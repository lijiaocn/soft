<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <div style="width:100%;text-align:center">
                  <h2 style="color:#afa790">å°é¸Ÿç¬”è®°-ç³»ç»Ÿè½¯ä»¶</h2>
                  <p style="font-weight:bold"><a style="color:lightgray;" href="https://www.lijiaocn.com">www.lijiaocn.com</a></p>
                </div>
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> å°é¸Ÿç¬”è®°â€”è½¯ä»¶ç¯‡</a></li><li class="chapter-item expanded "><a href="tools/index.html"><strong aria-hidden="true">2.</strong> å¸¸ç”¨å·¥å…·</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tools/domainip.html"><strong aria-hidden="true">2.1.</strong> åŸŸåå’ŒIPç›¸å…³</a></li><li class="chapter-item expanded "><a href="tools/http.html"><strong aria-hidden="true">2.2.</strong> HTTPåè®®ç›¸å…³</a></li><li class="chapter-item expanded "><a href="tools/benchmark.html"><strong aria-hidden="true">2.3.</strong> æ€§èƒ½æµ‹è¯•ç›¸å…³</a></li></ol></li><li class="chapter-item expanded "><a href="linuxsys/index.html"><strong aria-hidden="true">3.</strong> Linux ç³»ç»Ÿæ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linuxsys/tpproxy.html"><strong aria-hidden="true">3.1.</strong> é€æ˜ä»£ç†</a></li><li class="chapter-item expanded "><a href="linuxsys/iptables.html"><strong aria-hidden="true">3.2.</strong> iptables</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linuxsys/iptables-match.html"><strong aria-hidden="true">3.2.1.</strong> æŠ¥æ–‡åŒ¹é…è§„åˆ™</a></li><li class="chapter-item expanded "><a href="linuxsys/iptables-target.html"><strong aria-hidden="true">3.2.2.</strong> æŠ¥æ–‡å¤„ç†åŠ¨ä½œ</a></li></ol></li><li class="chapter-item expanded "><a href="linuxsys/localip.html"><strong aria-hidden="true">3.3.</strong> ç½‘ç»œè®¾ç½®</a></li><li class="chapter-item expanded "><a href="linuxsys/resource.html"><strong aria-hidden="true">3.4.</strong> èµ„æºç®¡ç†</a></li></ol></li><li class="chapter-item expanded "><a href="hyperledger/index.html"><strong aria-hidden="true">4.</strong> HyperLedger è¶…çº§è´¦æœ¬</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hyperledger/demo.html"><strong aria-hidden="true">4.1.</strong> Fabric å•æœºæç®€éƒ¨ç½²</a></li><li class="chapter-item expanded "><a href="hyperledger/explorer.html"><strong aria-hidden="true">4.2.</strong> Fabric æµè§ˆå™¨å®‰è£…</a></li><li class="chapter-item expanded "><a href="hyperledger/plan.html"><strong aria-hidden="true">4.3.</strong> åç»­å®‰æ’...</a></li></ol></li><li class="chapter-item expanded "><a href="istio/index.html"><strong aria-hidden="true">5.</strong> Istio æœåŠ¡ç½‘æ ¼</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="istio/install.html"><strong aria-hidden="true">5.1.</strong> éƒ¨ç½²ç¯å¢ƒå‡†å¤‡</a></li><li class="chapter-item expanded "><a href="istio/demo-install.html"><strong aria-hidden="true">5.2.</strong> é¢„è§ˆç‰ˆéƒ¨ç½²</a></li><li class="chapter-item expanded "><a href="istio/command.html"><strong aria-hidden="true">5.3.</strong> æ“ä½œå‘½ä»¤</a></li><li class="chapter-item expanded "><a href="istio/config.html"><strong aria-hidden="true">5.4.</strong> é…ç½®å‚æ•°</a></li><li class="chapter-item expanded "><a href="istio/concept.html"><strong aria-hidden="true">5.5.</strong> åŠŸèƒ½æ¦‚å¿µ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="istio/vsvc.html"><strong aria-hidden="true">5.5.1.</strong> VirtualService</a></li><li class="chapter-item expanded "><a href="istio/dstrule.html"><strong aria-hidden="true">5.5.2.</strong> DestinationRule</a></li><li class="chapter-item expanded "><a href="istio/gateway.html"><strong aria-hidden="true">5.5.3.</strong> Gateway</a></li><li class="chapter-item expanded "><a href="istio/entry.html"><strong aria-hidden="true">5.5.4.</strong> ServiceEntry</a></li><li class="chapter-item expanded "><a href="istio/egress.html"><strong aria-hidden="true">5.5.5.</strong> Engress Control</a></li></ol></li><li class="chapter-item expanded "><a href="istio/sample.html"><strong aria-hidden="true">5.6.</strong> istio ç¤ºä¾‹æ‹†è§£</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="istio/httprecord.html"><strong aria-hidden="true">5.6.1.</strong> Http-Record Application</a></li><li class="chapter-item expanded "><a href="istio/bookinfo.html"><strong aria-hidden="true">5.6.2.</strong> Bookinfo Application</a></li></ol></li><li class="chapter-item expanded "><a href="istio/route.html"><strong aria-hidden="true">5.7.</strong> è½¬å‘è·¯ç”±</a></li><li class="chapter-item expanded "><a href="istio/shift.html"><strong aria-hidden="true">5.8.</strong> æµé‡åˆ‡æ¢</a></li><li class="chapter-item expanded "><a href="istio/injection.html"><strong aria-hidden="true">5.9.</strong> é”™è¯¯æ³¨å…¥</a></li><li class="chapter-item expanded "><a href="istio/timeout.html"><strong aria-hidden="true">5.10.</strong> è¶…æ—¶è®¾ç½®</a></li><li class="chapter-item expanded "><a href="istio/tpolicy.html"><strong aria-hidden="true">5.11.</strong> è´Ÿè½½å‡è¡¡</a></li><li class="chapter-item expanded "><a href="istio/mirror.html"><strong aria-hidden="true">5.12.</strong> æµé‡å¤åˆ¶</a></li><li class="chapter-item expanded "><a href="istio/tracing.html"><strong aria-hidden="true">5.13.</strong> é“¾è·¯è·Ÿè¸ª</a></li><li class="chapter-item expanded "><a href="istio/metrics.html"><strong aria-hidden="true">5.14.</strong> æŒ‡æ ‡é‡‡é›†</a></li><li class="chapter-item expanded "><a href="istio/log.html"><strong aria-hidden="true">5.15.</strong> æ—¥å¿—æ”¶é›†</a></li><li class="chapter-item expanded "><a href="istio/policy.html"><strong aria-hidden="true">5.16.</strong> è®¿é—®æ§åˆ¶</a></li><li class="chapter-item expanded "><a href="istio/modify.html"><strong aria-hidden="true">5.17.</strong> è¯·æ±‚æ”¹å†™</a></li></ol></li><li class="chapter-item expanded "><a href="k8s/index.html"><strong aria-hidden="true">6.</strong> Kubernetes ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="minikube/index.html"><strong aria-hidden="true">6.1.</strong> minikube æœ¬åœ°éƒ¨ç½²</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="minikube/install.html"><strong aria-hidden="true">6.1.1.</strong> å®‰è£… minikube</a></li><li class="chapter-item expanded "><a href="minikube/deploy.html"><strong aria-hidden="true">6.1.2.</strong> å¯åŠ¨ kubernetes</a></li><li class="chapter-item expanded "><a href="minikube/vm.html"><strong aria-hidden="true">6.1.3.</strong> è¿›å…¥ minikube</a></li><li class="chapter-item expanded "><a href="minikube/config.html"><strong aria-hidden="true">6.1.4.</strong> ä¿®æ”¹ kubernetes</a></li><li class="chapter-item expanded "><a href="minikube/oper.html"><strong aria-hidden="true">6.1.5.</strong> æ“ä½œ kubernetes</a></li><li class="chapter-item expanded "><a href="minikube/request.html"><strong aria-hidden="true">6.1.6.</strong> è®¿é—® kubernetes</a></li></ol></li><li class="chapter-item expanded "><a href="k8s/res.html"><strong aria-hidden="true">6.2.</strong> k8s API å®šä¹‰åˆ—è¡¨</a></li><li class="chapter-item expanded "><a href="k8s/code.html"><strong aria-hidden="true">6.3.</strong> k8s æºç é˜…è¯»æŒ‡å¼•</a></li><li class="chapter-item expanded "><a href="k8s/svc/external.html"><strong aria-hidden="true">6.4.</strong> k8s å¯¼å…¥å¤–éƒ¨æœåŠ¡</a></li><li class="chapter-item expanded "><a href="k8s/usage/pod.html"><strong aria-hidden="true">6.5.</strong> k8s æ“ä½œæŠ€å·§æ”¶é›†</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/index.html"><strong aria-hidden="true">6.6.</strong> ingress-nginx ç”¨æ³•</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="k8s/ingress-nginx/tls.html"><strong aria-hidden="true">6.6.1.</strong> ä¼ è¾“åŠ å¯†</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/auth.html"><strong aria-hidden="true">6.6.2.</strong> è‡ªå¸¦è®¤è¯</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/auth-ext.html"><strong aria-hidden="true">6.6.3.</strong> å¤–éƒ¨è®¤è¯</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/rewrite.html"><strong aria-hidden="true">6.6.4.</strong> è¯·æ±‚æ”¹å†™</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/mirror.html"><strong aria-hidden="true">6.6.5.</strong> è¯·æ±‚å¤åˆ¶</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/ratelimit.html"><strong aria-hidden="true">6.6.6.</strong> æºIPé™é€Ÿ</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/canary.html"><strong aria-hidden="true">6.6.7.</strong> é‡‘ä¸é›€å‘å¸ƒ</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/anno.html"><strong aria-hidden="true">6.6.8.</strong> å¸¸ç”¨æ³¨è§£</a></li><li class="chapter-item expanded "><a href="k8s/ingress-nginx/note.html"><strong aria-hidden="true">6.6.9.</strong> ç›¸å…³ç¬”è®°</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="envoy/index.html"><strong aria-hidden="true">7.</strong> Envoy ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="envoy/install.html"><strong aria-hidden="true">7.1.</strong> å®‰è£…è¿è¡Œ</a></li><li class="chapter-item expanded "><a href="envoy/echoserver.html"><strong aria-hidden="true">7.2.</strong> åˆæ¬¡ä½“éªŒ</a></li><li class="chapter-item expanded "><a href="envoy/config.html"><strong aria-hidden="true">7.3.</strong> é…ç½®æ–‡ä»¶</a></li><li class="chapter-item expanded "><a href="envoy/config-static.html"><strong aria-hidden="true">7.4.</strong> é™æ€é…ç½®</a></li><li class="chapter-item expanded "><a href="envoy/config-dynamic.html"><strong aria-hidden="true">7.5.</strong> åŠ¨æ€é…ç½®</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="envoy/xds.html"><strong aria-hidden="true">7.5.1.</strong> ç”¨ XDS ä¸‹å‘é…ç½®</a></li><li class="chapter-item expanded "><a href="envoy/ads.html"><strong aria-hidden="true">7.5.2.</strong> ç”¨ ADS ä¸‹å‘é…ç½®</a></li><li class="chapter-item expanded "><a href="envoy/mds.html"><strong aria-hidden="true">7.5.3.</strong> lds/cds/rds/sds/eds</a></li></ol></li><li class="chapter-item expanded "><a href="envoy/control.html"><strong aria-hidden="true">7.6.</strong> æ§åˆ¶å¹³é¢å®ç°</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="envoy/go-control-plane-api.html"><strong aria-hidden="true">7.6.1.</strong> go-control-plane é…ç½®å®šä¹‰</a></li><li class="chapter-item expanded "><a href="envoy/go-control-plane-send.html"><strong aria-hidden="true">7.6.2.</strong> go-control-plane ä½¿ç”¨ä»‹ç»</a></li><li class="chapter-item expanded "><a href="envoy/go-control-plane-env.html"><strong aria-hidden="true">7.6.3.</strong> go-control-plane ç¤ºä¾‹å‡†å¤‡</a></li><li class="chapter-item expanded "><a href="envoy/go-control-plane-code.html"><strong aria-hidden="true">7.6.4.</strong> go-control-plane ç¤ºä¾‹è¯´æ˜</a></li><li class="chapter-item expanded "><a href="envoy/go-control-plane-run.html"><strong aria-hidden="true">7.6.5.</strong> go-control-plane ç¤ºä¾‹è¿è¡Œ</a></li></ol></li><li class="chapter-item expanded "><a href="envoy/cluster.html"><strong aria-hidden="true">7.7.</strong> Cluster è¯¦è§£</a></li><li class="chapter-item expanded "><a href="envoy/listener.html"><strong aria-hidden="true">7.8.</strong> Listener è¯¦è§£</a></li><li class="chapter-item expanded "><a href="envoy/filter.html"><strong aria-hidden="true">7.9.</strong> Filter è¯¦è§£</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="envoy/filter-def.html"><strong aria-hidden="true">7.9.1.</strong> filter çš„å®šä¹‰ä¸ä¸‹å‘</a></li><li class="chapter-item expanded "><a href="envoy/listener-filter.html"><strong aria-hidden="true">7.9.2.</strong> listener filter</a></li><li class="chapter-item expanded "><a href="envoy/network-filter.html"><strong aria-hidden="true">7.9.3.</strong> network filter</a></li><li class="chapter-item expanded "><a href="envoy/http-filter.html"><strong aria-hidden="true">7.9.4.</strong> http filter</a></li></ol></li><li class="chapter-item expanded "><a href="envoy/l4.html"><strong aria-hidden="true">7.10.</strong> 4 å±‚ TCP/UDP è½¬å‘</a></li><li class="chapter-item expanded "><a href="envoy/qa.html"><strong aria-hidden="true">7.11.</strong> å¸¸è§é—®é¢˜</a></li></ol></li><li class="chapter-item expanded "><a href="nginx/index.html"><strong aria-hidden="true">8.</strong> Nginx ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nginx/env.html"><strong aria-hidden="true">8.1.</strong> nginx è¯•éªŒç¯å¢ƒ</a></li><li class="chapter-item expanded "><a href="nginx/config.html"><strong aria-hidden="true">8.2.</strong> nginx é…ç½®æ–‡ä»¶</a></li><li class="chapter-item expanded "><a href="nginx/comm.html"><strong aria-hidden="true">8.3.</strong> nginx å¸¸ç”¨é…ç½®</a></li><li class="chapter-item expanded "><a href="nginx/performance.html"><strong aria-hidden="true">8.4.</strong> nginx æ€§èƒ½å‚æ•°</a></li><li class="chapter-item expanded "><a href="nginx/important.html"><strong aria-hidden="true">8.5.</strong> nginx æ³¨æ„äº‹é¡¹</a></li><li class="chapter-item expanded "><a href="nginx/status.html"><strong aria-hidden="true">8.6.</strong> nginx çŠ¶æ€æ•°æ®</a></li><li class="chapter-item expanded "><a href="nginx/mirror.html"><strong aria-hidden="true">8.7.</strong> nginx è¯·æ±‚å¤åˆ¶</a></li><li class="chapter-item expanded "><a href="nginx/abtest.html"><strong aria-hidden="true">8.8.</strong> nginx A/B æµ‹è¯•</a></li><li class="chapter-item expanded "><a href="nginx/proxy.html"><strong aria-hidden="true">8.9.</strong> nginx é€æ˜ä»£ç†</a></li></ol></li><li class="chapter-item expanded "><a href="openresty/index.html"><strong aria-hidden="true">9.</strong> OpenResty ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="openresty/env.html"><strong aria-hidden="true">9.1.</strong> openresty ç¯å¢ƒå‡†å¤‡</a></li><li class="chapter-item expanded "><a href="openresty/lua.html"><strong aria-hidden="true">9.2.</strong> openresty lua äº¤äº’</a></li><li class="chapter-item expanded "><a href="openresty/common.html"><strong aria-hidden="true">9.3.</strong> openresty å¸¸è§„æ“ä½œ</a></li></ol></li><li class="chapter-item expanded "><a href="prometheus/index.html"><strong aria-hidden="true">10.</strong> Prometheus ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="prometheus/start.html"><strong aria-hidden="true">10.1.</strong> å®‰è£…é…ç½®</a></li><li class="chapter-item expanded "><a href="prometheus/types.html"><strong aria-hidden="true">10.2.</strong> æ•°æ®ç±»å‹</a></li><li class="chapter-item expanded "><a href="prometheus/query.html"><strong aria-hidden="true">10.3.</strong> æŸ¥è¯¢è¯­æ³•</a></li><li class="chapter-item expanded "><a href="prometheus/query-compute.html"><strong aria-hidden="true">10.4.</strong> æ•°å€¼è¿ç®—</a></li><li class="chapter-item expanded "><a href="prometheus/query-function.html"><strong aria-hidden="true">10.5.</strong> æŸ¥è¯¢å‡½æ•°</a></li><li class="chapter-item expanded "><a href="prometheus/exporters.html"><strong aria-hidden="true">10.6.</strong> å„ç§ exporter</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="prometheus/blackbox.html"><strong aria-hidden="true">10.6.1.</strong> blackbox exporter</a></li></ol></li><li class="chapter-item expanded "><a href="prometheus/pushgateway.html"><strong aria-hidden="true">10.7.</strong> pushgateway</a></li><li class="chapter-item expanded "><a href="prometheus/more.html"><strong aria-hidden="true">10.8.</strong> è¿›é˜¶æ‹“å±•</a></li></ol></li><li class="chapter-item expanded "><a href="ansible/index.html"><strong aria-hidden="true">11.</strong> Ansible ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ansible/privilege.html"><strong aria-hidden="true">11.1.</strong> ç”¨æˆ·æƒé™æå‡</a></li><li class="chapter-item expanded "><a href="ansible/file.html"><strong aria-hidden="true">11.2.</strong> æ–‡ä»¶å’Œurlå¤„ç†</a></li><li class="chapter-item expanded "><a href="ansible/install.html"><strong aria-hidden="true">11.3.</strong> è½¯ä»¶å®‰è£…</a></li><li class="chapter-item expanded "><a href="ansible/docker.html"><strong aria-hidden="true">11.4.</strong> æ“ä½œ docker</a></li></ol></li><li class="chapter-item expanded "><a href="perf/index.html"><strong aria-hidden="true">12.</strong> Perf ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="perf/basic.html"><strong aria-hidden="true">12.1.</strong> perf æŠ€æœ¯åŸç†</a></li><li class="chapter-item expanded "><a href="perf/usage1.html"><strong aria-hidden="true">12.2.</strong> perf åŸºæœ¬ç”¨æ³•</a></li><li class="chapter-item expanded "><a href="perf/pmu.html"><strong aria-hidden="true">12.3.</strong> PMU äº‹ä»¶</a></li></ol></li><li class="chapter-item expanded "><a href="docker/index.html"><strong aria-hidden="true">13.</strong> Docker ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docker/install.html"><strong aria-hidden="true">13.1.</strong> å®‰è£…é…ç½®</a></li><li class="chapter-item expanded "><a href="docker/container.html"><strong aria-hidden="true">13.2.</strong> å®¹å™¨æ“ä½œ</a></li><li class="chapter-item expanded "><a href="docker/image.html"><strong aria-hidden="true">13.3.</strong> é•œåƒç®¡ç†</a></li><li class="chapter-item expanded "><a href="docker/principle.html"><strong aria-hidden="true">13.4.</strong> åŸç†è¿›é˜¶</a></li><li class="chapter-item expanded "><a href="docker/compose/index.html"><strong aria-hidden="true">13.5.</strong> docker-compose</a></li><li class="chapter-item expanded "><a href="docker/compose/mysql.html"><strong aria-hidden="true">13.6.</strong> MySQLé•œåƒä½¿ç”¨</a></li></ol></li><li class="chapter-item expanded "><a href="git/index.html"><strong aria-hidden="true">14.</strong> Git ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="git/rebase.html"><strong aria-hidden="true">14.1.</strong> æäº¤å‡†å¤‡ rebase</a></li><li class="chapter-item expanded "><a href="git/repo-cross.html"><strong aria-hidden="true">14.2.</strong> è·¨è¶Šå¤šä¸ª repo</a></li></ol></li><li class="chapter-item expanded "><a href="linux/index.html"><strong aria-hidden="true">15.</strong> æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜è¯Šæ–­</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/01-concept.html"><strong aria-hidden="true">15.1.</strong> è®¤çŸ¥æ¡†æ¶</a></li><li class="chapter-item expanded "><a href="linux/kernel.html"><strong aria-hidden="true">15.2.</strong> ç†è§£å†…æ ¸</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/dynamic-trace.html"><strong aria-hidden="true">15.2.1.</strong> åŠ¨æ€è¿½è¸ª</a></li></ol></li><li class="chapter-item expanded "><a href="linux/03-cpu.html"><strong aria-hidden="true">15.3.</strong> ç†è§£ CPU</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/02-process-3.html"><strong aria-hidden="true">15.3.1.</strong> CPU çš„å·¥ä½œçŠ¶æ€</a></li><li class="chapter-item expanded "><a href="linux/03-cpu-1.html"><strong aria-hidden="true">15.3.2.</strong> CPU ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li><li class="chapter-item expanded "><a href="linux/cpu-usage-analysis.html"><strong aria-hidden="true">15.3.3.</strong> CPU çš„ä½¿ç”¨æƒ…å†µ</a></li></ol></li><li class="chapter-item expanded "><a href="linux/memory.html"><strong aria-hidden="true">15.4.</strong> ç†è§£å†…å­˜</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/memory-manage.html"><strong aria-hidden="true">15.4.1.</strong> å†…å­˜ç®¡ç†</a></li><li class="chapter-item expanded "><a href="linux/memory-cache.html"><strong aria-hidden="true">15.4.2.</strong> å†…å­˜ç¼“å­˜</a></li><li class="chapter-item expanded "><a href="linux/memory-stat.html"><strong aria-hidden="true">15.4.3.</strong> å†…å­˜çŠ¶æ€</a></li></ol></li><li class="chapter-item expanded "><a href="linux/interrupt.html"><strong aria-hidden="true">15.5.</strong> ç†è§£ä¸­æ–­</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/sys-interrupt.html"><strong aria-hidden="true">15.5.1.</strong> ç³»ç»Ÿä¸­æ–­</a></li></ol></li><li class="chapter-item expanded "><a href="linux/02-process.html"><strong aria-hidden="true">15.6.</strong> ç†è§£è¿›ç¨‹</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/02-process-1.html"><strong aria-hidden="true">15.6.1.</strong> è¿›ç¨‹çš„åˆ†ç±»</a></li><li class="chapter-item expanded "><a href="linux/02-process-2.html"><strong aria-hidden="true">15.6.2.</strong> è¿›ç¨‹çš„çŠ¶æ€</a></li><li class="chapter-item expanded "><a href="linux/process-resouce.html"><strong aria-hidden="true">15.6.3.</strong> è¿›ç¨‹å ç”¨çš„èµ„æº</a></li></ol></li><li class="chapter-item expanded "><a href="linux/01-filesystem.html"><strong aria-hidden="true">15.7.</strong> ç†è§£æ–‡ä»¶ç³»ç»Ÿ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/vfs.html"><strong aria-hidden="true">15.7.1.</strong> VFS</a></li><li class="chapter-item expanded "><a href="linux/disk.html"><strong aria-hidden="true">15.7.2.</strong> ç£ç›˜</a></li><li class="chapter-item expanded "><a href="linux/filesystem-stat.html"><strong aria-hidden="true">15.7.3.</strong> æ–‡ä»¶ç³»ç»ŸçŠ¶æ€</a></li><li class="chapter-item expanded "><a href="linux/02-io.html"><strong aria-hidden="true">15.7.4.</strong> I/O æ“ä½œåˆ†ç±»</a></li><li class="chapter-item expanded "><a href="linux/process_sys_io.html"><strong aria-hidden="true">15.7.5.</strong> ç³»ç»Ÿ I/O çŠ¶æ€</a></li></ol></li><li class="chapter-item expanded "><a href="linux/network.html"><strong aria-hidden="true">15.8.</strong> ç†è§£ç½‘ç»œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/network-metrics.html"><strong aria-hidden="true">15.8.1.</strong> æ€§èƒ½æŒ‡æ ‡ä¸æ£€æµ‹</a></li><li class="chapter-item expanded "><a href="linux/network-nic-stat.html"><strong aria-hidden="true">15.8.2.</strong> ç½‘å¡çŠ¶æ€</a></li><li class="chapter-item expanded "><a href="linux/network-stat.html"><strong aria-hidden="true">15.8.3.</strong> è¿æ¥/åè®®æ ˆçŠ¶æ€</a></li><li class="chapter-item expanded "><a href="linux/network-netfilter.html"><strong aria-hidden="true">15.8.4.</strong> è¿æ¥è·Ÿè¸ª netfilter</a></li><li class="chapter-item expanded "><a href="linux/network-trace-pkt.html"><strong aria-hidden="true">15.8.5.</strong> æŠ¥æ–‡è·Ÿè¸ª</a></li><li class="chapter-item expanded "><a href="linux/network-dns-trace.html"><strong aria-hidden="true">15.8.6.</strong> DNS è§£æè¿½è¸ª</a></li><li class="chapter-item expanded "><a href="linux/netio-high-performance.html"><strong aria-hidden="true">15.8.7.</strong> é«˜æ€§èƒ½ç½‘ç»œ IO</a></li></ol></li><li class="chapter-item expanded "><a href="linux/04-tool.html"><strong aria-hidden="true">15.9.</strong> åˆ†æå·¥å…·</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/04-flame-graphs.html"><strong aria-hidden="true">15.9.1.</strong> ç«ç„°å›¾ä»‹ç»</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="linux/04-flame-graphs-cpu.html"><strong aria-hidden="true">15.9.1.1.</strong> CPU ç«ç„°å›¾</a></li><li class="chapter-item expanded "><a href="linux/04-flame-graphs-memory.html"><strong aria-hidden="true">15.9.1.2.</strong> å†…å­˜ç«ç„°å›¾</a></li><li class="chapter-item expanded "><a href="linux/04-flame-graphs-off-cpu.html"><strong aria-hidden="true">15.9.1.3.</strong> Off-CPU ç«ç„°å›¾</a></li><li class="chapter-item expanded "><a href="linux/04-flame-graphs-hot-code.html"><strong aria-hidden="true">15.9.1.4.</strong> å†·çƒ­ç«ç„°å›¾</a></li><li class="chapter-item expanded "><a href="linux/04-flame-graphs-differential.html"><strong aria-hidden="true">15.9.1.5.</strong> å·®å¼‚ç«ç„°å›¾</a></li><li class="chapter-item expanded "><a href="linux/04-flame-generate.html"><strong aria-hidden="true">15.9.1.6.</strong> ç«ç„°å›¾ç”Ÿæˆ</a></li></ol></li><li class="chapter-item expanded "><a href="linux/04-bcc-tools.html"><strong aria-hidden="true">15.9.2.</strong> BCCç³»åˆ—å·¥å…·</a></li></ol></li><li class="chapter-item expanded "><a href="linux/cpu-usage-high.html"><strong aria-hidden="true">15.10.</strong> æ¡ˆä¾‹: CPU ä½¿ç”¨ç‡å¾ˆé«˜</a></li><li class="chapter-item expanded "><a href="linux/todo.html"><strong aria-hidden="true">15.11.</strong> å¾…å­¦ä¹ </a></li></ol></li><li class="chapter-item expanded "><a href="mac/index.html"><strong aria-hidden="true">16.</strong> Mac ä½¿ç”¨æ‰‹å†Œ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mac/soft.html"><strong aria-hidden="true">16.1.</strong> å¸¸ç”¨è½¯ä»¶</a></li><li class="chapter-item expanded "><a href="mac/network.html"><strong aria-hidden="true">16.2.</strong> ç³»ç»Ÿæ“ä½œ</a></li></ol></li></ol>
               <div style="width:100%;text-align:center">
                  <img style="width:100%" src="https://www.lijiaocn.com/img/ercode/cur.jpg"/>
               </div>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div style="text-align:center;width:100%">
                    <!--h1>é¡¶éƒ¨æ¡å¹…å¹¿å‘Š</h1-->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8176866190626448"
                     crossorigin="anonymous"></script>
                     <!-- é¡¶éƒ¨æ¡å¹…å¹¿å‘Š -->
                    <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-8176866190626448"
                     data-ad-slot="1000173679"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                     <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                     </script>
                </div>

                <div id="content" class="content">
                    <main>
                        <h1 id="é‡è¦è½¯ä»¶ä½¿ç”¨æ–¹æ³•"><a class="header" href="#é‡è¦è½¯ä»¶ä½¿ç”¨æ–¹æ³•">é‡è¦è½¯ä»¶ä½¿ç”¨æ–¹æ³•</a></h1>
<p>è®°å½•å·¥ä½œä¸­æ¥è§¦çš„ä¸€äº›é‡è¦çš„è½¯ä»¶çš„ä½¿ç”¨æ–¹æ³•ï¼ŒåŠ›æ±‚æ¸…æ™°æ˜äº†ï¼Œä¸ºåæ¥è€…é“ºè·¯çœæ—¶é—´ã€‚</p>
<p>è¯¥æ‰‹å†Œä¸æ˜¯åˆ»æ„ç¼–å†™ï¼Œè€Œæ˜¯åœ¨å·¥ä½œå­¦ä¹ ä¸­éšæ‰‹è®°å½•ã€éšæ—¶æ›´æ–°ï¼Œæ–‡æ¡£ç»“æ„å’Œå†…å®¹ä¼šæŒç»­ä¼˜åŒ–ã€‚</p>
<p>ğŸ‘ˆ ä»å·¦ä¾§ç›®å½•å¼€å§‹é˜…è¯»ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="å·¥ä½œä»¥åŠæœ¬æ–‡æ¡£ä¸­å¸¸ç”¨çš„ä¸€äº›å·¥å…·"><a class="header" href="#å·¥ä½œä»¥åŠæœ¬æ–‡æ¡£ä¸­å¸¸ç”¨çš„ä¸€äº›å·¥å…·">å·¥ä½œä»¥åŠæœ¬æ–‡æ¡£ä¸­å¸¸ç”¨çš„ä¸€äº›å·¥å…·</a></h1>
<p>è¿™ä¸€ç« èŠ‚æ”¶é›†æ¯”è¾ƒç®€å•ã€ä½†æ˜¯åœ¨æœ¬æ–‡æ¡£ä»¥åŠå·¥ä½œä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›å°å·¥å…·ã€‚</p>
<h2 id="å‚è€ƒ"><a class="header" href="#å‚è€ƒ">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="åŸŸåipç­‰ç›¸å…³çš„å·¥å…·"><a class="header" href="#åŸŸåipç­‰ç›¸å…³çš„å·¥å…·">åŸŸåã€IPç­‰ç›¸å…³çš„å·¥å…·</a></h1>
<h2 id="è§£æåˆ°-127001-çš„å…¬ç½‘åŸŸå"><a class="header" href="#è§£æåˆ°-127001-çš„å…¬ç½‘åŸŸå">è§£æåˆ° 127.0.0.1 çš„å…¬ç½‘åŸŸå</a></h2>
<p>æœ¬ç«™æä¾›ä¸€ä¸ªè§£æåˆ° 127.0.0.1 çš„å…¬ç½‘åŸŸåï¼šlocal.lijiaocn.comã€‚</p>
<p>è¿™ä¸ªåŸŸåçš„å¥½å¤„æ˜¯å¯ä»¥é€šè¿‡å®ƒè®¿é—®æœ¬åœ°çš„æœåŠ¡ï¼Œæ¯”æ–¹è¯´åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªechoserverï¼Œç›‘å¬åœ°å€ä¸º 127.0.0.1:9090ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼è®¿é—®ï¼š</p>
<pre><code class="language-sh">$ curl local.lijiaocn.com:9090

Hostname: 57e34b409aa1

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008

Request Information:
	client_address=172.17.0.1
	method=GET
	real path=/
	query=
	request_version=1.1
	request_scheme=http
	request_uri=http://local.lijiaocn.com:8080/
...çœç•¥...
</code></pre>
<p>å½“ç›®æ ‡åº”ç”¨ä¸æ”¯æŒå¡«å…¥ IP åœ°å€ï¼Œæˆ–è€…æµ‹è¯•é€šè¿‡åŸŸåè®¿é—®çš„åŠŸèƒ½æ—¶ï¼Œè¿™ä¸ªåŸŸåç‰¹åˆ«æœ‰ç”¨ã€‚</p>
<h2 id="dnsmasq"><a class="header" href="#dnsmasq">dnsmasq</a></h2>
<p>è¯•éªŒä¸€äº›åŠŸèƒ½æ—¶ï¼Œè­¬å¦‚ <a href="tools/../nginx/tranproxy.html">nginx çš„é€æ˜ä»£ç†</a> ä»¥åŠ <a href="tools/../k8s/index.html">kubernetes</a> çš„ä¸€äº›åŠŸèƒ½ï¼Œéœ€è¦å¡«å†™å¯ä»¥é€šè¿‡åŸŸåæœåŠ¡å™¨è§£æçš„åŸŸåã€‚å¯ä»¥åœ¨æœ¬åœ°ç”¨ dnsmasq æ­å»ºä¸€ä¸ªåŸŸåæœåŠ¡è§£ææœåŠ¡ã€‚</p>
<h3 id="åœ¨-mac-ä¸Šéƒ¨ç½²-dnsmasq"><a class="header" href="#åœ¨-mac-ä¸Šéƒ¨ç½²-dnsmasq">åœ¨ mac ä¸Šéƒ¨ç½² dnsmasq</a></h3>
<ul>
<li>éƒ¨ç½² dnsmasqï¼š</li>
</ul>
<pre><code class="language-sh">$ sudo chown -R $(whoami):admin /usr/local
$ brew install dnsmasq
</code></pre>
<ul>
<li>åœ¨ /usr/local/etc/dnsmasq.conf ä¸­æ·»åŠ è§£æï¼Œè¿™é‡Œå°† echo.example è§£æåˆ°æœ¬åœ°åœ°å€ 127.0.0.1ï¼š</li>
</ul>
<pre><code class="language-conf">port 8053     # æ³¨æ„ï¼Œä¸è¦ç”¨ 53 ç«¯å£ï¼Œå¦åˆ™éœ€è¦ç”¨ root è¿è¡Œ
address=/echo.example/127.0.0.1
</code></pre>
<p>dnsmasq ç›‘å¬ç«¯å£æœ€å¥½ä¸ç”¨ 53 ï¼Œmac çš„æƒé™è¦æ±‚ 53 ç«¯å£å¿…é¡»ç”¨ root èº«ä»½ç›‘å¬ï¼Œè§ [Restart dnsmasq without sudo][2]ã€‚</p>
<ul>
<li>å¯åŠ¨ dnsmasqï¼š</li>
</ul>
<pre><code class="language-sh">$ brew services start dnsmasq
</code></pre>
<p>éªŒè¯è§£æï¼š</p>
<pre><code class="language-sh">$ dig @127.0.0.1 -p 8053 echo.example

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8053 echo.example
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 49022
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;echo.example.            IN    A

;; ANSWER SECTION:
echo.example.        0    IN    A    127.0.0.1

;; Query time: 41 msec
;; SERVER: 127.0.0.1#8053(127.0.0.1)
;; WHEN: Wed Oct 30 17:15:03 CST 2019
;; MSG SIZE  rcvd: 57
</code></pre>
<h2 id="å‚è€ƒ-1"><a class="header" href="#å‚è€ƒ-1">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="http-åè®®ç›¸å…³çš„å·¥å…·"><a class="header" href="#http-åè®®ç›¸å…³çš„å·¥å…·">HTTP åè®®ç›¸å…³çš„å·¥å…·</a></h1>
<h2 id="http-è¯·æ±‚å›æ˜¾-echoserver"><a class="header" href="#http-è¯·æ±‚å›æ˜¾-echoserver">HTTP è¯·æ±‚å›æ˜¾: echoserver</a></h2>
<p>ä¸‹è½½é•œåƒï¼š</p>
<pre><code class="language-sh">docker pull googlecontainer/echoserver:1.10 
</code></pre>
<p>å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">$ docker run -idt --name echoserver -p 9090:8080 -p 8443:8443 googlecontainer/echoserver:1.10
</code></pre>
<p>ç›´æ¥è®¿é—® echo å®¹å™¨æ•ˆæœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:9090
Hostname: 611185215d7a

Pod Information:
    -no pod information available-

Server values:
    server_version=nginx: 1.13.3 - lua: 10008

Request Information:
    client_address=172.17.0.1
    method=GET
    real path=/
    query=
    request_version=1.1
    request_scheme=http
    request_uri=http://127.0.0.1:9090/

Request Headers:
    accept=*/*
    host=127.0.0.1:9090
    user-agent=curl/7.54.0

Request Body:
    -no body in request-
</code></pre>
<h2 id="http-è¯·æ±‚è®°å½•-http-record"><a class="header" href="#http-è¯·æ±‚è®°å½•-http-record">HTTP è¯·æ±‚è®°å½•: http-record</a></h2>
<p>echoserver å‘å®¢æˆ·ç«¯è¿”å›æ¥æ”¶çš„è¯·æ±‚æƒ…å†µï¼Œhttp-record ä¸ä»…å‘å®¢æˆ·ç«¯è¿”å›ï¼ŒåŒæ—¶åœ¨æœ¬åœ°çš„æ ‡å‡†è¾“å‡ºæ‰“å°æ—¥å¿—ã€‚åœ¨æµ‹è¯•æµé‡å¤åˆ¶åŠŸèƒ½æ—¶ï¼Œå¤åˆ¶çš„è¯·æ±‚çš„å›åº”ä¼šè¢«ä¸¢å¼ƒï¼Œå¯ä»¥ç”¨ http-record è§‚å¯Ÿè¯·æ±‚æ˜¯å¦è¢«å¤åˆ¶ã€‚</p>
<pre><code class="language-sh">docker run -idt --name http-record -p 9091:8080 lijiaocn/http-record:0.0.1
</code></pre>
<p>è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:9091
{
    &quot;RemoteAddr&quot;: &quot;172.17.0.1:49802&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;127.0.0.1:9091&quot;,
    &quot;RequestURI&quot;: &quot;/&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.54.0&quot;
        ]
    },
    &quot;Body&quot;: &quot;&quot;
}%
</code></pre>
<p>å®¹å™¨æ—¥å¿—ï¼š</p>
<pre><code class="language-sh">$ docker logs -f http-record
/go/src/Server/echo.go:46: {
    &quot;RemoteAddr&quot;: &quot;172.17.0.1:49802&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;127.0.0.1:9091&quot;,
    &quot;RequestURI&quot;: &quot;/&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.54.0&quot;
        ]
    },
    &quot;Body&quot;: &quot;&quot;
}
</code></pre>
<h2 id="å‚è€ƒ-2"><a class="header" href="#å‚è€ƒ-2">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="æ€§èƒ½æµ‹è¯•å·¥å…·"><a class="header" href="#æ€§èƒ½æµ‹è¯•å·¥å…·">æ€§èƒ½æµ‹è¯•å·¥å…·</a></h1>
<p><a href="https://www.lijiaocn.com/%E6%96%B9%E6%B3%95/2018/11/02/webserver-benchmark-method.html">æ€æ ·å‹æµ‹Webåº”ç”¨çš„æ€§èƒ½ï¼Ÿå‹æµ‹å·¥å…·ä¸æµ‹é‡ã€åˆ†ææ–¹æ³•</a> ä¸­çš„éƒ¨åˆ†å·¥å…·æ²¡æœ‰è½¬ç§»åˆ°è¿™é‡Œã€‚</p>
<h2 id="iperf-æµ‹è¯•ç½‘ç»œä¼ è¾“æ€§èƒ½"><a class="header" href="#iperf-æµ‹è¯•ç½‘ç»œä¼ è¾“æ€§èƒ½">iperf æµ‹è¯•ç½‘ç»œä¼ è¾“æ€§èƒ½</a></h2>
<p><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2016/04/08/network-benchmark.html" title="iperfã€netperfç­‰ç½‘ç»œæ€§èƒ½æµ‹è¯•å·¥å…·çš„ä½¿ç”¨">iperf</a> æ˜¯ä¸€ä¸ªç®€å•å¸¸ç”¨çš„ç½‘ç»œä¼ è¾“æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œ<a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/11/08/kong-features-06-production-and-benchmark.html#%E7%94%A8siege%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95" title="siege">iperf-doc</a>ã€‚</p>
<p>å®‰è£…ï¼š</p>
<pre><code class="language-sh"># for CentOS
yum install -y epel-release
yum install -y iperf
</code></pre>
<p>å¯åŠ¨ Server ç«¯ï¼š</p>
<pre><code class="language-sh">$ iperf -p 5001 -s

# -s: serveræ¨¡å¼
# -p: ç›‘å¬ç«¯å£ï¼Œé»˜è®¤5001
</code></pre>
<p>æœåŠ¡ç«¯å¯ä»¥ç”¨å®¹å™¨å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">$ docker run -p 5001:5001 lijiaocn/iperf-server:1.0
</code></pre>
<p>å¯åŠ¨ Client ç«¯ï¼š</p>
<pre><code class="language-sh">$ iperf -p 5001 -c 192.168.10.2  -l 1M -t 120

#-p: server ç«¯å£ï¼Œé»˜è®¤ 5001
#-c: server åœ°å€
#-l: æ¯æ¬¡å‘é€çš„æ•°æ®çš„é•¿åº¦ï¼Œé»˜è®¤ tcp æ˜¯ 128Kï¼ŒUDP æ˜¯ 8K
#-t: æŒç»­çš„æ—¶é—´
</code></pre>
<h2 id="netperf-æ›´ç²¾ç»†çš„ç½‘ç»œä¼ è¾“æµ‹è¯•"><a class="header" href="#netperf-æ›´ç²¾ç»†çš„ç½‘ç»œä¼ è¾“æµ‹è¯•">netperf æ›´ç²¾ç»†çš„ç½‘ç»œä¼ è¾“æµ‹è¯•</a></h2>
<p><a href="https://hewlettpackard.github.io/netperf/" title="Netperf Homepage">NetPerf</a> èƒ½å¤Ÿæµ‹è¯•æ›´å¤šåœºæ™¯ï¼Œä¸€ä¸ªå¾ˆå¼ºå¤§çš„ç½‘ç»œæ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œ<a href="https://hewlettpackard.github.io/netperf/doc/netperf.html" title="Care and Feeding of Netperf 2.7.X">netperf doc</a> ä¸­æœ‰ä»‹ç»ã€‚</p>
<p>ä¸‹è½½æºä»£ç ï¼Œç¼–è¯‘å®‰è£…ï¼š</p>
<pre><code class="language-sh">$ yum install -y gcc make git texinfo
$ git clone https://github.com/HewlettPackard/netperf.git
$ cd netperf
$ ./autogen.sh
$ ./configure --prefix=/usr/local/
$ sudo make install
</code></pre>
<p>å¯åŠ¨æœåŠ¡ç«¯ï¼š</p>
<pre><code class="language-sh">$ netserver -4 -p 7777
</code></pre>
<p>å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æŒ‡å®šæµ‹è¯•ç±»å‹ï¼š</p>
<pre><code class="language-sh">$ netperf -4 -H 127.0.0.1 -p 7777 -t TCP_RR 
</code></pre>
<p>netperf çš„ -t å‚æ•°æ”¯æŒå¾ˆå¤šåœºæ™¯ï¼Œ<a href="https://github.com/lijiaocn/workspace/tree/master/net-benckmark/netperf/cases" title="netperf/cases">netperf/cases</a> ä¸­æ•´ç†äº†ä¸€éƒ¨åˆ†ã€‚</p>
<h2 id="wrk-æµ‹è¯•-http-æœåŠ¡æ€§èƒ½"><a class="header" href="#wrk-æµ‹è¯•-http-æœåŠ¡æ€§èƒ½">wrk æµ‹è¯• http æœåŠ¡æ€§èƒ½</a></h2>
<p>[wrk] æ˜¯ä¸€ä¸ªç‰¹åˆ«é«˜æ•ˆçš„ http æµ‹è¯•å·¥å…·ï¼Œæ¨èä½¿ç”¨ã€‚<a href="https://www.lijiaocn.com/%E6%96%B9%E6%B3%95/2018/11/02/webserver-benchmark-method.html" title="æ€æ ·å‹æµ‹Webåº”ç”¨çš„æ€§èƒ½ï¼Ÿå‹æµ‹å·¥å…·ä¸æµ‹é‡ã€åˆ†ææ–¹æ³•">æ€æ ·å‹æµ‹ Web åº”ç”¨çš„æ€§èƒ½ï¼Ÿå‹æµ‹å·¥å…·ä¸æµ‹é‡ã€åˆ†ææ–¹æ³•</a> ä¸­æœ‰æ›´å¤šå·¥å…· ã€‚</p>
<pre><code class="language-sh">$ git clone https://github.com/wg/wrk.git
$ cd wrk 
$ make
</code></pre>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">$ ./wrk
Usage: wrk &lt;options&gt; &lt;url&gt;
  Options:
    -c, --connections &lt;N&gt;  Connections to keep open
    -d, --duration    &lt;T&gt;  Duration of test
    -t, --threads     &lt;N&gt;  Number of threads to use

    -s, --script      &lt;S&gt;  Load Lua script file
    -H, --header      &lt;H&gt;  Add header to request
        --latency          Print latency statistics
        --timeout     &lt;T&gt;  Socket/request timeout
    -v, --version          Print version details

  Numeric arguments may include a SI unit (1k, 1M, 1G)
  Time arguments may include a time unit (2s, 2m, 2h)
</code></pre>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<pre><code class="language-sh">$ ./wrk -t 32 -c 64 -d 60s -H &quot;Host: webshell.com&quot; http://172.16.129.4/ping
</code></pre>
<h2 id="ghz-æµ‹è¯•-grpc-æœåŠ¡æ€§èƒ½"><a class="header" href="#ghz-æµ‹è¯•-grpc-æœåŠ¡æ€§èƒ½">ghz æµ‹è¯• grpc æœåŠ¡æ€§èƒ½</a></h2>
<p><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2019/02/22/grpc-benchmark-method.html">Grpcæ€§èƒ½å‹æµ‹æ–¹æ³•ï¼šç”¨ghzè¿›è¡Œå‹æµ‹</a></p>
<h2 id="å‚è€ƒ-3"><a class="header" href="#å‚è€ƒ-3">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2016/04/08/network-benchmark.html" title="iperfã€netperfç­‰ç½‘ç»œæ€§èƒ½æµ‹è¯•å·¥å…·çš„ä½¿ç”¨">iperfã€netperf</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/11/08/kong-features-06-production-and-benchmark.html#%E7%94%A8siege%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95" title="siege">siege</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-ç³»ç»ŸçŸ¥è¯†"><a class="header" href="#linux-ç³»ç»ŸçŸ¥è¯†">Linux ç³»ç»ŸçŸ¥è¯†</a></h1>
<p>Linux ç³»ç»Ÿçš„å­¦ä¹ ç¬”è®°ã€‚</p>
<p>å­¦ä¹ èµ„æ–™ï¼š</p>
<ul>
<li><a href="https://www.kernel.org/doc/man-pages/" title="The Linux man-pages project">The Linux man-pages project</a></li>
</ul>
<h2 id="å‚è€ƒ-4"><a class="header" href="#å‚è€ƒ-4">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-çš„é€æ˜ä»£ç†"><a class="header" href="#linux-çš„é€æ˜ä»£ç†">Linux çš„é€æ˜ä»£ç†</a></h1>
<p>TODO: å¾…è¯•éªŒã€‚</p>
<p>é€æ˜ä»£ç†æ˜¯ Linux kernel çš„åŠŸèƒ½ï¼Œç”¨ iptables æˆ–è€… nft å‘½ä»¤è®¾ç½®ï¼Œå°†å‘é€åˆ°åœ°å€ A çš„æŠ¥æ–‡è½¬å‘ç»™æœ¬åœ°çš„å¦ä¸€ä¸ªç›‘å¬åœ°å€ï¼Œç›‘å¬æ”¹åœ°å€çš„æœ¬åœ°è¿›ç¨‹èƒ½å¤Ÿè·å–åˆ°åŸå§‹çš„ç›®çš„åœ°å€ã€‚</p>
<p>ä»£ç†æŠ¥æ–‡çš„é€šå¸¸åšæ³•æ˜¯ REDIRECTï¼Œä¹Ÿå°±æ˜¯åš NATï¼Œkernel å°†æŠ¥æ–‡çš„ç›®æ ‡åœ°å€æ”¹å†™ä¸ºå¦ä¸€ä¸ªåœ°å€ï¼ŒåŒæ—¶å°†æºåœ°å€æ”¹å†™ä¸ºè‡ªèº«çš„åœ°å€ï¼Œç„¶åç»´æŠ¤è¿™ä¸¤ä¸ªåœ°å€çš„å¯¹åº”å…³ç³»ã€‚è¿™ç§æ–¹å¼å­˜åœ¨ä¸€ä¸ªæ˜æ˜¾çš„å¼Šç«¯ï¼Œæœ¬åœ°æ¥æ”¶ç«¯ä¸èƒ½æˆ–è€…å¾ˆéš¾è·å¾—æŠ¥æ–‡çš„åŸå§‹åœ°å€ã€‚</p>
<p>é€æ˜ä»£ç†æ˜¯å¦ä¸€ç§åšæ³•ï¼Œåœ¨ kernel ä¸Šåˆ›å»ºä¸€å¼ è·¯ç”±è¡¨ï¼Œæœ¬åœ°æ¥æ”¶ç«¯ï¼ˆç”¨æˆ·æ€ç¨‹åºï¼‰å»ºç«‹ç›‘å¬è¯¥è·¯ç”±è¡¨ä¸­åœ°å€çš„ socketã€‚åŒ¹é…è§„åˆ™æŠ¥æ–‡è¢«è½¬å‘ç»™æœ¬åœ°æ¥æ”¶ç«¯åï¼Œæœ¬åœ°æ¥æ”¶ç«¯å¯ä»¥ç”¨å¯¹åº”çš„ socket å‡½æ•°è·å–åŸå§‹çš„ç›®æ ‡åœ°å€ã€‚ </p>
<p>å†…æ ¸æ–‡æ¡£ <a href="https://www.kernel.org/doc/Documentation/networking/tproxy.txt" title="Transparent proxy support">Transparent proxy support</a> å¯¹è¯¥åŠŸèƒ½æœ‰ç®€å•è¯´æ˜ï¼Œ<a href="https://powerdns.org/tproxydoc/tproxy.md.html" title="Linux transparent proxy support">Linux transparent proxy support</a> ä»‹ç»çš„æ›´è¯¦ç»†ã€‚ ä¸‹é¢çš„å†…å®¹ä¸»è¦æ¥è‡ªç¬¬äºŒç¯‡æ–‡æ¡£ã€‚</p>
<h2 id="å‡†å¤‡æœ¬åœ°ä»£ç†è¿›ç¨‹"><a class="header" href="#å‡†å¤‡æœ¬åœ°ä»£ç†è¿›ç¨‹">å‡†å¤‡æœ¬åœ°ä»£ç†è¿›ç¨‹</a></h2>
<p>æœ¬åœ°ä»£ç†è¿›ç¨‹æ˜¯ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ªç›‘å¬ socket æ¥æ”¶æ–°å»ºè¿æ¥å’ŒæŠ¥æ–‡ã€‚ç›‘å¬åœ°å€å¯ä»¥æ˜¯ä»»æ„éœ€è¦çš„ IP åœ°å€ï¼Œä½†éœ€è¦æ³¨æ„ï¼Œå¦‚æœä¸æ˜¯ 0.0.0.0ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ <code>IP_TRANSPARENT</code> é€‰é¡¹ã€‚è®¤å®šä¸º local çš„ IP åœ°å€æ˜¯å¯ä»¥é…ç½®çš„ï¼Œè§ <a href="linuxsys/../linuxsys/localip.html">Linux ç³»ç»ŸçŸ¥è¯†/local åœ°å€</a></p>
<p>æœ¬åœ°ä»£ç†è¿›ç¨‹ä»ç›‘å¬ sockert ä¸­è¯»å–æ–°å»ºè¿æ¥ï¼Œå¯ä»¥è‡ªç”±åœ°å°†æ¥æ”¶çš„å†…å®¹è½¬å‘åˆ°å¦ä¸€ä¸ªåœ°å€ã€‚</p>
<pre><code>Socket s(AF_INET, SOCK_DGRAM, 0);
SSetsockopt(s, IPPROTO_IP, IP_TRANSPARENT, 1);
ComboAddress local(&quot;1.2.3.4&quot;, 5300);
ComboAddress remote(&quot;198.41.0.4&quot;, 53);

SBind(s, local);
SSendto(s, &quot;hi!&quot;, remote);
</code></pre>
<p>é€æ˜ä»£ç†èƒ½å¤Ÿè·å¾—åŸå§‹åœ°å€ï¼ŒæŒ‡çš„æœ¬åœ°ä»£ç†ç¨‹åºèƒ½å¤Ÿç”¨ socket å‡½æ•°è·å–æŠ¥æ–‡çš„åŸå§‹åœ°å€ï¼ŒTCP åè®®ç”¨ getsockname() è·å– ï¼š</p>
<pre><code>Socket s(AF_INET, SOCK_STREAM, 0);
SSetsockopt(s, IPPROTO_IP, IP_TRANSPARENT, 1);
ComboAddress local(&quot;127.0.0.1&quot;, 10025);

SBind(s, local);
SListen(s, 128);

ComboAddress remote(local), orig(local);
int client = SAccept(s, remote);
cout&lt;&lt;&quot;Got connection from &quot;&lt;&lt;remote.toStringWithPort()&lt;&lt;endl;

SGetsockname(client, orig);
cout&lt;&lt;&quot;Original destination: &quot;&lt;&lt;orig.toStringWithPort()&lt;&lt;endl;
</code></pre>
<p>UDP åè®®éœ€è¦ç”¨ setsockopt() è®¾ç½® IP_RECVORIGDSTADDRï¼Œç„¶åä» recvmsg() æ”¶åˆ°çš„ cmsg ä¸­è·å–ï¼Œç´¢å¼•ä¸º <code>IP_ORIGDSTADDR</code>ã€‚</p>
<h2 id="è®¾ç½®-iptables-è§„åˆ™"><a class="header" href="#è®¾ç½®-iptables-è§„åˆ™">è®¾ç½® iptables è§„åˆ™</a></h2>
<p>å‡†å¤‡å¥½æœ¬åœ°ä»£ç†è¿›ç¨‹åï¼Œè¿˜éœ€è¦è®¾ç½® iptables è§„åˆ™ï¼Œå°†æŠ¥æ–‡è½¬å‘ç»™æœ¬åœ°ä»£ç†ã€‚</p>
<p>åœ¨ iptables è§„åˆ™ä¸­ä½¿ç”¨åä¸º TPROXY çš„ TARGETï¼Œä¹Ÿå°±æ˜¯é€æ˜ä»£ç†ã€‚ä¸‹é¢çš„è§„åˆ™å°†ç›®æ ‡ç«¯å£æ˜¯ 25 çš„ TCP æŠ¥æ–‡ä»¥é€æ˜ä»£ç†çš„æ–¹å¼å‘é€åˆ°äº†æœ¬åœ°åœ°å€ 127.0.0.1:10025ã€‚</p>
<pre><code class="language-sh">iptables -t mangle -A PREROUTING -p tcp --dport 25 -j TPROXY \
  --tproxy-mark 0x1/0x1 --on-port 10025 --on-ip 127.0.0.1
</code></pre>
<h2 id="å‚è€ƒ-5"><a class="header" href="#å‚è€ƒ-5">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="iptables-çš„ä½¿ç”¨æ–¹æ³•"><a class="header" href="#iptables-çš„ä½¿ç”¨æ–¹æ³•">iptables çš„ä½¿ç”¨æ–¹æ³•</a></h1>
<p>è¿™é‡Œæ˜¯å¯¹ <a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2014/04/16/linux-net-iptables.html" title="iptablesï¼šLinuxçš„iptablesä½¿ç”¨">iptablesï¼šLinuxçš„iptablesä½¿ç”¨</a> çš„é‡æ–°æ•´ç†ã€æ‰©å……ã€‚</p>
<h2 id="å®‰è£…-iptables-å·¥å…·"><a class="header" href="#å®‰è£…-iptables-å·¥å…·">å®‰è£… iptables å·¥å…·</a></h2>
<p>åœ¨ Debian/Ubuntu ä¸Šå®‰è£…ï¼š</p>
<pre><code>apt-get update
apt-get install iptables -y
</code></pre>
<h2 id="iptables-åŸç†"><a class="header" href="#iptables-åŸç†">iptables åŸç†</a></h2>
<p>iptables æ ¹æ¤äº kernel ä¸­çš„ netfilter æ¨¡å—ï¼Œé€šè¿‡ netfilter åœ¨å½±å“æ­£åœ¨è¢«å†…æ ¸å¤„ç†çš„ç½‘ç»œæŠ¥æ–‡ï¼Œä¸€å…±æœ‰ PREROUTINGã€FORWARDã€POSTROUTINGã€INPUT å’Œ OUTPUT 5 ä¸ªå¹²æ¶‰ç‚¹ï¼Œæ¯ä¸ªå¹²æ¶‰ç‚¹å¯ä»¥æŒ‚ä¸€ä¸²çš„å¤„ç†è§„åˆ™ï¼ˆChainï¼‰ï¼š</p>
<pre><code>           INPUT                 OUPUT
             .                     |
            /_\           +--------+
             |           _|_
             +--------+  \ /
                      |   ' 
                      Router --------|&gt; FORWARD
                      .   |                |
                     /_\  +--------+       |
                      |           _|_     _|_
            +---------+           \ /     \ /
            |                      '       ' 
 PKT ---&gt; PREROUTING              POSTROUTING  ---&gt; PKT
</code></pre>
<h2 id="iptables-çš„è§„åˆ™ç®¡ç†ä¸ä½œç”¨é¡ºåº"><a class="header" href="#iptables-çš„è§„åˆ™ç®¡ç†ä¸ä½œç”¨é¡ºåº">iptables çš„è§„åˆ™ç®¡ç†ä¸ä½œç”¨é¡ºåº</a></h2>
<p>iptables çš„è§„åˆ™é€šè¿‡ 5 å¼ è¡¨ç®¡ç†ï¼Œæœ‰çš„è¡¨åŒ…æ‹¬æ‰€æœ‰çš„å¹²æ¶‰ç‚¹ï¼Œæœ‰çš„è¡¨åªåŒ…æ‹¬éƒ¨åˆ†å¹²æ¶‰ç‚¹ï¼š</p>
<pre><code class="language-sh">filter: 
    Chain INPUT
    Chain FORWARD
    Chain OUTPUT

nat:
    Chain PREROUTING
    Chain INPUT
    Chain OUTPUT
    Chain POSTROUTING

mangle:
    Chain PREROUTING
    Chain INPUT
    Chain FORWARD
    Chain OUTPUT
    Chain POSTROUTING

raw:
    Chain PREROUTING
    Chain OUTPUT

security:
    Chain INPUT
    Chain FORWARD
    Chain OUTPUT
</code></pre>
<p>ä¸Šé¢ 5 å¼ è¡¨ä¸­çš„ Chain çš„ä½œç”¨é¡ºåºæ˜¯å›ºå®šçš„ï¼Œè´¯ç©¿äº†æŠ¥æ–‡çš„å¤„ç†è¿‡ç¨‹ï¼Œ<a href="http://www.iptables.info/en/structure-of-iptables.html" title="structure-of-iptables">structure-of-iptables</a> ä¸­æœ‰éå¸¸è¯¦ç»†çš„è¯´æ˜ï¼š</p>
<p><img src="https://www.lijiaocn.com/img/iptables/nf-packet-flow.png" alt="nf-packet-flow" /></p>
<ul>
<li>
<p>è¿›å…¥ä¸»æœºçš„æŠ¥æ–‡:</p>
<p>raw.PREROUTING -&gt; mangle.PREROUTING -&gt; nat.PREROUTING -&gt; mangle.INPUT -&gt; filter.INPUT </p>
</li>
<li>
<p>ç»ä¸»æœºè½¬å‘çš„æŠ¥æ–‡:</p>
<p>raw.PREROUTING -&gt; mangle.PREROUTING -&gt; nat.PREROUTING -&gt; mangle.FORWARD -&gt; filter.FORWARD
-&gt; mangle.POSTROUTING -&gt; nat.POSTROUTING</p>
</li>
<li>
<p>ä¸»æœºå‘å‡ºçš„æŠ¥æ–‡:</p>
<p>raw.OUTPUT -&gt; mangle.OUTPUT -&gt; nat.OUTPUT -&gt; filter.OUTPUT -&gt; mangle.POSTROUTING 
-&gt;nat.POSTROUTING</p>
</li>
</ul>
<h2 id="è§„åˆ™æ ¼å¼"><a class="header" href="#è§„åˆ™æ ¼å¼">è§„åˆ™æ ¼å¼</a></h2>
<p>è§„åˆ™è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>rule-specification = [matches...] [target]
match = -m matchname [per-match-options]
target = -j targetname [per-target-options]
</code></pre>
<p>å¯ä»¥ä½¿ç”¨çš„è§„åˆ™å‚æ•°:</p>
<pre><code class="language-sh">-4, --ipv4
-6, --ipv6
[!] -p, --protocol protocol
     å¯ä»¥ä½¿ç”¨:
       1. tcp, udp, udplite, icmp, icmpv6,esp, ah, sctp, mh or the special keyword &quot;all&quot;
       2. åè®®å·ï¼Œ0ç­‰åŒäº&quot;all&quot;
       3. /etc/protocolsä¸­åˆ—å‡ºçš„åè®®å
[!] -s, --source address[/mask][,...]
     Address can be either:
         a network name, a hostname, a network IP address (with /mask), or a plain IP address.
         Multiple addresses can be specified, but this will expand to multiple rules (when
         adding with -A), or will cause multiple rules to be deleted (with -D).
[!] -d, --destination address[/mask][,...]
-m, --match match
     ä¸åŒçš„æ¨¡å—æœ‰ä¸åŒçš„å‚æ•°ï¼Œåœ¨ä¸‹ä¸€èŠ‚ä¸­å•ç‹¬è®¨è®º
-j, --jump target
-g, --goto chain
      Unlike the --jump option return will not continue processing in this chain but instead 
      in the chain that called us via --jump
[!] -i, --in-interface name
[!] -o, --out-interface name
[!] -f, --fragment
      This means that the rule only refers to second and further IPv4 fragments of fragmented packets.
      Since there is no way to tell the source or destination ports of  such  a  packet  (or ICMP type), 
      such a packet will not match any rules which specify them.  
      When the &quot;!&quot; argument precedes the &quot;-f&quot; flag, the rule will only match head fragments, or unfragmented packets.
      This option is IPv4 specific, it is not available in ip6tables.
-c, --set-counters packets bytes
      This enables the administrator to initialize the packet and byte counters of a rule 
      (during INSERT, APPEND, REPLACE operations).
</code></pre>
<p>æ€æ ·ç”¨ iptables å®ç°å„ç§æ•ˆæœï¼Œè§åé¢ç« èŠ‚ã€‚</p>
<h2 id="å‚è€ƒ-6"><a class="header" href="#å‚è€ƒ-6">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="iptables-çš„æŠ¥æ–‡åŒ¹é…æ–¹æ³•"><a class="header" href="#iptables-çš„æŠ¥æ–‡åŒ¹é…æ–¹æ³•">iptables çš„æŠ¥æ–‡åŒ¹é…æ–¹æ³•</a></h1>
<p>iptables è§„åˆ™çš„æ„æ€å°±æ˜¯ï¼Œå¯¹æ»¡è¶³ä»€ä¹ˆä»€ä¹ˆæ¡ä»¶çš„æŠ¥æ–‡ï¼Œåšæ€æ ·æ€æ ·çš„å¤„ç†ã€‚ç¬¬ä¸€æ­¥å°±æ˜¯æ’°å†™æŠ¥æ–‡çš„åŒ¹é…è§„åˆ™ï¼Œç„¶åè®¾ç½®å¤„ç†åŠ¨ä½œã€‚è¿™é‡Œæ”¶é›† iptables æä¾›çš„æŠ¥æ–‡åŒ¹é…æ–¹æ³•ã€‚</p>
<h2 id="åŸºæœ¬åŒ¹é…"><a class="header" href="#åŸºæœ¬åŒ¹é…">åŸºæœ¬åŒ¹é…</a></h2>
<p><code>man iptables</code> çš„ PARAMETERS ä¸­åˆ—å‡ºå¯ä»¥åœ¨è§„åˆ™ä¸­ä½¿ç”¨çš„å‚æ•°ï¼š</p>
<pre><code class="language-sh">-4, --ipv4
-6, --ipv6
[!] -p, --protocol protocol
[!] -s, --source address[/mask][,...]
[!] -d, --destination address[/mask][,...]
[!] -i, --in-interface name
[!] -o, --out-interface name
[!] -f, --fragment      # åŒ¹é…åˆ†ç‰‡æŠ¥æ–‡
                        # This means that the rule only refers to second and 
                        # further IPv4 fragments of fragmented packets.
</code></pre>
<h3 id="æ”¯æŒçš„åè®®"><a class="header" href="#æ”¯æŒçš„åè®®">æ”¯æŒçš„åè®®</a></h3>
<p>-p åé¢çš„ protocol å¯ä»¥æ˜¯æ•°å­—è¡¨ç¤ºçš„åè®®å·ï¼Œå¯ä»¥æ˜¯ä¸‹é¢çš„å­—ç¬¦ä¸²ï¼ˆ0 å’Œ &quot;all&quot; è¡¨ç¤ºåŒ¹é…æ‰€æœ‰åè®®ï¼‰ï¼Œæˆ–è€… /etc/protocols ä¸­åˆ—å‡ºçš„åè®®åï¼š</p>
<pre><code class="language-sh">tcp, udp, udplite, icmp, icmpv6, esp, ah, sctp, mh, all
</code></pre>
<pre><code class="language-sh">$ cat /etc/protocols
# /etc/protocols:
# $Id: protocols,v 1.11 2011/05/03 14:45:40 ovasik Exp $
#
# Internet (IP) protocols
#
#	from: @(#)protocols	5.1 (Berkeley) 4/17/89
#
# Updated for NetBSD based on RFC 1340, Assigned Numbers (July 1992).
# Last IANA update included dated 2011-05-03
#
# See also http://www.iana.org/assignments/protocol-numbers

ip	0	IP		# internet protocol, pseudo protocol number
hopopt	0	HOPOPT		# hop-by-hop options for ipv6
icmp	1	ICMP		# internet control message protocol
igmp	2	IGMP		# internet group management
...çœç•¥...
</code></pre>
<h2 id="æ‰©å±•åŒ¹é…"><a class="header" href="#æ‰©å±•åŒ¹é…">æ‰©å±•åŒ¹é…</a></h2>
<p>åŸºæœ¬åŒ¹é…çš„è§„åˆ™æ¯”è¾ƒç®€å•ï¼Œåªæœ‰åè®®ã€æºåœ°å€ã€ç›®çš„åœ°å€ã€æ¥æ”¶ç½‘å¡ã€å‘é€ç½‘å¡å’Œåˆ†ç‰‡æŠ¥æ–‡ï¼Œè¿™å‡ ç§åŒ¹é…æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œiptables çš„ -m å‚æ•°å¯ä»¥æŒ‡å®šæ‰©å±•æ¨¡å—ï¼Œå®ç°æ›´å¤æ‚ã€æ›´ç²¾ç»†çš„åŒ¹é…ï¼š</p>
<pre><code class="language-sh">-m, --match match
</code></pre>
<p>iptables æä¾›çš„æ‰©å±•æ¨¡å—éå¸¸å¤šï¼Œç§ç±»å’Œç”¨æ³•å¯ä»¥åœ¨ <code>man iptables-extensions</code> ä¸­çœ‹åˆ°ã€‚</p>
<p>æ‰©å±•æ¨¡å—åˆ†ä¸º MATCH EXTENSIONS å’Œ TARGET EXTENSIONS ä¸¤ç±»ï¼Œå‰è€…ç”¨äºæŠ¥æ–‡åŒ¹é…ï¼Œåè€…ç”¨äºæŠ¥æ–‡å¤„ç†ã€‚</p>
<p>ä¸‹é¢æ˜¯ MATCH EXTENSIONS åˆ—è¡¨ï¼š</p>
<pre><code class="language-sh">addrtype
ah (IPv6-specific)
ah (IPv4-specific)
bpf
cgroup
cluster
comment
connbytes
connlabel
connlimit
connmark
conntrack
cpu
dccp
devgroup
dscp
dst (IPv6-specific)
ecn
esp
eui64 (IPv6-specific)
frag (IPv6-specific)
hashlimit
hbh (IPv6-specific)
helper
hl (IPv6-specific)
icmp (IPv4-specific)
icmp6 (IPv6-specific)
iprange
ipv6header (IPv6-specific)
ipvs
length
limit
mac
mark
mh (IPv6-specific)
multiport
nfacct
osf
owner
physdev
pkttype
policy
quota
rateest
realm (IPv4-specific)
recent
rpfilter
rt (IPv6-specific)
sctp
set
socket
state
statistic
string
tcp
tcpmss
time
tos
ttl (IPv4-specific)
u32
udp
unclean (IPv4-specific)
</code></pre>
<h3 id="åŒ¹é…ç‰¹å®šç”¨æˆ·çš„æŠ¥æ–‡"><a class="header" href="#åŒ¹é…ç‰¹å®šç”¨æˆ·çš„æŠ¥æ–‡">åŒ¹é…ç‰¹å®šç”¨æˆ·çš„æŠ¥æ–‡</a></h3>
<p>istio ä¸­ç”¨<a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/11/01/istio-packet-forward.html#initcontainers-%E7%94%A8%E9%80%94%E5%88%86%E6%9E%90" title="æœåŠ¡ç½‘æ ¼/ServiceMesh é¡¹ç›® istio çš„æµé‡é‡å®šå‘ã€ä»£ç†è¯·æ±‚è¿‡ç¨‹åˆ†æ">ä¸‹é¢çš„æ–¹æ³•</a>ï¼Œå¯¹åº”ç”¨æˆ· 1337 å¯åŠ¨çš„ envoy è¿›ç¨‹åˆ›å»ºçš„æŠ¥æ–‡å•ç‹¬å¤„ç†ï¼š</p>
<pre><code class="language-sh">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
</code></pre>
<p>ä½¿ç”¨ç”¨æˆ·åä¹Ÿå¯ä»¥ï¼š</p>
<pre><code class="language-sh">iptables -t nat -A LOCAL_PROXY -m owner --uid-owner nginx -j RETURN
</code></pre>
<h2 id="å‚è€ƒ-7"><a class="header" href="#å‚è€ƒ-7">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="iptable-çš„æŠ¥æ–‡å¤„ç†åŠ¨ä½œ"><a class="header" href="#iptable-çš„æŠ¥æ–‡å¤„ç†åŠ¨ä½œ">iptable çš„æŠ¥æ–‡å¤„ç†åŠ¨ä½œ</a></h1>
<p>è®¾ç½® <a href="linuxsys/./iptables-match.html">åŒ¹é…è§„åˆ™</a> åï¼Œä¸ºæŠ¥æ–‡è®¾ç½®å¤„ç†åŠ¨ä½œã€‚</p>
<p>æŠ¥æ–‡å¤„ç†åŠ¨ä½œç”¨ä¸‹é¢æ˜¯ä¸‰ä¸ªå‚æ•°æŒ‡å®šï¼š</p>
<pre><code class="language-sh">-j, --jump target                  # ä½¿ç”¨æŒ‡å®šçš„æ‰©å±•æ¨¡å—å¤„ç†æŠ¥æ–‡ï¼Œå¤„ç†å®Œæˆåè¿”å›
-g, --goto chain                   # è·³è½¬åˆ°å¦ä¸€æ¡è§„åˆ™é“¾å¤„ç†
-c, --set-counters packets bytes   # è®¡æ•°å™¨é‡ç½®
</code></pre>
<p>æŠ¥æ–‡å¤„ç†åŠ¨ä½œä¸»è¦æ˜¯ç”¨ <code>-j</code> æŒ‡å®šï¼Œ-j ä¹Ÿå¯ä»¥åƒ -g ä¸€æ ·æŒ‡å‘å¦ä¸€æ¡è§„åˆ™é“¾ã€‚</p>
<p>å¦ä¸€æ¡è§„åˆ™é“¾æˆ‘ä»¬æŠŠå®ƒç§°ä¸ºå­é“¾ï¼š</p>
<ul>
<li>å¦‚æœå­é“¾æ˜¯é€šè¿‡ <code>-j</code> è·³è½¬çš„ï¼Œå­é“¾ä¸­çš„ return åŠ¨ä½œä¼šç»ˆæ­¢å­é“¾ä¸­å¤„ç†ï¼Œè¿”å›åˆ°çˆ¶é“¾ä¸­ç»§ç»­å¤„ç†</li>
<li>å¦‚æœå­é“¾æ˜¯é€šè¿‡ <code>-g</code> è·³è½¬çš„ï¼Œå­é“¾ä¸­çš„ return åŠ¨ä½œä¼šç»ˆæ­¢å­é“¾ä¸­å¤„ç†ï¼Œä¸”è·³è¿‡çˆ¶é“¾çš„åç»­è§„åˆ™</li>
</ul>
<blockquote>
<p>Unlike the --jump option return will not continue processing in this chain but instead in the chain that called us via --jump.</p>
</blockquote>
<h2 id="åŸºæœ¬åŠ¨ä½œ"><a class="header" href="#åŸºæœ¬åŠ¨ä½œ">åŸºæœ¬åŠ¨ä½œ</a></h2>
<pre><code class="language-sh">ACCEPT    # æ”¾è¡ŒæŠ¥æ–‡
DROP      # ä¸¢å¼ƒæŠ¥æ–‡
RETURN    # è¿”å›åˆ°ä¸Šä¸€æ¡è§„åˆ™é“¾ä¸­ç»§ç»­å¤„ç†
</code></pre>
<h2 id="æ‰©å±•åŠ¨ä½œ"><a class="header" href="#æ‰©å±•åŠ¨ä½œ">æ‰©å±•åŠ¨ä½œ</a></h2>
<p>å¤§éƒ¨åˆ†å¤„ç†æ˜¯ç”¨æ‰©å±•å®Œæˆçš„ï¼Œåœ¨ <code>man iptables-extensions</code> ä¸­å¯ä»¥çœ‹åˆ°æ”¯æŒçš„æ‰©å±•åŠ¨ä½œï¼š</p>
<pre><code>AUDIT
CHECKSUM
CLASSIFY
CLUSTERIP (IPv4-specific)
CONNMARK
CONNSECMARK
CT
DNAT
DNPT (IPv6-specific)
DSCP
ECN (IPv4-specific)
HL (IPv6-specific)
HMARK
IDLETIMER
LED
LOG
MARK
MASQUERADE
MIRROR (IPv4-specific)
NETMAP
NFLOG
NFQUEUE
NOTRACK
RATEEST
REDIRECT
REJECT (IPv6-specific)
REJECT (IPv4-specific)
SAME (IPv4-specific)
SECMARK
SET
SNAT
SNPT (IPv6-specific)
TCPMSS
TCPOPTSTRIP
TEE
TOS
TPROXY
TRACE
TTL (IPv4-specific)
ULOG (IPv4-specific)
</code></pre>
<h3 id="æŠ¥æ–‡é‡å®šå‘"><a class="header" href="#æŠ¥æ–‡é‡å®šå‘">æŠ¥æ–‡é‡å®šå‘</a></h3>
<p>REDIRECT èƒ½å¤Ÿåœ¨ nat è¡¨çš„ PREROUTING å’Œ OUTPUT é“¾ä¸­ï¼Œå°†æŠ¥æ–‡çš„ç›®åœ° IP ä¿®æ”¹ä¸ºæ¥æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡çš„ç½‘å¡çš„ IPï¼Œä»è€Œå°†æŠ¥æ–‡é‡å®šå‘åˆ°æœ¬åœ°çš„ç›‘å¬åœ°å€ã€‚</p>
<p>ç›®æ ‡ç«¯å£å¦‚æœä¸æŒ‡å®šåˆ™ä¸ä¿®æ”¹ï¼Œå¤ç”¨åŸå§‹æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ï¼š</p>
<pre><code class="language-sh">--to-ports port[-port]   # å°†ç›®æ ‡ç«¯å£ä¿®æ”¹ä¸ºèŒƒå›´å†…çš„æ•°å€¼
--random                 # ä¸ºç›®æ ‡ç«¯å£éšæœºå–å€¼
</code></pre>
<p>ç¤ºä¾‹ï¼Œ<a href="linuxsys/../nginx/proxy.html">nginx æœ¬åœ°é€æ˜ä»£ç†</a>ï¼š</p>
<pre><code class="language-sh"># æ–°å»ºä¸€ä¸ªè§„åˆ™é“¾ 
iptables -t nat -N LOCAL_PROXY

# ä¸ä»£ç† nginx ç”Ÿæˆçš„æŠ¥æ–‡ï¼Œé˜²æ­¢å‡ºç° nginx ä»£ç† nginx çš„æ­»å¾ªç¯
iptables -t nat -A LOCAL_PROXY -m owner --uid-owner nginx -j RETURN

# å°†æœ¬åœ°ç”Ÿæˆçš„ç›®æ ‡ç«¯å£ä¸º 8080 çš„ tcp æŠ¥æ–‡ï¼Œé‡å®šå‘åˆ°æœ¬åœ°çš„ :8080 ç›‘å¬åœ°å€
iptables -t nat -A LOCAL_PROXY -p tcp -m tcp --dport 8080 -j REDIRECT --to-ports 8080
</code></pre>
<h2 id="å‚è€ƒ-8"><a class="header" href="#å‚è€ƒ-8">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linux-çš„ç½‘ç»œè®¾ç½®"><a class="header" href="#linux-çš„ç½‘ç»œè®¾ç½®">Linux çš„ç½‘ç»œè®¾ç½®</a></h1>
<h2 id="linux-çš„-local-åœ°å€çš„è®¤å®š"><a class="header" href="#linux-çš„-local-åœ°å€çš„è®¤å®š">Linux çš„ Local åœ°å€çš„è®¤å®š</a></h2>
<p>127.0.0.1 é»˜è®¤æ˜¯ local åœ°å€ï¼Œå…¶å®è®¤å®šä¸º local åœ°å€çš„ IP æ˜¯å¯ä»¥è®¾ç½®çš„ï¼š</p>
<ul>
<li>åœ¨ mangle è¡¨ä¸­ä¸ºè¦è¢«è½¬å‘çš„æŠ¥æ–‡æ‰“ä¸Šæ ‡è®° 1 </li>
<li>æŒ‡å®šå¸¦æœ‰ä¸Šè¿°æ ‡è®°çš„æŠ¥æ–‡ä½¿ç”¨è·¯ç”±è¡¨ 100</li>
<li>å°† 0.0.0.0/0ï¼ˆå³æ‰€æœ‰ IPï¼‰è®¾ç½®ä¸ºè·¯ç”±è¡¨ 100 çš„ local</li>
</ul>
<pre><code class="language-sh">iptables -t mangle -I PREROUTING -p udp --dport 5301 -j MARK --set-mark 1
ip rule add fwmark 1 lookup 100
ip route add local 0.0.0.0/0 dev lo table 100
</code></pre>
<p>è®¾ç½®ä¸Šè¿°è§„åˆ™åï¼Œæ‰€æœ‰ç›®æ ‡ç«¯å£ä¸º 5301 çš„ UDP æŠ¥æ–‡ï¼Œæ— è®ºç›®çš„åœ°å€æ˜¯å¤šå°‘ï¼Œéƒ½è¢«è®¤ä¸ºæ˜¯å‘é€åˆ°ç»™æœ¬æœºï¼ˆlocalï¼‰çš„ã€‚ç›‘å¬æœ¬åœ°åœ°å€ 0.0.0.0:5301ï¼Œä¼šæ”¶åˆ°æ‰€æœ‰ç›®æ ‡ç«¯å£ä¸º 5301 çš„ udp æŠ¥æ–‡ï¼Œæ— è®ºæŠ¥æ–‡çš„ç›®çš„ IP æ˜¯ä¸æ˜¯æœ¬åœ° IPã€‚</p>
<h2 id="å‚è€ƒ-9"><a class="header" href="#å‚è€ƒ-9">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linux-çš„èµ„æºç®¡ç†"><a class="header" href="#linux-çš„èµ„æºç®¡ç†">Linux çš„èµ„æºç®¡ç†</a></h1>
<h2 id="cgroup"><a class="header" href="#cgroup">cgroup</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E6%96%B9%E6%B3%95/2019/12/21/how-to-study-cgroup.html">æ€æ ·æŒæ¡ Linux çš„ cgroupï¼Ÿèµ„æºé™åˆ¶æœºåˆ¶ cgroup å­¦ä¹ æŒ‡å¼•ä¸æ¦‚å¿µè¾¨æ</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/07/26/linux-tool-cgroup.html">cgroupï¼ˆä¸€ï¼‰ï¼šåˆçº§å…¥é—¨ä½¿ç”¨æ–¹æ³•</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2019/01/28/linux-tool-cgroup-detail.html">cgroupï¼ˆäºŒï¼‰ï¼šèµ„æºé™åˆ¶ cgroup v1 å’Œ cgroup v2 çš„è¯¦ç»†ä»‹ç»</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2019/02/18/linux-tool-cgroup-parameters.html">cgroupï¼ˆä¸‰ï¼‰ï¼šcgroup controller æ±‡æ€»å’Œæ§åˆ¶å™¨çš„å‚æ•°ï¼ˆæ–‡ä»¶æ¥å£ï¼‰</a></li>
</ul>
<h2 id="å‚è€ƒ-10"><a class="header" href="#å‚è€ƒ-10">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="hyperledger-è¶…çº§è´¦æœ¬é¡¹ç›®å­¦ä¹ "><a class="header" href="#hyperledger-è¶…çº§è´¦æœ¬é¡¹ç›®å­¦ä¹ ">HyperLedger è¶…çº§è´¦æœ¬é¡¹ç›®å­¦ä¹ </a></h1>
<p>ç¬¬ä¸€æ¬¡æ¥è§¦è¶…çº§è´¦æœ¬å·®ä¸å¤šæ˜¯ä¸¤å¹´å‰äº†ï¼Œå½“æ—¶è®°å½•äº†å¤§é‡çš„ <a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">hyperledger å­¦ä¹ ç¬”è®°</a>ï¼Œè¿˜åšäº†ä¸¤å¥—è§†é¢‘æ•™ç¨‹ï¼š</p>
<ul>
<li><a href="https://study.163.com/course/courseMain.htm?courseId=1005326005&amp;share=2&amp;shareId=400000000376006">HyperLedger Fabricæ‰‹æŠŠæ‰‹å…¥é—¨</a></li>
<li><a href="https://study.163.com/course/courseMain.htm?courseId=1005359012&amp;share=2&amp;shareId=400000000376006">HyperLedger Fabricè¿›é˜¶å®æˆ˜è¯¾</a></li>
</ul>
<p>åœ¨è¿‡å»ä¸¤å¹´å¤šçš„æ—¶é—´é‡Œï¼Œé™†ç»­æœ‰äººæ¥å’¨è¯¢ HyperLedger ç›¸å…³çš„é—®é¢˜ï¼Œæ„Ÿè§‰ä»¥åœ¨æ ¡å­¦ç”Ÿå±…å¤šã€‚ä¸å°‘äººæŒ‰ç…§ç½‘ä¸Šçš„å…¶å®ƒæ•™ç¨‹æ“ä½œï¼Œé‡åˆ°é—®é¢˜åæ— æ³•è§£å†³ï¼Œåˆ°å¤„æ±‚æ•‘ã€‚æ„Ÿè§‰æœ‰å¿…è¦é‡æ–°æ•´ç†å‡ºä¸€ä»½æ›´ç®€å•æ¸…æ™°çš„å…¥é—¨æ•™ç¨‹ã€‚</p>
<p>ç°åœ¨å·¥ä½œé‡ç‚¹å‘ç”Ÿäº†è½¬ç§»ï¼Œå¯¹ HyperLedger å…³æ³¨å¾ˆå°‘ï¼Œä¸€äº›éå¸¸ç»†èŠ‚çš„é—®é¢˜ï¼Œæˆ‘å¾ˆå¯èƒ½ä¹Ÿæ— æ³•è§£ç­”ï¼Œä½†åšä¸€ä»½å…¥é—¨æ•™ç¨‹ï¼Œè®©ã€Œå°ç™½ã€ç…§ç€æ•²å‘½ä»¤èƒ½è·‘é€šï¼Œè¿˜åœ¨æˆ‘çš„èƒ½åŠ›èŒƒå›´å†…ã€‚</p>
<p>å›æƒ³èµ·å½“å¹´åœ¨å­¦æ ¡æŠ˜è…¾ linux ç­‰å„ç§ç³»ç»Ÿæ—¶çš„æƒ…æ™¯ï¼Œé¥±ç»è¹‚èºï¼Œä¸€ä¸ªåˆ†å·æŸ¥ä¸€ä¸‹åˆçš„äº‹æƒ…ç»å¸¸æœ‰ã€‚æ‰¾åˆ°ä¸€ä¸ªæ•™ç¨‹ï¼Œç„¶åè¿™ä¸ªè·‘ä¸é€šã€é‚£ä¸ªè·‘ä¸é€šï¼Œä¸€è„¸æ‡µé€¼ï¼Œä¸¤çœ¼æŠ“çï¼Œé‚£ç§ç—›è‹¦å•Šã€‚å¹¶ä¸”å¸¸å¸¸ä¸ºäº†è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œè¢«è¿«å»äº†è§£äº† N ç§çŸ¥è¯†ã€‚</p>
<p>æˆ‘ä¼šå°½é‡è®©è¿™ä»½å…¥é—¨æ•™ç¨‹ç®€æ´ã€æµç•…ï¼Œå¦‚æœç”¨åˆ°äº†å…¶å®ƒæ–¹é¢çš„çŸ¥è¯†ï¼Œä¹Ÿä¼šå‘ŠçŸ¥æ–¹å‘ã€‚</p>
<h2 id="å‚è€ƒ-11"><a class="header" href="#å‚è€ƒ-11">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="hyperledger-fabricå•æœºæç®€éƒ¨ç½²"><a class="header" href="#hyperledger-fabricå•æœºæç®€éƒ¨ç½²">HyperLedger Fabricï¼šå•æœºæç®€éƒ¨ç½²</a></h1>
<p>è¿™æ˜¯ Fabric æ–‡æ¡£ <a href="https://hyperledger-fabric.readthedocs.io/en/latest/build_network.html" title="Building Your First Network">Building Your First Network</a> ä¸­æä¾›çš„åšæ³•ã€‚Fabric çš„ç¤ºä¾‹æ–‡ä»¶ä¸­æä¾›äº† ä¸€ä¸ªåä¸º â€œbyfn.shâ€ çš„è„šæœ¬ ï¼Œè¿™ä¸ªè„šæœ¬ç”¨ Docker åœ¨æœ¬åœ°æ­å»ºäº†ä¸€å¥— Fabricã€‚</p>
<p>ç”¨ byfn æ­å»ºçš„ Fabric éå¸¸ä¸å®ç”¨ï¼Œåªé€‚åˆç”¨æ¥å­¦ä¹ ï¼Œä½†æ˜¯æˆ‘å‘ç°å¾ˆå¤šäººèµ·æ­¥æ—¶éƒ½é‡‡ç”¨çš„è¿™ç§æ–¹å¼ã€‚å¹¶ä¸”å½“æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªç®€å•çš„ Fabric ç¯å¢ƒè¿›è¡Œç®€å•éªŒè¯æ—¶ï¼Œç”¨ byfn åˆ›å»ºæ¯”è¾ƒæ–¹ä¾¿ã€‚</p>
<p>å®é™…åº”ç”¨å¿…é¡»é‡‡ç”¨å¤šèŠ‚ç‚¹çš„æ–¹å¼éƒ¨ç½²ï¼Œå¤šèŠ‚ç‚¹éƒ¨ç½²å¯ä»¥å‚è€ƒå†å²æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html">ã€è§†é¢‘ã€‘è¶…çº§è´¦æœ¬HyperLedgerï¼šFabricçš„å…¨æ‰‹åŠ¨ã€å¤šæœåŠ¡å™¨éƒ¨ç½²æ•™ç¨‹</a></li>
</ul>
<h2 id="å‡†å¤‡ä¾èµ–çš„è½¯ä»¶"><a class="header" href="#å‡†å¤‡ä¾èµ–çš„è½¯ä»¶">å‡†å¤‡ä¾èµ–çš„è½¯ä»¶</a></h2>
<p>ç¬¬ä¸€ï¼Œå®‰è£… dockerã€‚è¦æŒæ¡ç”¨ byfn æ­å»º fabric çš„æ–¹æ³•ï¼Œå¿…é¡»è¦å¯¹ docker æœ‰åŸºæœ¬çš„äº†è§£ï¼Œåˆ° <a href="hyperledger/../docker/index.html">Dockerä½¿ç”¨æ‰‹å†Œ</a> ä¸­å­¦ä¹ ã€‚</p>
<p>ç¬¬äºŒï¼Œå®‰è£… gitã€‚git æ˜¯ç°åœ¨æœ€å¸¸ç”¨çš„ä»£ç ç®¡ç†å·¥å…·ï¼Œæˆ‘ä»¬è¦ç”¨ git ä» github ä¸­æ‹‰å– fabric-sample æ–‡ä»¶ï¼Œå¯ä»¥å‚è€ƒ <a href="hyperledger/../git/index.html">Gitä½¿ç”¨æ‰‹å†Œ</a>ï¼Œè¿™é‡Œåªç”¨ git è·å–ä»£ç ï¼Œä¸éœ€è¦æŒæ¡ä»£ç æäº¤ã€åˆå¹¶ç­‰ç”¨æ³•ï¼Œè™½ç„¶åœ¨ä»¥åçš„å·¥ä½œä¸­ä¸€å®šä¼šé‡åˆ°ã€‚</p>
<pre><code class="language-sh">$ yum install -y git      # CentOS ç³»ç»Ÿä¸Š
$ apt-get install -y git  # Ubuntu ç³»ç»Ÿä¸Š
$ brew install -y git     # Mac ç³»ç»Ÿä¸Š
</code></pre>
<h2 id="ä¸‹è½½-fabric-æ–‡ä»¶"><a class="header" href="#ä¸‹è½½-fabric-æ–‡ä»¶">ä¸‹è½½ Fabric æ–‡ä»¶</a></h2>
<p>å…ˆåˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•ï¼Œæ–‡ä»¶éƒ½å­˜æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸­ï¼š</p>
<pre><code class="language-sh">$ mkdir ~/hyperledger-fabric-1.4.4
$ cd ~/hyperledger-fabric-1.4.4
</code></pre>
<p>ä¸‹è½½ fabric æ–‡ä»¶ã€‚fabric æ¯ä¸ªç‰ˆæœ¬çš„ release æ–‡ä»¶éƒ½å‘å¸ƒåœ¨ <a href="https://github.com/hyperledger/fabric/releases" title="fabric releases">fabric releases</a> ä¸Šï¼š</p>
<p><img src="hyperledger/../img/fabric/fabric-down.png" alt="fabricæ–‡ä»¶ä¸‹è½½" /></p>
<p>æˆ‘ä½¿ç”¨çš„æ˜¯ Mac ç³»ç»Ÿï¼Œä¸‹è½½çš„æ˜¯ hyperledger-fabric-darwin-amd64-1.4.4.tar.gzï¼š</p>
<pre><code class="language-sh">$ wget https://github.com/hyperledger/fabric/releases/download/v1.4.4/hyperledger-fabric-darwin-amd64-1.4.4.tar.gz
</code></pre>
<blockquote>
<p>è¿™ä¸ªä¸‹è½½è¿‡ç¨‹å¯èƒ½å¾ˆæ…¢ï¼Œå¯èƒ½éœ€è¦ç¿»qiangã€‚</p>
</blockquote>
<p>ä¸‹è½½ byfn ç³»åˆ—è„šæœ¬ï¼š </p>
<pre><code class="language-sh">$ git clone https://github.com/hyperledger/fabric-samples.git
$ cd fabric-samples
$ git checkout -b v1.4.4 # æ ¹æ®éœ€è¦åˆ‡æ¢åˆ°å¯¹åº”ç‰ˆæœ¬
</code></pre>
<p>ä¸‹è½½è§£å‹åå¾—åˆ° bin å’Œ config ä¸¤ä¸ªç›®å½•ï¼Œbin ç›®å½•ä¸­æ˜¯ fabric çš„å‘½ä»¤æ–‡ä»¶ï¼Œconfig ä¸­ fabric çš„é…ç½®ç¤ºä¾‹ï¼š</p>
<pre><code class="language-sh">$ tar -xvf hyperledger-fabric-darwin-amd64-1.4.4.tar.gz
$ ls 
bin  config
</code></pre>
<p>æŠŠ bin ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ PATHï¼š</p>
<pre><code class="language-sh">export PATH=$PATH:~/hyperledger-fabric-1.4.4/bin
</code></pre>
<h2 id="å‡†å¤‡-first-network-éœ€è¦çš„è¯ä¹¦å’Œæ–‡ä»¶"><a class="header" href="#å‡†å¤‡-first-network-éœ€è¦çš„è¯ä¹¦å’Œæ–‡ä»¶">å‡†å¤‡ first-network éœ€è¦çš„è¯ä¹¦å’Œæ–‡ä»¶</a></h2>
<p>first-network å°±æ˜¯ä¸€ä¸ªæœ€ç®€å• fabricï¼Œå®ƒçš„éƒ¨ç½²æ–‡ä»¶ä½äº fabric-samples/first-networkï¼š</p>
<pre><code class="language-sh">$ cd fabric-samples/first-network
</code></pre>
<p>è¿›å…¥è¯¥ç›®å½•åï¼Œç”¨ byfn.sh åˆ›å»º first-network éœ€è¦çš„è¯ä¹¦æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ ./byfn.sh generate
</code></pre>
<p>å¦‚æœæç¤ºé”™è¯¯ï¼Œ&quot;cryptogen tool not found. exiting&quot;ï¼Œé‚£æ˜¯å› ä¸ºæ²¡æœ‰æŠŠ bin ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ PATH ä¸­ï¼š</p>
<pre><code class="language-sh">$ ./byfn.sh generate
Generating certs and genesis block for channel 'mychannel' with CLI timeout of '10' seconds and CLI delay of '3' seconds
Continue? [Y/n] y
proceeding ...
cryptogen tool not found. exiting  # å¦‚æœæ²¡æœ‰æŠŠ bin ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ PATH å°±ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼
</code></pre>
<p>æ‰§è¡ŒæˆåŠŸçš„ç»“æœå¦‚ä¸‹ã€‚</p>
<p>æ³¨æ„ ## ä¸­çš„æ–‡å­—ï¼Œâ€œGenerate certificates ...â€ï¼Œè¿™å°±æ˜¯ä¸ºç›¸åº”ç»„ç»‡æˆ–è€…æ¨¡å—ç”Ÿæˆäº†è¯ä¹¦ã€‚</p>
<p>first-network æ˜¯ç”± Org1 å’Œ Org2 ä¸¤ä¸ªæˆå‘˜ç»„æˆçš„åŒºå—é“¾ç½‘ç»œï¼Œç½‘ç»œä¸­æœ‰ä¸€ä¸ª Ordererï¼ŒOrg1 æœ‰ä¸¤ä¸ª Peerï¼ŒOrg2 æœ‰ä¸¤ä¸ª Peerï¼š</p>
<pre><code class="language-sh">âœ  first-network git:(v1.4.4) ./byfn.sh generate
Generating certs and genesis block for channel 'mychannel' with CLI timeout of '10' seconds and CLI delay of '3' seconds
Continue? [Y/n] y
proceeding ...
/Users/lijiao/hyperledger-fabric-1.4.4/bin/cryptogen

##########################################################
##### Generate certificates using cryptogen tool #########
##########################################################
+ cryptogen generate --config=./crypto-config.yaml
org1.example.com
org2.example.com
+ res=0
+ set +x

Generate CCP files for Org1 and Org2
/Users/lijiao/hyperledger-fabric-1.4.4/bin/configtxgen
##########################################################
#########  Generating Orderer Genesis block ##############
##########################################################
CONSENSUS_TYPE=solo
+ '[' solo == solo ']'
+ configtxgen -profile TwoOrgsOrdererGenesis -channelID byfn-sys-channel -outputBlock ./channel-artifacts/genesis.block
2019-11-26 22:23:26.404 CST [common.tools.configtxgen] main -&gt; INFO 001 Loading configuration
2019-11-26 22:23:26.527 CST [common.tools.configtxgen.localconfig] completeInitialization -&gt; INFO 002 orderer type: solo
2019-11-26 22:23:26.527 CST [common.tools.configtxgen.localconfig] Load -&gt; INFO 003 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:26.638 CST [common.tools.configtxgen.localconfig] completeInitialization -&gt; INFO 004 orderer type: solo
2019-11-26 22:23:26.638 CST [common.tools.configtxgen.localconfig] LoadTopLevel -&gt; INFO 005 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:26.643 CST [common.tools.configtxgen] doOutputBlock -&gt; INFO 006 Generating genesis block
2019-11-26 22:23:26.644 CST [common.tools.configtxgen] doOutputBlock -&gt; INFO 007 Writing genesis block
+ res=0
+ set +x

#################################################################
### Generating channel configuration transaction 'channel.tx' ###
#################################################################
+ configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel
2019-11-26 22:23:26.686 CST [common.tools.configtxgen] main -&gt; INFO 001 Loading configuration
2019-11-26 22:23:26.794 CST [common.tools.configtxgen.localconfig] Load -&gt; INFO 002 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:26.899 CST [common.tools.configtxgen.localconfig] completeInitialization -&gt; INFO 003 orderer type: solo
2019-11-26 22:23:26.899 CST [common.tools.configtxgen.localconfig] LoadTopLevel -&gt; INFO 004 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:26.899 CST [common.tools.configtxgen] doOutputChannelCreateTx -&gt; INFO 005 Generating new channel configtx
2019-11-26 22:23:26.905 CST [common.tools.configtxgen] doOutputChannelCreateTx -&gt; INFO 006 Writing new channel tx
+ res=0
+ set +x

#################################################################
#######    Generating anchor peer update for Org1MSP   ##########
#################################################################
+ configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP
2019-11-26 22:23:26.943 CST [common.tools.configtxgen] main -&gt; INFO 001 Loading configuration
2019-11-26 22:23:27.049 CST [common.tools.configtxgen.localconfig] Load -&gt; INFO 002 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:27.165 CST [common.tools.configtxgen.localconfig] completeInitialization -&gt; INFO 003 orderer type: solo
2019-11-26 22:23:27.165 CST [common.tools.configtxgen.localconfig] LoadTopLevel -&gt; INFO 004 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:27.165 CST [common.tools.configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 005 Generating anchor peer update
2019-11-26 22:23:27.166 CST [common.tools.configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 006 Writing anchor peer update
+ res=0
+ set +x

#################################################################
#######    Generating anchor peer update for Org2MSP   ##########
#################################################################
+ configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP
2019-11-26 22:23:27.206 CST [common.tools.configtxgen] main -&gt; INFO 001 Loading configuration
2019-11-26 22:23:27.347 CST [common.tools.configtxgen.localconfig] Load -&gt; INFO 002 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:27.473 CST [common.tools.configtxgen.localconfig] completeInitialization -&gt; INFO 003 orderer type: solo
2019-11-26 22:23:27.473 CST [common.tools.configtxgen.localconfig] LoadTopLevel -&gt; INFO 004 Loaded configuration: /Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/configtx.yaml
2019-11-26 22:23:27.473 CST [common.tools.configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 005 Generating anchor peer update
2019-11-26 22:23:27.474 CST [common.tools.configtxgen] doOutputAnchorPeersUpdate -&gt; INFO 006 Writing anchor peer update
+ res=0
+ set +x
</code></pre>
<h2 id="å¯åŠ¨-first-network"><a class="header" href="#å¯åŠ¨-first-network">å¯åŠ¨ first-network</a></h2>
<p>å¯åŠ¨è¿‡ç¨‹ä¸­è¦æ‹‰å– fabric çš„ docker é•œåƒï¼Œåœ¨å›½å†…å¯èƒ½ç‰¹åˆ«æ…¢ï¼Œå»ºè®®å…ˆç»™ docker <a href="hyperledger/../docker/config.html">é…ç½®é•œåƒæº</a> ï¼š</p>
<p>first-network å¯åŠ¨å‘½ä»¤ï¼š</p>
<pre><code class="language-sh">$ ./byfn.sh up
Starting for channel 'mychannel' with CLI timeout of '10' seconds and CLI delay of '3' seconds
Continue? [Y/n] y
proceeding ...
Unable to find image 'hyperledger/fabric-tools:latest' locally
latest: Pulling from hyperledger/fabric-tools
7ddbc47eeb70: Pulling fs layer
c1bbdc448b72: Pulling fs layer

...çœç•¥...

90
===================== Query successful on peer1.org2 on channel 'mychannel' =====================

========= All GOOD, BYFN execution completed ===========


 _____   _   _   ____
| ____| | \ | | |  _ \
|  _|   |  \| | | | | |
| |___  | |\  | | |_| |
|_____| |_| \_| |____/
</code></pre>
<p>å‡ºç° All GOOD åï¼Œå¯åŠ¨æˆåŠŸã€‚</p>
<h2 id="first-network-çš„ç»„æˆ"><a class="header" href="#first-network-çš„ç»„æˆ">first-network çš„ç»„æˆ</a></h2>
<p>ç”¨ docker ps å¯ä»¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œæœ€åä¸€åˆ—æ˜¯å®¹å™¨çš„åç§°ï¼š</p>
<pre><code class="language-sh">âœ  first-network git:(v1.4.4) âœ— docker ps
CONTAINER ID        IMAGE                                            COMMAND                  CREATED             STATUS              PORTS                      NAMES
b2d7c1e32b74        dev-peer1.org2.example.com-mycc-1.0-26c2ef3283   &quot;chaincode -peer.addâ€¦&quot;   5 minutes ago       Up 5 minutes                                   dev-peer1.org2.example.com-mycc-1.0
4e3b06b72953        dev-peer0.org1.example.com-mycc-1.0-384f11f484   &quot;chaincode -peer.addâ€¦&quot;   5 minutes ago       Up 5 minutes                                   dev-peer0.org1.example.com-mycc-1.0
6aebf7da1213        dev-peer0.org2.example.com-mycc-1.0-15b571b3ce   &quot;chaincode -peer.addâ€¦&quot;   6 minutes ago       Up 6 minutes                                   dev-peer0.org2.example.com-mycc-1.0
bb5b01488fe5        hyperledger/fabric-tools:latest                  &quot;/bin/bash&quot;              7 minutes ago       Up 7 minutes                                   cli
7781e5181954        hyperledger/fabric-peer:latest                   &quot;peer node start&quot;        7 minutes ago       Up 7 minutes        0.0.0.0:7051-&gt;7051/tcp     peer0.org1.example.com
d5ae822f095a        hyperledger/fabric-orderer:latest                &quot;orderer&quot;                7 minutes ago       Up 7 minutes        0.0.0.0:7050-&gt;7050/tcp     orderer.example.com
844929c28283        hyperledger/fabric-peer:latest                   &quot;peer node start&quot;        7 minutes ago       Up 7 minutes        0.0.0.0:10051-&gt;10051/tcp   peer1.org2.example.com
5ff858ab54cc        hyperledger/fabric-peer:latest                   &quot;peer node start&quot;        7 minutes ago       Up 7 minutes        0.0.0.0:9051-&gt;9051/tcp     peer0.org2.example.com
7ab6831f4530        hyperledger/fabric-peer:latest                   &quot;peer node start&quot;        7 minutes ago       Up 7 minutes        0.0.0.0:8051-&gt;8051/tcp     peer1.org1.example.com
</code></pre>
<p>ç»„æˆ first-network çš„å®¹å™¨ï¼š</p>
<pre><code class="language-sh">orderer.example.com        å½¢æˆç»´æŠ¤å…±è¯†çš„ orderer 
peer0.org1.example.com     org1 çš„ç¬¬ä¸€ä¸ª peer
peer1.org1.example.com     org1 çš„ç¬¬äºŒä¸ª peer
peer0.org2.example.com     org2 çš„ç¬¬ä¸€ä¸ª peer
peer1.org2.example.com     org2 çš„ç¬¬äºŒä¸ª peer
</code></pre>
<p>ä¸‹é¢ä¸‰ä¸ªå®¹å™¨æ˜¯ byfn.sh è„šæœ¬åˆ›å»ºçš„ä¸€ä¸ªåä¸º mycc çš„æ™ºèƒ½åˆçº¦ï¼Œfabric çš„æ™ºèƒ½åˆçº¦æ˜¯ç”¨ docker è¿è¡Œçš„ï¼š</p>
<pre><code class="language-sh">dev-peer1.org2.example.com-mycc-1.0
dev-peer0.org1.example.com-mycc-1.0
dev-peer0.org2.example.com-mycc-1.0
</code></pre>
<p>cli å®¹å™¨ç”¨æ¥æŸ¥çœ‹ã€ç®¡ç† first-networkï¼Œç”¨ä¸‹é¢çš„æ–¹æ³•è¿›å…¥ï¼š</p>
<pre><code class="language-sh">$ docker exec -it cli /bin/bash
root@bb5b01488fe5:/opt/gopath/src/github.com/hyperledger/fabric/peer#
</code></pre>
<p>åœ¨å®¹å™¨å†…æ‰§è¡Œ lsï¼Œå¯ä»¥çœ‹åˆ°åˆ›å»º first-network æ—¶ç”¨åˆ°æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ ls -lh
total 28K
drwxr-xr-x  7 root root 224 Nov 26 14:23 channel-artifacts
drwxr-xr-x  4 root root 128 Nov 26 14:23 crypto
-rw-r--r--  1 root root   3 Nov 26 14:34 log.txt
-rw-r--r--  1 root root 21K Nov 26 14:31 mychannel.block
drwxr-xr-x 10 root root 320 Nov 25 14:52 scripts
</code></pre>
<h2 id="first-network-æ˜¯æ€ä¹ˆå›äº‹"><a class="header" href="#first-network-æ˜¯æ€ä¹ˆå›äº‹">first-network æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</a></h2>
<p>è¿™ä¸ªé—®é¢˜ä¸‰è¨€ä¸¤è¯­è¿˜çœŸæ˜¯è¯´ä¸æ¸…æ¥šã€‚åˆ«çœ‹åˆ›å»º first-network ç‰¹åˆ«ç®€å•ï¼Œä½†æ˜¯ byfn.sh èƒŒåçš„å·¥ä½œæœ‰å¾ˆå¤šï¼ç”¨ docker-compose å’Œ ä¸€å †è„šæœ¬ã€‚å¼ºçƒˆå»ºè®®é€šè¿‡ä¸‹é¢æ•™ç¨‹å­¦ä¹  fabric çš„ç»„æˆã€‚è¿™ä¸ªæ•™ç¨‹ä½¿ç”¨çš„æ˜¯ fabric 1.1 ï¼ˆä¸¤å¹´å‰çš„ç‰ˆæœ¬ï¼‰ï¼Œä½†åŸºæœ¬åŸç†ä¸å˜ï¼ŒæŠŠæ¯ä¸ªç»„ä»¶çš„ç”¨é€”å’Œé…ç½®æ–¹æ³•éƒ½è®²æ¸…æ¥šäº†ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html">ã€è§†é¢‘ã€‘è¶…çº§è´¦æœ¬HyperLedgerï¼šFabricçš„å…¨æ‰‹åŠ¨ã€å¤šæœåŠ¡å™¨éƒ¨ç½²æ•™ç¨‹</a></li>
</ul>
<h2 id="å‚è€ƒ-12"><a class="header" href="#å‚è€ƒ-12">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="hyperledger-fabric-åŒºå—é“¾æµè§ˆå™¨çš„éƒ¨ç½²æ–¹æ³•"><a class="header" href="#hyperledger-fabric-åŒºå—é“¾æµè§ˆå™¨çš„éƒ¨ç½²æ–¹æ³•">HyperLedger Fabric åŒºå—é“¾æµè§ˆå™¨çš„éƒ¨ç½²æ–¹æ³•</a></h1>
<p><a href="https://github.com/hyperledger/blockchain-explorer" title="blockchain-explorer">blockchain-explorer</a> æ˜¯ä¸€ä¸ªç‹¬ç«‹é¡¹ç›®ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ fabric å†…çš„æˆå‘˜å’ŒåŒºå—ã€‚</p>
<h2 id="å®‰è£…ä¾èµ–çš„è½¯ä»¶"><a class="header" href="#å®‰è£…ä¾èµ–çš„è½¯ä»¶">å®‰è£…ä¾èµ–çš„è½¯ä»¶</a></h2>
<p>explorer ä¾èµ– nodejs 8.11ï¼ˆé«˜ç‰ˆæœ¬çš„ä¸æ”¯æŒï¼‰ã€PostgreSQL 9.5 å’Œä»¥ä¸Šç‰ˆæœ¬ã€jq å‘½ä»¤ã€‚</p>
<p>ä¸‹é¢çš„æ“ä½œæ˜¯åœ¨ Mac ä¸Šè¿›è¡Œçš„ï¼Œé™¤äº†ä¾èµ–è½¯ä»¶çš„å®‰è£…æ–¹å¼ï¼Œå¤§éƒ¨åˆ†æ“ä½œå’Œåœ¨ linux ä¸Šæ“ä½œç›¸åŒï¼š</p>
<p>ä»¥å‰çš„ç¬”è®°ï¼Œå¯å‚è€ƒå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼š<a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-explorer.html" title="è¶…çº§è´¦æœ¬HyperLedgerï¼šExplorerå®‰è£…ä½¿ç”¨">è¶…çº§è´¦æœ¬HyperLedgerï¼šExplorerå®‰è£…ä½¿ç”¨</a>ã€‚</p>
<h3 id="postgresql-å®‰è£…è®¾ç½®"><a class="header" href="#postgresql-å®‰è£…è®¾ç½®">PostgreSQL å®‰è£…è®¾ç½®</a></h3>
<p>å¦‚æœå¯¹ PostgreSQL å®Œå…¨ä¸äº†è§£ï¼Œå¯ä»¥å…ˆå­¦ä¹ ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/08/31/postgre-usage.html" title="PostgresSQLæ•°æ®åº“çš„åŸºæœ¬ä½¿ç”¨â€”â€”æ–°æ‰‹å…¥é—¨">PostgresSQLæ•°æ®åº“çš„åŸºæœ¬ä½¿ç”¨â€”â€”æ–°æ‰‹å…¥é—¨</a></li>
</ul>
<p>è¿™é‡Œä¸ºäº†å±è”½ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„å·®å¼‚ï¼Œç”¨ docker å¯åŠ¨ PostgreSQL æ•°æ®åº“ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæ‹‰å– Docker é•œåƒï¼Œ<a href="hyperledger/./demo.html">å•æœºæç®€éƒ¨ç½²</a> ä¸­æåˆ°è¿‡ docker çš„ä½¿ç”¨æ–¹æ³•å’Œæ‹‰å–é•œåƒæ…¢çš„é—®é¢˜ï¼š</p>
<pre><code class="language-sh">$ docker run -idt \
    -e POSTGRES_USER=&quot;postgres&quot; \
    -e POSTGRES_PASSWORD=&quot;password&quot; \
    -p 5432:5432  \
    postgres:latest
</code></pre>
<p>æœ¬åœ°è¿˜éœ€è¦å®‰è£… psqlï¼Œä¸€ä¸ªç”¨äºè¿æ¥ postgres æ•°æ®åº“çš„å‘½ä»¤ï¼š</p>
<pre><code class="language-sh">$ brew cask install postgresql               # Mac ä¸Šå®‰è£…æ–¹æ³•
$ yum install -y epel-release  postgresql    # CentOS ä¸Šå®‰è£…æ–¹æ³•
$ apt-get install  postgresql                # Ubuntu ä¸Šå®‰è£…æ–¹æ³•
</code></pre>
<p>ç¡®å®šèƒ½ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›å…¥æ•°æ®åº“ï¼Œå¯†ç æ˜¯ passwordï¼š</p>
<pre><code class="language-sh">$ psql -h 127.0.0.1 -U postgres
Password for user postgres:
psql (11.2, server 12.1 (Debian 12.1-1.pgdg100+1))
WARNING: psql major version 11, server major version 12.
         Some psql features might not work.
Type &quot;help&quot; for help.

postgres=#
</code></pre>
<h2 id="å®‰è£…-nodejs"><a class="header" href="#å®‰è£…-nodejs">å®‰è£… nodejs</a></h2>
<p>explorer è¦æ±‚ nodejs çš„ç‰ˆæœ¬ä¸èƒ½å¤ªé«˜ï¼Œå¿…é¡»æ˜¯ 8.x ç‰ˆæœ¬ã€‚</p>
<p>åœ¨ CentOS ä¸Šç›´æ¥ä¸‹è½½å®‰è£…ï¼š</p>
<pre><code class="language-sh">$ yum erase nodejs
$ wget https://nodejs.org/dist/v8.11.3/node-v8.11.3-linux-x64.tar.xz
$ tar -xvf node-v8.11.3-linux-x64.tar.xz
$ cd node-v8.11.3-linux-x64
$ cp -rf * /usr/
</code></pre>
<p>åœ¨ Mac ä¸Šç”¨ä¸‹é¢çš„æ–¹æ³•å®‰è£… node 8.xï¼š</p>
<pre><code class="language-sh">$ brew install node@8
</code></pre>
<p>ç¡®ä¿ node çš„ç‰ˆæœ¬æ˜¯ 8.xï¼Œç‰ˆæœ¬å¤ªé«˜å’Œå¤ªä½éƒ½ä¼šå‡ºç°å¥‡è‘©é—®é¢˜ï¼</p>
<pre><code class="language-sh">$ node --version
v8.16.3            # åœ¨ Mac ç”¨ 8.16.3 é€šè¿‡
</code></pre>
<blockquote>
<p>ç‰¹åˆ«æ³¨æ„ï¼šnode ç‰ˆæœ¬è¿‡é«˜æˆ–è¿‡ä½ï¼Œéƒ½ä¼šå‡ºç°å„ç§å¥‡è‘©é—®é¢˜ï¼</p>
</blockquote>
<h2 id="ä¸‹è½½-blockchain-explorer-æ–‡ä»¶"><a class="header" href="#ä¸‹è½½-blockchain-explorer-æ–‡ä»¶">ä¸‹è½½ blockchain-explorer æ–‡ä»¶</a></h2>
<p>æŠŠ blockchain-explorer ä¸‹è½½åˆ° ~/hyperledger-fabric-1.4.4 ç›®å½•ä¸­ï¼š</p>
<pre><code class="language-sh">$ cd ~/hyperledger-fabric-1.4.4
$ git clone https://github.com/hyperledger/blockchain-explorer.git
</code></pre>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ v0.3.9.5 ç‰ˆæœ¬ï¼Œexplorer å’Œ fabric çš„ç‰ˆæœ¬é€‚é…æƒ…å†µè§ <a href="https://github.com/hyperledger/blockchain-explorer/releases" title="blockchain-explorer release">blockchain-explorer release</a>ï¼š</p>
<pre><code class="language-sh">$ cd blockchain-explorer
$ git checkout -b v0.3.9.5    # v0.3.9.5 é€‚é… fabric 1.4
</code></pre>
<h2 id="æ ¸å®é…ç½®æ–‡ä»¶-appexplorerconfigjson"><a class="header" href="#æ ¸å®é…ç½®æ–‡ä»¶-appexplorerconfigjson">æ ¸å®é…ç½®æ–‡ä»¶ app/explorerconfig.json</a></h2>
<p>æ ¸å®é…ç½®æ–‡ä»¶ app/explorerconfig.jsonï¼Œç¡®å®šé‡Œé¢çš„æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯æ­£ç¡®çš„ï¼š</p>
<pre><code class="language-json">{
  &quot;persistence&quot;: &quot;postgreSQL&quot;,
  &quot;platforms&quot;: [&quot;fabric&quot;],
  &quot;postgreSQL&quot;: {
    &quot;host&quot;: &quot;127.0.0.1&quot;,
    &quot;port&quot;: &quot;5432&quot;,
    &quot;database&quot;: &quot;fabricexplorer&quot;,
    &quot;username&quot;: &quot;hppoc&quot;,
    &quot;passwd&quot;: &quot;password&quot;
  },
  &quot;sync&quot;: {
    &quot;type&quot;: &quot;local&quot;,
    &quot;platform&quot;: &quot;fabric&quot;,
    &quot;blocksSyncTime&quot;: &quot;3&quot;
  }
}
</code></pre>
<h2 id="åˆå§‹åŒ–-blockchain-explorer-ä½¿ç”¨çš„æ•°æ®åº“"><a class="header" href="#åˆå§‹åŒ–-blockchain-explorer-ä½¿ç”¨çš„æ•°æ®åº“">åˆå§‹åŒ– blockchain-explorer ä½¿ç”¨çš„æ•°æ®åº“</a></h2>
<p>åˆ›å»ºæ•°æ®åº“ï¼š</p>
<pre><code class="language-sh">$ cd app/persistence/fabric/postgreSQL/db
$ ./createdb.sh
</code></pre>
<p>æˆ‘åœ¨ Mac ä¸Šè¿è¡Œæ—¶é‡åˆ°ä¸‹é¢é”™è¯¯ï¼š</p>
<pre><code class="language-sh">$ ./createdb.sh
Copying ENV variables into temp file...
USER=&quot;hppoc&quot;
DATABASE=&quot;fabricexplorer&quot;
PASSWD='password'
Executing SQL scripts...
psql: could not connect to server: No such file or directory
	Is the server running locally and accepting
	connections on Unix domain socket &quot;/tmp/.s.PGSQL.5432&quot;?
psql: could not connect to server: No such file or directory
	Is the server running locally and accepting
	connections on Unix domain socket &quot;/tmp/.s.PGSQL.5432&quot;?
</code></pre>
<p>è¿™æ˜¯å› ä¸ºæˆ‘çš„ postgre æ˜¯ç”¨ docker å¯åŠ¨çš„ï¼Œè®¿é—®æ—¶éœ€è¦æŒ‡å®š IP åœ°å€å’Œç”¨æˆ·ï¼Œéœ€è¦ä¿®æ”¹ createdb.shã€‚</p>
<p>åœ¨ Mac ä¸Šï¼ŒæŠŠè¿™ä¸¤è¡Œï¼š</p>
<pre><code class="language-sh">darwin*) psql postgres -v dbname=$DATABASE -v user=$USER -v passwd=$PASSWD -f ./explorerpg.sql ;
psql postgres -v dbname=$DATABASE -v user=$USER -v passwd=$PASSWD -f ./updatepg.sql ;;
</code></pre>
<p>ä¿®æ”¹ä¸ºï¼š</p>
<pre><code class="language-sh">darwin*) psql postgres -h 127.0.0.1 -U postgres -v dbname=$DATABASE -v user=$USER -v passwd=$PASSWD -f ./explorerpg.sql ;
psql postgres -h 127.0.0.1 -U postgres -v dbname=$DATABASE -v user=$USER -v passwd=$PASSWD -f ./updatepg.sql ;;
</code></pre>
<p>åœ¨ Linux ä¸Šä¿®æ”¹æ–¹æ³•ç±»ä¼¼ï¼Œå°±æ˜¯åŠ ä¸Š -h 127.0.0.1 -U postgresï¼Œæˆ‘æ²¡è¯•éªŒï¼Œä½¿ç”¨ linux ç³»ç»Ÿçš„åŒå­¦å¯ä»¥è‡ªå·±è¯•ä¸€ä¸‹ï¼š</p>
<pre><code class="language-sh">linux*) psql postgres -h 127.0.0.1 -U postgres -v dbname=$DATABASE -v user=$USER -v passwd=$PASSWD -f ./explorerpg.sql ;
psql postgres -h 127.0.0.1 -U postgres -v dbname=$DATABASE -v user=$USER -v passwd=$PASSWD -f ./updatepg.sql ;;
</code></pre>
<p>ä¿®æ”¹åé‡æ–°æ‰§è¡Œ ./createdb.shï¼Œ è¿™æ—¶å€™ä¼šæç¤ºè¾“å…¥çš„å¯†ç ï¼Œå¯†ç å°±æ˜¯å‰é¢ç”¨ docker å¯åŠ¨æ•°æ®åº“æ—¶è®¾ç½®çš„ passwordã€‚
è¾“å‡ºçš„æœ€åä¸€è¡Œä¸ºä¸‹é¢çš„å†…å®¹æ—¶ï¼Œæ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼š</p>
<pre><code class="language-sh">You are now connected to database &quot;fabricexplorer&quot; as user &quot;postgres&quot;.
</code></pre>
<h2 id="è®¾ç½®-fabric-å¯¹æ¥æ–‡ä»¶"><a class="header" href="#è®¾ç½®-fabric-å¯¹æ¥æ–‡ä»¶">è®¾ç½® fabric å¯¹æ¥æ–‡ä»¶</a></h2>
<p>blockchain-explorer ä¸­çš„ app/platform/fabric/config.json æ˜¯ç”¨æ¥è¿æ¥ fabric çš„é…ç½®æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ ls app/platform/fabric/config.json
app/platform/fabric/config.json
</code></pre>
<p>æŸ¥çœ‹ config.json æ–‡ä»¶çš„å†…å®¹ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªæ–‡ä»¶ä¸­çš„é…ç½®é’ˆå¯¹çš„æ­£å¥½æ˜¯ <a href="hyperledger/./demo.html">ä¸Šä¸€èŠ‚</a> ä¸­åˆ›å»ºçš„ first-networkï¼š</p>
<pre><code class="language-sh">$ cat app/platform/fabric/config.json |grep peer
          &quot;peers&quot;: {
            &quot;peer0.org1.example.com&quot;: {}
              &quot;peer&quot;: {
            &quot;path&quot;: &quot;/fabric-path/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore&quot;
            &quot;path&quot;: &quot;/fabric-path/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/signcerts&quot;
            &quot;path&quot;: &quot;/fabric-path/fabric-samples/first-network/crypto-config/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp/keystore&quot;
      &quot;peers&quot;: {
        &quot;peer0.org1.example.com&quot;: {
            &quot;path&quot;: &quot;/fabric-path/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt&quot;
            &quot;ssl-target-name-override&quot;: &quot;peer0.org1.example.com&quot;
        &quot;peer1.org1.example.com&quot;: {
        &quot;peer0.org2.example.com&quot;: {
        &quot;peer1.org2.example.com&quot;: {
</code></pre>
<p>ä½†æ˜¯ config.json ä¸­çš„æ–‡ä»¶è·¯å¾„ä¸º â€œ/fabric-path/fabric....&quot;ï¼Œå’Œè¿™é‡Œçš„æ–‡ä»¶è·¯å¾„ä¸åŒï¼Œéœ€è¦å…¨éƒ¨ä¿®æ”¹ä¸ºï¼š</p>
<pre><code class="language-sh">&quot;path&quot;: &quot;/Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore&quot;
</code></pre>
<p>å¿…é¡»ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œè·¯å¾„ä¸èƒ½æ˜¯ <code>~</code>ï¼Œæˆ‘è¿™é‡Œæ˜¯ /Users/lijiaoï¼Œè®°å¾—æ¢æˆä½ è‡ªå·±çš„è·¯å¾„ï¼Œä¸‹é¢çš„å‘½ä»¤ä¸€æ¬¡ä¿®æ”¹å…¨éƒ¨ï¼š</p>
<pre><code class="language-sh"># Mac ä¸Šæ‰§è¡Œï¼š
$ sed -i &quot;&quot; -e &quot;s#/fabric-path#/Users/lijiao/hyperledger-fabric-1.4.4#&quot; app/platform/fabric/config.json
# Linux ä¸Šæ‰§è¡Œï¼š
$ sed -i -e &quot;s#/fabric-path#/Users/lijiao/hyperledger-fabric-1.4.4#&quot; app/platform/fabric/config.json
</code></pre>
<h2 id="ç¼–è¯‘å¯åŠ¨-blockchain-explorer"><a class="header" href="#ç¼–è¯‘å¯åŠ¨-blockchain-explorer">ç¼–è¯‘å¯åŠ¨ blockchain-explorer</a></h2>
<p>å®‰è£…ä¾èµ–åŒ…ï¼Œæ„å»º blockchain-explorerï¼š</p>
<pre><code class="language-sh">$ npm config set registry https://registry.npm.taobao.org  # æ·»åŠ æ·˜å®é•œåƒæºï¼ŒåŠ å¿«é€Ÿåº¦
$ cd blockchain-explorer
$ npm install
$ cd client   # è¿›å…¥ client ç›®å½•
$ npm install
$ npm run build
</code></pre>
<p>æ„å»ºæˆåŠŸè¾“å‡ºï¼š</p>
<p><img src="hyperledger/../img/fabric/explorer-client-build.png" alt="explorer-client-build æˆåŠŸ" /></p>
<p>å¯åŠ¨ï¼š</p>
<pre><code>$ cd blockchain-explorer
$ node ./main.js
....æ˜¾ç¤ºä¿¡æ¯...
write_set size &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; :  0.5014553070068359 MB
Insert sql is INSERT INTO transactions  ( &quot;blockid&quot;,&quot;txhash&quot;,&quot;createdt&quot;,&quot;chaincodename&quot;,&quot;chaincode_id&quot;,&quot;status&quot;,&quot;creator_msp_id&quot;,&quot;endorser_msp_id&quot;,&quot;type&quot;,&quot;read_set&quot;,&quot;write_set&quot;,&quot;channel_genesis_hash&quot;,&quot;validation_code&quot;,&quot;envelope_signature&quot;,&quot;payload_extension&quot;,&quot;creator_nonce&quot;,&quot;chaincode_proposal_input&quot;,&quot;endorser_signature&quot;,&quot;creator_id_bytes&quot;,&quot;payload_proposal_hash&quot;,&quot;endorser_id_bytes&quot; ) VALUES( $1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21  ) RETURNING *;
... çœç•¥ ...
</code></pre>
<p>ç›‘å¬åœ°å€åœ¨ appconfig.json ä¸­é…ç½®ï¼Œé»˜è®¤æ˜¯ 127.0.0.1:8080ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š</p>
<p><img src="hyperledger/../img/fabric/explorer.png" alt="Fabric åŒºå—é“¾æµè§ˆå™¨é¡µé¢" /></p>
<h2 id="é‡åˆ°çš„ä¸€äº›é”™è¯¯"><a class="header" href="#é‡åˆ°çš„ä¸€äº›é”™è¯¯">é‡åˆ°çš„ä¸€äº›é”™è¯¯</a></h2>
<h3 id="æ•°æ®åº“å¯†ç ä¸å¯¹"><a class="header" href="#æ•°æ®åº“å¯†ç ä¸å¯¹">æ•°æ®åº“å¯†ç ä¸å¯¹</a></h3>
<p>å¦‚æœé…ç½®æ–‡ä»¶ app/explorerconfig.json ä¸­æ•°æ®åº“è´¦å·å¯†ç ä¸å¯¹ï¼Œnode ./main.js ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<pre><code class="language-sh">postgres://hppoc:pass12345@127.0.0.1:5432/fabricexplorer
error when connecting to db: { error: password authentication failed for user &quot;hppoc&quot;
    at Connection.parseE (/Users/lijiao/hyperledger-fabric-1.4.4/blockchain-explorer/node_modules/pg/lib/connection.js:554:11)
    at Connection.parseMessage (/Users/lijiao/hyperledger-fabric-1.4.4/blockchain-explorer/node_modules/pg/lib/connection.js:379:19)
    at Socket.&lt;anonymous&gt; (/Users/lijiao/hyperledger-fabric-1.4.4/blockchain-explorer/node_modules/pg/lib/connection.js:119:22)
    at emitOne (events.js:116:13)
    at Socket.emit (events.js:211:7)
    at addChunk (_stream_readable.js:263:12)
    at readableAddChunk (_stream_readable.js:250:11)
    at Socket.Readable.push (_stream_readable.js:208:10)
    at TCP.onread (net.js:601:20)
</code></pre>
<p>exploer ä¼˜å…ˆä»ç¯å¢ƒå˜é‡ä¸­è·å–æ•°æ®åº“çš„è´¦å·å¯†ç ï¼Œå¦‚æœæ–‡ä»¶ä¸­çš„è´¦å·å¯†ç æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯ç¯å¢ƒå˜é‡ä¸­çš„ä¸æ­£ç¡®ï¼Œä¹Ÿä¼šæŠ¥é”™ï¼Œç”¨ä¸‹é¢å‘½ä»¤æ¸…ç©ºç¯å¢ƒå˜é‡ï¼š</p>
<pre><code class="language-sh">unset DATABASE_HOST
unset DATABASE_PORT
unset DATABASE_DATABASE
unset DATABASE_USERNAME
unset DATABASE_PASSWD
</code></pre>
<h3 id="fabric-çš„å¯¹æ¥æ–‡ä»¶é…ç½®é”™è¯¯"><a class="header" href="#fabric-çš„å¯¹æ¥æ–‡ä»¶é…ç½®é”™è¯¯">Fabric çš„å¯¹æ¥æ–‡ä»¶é…ç½®é”™è¯¯</a></h3>
<p>å¦‚æœ app/platform/fabric/config.json ä¸­çš„ path è·¯å¾„é…ç½®é”™äº†ï¼Œnode ./main.js  æ‰“å°ä¸‹é¢çš„å­—ç¬¦ï¼Œç„¶åè‡ªåŠ¨é€€å‡ºï¼š</p>
<pre><code class="language-sh">**************************************************************************************
Error : Failed to connect client peer, please check the configuration and peer status
Info :  Explorer will continue working with only DB data
**************************************************************************************
</code></pre>
<p>path å¿…é¡»ä½¿ç”¨å®Œæ•´çš„ç»å¯¹è·¯å¾„ï¼Œä¸èƒ½ç”¨ <code>~/xxxxx</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ cat  app/platform/fabric/config.json |grep path
            &quot;path&quot;: &quot;./tmp/credentialStore_Org1/credential&quot;,
              &quot;path&quot;: &quot;./tmp/credentialStore_Org1/crypto&quot;
          &quot;fullpath&quot;: false,
            &quot;path&quot;: &quot;/Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore&quot;
            &quot;path&quot;: &quot;/Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/signcerts&quot;
            &quot;path&quot;: &quot;/Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/crypto-config/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp/keystore&quot;
            &quot;path&quot;: &quot;/Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/crypto-config/ordererOrganizations/example.com/users/Admin@example.com/msp/keystore&quot;
            &quot;path&quot;: &quot;/Users/lijiao/hyperledger-fabric-1.4.4/fabric-samples/first-network/crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt&quot;
</code></pre>
<h2 id="å‚è€ƒ-13"><a class="header" href="#å‚è€ƒ-13">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="hyperledger-fabric-çš„åç»­å®‰æ’"><a class="header" href="#hyperledger-fabric-çš„åç»­å®‰æ’">HyperLedger Fabric çš„åç»­å®‰æ’</a></h1>
<p>æ¥ä¸‹æ¥è¦è¯¦ç»†è¯´æ˜ Fabric æ¯ä¸€ä¸ªç»„ä»¶çš„ç”¨æ³•ï¼ŒFabric ç³»ç»Ÿçš„ç”¨æ³•ï¼Œå¦‚ä½•åˆ›å»ºã€æ‰§è¡Œåˆçº¦ä¹‹ç±»çš„ï¼Œä»¥åŠ HyperLedger æ——ä¸‹å…¶å®ƒé¡¹ç›®çš„ä½¿ç”¨ï¼Œè­¬å¦‚ Cello......
å·¥ä½œé‡æœ‰ç‚¹å¤§ï¼Œè¿‘æœŸçš„ä¸»è¦ç²¾åŠ›è¦æ”¾åˆ°å·¥ä½œä¸Šæ­£åœ¨ç”¨çš„ <a href="hyperledger/../k8s/index.html">Kubernetes</a> å’Œå‡†å¤‡ç”¨çš„ <a href="hyperledger/../istio/index.html">Istio</a>ï¼ŒHyperLedger çš„åç»­è·Ÿè¿›æ¯”è¾ƒçª˜è¿«......</p>
<p>æ£€è§†äº†ä¸€ä¸‹ä¹‹å‰çš„æ•™ç¨‹å’Œç¬”è®°ï¼Œæ ¸å¿ƒé€»è¾‘è¿˜æ˜¯å¯¹ï¼Œè™½ç„¶ä½¿ç”¨çš„æ˜¯ Fabric 1.1 å’Œ Fabric 1.2ï¼Œä½†ä¸å¦¨ç¢å¯¹ Fabric ç»„ä»¶å’Œè¿ä½œæ–¹å¼çš„ç†è§£ã€‚ç¬”è®°å·²ç»å¾ˆè¯¦ç»†ï¼Œç½‘æ˜“äº‘è¯¾å ‚ä¸Šçš„è§†é¢‘å¯ç”¨å¯ä¸ç”¨ã€‚</p>
<p>æŒæ¡ä¸€ä¸ªç³»ç»Ÿï¼Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯è‡ªå·±æŠ˜è…¾ï¼Œä¸‹é¢è¿™äº›ç¬”è®°å’Œè§†é¢‘éƒ½æ˜¯è¾…åŠ©ï¼Œæˆ‘ä¼šå°½åŠ›æŠŠæœ€æ–°çš„å†…å®¹æ›´æ–°åˆ°è¿™æœ¬ã€Œå°é¸Ÿç¬”è®°ã€ä¸­ï¼ˆ2019-11-27 08:57:51)ã€‚</p>
<p><strong>è§†é¢‘æ¼”ç¤ºï¼š</strong></p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html">ã€è§†é¢‘ã€‘Fabricçš„å…¨æ‰‹åŠ¨ã€å¤šæœåŠ¡å™¨éƒ¨ç½²æ•™ç¨‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/09/hyperledger-fabric-ansible-deploy.html">ã€è§†é¢‘ã€‘ä½¿ç”¨Ansibleè¿›è¡ŒFabricå¤šèŠ‚ç‚¹åˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆå®æˆ˜ï¼‰</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/19/hyperledger-fabric-1-2-0.html">ã€è§†é¢‘ã€‘Fabricä»1.1.0å‡çº§åˆ°1.2.0</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/28/hyperledger-fabric-orderer-kafka.html">ã€è§†é¢‘ã€‘Fabricä½¿ç”¨kafkaè¿›è¡ŒåŒºå—æ’åºï¼ˆå…±è¯†ï¼‰</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/19/hyperledger-fabric-with-couchdb.html">ã€è§†é¢‘ã€‘ä¸ºFabricçš„PeerèŠ‚ç‚¹é…ç½®CouchDB</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html">ã€è§†é¢‘ã€‘Fabric-CAçš„ä½¿ç”¨æ¼”ç¤º(ä¸¤ä¸ªç»„ç»‡ä¸€ä¸ªOrdererä¸‰ä¸ªPeer)</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/17/hyperledger-fabric-chaincodes-example.html">ã€è§†é¢‘ã€‘Fabricçš„Chaincodeï¼ˆæ™ºèƒ½åˆçº¦ã€é“¾ç ï¼‰å¼€å‘ã€ä½¿ç”¨æ¼”ç¤º</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/07/28/hyperledger-fabric-sdk-go.html">ã€è§†é¢‘ã€‘Fabric Go SDKçš„ä½¿ç”¨</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/04/25/hyperledger-fabric-sdk-nodejs.html">ã€è§†é¢‘ã€‘Fabric nodejs SDKçš„ä½¿ç”¨</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/06/18/hyperledger-fabric-add-new-org.html">ã€è§†é¢‘ã€‘Fabricè¿›é˜¶ï¼Œåœ¨å·²æœ‰çš„Channelä¸­æ·»åŠ æ–°çš„ç»„ç»‡</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/17/hyperledger-fabric-source-code.html">ã€è§†é¢‘ã€‘è¶…çº§è´¦æœ¬HyperLedgerï¼šFabricæºç èµ°è¯»(é›¶)ï¼šæºä»£ç é˜…è¯»ç¯å¢ƒå‡†å¤‡</a></li>
</ul>
<p><strong>æ–‡å­—ä»‹ç»ï¼š</strong></p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/08/hyperledger-projects-intro.html">è¶…çº§è´¦æœ¬å·¥ä½œç»„æ——ä¸‹é¡¹ç›®ä»‹ç»</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/06/25/hyperledger-fabric-main-point.html">Fabricæ°å¼€æ‰ç¢ï¼Œä¸€æ–‡è§£æƒ‘</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/02/23/hyperledger-fabric-usage.html">Fabricçš„åŸºæœ¬æ¦‚å¿µä¸åŸºç¡€ç”¨æ³•</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html">FabricCAçš„åŸºæœ¬æ¦‚å¿µä¸ç”¨æ³•è®²è§£</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/07/09/hyperledger-fabric-ca-cascade.html">FabricCAçš„çº§è”ä½¿ç”¨ï¼ˆInterMediateCAï¼‰</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/05/hyperledger-fabric-chaincode.html">Fabric Chaincodeï¼ˆæ™ºèƒ½åˆçº¦ã€é“¾ç ï¼‰å¼€å‘æ–¹æ³•</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/06/19/hyperledger-channel-config-operation.html">Fabric Channelé…ç½®çš„è¯»å–è½¬æ¢</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-explorer.html">Explorerå®‰è£…ä½¿ç”¨</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/25/hyperledger-cello.html">Celloéƒ¨ç½²å’Œä½¿ç”¨</a></li>
</ul>
<p><strong>é—®é¢˜æ±‡æ€»ï¼š</strong></p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/04/25/hyperledger-fabric-problem.html">Fabricéƒ¨ç½²è¿‡ç¨‹æ—¶é‡åˆ°çš„é—®é¢˜æ±‡æ€»</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/07/20/hyperledger-fabric-chaincode-problem.html">Fabricçš„Chaincodeå¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/07/15/hyperledger-fabric-nodejs-problem.html">Fabric Node.js SDKä½¿ç”¨æ—¶é‡åˆ°çš„é—®é¢˜</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/07/15/hyperledger-fabric-golang-problem.html">Fabric Golang SDKä½¿ç”¨æ—¶é‡åˆ°çš„é—®é¢˜</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/07/25/hyperledger-fabric-1-2-0-problems.html">Fabric 1.2.0ä½¿ç”¨æ—¶é‡åˆ°çš„é—®é¢˜</a></li>
</ul>
<p>æ›´å¤šæ–‡ç« ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/tags/blockchain.html">è¶…çº§è´¦æœ¬&amp;åŒºå—é“¾å®è·µæ–‡ç« ï¼ˆæŒç»­æ›´æ–°ï¼‰</a></li>
</ul>
<h2 id="å‚è€ƒ-14"><a class="header" href="#å‚è€ƒ-14">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="istio-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#istio-ä½¿ç”¨æ‰‹å†Œ">istio ä½¿ç”¨æ‰‹å†Œ</a></h1>
<p>äº†è§£ istio çš„ä½¿ç”¨æ–¹æ³•ï¼Œå­¦ä¹ å€Ÿé‰´ istio çš„å®ç°æ€è·¯ã€‚</p>
<p>ä»è¿™é‡Œå¼€å§‹ï¼š <a href="istio/./install.html">istio éƒ¨ç½²ç¯å¢ƒå‡†å¤‡</a></p>
<h2 id="ç›¸å…³ç¬”è®°"><a class="header" href="#ç›¸å…³ç¬”è®°">ç›¸å…³ç¬”è®°</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/11/01/istio-packet-forward.html" title="æœåŠ¡ç½‘æ ¼/ServiceMesh é¡¹ç›® istio çš„æµé‡é‡å®šå‘ã€ä»£ç†è¯·æ±‚è¿‡ç¨‹åˆ†æ">æœåŠ¡ç½‘æ ¼/ServiceMesh é¡¹ç›® istio çš„æµé‡é‡å®šå‘ã€ä»£ç†è¯·æ±‚è¿‡ç¨‹åˆ†æ</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/05/21/apigateway-base-envoy-compare-istio.html">åŸºäºEnvoyçš„ApiGateway/Ingress Controlleré¡¹ç›®æ¢³ç†ï¼ˆå››ï¼‰ï¼šIstio</a></li>
</ul>
<h2 id="å‚è€ƒ-15"><a class="header" href="#å‚è€ƒ-15">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„éƒ¨ç½²"><a class="header" href="#istio-çš„éƒ¨ç½²">istio çš„éƒ¨ç½²</a></h1>
<p>åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½² istio æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œå‚è€ƒ <a href="https://istio.io/docs/setup/kubernetes/" title="Installing on Kubernetes">Installing on Kubernetes</a>ã€‚</p>
<ul>
<li>å•çº¯äº†è§£å­¦ä¹ ï¼Œéƒ¨ç½² <a href="istio/./demo-install.html">istio é¢„è§ˆç‰ˆ</a></li>
<li>ç”Ÿäº§ä½¿ç”¨ï¼Œéƒ¨ç½² istio ç”Ÿäº§ç‰ˆ</li>
</ul>
<p>æ— è®ºé‡‡ç”¨å“ªç§æ–¹å¼éƒ¨ç½²ï¼Œéƒ½éœ€è¦ä¸‹è½½ istio éƒ¨ç½²æ–‡ä»¶ï¼Œå‡†å¤‡ä¸€ä¸ª kubernetes é›†ç¾¤ã€‚éƒ¨ç½²æ–‡ä»¶åˆ° github ä¸‹è½½ï¼ŒKubernetes é›†ç¾¤å¯ä»¥ä½¿ç”¨ <a href="istio/../minikube/index.html">minikube</a> éƒ¨ç½²ä¸€ä¸ªå•æœºç‰ˆçš„ kubernetesã€‚</p>
<p>æœ¬æ‰‹å†Œä¸­éƒ¨ç½²çš„ istio ç‰ˆæœ¬æ˜¯ 1.2.5ï¼š</p>
<pre><code>Istio 1.2 has been tested with these Kubernetes releases: 1.12, 1.13, 1.14.
</code></pre>
<h2 id="å‡†å¤‡-kubernetes-é›†ç¾¤"><a class="header" href="#å‡†å¤‡-kubernetes-é›†ç¾¤">å‡†å¤‡ kubernetes é›†ç¾¤</a></h2>
<p>å•æœºç‰ˆ Kubernetes é›†ç¾¤åˆ›å»ºï¼š<a href="istio/../minikube/index.html">minkube ä½¿ç”¨æ‰‹å†Œ</a>ã€‚</p>
<p>å¤šæœºç‰ˆ Kubernetes é›†ç¾¤å‚è€ƒï¼ˆä¸‹é¢ä¸‰ä»½æ–‡æ¡£æ¯”è¾ƒè€ï¼Œä»¥åä¼šæ›´æ–°ï¼‰ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/10/04/k8s-class-a-deploy-kubeadm.html" title="ã€ŠKubernetes1.12ä»é›¶å¼€å§‹ï¼ˆä¸‰ï¼‰ï¼šç”¨kubeadméƒ¨ç½²å¤šèŠ‚ç‚¹é›†ç¾¤ã€‹">ã€ŠKubernetes1.12ä»é›¶å¼€å§‹ï¼ˆä¸‰ï¼‰ï¼šç”¨kubeadméƒ¨ç½²å¤šèŠ‚ç‚¹é›†ç¾¤ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/10/07/k8s-class-deploy-from-scratch.html" title="ã€ŠKubernetes1.12ä»é›¶å¼€å§‹ï¼ˆäº”ï¼‰ï¼šè‡ªå·±åŠ¨æ‰‹éƒ¨ç½²kubernetesã€‹">ã€ŠKubernetes1.12ä»é›¶å¼€å§‹ï¼ˆäº”ï¼‰ï¼šè‡ªå·±åŠ¨æ‰‹éƒ¨ç½²kubernetesã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/11/04/k8s-class-build-and-deploy-by-ansible.html" title="ã€ŠKubernetes1.12ä»é›¶å¼€å§‹ï¼ˆå…­ï¼‰ï¼šä»ä»£ç ç¼–è¯‘åˆ°è‡ªåŠ¨éƒ¨ç½²ã€‹">ã€ŠKubernetes1.12ä»é›¶å¼€å§‹ï¼ˆå…­ï¼‰ï¼šä»ä»£ç ç¼–è¯‘åˆ°è‡ªåŠ¨éƒ¨ç½²ã€‹</a></li>
</ul>
<h2 id="ä¸‹è½½-istio-éƒ¨ç½²æ–‡ä»¶"><a class="header" href="#ä¸‹è½½-istio-éƒ¨ç½²æ–‡ä»¶">ä¸‹è½½ istio éƒ¨ç½²æ–‡ä»¶</a></h2>
<p>ä» github çš„ <a href="https://github.com/istio/istio/releases" title="istio/releases">release</a> é¡µé¢ä¸‹è½½ istioï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">wget https://github.com/istio/istio/releases/download/1.2.5/istio-1.2.5-linux.tar.gz
</code></pre>
<p>æœ¬æ‰‹å†Œçš„æ“ä½œç¯å¢ƒæ˜¯ mac + minikubeï¼Œä¸‹è½½çš„æ˜¯ istio-1.2.5-osx.tar.gzï¼š</p>
<pre><code class="language-sh">wget https://github.com/istio/istio/releases/download/1.2.5/istio-1.2.5-osx.tar.gz
</code></pre>
<p>è§£å‹åå¾—åˆ° istio-1.2.5ï¼Œé‡Œé¢æœ‰å®‰è£…æ–‡ä»¶å’Œæ“ä½œå‘½ä»¤ï¼ˆbin/istioctlï¼‰ï¼š</p>
<pre><code class="language-sh">$ tree -L 1 istio-1.2.5
istio-1.2.5
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ bin
â”œâ”€â”€ install
â”œâ”€â”€ istio.VERSION
â”œâ”€â”€ samples
â””â”€â”€ tools
</code></pre>
<p>æˆ–è€…ç›´æ¥ clone æ•´ä¸ª istio é¡¹ç›®ï¼Œç„¶ååˆ‡æ¢åˆ°è¦ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œè¿™ç§æ–¹å¼éœ€è¦è‡ªå·±ç¼–è¯‘ istioï¼Œç¼–å†™éƒ¨ç½²æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/istio/istio.git
git checkout 1.2.5 -b 1.2.5
</code></pre>
<p>æºç ç›®å½• <a href="https://github.com/istio/istio/tree/1.2.5/install/kubernetes" title="1.2.5/install/kubernetes ">install/kubernetes</a> ä¸­æä¾›äº†ä¸€äº›éƒ¨ç½²æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">âœ  istio git:(1.2.5) âœ— tree install/kubernetes -L 3
install/kubernetes
â”œâ”€â”€ README.md
â”œâ”€â”€ ansible
â”‚Â Â  â”œâ”€â”€ OWNERS
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ ansible.cfg
â”‚Â Â  â”œâ”€â”€ istio
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ defaults
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ meta
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ tasks
â”‚Â Â  â”‚Â Â  â””â”€â”€ vars
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ global-default-sidecar-scope.yaml
â”œâ”€â”€ helm
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ helm-service-account.yaml
â”‚Â Â  â”œâ”€â”€ istio
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Chart.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LICENSE
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ charts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ example-values
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ files
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ requirements.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ templates
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ test-values
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ values-istio-demo-auth.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ values-istio-demo-common.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ values-istio-demo.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ values-istio-minimal.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ values-istio-remote.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ values-istio-sds-auth.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ values.yaml
â”‚Â Â  â””â”€â”€ istio-init
â”‚Â Â      â”œâ”€â”€ Chart.yaml
â”‚Â Â      â”œâ”€â”€ LICENSE
â”‚Â Â      â”œâ”€â”€ README.md
â”‚Â Â      â”œâ”€â”€ files
â”‚Â Â      â”œâ”€â”€ templates
â”‚Â Â      â””â”€â”€ values.yaml
â”œâ”€â”€ mesh-expansion.yaml
â””â”€â”€ namespace.yaml
</code></pre>
<p>éƒ¨ç½²æ“ä½œè§åé¢çš„ç« èŠ‚ã€‚</p>
<h2 id="å‚è€ƒ-16"><a class="header" href="#å‚è€ƒ-16">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-é¢„è§ˆç‰ˆéƒ¨ç½²"><a class="header" href="#istio-é¢„è§ˆç‰ˆéƒ¨ç½²">istio é¢„è§ˆç‰ˆéƒ¨ç½²</a></h1>
<p>åœ¨ kubernetes é›†ç¾¤ä¸­éƒ¨ç½² istio æœ€æ–¹ä¾¿ï¼Œistio åœ¨å¿«é€Ÿè¿­ä»£æ›´æ–°é˜¶æ®µï¼Œéƒ¨ç½²æ–¹æ³•ä¹Ÿåœ¨å˜ï¼Œè€ç‰ˆæœ¬ä½¿ç”¨çš„å®‰è£…æ–¹æ³•ï¼Œå¯¹æ–°ç‰ˆæœ¬å¯èƒ½ä¸é€‚ç”¨ï¼Œå»ºè®®ç»å¸¸æŸ¥çœ‹ istio çš„ <a href="https://istio.io/docs/setup/install/" title="istio Installation Guides">Installation Guides</a>ã€‚ </p>
<p>è¿™ç¯‡æ–‡æ¡£æœ€æ—©ä½¿ç”¨ yaml æ–‡ä»¶éƒ¨ç½²çš„ istio 1.2.5ï¼Œåæ¥ç”¨ <a href="https://istio.io/docs/setup/install/helm/" title="Customizable Install with Helm">helm çš„æ–¹å¼</a> é‡æ–°éƒ¨ç½²äº† istio 1.4.0ï¼Œæ²¡æœ‰é‡‡ç”¨ <a href="https://istio.io/docs/setup/install/istioctl/" title="Customizable Install with Istioctl">istioctlçš„æ–¹å¼</a>ï¼Œæ˜¯å› ä¸º 1.4.0 çš„ <a href="https://istio.io/docs/setup/upgrade/istioctl-upgrade/" title="istioctl-upgrade">istioctl upgrade</a> è¿˜åœ¨è¯•éªŒç‰¹æ€§ï¼Œä¸æƒ³è¸©åç»­ç‰ˆæœ¬å‡çº§çš„å‘ã€‚</p>
<blockquote>
<p>ä»¥åçš„ä¸»æµéƒ¨ç½²æ–¹å¼è‚¯å®šæ˜¯ istioctl æ–¹å¼ã€‚</p>
</blockquote>
<h2 id="ç‰ˆæœ¬å‡çº§"><a class="header" href="#ç‰ˆæœ¬å‡çº§">ç‰ˆæœ¬å‡çº§</a></h2>
<p>istio æä¾›äº† <a href="https://istio.io/docs/setup/upgrade/" title="istio Upgrade">å‡ ç§</a> å‡çº§æ–¹æ³•ï¼š</p>
<ul>
<li><a href="https://istio.io/docs/setup/upgrade/cni-helm-upgrade/" title="kubernetes rolling update">é€šè¿‡ kubernetes rolling update å‡çº§</a> </li>
<li><a href="https://istio.io/docs/setup/upgrade/istioctl-upgrade/" title="istioctl-upgrade">é€šè¿‡ istioctl upgrade</a> ï¼ˆè¯•éªŒé˜¶æ®µï¼Œ1.3.3 å¼€å§‹æ”¯æŒï¼‰</li>
</ul>
<p><a href="https://istio.io/docs/setup/upgrade/cni-helm-upgrade/" title="kubernetes rolling update">kubernetes rolling update</a> ç°åœ¨åªæ”¯æŒ helm çš„æ–¹å¼ï¼Œè¯¦ç»†æ“ä½œè¿‡ç¨‹è§ <a href="https://istio.io/docs/setup/upgrade/cni-helm-upgrade/" title="kubernetes rolling update">upgrade using Helm</a>ã€‚</p>
<h2 id="istio-140-éƒ¨ç½²helm-æ–¹å¼"><a class="header" href="#istio-140-éƒ¨ç½²helm-æ–¹å¼">istio 1.4.0 éƒ¨ç½²â€”â€”Helm æ–¹å¼</a></h2>
<p>å‚è€ƒæ–‡æ¡£ <a href="https://istio.io/docs/setup/install/helm/" title="Customizable Install with Helm">Customizable Install with Helm</a>ï¼Œæ·»åŠ  helm reppï¼š</p>
<pre><code class="language-sh">helm repo add istio.io https://storage.googleapis.com/istio-release/releases/1.4.0/charts/
</code></pre>
<p>ä» <a href="https://github.com/istio/istio/releases">istio/releases</a> é¡µé¢ä¸‹è½½ 1.4.0 çš„éƒ¨ç½²æ–‡ä»¶</p>
<pre><code class="language-sh">wget https://github.com/istio/istio/releases/download/1.4.0/istio-1.4.0-linux.tar.gz
tar -xvf istio-1.4.0-linux
cd istio-1.4.0
</code></pre>
<p>å®‰è£…å‰å‡†å¤‡ï¼Œè¿™é‡Œç”¨ nodeport çš„æ–¹å¼æš´éœ² istio æœåŠ¡ï¼ˆæ·»åŠ äº†å‘½ä»¤è¡Œå‚æ•° --set gateways.istio-ingressgateway.type=NodePortï¼‰é»˜è®¤æƒ…å†µæ˜¯ LoadBalancer æ–¹å¼ï¼š</p>
<pre><code class="language-sh">$ kubectl create namespace istio-system
$ helm template install/kubernetes/helm/istio-init \
  --name istio-init \
  --namespace istio-system \
  --set gateways.istio-ingressgateway.type=NodePort \
  | kubectl apply -f -
$ kubectl -n istio-system wait --for=condition=complete job --all
</code></pre>
<p>ä¸Šé¢çš„å‘½ä»¤æ˜¾ç¤ºä¸‹é¢çš„ç»“æœåï¼Œå†ç»§ç»­å¾€ä¸‹æ“ä½œï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system wait --for=condition=complete job --all
job.batch/istio-init-crd-10-1.4.0 condition met
job.batch/istio-init-crd-11-1.4.0 condition met
job.batch/istio-init-crd-14-1.4.0 condition met
</code></pre>
<p>æœ€åå®‰è£… istioï¼Œ<a href="https://istio.io/docs/setup/install/helm/" title="Customizable Install with Helm">Customizable Install with Helm</a> ç»™å‡ºäº†å¤šä¸ªé…ç½®ç‰ˆæœ¬ï¼Œå› ä¸ºç¯å¢ƒèµ„æºæœ‰é™ï¼Œè¿™é‡Œé€‰ç”¨ demo ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sh">$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system \
    --values install/kubernetes/helm/istio/values-istio-demo.yaml | kubectl apply -f -
</code></pre>
<p>Pod å¯åŠ¨å®Œæˆåï¼Œéƒ¨ç½²ç»“æŸï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system get pod
NAME                                      READY   STATUS      RESTARTS   AGE
grafana-584949b9c6-w8w8t                  1/1     Running     0          21m
istio-citadel-8575bd45c6-69lts            1/1     Running     0          20m
istio-egressgateway-79d56c9f58-sd8xb      1/1     Running     0          17m
istio-galley-7f8b95bff6-9q8pk             1/1     Running     0          21m
istio-grafana-post-install-1.4.0-m7lnb    0/1     Completed   0          21m
istio-ingressgateway-75d6d5fd99-m2jnf     1/1     Running     0          21m
istio-init-crd-10-1.4.0-7fh25             0/1     Completed   0          26m
istio-init-crd-11-1.4.0-jbcpd             0/1     Completed   0          26m
istio-init-crd-14-1.4.0-v7rkw             0/1     Completed   0          26m
istio-pilot-785bc88559-jjzvl              2/2     Running     3          20m
istio-policy-6ddfd68f86-shj5l             2/2     Running     6          20m
istio-security-post-install-1.4.0-96bs5   0/1     Completed   0          21m
istio-sidecar-injector-6c9d6cd87c-x586r   1/1     Running     0          20m
istio-telemetry-598988779b-4zst5          2/2     Running     7          20m
istio-tracing-795c9c64c4-8wdns            1/1     Running     0          20m
kiali-7d4cf866cc-qmkc6                    1/1     Running     0          21m
prometheus-8685f659f-xmvlp                1/1     Running     0          20m
</code></pre>
<p>å¦‚æœ kubernetes ç”¨çš„ minikubeï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ istio çš„æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ ./minkube service -n istio-system list
|--------------|------------------------|--------------------------------|
|  NAMESPACE   |          NAME          |              URL               |
|--------------|------------------------|--------------------------------|
| istio-system | grafana                | No node port                   |
| istio-system | istio-citadel          | No node port                   |
| istio-system | istio-egressgateway    | No node port                   |
| istio-system | istio-galley           | No node port                   |
| istio-system | istio-ingressgateway   | http://192.168.99.100:30506    |
|              |                        | http://192.168.99.100:31380    |
|              |                        | http://192.168.99.100:31390    |
|              |                        | http://192.168.99.100:31400    |
|              |                        | http://192.168.99.100:31976    |
|              |                        | http://192.168.99.100:31433    |
|              |                        | http://192.168.99.100:32546    |
|              |                        | http://192.168.99.100:32230    |
|              |                        | http://192.168.99.100:30693    |
| istio-system | istio-pilot            | No node port                   |
| istio-system | istio-policy           | No node port                   |
| istio-system | istio-sidecar-injector | No node port                   |
| istio-system | istio-telemetry        | No node port                   |
| istio-system | jaeger-agent           | No node port                   |
| istio-system | jaeger-collector       | No node port                   |
| istio-system | jaeger-query           | No node port                   |
| istio-system | kiali                  | No node port                   |
| istio-system | prometheus             | No node port                   |
| istio-system | tracing                | No node port                   |
| istio-system | zipkin                 | No node port                   |
|--------------|------------------------|--------------------------------|
</code></pre>
<p>å¦‚æœä¹‹å‰éƒ¨ç½²æœ‰ä½¿ç”¨ istio çš„å®¹å™¨ï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤é‡å¯ï¼š</p>
<pre><code class="language-sh">$ kubectl rollout restart deployment --namespace default
</code></pre>
<h2 id="istio-125-éƒ¨ç½²"><a class="header" href="#istio-125-éƒ¨ç½²">istio 1.2.5 éƒ¨ç½²</a></h2>
<p>è¿™é‡Œä»‹ç» istio demo çš„éƒ¨ç½²æ–¹æ³•ï¼Œç”¨è¿™ç§æ–¹å¼éƒ¨ç½²çš„ istio ä¸èƒ½ç”¨äºç”Ÿäº§ï¼Œåªç”¨æ¥äº†è§£ istio çš„ç”¨æ³•å’Œç‰¹æ€§ï¼Œå‚è€ƒ <a href="https://istio.io/docs/setup/kubernetes/install/kubernetes/" title="Quick Start Evaluation Install">Quick Start Evaluation Install</a>ã€‚</p>
<p>è¿™é‡Œä¼šä½¿ç”¨å‰é¢ä¸‹è½½ istio çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆè§ <a href="istio/./install.html#%E4%B8%8B%E8%BD%BD-istio">ä¸‹è½½ istio</a>ï¼‰ã€‚</p>
<h3 id="åˆ›å»º-istio-çš„-crd"><a class="header" href="#åˆ›å»º-istio-çš„-crd">åˆ›å»º istio çš„ crd</a></h3>
<p>Istio ä½¿ç”¨äº†å¤§é‡çš„ CRDï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨ kubernetes é›†ç¾¤ä¸­åˆ›å»ºè¿™äº› CRDï¼š</p>
<pre><code class="language-sh">$ for i in install/kubernetes/helm/istio-init/files/crd*yaml; do kubectl apply -f $i; done
customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/gateways.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/clusterrbacconfigs.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/policies.authentication.istio.io created
customresourcedefinition.apiextensions.k8s.io/meshpolicies.authentication.istio.io created
customresourcedefinition.apiextensions.k8s.io/httpapispecbindings.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/httpapispecs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/quotaspecbindings.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/quotaspecs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/rules.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/attributemanifests.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/rbacconfigs.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/serviceroles.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/servicerolebindings.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/adapters.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/instances.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/templates.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/handlers.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/sidecars.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/authorizationpolicies.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/clusterissuers.certmanager.k8s.io created
customresourcedefinition.apiextensions.k8s.io/issuers.certmanager.k8s.io created
customresourcedefinition.apiextensions.k8s.io/certificates.certmanager.k8s.io created
customresourcedefinition.apiextensions.k8s.io/orders.certmanager.k8s.io created
customresourcedefinition.apiextensions.k8s.io/challenges.certmanager.k8s.io created
</code></pre>
<h3 id="éƒ¨ç½²-istio"><a class="header" href="#éƒ¨ç½²-istio">éƒ¨ç½² istio</a></h3>
<p>è¿™é‡Œç”¨åˆ°çš„ istio-demo.yaml/istio-demo-auth.yamlï¼Œistio é¡¹ç›®ä»£ç æ˜¯æ²¡æœ‰çš„ï¼Œå®ƒä»¬åœ¨ istio çš„ release æ–‡ä»¶ä¸­ï¼Œåˆ° <a href="https://github.com/istio/istio/releases" title="istio/releases">istio/releases</a> é¡µé¢ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ release æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ wget https://github.com/istio/istio/releases/download/1.2.5/istio-1.2.5-linux.tar.gz
$ tar -xvf istio-1.2.5-linux.tar.gz
$ ls istio-1.2.5/install/kubernetes/istio-demo*
istio-1.2.5/install/kubernetes/istio-demo-auth.yaml
istio-1.2.5/install/kubernetes/istio-demo.yaml
</code></pre>
<p>istio-demo.yaml å’Œ istio-demo-auth.yaml æ˜¯ä¸¤ç§éƒ¨ç½²é…ç½®ï¼Œåè€…å¼ºåˆ¶åŠ å¯† client ä¸ server ä¹‹é—´çš„é€šä¿¡ã€‚æ–‡ä»¶å†…å®¹æ˜¯ istio çš„ deploymentã€configã€crd ç­‰ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶å·¨å¤§æ— æ¯”ï¼Œæ¥è¿‘ä¸¤ä¸‡è¡Œï¼</p>
<p>ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºï¼Œå¯ä»¥çœ‹åˆ°åœ¨ kubernetes ä¸­åˆ›å»ºäº†å¤§é‡çš„èµ„æºï¼š</p>
<pre><code class="language-sh">$ kubectl create -f istio-1.2.5/install/kubernetes/istio-demo.yaml
namespace/istio-system created
secret/kiali created
configmap/istio-galley-configuration created
configmap/istio-grafana-custom-resources created
configmap/istio-grafana-configuration-dashboards-galley-dashboard created
configmap/istio-grafana-configuration-dashboards-istio-mesh-dashboard created
configmap/istio-grafana-configuration-dashboards-istio-performance-dashboard created
configmap/istio-grafana-configuration-dashboards-istio-service-dashboard created
configmap/istio-grafana-configuration-dashboards-istio-workload-dashboard created
....çœç•¥...
</code></pre>
<h3 id="éƒ¨ç½²å®Œæˆ"><a class="header" href="#éƒ¨ç½²å®Œæˆ">éƒ¨ç½²å®Œæˆ</a></h3>
<p>å½“ istio-system ä¸­çš„æ‰€æœ‰ pod éƒ½æ˜¯ Running çŠ¶æ€æ—¶ï¼Œéƒ¨ç½²å®Œæˆï¼š</p>
<pre><code class="language-sh">$ kubectl get pods -n istio-system
NAME                                      READY   STATUS      RESTARTS   AGE
grafana-6575997f54-d8ltw                  1/1     Running     1          32m
istio-citadel-555dbdfd6b-kfd86            1/1     Running     1          32m
istio-cleanup-secrets-1.2.5-kv7jf         0/1     Completed   0          32m
istio-egressgateway-79f5b5b958-vr5hf      0/1     Running     1          32m
istio-galley-6855ffd77f-glwtd             1/1     Running     0          47s
istio-grafana-post-install-1.2.5-894k2    0/1     Completed   0          32m
istio-ingressgateway-585b9b66b8-9mwzs     0/1     Running     1          32m
istio-pilot-6d4dcbd54b-8p2fs              1/2     Running     2          32m
istio-policy-56588bf46d-8ft9v             2/2     Running     7          6m58s
istio-security-post-install-1.2.5-wzbkd   0/1     Completed   0          32m
istio-sidecar-injector-74f597fb84-p5n5p   1/1     Running     3          6m58s
istio-telemetry-76c5645cd9-k2r7n          2/2     Running     6          6m58s
istio-tracing-555cf644d-kcwll             1/1     Running     2          32m
kiali-6cd6f9dfb5-rvqg2                    1/1     Running     1          32m
prometheus-7d7b9f7844-hngc6               1/1     Running     4          32m
</code></pre>
<p>å¦‚æœä½¿ç”¨çš„ <a href="istio/../minikube/index.html">minikube</a> åˆ›å»ºçš„ kubernetes ï¼Œå¯ä»¥ç”¨ minikube æŸ¥çœ‹ istio æœåŠ¡åœ°å€ï¼š</p>
<pre><code class="language-sh">$ minkube service list
|---------------|------------------------|--------------------------------|
|   NAMESPACE   |          NAME          |              URL               |
|---------------|------------------------|--------------------------------|
| istio-system  | grafana                | No node port                   |
| istio-system  | istio-citadel          | No node port                   |
| istio-system  | istio-egressgateway    | No node port                   |
| istio-system  | istio-galley           | No node port                   |
| istio-system  | istio-ingressgateway   | http://192.168.99.100:31270    |
|               |                        | http://192.168.99.100:31380    |
|               |                        | http://192.168.99.100:31390    |
|               |                        | http://192.168.99.100:31400    |
|               |                        | http://192.168.99.100:31248    |
|               |                        | http://192.168.99.100:30079    |
|               |                        | http://192.168.99.100:30269    |
|               |                        | http://192.168.99.100:30249    |
|               |                        | http://192.168.99.100:31829    |
| istio-system  | istio-pilot            | No node port                   |
| istio-system  | istio-policy           | No node port                   |
| istio-system  | istio-sidecar-injector | No node port                   |
| istio-system  | istio-telemetry        | No node port                   |
| istio-system  | jaeger-agent           | No node port                   |
| istio-system  | jaeger-collector       | No node port                   |
| istio-system  | jaeger-query           | No node port                   |
| istio-system  | kiali                  | No node port                   |
| istio-system  | prometheus             | No node port                   |
| istio-system  | tracing                | No node port                   |
| istio-system  | zipkin                 | No node port                   |
| kube-system   | kube-dns               | No node port                   |
|---------------|------------------------|--------------------------------|
</code></pre>
<h3 id="å¸è½½"><a class="header" href="#å¸è½½">å¸è½½</a></h3>
<p>åå‘æ“ä½œå³å¯ï¼š</p>
<pre><code class="language-sh">$ kubectl delete -f install/kubernetes/istio-demo.yaml
$ for i in install/kubernetes/helm/istio-init/files/crd*yaml; do kubectl delete -f $i; done
</code></pre>
<h2 id="å‚è€ƒ-17"><a class="header" href="#å‚è€ƒ-17">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-æ“ä½œå‘½ä»¤"><a class="header" href="#istio-æ“ä½œå‘½ä»¤">istio æ“ä½œå‘½ä»¤</a></h1>
<p><a href="https://istio.io/docs/reference/commands/istioctl/" title="istioctl">istioctl</a>  æ˜¯ istio çš„ç®¡ç†å‘½ä»¤ï¼Œç”¨æ¥éƒ¨ç½²ã€ç®¡ç†ã€è°ƒè¯•ã€è¯Šæ–­ã€‚istioctl ç®¡ç†çš„æ˜¯éƒ¨ç½²åœ¨ kubernetes ä¸­çš„ istioï¼Œå®ƒé€šè¿‡è¯»å–æœ¬åœ°çš„ kubeconfig contextï¼Œè·å–çš„ kubernetes çš„åœ°å€ä»¥åŠæ“ä½œæƒé™ã€‚</p>
<p>istioctl å‘½ä»¤ä½äº istio-1.4.0/bin ä¸­ï¼Œæœ‰å¤šä¸ªå­å‘½ä»¤ï¼š</p>
<pre><code class="language-sh">--context &lt;string&gt;                 The name of the kubeconfig context to use (default ``)
--istioNamespace &lt;string&gt;    -i    Istio system namespace (default `istio-system`)
...
</code></pre>
<h2 id="istio-æä¾›çš„-web-é¡µé¢"><a class="header" href="#istio-æä¾›çš„-web-é¡µé¢">istio æä¾›çš„ Web é¡µé¢</a></h2>
<p>istio å†…ç½®äº†ä¸€äº› web é¡µé¢ï¼Œå¯ä»¥ç”¨ <code>istioctl dashboard</code> å‘½ä»¤æ‰“å¼€ã€‚ </p>
<pre><code class="language-sh">$ ./istioctl help dashboard
Access to Istio web UIs

Usage:
  istioctl dashboard [flags]
  istioctl dashboard [command]

Aliases:
  dashboard, dash, d

Available Commands:
  kiali       Open Kiali web UI
  controlz    Open ControlZ web UI
  envoy       Open Envoy admin web UI
  jaeger      Open Jaeger web UI
  prometheus  Open Prometheus web UI
  grafana     Open Grafana web UI
  zipkin      Open Zipkin web UI
</code></pre>
<h3 id="kialiå¯è§†åŒ–é¡µé¢"><a class="header" href="#kialiå¯è§†åŒ–é¡µé¢">kialiï¼Œå¯è§†åŒ–é¡µé¢</a></h3>
<p>kiali æ˜¯ istio å†…ç½®çš„å¯è§†åŒ–é¡µé¢ï¼š</p>
<pre><code class="language-sh">$ ./istioctl d kiali
http://localhost:50005/kiali
</code></pre>
<p><img src="istio/../img/istio/kiali.png" alt="istio kiali çš„é¡µé¢" /></p>
<h3 id="controlzé…ç½®æ–‡ä»¶"><a class="header" href="#controlzé…ç½®æ–‡ä»¶">controlzï¼Œé…ç½®æ–‡ä»¶</a></h3>
<p>æ‰“å¼€é…ç½®é¡µé¢ï¼Œistio çš„é…ç½®ç”¨ pilot ç»„ä»¶ç®¡ç†çš„ï¼Œæ‰“å¼€é…ç½®é¡µé¢æ—¶ï¼Œéœ€è¦æŒ‡å®š pilot å®¹å™¨ï¼š</p>
<pre><code class="language-sh">$ ./istioctl dashboard  controlz istio-pilot-785bc88559-jjzvl -n istio-system
</code></pre>
<p><img src="istio/../img/istio/configz.png" alt="istio configz çš„é¡µé¢" /></p>
<h3 id="envoyæ‰“å¼€æŒ‡å®š-envoy-çš„ç®¡ç†é¡µé¢"><a class="header" href="#envoyæ‰“å¼€æŒ‡å®š-envoy-çš„ç®¡ç†é¡µé¢">envoyï¼Œæ‰“å¼€æŒ‡å®š envoy çš„ç®¡ç†é¡µé¢</a></h3>
<p>istio ä¸ºç½‘æ ¼å†…çš„æ¯ä¸ªå®¹å™¨æ³¨å…¥äº†ä¸€ä¸ª envoy å®¹å™¨ï¼ŒåŒæ—¶æä¾›æ‰“å¼€æ¯ä¸ª envoy çš„ admin é¡µé¢æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">$ ./istioctl d envoy  ratings-v1-779cf974b6-fxmk8
http://localhost:51927
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ envoy çš„ admin é¡µé¢æŸ¥çœ‹ envoy ä¸­è§„åˆ™ï¼Œenvoy ç”¨æ³•å‚è€ƒ <a href="istio/../envoy/index.html">envoy ä½¿ç”¨æ‰‹å†Œ</a>ã€‚</p>
<p><img src="istio/../img/istio/envoy.png" alt="istio envoy çš„é¡µé¢" /></p>
<h3 id="jaejerè°ƒç”¨é“¾"><a class="header" href="#jaejerè°ƒç”¨é“¾">jaejerï¼Œè°ƒç”¨é“¾</a></h3>
<p>istio æ”¯æŒ jaejer å’Œ zipkinã€‚</p>
<pre><code class="language-sh">$ ./istioctl d jaeger
http://localhost:50887
</code></pre>
<p><img src="istio/../img/istio/jaeger.png" alt="istio jaeger çš„é¡µé¢" /></p>
<h3 id="prometheusç›‘æ§æ•°æ®"><a class="header" href="#prometheusç›‘æ§æ•°æ®">prometheusï¼Œç›‘æ§æ•°æ®</a></h3>
<p>æ‰“å¼€ prometheus é¡µé¢ï¼š</p>
<pre><code class="language-sh">$ ./istioctl d prometheus
http://localhost:49226
</code></pre>
<p><img src="istio/../img/istio/prometheus.png" alt="istio prometheus çš„é¡µé¢" /></p>
<h3 id="grafanaç›‘æ§æ•°æ®"><a class="header" href="#grafanaç›‘æ§æ•°æ®">grafanaï¼Œç›‘æ§æ•°æ®</a></h3>
<p>æ‰“å¼€ grafana é¡µé¢ï¼š</p>
<pre><code class="language-sh">$ ./istioctl d grafana
http://localhost:49645
</code></pre>
<p><img src="istio/../img/istio/grafana.png" alt="istio grafana çš„é¡µé¢" /></p>
<h2 id="å‚è€ƒ-18"><a class="header" href="#å‚è€ƒ-18">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„é…ç½®å‚æ•°"><a class="header" href="#istio-çš„é…ç½®å‚æ•°">istio çš„é…ç½®å‚æ•°</a></h1>
<p>istio çš„é…ç½®å‚æ•°éå¸¸éå¸¸å¤šï¼</p>
<h2 id="éƒ¨ç½²æ—¶è°ƒæ•´å‚æ•°çš„æ–¹æ³•"><a class="header" href="#éƒ¨ç½²æ—¶è°ƒæ•´å‚æ•°çš„æ–¹æ³•">éƒ¨ç½²æ—¶è°ƒæ•´å‚æ•°çš„æ–¹æ³•</a></h2>
<p>ç”¨ <a href="istio/./demo-install.html">helm</a> éƒ¨ç½²æ—¶ï¼Œé€šè¿‡ --set è®¾ç½®ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ kubectl create namespace istio-system
$ helm template install/kubernetes/helm/istio-init \
  --name istio-init \
  --namespace istio-system \
  --set gateways.istio-ingressgateway.type=NodePort \
  | kubectl apply -f -
</code></pre>
<p>istioctl æŸ¥çœ‹è¦ä½¿ç”¨çš„éƒ¨ç½²æ–‡ä»¶å’Œé…ç½®å‚æ•°ï¼š</p>
<pre><code class="language-sh">$ ./istioctl manifest generate
$ ./istioctl profile dump demo    # æŸ¥çœ‹ demo æ¨¡å¼çš„é…ç½®
</code></pre>
<p>istioctl éƒ¨ç½²æ—¶ä¿®æ”¹å‚æ•°çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">$ istioctl manifest apply --set values.global.mtls.enabled=true \
             --set values.global.controlPlaneSecurityEnabled=true
</code></pre>
<p>istioctl æ”¯æŒå¤šç§ profileï¼Œåœ¨éƒ¨ç½²æ—¶ç”¨ profile æŒ‡å®šï¼š</p>
<pre><code class="language-sh"># istioctl æ”¯æŒçš„ profile
$ ./istioctl profile list
Istio configuration profiles:
    default
    demo
    minimal
    remote
    sds

# istioctl éƒ¨ç½²æ—¶æŒ‡å®š demo æ¨¡å¼
$ ./istioctl manifest apply --set profile=demo
</code></pre>
<p>istioctl çš„æ›´å¤šç”¨æ³•è§ <a href="https://istio.io/docs/setup/install/istioctl/" title="istioctl usage">istioctl usage</a>ã€‚</p>
<h2 id="è¿è¡Œä¸­è°ƒæ•´å‚æ•°çš„æ–¹æ³•"><a class="header" href="#è¿è¡Œä¸­è°ƒæ•´å‚æ•°çš„æ–¹æ³•">è¿è¡Œä¸­è°ƒæ•´å‚æ•°çš„æ–¹æ³•</a></h2>
<p>è¦åœ¨è¿è¡Œä¸­è°ƒæ•´è¿è¡Œå‚æ•°ï¼Œå…ˆè¦çŸ¥é“ istio çš„é…ç½®å‚æ•°å­˜æ”¾åœ¨å“ªé‡Œã€‚istio çš„æ–‡æ¡£ä¸­æ²¡æœ‰æ˜ç¡®è¯´æ˜ï¼Œé€šè¿‡ä¸Šä¸‹æ–‡ä»¥åŠç›¸å…³æ“ä½œå‘½ä»¤åˆ¤æ–­ï¼Œistio çš„é…ç½®å‚æ•°éƒ½åœ¨ configmap ä¸­ï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system get configmap
NAME                                                                 DATA   AGE
istio                                                                2      3d23h
istio-crd-10                                                         1      3d23h
istio-crd-11                                                         1      3d23h
istio-crd-14                                                         1      3d23h
istio-galley-configuration                                           1      3d23h
istio-grafana                                                        2      3d23h
istio-grafana-configuration-dashboards-citadel-dashboard             1      3d23h
istio-grafana-configuration-dashboards-galley-dashboard              1      3d23h
istio-grafana-configuration-dashboards-istio-mesh-dashboard          1      3d23h
istio-grafana-configuration-dashboards-istio-performance-dashboard   1      3d23h
istio-grafana-configuration-dashboards-istio-service-dashboard       1      3d23h
istio-grafana-configuration-dashboards-istio-workload-dashboard      1      3d23h
istio-grafana-configuration-dashboards-mixer-dashboard               1      3d23h
istio-grafana-configuration-dashboards-pilot-dashboard               1      3d23h
istio-grafana-custom-resources                                       2      3d23h
istio-security                                                       1      3d23h
istio-security-custom-resources                                      2      3d23h
istio-sidecar-injector                                               2      3d23h
kiali                                                                1      3d23h
prometheus                                                           1      3d23h
</code></pre>
<p>istioctl å‘½ä»¤å¯ä»¥æ“ä½œ configmapï¼Œä¾‹å¦‚ <a href="https://istio.io/docs/tasks/policy-enforcement/enabling-policy/" title="istio enabling-policy">istio enabling-policy</a> ä¸­çš„æ“ä½œï¼š</p>
<pre><code class="language-sh"># æŸ¥çœ‹å½“å‰é…ç½®é¡¹
$ kubectl -n istio-system get cm istio -o jsonpath=&quot;{@.data.mesh}&quot; | grep disablePolicyChecks
disablePolicyChecks: true

# ä¿®æ”¹é…ç½®é¡¹
$ istioctl manifest apply --set values.global.disablePolicyChecks=false
configmap &quot;istio&quot; replaced

# æŸ¥çœ‹ä¿®æ”¹åçš„é…ç½®é¡¹
$ kubectl -n istio-system get cm istio -o jsonpath=&quot;{@.data.mesh}&quot; | grep disablePolicyChecks
disablePolicyChecks: false
</code></pre>
<h2 id="é…ç½®å‚æ•°çš„å«ä¹‰"><a class="header" href="#é…ç½®å‚æ•°çš„å«ä¹‰">é…ç½®å‚æ•°çš„å«ä¹‰</a></h2>
<p>è¿™ä¸ªè®©äººå¤´å¤§ï¼Œistio çš„ç»„ä»¶å¤šã€é…ç½®å‚æ•°å¤šï¼</p>
<p>è¿˜å¥½ configmap ä¸­æœ‰æ³¨é‡Šï¼Œé™¤äº†é€ä¸ªç ”ç©¶ï¼Œæ²¡æœ‰å…¶å®ƒæ–¹æ³•ï¼š</p>
<p><img src="istio/../img/istio/istio-configmap.png" alt="istio çš„ configmap" /></p>
<h2 id="å‚è€ƒ-19"><a class="header" href="#å‚è€ƒ-19">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„åŠŸèƒ½ç±»åˆ«å’ŒåŸºæœ¬æ¦‚å¿µ"><a class="header" href="#istio-çš„åŠŸèƒ½ç±»åˆ«å’ŒåŸºæœ¬æ¦‚å¿µ">istio çš„åŠŸèƒ½ç±»åˆ«å’ŒåŸºæœ¬æ¦‚å¿µ</a></h1>
<h2 id="istio-çš„åŠŸèƒ½ç±»åˆ«"><a class="header" href="#istio-çš„åŠŸèƒ½ç±»åˆ«">istio çš„åŠŸèƒ½ç±»åˆ«</a></h2>
<p>istio çš„åŠŸèƒ½åˆ†ä¸ºå››ç±»ï¼š</p>
<ul>
<li>æµé‡ç®¡ç†ï¼Œ<a href="https://istio.io/docs/concepts/traffic-management/">Traffic Management</a></li>
<li>è®¤è¯åŠ å¯†ï¼Œ<a href="https://istio.io/docs/concepts/security/">Security</a></li>
<li>è®¿é—®ç­–ç•¥ï¼Œ<a href="https://istio.io/docs/concepts/policies/">Policies</a></li>
<li>å…¨å±€ç›‘æ§ï¼Œ<a href="https://istio.io/docs/concepts/observability/">Observability</a></li>
</ul>
<p><img src="https://www.lijiaocn.com/img/article/istio-arch.svg" alt="istio-arch" /></p>
<h2 id="istio-çš„åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#istio-çš„åŸºæœ¬æ¦‚å¿µ">istio çš„åŸºæœ¬æ¦‚å¿µ</a></h2>
<p>istio çš„è§„åˆ™é…ç½®ä¸»è¦å›´ç»•ä¸‹é¢çš„æ¦‚å¿µè¿›è¡Œï¼š</p>
<ul>
<li><a href="istio/./vsvc.html">VirtualService</a>ï¼Œ è½¬å‘è§„åˆ™</li>
<li><a href="istio/./dstrule.html">DestinationRule</a>ï¼Œå‡è¡¡ç­–ç•¥</li>
<li><a href="istio/./gateway.html">Gateway</a>ï¼Œå¯¹å¤–æœåŠ¡</li>
<li><a href="istio/./entry.html">ServiceEntry</a>ï¼Œå°è£…å¤–éƒ¨æœåŠ¡</li>
<li><a href="istio/./egress.html">Engress Control</a>, ä¸€ç§ç®¡æ§å¤–å‡ºè¯·æ±‚çš„æ–¹æ³•</li>
</ul>
<p>å¦‚æœéè¦ç±»æ¯”çš„è¯ï¼š</p>
<ul>
<li>VirtualService ç›¸å½“äº nginx ä¸­çš„ Server</li>
<li>DestinationRule ç›¸å½“äº nginx ä¸­çš„ upstream </li>
<li>Gateway å’Œ ServiceEntry ç›¸å½“äº kubernetes ä¸­çš„ ingress å’Œ endpoints</li>
</ul>
<h2 id="istio-çš„é…ç½®æ¨¡å‹"><a class="header" href="#istio-çš„é…ç½®æ¨¡å‹">istio çš„é…ç½®æ¨¡å‹</a></h2>
<p>istio å®šä¹‰äº†å¤§é‡çš„ CRDï¼Œé™¤äº†ä¸Šé¢çš„ VirtualServiceã€DestinationRuleã€Gatewayã€ServiceEntryï¼Œè¿˜æœ‰<a href="istio/./metrics.html">æŒ‡æ ‡é‡‡é›†</a> ã€<a href="istio/./log.html">æ—¥å¿—æ”¶é›†</a>ã€<a href="istio/./policy.html">è®¿é—®é™åˆ¶</a>ã€<a href="istio/./modify.html">è¯·æ±‚æ”¹å†™</a> ä¸­ç”¨åˆ°çš„ handlerã€instanceã€ruleã€‚</p>
<p><a href="https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/" title="Mixer Configuration Model">Mixer Configuration Model</a> ä»‹ç»äº† istio çš„æ§åˆ¶ç­–ç•¥å’Œç›‘æµ‹åº¦é‡çš„é…ç½®æ¨¡å‹ï¼Œå°±æ˜¯ handlerã€instanceã€ruleã€‚</p>
<h3 id="handler-å’Œ-adapter"><a class="header" href="#handler-å’Œ-adapter">handler å’Œ adapter</a></h3>
<p><a href="https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/#handlers" title="handlers">handler</a> ä¸»è¦çš„ç”¨é€”æ˜¯é…ç½® <a href="https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/#adapters" title="adpaters">adapter</a>ï¼Œadapters æ˜¯ä¸€å †é€‚é…å™¨ï¼Œç”¨æ¥å¯¹æ¥ prometheusã€fluentd ç­‰å…¶å®ƒç³»ç»Ÿï¼Œæˆ–è€…å®ç°åå•ã€æ ‡å‡†è¾“å‡ºç­‰ç‰¹æ®ŠåŠŸèƒ½ã€‚</p>
<p>istio å†…ç½®äº†å¾ˆå¤š <a href="https://istio.io/docs/reference/config/policy-and-telemetry/adapters/" title="istio adapters">adapters</a>ï¼Œadapter æœ‰å„è‡ªçš„é…ç½®å‚æ•°ï¼š</p>
<p><img src="istio/../img/istio/adapters.png" alt="istioæ”¯æŒçš„adapters" /></p>
<p><a href="istio/./metrics.html">æŒ‡æ ‡é‡‡é›†</a> ä½¿ç”¨çš„å¯¹æ¥ prometheus çš„ handlerï¼Œå°è£…äº† <a href="https://istio.io/docs/reference/config/policy-and-telemetry/adapters/prometheus/" title="adapter prometheus">adpater prometheus</a>ï¼š</p>
<pre><code class="language-yaml"># Configuration for a Prometheus handler
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: doublehandler
  namespace: istio-system
spec:
  compiledAdapter: prometheus
  params:
    metrics:
    - name: double_request_count # Prometheus metric name
      instance_name: doublerequestcount.instance.istio-system # Mixer instance name (fully-qualified)
      kind: COUNTER
      label_names:
      - reporter
      - source
      - destination
      - message
</code></pre>
<p><a href="istio/./policy.html">è®¿é—®é™åˆ¶</a> ä½¿ç”¨äº† <a href="https://istio.io/docs/reference/config/policy-and-telemetry/adapters/denier/" title="adapter denier">adapter list</a>ï¼š</p>
<pre><code class="language-yaml">apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: whitelistip
spec:
  compiledAdapter: listchecker
  params:
    # providerUrl: ordinarily black and white lists are maintained
    # externally and fetched asynchronously using the providerUrl.
    overrides: [&quot;10.57.0.0/16&quot;]  # overrides provide a static list
    blacklist: false
    entryType: IP_ADDRESSES
</code></pre>
<h3 id="instance-å’Œ-template"><a class="header" href="#instance-å’Œ-template">instance å’Œ template</a></h3>
<p><a href="https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/#instances" title="Instances">instance</a> çš„ç”¨é€”æ˜¯å°† mixer è·å–çš„å„ç§å±æ€§è½¬æ¢æˆ apdater çš„è¾“å…¥ï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦ <a href="https://istio.io/docs/reference/config/policy-and-telemetry/templates/" title="templates">templates</a> ä»‹å…¥ï¼š</p>
<p>istio å†…ç½®äº†å¾ˆå¤š <a href="https://istio.io/docs/reference/config/policy-and-telemetry/templates/" title="templates">templates</a>:</p>
<p><img src="istio/../img/istio/templates.png" alt="istio æ”¯æŒçš„ templates" /></p>
<p><a href="istio/./metrics.html">æŒ‡æ ‡é‡‡é›†</a> ä¸­ç”¨åˆ°äº† <a href="https://istio.io/docs/reference/config/policy-and-telemetry/templates/metric/" title="template metric">template metric</a>ï¼š</p>
<pre><code class="language-yaml"># Configuration for metric instances
apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: doublerequestcount
  namespace: istio-system
spec:
  compiledTemplate: metric
  params:
    value: &quot;2&quot; # count each request twice
    dimensions:
      reporter: conditional((context.reporter.kind | &quot;inbound&quot;) == &quot;outbound&quot;, &quot;client&quot;, &quot;server&quot;)
      source: source.workload.name | &quot;unknown&quot;
      destination: destination.workload.name | &quot;unknown&quot;
      message: '&quot;twice the fun!&quot;'
    monitored_resource_type: '&quot;UNSPECIFIED&quot;'
</code></pre>
<h3 id="ruleè¿æ¥-handler-å’Œ-instance"><a class="header" href="#ruleè¿æ¥-handler-å’Œ-instance">ruleï¼šè¿æ¥ handler å’Œ instance</a></h3>
<p>rule è®¾ç½® handler çš„ä½œç”¨èŒƒå›´ï¼Œå¹¶æŒ‡å®šä¸º handler æä¾›è¾“å…¥çš„ instanceï¼Œå°† handler å’Œ instance é…å¯¹ã€‚</p>
<p>ä»¥ <a href="istio/./policy.html">æŒ‰æ ‡ç­¾è®¾ç½®é»‘ç™½åå•</a> ä¸­çš„ rule ä¸ºä¾‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: rule
metadata:
  name: denyproductpage
spec:
  match: destination.labels[&quot;app&quot;] == &quot;http-record&quot; &amp;&amp; destination.labels[&quot;version&quot;] == &quot;v2&quot; &amp;&amp; source.labels[&quot;app&quot;]==&quot;productpage&quot;
  actions:
  - handler: denyproductpagehandler
    instances: [ denyproductpagerequest ]
</code></pre>
<p>ä¸Šé¢çš„é…ç½®é™å®šåªä¸ºä» productpage åˆ° http-record:v1 çš„è¯·æ±‚ï¼Œé€šè¿‡ denyproductpagerequest æ¨¡æ¿ç”ŸæˆçŠ¶æ€æ•°æ®, ä½œä¸º denyproductpagehandler çš„è¾“å…¥ã€‚</p>
<p>instance å’Œ handler çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">---
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: handler
metadata:
  name: denyproductpagehandler
spec:
  compiledAdapter: denier
  params:
    status:
      code: 7
      message: Not allowed
---
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: instance
metadata:
  name: denyproductpagerequest
spec:
  compiledTemplate: checknothing
</code></pre>
<h3 id="adapter-å’Œ-template-çš„é…å¯¹"><a class="header" href="#adapter-å’Œ-template-çš„é…å¯¹">adapter å’Œ template çš„é…å¯¹</a></h3>
<p>é€šè¿‡ tempalte ç”Ÿæˆçš„çŠ¶æ€æ•°æ®ä¸èƒ½ç”¨äºæ‰€æœ‰çš„ adapterï¼Œtempalte å’Œ adapter ä¹‹é—´æœ‰é…å¯¹å…³ç³»ã€‚</p>
<p>template é€‚ç”¨çš„ adpatersï¼Œ<a href="https://istio.io/docs/reference/config/policy-and-telemetry/templates/#adapters" title="template é€‚ç”¨çš„ adpaters">ç‚¹å‡»æŸ¥çœ‹æœ€æ–°</a>ï¼š</p>
<p><img src="istio/../img/istio/tempalte-vs-adapter.png" alt="template é€‚ç”¨çš„ adpaters" /></p>
<p>adapter æ”¯æŒçš„ templatesï¼Œ<a href="https://istio.io/docs/reference/config/policy-and-telemetry/adapters/#templates" title="adater æ”¯æŒçš„ templates">ç‚¹å‡»æŸ¥çœ‹æœ€æ–°</a>ï¼š</p>
<p><img src="istio/../img/istio/adpater-vs-template.png" alt="adapter æ”¯æŒçš„ templates" /></p>
<h3 id="instance-å’Œ-rule-å¯ä»¥ä½¿ç”¨çš„å±æ€§å’Œå±æ€§è¡¨è¾¾å¼"><a class="header" href="#instance-å’Œ-rule-å¯ä»¥ä½¿ç”¨çš„å±æ€§å’Œå±æ€§è¡¨è¾¾å¼">instance å’Œ rule å¯ä»¥ä½¿ç”¨çš„å±æ€§å’Œå±æ€§è¡¨è¾¾å¼</a></h3>
<p>[Attributes][15] æ˜¯ istio çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ã€‚instance å’Œ rule éƒ½ç”¨åˆ°äº†å±æ€§å’Œå±æ€§è¡¨è¾¾å¼ï¼Œinstance é€šè¿‡å±æ€§è¡¨è¾¾å¼ç”Ÿæˆ handler çš„è¾“å…¥ï¼Œrule é€šè¿‡å±æ€§è¡¨è¾¾å¼é™å®š handler çš„ä½œç”¨èŒƒå›´ã€‚</p>
<p>istio æ”¯æŒçš„æ‰€æœ‰å±æ€§ï¼š</p>
<ul>
<li>[Attributes Vocabulary][16]</li>
</ul>
<p>istio å±æ€§è¡¨è¾¾å¼è¯­æ³•ï¼š</p>
<ul>
<li>[Expression Language][17]ã€‚</li>
</ul>
<h2 id="è‡ªå®šä¹‰-adpater-å’Œ-template"><a class="header" href="#è‡ªå®šä¹‰-adpater-å’Œ-template">è‡ªå®šä¹‰ adpater å’Œ template</a></h2>
<p>istio <a href="istio/./modify.html">è¯·æ±‚æ”¹å†™</a> ä¸­ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ adpater å’Œ templateã€‚</p>
<h2 id="å‚è€ƒ-20"><a class="header" href="#å‚è€ƒ-20">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<p>[14]: https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/#rules &quot;Rules'
[15]: https://istio.io/docs/reference/config/policy-and-telemetry/mixer-overview/#attributes &quot;Attributes&quot;
[16]: https://istio.io/docs/reference/config/policy-and-telemetry/attribute-vocabulary/ &quot;Attribute Vocabulary&quot;
[17]: https://istio.io/docs/reference/config/policy-and-telemetry/expression-language/ &quot;Expression Language&quot;</p>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„åŸºæœ¬æ¦‚å¿µvirtualservice"><a class="header" href="#istio-çš„åŸºæœ¬æ¦‚å¿µvirtualservice">istio çš„åŸºæœ¬æ¦‚å¿µï¼šVirtualService</a></h1>
<p><a href="https://istio.io/docs/concepts/traffic-management/#virtual-services" title="Virtual services">VirtualService</a> æ˜¯ istio çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒåŒ…å«ä¸€ç»„ route ï¼Œå®šä¹‰äº†è¯·æ±‚è½¬å‘è§„åˆ™ï¼Œå‚è€ƒ <a href="https://istio.io/docs/reference/config/networking/v1alpha3/virtual-service/" title="Envoy VirtualService Detail">VirtualService</a>ã€‚ VirtualService çš„é…ç½®æ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: my-namespace
spec:
  hosts:
  - my-namespace.com
  http:
  - match:
    - uri:
        prefix: /svc-1
    route:
    - destination:
        host: svc-1.my-namespace.svc.cluster.local
  - match:
    - uri:
        prefix: /svc-2
    route:
    - destination:
        host: svc-2.my-namespace.svc.cluster.local
</code></pre>
<p><code>hosts</code> æ˜¯åŸŸååŒ¹é…è§„åˆ™ï¼Œé™å®šäº† virtualservice çš„ä½œç”¨èŒƒå›´ï¼Œå³ virtualservice ä¸­çš„è§„åˆ™åªå½±å“ä¸ hosts åŒ¹é…çš„è¯·æ±‚ã€‚hosts åŒ¹é…è§„åˆ™å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ã€‚</p>
<p><code>host</code>ï¼ˆæ³¨æ„å’Œ hosts å­—æ®µåŒºåˆ†å¼€ï¼‰æ˜¯è½¬å‘ç›®æ ‡ï¼Œç¬¦å·è¦æ±‚çš„è¯·æ±‚è¢«è½¬å‘ç»™åˆ° host ä¸­é…ç½®çš„åŸŸåã€‚åŸŸåæ—¢å¯ä»¥æ˜¯ kubernetes ä¸­çš„åŸŸåï¼ˆå¯ä»¥è·¨ namespaceï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨æœåŠ¡çš„åŸŸåã€‚</p>
<p>VirtualService è¿˜å¯ä»¥ç»‘å®š gatewayï¼ˆå³åªå¤„ç†ç‰¹å®š gateway çš„æµé‡ï¼‰ï¼Œå®ƒè”ç»“äº† <a href="istio/./dstrule.html">DestinationRule</a>ã€<a href="istio/./gateway.html">Gateways</a> å’Œ <a href="istio/./entry.html">ServiceEntry</a>ï¼Œåé¢ç« èŠ‚ä¸­ä¼šé¢‘ç¹ç”¨åˆ° VirtualServiceã€‚</p>
<h2 id="å‚è€ƒ-21"><a class="header" href="#å‚è€ƒ-21">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„åŸºæœ¬æ¦‚å¿µ-destinationrule"><a class="header" href="#istio-çš„åŸºæœ¬æ¦‚å¿µ-destinationrule">istio çš„åŸºæœ¬æ¦‚å¿µï¼š DestinationRule</a></h1>
<p><a href="https://istio.io/docs/reference/config/networking/v1alpha3/destination-rule/" title="Destination Rule">DestinationRule</a> æ˜¯è½¬å‘ç­–ç•¥ï¼Œåœ¨ route è§„åˆ™ä¹‹åèµ·ä½œç”¨ï¼Œç›¸å½“äº nginx ä¸­çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚å®ƒä½œç”¨äº VirtualService çš„ destination ä¸­çš„åŒåçš„ hostã€‚</p>
<h2 id="å°†-pod-æŒ‰ç…§-label-åˆ†ç»„åˆ†åˆ«è®¾ç½®è½¬å‘ç­–ç•¥"><a class="header" href="#å°†-pod-æŒ‰ç…§-label-åˆ†ç»„åˆ†åˆ«è®¾ç½®è½¬å‘ç­–ç•¥">å°† Pod æŒ‰ç…§ label åˆ†ç»„ï¼Œåˆ†åˆ«è®¾ç½®è½¬å‘ç­–ç•¥</a></h2>
<p>ä¸‹é¢çš„ DestinationRule ä½œç”¨äº my-svcï¼Œå½±å“åˆ° my-svc çš„è¯·æ±‚çš„åˆ†é…ç­–ç•¥ã€‚</p>
<p>è®¾ç½®äº†å…¨å±€çš„è½¬å‘ç­–ç•¥ï¼ˆsubsets ä»¥å¤–çš„é…ç½®ï¼‰ï¼ŒåŒæ—¶å°† my-svc çš„ pod æŒ‰ç…§ label åˆ†æˆäº†ä¸‰ç»„ï¼Œå•ç‹¬è®¾ç½®äº†æ¯ç»„çš„è½¬å‘ç­–ç•¥ï¼ˆsubnets å†…çš„é…ç½®ï¼‰ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: my-destination-rule
spec:
  host: my-svc
  trafficPolicy:
    loadBalancer:
      simple: RANDOM
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v3
    labels:
      version: v3
</code></pre>
<ul>
<li>host æŒ‡å®šä½œç”¨çš„æœåŠ¡ï¼Œä¸ VirtualService çš„ Destination ä¸­çš„ host é…å¯¹</li>
<li>subsets ä¸­çš„çš„è½¬å‘ç­–ç•¥è¦†å‰é¢ subsets å¤–çš„åŒåé…ç½®</li>
<li>subsets ä¸­æ²¡æœ‰çš„é…ç½®ï¼Œä½¿ç”¨ subsets å¤–çš„é…ç½®</li>
</ul>
<p>subsets ä¸­ labels çš„ä½œç”¨æ˜¯ç­›é€‰ podï¼Œä¸Šé¢çš„é…ç½®å°† <code>my-svc</code> çš„ pod æŒ‰ç…§ label åˆ†æˆäº† v1ã€v2ã€v3 ä¸‰ç»„ï¼Œä¸ºæ¯ç»„å•ç‹¬è®¾ç½®è½¬å‘ç­–ç•¥ã€‚</p>
<h2 id="å°†è¯·æ±‚æŒ‰ç…§ç«¯å£åˆ†ç»„åˆ†åˆ«è®¾ç½®è½¬å‘ç­–ç•¥"><a class="header" href="#å°†è¯·æ±‚æŒ‰ç…§ç«¯å£åˆ†ç»„åˆ†åˆ«è®¾ç½®è½¬å‘ç­–ç•¥">å°†è¯·æ±‚æŒ‰ç…§ç«¯å£åˆ†ç»„ï¼Œåˆ†åˆ«è®¾ç½®è½¬å‘ç­–ç•¥</a></h2>
<p>é™¤äº†æŒ‰ç…§ pod åˆ†ç»„ï¼Œè¿˜å¯ä»¥æŒ‰ç›®çš„ç«¯å£åˆ†ç»„ï¼Œä¸ºæ¯ä¸ªç«¯å£è®¾ç½®è½¬å‘ç­–ç•¥ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: bookinfo-ratings-port
spec:
  host: ratings.prod.svc.cluster.local
  trafficPolicy: # Apply to all ports
    portLevelSettings:
    - port:
        number: 80
      loadBalancer:
        simple: LEAST_CONN
    - port:
        number: 9080
      loadBalancer:
        simple: ROUND_ROBIN
</code></pre>
<p>Destination Rule çš„è¯¦æƒ…è§ <a href="https://istio.io/docs/reference/config/networking/v1alpha3/destination-rule/" title="Destination Rule">Destination Rule</a>ã€‚</p>
<h2 id="åœ¨-virtualservice-ä¸­ä½¿ç”¨-destinationrule"><a class="header" href="#åœ¨-virtualservice-ä¸­ä½¿ç”¨-destinationrule">åœ¨ VirtualService ä¸­ä½¿ç”¨ DestinationRule</a></h2>
<p>åœ¨ VirtualService ä¸­æŒ‡å®š destination æ—¶ï¼Œå¼•ç”¨ destination ä¸­çš„ subsetï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
  namespace: foo
spec:
  hosts:
  - reviews # interpreted as reviews.foo.svc.cluster.local
  http:
  - match:
    - uri:
        prefix: &quot;/wpcatalog&quot;
    - uri:
        prefix: &quot;/consumercatalog&quot;
    rewrite:
      uri: &quot;/newcatalog&quot;
    route:
    - destination:
        host: reviews # interpreted as reviews.foo.svc.cluster.local
        subset: v2
  - route:
    - destination:
        host: reviews # interpreted as reviews.foo.svc.cluster.local
        subset: v1
</code></pre>
<h2 id="å‚è€ƒ-22"><a class="header" href="#å‚è€ƒ-22">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„åŸºæœ¬æ¦‚å¿µ-gateways"><a class="header" href="#istio-çš„åŸºæœ¬æ¦‚å¿µ-gateways">istio çš„åŸºæœ¬æ¦‚å¿µï¼š Gateways</a></h1>
<p><a href="https://istio.io/docs/concepts/traffic-management/#gateways" title="Gateways">Gateways</a> ç®¡ç†å—åŒ—å‘æµé‡ï¼Œä¹Ÿå°±æ˜¯ä»å¤–éƒ¨æµå…¥ç½‘æ ¼ï¼Œå’Œä»ç½‘æ ¼æµå‡ºåˆ°å¤–éƒ¨çš„æµé‡ã€‚å®ƒå½±å“ç½‘æ ¼è¾¹ç•Œçš„ envoy ï¼Œè¾¹ç•Œ envoy é€šå¸¸è¢«åˆ†æˆä¸¤ç»„ï¼š</p>
<ul>
<li>ä¸€ç»„å¤„ç†å¤–éƒ¨æµå…¥ç½‘æ ¼çš„æµé‡ï¼Œç§°ä¸º ingress gateway</li>
<li>ä¸€ç»„å¤„ç†ç½‘æ ¼æµå‘å¤–éƒ¨çš„æµé‡ï¼Œç§°ä¸º egress gateway</li>
</ul>
<p><img src="istio/../img/envoy/ingress-egress.svg" alt="istioçš„è¯·æ±‚æµå‘" /></p>
<p>Gateway è¯¦ç»†å†…å®¹è§ <a href="https://istio.io/docs/reference/config/networking/v1alpha3/gateway/" title="Envoy Gateway Detail">Envoy Gateway Detail</a>ã€‚</p>
<h2 id="å…è®¸å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡"><a class="header" href="#å…è®¸å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡">å…è®¸å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡</a></h2>
<p>ä¸‹é¢çš„é…ç½®ä¼šè¢«è½¬æ¢æˆè¾¹ç•Œ envoyï¼ˆå¸¦æœ‰ app: my-gateway-controller æ ‡ç­¾çš„ envoy podï¼‰ä¸­çš„é…ç½®ï¼šå…è®¸è®¿é—®é›†ç¾¤å†…çš„ ext-hostã€‚</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ext-host-gwy
spec:
  selector: 
    app: my-gateway-controller
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - ext-host
    tls:
      mode: SIMPLE
      serverCertificate: /tmp/tls.crt
      privateKey: /tmp/tls.key
</code></pre>
<p>selector ç­›é€‰è¦ä½œç”¨çš„ envoy podï¼Œä¸Šé¢çš„é…ç½®çš„æ„æ€æ˜¯ï¼šæŒ‡ç¤ºå¸¦æœ‰ <code>app: my-gateway-controller</code> æ ‡ç­¾çš„ envoy pod ï¼ˆé€šå¸¸æ˜¯ ingress gateway çš„ podï¼‰ç›‘å¬ 443ç«¯å£ï¼Œæ”¾è¡Œ host ä¸º ext-host çš„è¯·æ±‚ã€‚</p>
<h2 id="æ›´å¤æ‚çš„é…ç½®"><a class="header" href="#æ›´å¤æ‚çš„é…ç½®">æ›´å¤æ‚çš„é…ç½®</a></h2>
<p><a href="https://istio.io/docs/reference/config/networking/v1alpha3/gateway/" title="Envoy Gateway Detail">Envoy Gateway Detail</a> ä¸­ç»™å‡ºäº†ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼ŒåŒæ—¶ç›‘å¬å¤šä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£æ”¾è¡Œä¸åŒçš„è¯·æ±‚ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: my-gateway
  namespace: some-config-namespace
spec:
  selector:
    app: my-gateway-controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - uk.bookinfo.com
    - eu.bookinfo.com
    tls:
      httpsRedirect: true # sends 301 redirect for http requests
  - port:
      number: 443
      name: https-443
      protocol: HTTPS
    hosts:
    - uk.bookinfo.com
    - eu.bookinfo.com
    tls:
      mode: SIMPLE # enables HTTPS on this port
      serverCertificate: /etc/certs/servercert.pem
      privateKey: /etc/certs/privatekey.pem
  - port:
      number: 9443
      name: https-9443
      protocol: HTTPS
    hosts:
    - &quot;bookinfo-namespace/*.bookinfo.com&quot;
    tls:
      mode: SIMPLE # enables HTTPS on this port
      credentialName: bookinfo-secret # fetches certs from Kubernetes secret
  - port:
      number: 9080
      name: http-wildcard
      protocol: HTTP
    hosts:
    - &quot;*&quot;
  - port:
      number: 2379 # to expose internal service via external port 2379
      name: mongo
      protocol: MONGO
    hosts:
    - &quot;*&quot;
</code></pre>
<h2 id="åœ¨-virtualservice-ä¸­ä½¿ç”¨-gateway"><a class="header" href="#åœ¨-virtualservice-ä¸­ä½¿ç”¨-gateway">åœ¨ VirtualService ä¸­ä½¿ç”¨ Gateway</a></h2>
<p>Gateway æŒ‡ç¤ºè¾¹ç•Œ envoy ç›‘å¬ç«¯å£ã€æ”¾è¡Œè¯·æ±‚ï¼Œä½†æ˜¯æ²¡æœ‰å‘Šè¯‰è¾¹ç•Œ envoy å¦‚ä½•è½¬å‘è¿™äº›ä»å¤–éƒ¨è¿›æ¥çš„è¯·æ±‚ï¼Œè½¬å‘è§„åˆ™åœ¨ <a href="istio/./vsvc.html">VirtualService</a> ä¸­å®šä¹‰ã€‚</p>
<p>Gateway åªæœ‰è¢« VirtualService å¼•ç”¨äº†ï¼Œæ‰çŸ¥é“å°†æµå…¥çš„è¯·æ±‚è½¬å‘åˆ°å“ªé‡Œï¼ŒVirtualService é€šè¿‡ gateways å­—æ®µç»‘å®š Gateway.</p>
<p>å°†ä» some-config-namespace/my-gateway è¿›æ¥çš„ã€ç›®åœ°ç«¯å£ä¸º 27017 çš„æµé‡è½¬å‘åˆ° mongo.prod.svc.cluster.localï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo-Mongo
  namespace: bookinfo-namespace
spec:
  hosts:
  - mongosvr.prod.svc.cluster.local # name of internal Mongo service
  gateways:
  - some-config-namespace/my-gateway # can omit the namespace if gateway is in same
                                     #  namespace as virtual service.
  tcp:
  - match:
    - port: 27017
    route:
    - destination:
        host: mongo.prod.svc.cluster.local
        port:
          number: 5555
</code></pre>
<p>VirtualService å¯ä»¥ç»‘å®šå¤šä¸ª gatewayï¼Œä¾‹å¦‚ç»‘å®š some-config-namespace/my-gateway å’Œç½‘æ ¼å†…éƒ¨ï¼ˆmeshï¼‰ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo-rule
  namespace: bookinfo-namespace
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  - uk.bookinfo.com
  - eu.bookinfo.com
  gateways:
  - some-config-namespace/my-gateway
  - mesh # applies to all the sidecars in the mesh
  http:
  - match:
    - headers:
        cookie:
          exact: &quot;user=dev-123&quot;
    route:
    - destination:
        port:
          number: 7777
        host: reviews.qa.svc.cluster.local
  - match:
    - uri:
        prefix: /reviews/
    route:
    - destination:
        port:
          number: 9080 # can be omitted if it's the only port for reviews
        host: reviews.prod.svc.cluster.local
      weight: 80
    - destination:
        host: reviews.qa.svc.cluster.local
      weight: 20
</code></pre>
<p>è¿™é‡Œçš„ mesh æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­˜åœ¨ï¼Œå®ƒæ˜¯ä»£è¡¨æ•´ä¸ªç½‘æ ¼ã€‚</p>
<h2 id="é™å®š-gateway-çš„å¼•ç”¨èŒƒå›´"><a class="header" href="#é™å®š-gateway-çš„å¼•ç”¨èŒƒå›´">é™å®š Gateway çš„å¼•ç”¨èŒƒå›´</a></h2>
<p>å¦‚æœåœ¨ Gateway ä¸­è®¾ç½®äº† hostsï¼Œé‚£ä¹ˆåªèƒ½è¢«åŒ…å«åŒæ ·çš„ host çš„ VirtualService ç»‘å®šï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: my-gateway
  namespace: some-config-namespace
spec:
  selector:
    app: my-gateway-controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;ns1/*&quot;
    - &quot;ns2/foo.bar.com&quot;
</code></pre>
<ul>
<li><code>ns1/*</code>ï¼šåä¸º ns1 çš„ namespace ä¸­çš„æ‰€æœ‰ VirtualService éƒ½å¯ä»¥ç»‘å®š my-gatewayã€‚</li>
<li><code>ns2/foo.bar.com</code> ï¼šåä¸º ns2 çš„namespace ä¸­åŒ…å« foo.bar.com çš„ VirtualService å¯ä»¥ç»‘å®š my-gatewayã€‚</li>
</ul>
<h2 id="å‚è€ƒ-23"><a class="header" href="#å‚è€ƒ-23">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„åŸºæœ¬æ¦‚å¿µserviceentry"><a class="header" href="#istio-çš„åŸºæœ¬æ¦‚å¿µserviceentry">istio çš„åŸºæœ¬æ¦‚å¿µï¼šServiceEntry</a></h1>
<p><a href="https://istio.io/docs/concepts/traffic-management/#service-entries" title="Service Entry">ServiceEntry</a> ç”¨æ¥å°†å¤–éƒ¨çš„æœåŠ¡å°è£…æˆ istio ç½‘æ ¼ä¸­çš„æœåŠ¡ï¼Œä¸ºç½‘æ ¼å†…å’Œç½‘æ ¼å¤–çš„æœåŠ¡çš„ç»Ÿä¸€ç®¡ç†æä¾›åŸºç¡€ï¼Œè¯¦æƒ…è§ <a href="https://istio.io/docs/reference/config/networking/v1alpha3/service-entry/" title="Service Entry Detail">Service Entry Detail</a>ã€‚</p>
<p>å¤–éƒ¨æœåŠ¡è¢«å°è£…ä¸º ServiceEntryï¼Œå¯ä»¥åƒ kubernetes å†…éƒ¨çš„æœåŠ¡ä¸€æ ·ä½¿ç”¨ã€‚</p>
<h2 id="å°è£…å¤–éƒ¨çš„åŸŸå"><a class="header" href="#å°è£…å¤–éƒ¨çš„åŸŸå">å°è£…å¤–éƒ¨çš„åŸŸå</a></h2>
<p>å¤–éƒ¨æœåŠ¡æ˜¯åŸŸåæˆ– IPï¼Œä¸‹é¢æ˜¯åŸŸåçš„ä¾‹å­ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-https
spec:
  hosts:
  - api.dropboxapi.com
  - www.googleapis.com
  - api.facebook.com
  location: MESH_EXTERNAL
  ports:
  - number: 443
    name: https
    protocol: TLS
  resolution: DNS
</code></pre>
<p>hosts æ˜¯å¤–éƒ¨æœåŠ¡åœ¨ç½‘æ ¼å†…çš„åç§°ï¼Œå®ƒå¯ä»¥ä¸å¤–éƒ¨æœåŠ¡çš„åŸŸåç›¸åŒï¼Œå¯ä»¥ä¸åŒï¼Œå–å†³ç½‘æ ¼å†…è¦ä½¿ç”¨çš„åŸŸåã€‚ä¸Šé¢çš„ä¾‹å­ï¼Œæ²¡æœ‰é…ç½®å¤–éƒ¨æœåŠ¡çš„åŸå§‹åŸŸåï¼Œé»˜è®¤åŸå§‹åŸŸåä¸ hosts ä¸­çš„åŸŸåç›¸åŒã€‚</p>
<p>å¦‚æœå¤–éƒ¨æœåŠ¡åœ¨ç½‘æ ¼å†…çš„åŸŸåå’Œç½‘æ ¼å¤–çš„åŸŸåä¸åŒï¼Œåœ¨ endpoints ä¸­é…ç½®åŸå§‹åŸŸåï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-dns
spec:
  hosts:
  - foo.bar.com
  location: MESH_EXTERNAL
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: DNS
  endpoints:
  - address: us.foo.bar.com
    ports:
      https: 8080
  - address: uk.foo.bar.com
    ports:
      https: 9080
  - address: in.foo.bar.com
    ports:
      https: 7080
</code></pre>
<p>resolution æŒ‡å®šè§£ææ–¹å¼ä¸º DNSã€‚</p>
<h2 id="å°è£…-unix-domain-socket"><a class="header" href="#å°è£…-unix-domain-socket">å°è£… unix domain socket</a></h2>
<p>unix domain socket åœ°å€ä¹Ÿå¯ä»¥å°è£…åˆ°ç½‘æ ¼å†…ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: unix-domain-socket-example
spec:
  hosts:
  - &quot;example.unix.local&quot;
  location: MESH_EXTERNAL
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: STATIC
  endpoints:
  - address: unix:///var/run/example/socket
</code></pre>
<h2 id="ä¸ºå¤–éƒ¨æœåŠ¡é…ç½®-vip"><a class="header" href="#ä¸ºå¤–éƒ¨æœåŠ¡é…ç½®-vip">ä¸ºå¤–éƒ¨æœåŠ¡é…ç½® vip</a></h2>
<p>å°†å¤–éƒ¨æœåŠ¡çš„å¤šä¸ª ip å°è£…æˆåä¸º mymongodb.somedomain çš„ç½‘æ ¼å†…æœåŠ¡ï¼Œå¹¶è®¾ç½®ç½‘æ ¼å†… vipï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-mongocluster
spec:
  hosts:
  - mymongodb.somedomain # not used
  addresses:
  - 192.192.192.192/24 # VIPs
  ports:
  - number: 27018
    name: mongodb
    protocol: MONGO
  location: MESH_INTERNAL
  resolution: STATIC
  endpoints:
  - address: 2.2.2.2
  - address: 3.3.3.3
</code></pre>
<h2 id="è®¾ç½®å¤–éƒ¨æœåŠ¡çš„è½¬å‘ç­–ç•¥"><a class="header" href="#è®¾ç½®å¤–éƒ¨æœåŠ¡çš„è½¬å‘ç­–ç•¥">è®¾ç½®å¤–éƒ¨æœåŠ¡çš„è½¬å‘ç­–ç•¥</a></h2>
<p>å¤–éƒ¨æœåŠ¡è½¬å‘ç­–ç•¥çš„è®¾ç½®æ–¹æ³•å’Œå†…éƒ¨æœåŠ¡ç›¸åŒï¼Œç”¨ <a href="istio/./dstrule.html">DestinationRule</a> è®¾ç½®ï¼Œä¸‹ä¾‹å­ä¸­çš„ mymongodb.somedomain æ˜¯å¤–éƒ¨æœåŠ¡åœ¨ç½‘æ ¼å†…çš„åç§°ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: mtls-mongocluster
spec:
  host: mymongodb.somedomain
  trafficPolicy:
    tls:
      mode: MUTUAL
      clientCertificate: /etc/certs/myclientcert.pem
      privateKey: /etc/certs/client_private_key.pem
      caCertificates: /etc/certs/rootcacerts.pem
</code></pre>
<h2 id="å‚è€ƒ-24"><a class="header" href="#å‚è€ƒ-24">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„æµå‡ºæµé‡ç®¡æ§"><a class="header" href="#istio-çš„æµå‡ºæµé‡ç®¡æ§">istio çš„æµå‡ºæµé‡ç®¡æ§</a></h1>
<p>Engress Control ä¸æ˜¯ istio çš„åŸºæœ¬æ¦‚å¿µï¼Œè€Œæ˜¯ä¸€ç§ç”¨æ³•ã€‚</p>
<p>istio ä¸ä»…èƒ½å¤Ÿç®¡æ§ä»å¤–éƒ¨æµå…¥çš„æµé‡ï¼ˆé€šè¿‡ <a href="istio/./entry.html">Service Entry</a>ï¼Œä¹Ÿå¯ä»¥ç®¡æ§æµå‡ºçš„æµé‡ã€‚æµå‡ºæµé‡çš„ç®¡æ§å¤æ‚ä¸€äº›ï¼ŒåŒæ—¶ç”¨åˆ° <a href="istio/./vsvc.html">VirtualService</a>ã€<a href="istio/./entry.html">ServiceEntry</a> å’Œ <a href="istio/./gateway.html">Gateway</a>ã€‚</p>
<p>åŸºæœ¬æ€è·¯ï¼š</p>
<ul>
<li>å°†å¤–éƒ¨çš„æœåŠ¡å°è£…æˆä¸€ä¸ª ServiceEntry</li>
<li>åˆ›å»ºä¸€ä¸ª Gatewayï¼Œç»‘å®š engress envoy </li>
<li>åˆ›å»ºä¸€ä¸ª VirtualServiceï¼Œå°†ç½‘æ ¼å†…å¯¹å¤–éƒ¨æœåŠ¡è¯·æ±‚çš„è½¬å‘åˆ° engress envoy</li>
<li>engress envoy å°†æ”¶åˆ°çš„è¯·æ±‚è½¬å‘åˆ° ServiceEntryï¼ˆå³å¤–éƒ¨æœåŠ¡ï¼‰</li>
</ul>
<h2 id="å°†å¤–éƒ¨æœåŠ¡å°è£…æˆ-serviceentry"><a class="header" href="#å°†å¤–éƒ¨æœåŠ¡å°è£…æˆ-serviceentry">å°†å¤–éƒ¨æœåŠ¡å°è£…æˆ ServiceEntry</a></h2>
<p>å°è£…åçš„å¤–éƒ¨æœåŠ¡åœ¨ç½‘æ ¼å†…çš„åç§°æ˜¯ <code>httpbin.com</code>ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-httpbin
  namespace : egress
spec:
  hosts:
  - httpbin.com
  exportTo:
  - &quot;.&quot;
  location: MESH_EXTERNAL
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: DNS
</code></pre>
<p>å¤–éƒ¨æœåŠ¡çš„å°è£…æ–¹æ³•æœ‰å¤šä¸­ï¼Œè§ <a href="istio/./entry.html">ServiceEntry</a>ï¼‰ã€‚</p>
<h2 id="åˆ›å»ºæ¥æ”¶å¤–å‡ºæµé‡çš„-gateway"><a class="header" href="#åˆ›å»ºæ¥æ”¶å¤–å‡ºæµé‡çš„-gateway">åˆ›å»ºæ¥æ”¶å¤–å‡ºæµé‡çš„ Gateway</a></h2>
<p>åˆ›å»º Gatewayï¼ŒæŒ‡ç¤ºè¾¹ç•Œçš„ engress envoy ç›‘å¬ 80 ç«¯å£ï¼Œè¿™é‡Œé€‰å®šå¸¦æœ‰ &quot;istio: egressgateway&quot; æ ‡ç­¾çš„è¾¹ç•Œ envoyï¼Œä¸æ¥æ”¶å¤–éƒ¨è¯·æ±‚çš„ envoy åŒºåˆ†å¼€ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
 name: istio-egressgateway
 namespace: istio-system
spec:
 selector:
   istio: egressgateway
 servers:
 - port:
     number: 80
     name: http
     protocol: HTTP
   hosts:
   - &quot;*&quot;
</code></pre>
<h2 id="åˆ›å»ºåŒ…å«è½¬å‘è§„åˆ™çš„-virtualservice"><a class="header" href="#åˆ›å»ºåŒ…å«è½¬å‘è§„åˆ™çš„-virtualservice">åˆ›å»ºåŒ…å«è½¬å‘è§„åˆ™çš„ VirtualService</a></h2>
<p>åˆ›å»º hosts ä¸º httpbin.com çš„ VirtualServiceï¼Œç»‘å®š mesh å’Œå‰é¢åˆ›å»ºçš„ istio-egressgatewayï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: gateway-routing
  namespace: egress
spec:
  hosts:
  - httpbin.com
  exportTo:
  - &quot;*&quot;
  gateways:
  - mesh
  - istio-egressgateway
  http:
  - match:
    - port: 80
      gateways:
      - mesh
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
  - match:
    - port: 80
      gateways:
      - istio-egressgateway
    route:
    - destination:
        host: httpbin.com
</code></pre>
<p>http ä¸­çš„ ä¸¤ä¸ª match å¯¹åº”ä¸¤ä¸ªè½¬å‘è§„åˆ™ï¼Œé’ˆå¯¹çš„éƒ½æ˜¯ host ä¸º httpbin.com çš„è¯·æ±‚ï¼š</p>
<ul>
<li>
<p>ç¬¬ä¸€ä¸ªè§„åˆ™ï¼šç½‘æ ¼å†…å‘èµ·çš„è¯·æ±‚ï¼ˆç»‘å®šäº† meshï¼‰ï¼Œè½¬å‘åˆ° istio-egressgateway.istio-system.svc.cluster.localï¼Œè¿™ä¸ªåŸŸåæ˜¯ istio-egressgateway é€‰æ‹©çš„è¾¹ç•Œ envoy åœ¨ kubernetes ä¸­çš„åœ°å€ï¼Œå‘é€åˆ°è¿™ä¸ªåœ°å€å°±æ˜¯å‘é€åˆ° istio-egressgatewayã€‚</p>
</li>
<li>
<p>ç¬¬äºŒä¸ªè§„åˆ™ï¼šistio-egressgateway çš„ 80 ç«¯å£æ”¶åˆ°çš„è¯·æ±‚ ï¼Œå³è¾¹ç•Œ envoy æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼ˆç¬¬ä¸€ä¸ªè§„åˆ™è®¾ç½®çš„ä»ç½‘æ ¼å†…éƒ¨è½¬æ¥çš„æµé‡ï¼‰ï¼Œè½¬å‘ç»™å¤–éƒ¨æœåŠ¡ httpbin.comã€‚</p>
</li>
</ul>
<p>åœ¨ä¸Šé¢ä¸¤ä¸ªè§„åˆ™çš„ä½œç”¨ä¸‹ï¼Œä»ç½‘æ ¼å†…å‘èµ·çš„è¯·æ±‚å…ˆè½¬å‘ç»™è¾¹ç•Œ envoyï¼Œå†ç”±è¾¹ç•Œ envoy å°†è½¬å‘ç»™å¤–éƒ¨çš„ httpbin.comï¼Œå®ç°äº†å¯¹ <code>å¤–å‡ºæµé‡</code> çš„æµé‡é›†ä¸­ç®¡æ§ï¼Œengress envoy ç›¸å½“äºä¸€ä¸ªä»£ç†æœåŠ¡å™¨ã€‚</p>
<h2 id="å‚è€ƒ-25"><a class="header" href="#å‚è€ƒ-25">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="istio-çš„åº”ç”¨ç¤ºä¾‹æ‹†è§£"><a class="header" href="#istio-çš„åº”ç”¨ç¤ºä¾‹æ‹†è§£">Istio çš„åº”ç”¨ç¤ºä¾‹æ‹†è§£</a></h1>
<p>Istio çš„ä»£ç ç›®å½•å’Œ release æ–‡ä»¶ä¸­æä¾›å¤šä¸ª <a href="https://github.com/istio/istio/tree/master/samples" title="istio samples">åº”ç”¨ç¤ºä¾‹</a>ï¼š</p>
<pre><code class="language-sh">$ tree -L 1 istio-1.2.5-linux/samples
istio-1.2.5-linux/samples
â”œâ”€â”€ README.md
â”œâ”€â”€ bookinfo
â”œâ”€â”€ certs
â”œâ”€â”€ custom-bootstrap
â”œâ”€â”€ external
â”œâ”€â”€ fortio
â”œâ”€â”€ health-check
â”œâ”€â”€ helloworld
â”œâ”€â”€ httpbin
â”œâ”€â”€ https
â”œâ”€â”€ kubernetes-blog
â”œâ”€â”€ rawvm
â”œâ”€â”€ sleep
â”œâ”€â”€ tcp-echo
â””â”€â”€ websockets
</code></pre>
<p><a href="https://istio.io/docs/examples/" title="examples">examples</a> ä¸­æœ‰ç®€å•çš„ä»‹ç»ï¼Œå·²ç»æ‹†è§£çš„ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="istio/./bookinfo.html">Bookinfo Application</a></li>
</ul>
<h2 id="å‚è€ƒ-26"><a class="header" href="#å‚è€ƒ-26">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="åœ¨-istio-ä¸­éƒ¨ç½²å›æ˜¾-http-è¯·æ±‚çš„-http-record-æœåŠ¡"><a class="header" href="#åœ¨-istio-ä¸­éƒ¨ç½²å›æ˜¾-http-è¯·æ±‚çš„-http-record-æœåŠ¡">åœ¨ istio ä¸­éƒ¨ç½²å›æ˜¾ http è¯·æ±‚çš„ http-record æœåŠ¡</a></h1>
<p>è¿™æ˜¯æœ¬æ‰‹å†Œè®¾è®¡çš„ä¸€ä¸ªæœåŠ¡ç¤ºä¾‹ï¼Œhttp-record çš„åŠŸèƒ½ç‰¹åˆ«ç®€å•ï¼Œå°†æ”¶åˆ°çš„è¯·æ±‚åŸå°ä¸æ–­å›æ˜¾ï¼ŒåŒæ—¶åœ¨æ ‡å‡†è¾“å‡ºä¸­æ‰“å°ã€‚å®ƒå’Œ echoserver æœåŠ¡çš„åŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ˜¯å¤šäº†åœ¨æ ‡å‡†è¾“å‡ºä¸­æ‰“å°çš„åŠŸèƒ½ï¼Œåœ¨è§‚å¯Ÿæµé‡å¤åˆ¶æ•ˆæœæ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚</p>
<p>http-record å®¹å™¨çš„ç”¨æ³•è§ <a href="istio/../tools/http.html">å¸¸ç”¨å·¥å…·-HTTPåè®®ç›¸å…³</a>ã€‚</p>
<h2 id="ä¸ºç›®æ ‡-namespace-æ‰“ä¸Š-label"><a class="header" href="#ä¸ºç›®æ ‡-namespace-æ‰“ä¸Š-label">ä¸ºç›®æ ‡ namespace æ‰“ä¸Š label</a></h2>
<p>ä»…ä»…åœ¨å®‰è£…äº† istio çš„ kubernetes åˆ›å»ºåº”ç”¨æ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦åœ¨å¸¦æœ‰ <code>istio-injection=enabled</code> æ ‡ç­¾çš„ namespace ä¸­åˆ›å»ºæ‰å¯ä»¥ã€‚</p>
<p>è¿™é‡Œè¦åœ¨ default ä¸­éƒ¨ç½² http-record ï¼Œä¸º default namespace ä¸Šæ‰“æ ‡ç­¾ï¼š</p>
<pre><code class="language-sh">kubectl label namespace default istio-injection=enabled
</code></pre>
<p><a href="istio/./bookinfo.html">Bookinfo Application</a> å¯¹æ­¤æ­¥æ“ä½œæœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚</p>
<h2 id="éƒ¨ç½²-http-record"><a class="header" href="#éƒ¨ç½²-http-record">éƒ¨ç½² http-record</a></h2>
<p>ç”¨ä¸‹é¢çš„ yaml åˆ›å»º http-record çš„ Deployment å’Œ Serviceï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: http-record
  labels:
    app: http-record
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 8080
  selector:
    app: http-record
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: http-record-v1
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: http-record
        version: v1
    spec:
      containers:
      - image: lijiaocn/http-record:0.0.1
        imagePullPolicy: IfNotPresent
        name: http-record
        ports:
        - containerPort: 8080
</code></pre>
<h2 id="é…ç½®-http-record-çš„-istio-ç­–ç•¥"><a class="header" href="#é…ç½®-http-record-çš„-istio-ç­–ç•¥">é…ç½® http-record çš„ istio ç­–ç•¥</a></h2>
<p>ç”¨ä¸‹é¢çš„ yaml åˆ›å»º http-record çš„ istio ç­–ç•¥ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: http-record
spec:
  gateways:
  - http-record-gateway
  hosts:
    - http-record.example
  http:
  - route:
    - destination:
        host: http-record
        subset: v1
      weight: 100
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: http-record
spec:
  host: http-record
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: http-record-gateway
  namespace: default
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
    - 'http-record.example'
    port:
      name: http
      number: 80
      protocol: HTTP
</code></pre>
<h2 id="æ•ˆæœ"><a class="header" href="#æ•ˆæœ">æ•ˆæœ</a></h2>
<p>é€šè¿‡ istio çš„ ingressgateway è®¿é—® http-record æœåŠ¡ï¼ŒåŸŸåä¸º http-record.exampleï¼š</p>
<pre><code class="language-sh">$ curl  -H &quot;Host: http-record.example&quot; 192.168.99.100:31380
{
    &quot;RemoteAddr&quot;: &quot;127.0.0.1:52454&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;http-record.example&quot;,
    &quot;RequestURI&quot;: &quot;/&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;Content-Length&quot;: [
            &quot;0&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.54.0&quot;
        ],
        &quot;X-B3-Parentspanid&quot;: [
            &quot;afc976737b24ece3&quot;
        ],
        &quot;X-B3-Sampled&quot;: [
            &quot;1&quot;
        ],
...çœç•¥...
</code></pre>
<h2 id="å‚è€ƒ-27"><a class="header" href="#å‚è€ƒ-27">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„-bookinfo-application-ç¤ºä¾‹æ‹†è§£"><a class="header" href="#istio-çš„-bookinfo-application-ç¤ºä¾‹æ‹†è§£">istio çš„ Bookinfo Application ç¤ºä¾‹æ‹†è§£</a></h1>
<p>Istio æ–‡æ¡£ä¸­ç»™å‡ºäº†ä¸€ä¸ª <a href="https://istio.io/docs/examples/bookinfo/" title="Bookinfo Application">Bookinfo Application</a> ç¤ºä¾‹ï¼Œè¿™é‡Œæ‹†è§£å®ƒçš„å®ç°ã€‚</p>
<h2 id="bookinfo-app-ç»„æˆ"><a class="header" href="#bookinfo-app-ç»„æˆ">Bookinfo APP ç»„æˆ</a></h2>
<p>Bookinfo APP ç”±å››ä¸ªå­ç³»ç»Ÿç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>productpageï¼Œäº§å“é¡µï¼Œå±•ç¤ºå›¾ä¹¦ä¿¡æ¯ï¼Œä¾èµ– details å’Œ reviews</li>
<li>detailsï¼Œå›¾ä¹¦è¯¦æƒ…æŸ¥è¯¢</li>
<li>reviewsï¼Œç”¨æˆ·è¯„è®ºæŸ¥è¯¢ï¼Œä¾èµ– ratings</li>
<li>ratingsï¼Œå›¾ä¹¦æ’è¡Œæ¦œæŸ¥è¯¢</li>
</ul>
<p>è¿™äº›å­ç³»ç»Ÿåˆ†åˆ«ç”¨ pythonã€rubyã€javaã€node å¼€å‘ï¼Œå…¶ä¸­ reviews ç³»ç»Ÿæœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼šv1ã€v2ã€v3ã€‚</p>
<p><img src="istio/../img/envoy/bookinfo.svg" alt="Bookinfo Application" /></p>
<p>ç¤ºä¾‹ä¸­æŠŠä¸Šè¿°å››ä¸ªç³»ç»Ÿéƒ¨ç½²åœ¨ Kubernetes ä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿç”± Serviceã€ServiceAccountã€Deployment ç»„æˆã€‚reviews æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œå¯¹åº”ä¸‰ä¸ª Deploymentã€‚</p>
<h2 id="éƒ¨ç½²åˆ°-istio-ç½‘æ ¼"><a class="header" href="#éƒ¨ç½²åˆ°-istio-ç½‘æ ¼">éƒ¨ç½²åˆ° istio ç½‘æ ¼</a></h2>
<p>è¦æŠŠ Bookinfo Application éƒ¨ç½²åœ¨ istio ç½‘æ ¼ä¸­ï¼Œä»…ä»…åœ¨å®‰è£…äº† istio çš„ kubernetes åˆ›å»ºåº”ç”¨æ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦åœ¨å¸¦æœ‰ <code>istio-injection=enabled</code> æ ‡ç­¾çš„ namespace ä¸­åˆ›å»ºæ‰å¯ä»¥ã€‚</p>
<p>æ‰€ä»¥ <a href="https://istio.io/docs/examples/bookinfo/" title="Bookinfo Application">æ–‡æ¡£</a> ä¸­çš„ç¬¬ä¸€æ­¥æ“ä½œåœ¨ç›®æ ‡ namespace ä¸Šæ‰“æ ‡ç­¾ï¼š</p>
<pre><code class="language-sh">kubectl label namespace default istio-injection=enabled
</code></pre>
<p>ç„¶ååœ¨æ‰“äº†æ ‡ç­¾çš„ namespace ä¸­åˆ›å»ºåº”ç”¨ï¼š</p>
<pre><code class="language-sh">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre>
<p>å¦‚æœä¸æƒ³ç»™ namesapce æ‰“æ ‡ç­¾ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤è°ƒæ•´ yaml æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)
</code></pre>
<h3 id="éªŒè¯-productpage"><a class="header" href="#éªŒè¯-productpage">éªŒè¯ Productpage</a></h3>
<p>éƒ¨ç½²å®Œæˆåï¼ŒéªŒè¯ productpageï¼Œåœ¨é›†ç¾¤å†…ç”¨å®ƒçš„ cluster ip æˆ–è€… pod ip è®¿é—®ï¼š</p>
<pre><code class="language-sh">$ kubectl get svc productpage -o wide
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE   SELECTOR
productpage   ClusterIP   10.110.29.37     &lt;none&gt;        9080/TCP   76d   app=productpage
</code></pre>
<pre><code class="language-sh">$ curl 10.110.29.37:9080
...çœç•¥...
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>æˆ–è€…åœ¨ Productpage ç­‰å®¹å™¨å†…å®‰è£… curlï¼Œç”¨ curl éªŒè¯ï¼š</p>
<pre><code class="language-sh">$ kubectl exec -it productpage-v1-667bc85676-sgbqp /bin/sh
$ apt-get update
$ apt-get install -y curl
$ curl http://productpage:9080
...çœç•¥...
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Productpage æ˜¯ bookinfo app çš„å…¥å£ï¼Œä½¿ç”¨ python å¼€å‘ï¼Œä»ä»£ç ä¸­æ‰¾åˆ°å¦å¤–å‡ ä¸ªæœåŠ¡çš„æ¥å£ï¼š</p>
<pre><code class="language-sh">$ kubectl exec -it productpage-v1-8554d58bff-wlkg7 cat  productpage.py &gt;/tmp/productpage.py
</code></pre>
<p>æŸ¥çœ‹ä»£ç å¾—çŸ¥å…¶å®ƒå‡ ä¸ªæœåŠ¡çš„ http æ¥å£ï¼Œåé¢å°†ä½¿ç”¨è¿™äº›æ¥å£éªŒè¯æœåŠ¡ï¼š</p>
<pre><code class="language-sh">details:  http://details:9080/details/0
ratings:  http://ratings:9080/ratings/0
reviews:  http://reviews:9080/reviews/0
</code></pre>
<p>Productpage service éƒ¨ç½² yamlï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: productpage
  labels:
    app: productpage
    service: productpage
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: productpage
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-productpage
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productpage-v1
  labels:
    app: productpage
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: productpage
      version: v1
  template:
    metadata:
      labels:
        app: productpage
        version: v1
    spec:
      serviceAccountName: bookinfo-productpage
      containers:
      - name: productpage
        image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
</code></pre>
<h3 id="éªŒè¯-detail"><a class="header" href="#éªŒè¯-detail">éªŒè¯ Detail</a></h3>
<p>å®Œæˆéƒ¨ç½²åï¼ŒéªŒè¯ details æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ kubectl get svc details -o wide
NAME      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE   SELECTOR
details   ClusterIP   10.107.162.106   &lt;none&gt;        9080/TCP   76d   app=details
</code></pre>
<pre><code class="language-sh">$ curl http://10.107.162.106:9080/details/0
{&quot;id&quot;:0,&quot;author&quot;:&quot;William Shakespeare&quot;,&quot;year&quot;:1595,&quot;type&quot;:&quot;paperback&quot;,&quot;pages&quot;:200,&quot;publisher...çœç•¥...
</code></pre>
<p>details æœåŠ¡çš„éƒ¨ç½²æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">##################################################################################
# Details service
###################################################################################
apiVersion: v1
kind: Service
metadata:
  name: details
  labels:
    app: details
    service: details
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: details
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-details
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: details-v1
  labels:
    app: details
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: details
      version: v1
  template:
    metadata:
      labels:
        app: details
        version: v1
    spec:
      serviceAccountName: bookinfo-details
      containers:
      - name: details
        image: docker.io/istio/examples-bookinfo-details-v1:1.15.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
</code></pre>
<h3 id="éªŒè¯-ratings"><a class="header" href="#éªŒè¯-ratings">éªŒè¯ Ratings</a></h3>
<p>å®Œæˆéƒ¨ç½²åï¼ŒéªŒè¯ ratings æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ kubectl get svc ratings -o wide
NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   SELECTOR
ratings   ClusterIP   10.107.67.216   &lt;none&gt;        9080/TCP   76d   app=ratings
</code></pre>
<pre><code class="language-sh">$ curl http://10.107.67.216:9080/ratings/0
{&quot;id&quot;:0,&quot;ratings&quot;:{&quot;Reviewer1&quot;:5,&quot;Reviewer2&quot;:4}}$
</code></pre>
<p>ratings æœåŠ¡çš„éƒ¨ç½²æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">###################################################################################
# Ratings service
##################################################################################
apiVersion: v1
kind: Service
metadata:
  name: ratings
  labels:
    app: ratings
    service: ratings
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: ratings
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-ratings
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ratings-v1
  labels:
    app: ratings
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ratings
      version: v1
  template:
    metadata:
      labels:
        app: ratings
        version: v1
    spec:
      serviceAccountName: bookinfo-ratings
      containers:
      - name: ratings
        image: docker.io/istio/examples-bookinfo-ratings-v1:1.15.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
</code></pre>
<h3 id="éªŒè¯-reviews"><a class="header" href="#éªŒè¯-reviews">éªŒè¯ Reviews</a></h3>
<p>å®Œæˆéƒ¨ç½²åï¼ŒéªŒè¯ reviews æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ kubectl get svc reviews -o wide
NAME      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE   SELECTOR
reviews   ClusterIP   10.100.249.106   &lt;none&gt;        9080/TCP   76d   app=reviews
</code></pre>
<pre><code class="language-sh">$ curl http://10.100.249.106:9080/reviews/0
{&quot;id&quot;: &quot;0&quot;,&quot;reviews&quot;: [{  &quot;reviewer&quot;: &quot;Reviewer1&quot;,  &quot;text&quot;: &quot;An extremely entertaining play by Shakespeare....çœç•¥...
</code></pre>
<p>Reviews æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œå¯¹åº”ä¸‰ä¸ª Deploymentï¼Œéš¶å±äºåŒä¸€ä¸ª Serviceï¼š</p>
<pre><code class="language-yaml">###################################################################################
# Reviews service
###################################################################################
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
</code></pre>
<p>ä¸‰ä¸ªç‰ˆæœ¬çš„ deploymentï¼š</p>
<p>V1ï¼š</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.15.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
</code></pre>
<p>V2:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.15.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
</code></pre>
<p>V3:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.15.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
</code></pre>
<h2 id="åˆ›å»º-gatewayingress-envoy-å¼€å§‹ç›‘å¬"><a class="header" href="#åˆ›å»º-gatewayingress-envoy-å¼€å§‹ç›‘å¬">åˆ›å»º Gatewayï¼Œingress envoy å¼€å§‹ç›‘å¬</a></h2>
<p>åˆ›å»º Gatewayï¼ŒæŒ‡ç¤ºè¾¹ç•Œ envoy ç›‘å¬ 80 ç«¯å£ï¼Œå…è®¸é€šè¿‡ ingress envoy çš„ 80 ç«¯å£è®¿é—® Bookinfoï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
</code></pre>
<p>Gateway å®šä¹‰ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
</code></pre>
<p>å¦‚æœè¿™æ—¶å€™è¿˜æ²¡æœ‰åˆ›å»º VirtualServiceï¼Œingress envoy è¿˜ä¸çŸ¥é“è¦è½¬å‘åˆ°å“ªé‡Œã€‚</p>
<h2 id="åˆ›å»º-virtualserviceè½¬å‘è¯·æ±‚"><a class="header" href="#åˆ›å»º-virtualserviceè½¬å‘è¯·æ±‚">åˆ›å»º VirtualServiceï¼Œè½¬å‘è¯·æ±‚</a></h2>
<p>åˆ›å»º VirtualServiceï¼ŒæŒ‡ç¤º ingress envoy å°†å¤–éƒ¨åˆ°æ¥çš„è¯·æ±‚è½¬å‘åˆ° productpage ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml  
</code></pre>
<p>VirtualService å®šä¹‰ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - &quot;*&quot;
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
</code></pre>
<p>è¿™æ—¶å¯ä»¥é€šè¿‡è¾¹ç•Œ envoy è®¿é—® bookinfoã€‚è¿™é‡Œçš„ hosts é…ç½®æ˜¯ <code>*</code>ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹æˆå…·ä½“çš„åŸŸåã€‚</p>
<h2 id="é€šè¿‡è¾¹ç•Œ-envoy-è®¿é—®åº”ç”¨"><a class="header" href="#é€šè¿‡è¾¹ç•Œ-envoy-è®¿é—®åº”ç”¨">é€šè¿‡è¾¹ç•Œ envoy è®¿é—®åº”ç”¨</a></h2>
<p>è¾¹ç•Œ envoy æ˜¯ istio çš„ç»„ä»¶ä¹‹ä¸€ï¼Œç”±ä¸¤ä¸ªæœåŠ¡ç»„æˆï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system get deployment | grep gateway
istio-egressgateway      1/1     1            1           45h
istio-ingressgateway     1/1     1            1           45h
</code></pre>
<p>ä¸€ä¸ªè´Ÿè´£ä»å¤–éƒ¨æµå…¥ç½‘æ ¼çš„æµé‡ï¼ˆingressï¼‰ï¼Œä¸€ä¸ªè´Ÿè´£ä»ç½‘æ ¼æµå‘å¤–éƒ¨çš„æµé‡ï¼ˆegressï¼‰ã€‚</p>
<p>çº¦å®š istio-ingressgateway å¤„ç†å¤–éƒ¨è¿›å…¥ç½‘æ ¼çš„æµé‡ï¼Œistio-egressgateway å¤„ç†ç½‘æ ¼æµå‘å¤–éƒ¨çš„æµé‡ï¼Œç¦»å¼€ç½‘æ ¼çš„æµé‡çš„å¤„ç†å‚è€ƒ <a href="istio/./egress.html">Engress Control</a>ã€‚</p>
<p>é€šè¿‡ kubernetes æä¾›çš„æ–¹å¼è®¿é—® istio-ingressgatewayï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system get service | grep gateway
istio-egressgateway      ClusterIP      10.111.134.223   &lt;none&gt;     80/TCP,443/TCP,15443/TCP
istio-ingressgateway     LoadBalancer   10.101.187.91    &lt;pending&gt;  15020:31270/TCP,80:31380/TCP,
                                                                    443:31390/TCP,31400:31400/TCP,
                                                                    15029:31248/TCP,15030:30079/TCP,
                                                                    15031:30269/TCP,15032:30249/TCP,
                                                                    15443:31829/TCP
</code></pre>
<p>å¯ä»¥çœ‹åˆ° istio-ingressgateway ä½¿ç”¨ LoadBalancer æ¨¡å¼ï¼Œå®ƒçš„ 80 ç«¯å£å¯¹åº”çš„æ˜ å°„ç«¯å£æ˜¯ 31380ã€‚</p>
<p>å¦‚æœæ˜¯ç”¨ minikube éƒ¨ç½²çš„ kubernetesï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼è·å– istio-ingressgateway çš„è®¿é—®åœ°å€ï¼š</p>
<pre><code class="language-sh">$ minikube service list
|---------------|------------------------|--------------------------------|
|   NAMESPACE   |          NAME          |              URL               |
|---------------|------------------------|--------------------------------|
| istio-system  | istio-ingressgateway   | http://192.168.99.100:31270    |
|               |                        | http://192.168.99.100:31380    |
|               |                        | http://192.168.99.100:31390    |
|               |                        | http://192.168.99.100:31400    |
|               |                        | http://192.168.99.100:31248    |
|               |                        | http://192.168.99.100:30079    |
|               |                        | http://192.168.99.100:30269    |
|               |                        | http://192.168.99.100:30249    |
|               |                        | http://192.168.99.100:31829    |
|---------------|------------------------|--------------------------------|
</code></pre>
<p>è¿™é‡Œä½¿ç”¨äº† minikubeï¼Œç”¨ä¸‹é¢çš„ url è®¿é—® bookinfoï¼Œpath ä¸º <code>productpage</code>ï¼Œä¸ VirtualService ä¸­çš„é…ç½®ä¸€è‡´ï¼š</p>
<pre><code class="language-sh">http://192.168.99.100:31380/productpage
</code></pre>
<p><img src="istio/../img/envoy/bookinfo.png" alt="bookinfoç½‘é¡µ" /></p>
<p>è™½ç„¶å¯ä»¥é€šè¿‡è¾¹ç•Œ envoy è®¿é—®åº”ç”¨ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰è®¾ç½®è½¬å‘ç­–ç•¥ï¼Œå››ä¸ªå­ç³»ç»Ÿä¹‹é—´çš„äº’ç›¸è®¿é—®å’Œé€šè¿‡ kubernetes ä¸­çš„ svc è®¿é—®æ•ˆæœç›¸åŒã€‚</p>
<p>åˆ·æ–°é¡µé¢ä¼šçœ‹åˆ°é¡µé¢åœ¨å˜åŒ–ï¼š</p>
<p><img src="istio/../img/envoy/bookinfo.png" alt="bookinfoç½‘é¡µ" /></p>
<p><img src="istio/../img/envoy/bookinfo2.png" alt="bookinfoç½‘é¡µ" /></p>
<p>è¿™æ˜¯å› ä¸º reviews æœåŠ¡æœ‰ v1ã€v2ã€v3 ä¸‰ä¸ªç‰ˆæœ¬ï¼Œè®¿é—® productpage æ—¶ï¼Œproductpage éšæœºä» reviews çš„ä¸‰ä¸ªç‰ˆæœ¬çš„ pod ä¸­è·å–ç”¨æˆ·è¯„è®ºæ•°æ®ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°ä¸åŒçš„é¡µé¢ã€‚</p>
<p>å¯ä»¥ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ª VirtualService å’Œ Destinationï¼Œç²¾ç»†ç®¡æ§æ¯ä¸ªæœåŠ¡çš„è½¬å‘ç­–ç•¥ã€‚</p>
<h2 id="è®¾ç½®ç½‘æ ¼å†…çš„è½¬å‘ç­–ç•¥destinationrule"><a class="header" href="#è®¾ç½®ç½‘æ ¼å†…çš„è½¬å‘ç­–ç•¥destinationrule">è®¾ç½®ç½‘æ ¼å†…çš„è½¬å‘ç­–ç•¥ï¼šDestinationRule</a></h2>
<p>ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ª DestinationRuleï¼Œè®¾ç½®è½¬å‘ç­–ç•¥ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre>
<p>è¿™é‡Œåœ¨ DestinationRule ä¸­å°† Pod æŒ‰ç…§ Label è¿›è¡Œäº†åˆ†ç»„ï¼Œæ‹†åˆ†æˆå¤šä¸ª subnetï¼š</p>
<p>productpageï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  subsets:
  - name: v1
    labels:
      version: v1
</code></pre>
<p>ratingsï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ratings
spec:
  host: ratings
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v2-mysql
    labels:
      version: v2-mysql
  - name: v2-mysql-vm
    labels:
      version: v2-mysql-vm
</code></pre>
<p>details:</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: details
spec:
  host: details
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
</code></pre>
<p>reviews:</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
</code></pre>
<p>è½¬å‘ç­–ç•¥è¢« VirtualService å¼•ç”¨åæ‰ç”Ÿæ•ˆï¼Œå‚è€ƒ <a href="https://istio.io/docs/tasks/traffic-management/request-routing/" title="Apply a virtual service">Apply a virtual service</a>ï¼Œè¿˜éœ€è¦ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ª VirtualServiceï¼Œåœ¨ VirtualService ä¸­å¼•ç”¨ DestinationRule ä¸­çš„ subsetï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre>
<p>productpage çš„ VirtualServiceï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productpage
spec:
  hosts:
  - productpage
  http:
  - route:
    - destination:
        host: productpage
        subset: v1
</code></pre>
<p>details çš„ VirtualServiceï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: details
spec:
  hosts:
  - details
  http:
  - route:
    - destination:
        host: details
        subset: v1
</code></pre>
<p>ratings çš„ VirtualServiceï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - route:
    - destination:
        host: ratings
        subset: v1
</code></pre>
<p>reviews çš„ VirtualServiceï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
</code></pre>
<p>reviews çš„ VirtualService ç»‘å®šäº† reviews çš„ <code>subset: v1</code>ï¼Œè¿™æ—¶å€™è®¿é—® bookinfoï¼Œé¡µé¢ä¸å†å˜åŒ–ã€‚</p>
<p><img src="istio/../img/envoy/bookinfo3.png" alt="bookinfoç½‘é¡µ" /></p>
<h2 id="æŒ‰ç…§ç”¨æˆ·è½¬å‘"><a class="header" href="#æŒ‰ç…§ç”¨æˆ·è½¬å‘">æŒ‰ç…§ç”¨æˆ·è½¬å‘</a></h2>
<p>æ›´æ–° reviews çš„ VirtualServiceï¼Œå°† jason ç”¨æˆ·çš„è¯·æ±‚è½¬å‘åˆ° v2 ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
</code></pre>
<p>ç‚¹å‡»ç•Œé¢å³ä¸Šè§’çš„ loginï¼Œä»¥ç”¨æˆ· jason çš„èº«ä»½ç™»å½•ï¼ˆå¯†ç ä¸ºç©ºï¼‰ï¼Œç„¶ååˆ·æ–°é¡µé¢ï¼Œä¼šå‘ç°é¡µé¢å˜æˆäº† v2 ç‰ˆæœ¬ï¼š</p>
<p><img src="istio/../img/envoy/bookinfo4.png" alt="bookinfoç½‘é¡µ" /></p>
<p>é€€å‡º jason è´¦å·åï¼Œé¡µé¢åˆå›åˆ°äº† v1 ç‰ˆæœ¬ã€‚</p>
<h2 id="æ›´å¤šæ“ä½œ"><a class="header" href="#æ›´å¤šæ“ä½œ">æ›´å¤šæ“ä½œ</a></h2>
<p><a href="https://istio.io/docs/tasks/traffic-management/request-routing/" title="Traffic Management">Traffic Management</a> ä¸­æœ‰æ›´å¤šç¤ºèŒƒæ“ä½œï¼Œè­¬å¦‚æŒ‰ç…§ user è½¬å‘ã€é”™è¯¯æ³¨å…¥ã€æµé‡æ•´å½¢ã€æ–­è·¯å™¨ã€æµé‡å¤åˆ¶ç­‰ï¼Œè¿™äº›å†…å®¹æ”¾åœ¨åé¢å•ç‹¬æ•´ç†ã€‚</p>
<h2 id="å‚è€ƒ-28"><a class="header" href="#å‚è€ƒ-28">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„è½¬å‘åŠŸèƒ½ä½¿ç”¨æ–¹æ³•"><a class="header" href="#istio-çš„è½¬å‘åŠŸèƒ½ä½¿ç”¨æ–¹æ³•">istio çš„è½¬å‘åŠŸèƒ½ä½¿ç”¨æ–¹æ³•</a></h1>
<p>ç¤ºä¾‹æ‹†è§£ä¸­çš„ <a href="istio/./bookinfo.html">Bookinfo Application</a> åŒ…å«äº†è½¬å‘åŠŸèƒ½ï¼Œè¿™é‡Œç®€å•å¤è¿°ä¸‹ã€‚</p>
<p>è½¬å‘ç­–ç•¥é€šè¿‡ <a href="istio/./vsvc.html">VirtualService</a> è®¾ç½®ï¼Œè®¾ç½® hostnameã€uri å’Œç›®æ ‡æœåŠ¡çš„å¯¹åº”å…³ç³»ï¼Œç›®æ ‡æœåŠ¡å¯ä»¥æ˜¯åŸŸåæˆ– IPï¼Œå¯¹äºåŒä¸€ä¸ª namespace å†…çš„æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨æœåŠ¡åç§°ã€‚</p>
<p>åŒ¹é…æ¡ä»¶ä¸­çš„ hostsï¼Œå¯ä»¥æ˜¯åº”ç”¨çš„å¯¹å¤–åŸŸåï¼Œå®ç°å¯¹å¤–åŸŸååˆ°é›†ç¾¤å†…æœåŠ¡çš„æ˜ å°„ã€‚ä¹Ÿå¯ä»¥æ˜¯ç›®æ ‡æœåŠ¡è‡ªèº«ï¼Œå®ç°æœåŠ¡åˆ°è‡ªèº«çš„æ˜ å°„ã€‚</p>
<p>ä¸‹é¢æ“ä½œåœ¨ <a href="istio/./bookinfo.html">Bookinfo Application</a> çš„åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<h2 id="å¤–éƒ¨åŸŸååˆ°é›†ç¾¤å†…æœåŠ¡çš„æ˜ å°„"><a class="header" href="#å¤–éƒ¨åŸŸååˆ°é›†ç¾¤å†…æœåŠ¡çš„æ˜ å°„">å¤–éƒ¨åŸŸååˆ°é›†ç¾¤å†…æœåŠ¡çš„æ˜ å°„</a></h2>
<p>å¤–éƒ¨åŸŸååˆ°é›†ç¾¤å†…æœåŠ¡çš„æ˜ å°„ï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - &quot;*&quot;
  - &quot;bookinfo.xxx.com&quot;
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
</code></pre>
<h2 id="é›†ç¾¤å†…-service-åˆ°è‡ªèº«çš„æ˜ å°„"><a class="header" href="#é›†ç¾¤å†…-service-åˆ°è‡ªèº«çš„æ˜ å°„">é›†ç¾¤å†… Service åˆ°è‡ªèº«çš„æ˜ å°„</a></h2>
<p>é›†ç¾¤å†… Service åˆ°è‡ªèº«çš„æ˜ å°„ï¼Œä¸‹é¢çš„ hosts å’Œ host çš„å€¼éƒ½æ˜¯ reviewsï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
</code></pre>
<p>è¿™æ ·å¯ä»¥ä¸º reviews è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä¸Šé¢çš„ v1 æ¥è‡ªäº reivews æœåŠ¡çš„ Destinationï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
</code></pre>
<h2 id="virtualservice-æ”¯æŒçš„åŒ¹é…è§„åˆ™"><a class="header" href="#virtualservice-æ”¯æŒçš„åŒ¹é…è§„åˆ™">VirtualService æ”¯æŒçš„åŒ¹é…è§„åˆ™</a></h2>
<p>VirtualService æ”¯æŒä»¥ä¸‹åŒ¹é…è§„åˆ™ï¼š</p>
<ul>
<li><a href="https://istio.io/docs/reference/config/networking/virtual-service/#HTTPMatchRequest" title="HTTPMatchRequest">HTTPMatchRequest</a></li>
<li><a href="https://istio.io/docs/reference/config/networking/virtual-service/#TLSMatchAttributes" title="TLSMatchAttributes">TLSMatchAttributes</a></li>
<li><a href="https://istio.io/docs/reference/config/networking/virtual-service/#L4MatchAttributes" title="L4MatchAttributes">L4MatchAttributes</a></li>
</ul>
<p>è­¬å¦‚åŒ¹é… headersï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
</code></pre>
<h2 id="å‚è€ƒ-29"><a class="header" href="#å‚è€ƒ-29">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„æµé‡åˆ‡æ¢åŠŸèƒ½ç±»ä¼¼äºç°åº¦å‘å¸ƒ"><a class="header" href="#istio-çš„æµé‡åˆ‡æ¢åŠŸèƒ½ç±»ä¼¼äºç°åº¦å‘å¸ƒ">istio çš„æµé‡åˆ‡æ¢åŠŸèƒ½ï¼ˆç±»ä¼¼äºç°åº¦å‘å¸ƒï¼‰</a></h1>
<p>istio å¥½åƒæ²¡æœ‰é‡‘ä¸é›€ä»¥åŠå›½å†…å¸¸è¯´çš„ç°åº¦å‘å¸ƒæ¦‚å¿µï¼Œå®ƒçš„ <a href="https://istio.io/docs/tasks/traffic-management/traffic-shifting/" title="traffic-shifting">Traffic Shifting</a> å¯ä»¥å®ç°åŒæ ·çš„æ•ˆæœï¼Œå®ç°æ€è·¯æ˜¯åœ¨ <a href="istio/./vsvc.html">VirtualService</a> ä¸­é…ç½®å¤šä¸ª destinationï¼Œé€šè¿‡è®¾ç½®æ¯ä¸ª destination çš„æƒé‡ï¼Œå½±å“æµé‡çš„åˆ†é…ã€‚</p>
<p>ä¸‹é¢æ“ä½œåœ¨ <a href="istio/./bookinfo.html">Bookinfo Application</a> çš„åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<h2 id="http-è¯·æ±‚çš„åˆ‡æ¢"><a class="header" href="#http-è¯·æ±‚çš„åˆ‡æ¢">HTTP è¯·æ±‚çš„åˆ‡æ¢</a></h2>
<p>ç¼–è¾‘åä¸º reviews çš„ VirtualServiceï¼Œä¸ºé»˜è®¤çš„ route è®¾ç½®ä¸¤ä¸ª destinationï¼Œæƒé‡éƒ½æ˜¯ 50%ï¼š</p>
<pre><code class="language-yaml">$ kubectl edit vs reviews
....çœç•¥...
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50
    - destination:
        host: reviews
        subset: v3
      weight: 50
</code></pre>
<p>ç„¶åé‡å¤åˆ·æ–°é¡µé¢ï¼Œä¼šå‘ç°é¡µé¢çš„ reviews éƒ¨åˆ†åœ¨ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢ã€‚</p>
<h2 id="tcp-è¯·æ±‚çš„åˆ‡åˆ†"><a class="header" href="#tcp-è¯·æ±‚çš„åˆ‡åˆ†">TCP è¯·æ±‚çš„åˆ‡åˆ†</a></h2>
<p>TCP è¯·æ±‚å¯ä»¥æŒ‰ç…§ destination çš„æƒé‡åˆ†é…ï¼Œè®¾ç½®æ–¹æ³•ç±»ä¼¼ï¼Œè§ <a href="https://istio.io/docs/tasks/traffic-management/tcp-traffic-shifting/" title="TCP Traffic Shifting">TCP Traffic Shifting</a>ã€‚</p>
<h2 id="æ›´å¤šé…ç½®"><a class="header" href="#æ›´å¤šé…ç½®">æ›´å¤šé…ç½®</a></h2>
<ul>
<li><a href="https://istio.io/docs/reference/config/networking/virtual-service/#RouteDestination" title="RouteDestination">RouteDestination</a></li>
</ul>
<h2 id="å‚è€ƒ-30"><a class="header" href="#å‚è€ƒ-30">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-é”™è¯¯æ³¨å…¥åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•"><a class="header" href="#istio-é”™è¯¯æ³¨å…¥åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•">istio é”™è¯¯æ³¨å…¥åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•</a></h1>
<p><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">Fault Injection</a> è®©ç›®æ ‡æœåŠ¡ä»¥ä¸€å®šçš„æ¯”ä¾‹è¿”å›é”™è¯¯ç åè€…å»¶è¿Ÿå›åº”ï¼Œç”¨æ¥æµ‹è¯•ä¸šåŠ¡ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ã€‚</p>
<p>é”™è¯¯æ³¨å…¥åœ¨ <a href="istio/./vsvc.html">VirtualService</a> ä¸­é…ç½®ï¼ŒVirtualService æ”¯æŒçš„æ³¨å…¥ç±»å‹ï¼Œå¯ä»¥åœ¨ <a href="https://istio.io/docs/reference/config/networking/virtual-service/#HTTPFaultInjection" title="HTTPFaultInjection">HTTPFaultInjection</a> ä¸­æ‰¾åˆ°ã€‚ </p>
<p>ä¸‹é¢æ“ä½œåœ¨ <a href="istio/./bookinfo.html">Bookinfo Application</a> çš„åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<h2 id="è¿”å›ä¸€å®šçš„æ¯”ä¾‹çš„é”™è¯¯ç "><a class="header" href="#è¿”å›ä¸€å®šçš„æ¯”ä¾‹çš„é”™è¯¯ç ">è¿”å›ä¸€å®šçš„æ¯”ä¾‹çš„é”™è¯¯ç </a></h2>
<p><a href="https://istio.io/docs/tasks/traffic-management/fault-injection/#injecting-an-http-abort-fault" title="injecting-an-http-abort-fault">injecting-an-http-abort-fault</a> æ¼”ç¤ºå¦‚ä½•è¿”å›ä¸€å®šæ¯”ä¾‹çš„é”™è¯¯ç ã€‚</p>
<p>ç¼–è¾‘å‰é¢åˆ›å»ºçš„åä¸º reviews çš„ VirtualServiceï¼Œåœ¨ http ä¸­æ·»åŠ  fault é…ç½®ï¼š</p>
<pre><code class="language-yaml">$ kubectl edit vs ratings
...çœç•¥...
spec:
  hosts:
  - ratings
  http:
  - route:
    - destination:
        host: ratings
        subset: v1
  # æ·»åŠ çš„ fault æ³¨å…¥ï¼Œä»¥ 100% çš„æ¯”ä¾‹è¿”å› 500 é”™è¯¯ç 
  - fault:
      abort:
        httpStatus: 500
        percentage:
          value: 100
    match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: ratings
        subset: v1
</code></pre>
<p>ä¸Šé¢é…ç½®çš„ fault æ³¨å…¥åªå¯¹ jason ç”¨æˆ·æœ‰æ•ˆï¼ˆfault çš„ match ä¸­é…ç½®çš„åŒ¹é…æ¡ä»¶ï¼Œå¸¦æœ‰ end-user: jason è¯·æ±‚å¤´ï¼‰ã€‚</p>
<p>åœ¨ productpage å®¹å™¨ä¸­ï¼Œç”¨ curl è®¿é—® ratings æœåŠ¡ï¼Œå¸¦æœ‰åŒ¹é…çš„ header æ—¶ï¼Œè¿”å› 500ï¼š</p>
<pre><code class="language-sh">$ apt-get install curl
$ curl -H &quot;end-user: jason&quot; http://ratings:9080/ratings/0
...çœç•¥...
&lt; HTTP/1.1 500 Internal Server Error
&lt; content-length: 18
&lt; content-type: text/plain
&lt; date: Thu, 21 Nov 2019 07:18:51 GMT
&lt; server: envoy
&lt;
* Curl_http_done: called premature == 0
* Connection #0 to host ratings left intact
</code></pre>
<p>Productpage é¡µé¢ä¼šæ˜¾ç¤º Ratings service is currently unavailableï¼š</p>
<p><img src="istio/../img/istio/fault.png" alt="é”™è¯¯æ³¨å…¥åçš„é¡µé¢" /></p>
<p>é€šè¿‡é”™è¯¯æ³¨å…¥ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„éªŒè¯å½“ä¸€ä¸ªå¾®æœåŠ¡å‘ç”Ÿæ•…éšœæ—¶ï¼Œæ•´ä¸ªåº”ç”¨çš„è¿è¡ŒçŠ¶æ€ã€‚</p>
<h2 id="æ³¨å…¥å“åº”å»¶è¿Ÿ"><a class="header" href="#æ³¨å…¥å“åº”å»¶è¿Ÿ">æ³¨å…¥å“åº”å»¶è¿Ÿ</a></h2>
<p>é™¤äº†æ³¨å…¥é”™è¯¯ç ï¼Œè¿˜å¯ä»¥å»¶è¿Ÿå“åº”ï¼Œåˆ¶é€ è¶…æ—¶çš„åœºæ™¯ï¼š<a href="https://istio.io/docs/tasks/traffic-management/fault-injection/#injecting-an-http-delay-fault" title="injecting-an-http-delay-fault">injecting-an-http-delay-fault</a>ã€‚</p>
<h2 id="æ›´å¤šæ³¨å…¥ç±»å‹"><a class="header" href="#æ›´å¤šæ³¨å…¥ç±»å‹">æ›´å¤šæ³¨å…¥ç±»å‹</a></h2>
<ul>
<li><a href="https://istio.io/docs/reference/config/networking/virtual-service/#HTTPFaultInjection" title="HTTPFaultInjection">HTTPFaultInjection</a> </li>
</ul>
<h2 id="å‚è€ƒ-31"><a class="header" href="#å‚è€ƒ-31">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„è¯·æ±‚è¶…æ—¶æ—¶é—´è®¾ç½®"><a class="header" href="#istio-çš„è¯·æ±‚è¶…æ—¶æ—¶é—´è®¾ç½®">istio çš„è¯·æ±‚è¶…æ—¶æ—¶é—´è®¾ç½®</a></h1>
<p>è¿™é‡Œçš„ <a href="https://istio.io/docs/tasks/traffic-management/request-timeouts/" title="Request Timeouts">Request Timeouts</a> æ˜¯ç­‰å¾…ç›®æ ‡æœåŠ¡å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœç›®æ ‡æœåŠ¡çš„å“åº”æ—¶é—´è¶…è¿‡äº†è®¾ç½®ï¼Œä»£ç†æœ¬æ¬¡è¯·æ±‚çš„ envoy ä¸åœ¨ç­‰å¾…ï¼Œç›´æ¥å‘è¯·æ±‚ç«¯è¿”å›å¤±è´¥ã€‚è¶…æ—¶æ—¶é—´åœ¨ <a href="istio/./vsvc.html">VirtualService</a> ä¸­è®¾ç½®ã€‚</p>
<p>ä¸‹é¢æ“ä½œåœ¨ <a href="istio/./bookinfo.html">Bookinfo Application</a> çš„åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<h2 id="è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´"><a class="header" href="#è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´">è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´</a></h2>
<p>ç¼–è¾‘åä¸º reviews çš„ VirtualServiceï¼Œåœ¨ route  ä¸­æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼š</p>
<pre><code class="language-yaml">$ kubectl edit vs reviews
... çœç•¥ ...
- match:
  - headers:
      end-user:
        exact: jason
  route:
  - destination:
      host: reviews
      subset: v2
  timeout: 0.5s
... çœç•¥ ...
</code></pre>
<p>ä¸Šé¢è®¾ç½®çš„è¶…æ—¶æ—¶é—´åªå¯¹å¸¦æœ‰ &quot;end-user: jason&quot; çš„è¯·æ±‚æœ‰æ•ˆã€‚</p>
<p>ä¸ºäº†éªŒè¯è¶…æ—¶æ•ˆæœï¼Œç”¨ <a href="istio/./injection.html">é”™è¯¯æ³¨å…¥</a> åŠŸèƒ½ä¸º reviews æœåŠ¡ä¾èµ–çš„ ratings æœåŠ¡æ³¨å…¥è¶…è¿‡ 2s çš„è¶…æ—¶ï¼š</p>
<pre><code class="language-yaml">$ kubectl edit vs ratings
...çœç•¥...
  http:
  - fault:
      delay:
        percent: 100
        fixedDelay: 2s
    match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: ratings
        subset: v1
  - route:
    - destination:
        host: ratings
        subset: v1
...çœç•¥...
</code></pre>
<p>åªå¯¹å¸¦æœ‰ &quot;end-user: jason&quot; çš„è¯·æ±‚æ³¨å…¥è¶…æ—¶ã€‚æ³¨å…¥è¶…æ—¶åï¼Œratings æ¥å£çš„å“åº”æ—¶é—´è¶…è¿‡ 2 ç§’ï¼š</p>
<pre><code class="language-sh">$ time curl  -H &quot;end-user: jason&quot;  http://ratings:9080/ratings/0
{&quot;id&quot;:0,&quot;ratings&quot;:{&quot;Reviewer1&quot;:5,&quot;Reviewer2&quot;:4}}
real	0m2.043s
user	0m0.008s
sys	0m0.019s
</code></pre>
<p>reviews æœåŠ¡ä¾èµ– ratings æœåŠ¡ï¼Œæ¥å£å“åº”æ—¶é—´ä¼šåŒæ—¶è¢«æ‹‰é•¿ï¼Œç»§è€Œè§¦å‘å‰é¢è®¾ç½®çš„ 0.5s è¶…æ—¶ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;end-user: jason&quot;  http://reviews:9080/reviews/0
upstream request timeout
</code></pre>
<p><img src="istio/../img/istio/timeout.png" alt="è¶…æ—¶é”™è¯¯" /></p>
<h2 id="å‚è€ƒ-32"><a class="header" href="#å‚è€ƒ-32">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„æµé‡ç­–ç•¥è´Ÿè½½å‡è¡¡ç­–ç•¥"><a class="header" href="#istio-çš„æµé‡ç­–ç•¥è´Ÿè½½å‡è¡¡ç­–ç•¥">istio çš„æµé‡ç­–ç•¥ï¼ˆè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼‰</a></h1>
<p>istio çš„æµé‡ç­–ç•¥åœ¨ <a href="istio/./dstrule.html">DestinationRule</a> çš„ <a href="https://istio.io/docs/reference/config/networking/destination-rule/#TrafficPolicy" title="TrafficPolicy">TrafficPolicy</a> ä¸­è®¾ç½®ï¼Œè´Ÿè½½å‡è¡¡æ˜¯æµé‡ç­–ç•¥ä¸­çš„ä¸€ç§ã€‚</p>
<p>ä¸‹é¢æ“ä½œåœ¨ <a href="istio/./bookinfo.html">Bookinfo Application</a> çš„åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<h2 id="æ–­è·¯ä¿æŠ¤"><a class="header" href="#æ–­è·¯ä¿æŠ¤">æ–­è·¯ä¿æŠ¤</a></h2>
<p>istio çš„ <a href="https://istio.io/docs/tasks/traffic-management/circuit-breaking/" title="Circuit Breaking">Circuit Breaking</a> ç›®å‰ï¼ˆ2019-11-21 19:26:57ï¼‰ç›¸å½“å¼±ï¼Œå°±æ˜¯æ§åˆ¶ä¸€ä¸‹è¯·æ±‚æ•°å’Œå¹¶å‘æ•°ï¼Œæ„Ÿè§‰æ²¡æœ‰ <a href="https://www.lijiaocn.com/soft/k8s/ingress-nginx/ratelimit.html">ingress-nginx çš„é™é€ŸåŠŸèƒ½</a> å®ç”¨ã€‚</p>
<h3 id="é™åˆ¶-tcp-è¿æ¥æ•°å’Œå•è¿æ¥è¯·æ±‚æ•°"><a class="header" href="#é™åˆ¶-tcp-è¿æ¥æ•°å’Œå•è¿æ¥è¯·æ±‚æ•°">é™åˆ¶ TCP è¿æ¥æ•°å’Œå•è¿æ¥è¯·æ±‚æ•°</a></h3>
<p>ç¼–è¾‘åä¸º details çš„ DestinationRuleï¼Œæ·»åŠ  trafficPolicyï¼š</p>
<pre><code class="language-sh">$ kubectl edit destinationrules details
...çœç•¥...
  host: details
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1
      tcp:
        maxConnections: 1
...çœç•¥...
</code></pre>
<p>éƒ¨ç½² istio æä¾›çš„ <a href="https://istio.io/docs/tasks/traffic-management/circuit-breaking/#adding-a-client" title="fortio client">fortio client</a>ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/httpbin/sample-client/fortio-deploy.yaml
</code></pre>
<p>4 å¹¶å‘æµ‹è¯•ï¼Œä¼šå‘ç°éƒ¨åˆ†è¯·æ±‚è¢«æ‹’ç»ï¼ˆ503 é”™è¯¯ï¼‰ï¼š</p>
<pre><code class="language-sh">$ FORTIO_POD=$(kubectl get pod | grep fortio | awk '{ print $1 }')
$ kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio --  load   -c 4 -qps 0 -n 20 -loglevel Warning  http://details:9080/details/0
...çœç•¥...
Sockets used: 14 (for perfect keepalive, would be 4)
Code 200 : 8 (40.0 %)
Code 503 : 12 (60.0 %)
Response Header Sizes : count 20 avg 63.45 +/- 77.71 min 0 max 159 sum 1269
Response Body/Total Sizes : count 20 avg 281 +/- 46.03 min 241 max 337 sum 5620
All done 20 calls (plus 0 warmup) 39.719 ms avg, 87.7 qps
</code></pre>
<h2 id="æ›´å¤šé…ç½®-1"><a class="header" href="#æ›´å¤šé…ç½®-1">æ›´å¤šé…ç½®</a></h2>
<ul>
<li><a href="https://istio.io/docs/reference/config/networking/destination-rule/#TrafficPolicy" title="TrafficPolicy">TrafficPolicy</a></li>
</ul>
<h2 id="å‚è€ƒ-33"><a class="header" href="#å‚è€ƒ-33">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„æµé‡å¤åˆ¶åŠŸèƒ½"><a class="header" href="#istio-çš„æµé‡å¤åˆ¶åŠŸèƒ½">istio çš„æµé‡å¤åˆ¶åŠŸèƒ½</a></h1>
<p>istio çš„æµé‡å¤åˆ¶åœ¨ <a href="istio/./vsvc.html">VirtualService</a> ä¸­è®¾ç½®ï¼Œistio 1.4.x å¼€å§‹æ”¯æŒã€‚</p>
<h2 id="åˆ›å»ºæ¥æ”¶å¤åˆ¶æµé‡çš„æœåŠ¡"><a class="header" href="#åˆ›å»ºæ¥æ”¶å¤åˆ¶æµé‡çš„æœåŠ¡">åˆ›å»ºæ¥æ”¶å¤åˆ¶æµé‡çš„æœåŠ¡</a></h2>
<p>æ¥æ”¶æ­£å¸¸è¯·æ±‚çš„æœåŠ¡æ˜¯å‰é¢éƒ¨ç½²çš„ <a href="istio/./httprecord.html">http-record v1</a> ã€‚æˆ‘ä»¬å‡†å¤‡æŠŠè¿™ä¸ªæœåŠ¡çš„æµé‡å¤åˆ¶åŒåçš„ v2 ç‰ˆæœ¬çš„æœåŠ¡ã€‚</p>
<p>ç”¨ä¸‹é¢çš„ yaml æ–‡ä»¶åˆ›å»º http-record v2ï¼Œåªéœ€è¦åˆ›å»º deploymentï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: http-record-v2
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: http-record
        version: v2
    spec:
      containers:
      - image: lijiaocn/http-record:0.0.1
        imagePullPolicy: IfNotPresent
        name: http-record
        ports:
        - containerPort: 8080
</code></pre>
<h2 id="è®¾ç½®é•œåƒå¤åˆ¶ç­–ç•¥"><a class="header" href="#è®¾ç½®é•œåƒå¤åˆ¶ç­–ç•¥">è®¾ç½®é•œåƒå¤åˆ¶ç­–ç•¥</a></h2>
<p>ç¼–è¾‘ä¹‹å‰åˆ›å»ºçš„åä¸º http-record çš„ VirtualServiceï¼Œè®¾ç½®æµé‡å¤åˆ¶ç­–ç•¥ï¼š</p>
<pre><code class="language-yaml">$ kubectl edit vs http-record
  hosts:
  - http-record
  http:
  - mirror:
      host: http-record
      subset: v2
    mirror_percent: 100
    route:
    - destination:
        host: http-record
        subset: v1
      weight: 100
</code></pre>
<p>ä¸Šé¢çš„é…ç½®å°† 100% çš„æµé‡å¤åˆ¶åˆ° v2ã€‚</p>
<h2 id="å¤åˆ¶æ•ˆæœ"><a class="header" href="#å¤åˆ¶æ•ˆæœ">å¤åˆ¶æ•ˆæœ</a></h2>
<p>åœ¨ä»»æ„å®¹å™¨å†…æˆ–è€…é€šè¿‡ ingressgateway è®¿é—® http-recordï¼š</p>
<pre><code class="language-sh">$ curl http-record:8000
</code></pre>
<p>åŒæ—¶æŸ¥çœ‹ v1 å’Œ v2 çš„æ—¥å¿—ï¼š</p>
<pre><code class="language-sh">$ kubectl logs -f http-record-v1-5f9c95b7cf-t9tzx http-record
$ kubectl logs -f http-record-v2-d697c886-lqpsw http-record
</code></pre>
<p>ä¼šå‘ç° http-record-v1 å’Œ http-record-v2 çš„ pod åŒæ—¶æ”¶åˆ°äº†ç›¸åŒçš„è¯·æ±‚ã€‚</p>
<h2 id="ä¼¼ä¹ä¸æ”¯æŒå¤åˆ¶åˆ°å¦ä¸€ä¸ªæœåŠ¡"><a class="header" href="#ä¼¼ä¹ä¸æ”¯æŒå¤åˆ¶åˆ°å¦ä¸€ä¸ªæœåŠ¡">ä¼¼ä¹ä¸æ”¯æŒå¤åˆ¶åˆ°å¦ä¸€ä¸ªæœåŠ¡</a></h2>
<p>å°è¯•å°†åˆ°è¾¾ <a href="istio/./bookinfo.html">Bookinfo Application</a>  çš„ productpage çš„è¯·æ±‚å¤åˆ¶åˆ° http-recordï¼Œç»“æœä¸æˆåŠŸï¼Œä¼¼ä¹ä¸æ”¯æŒè·¨åŸŸåå¤åˆ¶ã€‚</p>
<p>å°è¯•çš„ yaml å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">$ kubectl edit vs productpage
...çœç•¥...
  hosts:
  - productpage
  http:
  - mirror:
      host: http-record
      subset: v1
    mirror_percent: 100
    route:
    - destination:
        host: productpage
        subset: v1
...çœç•¥...
</code></pre>
<p>è®¿é—® productpageï¼š</p>
<pre><code class="language-sh">$ curl productpage:9080
</code></pre>
<p>http-record:v1 æ²¡æœ‰æ”¶åˆ°å¤åˆ¶çš„è¯·æ±‚ï¼Œistio ä¸æ”¯æŒè·¨æœåŠ¡å¤åˆ¶å—ï¼Ÿï¼ˆ2019-11-22 18:16:01ï¼‰ã€‚</p>
<h2 id="å‚è€ƒ-34"><a class="header" href="#å‚è€ƒ-34">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„é“¾è·¯è·Ÿè¸ªè°ƒç”¨é“¾"><a class="header" href="#istio-çš„é“¾è·¯è·Ÿè¸ªè°ƒç”¨é“¾">istio çš„é“¾è·¯è·Ÿè¸ªï¼ˆè°ƒç”¨é“¾ï¼‰</a></h1>
<p>istio è‡ªåŠ¨ä¸º pod å‘å‡ºçš„ http è¯·æ±‚æ·»åŠ è¿½è¸ª headersï¼Œè¦å®ç°å®Œæ•´çš„ <a href="https://istio.io/docs/tasks/observability/distributed-tracing/overview/" title="Distributed Tracing">é“¾è·¯è·Ÿè¸ª</a>ï¼Œæ”¶åˆ°è¯·æ±‚çš„åº”ç”¨ç¨‹åºåœ¨è®¿é—®ä¾èµ–çš„æœåŠ¡æ—¶ï¼Œéœ€è¦æŠŠè¯·æ±‚å¤´ä¸­çš„ headers å¸¦åˆ°ä¸‹ä¸€ä¸ªè¯·æ±‚ä¸­ã€‚</p>
<p>istio æ³¨å…¥çš„ headersï¼š</p>
<pre><code class="language-sh">x-request-id
x-b3-traceid
x-b3-spanid
x-b3-parentspanid
x-b3-sampled
x-b3-flags
x-ot-span-context
</code></pre>
<h2 id="è¿½è¸ª-headers"><a class="header" href="#è¿½è¸ª-headers">è¿½è¸ª headers</a></h2>
<p>istio è‡ªåŠ¨ä¸º pod å‘å‡ºçš„ http è¯·æ±‚æ·»åŠ è¿½è¸ª headersï¼š</p>
<pre><code class="language-sh">$ curl 10.101.26.165:8000
{
    &quot;RemoteAddr&quot;: &quot;127.0.0.1:54854&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;10.101.26.165:8000&quot;,
    &quot;RequestURI&quot;: &quot;/&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;Content-Length&quot;: [
            &quot;0&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.61.1&quot;
        ],
        &quot;X-B3-Sampled&quot;: [
            &quot;1&quot;
        ],
        &quot;X-B3-Spanid&quot;: [
            &quot;cf8b6544e0a1b64c&quot;
        ],
        &quot;X-B3-Traceid&quot;: [
            &quot;3775c9f1d6b7442acf8b6544e0a1b64c&quot;
        ],
        &quot;X-Forwarded-Proto&quot;: [
            &quot;http&quot;
        ],
        &quot;X-Request-Id&quot;: [
            &quot;81360a15-3ac5-9b9c-89ad-4baada513160&quot;
        ]
    },
    &quot;Body&quot;: &quot;&quot;
</code></pre>
<p>æ€æ ·æŠŠè¿™äº› headers å¸¦åˆ°ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œå–å†³äºåº”ç”¨ç¨‹åºçš„å¼€å‘è¯­è¨€ï¼Œä¾‹å¦‚ java å¯ä»¥è¿™æ ·åšï¼š</p>
<pre><code class="language-java">@GET
@Path(&quot;/reviews/{productId}&quot;)
public Response bookReviewsById(@PathParam(&quot;productId&quot;) int productId,
                            @HeaderParam(&quot;end-user&quot;) String user,
                            @HeaderParam(&quot;x-request-id&quot;) String xreq,
                            @HeaderParam(&quot;x-b3-traceid&quot;) String xtraceid,
                            @HeaderParam(&quot;x-b3-spanid&quot;) String xspanid,
                            @HeaderParam(&quot;x-b3-parentspanid&quot;) String xparentspanid,
                            @HeaderParam(&quot;x-b3-sampled&quot;) String xsampled,
                            @HeaderParam(&quot;x-b3-flags&quot;) String xflags,
                            @HeaderParam(&quot;x-ot-span-context&quot;) String xotspan) {

  if (ratings_enabled) {
    JsonObject ratingsResponse = getRatings(Integer.toString(productId), user, xreq, xtraceid, xspanid, xparentspanid, xsampled, xflags, xotspan);
</code></pre>
<h2 id="è®¾ç½®é‡‡æ ·é¢‘ç‡"><a class="header" href="#è®¾ç½®é‡‡æ ·é¢‘ç‡">è®¾ç½®é‡‡æ ·é¢‘ç‡</a></h2>
<p>istio æ”¯æŒè°ƒç”¨é“¾çš„æŠ½æ£€ï¼Œè°ƒç”¨é“¾é‡‡æ ·é¢‘ç‡åœ¨ istio-pilot ä¸­è®¾ç½®ï¼Œé»˜è®¤æ˜¯ 100%ï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system edit deploy istio-pilot
...
        - name: PILOT_TRACE_SAMPLING
          value: &quot;100&quot;
...
</code></pre>
<h2 id="æŸ¥çœ‹è°ƒç”¨é“¾"><a class="header" href="#æŸ¥çœ‹è°ƒç”¨é“¾">æŸ¥çœ‹è°ƒç”¨é“¾</a></h2>
<p>ç”¨ <a href="istio/./command.html">istio æ“ä½œå‘½ä»¤</a>  ä¸­çš„æ–¹æ³•æŸ¥çœ‹ï¼š</p>
<pre><code class="language-sh">$ ./istioctl d jaeger
http://localhost:50887
</code></pre>
<h2 id="å‚è€ƒ-35"><a class="header" href="#å‚è€ƒ-35">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-æœåŠ¡è¿è¡ŒæŒ‡æ ‡çš„é‡‡é›†å’ŒæŸ¥çœ‹"><a class="header" href="#istio-æœåŠ¡è¿è¡ŒæŒ‡æ ‡çš„é‡‡é›†å’ŒæŸ¥çœ‹">istio æœåŠ¡è¿è¡ŒæŒ‡æ ‡çš„é‡‡é›†å’ŒæŸ¥çœ‹</a></h1>
<p>æœåŠ¡çš„è¿è¡ŒæŒ‡æ ‡è¦å…ˆé…ç½®ç„¶åæ‰èƒ½ç”Ÿæˆã€‚é¦–å…ˆåœ¨ istio ä¸­å®šä¹‰ä¸€ä¸ªæŒ‡æ ‡ã€ç„¶åå®šä¹‰æŒ‡æ ‡çš„æ”¶é›†æ–¹å¼ï¼Œæœ€åå®šä¹‰æŒ‡æ ‡çš„æ”¶é›†è§„åˆ™ï¼Œä¹‹åå°±å¯ä»¥åœ¨ istio ä¸­çœ‹åˆ°é‡‡é›†çš„æŒ‡æ ‡ï¼Œå‚è€ƒ <a href="https://istio.io/docs/tasks/observability/metrics/collecting-metrics/" title="Collecting Metrics">Collecting Metrics</a>ã€‚</p>
<p>ä¸‹é¢æ“ä½œåœ¨ <a href="istio/./bookinfo.html">Bookinfo Application</a> çš„åŸºç¡€ä¸Šè¿›è¡Œã€‚</p>
<h2 id="åˆ›å»ºæŒ‡æ ‡å¹¶æ”¶é›†"><a class="header" href="#åˆ›å»ºæŒ‡æ ‡å¹¶æ”¶é›†">åˆ›å»ºæŒ‡æ ‡å¹¶æ”¶é›†</a></h2>
<p>metrics.yaml åŒ…å«äº†æ‰€æœ‰éœ€è¦çš„é…ç½®ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/telemetry/metrics.yaml
instance.config.istio.io/doublerequestcount created
handler.config.istio.io/doublehandler created
rule.config.istio.io/doubleprom created
</code></pre>
<h3 id="æŒ‡æ ‡æ•°æ®ç”Ÿæˆæ–¹æ³•"><a class="header" href="#æŒ‡æ ‡æ•°æ®ç”Ÿæˆæ–¹æ³•">æŒ‡æ ‡æ•°æ®ç”Ÿæˆæ–¹æ³•</a></h3>
<p>å®šä¹‰åä¸º doublerequestcount çš„æŒ‡æ ‡ï¼Œinstance è§„å®šäº†æŒ‡æ ‡çš„ç”Ÿæˆæ–¹æ³•ï¼Œdimensions æ˜¯ç”Ÿæˆçš„æŒ‡æ ‡çš„å±æ€§å’Œå±æ€§å€¼ï¼š</p>
<p>å±æ€§å€¼ä¸­å¯ä»¥å¼•ç”¨ envoy å’Œ mixer ç”Ÿæˆçš„å±æ€§ï¼Œè§ <a href="istio/./concept.html">istioçš„é…ç½®æ¨¡å‹</a>ï¼Œä½¿ç”¨äº†åä¸º metric çš„ templateï¼Œè§ <a href="istio/./concept.html">instance å’Œ template</a>ã€‚</p>
<pre><code class="language-yaml"># Configuration for metric instances
apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: doublerequestcount
  namespace: istio-system
spec:
  compiledTemplate: metric
  params:
    value: &quot;2&quot; # count each request twice
    dimensions:
      reporter: conditional((context.reporter.kind | &quot;inbound&quot;) == &quot;outbound&quot;, &quot;client&quot;, &quot;server&quot;)
      source: source.workload.name | &quot;unknown&quot;
      destination: destination.workload.name | &quot;unknown&quot;
      message: '&quot;twice the fun!&quot;'
    monitored_resource_type: '&quot;UNSPECIFIED&quot;'
</code></pre>
<p>doublerequestcount æœ‰ä¸ªå››ä¸ªå±æ€§ï¼šreporterã€sourceã€destination å’Œ messageã€‚</p>
<p>value æ˜¯æŒ‡æ ‡çš„å€¼ï¼Œè¿™é‡Œå›ºå®šä¸º 2ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¸¦æœ‰å››ä¸ªå±æ€§ã€å€¼ä¸º 2 çš„æŒ‡æ ‡ã€‚</p>
<h3 id="é…ç½®æ¥æ”¶æŒ‡æ ‡æ•°æ®çš„-adpater"><a class="header" href="#é…ç½®æ¥æ”¶æŒ‡æ ‡æ•°æ®çš„-adpater">é…ç½®æ¥æ”¶æŒ‡æ ‡æ•°æ®çš„ adpater</a></h3>
<p>istio æ”¯æŒå¤šç§ adapterï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ prometheusï¼Œé€šè¿‡é…ç½®å‚æ•°æ§åˆ¶å‘ prometheus ä¸­å†™å…¥çš„æ•°æ®ï¼Œè§ <a href="istio/./concept.html">handler å’Œ adapter</a>ã€‚</p>
<pre><code class="language-yaml"># Configuration for a Prometheus handler
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: doublehandler
  namespace: istio-system
spec:
  compiledAdapter: prometheus
  params:
    metrics:
    - name: double_request_count # Prometheus metric name
      instance_name: doublerequestcount.instance.istio-system # Mixer instance name (fully-qualified)
      kind: COUNTER
      label_names:
      - reporter
      - source
      - destination
      - message
</code></pre>
<p>ä¸Šé¢çš„é…ç½®çš„æ„æ€æ˜¯åœ¨ prometheus ä¸­å­˜æ”¾ double_request_count æŒ‡æ ‡ï¼ŒæŠŠæŒ‡æ ‡çš„å››ä¸ªå±æ€§è®¾ç½®ä¸º prometheus ä¸­çš„ labelï¼ŒæŠŠ doublerequestcount æŒ‡æ ‡çš„å€¼ç´¯åŠ ï¼ˆCOUNTER ç±»å‹ï¼‰ã€‚</p>
<p>ç»“åˆå‰é¢çš„æŒ‡æ ‡å®šä¹‰ï¼Œ double_request_count çš„æŒ‡æ ‡å€¼å›ºå®šä½ 2ï¼Œæ¯äº§ç”Ÿä¸€ä¸ªè¯·æ±‚å°±ç´¯åŠ  2ï¼Œæ‰€ä»¥è¿™ä¸ªæŒ‡æ ‡çš„å«ä¹‰å°±æ˜¯â€œè¯·æ±‚å‘ç”Ÿæ¬¡æ•° * 2â€ã€‚</p>
<h3 id="è®¾ç½®-handler-çš„ä½œç”¨èŒƒå›´"><a class="header" href="#è®¾ç½®-handler-çš„ä½œç”¨èŒƒå›´">è®¾ç½® handler çš„ä½œç”¨èŒƒå›´</a></h3>
<p>æœ€åæ˜¯è®¾ç½® handler çš„ä½œç”¨èŒƒå›´ï¼ŒæŒ‡å®š handler çš„è¾“å…¥ï¼š</p>
<pre><code class="language-yaml"># Rule to send metric instances to a Prometheus handler
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: doubleprom
  namespace: istio-system
spec:
  actions:
  - handler: doublehandler
    instances: [ doublerequestcount ]
</code></pre>
<p>ä¸Šé¢é…ç½®çš„æ„æ€æ˜¯ï¼šæŠŠ doublerequestcount æŒ‡æ ‡å­˜æ”¾åˆ° doublehandlerï¼Œå› ä¸ºåªé…ç½®äº† actions æ²¡æœ‰é…ç½® matchï¼Œæ‰€ä»¥è¯¥è§„åˆ™å¯¹æ‰€æœ‰çš„è¯·æ±‚æœ‰æ•ˆã€‚</p>
<h2 id="é‡‡é›†æ•ˆæœ"><a class="header" href="#é‡‡é›†æ•ˆæœ">é‡‡é›†æ•ˆæœ</a></h2>
<p>ç”¨ <a href="istio/./command.html">istioæ“ä½œå‘½ä»¤</a> æä¾›çš„æ–¹æ³•æ‰“å¼€ prometheusï¼š</p>
<pre><code class="language-sh">$ ./istioctl d prometheus
http://localhost:49226
</code></pre>
<p>åˆ·æ–°å‡ æ¬¡ bookinfo ç½‘é¡µåï¼Œå°±èƒ½åœ¨ Prometheus æŸ¥è¯¢å‰é¢åˆ›å»ºçš„æŒ‡æ ‡ï¼Œåç§°ä¸º istio_double_request_countï¼Œistio_ æ˜¯é»˜è®¤å‰ç¼€ï¼š</p>
<p><img src="istio/../img/istio/metirc-result.png" alt="åœ¨ Prometehus ä¸­æŸ¥çœ‹ istio ç›‘æ§æŒ‡æ ‡" /></p>
<h2 id="istio-é»˜è®¤è®¾ç½®çš„æŒ‡æ ‡"><a class="header" href="#istio-é»˜è®¤è®¾ç½®çš„æŒ‡æ ‡">istio é»˜è®¤è®¾ç½®çš„æŒ‡æ ‡</a></h2>
<p>istio å†…ç½®äº†ä¸€äº›æŒ‡æ ‡ï¼ŒæŒ‡æ ‡åç§°å’Œæ ‡ç­¾å«ä¹‰è§ <a href="https://istio.io/docs/reference/config/policy-and-telemetry/metrics/" title="Default Metrics">Default Metrics</a>ã€‚</p>
<p>istio å†…ç½®çš„é»˜è®¤æŒ‡æ ‡ä¹Ÿæ˜¯é€šè¿‡ instanceã€handler å’Œ rule è®¾ç½®çš„ã€‚</p>
<pre><code class="language-sh">$ kubectl -n istio-system get instance
NAME                   AGE
accesslog              7d4h
attributes             7d4h
doublerequestcount     2d4h
keyval                 44h
newlog                 2d
requestcount           7d4h
requestduration        7d4h
requestsize            7d4h
responsesize           7d4h
tcpaccesslog           7d4h
tcpbytereceived        7d4h
tcpbytesent            7d4h
tcpconnectionsclosed   7d4h
tcpconnectionsopened   7d4h
</code></pre>
<pre><code class="language-sh">$ kubectl -n istio-system get handler
NAME            AGE
doublehandler   2d4h
keyval          44h
kubernetesenv   7d4h
newloghandler   2d
prometheus      7d4h
stdio           7d4h
</code></pre>
<pre><code class="language-sh">$ kubectl -n istio-system get rule
NAME                      AGE
doubleprom                2d4h
kubeattrgenrulerule       7d4h
newlogstdio               2d
promhttp                  7d4h
promtcp                   7d4h
promtcpconnectionclosed   7d4h
promtcpconnectionopen     7d4h
stdio                     7d4h
stdiotcp                  7d4h
tcpkubeattrgenrulerule    7d4h
</code></pre>
<h2 id="å‚è€ƒ-36"><a class="header" href="#å‚è€ƒ-36">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„æ—¥å¿—æ”¶é›†æ–¹æ³•"><a class="header" href="#istio-çš„æ—¥å¿—æ”¶é›†æ–¹æ³•">istio çš„æ—¥å¿—æ”¶é›†æ–¹æ³•</a></h1>
<p>istio ä¸ºæ¯ä¸ª pod æ³¨å…¥ envoy å®¹å™¨åï¼Œenvoy èƒ½å¤Ÿè®°å½•æ¯ä¸ª pod çš„è¯·æ±‚ã€‚</p>
<h2 id="åŸå§‹è®¿é—®æ—¥å¿—"><a class="header" href="#åŸå§‹è®¿é—®æ—¥å¿—">åŸå§‹è®¿é—®æ—¥å¿—</a></h2>
<p>æ˜¯å¦è®°å½•è®¿é—®æ—¥å¿—ä»¥åŠè®¿é—®æ—¥å¿—çš„å­˜æ”¾ä½ç½®ï¼Œé€šè¿‡ <a href="https://istio.io/docs/tasks/observability/logs/access-log/" title="access-log">accessLogFile</a> è®¾ç½®ï¼š</p>
<pre><code class="language-yaml"># $ kubectl -n istio-system get configmap  istio  -o yaml |grep accessLogFile
# Set accessLogFile to empty string to disable access log.
accessLogFile: &quot;/dev/stdout&quot;
</code></pre>
<p>é»˜è®¤æ˜¾ç¤ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼æŸ¥çœ‹ï¼š</p>
<pre><code class="language-sh">$ kubectl logs -f productpage-v1-667bc85676-sgbqp -c istio-proxy
[2019-11-27T06:45:55.152Z] &quot;GET /reviews/0 HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot; 0 379 74 74 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36&quot; &quot;105f2059-fbc8-9446-8bbb-b9c1a37019bd&quot; &quot;reviews:9080&quot; &quot;172.17.0.32:9080&quot; outbound|9080|v2|reviews.default.svc.cluster.local - 10.100.249.106:9080 172.17.0.27:40612 - -
[2019-11-27T06:45:55.121Z] &quot;GET /productpage HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot; 0 5286 110 103 &quot;172.17.0.1&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36&quot; &quot;105f2059-fbc8-9446-8bbb-b9c1a37019bd&quot; &quot;192.168.99.100:31380&quot; &quot;127.0.0.1:9080&quot; inbound|9080|http|productpage.default.svc.cluster.local - 172.17.0.27:9080 172.17.0.1:0 - default
...
</code></pre>
<h2 id="ç”Ÿæˆå¹¶æ”¶é›†æ—¥å¿—"><a class="header" href="#ç”Ÿæˆå¹¶æ”¶é›†æ—¥å¿—">ç”Ÿæˆå¹¶æ”¶é›†æ—¥å¿—</a></h2>
<p>istio æ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ï¼Œå¹¶å°†ç»Ÿä¸€æ”¶é›†åˆ°æŒ‡å®šä½ç½®ã€‚è¿™ä¸€æ­¥æ“ä½œå’Œ <a href="istio/./metrics.html">æŒ‡æ ‡é‡‡é›†</a> ç±»ä¼¼ï¼Œé€šè¿‡ instanceã€handler å’Œ route ä¸‰ä¸ª CRD è®¾ç½®ã€‚</p>
<p><a href="https://istio.io/docs/tasks/observability/logs/collecting-logs/" title="Collecting Logs">log-entry.yaml</a> å®šä¹‰äº†æ—¥å¿— newlogï¼Œå¹¶æ”¶é›†åˆ° mixer çš„æ ‡å‡†è¾“å‡ºï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/telemetry/log-entry.yaml
</code></pre>
<p>instance å®šä¹‰çš„æ—¥å¿—æ ¼å¼ï¼Œåç§°ä¸º newlogï¼Œåœ¨ params ä¸­è®¾ç½®äº†çº§åˆ«ã€æ—¶é—´æˆ³ä»¥åŠå±æ€§ç»„æˆï¼š</p>
<pre><code class="language-yaml"># Configuration for logentry instances
apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: newlog
  namespace: istio-system
spec:
  compiledTemplate: logentry
  params:
    severity: '&quot;warning&quot;'
    timestamp: request.time
    variables:
      source: source.labels[&quot;app&quot;] | source.workload.name | &quot;unknown&quot;
      user: source.user | &quot;unknown&quot;
      destination: destination.labels[&quot;app&quot;] | destination.workload.name | &quot;unknown&quot;
      responseCode: response.code | 0
      responseSize: response.size | 0
      latency: response.duration | &quot;0ms&quot;
    monitored_resource_type: '&quot;UNSPECIFIED&quot;'
</code></pre>
<p>handler å®šä¹‰äº†é‡‡é›†å™¨ï¼Œåç§°ä¸º newloghandlerï¼Œç›´æ¥æ‰“å°åˆ° stdioï¼Œè¾“å‡ºæ ¼å¼ä¸º jsonï¼š</p>
<pre><code class="language-yaml"># Configuration for a stdio handler
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: newloghandler
  namespace: istio-system
spec:
  compiledAdapter: stdio
  params:
    severity_levels:
      warning: 1 # Params.Level.WARNING
    outputAsJson: true
</code></pre>
<p>rule å®šä¹‰äº†é‡‡é›†åŠ¨ä½œï¼Œå°† newlog æ—¥å¿—æ”¶é›†åˆ° newloghandlerï¼š</p>
<pre><code class="language-yaml"># Rule to send logentry instances to a stdio handler
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: newlogstdio
  namespace: istio-system
spec:
  match: &quot;true&quot; # match for all requests
  actions:
   - handler: newloghandler
     instances:
     - newlog
</code></pre>
<h2 id="é‡‡é›†æ•ˆæœ-1"><a class="header" href="#é‡‡é›†æ•ˆæœ-1">é‡‡é›†æ•ˆæœ</a></h2>
<p>ä¸Šé¢å®šä¹‰çš„ newlog é‡‡é›†è§„åˆ™ï¼Œå°†æ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œè¿™é‡Œçš„æ ‡å‡†è¾“å‡ºæ˜¯ telemetry çš„æ ‡å‡†è¾“å‡ºï¼š</p>
<pre><code class="language-sh">$ kubectl logs -f -n istio-system -l istio-mixer-type=telemetry -c mixer 
{&quot;level&quot;:&quot;warn&quot;,&quot;time&quot;:&quot;2019-11-27T08:24:05.706343Z&quot;,&quot;instance&quot;:&quot;newlog.instance.istio-system&quot;,&quot;destination&quot;:&quot;productpage&quot;,&quot;latency&quot;:&quot;1.072931146s&quot;,&quot;responseCode&quot;:200,&quot;responseSize&quot;:4183,&quot;source&quot;:&quot;istio-ingressgateway&quot;,&quot;user&quot;:&quot;unknown&quot;}
{&quot;level&quot;:&quot;warn&quot;,&quot;time&quot;:&quot;2019-11-27T08:24:05.188835Z&quot;,&quot;instance&quot;:&quot;newlog.instance.istio-system&quot;,&quot;destination&quot;:&quot;productpage&quot;,&quot;latency&quot;:&quot;1.654626443s&quot;,&quot;responseCode&quot;:200,&quot;responseSize&quot;:4183,&quot;source&quot;:&quot;istio-ingressgateway&quot;,&quot;user&quot;:&quot;unknown&quot;}
</code></pre>
<h2 id="å°†æ—¥å¿—æ”¶é›†åˆ°-es"><a class="header" href="#å°†æ—¥å¿—æ”¶é›†åˆ°-es">å°†æ—¥å¿—æ”¶é›†åˆ° es</a></h2>
<p>handler å¯ä»¥æŒ‡å‘å¤šç§æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼Œä¾‹å¦‚ <a href="https://istio.io/docs/tasks/observability/logs/fluentd/" title="Logging with Fluentd">é€šè¿‡flutentdæ”¶é›†</a>ï¼š</p>
<pre><code class="language-yaml"># Configuration for a Fluentd handler
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: handler
  namespace: istio-system
spec:
  compiledAdapter: fluentd
  params:
    address: &quot;fluentd-es.logging:24224&quot;
</code></pre>
<h2 id="å‚è€ƒ-37"><a class="header" href="#å‚è€ƒ-37">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„è®¿é—®ç­–ç•¥"><a class="header" href="#istio-çš„è®¿é—®ç­–ç•¥">istio çš„è®¿é—®ç­–ç•¥</a></h1>
<p>istio æä¾›äº†é™é€Ÿã€æŒ‰ header è·¯ç”±ç­‰è®¿é—®æ§åˆ¶ç­–ç•¥ã€‚</p>
<h2 id="istio-é»‘ç™½åå•"><a class="header" href="#istio-é»‘ç™½åå•">istio é»‘ç™½åå•</a></h2>
<p>istio åŸºäº mixer è·å–çš„å±æ€§è®¾ç½®é»‘ç™½åå•ï¼Œé»‘ç™½åå•ä¹Ÿæ˜¯é€šè¿‡ instanceã€handler å’Œ rule è®¾ç½®ã€‚</p>
<h3 id="æŒ‰æ ‡ç­¾è®¾ç½®é»‘ç™½åå•"><a class="header" href="#æŒ‰æ ‡ç­¾è®¾ç½®é»‘ç™½åå•">æŒ‰æ ‡ç­¾è®¾ç½®é»‘ç™½åå•</a></h3>
<p>ä¸‹é¢ä¸‰æ¡è§„åˆ™ç¦æ­¢ productpage è®¿é—® http-record v2ï¼š</p>
<pre><code class="language-yaml">apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: handler
metadata:
  name: denyproductpagehandler
spec:
  compiledAdapter: denier
  params:
    status:
      code: 7
      message: Not allowed
---
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: instance
metadata:
  name: denyproductpagerequest
spec:
  compiledTemplate: checknothing
---
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: rule
metadata:
  name: denyproductpage
spec:
  match: destination.labels[&quot;app&quot;] == &quot;http-record&quot; &amp;&amp; destination.labels[&quot;version&quot;] == &quot;v2&quot; &amp;&amp; source.labels[&quot;app&quot;]==&quot;productpage&quot;
  actions:
  - handler: denyproductpagehandler
    instances: [ denyproductpagerequest ]
</code></pre>
<h3 id="æŒ‰æ ‡ç­¾ç¦æ­¢è®¿é—®"><a class="header" href="#æŒ‰æ ‡ç­¾ç¦æ­¢è®¿é—®">æŒ‰æ ‡ç­¾ç¦æ­¢è®¿é—®</a></h3>
<p>http-record v1 å’Œ http-record v2 çš„ ip åœ°å€å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ kubectl get pod --show-labels |grep http-record
http-record-v1-5f9c95b7cf-t9tzx   2/2     Running   0  5d23h   172.17.0.16   app=http-record,pod-template-hash=5f9c95b7cf,security.istio.io/tlsMode=istio,version=v1
http-record-v2-d697c886-lqpsw     2/2     Running   0  5d23h   172.17.0.4    app=http-record,pod-template-hash=d697c886,security.istio.io/tlsMode=istio,version=v2
</code></pre>
<p>åœ¨ productpage ä¸­è®¿é—® http-record v1ï¼š</p>
<pre><code class="language-sh">$ curl 172.17.0.16:8080
{
    &quot;RemoteAddr&quot;: &quot;127.0.0.1:52814&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;172.17.0.16:8080&quot;,
    &quot;RequestURI&quot;: &quot;/&quot;,
    &quot;Header&quot;: {
    ...çœç•¥...
</code></pre>
<p>åœ¨ productpage ä¸­è®¿é—® http-record v2ï¼š</p>
<pre><code class="language-sh">$ curl -v 172.17.0.4:8080
* Rebuilt URL to: 172.17.0.4:8080/
*   Trying 172.17.0.4...
* TCP_NODELAY set
* Connected to 172.17.0.4 (172.17.0.4) port 8080 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 172.17.0.4:8080
&gt; User-Agent: curl/7.52.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 403 Forbidden
&lt; content-length: 60
&lt; content-type: text/plain
&lt; date: Thu, 28 Nov 2019 06:27:39 GMT
&lt; server: envoy
&lt; x-envoy-upstream-service-time: 4
&lt;
* Curl_http_done: called premature == 0
* Connection #0 to host 172.17.0.4 left intact
PERMISSION_DENIED:denyproductpagehandler.default:Not allowed
</code></pre>
<p>é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬åŒæ—¶å¾—çŸ¥ï¼Œistio çš„é»‘ç™½åå•æ˜¯åŸºäº pod çš„ï¼Œç¦æ­¢çš„æ˜¯ pod åˆ° pod çš„è®¿é—®ã€‚</p>
<p>ä¸è¿‡ç½‘ç»œå±‚ä¾æ—§æ˜¯å¯è¾¾çš„ï¼Œç½‘ç»œå±‚ä¸åœ¨ istio çš„ç®¡æ§èŒƒå›´å†…ï¼š</p>
<pre><code class="language-sh">$ ping 172.17.0.4
PING 172.17.0.4 (172.17.0.4) 56(84) bytes of data.
64 bytes from 172.17.0.4: icmp_seq=1 ttl=64 time=0.367 ms
64 bytes from 172.17.0.4: icmp_seq=2 ttl=64 time=0.046 ms
</code></pre>
<h3 id="æŒ‰-ip-è®¾ç½®é»‘ç™½åå•"><a class="header" href="#æŒ‰-ip-è®¾ç½®é»‘ç™½åå•">æŒ‰ IP è®¾ç½®é»‘ç™½åå•</a></h3>
<p>è¿™æ˜¯ä¸€ä¸ª ip ç™½åå•çš„ä¾‹å­ï¼Œåªå…è®¸ç‰¹å®šç½‘æ®µçš„ client é€šè¿‡ ingressgateway è®¿é—®:</p>
<pre><code class="language-sh">$ kubectl apply -f samples/bookinfo/policy/mixer-rule-deny-ip.yaml
</code></pre>
<p>é€šè¿‡ä¸‹é¢ä¸‰é¡¹é…ç½®ï¼Œåªå…è®¸ 10.57.0.0/16 ç½‘æ®µå†…çš„ ingressgateway çš„è®¿é—®ï¼š</p>
<pre><code class="language-sh">apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: whitelistip
spec:
  compiledAdapter: listchecker
  params:
    # providerUrl: ordinarily black and white lists are maintained
    # externally and fetched asynchronously using the providerUrl.
    overrides: [&quot;10.57.0.0/16&quot;]  # overrides provide a static list
    blacklist: false
    entryType: IP_ADDRESSES
---
apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: sourceip
spec:
  compiledTemplate: listentry
  params:
    value: source.ip | ip(&quot;0.0.0.0&quot;)
---
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: checkip
spec:
  match: source.labels[&quot;istio&quot;] == &quot;ingressgateway&quot;
  actions:
  - handler: whitelistip
    instances: [ sourceip ]
</code></pre>
<p>è¿™ä¸ªè§„åˆ™éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œrule é™å®šåªä½œç”¨äº ingressgatewayï¼Œä¼šæ£€æŸ¥ ingressgateway çš„æº IP æ˜¯å¦åœ¨ç™½åå•å†…ï¼Œå¦‚æœä¸åœ¨å°±æ‹’ç»è®¿é—®ã€‚</p>
<p>æˆ‘è¿™é‡Œçš„ ingressgateway çš„ IP æ˜¯ 172.17.0.19ï¼Œä¸åœ¨ç™½åå•å†…ï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system get pod -o wide  |grep ingressgateway
istio-ingressgateway-75d6d5fd99-m2jnf     1/1     Running     1          6d2h   172.17.0.19 
</code></pre>
<p>é€šè¿‡è¯¥ ingressgateway è®¿é—®æœåŠ¡ä¼šè¢«ç¦æ­¢ï¼š</p>
<p><img src="istio/../img/istio/ipdeny.png" alt="è®¿é—®è¢«ç¦æ­¢" /></p>
<p>ç¼–è¾‘ handler whitelistipï¼Œå°† 172.17 ç½‘æ®µåŠ å…¥ç™½åå•åï¼Œå°±å¯ä»¥è®¿é—®äº†ï¼š</p>
<pre><code class="language-sh">$ kubectl edit handler whitelistip
...çœç•¥...
spec:
  compiledAdapter: listchecker
  params:
    blacklist: false
    entryType: IP_ADDRESSES
    overrides:
    - 10.57.0.0/16
    - 172.17.0.0/16
...
</code></pre>
<h2 id="istio-é™é€Ÿç­–ç•¥"><a class="header" href="#istio-é™é€Ÿç­–ç•¥">istio é™é€Ÿç­–ç•¥</a></h2>
<p>istio çš„ <a href="https://istio.io/docs/tasks/policy-enforcement/rate-limiting/" title="Enabling Rate Limits">é™é€ŸåŠŸèƒ½</a> ç”¨èµ·æ¥ç›¸å½“ç¹çï¼Œç”¨åˆ° handlerã€instanceã€QuotaSpecã€QuotaSpecBinding å’Œ rule æ€»å…± 5 ä¸ª CRDã€‚ï¼ˆè¿™ä¹ˆç¹çï¼Œæƒ³åæ§½... 2019-11-27 18:36:29ï¼‰</p>
<pre><code class="language-sh">$ kubectl apply -f  samples/bookinfo/policy/mixer-rule-productpage-ratelimit.yaml
</code></pre>
<p>instance å®šä¹‰äº†åº¦é‡çš„ç»´åº¦ï¼Œåé¢çš„ handler ä¼šä½¿ç”¨è¿™äº›ç»´åº¦å±æ€§ï¼š</p>
<pre><code class="language-yaml">apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: requestcountquota
  namespace: istio-system
spec:
  compiledTemplate: quota
  params:
    dimensions:
      source: request.headers[&quot;x-forwarded-for&quot;] | &quot;unknown&quot;
      destination: destination.labels[&quot;app&quot;] | destination.service.name | &quot;unknown&quot;
      destinationVersion: destination.labels[&quot;version&quot;] | &quot;unknown&quot;
</code></pre>
<p>handler å®šä¹‰äº†åŸºäºå†…å­˜çš„è¯·æ±‚é…é¢ç®¡ç†ç­–ç•¥ï¼ˆmemquotaï¼Œä¼—å¤šé…é¢ç®¡ç†å™¨ä¸­çš„ä¸€ç§ï¼‰ï¼Œè®¾ç½®äº†é™é€Ÿè§„åˆ™ï¼š</p>
<pre><code class="language-yaml">apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: quotahandler
  namespace: istio-system
spec:
  compiledAdapter: memquota
  params:
    quotas:
    - name: requestcountquota.instance.istio-system
      maxAmount: 500
      validDuration: 1s
      # The first matching override is applied.
      # A requestcount instance is checked against override dimensions.
      overrides:
      # The following override applies to 'reviews' regardless
      # of the source.
      - dimensions:
          destination: reviews
        maxAmount: 1
        validDuration: 5s
      # The following override applies to 'productpage' when
      # the source is a specific ip address.
      - dimensions:
          destination: productpage
          source: &quot;10.28.11.20&quot;
        maxAmount: 500
        validDuration: 1s
      # The following override applies to 'productpage' regardless
      # of the source.
      - dimensions:
          destination: productpage
        maxAmount: 2
        validDuration: 5s
</code></pre>
<p>rule è®¾ç½®äº†é™é€Ÿçš„èŒƒå›´ï¼Œå¯¹ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚å¯ç”¨é™é€Ÿï¼š</p>
<pre><code class="language-yaml">apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: quota
  namespace: istio-system
spec:
  # quota only applies if you are not logged in.
  # match: match(request.headers[&quot;cookie&quot;], &quot;user=*&quot;) == false
  actions:
  - handler: quotahandler
    instances:
    - requestcountquota
</code></pre>
<p>QuotaSpec æ˜¯åˆ†é…çš„é™é€Ÿé…é¢ï¼Œå®ƒå°†è¢«ç»‘å®šåˆ°è¦è¢«é™é€Ÿçš„æœåŠ¡ï¼š</p>
<pre><code class="language-yaml">apiVersion: config.istio.io/v1alpha2
kind: QuotaSpec
metadata:
  name: request-count
  namespace: istio-system
spec:
  rules:
  - quotas:
    - charge: 1
      quota: requestcountquota
</code></pre>
<p>QuotaSpecBinding å°†é™é€Ÿé…é¢ä¸ç›®æ ‡æœåŠ¡ç»‘å®šï¼š</p>
<pre><code class="language-yaml">apiVersion: config.istio.io/v1alpha2
kind: QuotaSpecBinding
metadata:
  name: request-count
  namespace: istio-system
spec:
  quotaSpecs:
  - name: request-count
    namespace: istio-system
  services:
  - name: productpage
    namespace: default
    #  - service: '*'  # Uncomment this to bind *all* services to request-count
</code></pre>
<p>è¿™äº›é…ç½®çš„æœ€ç»ˆæ•ˆæœæ˜¯ï¼š</p>
<pre><code class="language-sh">productpage çš„è®¿é—®é¢‘ç‡é™åˆ¶ä¸º 5 ç§’ 2 æ¬¡ï¼Œå¦‚æºå¤´ IP æ˜¯ 10.28.11.20ï¼Œè®¿é—®é™é€Ÿä¸º 500æ¬¡/sã€‚

reviews çš„è®¿é—®é¢‘ç‡é™åˆ¶ä¸º 5 ç§’ 1 æ¬¡ã€‚

å…¶å®ƒæœåŠ¡çš„è®¿é—®é¢‘ç‡é™åˆ¶ä¸º 500 æ¬¡/s
</code></pre>
<h2 id="å‚è€ƒ-38"><a class="header" href="#å‚è€ƒ-38">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="istio-çš„è¯·æ±‚æ”¹å†™åŠŸèƒ½"><a class="header" href="#istio-çš„è¯·æ±‚æ”¹å†™åŠŸèƒ½">istio çš„è¯·æ±‚æ”¹å†™åŠŸèƒ½</a></h1>
<p>istio å¯ä»¥æŒ‰ç…§ç”¨æˆ·çš„å®šä¹‰æ”¹å†™è¯·æ±‚ï¼Œè­¬å¦‚å¢åŠ è¯·æ±‚å¤´ã€æ”¹å†™ uriã€è¯·æ±‚é‡å®šå‘ç­‰ã€‚</p>
<p><a href="https://istio.io/docs/tasks/policy-enforcement/control-headers/" title="Control Headers and Routing">Control Headers and Routing</a> æ¼”ç¤ºäº†æ”¹å†™è¯·æ±‚çš„æ–¹æ³•åŒæ—¶ä¹Ÿæ¼”ç¤ºäº† istio çš„ adpater çš„ç”¨æ³•ã€‚</p>
<h2 id="å¯åŠ¨-adpater"><a class="header" href="#å¯åŠ¨-adpater">å¯åŠ¨ adpater</a></h2>
<p>keyval adpater æ˜¯ä¸€ä¸ª key:value æœåŠ¡ï¼Œè¾“å…¥ key è¿”å› valueï¼Œå¦‚æœ key ä¸å­˜åœ¨è¿”å› NOT_FOUNDã€‚</p>
<p>å¯åŠ¨ keyval å®¹å™¨ï¼š</p>
<pre><code class="language-sh">$ kubectl run keyval --image=gcr.io/istio-testing/keyval:release-1.1 --namespace istio-system --port 9070 --expose
</code></pre>
<p>ç¡®å®š keyval åˆ›å»ºæˆåŠŸï¼š</p>
<pre><code class="language-sh">$ kubectl -n istio-system get pod |grep keyval 
keyval-57f7c4b4cc-t5xw7                   1/1     Running     0          2m51s
</code></pre>
<p>æŠŠ keyval å°è£…æˆ istio çš„ adapterï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f samples/httpbin/policy/keyval-template.yaml
$ kubectl apply -f samples/httpbin/policy/keyval.yaml
</code></pre>
<p>keyval-template.yaml çš„ç±»å‹æ˜¯ templateï¼Œkeyval.yaml çš„ç±»å‹æ˜¯ adapterï¼Œ ç°åœ¨åªèƒ½åˆ¤æ–­è¿™å°±æ˜¯åœ¨ handler ä¸­ä½¿ç”¨çš„ adapterã€‚</p>
<p>adapter çš„è¿è¡Œã€è¡”æ¥æœºåˆ¶ç°åœ¨è¿˜ä¸æ¸…æ¥šï¼ˆ2019-11-27 19:25:30ï¼‰ã€‚adapter æ˜¾ç„¶æ˜¯ istio çš„é‡ç‚¹ç‰¹æ€§ï¼Œistio çš„çµæ´»æ€§å¾ˆå¤§ä¸€éƒ¨åˆ†æ¥è‡ªäº apdaterã€‚</p>
<h2 id="åˆ›å»º-handler"><a class="header" href="#åˆ›å»º-handler">åˆ›å»º handler</a></h2>
<p>handler å¼•ç”¨äº†å‰é¢çš„åˆ›å»ºçš„ adpaterï¼Œå¹¶è®¾ç½®äº† paramsï¼ˆä¸€ä¸ª K-V æŸ¥æ‰¾è¡¨ï¼‰</p>
<pre><code class="language-yaml">$ kubectl apply -f - &lt;&lt;EOF
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  name: keyval
  namespace: istio-system
spec:
  adapter: keyval
  connection:
    address: keyval:9070
  params:
    table:
      jason: admin
EOF
</code></pre>
<h2 id="åˆ›å»º-instance"><a class="header" href="#åˆ›å»º-instance">åˆ›å»º instance</a></h2>
<p>instance å¼•ç”¨äº†å‰é¢åˆ›å»ºçš„ templateï¼š</p>
<pre><code class="language-yaml">$ kubectl apply -f - &lt;&lt;EOF
apiVersion: config.istio.io/v1alpha2
kind: instance
metadata:
  name: keyval
  namespace: istio-system
spec:
  template: keyval
  params:
    key: request.headers[&quot;user&quot;] | &quot;&quot;
EOF
</code></pre>
<p>è¿™ä¸ª instance çš„å«ä¹‰ä½¿ç”¨è¯·æ±‚å¤´ä¸­çš„ user å¤´çš„å€¼ä½œä¸º keyï¼Œä» keyval è·å–ä»·å€¼ã€‚</p>
<p>å‰é¢çš„ adpater ä¸­è®¾ç½®çš„ jason å¯¹åº”çš„åªä¸º adminï¼Œåé¢ä¼šç”¨åˆ°è¿™ä¸ª keyã€‚</p>
<h2 id="åˆ›å»º-rule"><a class="header" href="#åˆ›å»º-rule">åˆ›å»º rule</a></h2>
<p>rule å°†å‰é¢åˆ›å»ºçš„ handler å’Œ instance ç»‘å®šï¼Œè®¾ç½®äº†å¤„ç†åŠ¨ä½œï¼ˆæ³¨å…¥ user-group headerï¼‰ï¼š</p>
<pre><code class="language-yaml">$ kubectl apply -f - &lt;&lt;EOF
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: keyval
  namespace: istio-system
spec:
  actions:
  - handler: keyval.istio-system
    instances: [ keyval ]
    name: x
  requestHeaderOperations:
  - name: user-group
    values: [ x.output.value ]
EOF
</code></pre>
<p>è¿™ä¸ª handler çš„å«ä¹‰æ˜¯è¯»å–å‰é¢åˆ›å»ºçš„ instance çš„å€¼ï¼ˆxï¼‰ï¼Œç„¶ååœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ ä¸€ä¸ª user-group headerï¼Œå­—æ®µå€¼ä¸º instaces çš„å€¼ã€‚</p>
<h2 id="http-å¤´æ”¹å†™æ•ˆæœ"><a class="header" href="#http-å¤´æ”¹å†™æ•ˆæœ">http å¤´æ”¹å†™æ•ˆæœ</a></h2>
<p>å¸¦ä¸Š user:jason è¯·æ±‚å¤´ï¼Œè®¿é—® http-record æœåŠ¡ï¼ˆä¸€ä¸ªå›æ˜¾è¯·æ±‚çš„ http æœåŠ¡ï¼‰ï¼š</p>
<pre><code class="language-yaml">curl  -H &quot;user:jason&quot;   10.101.26.165:8000
{
    &quot;RemoteAddr&quot;: &quot;127.0.0.1:41098&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;10.101.26.165:8000&quot;,
    &quot;RequestURI&quot;: &quot;/&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;Content-Length&quot;: [
            &quot;0&quot;
        ],
        &quot;User&quot;: [
            &quot;jason&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.61.1&quot;
        ],
        &quot;User-Group&quot;: [
            &quot;admin&quot;
        ],
        &quot;X-B3-Sampled&quot;: [
            &quot;1&quot;
        ],
        &quot;X-B3-Spanid&quot;: [
            &quot;51eb9b405f2c1207&quot;
        ],
        &quot;X-B3-Traceid&quot;: [
            &quot;a63afc71120d234051eb9b405f2c1207&quot;
        ],
        &quot;X-Forwarded-Proto&quot;: [
            &quot;http&quot;
        ],
        &quot;X-Request-Id&quot;: [
            &quot;877e616c-7abc-93f4-913d-7dea33b3144e&quot;
        ]
    },
    &quot;Body&quot;: &quot;&quot;
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æ¥æ”¶çš„è¯·æ±‚å¤´ä¸­å¤šäº†ä¸€ä¸ª &quot;User-Groupâ€ã€‚</p>
<h2 id="ä¿®æ”¹-uri"><a class="header" href="#ä¿®æ”¹-uri">ä¿®æ”¹ uri</a></h2>
<p>ä¿®æ”¹ uri çš„æ“ä½œå’Œæ³¨å…¥è¯·æ±‚å¤´ç±»ä¼¼ï¼š</p>
<pre><code class="language-yaml">$ kubectl apply -f - &lt;&lt;EOF
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: keyval
  namespace: istio-system
spec:
  match: source.labels[&quot;istio&quot;] == &quot;ingressgateway&quot;
  actions:
  - handler: keyval.istio-system
    instances: [ keyval ]
  requestHeaderOperations:
  - name: :path
    values: [ '&quot;/status/418&quot;' ]
EOF
</code></pre>
<p>ä¸Šé¢çš„å®šä¹‰ä¸­ä½¿ç”¨äº† matchï¼Œåªå½±å“åˆ° ingressgateway çš„è¯·æ±‚ï¼Œé€šè¿‡ ingressgateway è®¿é—®ï¼Œuri è¢«æ”¹å†™ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;user: jason&quot;  -H &quot;Host: http-record.example&quot; 192.168.99.100:31380
{
    &quot;RemoteAddr&quot;: &quot;127.0.0.1:50684&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;http-record.example&quot;,
    &quot;RequestURI&quot;: &quot;/status/418&quot;,
...çœç•¥...
</code></pre>
<h2 id="å‚è€ƒ-39"><a class="header" href="#å‚è€ƒ-39">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kubernetes-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#kubernetes-ä½¿ç”¨æ‰‹å†Œ">Kubernetes ä½¿ç”¨æ‰‹å†Œ</a></h1>
<p>éƒ¨åˆ†å†…å®¹æ¥è‡ª <a href="https://www.lijiaocn.com/tags/kubernetes.html" title="kuberneteså·¥ä½œç¬”è®°">kubernetes å·¥ä½œç¬”è®°</a>ï¼Œæœ¬æ‰‹å†Œéšç€å·¥ä½œå­¦ä¹ çš„è¿›è¡Œä¸æ–­æ›´æ–°ã€‚</p>
<p>ç”¨åˆ°çš„ yaml æ–‡ä»¶ä½äº <a href="https://github.com/introclass/kubernetes-yamls">kubernetes-yamls</a> ä¸­ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/kubernetes-yamls
</code></pre>
<h2 id="kubernetes-èµ„æ–™"><a class="header" href="#kubernetes-èµ„æ–™">Kubernetes èµ„æ–™</a></h2>
<p>Kubernetes ç¤¾åŒºèµ„æ–™ï¼š<a href="https://github.com/kubernetes/community">Community</a></p>
<p>Kubernetes åšå®¢ï¼š<a href="https://kubernetes.io/blog/">Blog</a></p>
<p>Kubernetes å¼€å‘å°ç»„ï¼š<a href="https://github.com/kubernetes/community/blob/master/sig-list.md">SIGs and Working Groups</a></p>
<p>Kubernetes å¼€å‘è§„èŒƒï¼š<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/README.md">Developer Guide</a></p>
<p>Kubernetes Go ç‰ˆæœ¬ï¼š<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/development.md#go">Go Development Environment</a></p>
<p>Kubernetes çš„æ„å»ºï¼š <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/development.md">Building Kubernetes</a>ï¼Œå¯ä»¥å‚é˜… <a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/05/15/Kubernetes-compile.html">kubernetesçš„ç¼–è¯‘ã€æ‰“åŒ…ã€å‘å¸ƒ</a> </p>
<p>Kubernetes çš„ APIï¼š<a href="https://kubernetes.io/docs/reference/kubernetes-api/api-index/">Kubernetes API</a></p>
<h2 id="å†å²ç¬”è®°"><a class="header" href="#å†å²ç¬”è®°">å†å²ç¬”è®°</a></h2>
<p><a href="https://www.lijiaocn.com/tags/kubernetes.html">Kubernetes ç¬”è®°æ±‡æ€»</a></p>
<h2 id="å‚è€ƒ-40"><a class="header" href="#å‚è€ƒ-40">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="minikube-ä½¿ç”¨æ–¹æ³•æœ€è¯¦ç»†çš„ä¸­æ–‡æ‰‹å†Œ"><a class="header" href="#minikube-ä½¿ç”¨æ–¹æ³•æœ€è¯¦ç»†çš„ä¸­æ–‡æ‰‹å†Œ">Minikube ä½¿ç”¨æ–¹æ³•ï¼ˆæœ€è¯¦ç»†çš„ä¸­æ–‡æ‰‹å†Œï¼‰</a></h1>
<p>ç”¨ <a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/10/03/k8s-class-deploy.html" title="Kubernetes1.12ä»é›¶å¼€å§‹ï¼ˆäºŒï¼‰ï¼šç”¨minikubeéƒ¨ç½²å¼€å‘æµ‹è¯•ç¯å¢ƒ">minikube éƒ¨ç½²å¼€å‘æµ‹è¯•ç¯å¢ƒ</a> ä¸­è®°å½•äº† minikube çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™é‡Œé‡æ–°æ•´ç†ä¸€ä¸‹ã€‚</p>
<p>æ‰‹å†Œç›®å½•åœ¨é¡µé¢å·¦ä¾§ï¼Œå¦‚æœæ˜¯åœ¨æ‰‹æœºç«¯æŸ¥çœ‹ï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ <i class="fa fa-align-justify"></i> ç¬¦å·ã€‚</p>
<h2 id="ä»€ä¹ˆæƒ…å†µä¸‹ä¸ºä»€ä¹ˆç”¨-minikube"><a class="header" href="#ä»€ä¹ˆæƒ…å†µä¸‹ä¸ºä»€ä¹ˆç”¨-minikube">ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œä¸ºä»€ä¹ˆç”¨ Minikubeï¼Ÿ</a></h2>
<p>åš Kubernetes é…å¥—å¼€å‘æ—¶ï¼Œç”¨ minkube å¯åŠ¨ä¸€ä¸ª kubernetes é›†ç¾¤ä½œä¸ºå¼€å‘æµ‹è¯•ç¯å¢ƒæ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚</p>
<p>Minikube å¯ä»¥æ–¹ä¾¿åœ°å¯åŠ¨ä¸åŒç‰ˆæœ¬çš„ kubernetesï¼Œç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œç”¨ minikube éƒ¨ç½²çš„ kubernetes éƒ½æ˜¯å•æœºæ¨¡å¼ï¼Œå¦‚æœè¦åšä¸€äº›é›†ç¾¤ç›¸å…³è°ƒè¯•ï¼Œå•æœºçš„ kubernetes å°±ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ï¼Œéœ€è¦è€ƒè™‘å…¶å®ƒçš„æ–¹æ³•ã€‚</p>
<p>Minikube æ˜¯ kubernetes çš„ä¸€ä¸ªå­é¡¹ç›®ï¼ˆ<a href="https://github.com/kubernetes/minikube" title="github.com/kubernetes/minikube">githubåœ°å€</a>ï¼‰ï¼Œä½¿ç”¨æ‰‹å†Œæ¯”è¾ƒå®Œå–„ï¼ˆ<a href="https://minikube.sigs.k8s.io/docs/start/" title="minikube doc">minikube doc</a>ï¼‰ã€‚</p>
<p>Minikube åœ¨ linuxã€windows å’Œ mac ä¸­éƒ½å¯ä»¥ä½¿ç”¨ï¼Œåœ¨ linux ä¸Šæ”¯æŒ baremetal æ–¹å¼ï¼Œå³å°† kubernetes ç›´æ¥éƒ¨ç½²åœ¨å½“å‰ç³»ç»Ÿä¸Šï¼Œåœ¨ windows å’Œ mac ä¸Šåˆ™æ˜¯åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºä¸­éƒ¨ç½² kubernetesï¼Œè™šæ‹Ÿæœºçš„åˆ›å»ºéƒ½æ˜¯è‡ªåŠ¨çš„ã€‚</p>
<h2 id="å‚è€ƒ-41"><a class="header" href="#å‚è€ƒ-41">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="å®‰è£…-minikube"><a class="header" href="#å®‰è£…-minikube">å®‰è£… Minikube</a></h1>
<p>Minikube çš„å®‰è£…éå¸¸ç®€å•ï¼Œå¯ä»¥ç”¨ yumã€brew ç­‰å·¥å…·å®‰è£…ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä» <a href="https://github.com/kubernetes/minikube/releases" title="kubernetes/minikube/releases">github</a> ä¸Šä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<p><a href="https://github.com/kubernetes/minikube/releases" title="kubernetes/minikube/releases"><img src="minikube/../img/minikube/minikube.png" alt="minikubeä¸‹è½½åœ°å€" /></a></p>
<h2 id="æŸ¥çœ‹å­å‘½ä»¤"><a class="header" href="#æŸ¥çœ‹å­å‘½ä»¤">æŸ¥çœ‹å­å‘½ä»¤</a></h2>
<p>ç”¨ help å‘½ä»¤æŸ¥çœ‹ minkube æ”¯æŒçš„å­å‘½ä»¤ï¼š</p>
<pre><code class="language-sh">$ ./minkube help
Minikube is a CLI tool that provisions and manages single-node Kubernetes clusters optimized for development workflows.

Basic Commands:
  start          Starts a local kubernetes cluster
  status         Gets the status of a local kubernetes cluster
  stop           Stops a running local kubernetes cluster
  delete         Deletes a local kubernetes cluster
  dashboard      Access the kubernetes dashboard running within the minikube cluster

Images Commands:
  docker-env     Sets up docker env variables; similar to '$(docker-machine env)'
  cache          Add or delete an image from the local cache.

Configuration and Management Commands:
  addons         Modify minikube's kubernetes addons
  config         Modify minikube config
 ...ï¼ˆçœç•¥ï¼‰...
</code></pre>
<h2 id="å®‰è£…è™šæ‹ŸåŒ–è½¯ä»¶"><a class="header" href="#å®‰è£…è™šæ‹ŸåŒ–è½¯ä»¶">å®‰è£…è™šæ‹ŸåŒ–è½¯ä»¶</a></h2>
<p>é™¤éåœ¨ Linux ä¸Šä½¿ç”¨ baremetal çš„æ–¹å¼ï¼Œå¦åˆ™éœ€è¦å®‰è£…è™šæ‹ŸåŒ–è½¯ä»¶ï¼Œä½¿ç”¨ virtualboxã€vmware ç­‰æœ€å¸¸ç”¨çš„è™šæ‹ŸæœºåŒ–è½¯ä»¶å³å¯ã€‚Minikube é»˜è®¤è™šæ‹ŸåŒ–è½¯ä»¶ä¸º virtualboxã€‚</p>
<h2 id="å®‰è£…-kubectl"><a class="header" href="#å®‰è£…-kubectl">å®‰è£… kubectl</a></h2>
<p>è¦æ“ä½œéƒ¨ç½²çš„ kubernetesï¼Œæœ¬åœ°è¿˜éœ€è¦æœ‰ kubectl å‘½ä»¤ï¼Œå¯ä»¥åˆ° <a href="https://github.com/kubernetes/kubernetes/releases" title="kubernetes/releases">kubernetes/releases</a> ä¸­ä¸‹è½½ã€‚</p>
<p><a href="https://github.com/kubernetes/kubernetes/releases" title="kubernetes/releases"><img src="minikube/../img/minikube/kuberelease.png" alt="kubernetes release" /></a></p>
<p>ç‚¹å‡» ChangeLog æ–‡ä»¶è¿›å…¥ä¸‹è½½é¡µé¢ï¼š</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.16.md#downloads-for-v1160-beta1" title="CHANGELOG-1.16.md"><img src="minikube/../img/minikube/kubedown.png" alt="kubernetes binary download" /></a></p>
<h2 id="å‚è€ƒ-42"><a class="header" href="#å‚è€ƒ-42">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç”¨-minikube-å¯åŠ¨-kubernetes"><a class="header" href="#ç”¨-minikube-å¯åŠ¨-kubernetes">ç”¨ minikube å¯åŠ¨ kubernetes</a></h1>
<p>Minikube å¯ä»¥éƒ¨ç½²å¤šä¸ªç‰ˆæœ¬çš„ kubernetesï¼Œå¦‚æœä¸æŒ‡å®šç‰ˆæœ¬é»˜è®¤ä½¿ç”¨æœ€æ–°ç‰ˆã€‚</p>
<h2 id="å¯åŠ¨é»˜è®¤ç‰ˆæœ¬çš„-kubernetes"><a class="header" href="#å¯åŠ¨é»˜è®¤ç‰ˆæœ¬çš„-kubernetes">å¯åŠ¨é»˜è®¤ç‰ˆæœ¬çš„ kubernetes</a></h2>
<pre><code class="language-sh">$ minkube start
ğŸ˜„  minikube v1.3.1 on Darwin 10.14
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=2000MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.15.2 on Docker 18.09.8 ...
    â–ª scheduler.leader-elect-resource-lock=configmaps
    â–ª controller-manager.leader-elect-resource-lock=configmaps
ğŸšœ  Pulling images ...
ğŸš€  Launching Kubernetes ...
âŒ›  Waiting for: apiserver proxy

ğŸ’£  Wait failed: waiting for k8s-app=kube-proxy: timed out waiting for the condition

ğŸ˜¿  Sorry that minikube crashed. If this was unexpected, we would love to hear from you:
ğŸ‘‰  https://github.com/kubernetes/minikube/issues/new/choose
</code></pre>
<p>å¦‚æœé‡åˆ° &quot;Wait failed&quot; çš„æƒ…å†µå…ˆåˆ«æ€¥ç€é‡è¯•ï¼Œå³ä½¿é‡åˆ°äº†ä¸Šé¢çš„é”™è¯¯ï¼Œkubernetes ä¹Ÿå¯èƒ½å·²ç»å¯åŠ¨æˆåŠŸäº†ï¼š</p>
<pre><code class="language-sh">$ kubectl get cs
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-0               Healthy   {&quot;health&quot;:&quot;true&quot;}
</code></pre>
<h2 id="å¯åŠ¨æŒ‡å®šç‰ˆæœ¬çš„-kubernetes"><a class="header" href="#å¯åŠ¨æŒ‡å®šç‰ˆæœ¬çš„-kubernetes">å¯åŠ¨æŒ‡å®šç‰ˆæœ¬çš„ kubernetes</a></h2>
<p>--kubernetes-version æŒ‡å®šè¦éƒ¨ç½²çš„ kubernetes ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sh">$ minikube start --kubernetes-version v1.12.0
ğŸ˜„  minikube v1.3.1 on Darwin 10.14
ğŸ’¡  Tip: Use 'minikube start -p &lt;name&gt;' to create a new cluster, or 'minikube delete' to delete this one.
ğŸ”„  Starting existing virtualbox VM for &quot;minikube&quot; ...
</code></pre>
<p>è™šæ‹ŸåŒ–è½¯ä»¶é»˜è®¤ä¸º virtualboxï¼Œå¦‚æœè¦ç”¨å…¶ä»–çš„è™šæ‹ŸæœºåŒ–ï¼Œç”¨ --vm-driver æŒ‡å®šã€‚</p>
<p>æ”¯æŒçš„å‚æ•°åœ¨ minkube help start ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="language-sh">$ ./minkube help start
Starts a local kubernetes cluster

Options:
      --apiserver-ips=[]: A set of apiserver IP Addresses which are used in the generated certificate for kubernetes.
This can be used if you want to make the apiserver available from outside the machine
      --apiserver-name='minikubeCA': The apiserver name which is used in the generated certificate for kubernetes.  This
	  ...çœç•¥...
</code></pre>
<h2 id="å…³é—­-kubernetes"><a class="header" href="#å…³é—­-kubernetes">å…³é—­ kubernetes</a></h2>
<pre><code class="language-sh">$ minikube stop
âœ‹  Stopping &quot;minikube&quot; in virtualbox ...
ğŸ›‘  &quot;minikube&quot; stopped.
</code></pre>
<h2 id="åˆ é™¤"><a class="header" href="#åˆ é™¤">åˆ é™¤</a></h2>
<pre><code class="language-sh">$ minikube delete
</code></pre>
<h2 id="å‚è€ƒ-43"><a class="header" href="#å‚è€ƒ-43">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="è¿›å…¥-minikube-è™šæ‹Ÿæœºä»¥åŠè¿›è¡Œå…¶å®ƒç²¾ç»†æ“ä½œ"><a class="header" href="#è¿›å…¥-minikube-è™šæ‹Ÿæœºä»¥åŠè¿›è¡Œå…¶å®ƒç²¾ç»†æ“ä½œ">è¿›å…¥ minikube è™šæ‹Ÿæœºä»¥åŠè¿›è¡Œå…¶å®ƒç²¾ç»†æ“ä½œ</a></h1>
<p>minkube è‡ªå¸¦äº†ä¸å°‘å­å‘½ä»¤ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ã€ä¿®æ”¹å„ç§ç»†èŠ‚ã€‚</p>
<h2 id="è¿›å…¥-minikube-è™šæ‹Ÿæœº"><a class="header" href="#è¿›å…¥-minikube-è™šæ‹Ÿæœº">è¿›å…¥ minikube è™šæ‹Ÿæœº</a></h2>
<pre><code class="language-sh">./minkube-v1.3.1 ssh
                         _             _
            _         _ ( )           ( )
  ___ ___  (_)  ___  (_)| |/')  _   _ | |_      __
/' _ ` _ `\| |/' _ `\| || , &lt;  ( ) ( )| '_`\  /'__`\
| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/
(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'(_,__/'`\____)

$ pwd
/home/docker
</code></pre>
<h2 id="å‚è€ƒ-44"><a class="header" href="#å‚è€ƒ-44">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="minikube-éƒ¨ç½²æ—¶ä¿®æ”¹-kubernetes-çš„ç»„ä»¶å‚æ•°"><a class="header" href="#minikube-éƒ¨ç½²æ—¶ä¿®æ”¹-kubernetes-çš„ç»„ä»¶å‚æ•°">Minikube éƒ¨ç½²æ—¶ï¼Œä¿®æ”¹ kubernetes çš„ç»„ä»¶å‚æ•°</a></h1>
<p>minikube æ”¯æŒä¿®æ”¹æ¯ä¸ªç»„ä»¶çš„å‚æ•°ï¼Œç”¨ --extra-config ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ ./minkube-v1.3.1 start --extra-config=scheduler.leader-elect-resource-lock=configmaps  --extra-config=controller-manager.leader-elect-resource-lock=configmaps
ğŸ˜„  minikube v1.3.1 on Darwin 10.14
ğŸ’¡  Tip: Use 'minikube start -p &lt;name&gt;' to create a new cluster, or 'minikube delete' to delete this one.
ğŸƒ  Using the running virtualbox &quot;minikube&quot; VM ...
âŒ›  Waiting for the host to be provisioned ...
ğŸ³  Preparing Kubernetes v1.15.2 on Docker 18.09.8 ...
    â–ª scheduler.leader-elect-resource-lock=configmaps
    â–ª controller-manager.leader-elect-resource-lock=configmaps
ğŸ”„  Relaunching Kubernetes using kubeadm ...
âŒ›  Waiting for: apiserver proxy etcd scheduler controller dns
ğŸ„  Done! kubectl is now configured to use &quot;minikube&quot;
</code></pre>
<p>ä¸Šé¢å‚æ•°çš„å«ä¹‰æ˜¯å°† scheduler çš„å‚æ•° LeaderElection.ResourceLock è®¾ç½®ä¸º configmapsã€‚</p>
<p>æ”¯æŒå‚æ•°è®¾ç½®çš„ç»„ä»¶ï¼š<a href="https://godoc.org/k8s.io/kubernetes/pkg/kubelet/apis/config#KubeletConfiguration" title="KubeletConfiguration">kubelet</a>ã€<a href="https://godoc.org/k8s.io/kubernetes/cmd/kube-apiserver/app/options#ServerRunOptions" title="ServerRunOptions">apiserver</a>ã€<a href="https://godoc.org/k8s.io/kubernetes/pkg/proxy/apis/config#KubeProxyConfiguration" title="KubeProxyConfiguration">proxy</a>ã€<a href="https://godoc.org/k8s.io/kubernetes/pkg/controller/apis/config#KubeControllerManagerConfiguration" title="KubeControllerManagerConfiguration">controller-manager</a>ã€<a href="https://godoc.org/github.com/coreos/etcd/etcdserver#ServerConfig" title="ServerConfig">etcd</a>ã€<a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration" title="KubeSchedulerConfiguration">scheduler</a>ã€‚</p>
<h2 id="å‚è€ƒ-45"><a class="header" href="#å‚è€ƒ-45">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="æ“ä½œç”¨-minikube-å¯åŠ¨çš„-kubernetes"><a class="header" href="#æ“ä½œç”¨-minikube-å¯åŠ¨çš„-kubernetes">æ“ä½œç”¨ minikube å¯åŠ¨çš„ kubernetes</a></h1>
<p>Minikube åœ¨å¯åŠ¨ kubernetes æ—¶ä¼šè®¾ç½®  ~/.kube/config æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å¢åŠ äº†è®¿é—®å‡­è¯ï¼š</p>
<pre><code class="language-yaml">...çœç•¥...
users:
- name: minikube
  user:
    client-certificate: /Users/lijiao/.minikube/client.crt
    client-key: /Users/lijiao/.minikube/client.key
...çœç•¥...
</code></pre>
<p>æ‰€ä»¥åœ¨å½“å‰æœºå™¨ä¸Šå¯ä»¥ç”¨ kubectl ç›´æ¥æ“ä½œ kubernetesï¼š</p>
<pre><code class="language-sh">$ kubectl get ns
NAME              STATUS   AGE
kube-node-lease   Active   7d19h
kube-public       Active   7d19h
kube-system       Active   7d19h
</code></pre>
<h2 id="å‚è€ƒ-46"><a class="header" href="#å‚è€ƒ-46">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="è®¿é—®-minikube-å¯åŠ¨çš„-kubernetes-ä¸­çš„æœåŠ¡"><a class="header" href="#è®¿é—®-minikube-å¯åŠ¨çš„-kubernetes-ä¸­çš„æœåŠ¡">è®¿é—® minikube å¯åŠ¨çš„ kubernetes ä¸­çš„æœåŠ¡</a></h1>
<p>Kubernetes åœ¨æœ¬åœ°è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œå¦‚æœè¦è®¿é—®éƒ¨ç½²å…¶ä¸­çš„æœåŠ¡ï¼Œéœ€è¦é€šè¿‡ node portã€‚</p>
<h2 id="é€šè¿‡-node-port-è®¿é—®"><a class="header" href="#é€šè¿‡-node-port-è®¿é—®">é€šè¿‡ node port è®¿é—®</a></h2>
<p>åœ¨ kubernetes ä¸­è®¾ç½®äº†ä½¿ç”¨ node port çš„ service åï¼Œå‘½ä»¤ minikube service list ä¼šåˆ—å‡ºè¿™äº›æœåŠ¡çš„æœ¬åœ°è®¿é—®åœ°å€ï¼š</p>
<pre><code>$ minkube service list
|---------------|-------------------|--------------------------------|
|   NAMESPACE   |       NAME        |              URL               |
|---------------|-------------------|--------------------------------|
| default       | kubernetes        | No node port                   |
| demo-echo     | echo              | http://192.168.99.100:30801    |
|               |                   | http://192.168.99.100:30263    |
| demo-webshell | webshell          | No node port                   |
| demo-webshell | webshell-nodeport | http://192.168.99.100:32635    |
|               |                   | http://192.168.99.100:32454    |
| kube-system   | kube-dns          | No node port                   |
|---------------|-------------------|--------------------------------|
</code></pre>
<h2 id="å‚è€ƒ-47"><a class="header" href="#å‚è€ƒ-47">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="kubernetes-çš„ç”¨æˆ·äº¤äº’-api"><a class="header" href="#kubernetes-çš„ç”¨æˆ·äº¤äº’-api">Kubernetes çš„ç”¨æˆ·äº¤äº’ API</a></h1>
<p>ç”¨æˆ·å¯ä»¥å‘ kubernetes æäº¤å„ç§ç±»å‹çš„ä»»åŠ¡å’Œæ•°æ®ï¼Œæˆ‘ä»¬æŠŠ kubernetes æ¥å—çš„ä»»åŠ¡æˆ–æ•°æ®ç±»å‹ç§°ä¸º APIã€‚ç»è¿‡è¿™å‡ å¹´çš„é£é€Ÿå‘å±•ï¼ŒAPI çš„ç§ç±»éå¸¸ä¸°å¯Œã€‚</p>
<p>æœ€å¸¸è§çš„ APIï¼š<a href="https://kubernetes.io/docs/concepts/" title="concepts">concepts</a>ã€<a href="https://kubernetes.io/docs/tasks/" title="tasks">tasks</a>ã€‚</p>
<p>API å®Œæ•´åˆ—è¡¨ï¼š<a href="https://kubernetes.io/docs/reference/kubernetes-api/api-index/" title="api-index">api-index</a>ã€‚</p>
<p>åœ¨ kubernetes é¡¹ç›®ä¸­ï¼ŒAPI çš„å®šä¹‰ä»£ç ä½äº <a href="https://github.com/kubernetes/kubernetes/tree/v1.16.3/staging/src/k8s.io/api" title="staging/src/k8s.io/api">staging/src/k8s.io/api</a>ï¼Œstaging/src/k8s.io/api å·²ç»ä½œä¸ºç‹¬ç«‹é¡¹ç›®å‘å¸ƒï¼Œé€šè¿‡ <a href="https://github.com/kubernetes/api" title="kubernetes/api">k8s.io/api</a> å¼•ç”¨ã€‚</p>
<h2 id="api-çš„ç‰ˆæœ¬ä¸ä½œç”¨åŸŸ"><a class="header" href="#api-çš„ç‰ˆæœ¬ä¸ä½œç”¨åŸŸ">API çš„ç‰ˆæœ¬ä¸ä½œç”¨åŸŸ</a></h2>
<p>Resource æ˜¯æœ‰ç‰ˆæœ¬çš„ï¼š</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
...
apiVersion: extensions/v1beta1
kind: DaemonSet
</code></pre>
<p>æœ‰ä¸€äº› resource æ˜¯ cluster çº§åˆ«çš„ï¼Œä¸å±äºä»»ä½• namespaceï¼Œå…¨å±€æœ‰æ•ˆï¼Œåé¢çš„ cluster apisã€‚</p>
<h2 id="cluster-apis"><a class="header" href="#cluster-apis">CLUSTER APIS</a></h2>
<pre><code class="language-sh">APIService v1 apiregistration.k8s.io
AuditSink v1alpha1 auditregistration.k8s.io
Binding v1 core
CertificateSigningRequest v1beta1 certificates.k8s.io
ClusterRoleBinding v1 rbac.authorization.k8s.io
ComponentStatus v1 core
Lease v1 coordination.k8s.io
LocalSubjectAccessReview v1 authorization.k8s.io
Namespace v1 core
Node v1 core
PersistentVolume v1 core
ResourceQuota v1 core
Role v1 rbac.authorization.k8s.io
RoleBinding v1 rbac.authorization.k8s.io
RuntimeClass v1beta1 node.k8s.io
SelfSubjectAccessReview v1 authorization.k8s.io
SelfSubjectRulesReview v1 authorization.k8s.io
ServiceAccount v1 core
SubjectAccessReview v1 authorization.k8s.io
TokenRequest v1 authentication.k8s.io
TokenReview v1 authentication.k8s.io
NetworkPolicy v1 networking.k8s.io
</code></pre>
<h2 id="workloads-apis"><a class="header" href="#workloads-apis">WORKLOADS APIS</a></h2>
<pre><code class="language-sh">Container v1 core
CronJob v1beta1 batch
DaemonSet v1 apps
Deployment v1 apps
Job v1 batch
Pod v1 core
ReplicaSet v1 apps
ReplicationController v1 core
StatefulSet v1 apps
</code></pre>
<h2 id="service-apis"><a class="header" href="#service-apis">SERVICE APIS</a></h2>
<pre><code class="language-sh">Endpoints v1 core
EndpointSlice v1alpha1 discovery.k8s.io
Ingress v1beta1 networking.k8s.io
Service v1 core
</code></pre>
<h2 id="config-and-storage-apis"><a class="header" href="#config-and-storage-apis">CONFIG AND STORAGE APIS</a></h2>
<pre><code class="language-sh">ConfigMap v1 core
CSIDriver v1beta1 storage.k8s.io
CSINode v1beta1 storage.k8s.io
Secret v1 core
PersistentVolumeClaim v1 core
StorageClass v1 storage.k8s.io
Volume v1 core
VolumeAttachment v1 storage.k8s.io
</code></pre>
<h2 id="metadata-apis"><a class="header" href="#metadata-apis">METADATA APIS</a></h2>
<pre><code class="language-sh">ControllerRevision v1 apps
CustomResourceDefinition v1 apiextensions.k8s.io
Event v1 core
LimitRange v1 core
HorizontalPodAutoscaler v1 autoscaling
MutatingWebhookConfiguration v1 admissionregistration.k8s.io
ValidatingWebhookConfiguration v1 admissionregistration.k8s.io
PodTemplate v1 core
PodDisruptionBudget v1beta1 policy
PriorityClass v1 scheduling.k8s.io
PodPreset v1alpha1 settings.k8s.io
PodSecurityPolicy v1beta1 policy
</code></pre>
<h2 id="å‚è€ƒ-48"><a class="header" href="#å‚è€ƒ-48">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="kubernetes-æºä»£ç é˜…è¯»æŒ‡å¼•"><a class="header" href="#kubernetes-æºä»£ç é˜…è¯»æŒ‡å¼•">Kubernetes æºä»£ç é˜…è¯»æŒ‡å¼•</a></h1>
<h2 id="ç‹¬ç«‹å‘å¸ƒçš„ä»£ç "><a class="header" href="#ç‹¬ç«‹å‘å¸ƒçš„ä»£ç ">ç‹¬ç«‹å‘å¸ƒçš„ä»£ç </a></h2>
<p>kubernetes/staging/ ä½äº kubernetes é¡¹ç›®ä¸­ï¼Œä½†æ˜¯å…¶ä¸­çš„ä»£ç å‘å¸ƒåˆ°ç‹¬ç«‹çš„ repoï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2019/12/06/k8s-io-usage.html">k8s.io æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2019/12/08/kube-scheduler-code-1-16-3.html">kubernetes è°ƒåº¦ç»„ä»¶ kube-scheduler 1.16.3 æºä»£ç é˜…è¯»æŒ‡å¼•</a></li>
</ul>
<h2 id="api-å®šä¹‰ä»£ç "><a class="header" href="#api-å®šä¹‰ä»£ç ">api å®šä¹‰ä»£ç </a></h2>
<p>api å®šä¹‰ä»£ç ä½äº <a href="https://github.com/kubernetes/kubernetes/tree/v1.16.3/staging/src/k8s.io/api" title="k8s.io/api">kubernetes/staging/src/k8s.io/api</a>ã€‚</p>
<p>éœ€è¦æ³¨æ„ kubernetes ä¸»é¡¹ç›®ä¸­è¿˜æœ‰ä¸‰ä¸ªåä¸º api/apis çš„ç›®å½•ï¼š</p>
<pre><code class="language-sh">kubernetes/api:      ä¸ç¬¦åˆè§„èŒƒã€ä½†æ˜¯è¿˜æ²¡å»å¤„çš„ api åˆ—è¡¨
kuberntes/pkg/api:   ç®€å•çš„æ“ä½œå‡½æ•°
kuberntes/pkg/apis:  deepcopyã€ç‰ˆæœ¬è½¬æ¢ç­‰å·¥å…·ä»£ç 
</code></pre>
<h2 id="å‚è€ƒ-49"><a class="header" href="#å‚è€ƒ-49">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="kubernetes-å¯¼å…¥å¤–éƒ¨æœåŠ¡"><a class="header" href="#kubernetes-å¯¼å…¥å¤–éƒ¨æœåŠ¡">Kubernetes å¯¼å…¥å¤–éƒ¨æœåŠ¡</a></h1>
<p>æœ¬æ–‡ä½¿ç”¨çš„ yaml æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/kubernetes-yamls
cd kubernetes-yamls/ingress-nginx/05-1-external-svc
</code></pre>
<h2 id="å¯åŠ¨ä¸€ä¸ªå¤–éƒ¨æœåŠ¡"><a class="header" href="#å¯åŠ¨ä¸€ä¸ªå¤–éƒ¨æœåŠ¡">å¯åŠ¨ä¸€ä¸ªå¤–éƒ¨æœåŠ¡</a></h2>
<p>å¯åŠ¨ä¸€ä¸ªä½äºé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡ï¼š</p>
<pre><code class="language-sh">./start-github-oauth2-proxy.sh
</code></pre>
<p>è¿™é‡Œçš„æœåŠ¡åœ°å€ä¸º 192.168.99.1:4180ï¼Œå°†è¿™ä¸ªæœåŠ¡å¯¼å…¥åˆ° kubernetes ä¸­ã€‚</p>
<h2 id="å¯¼å…¥åˆ°-kubernetes-ä¸­"><a class="header" href="#å¯¼å…¥åˆ°-kubernetes-ä¸­">å¯¼å…¥åˆ° kubernetes ä¸­</a></h2>
<p>ä¸ºå¤–éƒ¨æœåŠ¡åˆ›å»º Service å’Œä¸€ä¸ªä¸ Service åŒåçš„ endpointï¼Œendpoint ä¸­å¡«å…¥å¤–éƒ¨æœåŠ¡çš„ IPã€‚</p>
<p>åä¸º external-github-oauth-proxy çš„ Serviceï¼š</p>
<pre><code class="language-yaml">kind: Service
apiVersion: v1
metadata:
 name: external-github-oauth-proxy
spec:
 type: ClusterIP
 ports:
 - port: 4180
   targetPort: 4180
</code></pre>
<p>åŒåçš„ endpointï¼š</p>
<pre><code class="language-yaml">kind: Endpoints
apiVersion: v1
metadata:
 name: external-github-oauth-proxy
subsets:
 - addresses:
     - ip: 192.168.99.1
   ports:
     - port: 4180
</code></pre>
<p>åˆ›å»ºï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create -f external-github-oauth2-proxy.yaml
</code></pre>
<h2 id="å¯¼å…¥æ•ˆæœ"><a class="header" href="#å¯¼å…¥æ•ˆæœ">å¯¼å…¥æ•ˆæœ</a></h2>
<p>å¯¼å…¥åå¯ä»¥åƒä½¿ç”¨å…¶å®ƒæœåŠ¡ä¸€æ ·ä½¿ç”¨å¤–éƒ¨æœåŠ¡ï¼Œè­¬å¦‚åœ¨ ingress ä¸­é…ç½®å¤–éƒ¨æœåŠ¡ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: github-oauth2-proxy
spec:
  rules:
  - host: github-oauth2.example
    http:
      paths:
      - backend:
          serviceName: github-oauth2-proxy
          servicePort: 4180
        path: /
</code></pre>
<p>åˆ›å»ºï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create github-oauth-proxy.yaml
</code></pre>
<h2 id="å‚è€ƒ-50"><a class="header" href="#å‚è€ƒ-50">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="kubernetes-çš„-pod-æ“ä½œæŠ€å·§"><a class="header" href="#kubernetes-çš„-pod-æ“ä½œæŠ€å·§">Kubernetes çš„ Pod æ“ä½œæŠ€å·§</a></h1>
<h2 id="pod-çš„ä¿¡æ¯ä»¥ç¯å¢ƒå˜é‡çš„æ–¹å¼æ³¨å…¥å®¹å™¨"><a class="header" href="#pod-çš„ä¿¡æ¯ä»¥ç¯å¢ƒå˜é‡çš„æ–¹å¼æ³¨å…¥å®¹å™¨">Pod çš„ä¿¡æ¯ä»¥ç¯å¢ƒå˜é‡çš„æ–¹å¼æ³¨å…¥å®¹å™¨</a></h2>
<p>å‚è€ƒ <a href="https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/" title="Expose Pod Information to Containers Through Environment Variables">Expose Pod Information to Containers Through Environment Variables</a>ã€‚</p>
<pre><code class="language-yaml">env:
- name: PODIP
  valueFrom:
    fieldRef:
      fieldPath: status.podIP
</code></pre>
<h2 id="åœ¨-pod-å†…ç”¨-servcieaccount-è®¿é—®-apiserver"><a class="header" href="#åœ¨-pod-å†…ç”¨-servcieaccount-è®¿é—®-apiserver">åœ¨ Pod å†…ç”¨ ServcieAccount è®¿é—® APIServer</a></h2>
<pre><code class="language-sh">KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
curl -sSk -H &quot;Authorization: Bearer $KUBE_TOKEN&quot;  https://kubernetes.default.svc/api/v1/nodes/172.29.128.12/proxy/metrics/cadvisor
</code></pre>
<h2 id="å‚è€ƒ-51"><a class="header" href="#å‚è€ƒ-51">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„ä½¿ç”¨æ–¹æ³•"><a class="header" href="#ingress-nginx-çš„ä½¿ç”¨æ–¹æ³•">ingress-nginx çš„ä½¿ç”¨æ–¹æ³•</a></h1>
<p><a href="https://github.com/kubernetes/ingress-nginx" title="ingress-nginx">ingress-nginx</a> æ˜¯ NGINX Ingress Controller for Kubernetesï¼Œå®ƒèƒ½åšçš„äº‹æƒ…è¶Šæ¥è¶Šå¤šï¼Œ<a href="https://kubernetes.github.io/ingress-nginx/examples/" title="NGINX Ingress Controller Examples">NGINX Ingress Controller Examples</a> åˆ—å‡ºäº† ingress-nginx èƒ½åšçš„äº‹æƒ…ã€‚</p>
<p>è·å–åé¢è¦ä½¿ç”¨çš„ yaml æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ git clone https://github.com/introclass/kubernetes-yamls
$ cd kubernetes-yamls/ingress-nginx
$ ls
  01-tls                    05-1-external-svc         08-ratelimit
  02-auth-basic             05-2-auth-oauth-ext       ingress-nginx-0.25.1.yaml
  03-auth-cert              06-rewrite
  04-auth-basic-ext         07-mirror
</code></pre>
<h2 id="è¯•éªŒç¯å¢ƒ"><a class="header" href="#è¯•éªŒç¯å¢ƒ">è¯•éªŒç¯å¢ƒ</a></h2>
<p>Kubernetes æ˜¯ç”¨ minikube éƒ¨ç½²çš„å•æœºç‰ˆï¼Œè§ <a href="k8s/ingress-nginx/../../minikube/index.html">Minikube ä½¿ç”¨æ‰‹å†Œ</a>ï¼Œç‰ˆæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ kubectl version
Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;15&quot;, GitVersion:&quot;v1.15.3&quot;, GitCommit:&quot;2d3c76f9091b6bec110a5e63777c332469e0cba2&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-08-19T12:36:28Z&quot;, GoVersion:&quot;go1.12.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;darwin/amd64&quot;}
Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;15&quot;, GitVersion:&quot;v1.15.2&quot;, GitCommit:&quot;f6278300bebbb750328ac16ee6dd3aa7d3549568&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2019-08-05T09:15:22Z&quot;, GoVersion:&quot;go1.12.5&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}
</code></pre>
<h2 id="å®‰è£…-ingress-nginx"><a class="header" href="#å®‰è£…-ingress-nginx">å®‰è£… ingress-nginx</a></h2>
<p>åˆ›å»º namespaceã€configmapï¼Œè®¾ç½® roleï¼Œéƒ¨ç½² deploymentï¼ˆdeployment ç”¨åˆ°é•œåƒè¦ç¿» Q è·å–ï¼‰ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.25.1/deploy/static/mandatory.yaml
</code></pre>
<p><strong>å¦‚æœä¸èƒ½ç¿»Q</strong>ï¼Œç”¨ä¸‹é¢çš„ yamlï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f https://raw.githubusercontent.com/introclass/kubernetes-yamls/master/ingress-nginx/ingress-nginx-0.25.1.yaml
</code></pre>
<p>ä»¥ nodeport çš„æ–¹å¼æš´éœ² ingress-nginxï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.25.1/deploy/static/provider/baremetal/service-nodeport.yaml
</code></pre>
<p>30933 ç«¯å£æ˜¯ http çš„æ˜ å°„ç«¯å£ï¼Œ30358 æ˜¯ https åè®®çš„æ˜ å°„ç«¯å£ï¼š</p>
<pre><code class="language-sh">$ kubectl -n ingress-nginx get svc
NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx   NodePort   10.106.78.115   &lt;none&gt;        80:30933/TCP,443:30358/TCP   5d4h
</code></pre>
<h2 id="éƒ¨ç½²ç›®æ ‡æœåŠ¡"><a class="header" href="#éƒ¨ç½²ç›®æ ‡æœåŠ¡">éƒ¨ç½²ç›®æ ‡æœåŠ¡</a></h2>
<p>éƒ¨ç½²ç›®æ ‡æœåŠ¡ echoï¼Œecho æœåŠ¡çš„ç”¨é€”è§ <a href="k8s/ingress-nginx/../../envoy/echoserver.html">ç”¨ echoserver è§‚å¯Ÿä»£ç†/è½¬å‘æ•ˆæœ</a>ï¼Œé€šè¿‡ ingress-nginx è®¿é—®è¯¥ç›®æ ‡æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ kubectl apply -f https://raw.githubusercontent.com/introclass/kubernetes-yamls/master/all-in-one/echo-all-in-one.yaml
</code></pre>
<p>åœ¨åä¸º demo-echo çš„ namespace ä¸­åˆ›å»ºäº† echo æœåŠ¡ï¼Œä»¥ nodeport æ–¹å¼æš´éœ² echo æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo get svc -o wide
NAME   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                     AGE   SELECTOR
echo   NodePort   10.111.29.87   &lt;none&gt;        80:30411/TCP,22:31867/TCP   42d   app=echo
</code></pre>
<p>åŒæ—¶é€šè¿‡ ingress æš´éœ² echo æœåŠ¡ï¼ˆç”¨äºå’Œ ingress ä»£ç†è¿”å›çš„ç»“æœå¯¹æ¯”ï¼‰ï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo get ingress
NAME                HOSTS                     ADDRESS   PORTS   AGE
ingress-echo        echo.example                        80      42d
</code></pre>
<h2 id="éªŒè¯ç¯å¢ƒ"><a class="header" href="#éªŒè¯ç¯å¢ƒ">éªŒè¯ç¯å¢ƒ</a></h2>
<p>é€šè¿‡ nodeport è®¿é—® echo æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ curl  http://192.168.99.100:30411

Hostname: echo-597d89dcd9-4dp6f

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008
...
</code></pre>
<p>é€šè¿‡ ingress-nginx è®¿é—® echo æœåŠ¡ï¼š</p>
<pre><code class="language-sh">$ curl http://192.168.99.100:30933 -H &quot;Host: echo.example&quot;

Hostname: echo-597d89dcd9-4dp6f

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008

Request Information:
	client_address=172.17.0.18
	method=GET
	real path=/
	query=
	request_version=1.1
	request_uri=http://echo.example:8080/
...
</code></pre>
<h2 id="å‚è€ƒ-52"><a class="header" href="#å‚è€ƒ-52">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/" title="NGINX Ingress Controller Examples">NGINX Ingress Controller Examples</a></li>
<li><a href="https://github.com/kubernetes/ingress-nginx" title="ingress-nginx">ingress-nginx</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-è®¾ç½®-https-è¯ä¹¦"><a class="header" href="#ingress-nginx-è®¾ç½®-https-è¯ä¹¦">ingress-nginx è®¾ç½® https è¯ä¹¦</a></h1>
<p>ingress-nginx è®¾ç½® https è¯ä¹¦çš„æ–¹å¼ç‰¹åˆ«ç®€å•ï¼Œå°†ç›®æ ‡æœåŠ¡çš„ tls è¯ä¹¦ä»¥ secret çš„æ–¹å¼å­˜æ”¾åˆ° kubernetes  åï¼Œåœ¨å¯¹åº”çš„ ingress çš„ tls è®¾ç½®ä¸­å¼•ç”¨è¯ä¹¦å³å¯ã€‚</p>
<pre><code class="language-sh">$ cd 01-tls
</code></pre>
<h2 id="å‡†å¤‡è¯ä¹¦"><a class="header" href="#å‡†å¤‡è¯ä¹¦">å‡†å¤‡è¯ä¹¦</a></h2>
<p>ç›®æ ‡æœåŠ¡çš„æ­£å¼è¯ä¹¦è¦é€šè¿‡ CA æœºæ„ç­¾ç½²ï¼Œè¯•éªŒè¯¥åŠŸèƒ½æ—¶å¯ä»¥å…ˆç”¨è‡ªç­¾ç½²çš„è¯ä¹¦ï¼š</p>
<pre><code class="language-sh">echo &quot;ç”Ÿæˆè‡ªç­¾ç½²çš„ ca è¯ä¹¦&quot;
openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days 3560 -nodes -subj '/CN=My Cert Authority'

echo &quot;ç”Ÿæˆç”¨ä¸Šè¿° ca ç­¾ç½²çš„ server è¯ä¹¦&quot;
openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj '/CN=tls.echo.example'
openssl x509 -req -sha256 -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt
</code></pre>
<p>ä¸Šé¢çš„ CN= æ˜¯ç›®æ ‡æœåŠ¡è¦ä½¿ç”¨çš„åŸŸåã€‚</p>
<p>ç”Ÿæˆè¯ä¹¦ï¼š</p>
<pre><code class="language-sh">./01-create-cert.sh
</code></pre>
<p>å°† server è¯ä¹¦ä¸Šä¼ åˆ° kubernetesï¼Œï¼ˆå¦‚æœåªæ˜¯å¯ç”¨ tls åŠ å¯†ï¼Œ ca è¯ä¹¦ä¸éœ€è¦ä¸Šä¼ ï¼‰ï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create secret generic tls-echo-exmaple-secret --from-file=tls.crt=server.crt --from-file=tls.key=server.key
</code></pre>
<h2 id="é…ç½®-ingress"><a class="header" href="#é…ç½®-ingress">é…ç½® ingress</a></h2>
<p>ignress ä¸­çš„ host ä¸€å®šè¦ä¸è¯ä¹¦çš„ CN ç›¸åŒï¼Œåœ¨ tls é…ç½®ä¸­å¼•ç”¨å‰é¢åˆ›å»ºçš„ secretï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-tls
spec:
  rules:
  - host: tls.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
  tls:
  - hosts:
    - tls.echo.example
    secretName: tls-echo-exmaple-secret
</code></pre>
<p>åˆ›å»ºï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create -f tls-echo-example-ingress.yaml
</code></pre>
<h2 id="æ•ˆæœ-1"><a class="header" href="#æ•ˆæœ-1">æ•ˆæœ</a></h2>
<p>è¿™é‡Œçš„ ingress-nginx çš„ IP åœ°å€æ˜¯ 192.168.99.100ï¼Œhttps ç«¯å£æ˜¯ 30358ï¼Œåœ¨æœ¬åœ°é…ç½® hosts åè®¿é—®ï¼š</p>
<pre><code class="language-sh"># /etc/hosts
192.168.99.100 tls.echo.example
</code></pre>
<p>å› ä¸ºæ˜¯è‡ªç­¾ç½²çš„è¯ä¹¦ï¼Œæµè§ˆå™¨ä¼šæç¤ºè¯ä¹¦ä¸å¯ä¿¡ï¼Œä½¿ç”¨ CA æœºæ„ç­¾ç½²è¯ä¹¦ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼š</p>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/tls-1.png" alt="è®¿é—®ç”¨tlsåŠ å¯†çš„ ingress-nginx æœåŠ¡" /></p>
<h2 id="æ”¯æŒå¤šä¸ªåŸŸå"><a class="header" href="#æ”¯æŒå¤šä¸ªåŸŸå">æ”¯æŒå¤šä¸ªåŸŸå</a></h2>
<p>å¯ä»¥åœ¨ä¸€ä¸ª ingress ä¸­ä¸ºå¤šä¸ªåŸŸåè®¾ç½® tls åŠ å¯†ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: foo-tls
  namespace: default
spec:
  tls:
  - hosts:
    - foo.bar.com
    # This secret must exist beforehand
    # The cert must also contain the subj-name foo.bar.com
    # https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#tls-certificates
    secretName: foobar
  - hosts:
    - bar.baz.com
    # This secret must exist beforehand
    # The cert must also contain the subj-name bar.baz.com
    # https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#tls-certificates
    secretName: barbaz
  rules:
  - host: foo.bar.com
    http:
      paths:
      - backend:
          serviceName: http-svc
          servicePort: 80
        path: /
  - host: bar.baz.com
    http:
      paths:
      - backend:
          serviceName: nginx
          servicePort: 80
        path: /
</code></pre>
<h2 id="å‚è€ƒ-53"><a class="header" href="#å‚è€ƒ-53">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/" title="tls">ingress-nginx tls</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/tls-termination/" title="TLS termination">TLS termination</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„è®¤è¯åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹"><a class="header" href="#ingress-nginx-çš„è®¤è¯åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹">ingress-nginx çš„è®¤è¯åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹</a></h1>
<h2 id="basic-authentication-http-è®¤è¯"><a class="header" href="#basic-authentication-http-è®¤è¯">Basic Authentication ï¼ˆHTTP è®¤è¯ï¼‰</a></h2>
<p><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/" title="Basic Authentication">Basic Authentication</a> æ˜¯æœ€ç®€å•çš„ http è®¤è¯æ–¹å¼ï¼Œé‡‡ç”¨ç”¨æˆ·åå’Œå¯†ç çš„æ–¹å¼ï¼Œç”¨æˆ·åå’Œå¯†ç ä»¥ secret çš„æ–¹å¼å­˜æ”¾åœ¨ kubernetes ä¸­ã€‚</p>
<pre><code class="language-sh">cd 02-auth-basic
</code></pre>
<h3 id="åˆ›å»ºç”¨æˆ·è®¾ç½®å¯†ç "><a class="header" href="#åˆ›å»ºç”¨æˆ·è®¾ç½®å¯†ç ">åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç </a></h3>
<p>ç”¨ä¸‹é¢çš„ä¸‰ä¸ªæ“ä½œï¼Œåˆ›å»º basic-auth ç”¨æˆ· fooï¼Œå¯†ç  123456ï¼Œå°†ç”¨æˆ·ä¿¡æ¯æäº¤åˆ° kubernetesï¼š</p>
<pre><code class="language-sh">$ htpasswd -c auth foo
$ kubectl -n demo-echo create secret generic basic-auth --from-file=auth

</code></pre>
<p>secret ä¸ç›®æ ‡æœåŠ¡ echo åœ¨åŒä¸€ä¸ª namespace ä¸­ã€‚</p>
<p>æ‰§è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ ./01-create-user.sh
New password:  123456
Re-type new password: 123456
Adding password for user foo
...
</code></pre>
<h3 id="ä¸ºç›®æ ‡æœåŠ¡è®¾ç½®-ingress"><a class="header" href="#ä¸ºç›®æ ‡æœåŠ¡è®¾ç½®-ingress">ä¸ºç›®æ ‡æœåŠ¡è®¾ç½® ingress</a></h3>
<p>ä¸ºç›®æ ‡æœåŠ¡åˆ›å»ºä¸€ä¸ªå¯ç”¨äº† basic-auth çš„ ingressï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-auth-basic
  annotations:
    # type of authentication
    nginx.ingress.kubernetes.io/auth-type: basic
    # name of the secret that contains the user/password definitions
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    # message to display with an appropriate context why the authentication is required
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - foo'
spec:
  rules:
  - host: auth-basic.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo apply -f auth-basic-ingress.yaml
</code></pre>
<pre><code class="language-sh">$ kubectl -n demo-echo get ingress
NAME                           HOSTS                     ADDRESS   PORTS   AGE
ingress-echo                   echo.example                        80      42d
ingress-echo-with-auth-basic   auth-basic.echo.example             80      6s
</code></pre>
<h3 id="ä½¿ç”¨æ•ˆæœ"><a class="header" href="#ä½¿ç”¨æ•ˆæœ">ä½¿ç”¨æ•ˆæœ</a></h3>
<p>é€šè¿‡å¼€å¯äº†è®¤è¯åŠŸèƒ½çš„ ingress è®¿é—®ï¼Œä¸å¸¦ç”¨æˆ·åå’Œå¯†ç æ—¶ï¼Œè¿”å› 401ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: auth-basic.echo.example&quot; 192.168.99.100:30933
&lt;html&gt;
&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯æ—¶ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: auth-basic.echo.example&quot; 192.168.99.100:30933 -u 'foo:bar'
&lt;html&gt;
&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
</code></pre>
<p>ç”¨æˆ·åå’Œå¯†ç æ­£ç¡®æ—¶ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: auth-basic.echo.example&quot; 192.168.99.100:30933 -u 'foo:123456'

Hostname: echo-597d89dcd9-4dp6f

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008
</code></pre>
<h2 id="client-certificate-authenticationå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯"><a class="header" href="#client-certificate-authenticationå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯">Client Certificate Authenticationï¼ˆå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯ï¼‰</a></h2>
<p><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/" title="Basic Authentication">Client Certificate Authentication</a>ï¼Œè¿›è¡Œå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯éœ€è¦æä¾› <strong>å®¢æˆ·ç«¯è¯ä¹¦</strong> ã€ <strong>æœåŠ¡ç«¯è¯ä¹¦</strong> å’Œèƒ½å¤ŸéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„ <strong>ca è¯ä¹¦</strong>ã€‚å¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦å¿…é¡»ä½¿ç”¨ tls åŠ å¯†ï¼Œæ‰€ä»¥æœåŠ¡ç«¯è¯ä¹¦æ˜¯å¿…é¡»çš„ã€‚</p>
<p>æ“ä½œè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸¤ä¸ªä½çº§é”™è¯¯å¼•å‘çš„é—®é¢˜ï¼Œä¾›å‚è€ƒï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/10/12/ssl-wrong-version-number.html" title="CONNECT_CR_SRVR_HELLO:wrong version number">CONNECT_CR_SRVR_HELLO:wrong version number</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/10/12/cacert-not-work-on-mac.html" title="unable to get local issuer certificate">unable to get local issuer certificate</a></li>
</ul>
<pre><code class="language-sh">cd 03-auth-cert
</code></pre>
<h3 id="ç”Ÿæˆè¯ä¹¦"><a class="header" href="#ç”Ÿæˆè¯ä¹¦">ç”Ÿæˆè¯ä¹¦</a></h3>
<p>ç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆè¯ä¹¦ï¼š</p>
<pre><code class="language-sh">
echo &quot;ç”Ÿæˆè‡ªç­¾ç½²çš„ ca è¯ä¹¦&quot;
openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days 3560 -nodes -subj '/CN=My Cert Authority'

echo &quot;ç”Ÿæˆç”¨ä¸Šè¿° ca ç­¾ç½²çš„ server è¯ä¹¦&quot;
openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj '/CN=auth-cert.echo.example'
openssl x509 -req -sha256 -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt

echo &quot;ç”Ÿæˆç”¨ä¸Šè¿° ca ç­¾ç½²çš„ client è¯ä¹¦&quot;
openssl req -new -newkey rsa:4096 -keyout client.key -out client.csr -nodes -subj '/CN=My Client'
openssl x509 -req -sha256 -days 3650 -in client.csr -CA ca.crt -CAkey ca.key -set_serial 02 -out client.crt
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">$ ./01-create-cert.sh
</code></pre>
<p>ç”Ÿæˆä¸‹é¢çš„æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">client.crt        server.crt
ca.crt            client.csr        server.csr
ca.key            client.key        server.key
</code></pre>
<h3 id="ä¸Šä¼ è¯ä¹¦"><a class="header" href="#ä¸Šä¼ è¯ä¹¦">ä¸Šä¼ è¯ä¹¦</a></h3>
<p>å°† ca è¯ä¹¦å’ŒæœåŠ¡ç«¯è¯ä¹¦ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡ echo æ‰€åœ¨çš„ namespaceï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create secret generic ca-secret --from-file=ca.crt=ca.crt
$ kubectl -n demo-echo create secret generic tls-secret --from-file=tls.crt=server.crt --from-file=tls.key=server.key
</code></pre>
<h3 id="åˆ›å»ºå¯¹åº”çš„-ingress"><a class="header" href="#åˆ›å»ºå¯¹åº”çš„-ingress">åˆ›å»ºå¯¹åº”çš„ ingress</a></h3>
<p>åˆ›å»ºé…ç½®äº† tls è®¤è¯çš„ ingressï¼Œauth-tls-secret æ˜¯æœåŠ¡ç«¯éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦æ—¶ä½¿ç”¨çš„è¯ä¹¦ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-auth-cert
  annotations:
    # Enable client certificate authentication
    nginx.ingress.kubernetes.io/auth-tls-verify-client: &quot;on&quot;
    # Create the secret containing the trusted ca certificates
    nginx.ingress.kubernetes.io/auth-tls-secret: &quot;demo-echo/ca-secret&quot;
    # Specify the verification depth in the client certificates chain
    nginx.ingress.kubernetes.io/auth-tls-verify-depth: &quot;1&quot;
    # Specify an error page to be redirected to verification errors
    nginx.ingress.kubernetes.io/auth-tls-error-page: &quot;http://auth-cert.echo.example/error-cert.html&quot;
    # Specify if certificates are passed to upstream server
    nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream: &quot;true&quot;
spec:
  rules:
  - host: auth-cert.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
  tls:
  - hosts:
    - auth-cert.echo.example
    secretName: tls-secret
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo apply -f auth-cert-ingress.yaml
</code></pre>
<pre><code class="language-sh">$ kubectl -n demo-echo get ingress
NAME                           HOSTS                     ADDRESS   PORTS   AGE
ingress-echo                   echo.example                        80      42d
ingress-echo-with-auth-basic   auth-basic.echo.example             80      3s
ingress-echo-with-auth-cert    auth-cert.echo.example              80      81s
</code></pre>
<h3 id="ä½¿ç”¨æ•ˆæœ-1"><a class="header" href="#ä½¿ç”¨æ•ˆæœ-1">ä½¿ç”¨æ•ˆæœ</a></h3>
<p>ä½¿ç”¨ http åè®®è®¿é—®æ—¶ï¼Œ308 è·³è½¬åˆ° https ç½‘å€ï¼š</p>
<pre><code class="language-sh">$ curl -v  -H &quot;Host: auth-cert.echo.example&quot; 192.168.99.100:30933
* Rebuilt URL to: 192.168.99.100:30933/
*   Trying 192.168.99.100...
* TCP_NODELAY set
* Connected to 192.168.99.100 (192.168.99.100) port 30933 (#0)
&gt; GET / HTTP/1.1
&gt; Host: auth-cert.echo.example
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 308 Permanent Redirect
&lt; Server: openresty/1.15.8.1
&lt; Date: Fri, 11 Oct 2019 11:34:57 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 177
&lt; Connection: keep-alive
&lt; Location: https://auth-cert.echo.example/
</code></pre>
<p>ä½¿ç”¨ https åè®®è®¿é—®ï¼ˆä½¿ç”¨ https æ—¶å¿…é¡»ä½¿ç”¨åŸŸåï¼‰ï¼Œå®¢æˆ·ç«¯æ²¡æœ‰ä½¿ç”¨è¯ä¹¦æ—¶ï¼Œè¢«é‡å®šå‘ï¼š</p>
<pre><code class="language-sh">$ curl --cacert  ca.crt  https://auth-cert.echo.example:30358/
...
&lt; HTTP/2 302
&lt; server: openresty/1.15.8.1
&lt; date: Sat, 12 Oct 2019 06:44:11 GMT
&lt; content-type: text/html
&lt; content-length: 151
&lt; location: http://auth-cert.echo.example/error-cert.html
&lt;
...
&lt;html&gt;
&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>é‡å®šå‘åœ°å€åœ¨ annotation ä¸­è®¾ç½®ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/auth-tls-error-page: &quot;http://auth-cert.echo.example/error-cert.html&quot;
</code></pre>
<p>ä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯ï¼š</p>
<pre><code class="language-sh">$ curl --cacert  ca.crt --cert  client.crt --key client.key  https://auth-cert.echo.example:30358/

Hostname: echo-597d89dcd9-4dp6f

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008
...
</code></pre>
<h2 id="å‚è€ƒ-54"><a class="header" href="#å‚è€ƒ-54">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/" title="Basic Authentication">Basic Authentication</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/client-certs/" title="Client Certificate Authentication">Client Certificate Authentication</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/10/12/ssl-wrong-version-number.html" title="CONNECT_CR_SRVR_HELLO:wrong version number">CONNECT_CR_SRVR_HELLO:wrong version number</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/10/12/cacert-not-work-on-mac.html" title="unable to get local issuer certificate">unable to get local issuer certificate</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-å¯¹æ¥å¤–éƒ¨çš„è®¤è¯æœåŠ¡"><a class="header" href="#ingress-nginx-å¯¹æ¥å¤–éƒ¨çš„è®¤è¯æœåŠ¡">ingress-nginx å¯¹æ¥å¤–éƒ¨çš„è®¤è¯æœåŠ¡</a></h1>
<p>ingress-nginx <a href="k8s/ingress-nginx/./auth.html">è‡ªå¸¦è®¤è¯åŠŸèƒ½</a>ï¼Œä¹Ÿæ”¯æŒå¯¹æ¥å¤–éƒ¨çš„è®¤è¯æœåŠ¡ã€‚</p>
<h2 id="å¯¹æ¥å¤–éƒ¨çš„-basic-auth"><a class="header" href="#å¯¹æ¥å¤–éƒ¨çš„-basic-auth">å¯¹æ¥å¤–éƒ¨çš„ Basic Auth</a></h2>
<pre><code class="language-sh">cd 04-auth-basic-ext/
</code></pre>
<h3 id="å‡†å¤‡å¤–éƒ¨-basic-auth-æœåŠ¡"><a class="header" href="#å‡†å¤‡å¤–éƒ¨-basic-auth-æœåŠ¡">å‡†å¤‡å¤–éƒ¨ basic auth æœåŠ¡</a></h3>
<p>å‡†å¤‡ä¸€ä¸ªå¤–éƒ¨çš„ Basic Authï¼Œ<a href="https://httpbin.org/#/Auth/get_basic_auth__user___passwd_" title="https://httpbin.org/">https://httpbin.org/ </a> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
<p>httbin.org æœ‰ä¸€ä¸ªæ¥å£ <code>https://httpbin.org/basic-auth/{user}/{passwd}</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªè®¤è¯åœ°å€ï¼Œç”¨æˆ·åå°±æ˜¯ url ä¸­çš„ userï¼Œå¯†ç å°±æ˜¯ passwdï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ curl -u user1:passwd1 https://httpbin.org/basic-auth/user1/passwd1
{
  &quot;authenticated&quot;: true,
  &quot;user&quot;: &quot;user1&quot;
}
</code></pre>
<h3 id="åˆ›å»ºä½¿ç”¨å¤–éƒ¨è®¤è¯çš„-ingress"><a class="header" href="#åˆ›å»ºä½¿ç”¨å¤–éƒ¨è®¤è¯çš„-ingress">åˆ›å»ºä½¿ç”¨å¤–éƒ¨è®¤è¯çš„ ingress</a></h3>
<p>auth-url æ˜¯å¤–éƒ¨è®¤è¯åœ°å€ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-auth-basic-ext
  annotations:
    nginx.ingress.kubernetes.io/auth-url: &quot;https://httpbin.org/basic-auth/user1/passwd1&quot;
spec:
  rules:
  - host: auth-basic-ext.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create -f auth-basic-ext-ingress.yaml
</code></pre>
<pre><code class="language-sh">$ kubectl -n demo-echo get ingress -o wide
NAME                               HOSTS                         ADDRESS   PORTS     AGE
ingress-echo                       echo.example                            80        45d
ingress-echo-with-auth-basic       auth-basic.echo.example                 80        2d20h
ingress-echo-with-auth-basic-ext   auth-basic-ext.echo.example             80        21s
ingress-echo-with-auth-cert        auth-cert.echo.example                  80, 443   2d1h
</code></pre>
<h3 id="ä½¿ç”¨æ•ˆæœ-2"><a class="header" href="#ä½¿ç”¨æ•ˆæœ-2">ä½¿ç”¨æ•ˆæœ</a></h3>
<p>ä¸æä¾›ç”¨æˆ·åå’Œå¯†ç ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: auth-basic-ext.echo.example&quot; 192.168.99.100:30933
&lt;html&gt;
&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>æä¾›é”™è¯¯çš„ç”¨æˆ·åæˆ–å¯†ç ï¼š</p>
<pre><code class="language-sh">$ curl -u user:nopass -H &quot;Host: auth-basic-ext.echo.example&quot; 192.168.99.100:30933
&lt;html&gt;
&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>æä¾›æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç ï¼š</p>
<pre><code class="language-sh">$ curl -u user1:passwd1 -H &quot;Host: auth-basic-ext.echo.example&quot; 192.168.99.100:30933

Hostname: echo-597d89dcd9-4dp6f

Pod Information:
    -no pod information available-
</code></pre>
<h2 id="å¯¹æ¥å¤–éƒ¨çš„-oauth2-æœåŠ¡"><a class="header" href="#å¯¹æ¥å¤–éƒ¨çš„-oauth2-æœåŠ¡">å¯¹æ¥å¤–éƒ¨çš„ OAuth2 æœåŠ¡</a></h2>
<p>OAuth2 æœåŠ¡çš„åœ°å€åŒæ ·åœ¨ annotation ä¸­è®¾ç½®ï¼Œä¸ºäº†é¿å…é¢å¤–çš„æŠ˜è…¾ï¼Œè¿™é‡Œå…¨éƒ¨ä½¿ç”¨ httpsï¼Œå¦åˆ™éœ€è¦è°ƒæ•´ lijiaocn/oauth2_proxy:v4.0.0 çš„å¯åŠ¨å‚æ•°ã€‚</p>
<pre><code class="language-sh">cd 05-2-auth-oauth-ext
</code></pre>
<h3 id="å‡†å¤‡å¤–éƒ¨-oauth2-æœåŠ¡"><a class="header" href="#å‡†å¤‡å¤–éƒ¨-oauth2-æœåŠ¡">å‡†å¤‡å¤–éƒ¨ OAuth2 æœåŠ¡</a></h3>
<p>Github æ”¯æŒ OAuth2 è®¤è¯ï¼Œé€šè¿‡åœ°å€ <a href="https://github.com/settings/applications/new" title="https://github.com/settings/applications/new">https://github.com/settings/applications/new </a> æ³¨å†Œä½¿ç”¨ github OAuth2 çš„åº”ç”¨ï¼š</p>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/github-oauth.png" alt="æ³¨å†Œ github OAuth2 åº”ç”¨" /></p>
<p>åˆ›å»ºä¹‹åè·å¾— Client ID å’Œ Client Secretï¼š</p>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/github-oauth2.png" alt="github OAuth2 æ³¨å†Œåº”ç”¨çš„ client ID å’Œ Secret" /></p>
<p>å¯åŠ¨å®¹å™¨ github_oauth2_proxyï¼Œè¯¥å®¹å™¨ç”¨äºä»£ç†åˆ° github çš„ OAuth2 è®¤è¯ï¼Œç”¨ github åˆ†é…çš„ client id å’Œ client secret å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">$ ./github-oauth-proxy.sh
$ docker ps
CONTAINER ID        IMAGE                          COMMAND                  CREATED             STATUS              PORTS                    NAMES
b9fc2924b9eb        lijiaocn/oauth2_proxy:v4.0.0   &quot;/bin/oauth2_proxy -â€¦&quot;   5 seconds ago       Up 4 seconds        0.0.0.0:4180-&gt;4180/tcp   github_oauth2_proxy
</code></pre>
<p>è¿™é‡Œçš„ github_oauth2_proxy æœåŠ¡åœ°å€ä¸º 192.168.99.1:4180ï¼Œéœ€è¦ç¡®ä¿ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>èƒ½å¤Ÿç”¨æµè§ˆå™¨æ‰“å¼€è¿™ä¸ªåœ°å€ï¼›</li>
<li>ingress-nginx å®¹å™¨èƒ½å¤Ÿè®¿é—®è¯¥åœ°å€ï¼š</li>
</ul>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/github-oauth3.png" alt="create github app" /></p>
<p>å¦‚æœå½“å‰æ²¡æœ‰ç™»å½• githubï¼Œç‚¹å‡» Sign in with Github ä¼šå¼¹å‡º github ç™»å½•é¡µé¢ã€‚
ç°åœ¨è¿˜æ²¡æœ‰é…ç½® auth-oauth2-ext.echo.example çš„ ingressï¼Œç™»å½•åçš„å›è°ƒé¡µé¢æ‰“ä¸å¼€ï¼Œä¸”ä¼šæŠ¥ url ä¸ä¸€è‡´çš„ OAuth2 è®¤è¯é”™è¯¯ã€‚</p>
<p>github_oauth2_proxy ä½äº kubernetes å¤–éƒ¨ï¼Œ æŒ‰ç…§ <a href="k8s/ingress-nginx/../svc/external.html">Kubernetes å¯¼å…¥å¤–éƒ¨æœåŠ¡</a> çš„åšæ³•å¯¼å…¥ï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo apply -f external-github-oauth2-proxy.yaml
</code></pre>
<h3 id="é…ç½®ç›®æ ‡åº”ç”¨çš„-ingress"><a class="header" href="#é…ç½®ç›®æ ‡åº”ç”¨çš„-ingress">é…ç½®ç›®æ ‡åº”ç”¨çš„ Ingress</a></h3>
<p>ä¸ºç›®æ ‡åº”ç”¨åˆ›å»º tls è¯ä¹¦ï¼Œä¿å­˜åœ¨åä¸º oauth2-tls-secret çš„ secret ä¸­ï¼š</p>
<pre><code class="language-sh">echo &quot;ç”Ÿæˆè‡ªç­¾ç½²çš„ ca è¯ä¹¦&quot;
openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days 3560 -nodes -subj '/CN=My Cert Authority'

echo &quot;ç”Ÿæˆç”¨ä¸Šè¿° ca ç­¾ç½²çš„ server è¯ä¹¦&quot;
openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj '/CN=auth-oauth2-ext.echo.example'
openssl x509 -req -sha256 -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">$ ./01-create-cert.sh
$ kubectl -n demo-echo create secret generic oauth2-tls-secret --from-file=tls.crt=server.crt --from-file=tls.key=server.key
</code></pre>
<p>ä¸ºç›®æ ‡åº”ç”¨åˆ›å»º ingressï¼š</p>
<ul>
<li>éœ€è¦åˆ›å»ºä¸¤ä¸ª ingressï¼Œä¸€ä¸ªæŒ‡å‘ç›®æ ‡åº”ç”¨ï¼Œä¸€ä¸ªæŒ‡å‘ github_oauth2_proxyï¼›</li>
<li>ä¸¤ä¸ª ingress ä½¿ç”¨åŒæ ·çš„ hostï¼Œæ³¨æ„ï¼Œ <strong>å¿…é¡»æ˜¯ä¸¤ä¸ª ingress</strong> ï¼›</li>
<li><strong>æŒ‡å‘ github_oauth2_proxy çš„ingress çš„ path ã€åœ¨ github ä¸­æ³¨å†Œçš„ callback åœ°å€ã€æŒ‡å‘ç›®æ ‡åº”ç”¨çš„ ingress ä¸­çš„ auth-signin ï¼Œä¸‰è€…è¦ä¸€è‡´</strong>ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯æŒ‡å‘ç›®æ ‡åº”ç”¨çš„ ingressï¼Œauth-url æ˜¯ oauth è®¤è¯åœ°å€ï¼Œauth-signin æ˜¯æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥æ—¶çš„é‡å®šå‘åœ°å€ï¼Œé‡å®šå‘åœ°å€æ˜¯æŒ‡å‘ github_oauth2_proxy çš„ ingress çš„ pathï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-auth-oauth2-ext
  annotations:
    # å¦‚æœ ingress-nginx å®¹å™¨èƒ½å¤Ÿè®¿é—® auth-oauth2-ext.echo.exampleï¼Œå†™åŸŸåä¹Ÿå¯ä»¥ï¼Œè§åé¢çš„åŸç†è¯´æ˜
    nginx.ingress.kubernetes.io/auth-url: &quot;http://192.168.99.1:4180/oauth2/auth&quot;
    nginx.ingress.kubernetes.io/auth-signin: &quot;https://auth-oauth2-ext.echo.example:30358/oauth2/start?rd=$escaped_request_uri&quot;
spec:
  rules:
  - host: auth-oauth2-ext.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
  tls:
  - hosts:
    - auth-oauth2-ext.echo.example
    secretName: secret/oauth2-tls-secret
</code></pre>
<p>ä¸‹é¢æ˜¯æŒ‡å‘ github_oauth2_proxy çš„ ingress ï¼Œéœ€è¦å’Œä¸Šé¢çš„ ingress ä½¿ç”¨åŒä¸€ä¸ªåŸŸåï¼Œå¦åˆ™ä¼šå› ä¸º url ä¸åŒ¹é…è€Œè®¤è¯å¤±è´¥ï¼Œä¸Šé¢çš„ ingress ä¸­çš„ auth-signin æŒ‡å®šçš„ path åœ¨è¿™é‡Œé…ç½®ï¼ˆ /oauth2 ï¼‰ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-auth-oauth2-ext-proxy
spec:
  rules:
  - host: auth-oauth2-ext.echo.example
    http:
      paths:
      - path: /oauth2
        backend:
          serviceName: external-github-oauth-proxy
          servicePort: 4180
  tls:
  - hosts:
    - auth-oauth2-ext.echo.example
    secretName: secret/oauth2-tls-secret
</code></pre>
<p>åˆ›å»ºï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create -f auth-oauth2-ext-ingress.yaml
</code></pre>
<h3 id="ä½¿ç”¨æ•ˆæœ-3"><a class="header" href="#ä½¿ç”¨æ•ˆæœ-3">ä½¿ç”¨æ•ˆæœ</a></h3>
<p>è®¿é—® https://auth-oauth2-ext.echo.example:30358 æ—¶ï¼Œå¼¹å‡º github ç™»å½•ç•Œé¢ï¼ˆæœªç™»å½•çš„æ—¶å€™ï¼‰ï¼š</p>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/github-oauth4.png" alt="ingress-nginx OAuth2 çš„ github è®¤è¯ç•Œé¢" /></p>
<p>ç™»å½• github åï¼Œå®¢æˆ·ç«¯ä¼šè¢«è®¾ç½®ä¸€ä¸ªå <code>_oauth2_proxy</code> çš„ cookieï¼Œåç»­è®¿é—®ä¸éœ€è¦ç™»å½• githubï¼š</p>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/github-oauth5.png" alt="ingress-nginx OAuth2 è®¤è¯æˆåŠŸ" /></p>
<h3 id="åŸç†è¯´æ˜"><a class="header" href="#åŸç†è¯´æ˜">åŸç†è¯´æ˜</a></h3>
<p>è®¿é—®ç›®æ ‡åº”ç”¨æ—¶å€™ï¼Œingress-nginx å®¹å™¨ä¼šå‘ auth-url å‘èµ·è®¤è¯ï¼Œè¯¥è®¤è¯ç”± ingress-nginx å®¹å™¨å‘èµ·ï¼Œæ‰€ä»¥ ingress-nginx å®¹å™¨å¿…é¡»èƒ½å¤Ÿè®¿é—® auth-urlã€‚</p>
<p>å¦‚æœè®¤è¯æ²¡æœ‰é€šè¿‡ï¼Œingress-nginx å®¹å™¨å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ° auth-signinã€‚auth-signin æ˜¯ç›®æ ‡åº”ç”¨çš„ oauth2 ç™»å½•é¡µé¢ï¼Œè¿™é‡Œæ˜¯ç”¨ github_oauth2_proxy å®¹å™¨å®ç°çš„ã€‚ auth-signin åœ°å€æ˜¯å®¢æˆ·ç«¯è¦è®¿é—®çš„ï¼Œingress-nginx å®¹å™¨èƒ½å¦è®¿é—®æ²¡æœ‰å½±å“ã€‚ </p>
<p>å®¢æˆ·ç«¯è¢«é‡å®šå‘åˆ° oauth2 ç™»å½•é¡µé¢åï¼Œç‚¹å‡»ç™»å½•ï¼Œè¿›å…¥ github çš„ç™»å½•é¡µé¢ã€‚</p>
<p>ç”¨æˆ·ç™»å½• github åï¼Œgithub å†å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°åœ¨ github ä¸­é…ç½®çš„å›è°ƒåœ°å€ï¼ˆå³ github_oauth2_proxy çš„ pathï¼‰ï¼Œè¯¥å›è°ƒåœ°å€ç”±å®¢æˆ·ç«¯è®¿é—®ï¼Œgithub èƒ½å¦è®¿é—®æ²¡æœ‰å½±å“ï¼š</p>
<p><img src="k8s/ingress-nginx/../../img/ingress-nginx/github-oauth6.png" alt="create github app" /></p>
<p>å®¢æˆ·ç«¯è®¿é—®å›è°ƒåœ°å€åï¼Œgithub_oauth2_proxy åœ¨å®¢æˆ·ç«¯è®¾ç½® cookieï¼Œå¹¶å°†å®¢æˆ·ç«¯é‡å®šå‘åˆ°æœ€åˆçš„è®¿é—®åœ°å€ã€‚</p>
<p>å¸¦æœ‰ cookie çš„å®¢æˆ·ç«¯å†æ¬¡è®¿é—®ç›®æ ‡åº”ç”¨æ—¶ï¼Œé€šè¿‡äº† auth-url çš„è®¤è¯ï¼Œè®¿é—®åˆ°ç›®æ ‡æœåŠ¡ã€‚</p>
<h2 id="å‚è€ƒ-55"><a class="header" href="#å‚è€ƒ-55">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/external-auth/" title="External Basic Authentication">External Basic Authentication</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/oauth-external-auth/" title="oauth-external-auth">External OAUTH Authentication</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„-uri-æ”¹å†™åŠŸèƒ½rewrite"><a class="header" href="#ingress-nginx-çš„-uri-æ”¹å†™åŠŸèƒ½rewrite">Ingress-nginx çš„ uri æ”¹å†™åŠŸèƒ½ï¼ˆrewriteï¼‰</a></h1>
<p>ingress-nginx æ”¯æŒ uri æ”¹å†™ï¼Œå¹¶ä¸”æ”¯æŒæ­£åˆ™æ•è·ã€‚</p>
<pre><code class="language-sh">cd 06-rewrite
</code></pre>
<h2 id="é…ç½®ç›®æ ‡åº”ç”¨çš„-ingress-1"><a class="header" href="#é…ç½®ç›®æ ‡åº”ç”¨çš„-ingress-1">é…ç½®ç›®æ ‡åº”ç”¨çš„ ingress</a></h2>
<p>åˆ›å»ºä¸€ä¸ª ingressï¼Œpath åŒ¹é…è§„åˆ™ä¸º <code>/rewrite/(.*)</code>ï¼Œrewrite-target ä¸­å¯ä»¥ä½¿ç”¨ path ä¸­çš„æ­£åˆ™åŒ¹é…ï¼š</p>
<pre><code class="language-sh">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-rewrite
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$1
spec:
  rules:
  - host: rewrite.echo.example
    http:
      paths:
      - path: /rewrite/(.*)
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>éœ€è¦æ³¨æ„ rewrite-target å¯¹ ingress ä¸­çš„æ‰€æœ‰ path æœ‰æ•ˆã€‚</p>
<p>åˆ›å»ºï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo create -f rewrite-echo-example-ingress.yaml
</code></pre>
<h2 id="æ•ˆæœ-2"><a class="header" href="#æ•ˆæœ-2">æ•ˆæœ</a></h2>
<p>è®¿é—® <code>/rewrite/abc</code>ï¼ŒæœåŠ¡ç«¯çœ‹åˆ°çš„æ˜¯æ”¹å†™åçš„ <code>/abc</code>ï¼š</p>
<pre><code class="language-sh">$ curl  -H &quot;Host: rewrite.echo.example&quot; 192.168.99.100:30933/rewrite/abc

Hostname: echo-597d89dcd9-4dp6f

Pod Information:
    -no pod information available-

Server values:
    server_version=nginx: 1.13.3 - lua: 10008

Request Information:
    client_address=172.17.0.11
    method=GET
    real path=/abc    #&lt;--æ”¹å†™åçš„ path
    query=
</code></pre>
<h2 id="å‚è€ƒ-56"><a class="header" href="#å‚è€ƒ-56">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/" title="Rewrite">Rewrite</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„è¯·æ±‚å¤åˆ¶åŠŸèƒ½"><a class="header" href="#ingress-nginx-çš„è¯·æ±‚å¤åˆ¶åŠŸèƒ½">ingress-nginx çš„è¯·æ±‚å¤åˆ¶åŠŸèƒ½</a></h1>
<p>ingress-nginx æ”¯æŒè¯·æ±‚å¤åˆ¶åŠŸèƒ½ï¼Œå°†åŒä¸€åŸŸåä¸‹æŒ‡å®š path ä¸Šçš„è¯·æ±‚å¤åˆ¶åˆ°å¦ä¸€ä¸ª pathã€‚</p>
<pre><code class="language-sh">cd 07-mirror
</code></pre>
<h2 id="éƒ¨ç½²æ¥æ”¶å¤åˆ¶è¯·æ±‚çš„æœåŠ¡"><a class="header" href="#éƒ¨ç½²æ¥æ”¶å¤åˆ¶è¯·æ±‚çš„æœåŠ¡">éƒ¨ç½²æ¥æ”¶å¤åˆ¶è¯·æ±‚çš„æœåŠ¡</a></h2>
<p>åˆ›å»ºä¸€ä¸ªåä¸º http-record çš„æœåŠ¡ï¼Œç”¨æ¥æ¥æ”¶å¤åˆ¶çš„è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo apply -f http-record.yaml
namespace/demo-echo unchanged
service/http-record created
deployment.apps/http-record created
</code></pre>
<pre><code class="language-sh">$ kubectl -n demo-echo get svc
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                     AGE
echo          NodePort    10.111.29.87    &lt;none&gt;        80:30411/TCP,22:31867/TCP   47d
http-record   NodePort    10.106.66.216   &lt;none&gt;        80:31734/TCP,22:32324/TCP   29s
</code></pre>
<h2 id="é…ç½®è¢«å¤åˆ¶çš„æœåŠ¡çš„-ingress"><a class="header" href="#é…ç½®è¢«å¤åˆ¶çš„æœåŠ¡çš„-ingress">é…ç½®è¢«å¤åˆ¶çš„æœåŠ¡çš„ ingress</a></h2>
<p>éœ€è¦åˆ›å»ºä¸¤ä¸ª ingressï¼Œä¸¤ä¸ª ingress ä½¿ç”¨ç›¸åŒçš„ hostã€‚</p>
<p>ç¬¬ä¸€ä¸ª ingress ç”¨æ¥æ¥æ”¶å¤åˆ¶çš„è¯·æ±‚ï¼ŒæŒ‡å‘ http-record æœåŠ¡ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-mirror-backend
spec:
  rules:
  - host: mirror.echo.example
    http:
      paths:
      - path: /echo
        backend:
          serviceName: http-record
          servicePort: 80
</code></pre>
<p>ç¬¬äºŒä¸ª ingress é…ç½®è¦è¢«å¤åˆ¶çš„è¯·æ±‚ï¼ŒæŒ‡å‘ç›®æ ‡æœåŠ¡ã€‚mirror-uri æ¥æ”¶å¤åˆ¶çš„è¯·æ±‚çš„åœ°å€ï¼Œå¯¹ ingress ä¸­æ‰€æœ‰ path æœ‰æ•ˆï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-mirror
  annotations:
    nginx.ingress.kubernetes.io/mirror-uri: &quot;/echo&quot;
spec:
  rules:
  - host: mirror.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>é»˜è®¤å°†è¯·æ±‚çš„ body ä¸€åŒå¤åˆ¶ï¼Œå¦‚æœä¸æƒ³å¤åˆ¶ bodyï¼Œåœ¨ç¬¬äºŒä¸ª ingress ä¸­ç”¨ä¸‹é¢çš„æ³¨è§£å…³é—­ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/mirror-request-body: &quot;off&quot;
</code></pre>
<h2 id="è¯·æ±‚å¤åˆ¶æ•ˆæœ"><a class="header" href="#è¯·æ±‚å¤åˆ¶æ•ˆæœ">è¯·æ±‚å¤åˆ¶æ•ˆæœ</a></h2>
<p>å‘èµ·è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">$ curl -X POST -d &quot;111111&quot; -H &quot;Host: mirror.echo.example&quot; &quot;192.168.99.100:30933/aaaaaa/bbbb?c=a&quot;
Hostname: echo-597d89dcd9-m84tq

Pod Information:
	-no pod information available-
...
</code></pre>
<p>ä¸Šé¢çš„è¯·æ±‚å°†è¢«å¤åˆ¶ä¸€ä»½åˆ° http-record å®¹å™¨ï¼Œhttp-record å®¹å™¨çš„å›åº”è¢« ingress å¿½ç•¥ï¼Œåœ¨ http-record çš„æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°å¤åˆ¶æ¥çš„è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo logs -f http-record-66478bdbb7-xslzg
</code></pre>
<p>http-record å®¹å™¨æ”¶åˆ°çš„è¯·æ±‚ä¿¡æ¯ï¼Œæ³¨æ„åŸå§‹çš„ uri ä½¿ç”¨ header ä¼ é€’çš„ â€”â€” <strong>X-Original-Uri</strong>ï¼š</p>
<pre><code class="language-json">{
    &quot;RemoteAddr&quot;: &quot;172.17.0.11:59784&quot;,
    &quot;Method&quot;: &quot;POST&quot;,
    &quot;Host&quot;: &quot;mirror.echo.example&quot;,
    &quot;RequestURI&quot;: &quot;/echo?c=a&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;Content-Length&quot;: [
            &quot;6&quot;
        ],
        &quot;Content-Type&quot;: [
            &quot;application/x-www-form-urlencoded&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.54.0&quot;
        ],
        &quot;X-Forwarded-For&quot;: [
            &quot;172.17.0.1&quot;
        ],
        &quot;X-Forwarded-Host&quot;: [
            &quot;mirror.echo.example&quot;
        ],
        &quot;X-Forwarded-Port&quot;: [
            &quot;80&quot;
        ],
        &quot;X-Forwarded-Proto&quot;: [
            &quot;http&quot;
        ],
        &quot;X-Original-Uri&quot;: [
            &quot;/aaaaaa/bbbb?c=a&quot;
        ],
        &quot;X-Real-Ip&quot;: [
            &quot;172.17.0.1&quot;
        ],
        &quot;X-Request-Id&quot;: [
            &quot;86e25adfcd7f2a673925d9a17769272a&quot;
        ],
        &quot;X-Scheme&quot;: [
            &quot;http&quot;
        ]
    },
    &quot;Body&quot;: &quot;1111&quot;
</code></pre>
<h2 id="å¤åˆ¶åŸå§‹çš„-uri"><a class="header" href="#å¤åˆ¶åŸå§‹çš„-uri">å¤åˆ¶åŸå§‹çš„ uri</a></h2>
<p>ä¸Šé¢çš„å¤åˆ¶æ•ˆæœï¼Œå¤åˆ¶åçš„è¯·æ±‚çš„ uri ä¸º /echoï¼Œä¸æ˜¯åŸå§‹çš„ uriã€‚åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­æ¢è®¨äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/10/21/ingress-nginx-request-mirror.html">kubernetes ingress-nginx http è¯·æ±‚å¤åˆ¶åŠŸèƒ½ä¸ nginx mirror çš„è¡Œä¸ºå·®å¼‚</a>ã€‚</li>
</ul>
<p>ç°åœ¨å‘ç°äº†ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ³•ï¼Œç›´æ¥åœ¨æ¥æ”¶å¤åˆ¶æµé‡çš„ ingress ä¸­åŠ ä¸€ä¸ª rewrite å°±å¯ä»¥äº†ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    # ä½¿ç”¨åŸå§‹çš„ uri
    nginx.ingress.kubernetes.io/rewrite-target: $request_uri
  name: ingress-echo-with-mirror-backend
spec:
  rules:
  - host: mirror.echo.example
    http:
      paths:
      - path: /echo
        backend:
          serviceName: http-record
          servicePort: 80
</code></pre>
<p>è¿™æ—¶å€™è®¿é—®ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: mirror.echo.example&quot; &quot;192.168.99.100:30933/dddd?a=1&amp;b=2&quot;
</code></pre>
<p>å¤åˆ¶ç«¯çœ‹åˆ°çš„è¯·æ±‚çš„ uri æ˜¯ dddd?a=1&amp;b=2 ï¼š</p>
<pre><code class="language-json">{
    &quot;RemoteAddr&quot;: &quot;172.17.0.27:39254&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;mirror.echo.example&quot;,
    &quot;RequestURI&quot;: &quot;/dddd%3Fa=1\u0026b=2?a=1\u0026b=2&quot;,
    ...çœç•¥...
}
</code></pre>
<h2 id="è¡¥å……å¦ä¸€ç§å®ç°æ–¹æ³•å¯ä»¥æŒ‰æ¯”ä¾‹å¤åˆ¶"><a class="header" href="#è¡¥å……å¦ä¸€ç§å®ç°æ–¹æ³•å¯ä»¥æŒ‰æ¯”ä¾‹å¤åˆ¶">è¡¥å……ï¼šå¦ä¸€ç§å®ç°æ–¹æ³•ï¼Œå¯ä»¥æŒ‰æ¯”ä¾‹å¤åˆ¶</a></h2>
<p>é˜¿é‡Œäº‘æä¾›çš„ä¸€ç§å®ç°æ–¹æ³•ï¼Œè¯¦æƒ…è§ <a href="https://yq.aliyun.com/articles/665338" title="é€šè¿‡K8S Ingress Controlleræ¥å®ç°åº”ç”¨çš„æµé‡å¤åˆ¶">é€šè¿‡K8S Ingress Controlleræ¥å®ç°åº”ç”¨çš„æµé‡å¤åˆ¶</a>ã€‚</p>
<p>åœ¨ ingress-nginx ä½¿ç”¨çš„ configmap nginx-configuration ä¸­æ·»åŠ é…ç½®ï¼Œé€šè¿‡ <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#http-snippet" title="http-snippet">http-snippet</a> æ·»åŠ å…¨å±€é…ç½®ï¼Œè®¾ç½®å¤åˆ¶çš„æµé‡çš„å»å¤„ã€‚æµé‡çš„å»å¤„å¯ä»¥æ˜¯ IP åœ°å€æˆ–è€…åŸŸåï¼Œä¸‹é¢å°†ä½¿ç”¨ http-record æœåŠ¡çš„ cluster ipï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo get svc
NAME          TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE
echo          NodePort   10.100.105.128   &lt;none&gt;        80:32110/TCP,22:32561/TCP   33d
http-record   NodePort   10.106.66.216    &lt;none&gt;        80:31734/TCP,22:32324/TCP   29d
</code></pre>
<p>åœ¨ configmap nginx-configuration ä¸­æ·»åŠ çš„é…ç½®ï¼Œè¿™ä¸ªé…ç½®æ˜¯å…¨å±€çš„ï¼Œä¼šè¢«æ³¨å…¥åˆ° nginx.confï¼š</p>
<pre><code class="language-yaml"> http-snippet: |
   split_clients &quot;$date_gmt&quot; $mirror_echo_to_http_record {
      50%    10.106.66.216; # å¯ä»¥æ˜¯åŸŸåã€IPï¼Œ100% æ˜¯å¤åˆ¶æ¯”ä¾‹
      *       &quot;&quot;;
   }
</code></pre>
<p>split_clients æŒ‡ä»¤çš„ç”¨é€”è§ <a href="k8s/ingress-nginx/../../nginx/abtest.html">nginx çš„ A/B æµ‹è¯•åŠŸèƒ½</a>ï¼Œè¿™ä¸ªæŒ‡ä»¤çš„å¼ºå¤§ä¹‹å¤„æ˜¯å¯ä»¥æŒ‰ hash å€¼çš„åˆ†å¸ƒåŒºé—´è®¾ç½®å˜é‡å€¼ã€‚hash ç®—æ³•çš„è¾“å…¥å­—ç¬¦ä¸²è‡ªè¡ŒæŒ‡å®šï¼Œè¿™é‡Œæ˜¯ $date_gmtï¼Œä½¿ç”¨æºIPã€request_uri ç­‰ nginx æ”¯æŒçš„å˜é‡éƒ½æ˜¯å¯ä»¥çš„ã€‚</p>
<p>åœ¨éœ€è¦è¢«å¤åˆ¶çš„ ingress ä¸­ç”¨ <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#configuration-snippet" title="configuration-snippet">configuration-snippet</a> å’Œ <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#server-snippet" title="server-snippet">server-snippet</a> æ³¨å…¥é…ç½®ï¼Œè¿™äº›é…ç½®ä¼š <strong>åŸå°ä¸åŠ¨</strong> çš„åˆå¹¶åˆ°æœ€ç»ˆçš„ nginx.conf ä¸­ï¼Œ <strong>ä¸è¦æœ‰é”™è¯¯</strong>ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-mirror2
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
        mirror /mirror334556; # é…ç½®å¤šæ¬¡è¯¥é¡¹åˆ™å¯æ”¾å¤§Nå€æµé‡
    nginx.ingress.kubernetes.io/server-snippet: |
        location = /mirror334556 {
            internal;
            access_log off; # å…³é—­mirrorè¯·æ±‚æ—¥å¿—
            if ($mirror_echo_to_http_record) {
                set $proxy_host $host; # æ˜¯å¦æ›´æ”¹ host
                #set $proxy_host $mirror_echo_to_http_record; # æ˜¯å¦æ›´æ”¹ host
                proxy_pass http://$mirror_echo_to_http_record$request_uri;
            }
        }
spec:
  rules:
  - host: mirror2.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>æ³¨æ„ $mirror_echo_to_http_record è¦å’Œ configmap nginx-configuration ä¸­é…ç½®çš„é…å¯¹ï¼Œmirror æŒ‡å®šçš„ /mirror334556 å’ŒåŒåçš„ location å¯¹åº”ã€‚</p>
<p>è®¿é—® mirror2.echo.exampleï¼Œä¼šçœ‹åˆ°è¯·æ±‚è¢«å¤åˆ¶åˆ° http-recordï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: mirror2.echo.example&quot; 192.168.99.100:30933/1234

Hostname: echo-597d89dcd9-m84tq

Pod Information:
	-no pod information available-
</code></pre>
<p>http-record æ”¶åˆ°çš„å¤åˆ¶è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">/go/src/Server/echo.go:46: {
    &quot;RemoteAddr&quot;: &quot;10.0.2.15:39222&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;mirror2.echo.example&quot;,
    &quot;RequestURI&quot;: &quot;/1234&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;Connection&quot;: [
            &quot;close&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.54.0&quot;
        ]
    },
    &quot;Body&quot;: &quot;&quot;
}
</code></pre>
<p>è¿™ç§æ–¹æ³•ç›¸æ¯”ç¬¬ä¸€ç§æ–¹å¼ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼Œæ˜¯ä¸€ç§æ›´å·§å¦™æ›´ç®€æ´çš„åšæ³•ï¼Œå·¥ä½œåŸç†ï¼š</p>
<ol>
<li><a href="k8s/ingress-nginx/../../nginx/mirror.html">ç»“åˆ split_clients å®ç°è¯·æ±‚çš„éƒ¨åˆ†å¤åˆ¶</a></li>
<li><a href="k8s/ingress-nginx/../../nginx/abtest.html">Nginx çš„ A/B æµ‹è¯•åŠŸèƒ½</a></li>
</ol>
<p>å¦‚æœä¸è¦æ±‚æŒ‰æ¯”ä¾‹å¤åˆ¶ï¼Œå®ç°æ–¹å¼æ›´ç®€å•ï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-mirror3
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
        mirror /mirror334556; # é…ç½®å¤šæ¬¡è¯¥é¡¹åˆ™å¯æ”¾å¤§Nå€æµé‡
    nginx.ingress.kubernetes.io/server-snippet: |
        location = /mirror334556 {
            internal;
            #access_log off; # å…³é—­mirrorè¯·æ±‚æ—¥å¿—
            set $target 10.106.66.216;
            set $proxy_host $target; # æ˜¯å¦æ›´æ”¹ host
            #set $proxy_host $host;  # æ˜¯å¦æ›´æ”¹ host
            proxy_pass http://$target$request_uri;
        }
spec:
  rules:
  - host: mirror3.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<h2 id="å‚è€ƒ-57"><a class="header" href="#å‚è€ƒ-57">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#mirror" title="mirror">mirror</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/10/21/ingress-nginx-request-mirror.html">kubernetes ingress-nginx http è¯·æ±‚å¤åˆ¶åŠŸèƒ½ä¸ nginx mirror çš„è¡Œä¸ºå·®å¼‚</a></li>
<li><a href="https://yq.aliyun.com/articles/665338" title="é€šè¿‡K8S Ingress Controlleræ¥å®ç°åº”ç”¨çš„æµé‡å¤åˆ¶">é€šè¿‡K8S Ingress Controlleræ¥å®ç°åº”ç”¨çš„æµé‡å¤åˆ¶</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-é’ˆå¯¹æº-ip-é™é€Ÿ"><a class="header" href="#ingress-nginx-é’ˆå¯¹æº-ip-é™é€Ÿ">ingress-nginx é’ˆå¯¹æº IP é™é€Ÿ</a></h1>
<p>ingress-nginx å¯ä»¥é™åˆ¶æº IP çš„æœ€å¤§è¿æ¥æ•°ã€æ¯ç§’è¯·æ±‚æ•°ã€æ¯åˆ†é’Ÿè¯·æ±‚æ•°ã€æ¯ç§’å‘é€çš„æ•°æ®é‡ã€é™é€Ÿç™½åå•ã€‚è¶…è¿‡ä¸Šé™çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ° ingress-nginx è¿”å›çš„ 503ã€‚</p>
<pre><code class="language-sh">cd 08-ratelimit
</code></pre>
<h2 id="é…ç½®-ingress-1"><a class="header" href="#é…ç½®-ingress-1">é…ç½® ingress</a></h2>
<p>ä¼˜å…ˆçº§ï¼š limit-connections &gt;  limit-rpm &gt; limit-rpsã€‚</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-ratelimit
  annotations:
    # æ¯ä¸ªæº IP å¯ä»¥å»ºç«‹æœ€å¤§è¿æ¥æ•°
    nginx.ingress.kubernetes.io/limit-connections: 2
    # æ¯ä¸ªæº IP æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ¬¡æ•°
    nginx.ingress.kubernetes.io/limit-rpm: &quot;5&quot;
    # æ¯ä¸ªæº IP æ¯ç§’æœ€å¤§è¯·æ±‚æ¬¡æ•°
    nginx.ingress.kubernetes.io/limit-rps: &quot;1&quot;
spec:
  rules:
  - host: ratelimit.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">$ kubectl -n demo-echo apply -f ratelimit-echo-example-ingress.yaml
</code></pre>
<h2 id="é™é€Ÿæ•ˆæœ"><a class="header" href="#é™é€Ÿæ•ˆæœ">é™é€Ÿæ•ˆæœ</a></h2>
<p>è¿ç»­è®¿é—®è¶…é€Ÿåï¼Œingress-nginx è¿”å› 503ï¼š</p>
<pre><code class="language-sh">$ curl -v  -H &quot;Host: ratelimit.echo.example&quot; &quot;192.168.99.100:30933/&quot;
*   Trying 192.168.99.100...
* TCP_NODELAY set
* Connected to 192.168.99.100 (192.168.99.100) port 30933 (#0)
&gt; GET / HTTP/1.1
&gt; Host: ratelimit.echo.example
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 503 Service Temporarily Unavailable
&lt; Server: openresty/1.15.8.1
&lt; Date: Wed, 16 Oct 2019 10:37:41 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 203
&lt; Connection: keep-alive
</code></pre>
<h2 id="å…¶å®ƒç›¸å…³é…ç½®"><a class="header" href="#å…¶å®ƒç›¸å…³é…ç½®">å…¶å®ƒç›¸å…³é…ç½®</a></h2>
<p>Configmap ä¸­è¿˜æœ‰å…¶ä»–ç›¸å…³é…ç½®ï¼Œä¾‹å¦‚è¶…é€Ÿæ—¶çš„è¿”å›ä»£ç ï¼š<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code" title="limit-req-status-code">limit-req-status-code</a>ã€‚</p>
<h2 id="ç»†èŠ‚ç ”ç©¶"><a class="header" href="#ç»†èŠ‚ç ”ç©¶">ç»†èŠ‚ç ”ç©¶</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/12/03/ingress-nginx-rate-limit.html" title="ingress-nginx çš„é™é€ŸåŠŸèƒ½åœ¨ nginx.conf ä¸­çš„å¯¹åº”é…ç½®">ingress-nginx çš„é™é€ŸåŠŸèƒ½åœ¨ nginx.conf ä¸­çš„å¯¹åº”é…ç½®</a></li>
</ul>
<h2 id="å‚è€ƒ-58"><a class="header" href="#å‚è€ƒ-58">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#rate-limiting" title="rate-limiting">rate-limiting</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/12/03/ingress-nginx-rate-limit.html" title="ingress-nginx çš„é™é€ŸåŠŸèƒ½åœ¨ nginx.conf ä¸­çš„å¯¹åº”é…ç½®">ingress-nginx çš„é™é€ŸåŠŸèƒ½åœ¨ nginx.conf ä¸­çš„å¯¹åº”é…ç½®</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„é‡‘ä¸é›€canaryå‘å¸ƒåŠŸèƒ½"><a class="header" href="#ingress-nginx-çš„é‡‘ä¸é›€canaryå‘å¸ƒåŠŸèƒ½">ingress-nginx çš„é‡‘ä¸é›€ï¼ˆcanaryï¼‰å‘å¸ƒåŠŸèƒ½</a></h1>
<p>ä¹‹å‰æœ‰è¿‡ä¸€ç¯‡ç¬”è®°ï¼ˆ<a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/07/12/ingress-nginx-canary.html" title="kubernetes ingress-nginx çš„é‡‘ä¸é›€ï¼ˆcanaryï¼‰/ç°åº¦å‘å¸ƒåŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•">kubernetes ingress-nginx çš„é‡‘ä¸é›€ï¼ˆcanaryï¼‰/ç°åº¦å‘å¸ƒåŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•</a>ï¼‰ï¼Œè¿™é‡Œé‡æ–°æ•´ç†ä¸‹ã€‚ä»€ä¹ˆæ˜¯é‡‘ä¸é›€ã€ä»€ä¹ˆæ˜¯è“ç»¿ã€ä»€ä¹ˆæ˜¯ç°åº¦ï¼Œè§ <a href="https://www.lijiaocn.com/%E6%96%B9%E6%B3%95/2018/10/23/devops-blue-green-deployment-ab-test-canary.html" title="è“ç»¿éƒ¨ç½²ã€é‡‘ä¸é›€å‘å¸ƒï¼ˆç°åº¦å‘å¸ƒï¼‰ã€A/Bæµ‹è¯•çš„å‡†ç¡®å®šä¹‰">è“ç»¿éƒ¨ç½²ã€é‡‘ä¸é›€å‘å¸ƒï¼ˆç°åº¦å‘å¸ƒï¼‰ã€A/Bæµ‹è¯•çš„å‡†ç¡®å®šä¹‰</a>ã€‚</p>
<h2 id="åŸæœ‰çš„-ingress-ä¸éœ€è¦æ”¹å˜"><a class="header" href="#åŸæœ‰çš„-ingress-ä¸éœ€è¦æ”¹å˜">åŸæœ‰çš„ ingress ä¸éœ€è¦æ”¹å˜</a></h2>
<p>ä½¿ç”¨ canary åŠŸèƒ½æ—¶ï¼Œä¸»ç‰ˆæœ¬ ingress ä¿æŒåŸçŠ¶ï¼Œä¸éœ€è¦ä»»ä½•æ”¹åŠ¨ã€‚</p>
<p>è¿™é‡Œä½¿ç”¨ä¸‹é¢ ingress ä½œä¸ºä¸»ç‰ˆæœ¬ ingressï¼š </p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-canary-master
spec:
  rules:
  - host: canary.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">kubectl -n demo-echo create -f canary-master-echo-example-ingress.yaml
</code></pre>
<h2 id="åˆ›å»º-canary-é‡‘ä¸é›€ingress"><a class="header" href="#åˆ›å»º-canary-é‡‘ä¸é›€ingress">åˆ›å»º canary ï¼ˆé‡‘ä¸é›€ï¼‰ingress</a></h2>
<p>é‡‘ä¸é›€ ingress å’Œä¸» ingress ä½¿ç”¨ç›¸åŒçš„ host å’Œ pathï¼ŒåŒºåˆ«åœ¨äºå¤šå‡ºäº†ä¸€äº› annotationï¼š</p>
<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-echo-with-canary-version
  annotations:
    nginx.ingress.kubernetes.io/canary: &quot;true&quot;
    nginx.ingress.kubernetes.io/canary-by-header: &quot;version&quot;
    nginx.ingress.kubernetes.io/canary-by-header-value: &quot;canary&quot;
    nginx.ingress.kubernetes.io/canary-by-cookie: &quot;canary-cookie&quot;
    nginx.ingress.kubernetes.io/canary-weight: &quot;50&quot;
spec:
  rules:
  - host: canary.echo.example
    http:
      paths:
      - path: /
        backend:
          serviceName: http-record
          servicePort: 80
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">kubectl -n demo-echo create -f canary-version-echo-example-ingress.yaml
</code></pre>
<p><code>nginx.ingress.kubernetes.io/canary: true</code> æ˜¯å¯ç”¨ canaryï¼Œå…¶ä½™å‡ ä¸ª annotation åˆ†åˆ«æ˜¯è®¾ç½®å¯¼å‘ cannary çš„æ¡ä»¶ã€æƒé‡ã€‚</p>
<h2 id="é‡‘ä¸é›€æ•ˆæœ"><a class="header" href="#é‡‘ä¸é›€æ•ˆæœ">é‡‘ä¸é›€æ•ˆæœ</a></h2>
<p>ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ—¶ï¼Œ50% çš„è¯·æ±‚è½¬å‘åˆ°é‡‘ä¸é›€æœåŠ¡ï¼ˆå¯¹åº”è®¾ç½® canary-weightï¼‰ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: canary.echo.example&quot;  192.168.99.100:30933/
</code></pre>
<p>å¸¦æœ‰ &quot;version: canary&quot; å¤´çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°é‡‘ä¸é›€æœåŠ¡ï¼ˆå¯¹åº”è®¾ç½® canary-by-header å’Œ canary-by-header-valueï¼‰ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: canary.echo.example&quot; -H &quot;version: canary&quot; 192.168.99.100:30933/
</code></pre>
<p>å¸¦æœ‰ canary-cookie ä¸” cookie  å€¼ä¸º always çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°é‡‘ä¸é›€æœåŠ¡ï¼ˆå¯¹åº”è®¾ç½® canary-by-cookieï¼‰ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: canary.echo.example&quot; -b canary-cookie=always 192.168.99.100:30933/
</code></pre>
<p>å¸¦æœ‰ canary-cookie ä¸” cookie  å€¼ä¸º always çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°ä¸»æœåŠ¡ï¼ˆå¯¹åº”è®¾ç½® canary-by-cookieï¼‰ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: canary.echo.example&quot; -b canary-cookie=never 192.168.99.100:30933/
</code></pre>
<p>headerã€cookieã€weight çš„ä¼˜å…ˆçº§ï¼šcanary-by-header -&gt; canary-by-cookie -&gt; canary-weightã€‚</p>
<h2 id="å‚è€ƒ-59"><a class="header" href="#å‚è€ƒ-59">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„å¸¸ç”¨æ³¨è§£"><a class="header" href="#ingress-nginx-çš„å¸¸ç”¨æ³¨è§£">ingress-nginx çš„å¸¸ç”¨æ³¨è§£</a></h1>
<p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/" title="Nginx Ingress Controller Annotations">Annotations</a> ä¸­åˆ—å‡ºäº† ingress-nginx æ”¯æŒçš„ annotationï¼Œ</p>
<h2 id="åç«¯è¶…æ—¶è®¾ç½®"><a class="header" href="#åç«¯è¶…æ—¶è®¾ç½®">åç«¯è¶…æ—¶è®¾ç½®</a></h2>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/proxy-connect-timeout    # åç«¯è¿æ¥è¶…æ—¶ï¼Œé»˜è®¤ 60 ç§’
nginx.ingress.kubernetes.io/proxy-send-timeout       # åç«¯å‘é€è¶…æ—¶ï¼Œé»˜è®¤ 120 ç§’
nginx.ingress.kubernetes.io/proxy-read-timeout       # åç«¯è¯»å–è¶…æ—¶ï¼Œé»˜è®¤ 120 ç§’
</code></pre>
<h2 id="åç«¯é‡è¯•è®¾ç½®"><a class="header" href="#åç«¯é‡è¯•è®¾ç½®">åç«¯é‡è¯•è®¾ç½®</a></h2>
<p>é‡è¯•æ¡ä»¶è®¾ç½®ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/proxy-next-upstream  # é»˜è®¤ &quot;error timeout&quot;
</code></pre>
<p>proxy-next-upstream æ˜¯ nginx çš„ <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream" title="proxy_next_upstream">æ ‡å‡†æŒ‡ä»¤</a>ï¼Œå®ƒå®šä¹‰äº†å°†è¯·æ±‚è½¬å‘å¦ä¸€ä¸ª upstream çš„æƒ…å†µï¼Œæ”¯æŒä»¥ä¸‹çš„å€¼ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ï¼š</p>
<pre><code>error 
timeout 
invalid_header 
http_500 
http_502 
http_503 
http_504 
http_403 
http_404 
http_429 
non_idempotent 
off
</code></pre>
<p>é‡è¯•è¶…æ—¶è®¾ç½®ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/proxy-next-upstream-timeout   # è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 0 ç§’
nginx.ingress.kubernetes.io/proxy-next-upstream-tries     # é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 3 æ¬¡ 
</code></pre>
<p>è¯·æ±‚ç¼“å­˜ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/proxy-request-buffering       # ç¼“å­˜è¯·æ±‚ï¼Œé»˜è®¤ on
</code></pre>
<p>å¼€å¯è¯·æ±‚ç¼“å­˜æ—¶ï¼Œingress æš‚å­˜æ”¶åˆ°çš„å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè¯·æ±‚æ•°æ®å…¨éƒ¨æ”¶é½åï¼Œå†å°†è¯·æ±‚è½¬å‘ç»™ upstreamã€‚</p>
<h2 id="ç¼“å­˜åŒºè®¾ç½®"><a class="header" href="#ç¼“å­˜åŒºè®¾ç½®">ç¼“å­˜åŒºè®¾ç½®</a></h2>
<p>è¯·æ±‚ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ä¸ºä¸¤ä¸ªå†…å­˜é¡µé¢ï¼Œé€šå¸¸æ˜¯ 8k å’Œ 16kï¼Œè¶…è¿‡çš„è¯·æ±‚è¢«å†™å…¥ä¸´æ—¶æ–‡ä»¶æš‚å­˜ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/client-body-buffer-size  &quot;1000&quot; # é»˜è®¤ 8k
</code></pre>
<p>å®¢æˆ·ç«¯è¯·æ±‚æœ€å¤§é•¿åº¦ï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/proxy-body-size  # é»˜è®¤ 8m
</code></pre>
<p>å“åº”æ•°æ®ç¼“å†²åŒºå¤§å°ï¼ˆä»å“åº”å¤´è¯»å–çš„ç¬¬ä¸€å—æ•°æ®å¤§å°ï¼‰ï¼Œé»˜è®¤ä¸º 1 ä¸ªé¡µé¢ï¼Œé€šå¸¸æ˜¯ 4k å’Œ 8kï¼š</p>
<pre><code class="language-sh">nginx.ingress.kubernetes.io/proxy-buffer-size # é»˜è®¤ 4k
</code></pre>
<h2 id="å‚è€ƒ-60"><a class="header" href="#å‚è€ƒ-60">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ingress-nginx-çš„ç›¸å…³ç¬”è®°æ±‡æ€»"><a class="header" href="#ingress-nginx-çš„ç›¸å…³ç¬”è®°æ±‡æ€»">ingress-nginx çš„ç›¸å…³ç¬”è®°æ±‡æ€»</a></h1>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/10/28/ingress-nginx-test-code.html" title="kubernetes ingress-nginx çš„æµ‹è¯•ä»£ç ï¼ˆå•å…ƒæµ‹è¯•+e2eæµ‹è¯•ï¼‰">ingress-nginx çš„æµ‹è¯•ä»£ç ï¼ˆå•å…ƒæµ‹è¯•+e2eæµ‹è¯•ï¼‰</a></li>
</ul>
<h2 id="å‚è€ƒ-61"><a class="header" href="#å‚è€ƒ-61">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="envoy"><a class="header" href="#envoy">Envoy</a></h1>
<p>åˆæ¬¡äº†è§£ Envoy æ—¶åšè¿‡ä¸€äº›ç¬”è®°ï¼Œè¿™é‡Œæ˜¯å†æ¬¡å­¦ä¹ æ—¶ï¼Œå¯¹åŸå…ˆç¬”è®°çš„è¿›ä¸€æ­¥æ•´ç†ã€‚</p>
<p>è¿™æœ¬æ‰‹å†Œçš„å†…å®¹ä¼šæ ¹æ®å®é™…å·¥ä½œçš„éœ€è¦è¿›è¡Œæ‰©å±•ï¼Œæ¯”è¾ƒè´´è¿‘å®é™…ã€‚</p>
<p>æ‰‹å†Œç›®å½•åœ¨é¡µé¢å·¦ä¾§ï¼Œå¦‚æœæ˜¯åœ¨æ‰‹æœºç«¯æŸ¥çœ‹ï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ <i class="fa fa-align-justify"></i> ç¬¦å·ã€‚</p>
<p><strong>è§†é¢‘è®²è§£</strong>ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
<h2 id="ç¯å¢ƒå’Œç´ æå‡†å¤‡"><a class="header" href="#ç¯å¢ƒå’Œç´ æå‡†å¤‡">ç¯å¢ƒå’Œç´ æå‡†å¤‡</a></h2>
<pre><code class="language-sh">docker pull envoyproxy/envoy:v1.11.0
git clone https://github.com/introclass/go-code-example.git
</code></pre>
<h2 id="å†å²æ–‡ç« æ”¶å½•"><a class="header" href="#å†å²æ–‡ç« æ”¶å½•">å†å²æ–‡ç« æ”¶å½•</a></h2>
<p>ä¸‹é¢æ˜¯ <strong>ä»¥å‰çš„</strong> ç¬”è®°ï¼Œå†…å®¹ç›¸å¯¹æ‚ä¹±ï¼Œä¸å¦‚å½“å‰æ‰‹å†Œæ¡ç†ã€æ¸…æ™°ï¼Œä»…ä¾›å‚è€ƒï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/12/envoy-01-usage.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆä¸€ï¼‰ï¼šæ–°å‹L3~L7å±‚è®¿é—®ä»£ç†è½¯ä»¶Envoyçš„ä½¿ç”¨ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/17/envoy-02-ide.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆäºŒï¼‰ï¼šenvoyæºä»£ç é˜…è¯»ã€é›†æˆå¼€å‘ç¯å¢ƒ(IDE)ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/20/envoy-03-arch.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆä¸‰ï¼‰ï¼šenvoyè®¾è®¡æ€è·¯ã€é…ç½®æ–‡ä»¶å’ŒåŠŸèƒ½ç‰¹æ€§æ¦‚è§ˆã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/24/envoy-04-codes.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆå››ï¼‰ï¼šenvoyæºä»£ç èµ°è¯»&amp;å¯åŠ¨è¿‡ç¨‹åˆ†æã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/27/envoy-05-configfile.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆäº”ï¼‰ï¼šenvoyçš„é…ç½®æ–‡ä»¶å®Œå…¨å±•å¼€ä»‹ç»ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/28/envoy-06-features-1-basic.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆå…­ï¼‰ï¼šenvoyä¸€äº›ç®€å•åŠŸèƒ½/åŸºç¡€é…ç½®çš„ä½¿ç”¨æ–¹æ³•ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/29/envoy-07-features-2-dynamic-discovery.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆä¸ƒï¼‰ï¼šenvoyåŠ¨æ€é…ç½®xDSçš„ä½¿ç”¨æ–¹æ³•ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/01/07/envoy-08-features-3-dynamic-discovery-ads.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆå…«ï¼‰ï¼šenvoyåŠ¨æ€é…ç½®-èšåˆå‘ç°ADSçš„ä½¿ç”¨æ–¹æ³•ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/01/07/envoy-09-usage-rules.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆä¹ï¼‰ï¼šenvoyçš„åº”ç”¨æ–¹æ³•ä¸ä½¿ç”¨çº¦æŸã€‹</a></li>
</ul>
<h2 id="å‚è€ƒ-62"><a class="header" href="#å‚è€ƒ-62">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-å®‰è£…è¿è¡Œ"><a class="header" href="#envoy-å®‰è£…è¿è¡Œ">Envoy å®‰è£…è¿è¡Œ</a></h1>
<p>Envoy ä»¥ docker é•œåƒçš„æ–¹å¼åˆ†å‘ï¼Œç¤¾åŒºæä¾›çš„é•œåƒä½äº <a href="https://hub.docker.com/u/envoyproxy" title="docker hub: envoyproxy">envoyproxy</a> ä¸­ï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p>
<ul>
<li><a href="https://hub.docker.com/r/envoyproxy/envoy-alpine/tags" title="envoyproxy/envoy-alpine">envoyproxy/envoy-alpine</a> åŸºäº alpine çš„å‘è¡Œé•œåƒ</li>
<li><a href="https://hub.docker.com/r/envoyproxy/envoy/tags" title="envoyproxy/envoy">envoyproxy/envoy</a> åŸºäº ubuntu çš„å‘è¡Œé•œåƒ</li>
</ul>
<p>è·å–é•œåƒï¼š</p>
<pre><code class="language-sh">docker pull envoyproxy/envoy:v1.11.0
</code></pre>
<p>å¯åŠ¨ envoy å®¹å™¨æ—¶ï¼Œå¯ä»¥ç”¨æœ¬åœ°çš„ envoy.yaml è¦†ç›–é•œåƒä¸­çš„ envoy.yamlï¼š</p>
<pre><code class="language-sh">docker run -idt --network=host -v `pwd`/envoy.yaml:/etc/envoy/envoy.yaml envoyproxy/envoy:v1.11.0
</code></pre>
<p>envoy é•œåƒä¸­åŒ…å«çš„å‘½ä»¤éå¸¸å°‘ï¼Œå¯ä»¥è‡ªå·±åœ¨é‡Œé¢å®‰è£…ä¸€äº›å¸¸ç”¨çš„è°ƒè¯•å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">apt-get update
apt-get install -y iputils-ping curl iproute
</code></pre>
<p>æœ¬æ‰‹å†Œä½¿ç”¨çš„ envoy é•œåƒæ˜¯ â€œlijiaocn/envoy:v1.11.0â€ï¼Œä½¿ç”¨ä¸‹é¢çš„ Dockerfile ç”Ÿæˆï¼š</p>
<pre><code class="language-sh">FROM envoyproxy/envoy:v1.11.0
MAINTAINER lijiaocn &lt;lijiaocn@foxmail.com&gt;

RUN apt-get update &amp;&amp; apt-get install -y iputils-ping curl iproute net-tools vim
</code></pre>
<p>è¿™ä¸ªé•œåƒæ¯”åŸå§‹çš„ envoy é•œåƒä½“ç§¯å¤§ï¼ŒåŒ…å«äº†ä¸€äº›è°ƒè¯•å·¥å…·ï¼Œé€‚ç”¨äºå¼€å‘è°ƒè¯•ï¼Œé•œåƒå·²ç»æäº¤åˆ° docker hubï¼Œå¯ä»¥ç›´æ¥æ‹‰å–ä½¿ç”¨ï¼š</p>
<pre><code class="language-sh">docker pull lijiaocn/envoy:v1.11.0
</code></pre>
<h2 id="æœ¬æ‰‹å†Œä½¿ç”¨çš„è¿è¡Œæ–¹å¼"><a class="header" href="#æœ¬æ‰‹å†Œä½¿ç”¨çš„è¿è¡Œæ–¹å¼">æœ¬æ‰‹å†Œä½¿ç”¨çš„è¿è¡Œæ–¹å¼</a></h2>
<p>Envoy å®¹å™¨çš„è¿è¡Œæ¨¡å¼æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰å–ï¼Œè¯¥æ‰‹å†Œæ˜¯åœ¨ mac ä¸Šç”¨é host æ¨¡å¼è¿è¡Œ envoy å®¹å™¨ï¼Œæ˜ å°„äº† 9901 å’Œ 80-86 ç«¯å£ã€‚</p>
<p>è¿è¡Œè„šæœ¬åœ¨ <a href="https://github.com/introclass/go-code-example/tree/master/envoydev/xds/envoy-docker-run" title="envoy-docker-run">go-code-example/envoydev/xds/envoy-docker-run</a> ä¸­ï¼Œç”¨ git è·å–ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/go-code-example.git
</code></pre>
<p>go-code-example ä¸­æœ‰å¤šä¸ªç›®å½•ï¼Œåˆ†åˆ«æ˜¯ä¸åŒé¡¹ç›®çš„è¯•éªŒç´ æï¼Œæœ¬æ‰‹å†Œä½¿ç”¨çš„ä»£ç å’Œè„šæœ¬ä½äº envoydev ä¸­ï¼š</p>
<pre><code class="language-sh">â–¾ envoydev/
  â–¾ xds/
    â–¾ envoy-docker-run/
      â–¸ log/
        envoy-0-default.yaml
        envoy-0-example.yaml
        envoy-1-ads-with-xds.yaml
        envoy-1-ads.yaml
        envoy-1-static.yaml
        envoy-1-xds.yaml
        envoy-to-grpc-svc.yaml
        run.sh*
      xds.go
    go.mod
    go.sum
    README.md
</code></pre>
<p>é€šè¿‡ run.sh å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€‰æ‹©ä¸€ä¸ªé…ç½®å¯åŠ¨ï¼Œä¾‹å¦‚ï¼š </p>
<pre><code class="language-sh">cd  go-code-example/envoydev/xds/envoy-docker-run/
./run.sh envoy-0-example.yaml
</code></pre>
<p>è¿è¡Œè„šæœ¬ run.sh çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">IMAGE=lijiaocn/envoy:v1.11.0
NAME=envoy-1.11.0

if  [ $# -ne 1 ];then
	echo &quot;must choose one config file&quot;
	exit 1
fi

config=$1

docker rm -f $NAME 2&gt;&amp;1 1&gt;/dev/null

if [ `uname`=&quot;Darwin&quot; ];then
	docker run -idt --name $NAME -p 9901:9901 -p 80-86:80-86 -v `pwd`/$config:/etc/envoy/envoy.yaml -v `pwd`/log:/var/log/envoy $IMAGE
else
	docker run -idt --name $NAME -e loglevel=debug --network=host -v `pwd`/$config:/etc/envoy/envoy.yaml -v `pwd`/log:/var/log/envoy $IMAGE
fi
</code></pre>
<h2 id="å‚è€ƒ-63"><a class="header" href="#å‚è€ƒ-63">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="ç”¨-echoserver-è§‚å¯Ÿä»£ç†è½¬å‘æ•ˆæœ"><a class="header" href="#ç”¨-echoserver-è§‚å¯Ÿä»£ç†è½¬å‘æ•ˆæœ">ç”¨ echoserver è§‚å¯Ÿä»£ç†/è½¬å‘æ•ˆæœ</a></h1>
<p>echoserver æ˜¯ä¸€ä¸ªå›æ˜¾ç”¨æˆ·è¯·æ±‚çš„ http æœåŠ¡ï¼Œç”¨æ¥è§‚å¯Ÿ http è¯·æ±‚çš„ä»£ç†/è½¬å‘æ•ˆæœéå¸¸æ–¹ä¾¿ã€‚</p>
<p>echoserver 1.10 ä¸æ”¯æŒ HTTP 2.0ã€‚</p>
<h2 id="å¯åŠ¨-echoserver-å®¹å™¨"><a class="header" href="#å¯åŠ¨-echoserver-å®¹å™¨">å¯åŠ¨ echoserver å®¹å™¨</a></h2>
<p>å‡†å¤‡ä¸€ä¸ª echoserver è§‚å¯Ÿ envoy è½¬å‘æ¥çš„è¯·æ±‚ï¼Œechoserver ç”¨é€”è§ <a href="envoy/../tools/http.html">HTTP åè®®ç›¸å…³çš„å·¥å…·</a>ã€‚</p>
<pre><code class="language-sh">$ docker run -idt --name echoserver -p 9090:8080 -p 9443:8443 googlecontainer/echoserver:1.10
</code></pre>
<h2 id="è·å–-echoserver-å®¹å™¨çš„-ip"><a class="header" href="#è·å–-echoserver-å®¹å™¨çš„-ip">è·å– echoserver å®¹å™¨çš„ IP</a></h2>
<p>å…ˆè·å– echoserver å®¹å™¨çš„ IP åœ°å€ï¼Œç¡®å®š envoy èƒ½å¤Ÿè®¿é—®è¿™ä¸ªåœ°å€ï¼š</p>
<pre><code class="language-sh"># echoserver æ˜¯å®¹å™¨çš„åå­—ï¼Œæ›¿æ¢æˆä½ è‡ªå·±çš„å®¹å™¨å
$ docker inspect echoserver -f &quot;{{.NetworkSettings.Networks.bridge.IPAddress}}&quot;
172.17.0.2
</code></pre>
<h2 id="é…ç½®-cluster"><a class="header" href="#é…ç½®-cluster">é…ç½® cluster</a></h2>
<p>è¯¥ç¤ºä¾‹ä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-0-example.yaml" title="envoy-0-example.yaml">envoy-0-example.yaml</a>ï¼Œåœ¨ static_resources: -&gt; clusters: ä¸­é…ç½®çš„æ˜¯ echoserver å®¹å™¨çš„åœ°å€ï¼Œæ³¨æ„å°† address æ›¿æ¢æˆä½ è‡ªå·±çš„ echoserver å®¹å™¨çš„ IPï¼š</p>
<pre><code class="language-yaml">- name: service_echo
  connect_timeout: 0.25s
  type: STATIC
  lb_policy: ROUND_ROBIN
  #http2_protocol_options: {}  # æ³¨æ„ echoserver ä¸æ”¯æŒhttp 2.0ï¼Œä¸èƒ½æœ‰è¿™é¡¹é…ç½®
  load_assignment:
    cluster_name: service_echo
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            socket_address:
              address:  172.17.0.2
              port_value: 8080
</code></pre>
<h2 id="é…ç½®-listener"><a class="header" href="#é…ç½®-listener">é…ç½® listener</a></h2>
<p>è¯¥ç¤ºä¾‹ä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-0-example.yaml" title="envoy-0-example.yaml">envoy-0-example.yaml</a>ï¼Œåœ¨ static_resources: -&gt; listeners: ä¸­é…ç½®çš„æ˜¯ listenerï¼Œè¿™ä¸ª listener ç›‘å¬ 80 ç«¯å£ï¼Œå°† host åŒ¹é… &quot;*&quot; å’Œ prefix åŒ¹é… &quot;/&quot; çš„è¯·æ±‚è½¬å‘ç»™ä¸Šé¢é…ç½®çš„ clusterï¼Œå¹¶ä¸”åœ¨è½¬å‘çš„æ—¶å€™å°† host ä¿®æ”¹ä¸º www.google.comï¼š</p>
<pre><code class="language-yaml">- name: listener_0
  address:
    socket_address:
      protocol: TCP
      address: 0.0.0.0
      port_value: 80
  filter_chains:
  - filters:
    - name: envoy.http_connection_manager
      typed_config:
        &quot;@type&quot;: type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
        stat_prefix: ingress_http
        route_config:
          name: local_route
          virtual_hosts:
          - name: local_service
            domains: [&quot;*&quot;]
            routes:
            - match:
                prefix: &quot;/&quot;
              route:
                host_rewrite: www.baidu.com
                cluster: service_echo
        http_filters:
        - name: envoy.router
</code></pre>
<h2 id="å¯åŠ¨è§‚å¯Ÿæ•ˆæœ"><a class="header" href="#å¯åŠ¨è§‚å¯Ÿæ•ˆæœ">å¯åŠ¨ï¼Œè§‚å¯Ÿæ•ˆæœ</a></h2>
<p>ä¸Šé¢çš„é…ç½®å·²ç»æ·»åŠ åˆ° <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-0-example.yaml" title="envoy-0-example.yaml">envoy-0-example.yaml</a> ä¸­ï¼Œç›´æ¥ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">$ ./run.sh envoy-0-example.yaml
</code></pre>
<p>è®¿é—® envoy çš„ 80 ç«¯å£ï¼Œæ•ˆæœå¦‚ä¸‹ï¼Œæ³¨æ„è§‚å¯Ÿ echoserver æ”¶åˆ°çš„è¯·æ±‚çš„ host æ˜¯ www.baidu.comï¼Œè¿™æ˜¯å› ä¸ºä¸Šé¢çš„é…ç½®é‡Œæœ‰ä¸€é¡¹ â€œhost_rewrite: www.baidu.comâ€ï¼š</p>
<pre><code>$ curl 127.0.0.1:80

Hostname: 7759cabd7402

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008

Request Information:
	client_address=172.17.0.3
	method=GET
	real path=/
	query=
	request_version=1.1
	request_scheme=http
	request_uri=http://www.baidu.com:8080/

Request Headers:
	accept=*/*
	content-length=0
	host=www.baidu.com     # echoserver æ”¶åˆ°çš„è¯·æ±‚çš„ host
	user-agent=curl/7.54.0
	x-envoy-expected-rq-timeout-ms=15000
	x-forwarded-proto=http
	x-request-id=957e0bd8-2fb1-4ff1-8131-f1fff1cb0e9a

Request Body:
	-no body in request-
</code></pre>
<h2 id="å‚è€ƒ-64"><a class="header" href="#å‚è€ƒ-64">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„é…ç½®æ–‡ä»¶æ ¼å¼"><a class="header" href="#envoy-çš„é…ç½®æ–‡ä»¶æ ¼å¼">Envoy çš„é…ç½®æ–‡ä»¶æ ¼å¼</a></h1>
<p>Envoy çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api/api">API æ–‡æ¡£</a> ä¸­ï¼Œåˆ†åˆ«ç»™å‡ºäº†æ¯ä¸ªé…ç½®é¡¹çš„æ ¼å¼ï¼Œ<a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/27/envoy-05-configfile.html">ã€ŠEnvoy Proxyä½¿ç”¨ä»‹ç»æ•™ç¨‹ï¼ˆäº”ï¼‰ï¼šenvoyçš„é…ç½®æ–‡ä»¶å®Œå…¨å±•å¼€ä»‹ç»ã€‹</a> å°† envoy 1.8.0  çš„å„ä¸ªé…ç½®é¡¹æ ¼å¼ç»„åˆäº†èµ·æ¥ï¼Œå‘ˆç°äº† envoy é…ç½®æ–‡ä»¶çš„å®Œæ•´è½®å»“ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{
  &quot;node&quot;: {
    &quot;id&quot;: &quot;...&quot;,
    &quot;cluster&quot;: &quot;...&quot;,
    &quot;metadata&quot;: &quot;{...}&quot;,
    &quot;locality&quot;: &quot;{...}&quot;,
    &quot;build_version&quot;: &quot;...&quot;
  },
  &quot;static_resources&quot;: {
    &quot;listeners&quot;: [],
    &quot;clusters&quot;: [],
    &quot;secrets&quot;: []
  },
  &quot;dynamic_resources&quot;: {
    &quot;lds_config&quot;: &quot;{...}&quot;,
    &quot;cds_config&quot;: &quot;{...}&quot;,
    &quot;ads_config&quot;: &quot;{...}&quot;
  },
  &quot;cluster_manager&quot;: {
    &quot;local_cluster_name&quot;: &quot;...&quot;,
    &quot;outlier_detection&quot;: &quot;{...}&quot;,
    &quot;upstream_bind_config&quot;: &quot;{...}&quot;,
    &quot;load_stats_config&quot;: &quot;{...}&quot;
  },
  &quot;hds_config&quot;: {
    &quot;api_type&quot;: &quot;...&quot;,
    &quot;cluster_names&quot;: [],
    &quot;grpc_services&quot;: [],
    &quot;refresh_delay&quot;: &quot;{...}&quot;,
    &quot;request_timeout&quot;: &quot;{...}&quot;,
    &quot;rate_limit_settings&quot;: &quot;{...}&quot;
  },
  &quot;flags_path&quot;: &quot;...&quot;,
  &quot;stats_sinks&quot;: [
    {
      &quot;name&quot;: &quot;...&quot;,
      &quot;config&quot;: &quot;{...}&quot;
    }
  ],
  &quot;stats_config&quot;: {
    &quot;stats_tags&quot;: [],
    &quot;use_all_default_tags&quot;: &quot;{...}&quot;,
    &quot;stats_matcher&quot;: &quot;{...}&quot;
  },
  &quot;stats_flush_interval&quot;: &quot;{...}&quot;,
  &quot;watchdog&quot;: {
    &quot;miss_timeout&quot;: &quot;{...}&quot;,
    &quot;megamiss_timeout&quot;: &quot;{...}&quot;,
    &quot;kill_timeout&quot;: &quot;{...}&quot;,
    &quot;multikill_timeout&quot;: &quot;{...}&quot;
  },
  &quot;tracing&quot;: {
    &quot;http&quot;: &quot;{...}&quot;
  },
  &quot;rate_limit_service&quot;: {
    &quot;grpc_service&quot;: &quot;{...}&quot;
  },
  &quot;runtime&quot;: {
    &quot;symlink_root&quot;: &quot;...&quot;,
    &quot;subdirectory&quot;: &quot;...&quot;,
    &quot;override_subdirectory&quot;: &quot;...&quot;
  },
  &quot;admin&quot;: {
    &quot;access_log_path&quot;: &quot;...&quot;,
    &quot;profile_path&quot;: &quot;...&quot;,
    &quot;address&quot;: &quot;{...}&quot;
  },
  &quot;overload_manager&quot;: {
    &quot;refresh_interval&quot;: &quot;{...}&quot;,
    &quot;resource_monitors&quot;: [],
    &quot;actions&quot;: []
  }
}
</code></pre>
<h2 id="æœ¬æ‰‹å†Œä¸­ç”¨åˆ°çš„å‡ ä¸ªé…ç½®æ–‡ä»¶"><a class="header" href="#æœ¬æ‰‹å†Œä¸­ç”¨åˆ°çš„å‡ ä¸ªé…ç½®æ–‡ä»¶">æœ¬æ‰‹å†Œä¸­ç”¨åˆ°çš„å‡ ä¸ªé…ç½®æ–‡ä»¶</a></h2>
<p><a href="https://github.com/introclass/go-code-example/tree/master/envoydev/xds/envoy-docker-run" title="envoy-docker-run">xds/envoy-docker-run</a>ï¼š</p>
<pre><code class="language-sh">â”‚Â Â  â”œâ”€â”€ envoy-0-default.yaml         # envoy å®¹å™¨ä¸­çš„é»˜è®¤é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-0-example.yaml         # åˆæ¬¡ä½“éªŒä½¿ç”¨çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-1-ads-with-xds.yaml    # æ¼”ç¤ºé…ç½®ä¸‹å‘æ—¶ç”¨çš„é…ç½®ï¼ŒåŒæ—¶é…ç½®äº† adsã€xds
â”‚Â Â  â”œâ”€â”€ envoy-1-ads.yaml             # åªä½¿ç”¨ ads å‘ç°é…ç½®çš„é…ç½® 
â”‚Â Â  â”œâ”€â”€ envoy-1-static.yaml          # å®Œå…¨é™æ€çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-1-xds.yaml             # åªä½¿ç”¨ ads å‘ç°é…ç½®çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-to-grpc-svc.yaml       # grpc ä»£ç†é…ç½®
</code></pre>
<p>envoy-0-default.yaml æ˜¯ envoy å®¹å™¨ä¸­çš„é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">admin:
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
      protocol: TCP
      address: 127.0.0.1
      port_value: 9901
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: 10000
    filter_chains:
    - filters:
      - name: envoy.http_connection_manager
        typed_config:
          &quot;@type&quot;: type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: [&quot;*&quot;]
              routes:
              - match:
                  prefix: &quot;/&quot;
                route:
                  host_rewrite: www.google.com
                  cluster: service_google
          http_filters:
          - name: envoy.router
  clusters:
  - name: service_google
    connect_timeout: 0.25s
    type: LOGICAL_DNS
    # Comment out the following line to test on v6 networks
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: service_google
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: www.google.com
                port_value: 443
    tls_context:
      sni: www.google.com
</code></pre>
<h2 id="å‚è€ƒ-65"><a class="header" href="#å‚è€ƒ-65">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„é™æ€é…ç½®ç¤ºä¾‹"><a class="header" href="#envoy-çš„é™æ€é…ç½®ç¤ºä¾‹">Envoy çš„é™æ€é…ç½®ç¤ºä¾‹</a></h1>
<p>ç›‘å¬è½¬å‘é…ç½®ï¼ˆlistenerã€clusterï¼‰å¯ä»¥é™æ€é…ç½®ä¹Ÿå¯ä»¥åŠ¨æ€è·å–ï¼Œé™æ€é…ç½®åœ¨ <code>static_resources</code> ä¸­ã€‚</p>
<p>è¿™é‡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ï¼š<a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-1-static.yaml" title="envoy-1-static.yaml">envoy-1-static.yaml</a>ï¼Œenvoy å¯åŠ¨å‘½ä»¤ä¸ºï¼š</p>
<pre><code class="language-sh">./run.sh envoy-1-static.yaml
</code></pre>
<h2 id="è½¬å‘åˆ°-ip"><a class="header" href="#è½¬å‘åˆ°-ip">è½¬å‘åˆ° IP</a></h2>
<p>åœ¨ clusters ä¸­é…ç½®äº†ä¸€ä¸ªåä¸º service_echo çš„ cluster ï¼Œå®ƒæŒ‡å‘ 172.17.0.2:8080ï¼Œè¿™æ˜¯ <a href="envoy/./echoserver.html">åˆæ¬¡ä½“éªŒ</a> ä¸­å¯åŠ¨çš„ echoserver å®¹å™¨çš„åœ°å€ï¼š</p>
<pre><code class="language-yaml">- name: service_echo
  connect_timeout: 0.25s
  type: static
  lb_policy: ROUND_ROBIN
  hosts:
    - socket_address:
        address:  172.17.0.2
        port_value: 8080
</code></pre>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ load_assignment çš„å½¢å¼ï¼š</p>
<pre><code class="language-yaml">- name: service_echo
  connect_timeout: 0.25s
  type: STATIC
  lb_policy: ROUND_ROBIN
  #http2_protocol_options: {}  #echoserverä¸æ”¯æŒhttp 2.0
  load_assignment:
    cluster_name: service_echo
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            socket_address:
              address:  172.17.0.2
              port_value: 8080
</code></pre>
<p>åœ¨ listeners ä¸­é…ç½®ä¸€ä¸ªåä¸º listener_0  çš„ listenerï¼Œå®ƒç›‘å¬ 80 ç«¯å£ï¼Œå°†åŒ¹é… &quot;Host: echo.com&quot; å’Œ &quot;/&quot; çš„è¯·æ±‚è½¬å‘ç»™ä¸Šé¢çš„ clusterï¼š</p>
<pre><code class="language-yaml">- name: listener_0
  address:
    socket_address:
      protocol: TCP
      address: 0.0.0.0
      port_value: 80
  filter_chains:
  - filters:
    - name: envoy.http_connection_manager
      config:
        stat_prefix: ingress_http
        generate_request_id: true
        route_config:
          name: local_route
          virtual_hosts:
          - name: local_service
            domains: [&quot;echo.com&quot;]
            routes:
            - match:
                prefix: &quot;/&quot;
              route:
                host_rewrite: echo.com
                cluster: service_echo
        http_filters:
        - name: envoy.router
          config:
            dynamic_stats: false
</code></pre>
<p>ç›´æ¥è®¿é—® listener_0ï¼Œä¸å¸¦ host æ—¶ï¼Œè¿”å› 404ï¼š</p>
<pre><code class="language-sh">$ curl -v  127.0.0.1:80
* Rebuilt URL to: 127.0.0.1:80/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 127.0.0.1
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 404 Not Found
&lt; date: Fri, 16 Aug 2019 11:50:13 GMT
&lt; server: envoy
&lt; content-length: 0
&lt;
* Connection #0 to host 127.0.0.1 left intact
</code></pre>
<p>å¸¦ä¸Š hostï¼Œè¿”å› echoserver çš„å“åº”ï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:80 -H &quot;Host: echo.com&quot;
Hostname: 7759cabd7402

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008

Request Information:
	client_address=172.17.0.3
	method=GET
	real path=/
	query=
	request_version=1.1
	request_scheme=http
	request_uri=http://echo.com:8080/

Request Headers:
	accept=*/*
	content-length=0
	host=echo.com
	user-agent=curl/7.54.0
	x-envoy-expected-rq-timeout-ms=15000
	x-forwarded-proto=http
	x-request-id=da973764-051b-409a-9a2b-5293158e83cd

Request Body:
	-no body in request-
</code></pre>
<h2 id="è½¬å‘åˆ°åŸŸå"><a class="header" href="#è½¬å‘åˆ°åŸŸå">è½¬å‘åˆ°åŸŸå</a></h2>
<p>é…ç½®ä¸€ä¸ªåä¸º service_baidu çš„ clusterï¼Œendpoint ä¸­å¡«å…¥åŸŸå www.baidu.comï¼š</p>
<pre><code class="language-yaml">- name: service_baidu
  connect_timeout: 0.25s
  type: LOGICAL_DNS
  dns_lookup_family: V4_ONLY
  lb_policy: ROUND_ROBIN
  load_assignment:
    cluster_name: service_baidu
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            socket_address:
              address: www.baidu.com
              port_value: 443
  tls_context:
    sni: www.baidu.com
</code></pre>
<p>ä¸Šé¢ä½¿ç”¨çš„ç±»å‹ä¸º LOGICAL_DNSï¼Œä¼šä½¿ç”¨åŸŸåè§£æè¿”å›çš„ç¬¬ä¸€ä¸ª IPï¼Œå¦‚æœæ˜¯ STRICT_DNSï¼Œåˆ™ä½¿ç”¨åŸŸåè§£æè¿”å›çš„æ‰€æœ‰ IPï¼Œæ›´å¤šç±»å‹è§ <a href="envoy/./cluster.html#cluster-%E7%9A%84%E7%B1%BB%E5%9E%8B">Cluster çš„ç±»å‹</a>ã€‚</p>
<p>é…ç½®ä¸€ä¸ª listener ç›‘å¬ 81 ç«¯å£ï¼Œå°†æ‰€æœ‰è¯·æ±‚è½¬å‘åˆ° www.baidu.comï¼Œè½¬å‘æ—¶å°† host æ”¹å†™ä¸º &quot;www.baidu.com&quot;ï¼š</p>
<pre><code class="language-yaml">- name: listener_1
  address:
    socket_address:
      protocol: TCP
      address: 0.0.0.0
      port_value: 81
  filter_chains:
  - filters:
    - name: envoy.http_connection_manager
      typed_config:
        &quot;@type&quot;: type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
        stat_prefix: ingress_http
        route_config:
          name: local_route
          virtual_hosts:
          - name: local_service
            domains: [&quot;*&quot;]
            routes:
            - match:
                prefix: &quot;/&quot;
              route:
                host_rewrite: www.baidu.com
                cluster: service_baidu
        http_filters:
        - name: envoy.router
</code></pre>
<p>è®¿é—® 127.0.0.1:81ï¼Œæ— è®º host æ˜¯å¤šå°‘ï¼Œéƒ½è½¬å‘åˆ° www.baidu.comï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:81
...
&lt;title&gt;ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“&lt;/title&gt;
...
</code></pre>
<p>æ³¨æ„ï¼šenvoy è§£æ www.baidu.com åŸŸåéœ€è¦ä¸€å®šæ—¶é—´ï¼Œåœ¨ envoy åˆšå¯åŠ¨ã€www.baidu.com åŸŸåè§£ææœªå®Œæˆæ—¶ï¼Œä¼šè¿”å› 503ã€‚</p>
<h2 id="å‚è€ƒ-66"><a class="header" href="#å‚è€ƒ-66">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„åŠ¨æ€é…ç½®"><a class="header" href="#envoy-çš„åŠ¨æ€é…ç½®">Envoy çš„åŠ¨æ€é…ç½®</a></h1>
<p>Listenerã€Cluster ç­‰é™¤äº†åœ¨é…ç½®æ–‡ä»¶ä¸­é™æ€é…ç½®ï¼Œè¿˜å¯ä»¥ä»æ§åˆ¶å¹³é¢åŠ¨æ€è·å–ã€‚ä¸‹å‘åŠ¨æ€é…ç½®çš„æœåŠ¡å«åš <strong>æ§åˆ¶å¹³é¢</strong> ï¼Œå®ƒçš„åœ°å€ä»¥ cluster çš„å½¢å¼åœ¨é…ç½®æ–‡ä»¶ä¸­é™æ€é…ç½®ï¼Œç„¶ååœ¨ dynamic_resources ä¸­å¼•ç”¨è¿™ä¸ª clusterã€‚</p>
<p>å¯ä»¥åŠ¨æ€ä¸‹å‘çš„é…ç½®è§ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/intro/arch_overview/operations/dynamic_configuration" title="Dynamic configuration">Dynamic configuration</a>ï¼Œä¸»è¦æœ‰ï¼š</p>
<p>CDSï¼šcluster é…ç½®åŠ¨æ€ä¸‹å‘</p>
<p>LDSï¼šlistener é…ç½®åŠ¨æ€ä¸‹å‘</p>
<p>EDSï¼šcluster ä¸­çš„ endpoint çš„åŠ¨æ€ä¸‹å‘</p>
<p>RDSï¼šlistener ä¸­çš„ route çš„åŠ¨æ€ä¸‹å‘</p>
<p>SDSï¼šè¯ä¹¦çš„åŠ¨æ€ä¸‹å‘</p>
<p>å…¶ä¸­åªæœ‰ CDS å’Œ LDS çš„å‘ç°åœ°å€æ˜¯åœ¨ dynamic_resources ä¸­æŒ‡å®šçš„ï¼Œåé¢æœ‰è¯¦ç»†è¯´æ˜ã€‚</p>
<h2 id="å‡†å¤‡ä¸€ä¸ªæ§åˆ¶å¹³é¢"><a class="header" href="#å‡†å¤‡ä¸€ä¸ªæ§åˆ¶å¹³é¢">å‡†å¤‡ä¸€ä¸ªæ§åˆ¶å¹³é¢</a></h2>
<p><a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/xds.go" title="xds/xds.go">xds/xds.go</a> æ˜¯ä¸€ä¸ªéå¸¸ç®€é™‹çš„æ§åˆ¶å¹³é¢çš„å®ç°ï¼Œå®ƒçš„ä»£ç å®ç°åœ¨ <a href="envoy/./control.html">æ§åˆ¶å¹³é¢å®ç°</a> ç« èŠ‚è¯¦ç»†ä»‹ç»ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å®ƒæ—¢å¯ä»¥ä½œä¸º xds ä¹Ÿå¯ä»¥ä½œä¸º adsã€‚</p>
<p>è¿™ä¸ªç®€é™‹çš„æ§åˆ¶å¹³é¢çš„ç›‘å¬åœ°å€æ˜¯ 0.0.0.0:5678ï¼Œå®ƒåªä¸‹å‘äº†ä¸‹é¢è¿™ä¸ª envoy çš„é…ç½®ï¼š</p>
<pre><code class="language-go">node := &amp;core.Node{
	Id:      &quot;envoy-64.58&quot;,
	Cluster: &quot;test&quot;,
}
</code></pre>
<p>é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨åŒæ ·çš„ ID å’Œ Cluster çš„ envoy æ‰ä¼šæ¥å—è¿™ä¸ªæ§åˆ¶å¹³é¢ä¸‹å‘çš„é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„ envoy é…ç½®æ–‡ä»¶ä¸­éƒ½ä½¿ç”¨è¿™ä¸ª Id å’Œ Clusterï¼š</p>
<pre><code class="language-yaml">node:
  id: &quot;envoy-64.58&quot;
  cluster: &quot;test&quot;
</code></pre>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/go-code-example.git
cd go-code-example/envoydev/xds/
$ ./xds
Enter to update version 1: Cluster_With_Static_Endpoint
&lt;é”®å…¥å›è½¦ç¬¦ï¼Œå°±å¼€å§‹ä¸‹å‘æ‰€ç¤ºçš„é…ç½®&gt;
</code></pre>
<h2 id="å‚è€ƒ-67"><a class="header" href="#å‚è€ƒ-67">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-ç”¨-xds-åŠ¨æ€å‘ç°é…ç½®çš„æ–¹æ³•"><a class="header" href="#envoy-ç”¨-xds-åŠ¨æ€å‘ç°é…ç½®çš„æ–¹æ³•">envoy ç”¨ XDS åŠ¨æ€å‘ç°é…ç½®çš„æ–¹æ³•</a></h1>
<p>è¿™é‡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-1-xds.yaml" title="envoy-1-xds.yaml">envoy-docker-run/envoy-1-xds.yaml</a>ã€‚</p>
<h2 id="é…ç½®-xds-çš„åœ°å€"><a class="header" href="#é…ç½®-xds-çš„åœ°å€">é…ç½® XDS çš„åœ°å€</a></h2>
<p>é¦–å…ˆåœ¨é…ç½®æ–‡ä»¶ä¸­é™æ€é…ç½®æ§åˆ¶å¹³é¢çš„åœ°å€ï¼Œåœ°å€ä¸ºç®€é™‹æ§åˆ¶å¹³é¢çš„æœåŠ¡åœ°å€ï¼Œæ³¨æ„å°†åœ°å€ä¿®æ”¹ä½ è‡ªå·±çš„ç¯å¢ƒä¸­çš„åœ°å€ï¼š</p>
<pre><code class="language-yaml">static_resources:
  clusters:
  - name: xds_cluster
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                #address: 127.0.0.1
                address: 192.168.99.1
                port_value: 5678
</code></pre>
<h2 id="é…ç½®-cds_config-å’Œ-lds_config"><a class="header" href="#é…ç½®-cds_config-å’Œ-lds_config">é…ç½® cds_config å’Œ lds_config</a></h2>
<p>ç„¶ååœ¨ cds_config å’Œ lds_config ä¸­å¼•ç”¨å‰é¢çš„é…ç½®çš„ xds_clusterï¼š</p>
<pre><code class="language-yaml">dynamic_resources:
  cds_config:
    api_config_source:
      api_type: GRPC
      grpc_services:
        envoy_grpc:
          cluster_name: xds_cluster
  lds_config:
    api_config_source:
      api_type: GRPC
      grpc_services:
        envoy_grpc:
          cluster_name: xds_cluster
</code></pre>
<h2 id="è¿è¡Œæ•ˆæœ"><a class="header" href="#è¿è¡Œæ•ˆæœ">è¿è¡Œæ•ˆæœ</a></h2>
<p>å¯åŠ¨ envoyï¼š</p>
<pre><code class="language-sh">./run.sh envoy-1-xds.yaml
</code></pre>
<p>æ§åˆ¶å¹³é¢æœªå¯åŠ¨çš„æ—¶å€™ï¼Œenvoy æŠ¥å‘Šè¿ä¸ä¸Šæ§åˆ¶å¹³é¢ï¼š</p>
<pre><code class="language-sh">$ docker logs -f envoy-1.11.0
...
[2019-09-02 07:51:44.811][1][warning][config] [bazel-out/k8-opt/bin/source/common/config/_virtual_includes/grpc_stream_lib/common/config/grpc_stream.h:87] gRPC config stream closed: 14, upstream connect error or disconnect/reset before headers. reset reason: connection failure
...
</code></pre>
<p>å¯åŠ¨æ§åˆ¶å¹³é¢ï¼Œä¸‹å‘ç¬¬ä¸€ä¸ªé…ç½®ï¼š</p>
<pre><code class="language-sh">$ ./xds
Enter to update version 1: Cluster_With_Static_Endpoint
ok
</code></pre>
<p>envoy è¿™æ—¶æ‰“å°ä¸‹é¢çš„æ—¥å¿—ï¼š</p>
<pre><code class="language-sh">$ docker logs -f envoy-1.11.0
...
[2019-09-02 08:00:33.216][1][info][upstream] [source/common/upstream/cluster_manager_impl.cc:495] add/update cluster Cluster_With_Static_Endpoint starting warming
[2019-09-02 08:00:33.216][1][info][upstream] [source/common/upstream/cluster_manager_impl.cc:507] warming cluster Cluster_With_Static_Endpoint complete
...
</code></pre>
<p>æ‰“å¼€ envoy çš„ admin é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°åŠ¨æ€ä¸‹å‘çš„ cluster_With_Static_Endpointï¼š</p>
<p><img src="envoy/../img/envoy/static-cluster.png" alt="cluster_With_Static_Endpoint" /></p>
<h2 id="å‚è€ƒ-68"><a class="header" href="#å‚è€ƒ-68">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-ç”¨-ads-åŠ¨æ€å‘ç°é…ç½®çš„æ–¹æ³•"><a class="header" href="#envoy-ç”¨-ads-åŠ¨æ€å‘ç°é…ç½®çš„æ–¹æ³•">envoy ç”¨ ADS åŠ¨æ€å‘ç°é…ç½®çš„æ–¹æ³•</a></h1>
<p>è¿™é‡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-1-ads.yaml" title="envoy-1-ads.yaml">envoy-docker-run/envoy-1-ads.yaml</a>ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-ads-"><a class="header" href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-ads-">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ADS ï¼Ÿ</a></h2>
<p>cds_config å’Œ lds_config æ˜¯åˆ†å¼€çš„ï¼Œè¿™æ„å‘³ç€ cluster å’Œ listener é…ç½®å¯ä»¥ä»ä¸åŒçš„æ§åˆ¶å¹³é¢è·å–ï¼Œè¿™æ ·ä¼šé‡åˆ°é…ç½®ä¸åŒæ­¥çš„é—®é¢˜ï¼Œå³ä½¿å®ƒä»¬ç”¨çš„æ˜¯åŒä¸€ä¸ªæ§åˆ¶å¹³é¢ä¹Ÿå¯èƒ½å› ä¸ºåˆ°è¾¾æ¬¡åºä¸åŒè€Œä¸åŒæ­¥ã€‚</p>
<p>è­¬å¦‚ listenerA ä¸­ä½¿ç”¨äº† clusterAï¼Œä½†æ˜¯ listenerA çš„é…ç½®å¯èƒ½åœ¨ clusterA ä¹‹å‰ä¸‹å‘åˆ° envoy ï¼Œä½¿ envoy è®¤ä¸º listenerA ä½¿ç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨çš„ clusterAã€‚</p>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/overview/v2_overview#aggregated-discovery-service" title="ADS">ADS</a> æ”¯æŒæ‰€æœ‰ç±»å‹åŠ¨æ€é…ç½®çš„ä¸‹å‘ï¼Œå¹¶ä¸”ä¼šå¤„ç†é…ç½®é—´çš„ä¾èµ–ï¼Œä¿è¯é…ç½®çš„ä¸‹å‘é¡ºåºï¼Œæ˜¯ä¼˜å…ˆé€‰ç”¨çš„é…ç½®å‘ç°æ–¹æ³•ï¼Œå®ç°åŸç†è§é…ç½®ä¸‹å‘åè®®çš„è¯´æ˜ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/api-docs/xds_protocol#eventual-consistency-considerations" title="xDS REST and gRPC protocol">xDS REST and gRPC protocol</a>ã€‚</p>
<h2 id="é…ç½®-ads-åœ°å€"><a class="header" href="#é…ç½®-ads-åœ°å€">é…ç½® ADS åœ°å€</a></h2>
<p>é¦–å…ˆé…ç½® ADS çš„åœ°å€ï¼ŒADS åœ°å€çš„é…ç½®æ–¹å¼ä¸ XDS ç›¸åŒï¼Œéƒ½æ˜¯ä»¥ cluster å½¢å¼åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š</p>
<pre><code class="language-yaml">static_resources:
  clusters:
  - name: ads_cluster
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: ads_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 5678
</code></pre>
<h2 id="é…ç½®-ads_config"><a class="header" href="#é…ç½®-ads_config">é…ç½® ads_config</a></h2>
<p>ç„¶åé…ç½® ads_configï¼Œåœ¨ ads_config ä¸­å¼•ç”¨ä¸Šé¢é…ç½®çš„ ads_clusterï¼Œå¦å¤– cds_config å’Œ  lds_config è®¾ç½®æˆ ads æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml">dynamic_resources:
  ads_config:
    api_type: GRPC
    grpc_services:
      envoy_grpc:
        cluster_name: ads_cluster
  cds_config: {ads: {}}
  lds_config: {ads: {}}
</code></pre>
<h2 id="è¿è¡Œæ•ˆæœ-1"><a class="header" href="#è¿è¡Œæ•ˆæœ-1">è¿è¡Œæ•ˆæœ</a></h2>
<p>é™¤äº†å¯åŠ¨ envoy æ—¶ç”¨ envoy-1-ads.yaml æ–‡ä»¶ï¼Œè¿‡ç¨‹ä¸ <a href="envoy/./xds.html#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C">ç”¨ XDS ä¸‹å‘é…ç½®</a> ç›¸åŒï¼š</p>
<pre><code class="language-sh">./run.sh envoy-1-ads.yaml
</code></pre>
<h2 id="å‚è€ƒ-69"><a class="header" href="#å‚è€ƒ-69">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„-ldscdsrdssdseds"><a class="header" href="#envoy-çš„-ldscdsrdssdseds">envoy çš„ lds/cds/rds/sds/eds</a></h1>
<p>dynamic_resources é…ç½®ä¸­åªæœ‰ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/listeners/lds.html" title="LDS">lds_config</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/cluster_manager/cds.html" title="CDS">cds_config</a> å’Œ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/overview/v2_overview#aggregated-discovery-service" title="ADS">ads_config</a>ï¼Œåˆ†åˆ«å¯¹åº” listenterã€cluster å’Œèšåˆå‘ç°ï¼š</p>
<pre><code class="language-json">&quot;dynamic_resources&quot;: {
  &quot;lds_config&quot;: &quot;{...}&quot;,
  &quot;cds_config&quot;: &quot;{...}&quot;,
  &quot;ads_config&quot;: &quot;{...}&quot;
},
</code></pre>
<p>ä½†å¯ä»¥åŠ¨æ€ä¸‹å‘çš„é…ç½®ä¸åªæœ‰ listener å’Œ clusterã€‚</p>
<p>cluster ä¸­çš„ endpointã€tls ç”¨åˆ°çš„ secretã€HttpConnectionManager ä¸­ç”¨åˆ° route ä¹Ÿå¯ä»¥åŠ¨æ€ä¸‹å‘ï¼Œå¯¹åº”çš„å‘ç°æœåŠ¡åˆ†åˆ«æ˜¯ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/intro/arch_overview/operations/dynamic_configuration#arch-overview-dynamic-config-eds" title="EDS">eds</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/secret.html" title="Secret discovery service (SDS)">sds</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/http_conn_man/rds.html" title="Route discovery service (RDS)">rds</a>ã€‚è¿™äº›å‘ç°æœåŠ¡ä¸åœ¨ dynamic_resources ä¸­é…ç½®ï¼Œè€Œæ˜¯ç‹¬ç«‹é…ç½®æˆ–è€…åœ¨ç”¨åˆ°å®ƒä»¬çš„ filter ä¸­é…ç½®ã€‚</p>
<h2 id="rds-çš„é…ç½®"><a class="header" href="#rds-çš„é…ç½®">RDS çš„é…ç½®</a></h2>
<p>ä»¥ HttpConnectionManager ä¸ºä¾‹ã€‚</p>
<p>HttpConnectionManager æ˜¯ä¸€ä¸ªå¤„ç† http è¯·æ±‚çš„ filterï¼Œå®ƒç”¨åˆ°çš„ http è·¯ç”±å¯ä»¥ä» rds ä¸­åŠ¨æ€å‘ç°ï¼Œrds å°±åœ¨è¿™ä¸ª filter ä¸­æŒ‡å®šã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ç®€é™‹æ§åˆ¶å¹³é¢ä¸­ä¸€æ®µä»£ç ï¼Œå¯ä»¥çœ‹åˆ° <code>Rds</code> å­—æ®µé…ç½®çš„ç±»å‹æ˜¯ Adsï¼Œhttp è·¯ç”±å°†ä» ads_cluster ä¸­è·å–ï¼š</p>
<pre><code class="language-go">listen_filter_http_conn_ := &amp;http_conn_manager.HttpConnectionManager{
    StatPrefix: &quot;ingress_http&quot;,
    RouteSpecifier: &amp;http_conn_manager.HttpConnectionManager_Rds{
        Rds: &amp;http_conn_manager.Rds{
            RouteConfigName: &quot;ads_route&quot;,
            ConfigSource: &amp;core.ConfigSource{
                ConfigSourceSpecifier: &amp;core.ConfigSource_Ads{
                    Ads: &amp;core.AggregatedConfigSource{}, //ä½¿ç”¨ADS
                },
            },
        },
    },
    ...
}
</code></pre>
<p>ç±»ä¼¼äº ADS æ–¹å¼ä¸­çš„ cds_config å’Œ lds_configï¼š</p>
<pre><code class="language-yaml">dynamic_resources:
  ads_config:
    api_type: GRPC
    grpc_services:
      envoy_grpc:
        cluster_name: ads_cluster
  cds_config: {ads: {}}
  lds_config: {ads: {}}
</code></pre>
<h2 id="å‚è€ƒ-70"><a class="header" href="#å‚è€ƒ-70">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„æ§åˆ¶å¹³é¢çš„å®ç°"><a class="header" href="#envoy-çš„æ§åˆ¶å¹³é¢çš„å®ç°">Envoy çš„æ§åˆ¶å¹³é¢çš„å®ç°</a></h1>
<p>å¯ä»¥åŠ¨æ€ä¸‹å‘çš„é…ç½®æœ‰ï¼š</p>
<ul>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cds.proto#cluster" title="cluster">cluster</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cds.proto#cluster" title="cluster">cluster</a> ä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/endpoint/endpoint.proto" title="endpoint.proto">endpoint</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#listener" title="listener">listener</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#listener" title="listener">listener</a> çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/network/network" title="network filter">Network filter</a> ä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#envoy-api-msg-config-filter-network-http-connection-manager-v2-httpconnectionmanager" title="HTTP Connection Manager">HTTP connection manager</a> ä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#route-virtualhost" title="route-virtualhost">Virtualhost</a> ä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/rds.proto#envoy-api-msg-routeconfiguration" title="routeconfiguration">RouteConfiguration</a> ä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto" title="route.proto">route</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/auth/cert.proto#envoy-api-msg-auth-secret" title="secret">serect</a></li>
</ul>
<p>å¯¹åº”çš„æœåŠ¡ç«¯åˆ†åˆ«ç§°ä¸º <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/cluster_manager/cds.html" title="CDS">cds</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/lds.html" title="LDS">lds</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_conn_man/rds.html" title="Route discovery service (RDS)">rds</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/secret.html" title="SDS">sds</a> ã€‚</p>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/go-code-example.git
</code></pre>
<h2 id="ä¸‹å‘åè®®"><a class="header" href="#ä¸‹å‘åè®®">ä¸‹å‘åè®®</a></h2>
<p><a href="https://github.com/envoyproxy/data-plane-api" title="envoyproxy/data-plane-api">envoyproxy/data-plane-api</a> å®šä¹‰äº† envoy çš„ REST API å’Œé…ç½®ä¸‹å‘æ—¶ä½¿ç”¨çš„é€šä¿¡åè®® <a href="https://www.envoyproxy.io/docs/envoy/latest/api-docs/xds_protocol" title="xDS REST and gRPC protocol">xDS REST and gRPC protocol</a>ï¼ŒåŒæ—¶ Envoy å¼€æºäº†ä¸€ä¸ªæ§åˆ¶å±‚é¢çš„å¼€å‘æ¡†æ¶ <a href="https://github.com/envoyproxy/go-control-plane" title="envoyproxy/go-control-plane">envoyproxy/go-control-plane</a>ï¼Œä½¿ç”¨è¯¥æ¡†æ¶å¯ä»¥å¿«é€Ÿå¼€å‘ä¸€ä¸ªæ§åˆ¶å¹³é¢ï¼ˆä¹Ÿå°±æ˜¯ xDS æœåŠ¡ï¼‰ï¼Œæ¡†æ¶å·²ç»å®ç°äº†é€šä¿¡è¿‡ç¨‹ï¼Œä¸éœ€è¦è‡ªè¡Œå®ç°é€šä¿¡åè®®ã€‚</p>
<h2 id="å‚è€ƒ-71"><a class="header" href="#å‚è€ƒ-71">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="åŠ¨æ€é…ç½®åœ¨-go-control-plane-ä¸­çš„å®šä¹‰"><a class="header" href="#åŠ¨æ€é…ç½®åœ¨-go-control-plane-ä¸­çš„å®šä¹‰">åŠ¨æ€é…ç½®åœ¨ go-control-plane ä¸­çš„å®šä¹‰</a></h1>
<p><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/12/29/envoy-07-features-2-dynamic-discovery.html#go-control-plane">go-control-plane</a> ä¸­çš„é…ç½®å®šä¹‰ä¸ <a href="https://www.envoyproxy.io/docs/envoy/latest/api/api">API æ–‡æ¡£</a> ä¸­ç»™å‡ºçš„ç›¸åŒï¼Œä»¥ listener ä¸ºä¾‹ï¼š</p>
<p>api æ–‡æ¡£ä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#listener" title="listener">listeners</a> ï¼š</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;address&quot;: &quot;{...}&quot;,
  &quot;filter_chains&quot;: [],
  &quot;use_original_dst&quot;: &quot;{...}&quot;,
  &quot;per_connection_buffer_limit_bytes&quot;: &quot;{...}&quot;,
  &quot;metadata&quot;: &quot;{...}&quot;,
  &quot;drain_type&quot;: &quot;...&quot;,
  &quot;listener_filters&quot;: [],
  &quot;listener_filters_timeout&quot;: &quot;{...}&quot;,
  &quot;transparent&quot;: &quot;{...}&quot;,
  &quot;freebind&quot;: &quot;{...}&quot;,
  &quot;socket_options&quot;: [],
  &quot;tcp_fast_open_queue_length&quot;: &quot;{...}&quot;,
  &quot;traffic_direction&quot;: &quot;...&quot;
}
</code></pre>
<p>å¯¹åº” go-control-plane åœ¨ <a href="https://github.com/envoyproxy/go-control-plane/blob/v0.8.4/envoy/api/v2/lds.pb.go">envoy/api/v2/lds.pb.go</a> ä¸­å®ç°çš„ Listenerï¼š</p>
<pre><code class="language-go">type Listener struct {
    Name string 
    Address *core.Address 
    FilterChains []*listener.FilterChain 
    UseOriginalDst *types.BoolValue  
    PerConnectionBufferLimitBytes *types.UInt32Value 
    Metadata *core.Metadata 
    DeprecatedV1 *Listener_DeprecatedV1 
    DrainType Listener_DrainType 
    ListenerFilters []*listener.ListenerFilter 
    ListenerFiltersTimeout *time.Duration 
    Transparent *types.BoolValue 
    Freebind *types.BoolValue 
    SocketOptions []*core.SocketOption 
    TcpFastOpenQueueLength *types.UInt32Value 
    XXX_NoUnkeyedLiteral   struct{}           
    XXX_unrecognized       []byte             
    XXX_sizecache          int32              
}
</code></pre>
<h2 id="å‚è€ƒ-72"><a class="header" href="#å‚è€ƒ-72">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="go-control-plane-çš„åŸºæœ¬ç”¨æ³•"><a class="header" href="#go-control-plane-çš„åŸºæœ¬ç”¨æ³•">go-control-plane çš„åŸºæœ¬ç”¨æ³•</a></h1>
<p><a href="https://github.com/envoyproxy/go-control-plane" title="go-control-plane">go-control-plane</a> æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæä¾›äº†é…ç½®ä¸‹å‘æ¥å£ï¼Œåœ¨å®ƒçš„åŸºç¡€ä¸Šæ ¹æ®è‡ªå·±çš„éœ€è¦å¼€å‘å…¶å®ƒåŠŸèƒ½ã€‚</p>
<p>è¿™é‡Œç®€å•è¯´æ˜ä¸‹ç”¨æ³•ï¼Œä¸‹ä¸€èŠ‚æœ‰è¯¦ç»†çš„ä¾‹å­ï¼Œæ³¨æ„ <strong>åŠ¨æ€é…ç½®ä¸ envoy çš„é…å¯¹</strong> çš„æ–¹æ³•ã€‚</p>
<h2 id="å‡†å¤‡å¼€å‘ç¯å¢ƒ"><a class="header" href="#å‡†å¤‡å¼€å‘ç¯å¢ƒ">å‡†å¤‡å¼€å‘ç¯å¢ƒ</a></h2>
<p>ç”¨ <a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2019/05/05/go-modules.html" title="Go Modulesï¼šGo 1.11å’Œ1.12å¼•å…¥çš„ä¾èµ–åŒ…ç®¡ç†æ–¹æ³•">go mod</a> å¼•ç”¨ go-control-planeï¼š</p>
<pre><code class="language-sh">mkdir envoydev 
cd envoydev
go mod init github.com/introclass/go-code-example/envoydev
go get github.com/envoyproxy/go-control-plane@v0.8.3
</code></pre>
<h2 id="ä½¿ç”¨ç¤ºä¾‹"><a class="header" href="#ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</a></h2>
<p>go-control-plane ä¸­ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒsnapshotCache ä¸­å­˜æ”¾è¦ä¸‹å‘é…ç½®ï¼Œå°†é€šè¿‡å®ƒåˆ›å»ºçš„ server ä¸ grpcServer ç»‘å®šã€‚envoy é€šè¿‡ grpc æœåŠ¡è·å–é…ç½®ï¼š </p>
<pre><code class="language-go">import (
    &quot;net&quot;

    api &quot;github.com/envoyproxy/go-control-plane/envoy/api/v2&quot;
    discovery &quot;github.com/envoyproxy/go-control-plane/envoy/service/discovery/v2&quot;
    &quot;github.com/envoyproxy/go-control-plane/pkg/cache&quot;
    xds &quot;github.com/envoyproxy/go-control-plane/pkg/server&quot;
)

func main() {
    snapshotCache := cache.NewSnapshotCache(false, hash{}, nil)
    server := xds.NewServer(snapshotCache, nil)
    grpcServer := grpc.NewServer()
    lis, _ := net.Listen(&quot;tcp&quot;, &quot;:8080&quot;)

    discovery.RegisterAggregatedDiscoveryServiceServer(grpcServer, server)
    api.RegisterEndpointDiscoveryServiceServer(grpcServer, server)
    api.RegisterClusterDiscoveryServiceServer(grpcServer, server)
    api.RegisterRouteDiscoveryServiceServer(grpcServer, server)
    api.RegisterListenerDiscoveryServiceServer(grpcServer, server)
    go func() {
        if err := grpcServer.Serve(lis); err != nil {
            // error handling
        }
    }()
}
</code></pre>
<h2 id="åŠ¨æ€é…ç½®ä¸-envoy-çš„é…å¯¹"><a class="header" href="#åŠ¨æ€é…ç½®ä¸-envoy-çš„é…å¯¹">åŠ¨æ€é…ç½®ä¸ envoy çš„é…å¯¹</a></h2>
<p>åŠ¨æ€é…ç½®æ˜¯å…³è”åˆ° envoy çš„ ï¼Œæ¯ä¸ª envoy çš„åŠ¨æ€é…ç½®éƒ½è¦å•ç‹¬ç»´æŠ¤ã€‚</p>
<p>åœ¨ envoy çš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€æ®µ node é…ç½®ï¼Œæ ‡æ³¨äº†å½“å‰ envoy æ‰€å±çš„ cluster å’Œ idï¼Œenvoy åªæ¥å—ä½¿ç”¨åŒæ ·çš„ cluster å’Œ id çš„åŠ¨æ€é…ç½®ï¼š</p>
<pre><code class="language-yaml">node:
  id: &quot;envoy-64.58&quot;
  cluster: &quot;test&quot;
...
</code></pre>
<p>ä½¿ç”¨ go-control-plane å®ç°çš„æ§åˆ¶å¹³é¢è¦ä¸ºæ¯ä¸ª envoy å®ä¾‹ç»´æŠ¤ä¸€ä»½é…ç½®ï¼š</p>
<pre><code class="language-go">node := &amp;core.Node{
    Id:      &quot;envoy-64.58&quot;,
    Cluster: &quot;test&quot;,
}

node_config := &amp;NodeConfig{
    node:      node,
    endpoints: []cache.Resource{}, //[]*api_v2.ClusterLoadAssignment
    clusters:  []cache.Resource{}, //[]*api_v2.Cluster
    routes:    []cache.Resource{}, //[]*api_v2.RouteConfiguration
    listeners: []cache.Resource{}, //[]*api_v2.Listener
}
</code></pre>
<h2 id="å‚è€ƒ-73"><a class="header" href="#å‚è€ƒ-73">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="go-control-plane-ä¸‹å‘é…ç½®ç¤ºä¾‹ç¯å¢ƒå‡†å¤‡"><a class="header" href="#go-control-plane-ä¸‹å‘é…ç½®ç¤ºä¾‹ç¯å¢ƒå‡†å¤‡">go-control-plane ä¸‹å‘é…ç½®ç¤ºä¾‹â€”ç¯å¢ƒå‡†å¤‡</a></h1>
<p>è¿™é‡Œæ¼”ç¤ºä¸€ä¸ªç”¨ go-control-plane ä¸‹å‘é…ç½®çš„ä¾‹å­ã€‚</p>
<p>æ¼”ç¤ºç”¨çš„ä»£ç å’Œé…ç½®æ–‡ä»¶ä½äºï¼š<a href="https://github.com/introclass/go-code-example/tree/master/envoydev/xds" title="github.com/introclass/go-code-example/envoydev/xds">github.com/introclass/go-code-example/envoydev/xds</a>ã€‚xds.go æ˜¯ç”¨ go-controle-plane å®ç°çš„ç®€é™‹æ§åˆ¶å¹³é¢ï¼Œenvoy-docker-run ç›®å½•ä¸­æ˜¯å¯åŠ¨ envoy å®¹å™¨çš„æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">â”œâ”€â”€ envoy-docker-run
â”‚Â Â  â”œâ”€â”€ envoy-0-default.yaml
â”‚Â Â  â”œâ”€â”€ envoy-1-ads-with-xds.yaml
â”‚Â Â  â”œâ”€â”€ envoy-1-ads.yaml
â”‚Â Â  â”œâ”€â”€ envoy-1-static.yaml
â”‚Â Â  â”œâ”€â”€ envoy-1-xds.yaml
â”‚Â Â  â”œâ”€â”€ envoy-to-grpc-svc.yaml
â”‚Â Â  â”œâ”€â”€ log
â”‚Â Â  â”‚Â Â  â””â”€â”€ admin_access.log
â”‚Â Â  â””â”€â”€ run.sh
â””â”€â”€ xds.go
</code></pre>
<h2 id="å¯åŠ¨-envoy"><a class="header" href="#å¯åŠ¨-envoy">å¯åŠ¨ envoy</a></h2>
<p>envoy å¯åŠ¨æ—¶ä½¿ç”¨ç”¨é…ç½®æ–‡ä»¶ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-1-ads-with-xds.yaml" title="envoy-1-ads-with-xds.yaml">envoy-1-ads-with-xds.yaml</a>ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­</p>
<pre><code class="language-sh">./run.sh envoy-1-ads-with-xds.yaml
</code></pre>
<p><a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-1-ads-with-xds.yaml" title="envoy-1-ads-with-xds.yaml">envoy-1-ads-with-xds.yaml</a> ä¸­é…ç½®äº†ä¸¤ä¸ª clusterï¼Œä¸€ä¸ªæ˜¯ ads_cluster ä¸€ä¸ªæ˜¯ xds_clusterï¼Œåé¢çš„æ¼”ç¤ºä»£ç æ—¢ä¼šä¸‹å‘ä½¿ç”¨ xds ï¼Œä¹Ÿä¼šä½¿ç”¨ ads ï¼Œæ‰€ä»¥åœ¨é…ç½®äº†è¿™ä¸¤ä¸ª clusterã€‚</p>
<pre><code class="language-sh">â”‚Â Â  â”œâ”€â”€ envoy-0-default.yaml         # envoy å®¹å™¨ä¸­çš„é»˜è®¤é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-0-example.yaml         # åˆæ¬¡ä½“éªŒä½¿ç”¨çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-1-ads-with-xds.yaml    # æ¼”ç¤ºé…ç½®ä¸‹å‘æ—¶ç”¨çš„é…ç½®ï¼ŒåŒæ—¶é…ç½®äº† adsã€xds
â”‚Â Â  â”œâ”€â”€ envoy-1-ads.yaml             # åªä½¿ç”¨ ads å‘ç°é…ç½®çš„é…ç½® 
â”‚Â Â  â”œâ”€â”€ envoy-1-static.yaml          # å®Œå…¨é™æ€çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-1-xds.yaml             # åªä½¿ç”¨ ads å‘ç°é…ç½®çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ envoy-to-grpc-svc.yaml       # grpc ä»£ç†é…ç½®
</code></pre>
<h2 id="æ¼”ç¤ºç”¨çš„é…ç½®æ–‡ä»¶è¯´æ˜"><a class="header" href="#æ¼”ç¤ºç”¨çš„é…ç½®æ–‡ä»¶è¯´æ˜">æ¼”ç¤ºç”¨çš„é…ç½®æ–‡ä»¶è¯´æ˜</a></h2>
<p><a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-1-ads-with-xds.yaml" title="envoy-1-ads-with-xds.yaml">envoy-1-ads-with-xds.yaml</a> çš„å†…å®¹æ¯”è¾ƒé•¿ï¼Œåˆ†æˆå‡ æ®µè¯´æ˜ã€‚</p>
<p>ç¬¬ä¸€æ®µæ˜¯ envoy çš„å¸¸è§„é…ç½®ï¼Œé…ç½® envoy çš„ idã€ç®¡ç†æ¥å£ç­‰ï¼š</p>
<pre><code class="language-yaml">node:
  id: &quot;envoy-64.58&quot;
  cluster: &quot;test&quot;
#runtime:
#  symlink_root: /srv/runtime/current
#  subdirectory: envoy
#  override_subdirectory: envoy_override
watchdog:
  miss_timeout: 0.2s
  megamiss_timeout: 1s
  kill_timeout: 0s
  multikill_timeout: 0s
flags_path: /etc/envoy/flags/
stats_flush_interval: 5s
stats_config:
  use_all_default_tags: true
stats_sinks:
  name: envoy.stat_sinks.hystrix
  config:
    num_buckets: 10
admin:
  access_log_path: /var/log/envoy/admin_access.log
  profile_path: /var/log/envoy/envoy.prof
  address:
    socket_address:
      protocol: TCP
      address: 0.0.0.0
      port_value: 9901
</code></pre>
<p>ç¬¬äºŒæ®µæ˜¯å‘ç°é…ç½®ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯ ads çš„æ–¹å¼ï¼Œcds å’Œ lds éƒ½æŒ‡å‘ adsï¼š</p>
<pre><code class="language-yaml">dynamic_resources:
  ads_config:
    api_type: GRPC
    grpc_services:
      envoy_grpc:
        cluster_name: ads_cluster
  cds_config: {ads: {}}
  lds_config: {ads: {}}
</code></pre>
<p>ç¬¬ä¸‰æ®µæ˜¯ä¸‹å‘é…ç½®ï¼Œä¸¤ä¸ª clusterï¼Œä¸€ä¸ªæ˜¯ ads_clusterï¼Œåœ¨ä¸Šä¸€æ®µé…ç½®ä¸­å·²ç»è¢«å¼•ç”¨ï¼Œå¦ä¸€ä¸ª xds_clusteråœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œä½†æ˜¯åé¢çš„æ¼”ç¤ºä»£ç ä¸‹å‘çš„é…ç½®ä¸­ä¼šç”¨åˆ°ã€‚</p>
<p>ads_cluster å’Œ xds_cluster çš„åœ°å€éƒ½æ˜¯ 127.0.0.1:5678ï¼Œæ¼”ç¤ºç¯å¢ƒä¸­ xds.go å’Œ envoy å®¹å™¨åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œæ‰€ä»¥è¿™é‡Œé…ç½®çš„éƒ½æ˜¯æœ¬åœ°åœ°å€ã€‚</p>
<pre><code class="language-yaml">static_resources:
  clusters:
  - name: ads_cluster
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: ads_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 5678
  - name: xds_cluster
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 5678
</code></pre>
<p>æœ€å static_resources ä¸­è¿˜æœ‰ä¸¤ä¸ªæ¼”ç¤ºä¸­æ²¡æœ‰ç”¨åˆ°çš„ clusterï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘ 8.8.8.8:53 ï¼Œä¸€ä¸ªæŒ‡å‘  www.baidu.comï¼Œå®ƒä»¬åªæ˜¯ç”¨æ¥ç¤ºèŒƒ cluster çš„é…ç½®æ–¹æ³•ï¼š</p>
<pre><code class="language-yaml">  - name: dns_google
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: dns_google
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 8.8.8.8
                port_value: 53
  - name: service_baidu
    connect_timeout: 0.25s
    type: LOGICAL_DNS
    # Comment out the following line to test on v6 networks
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: service_baidu
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: www.baidu.com
                port_value: 443
    tls_context:
      sni: www.baidu.com
</code></pre>
<h2 id="å‚è€ƒ-74"><a class="header" href="#å‚è€ƒ-74">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="go-control-plane-ä¸‹å‘é…ç½®ç¤ºä¾‹ä»£ç è¯´æ˜"><a class="header" href="#go-control-plane-ä¸‹å‘é…ç½®ç¤ºä¾‹ä»£ç è¯´æ˜">go-control-plane ä¸‹å‘é…ç½®ç¤ºä¾‹â€”ä»£ç è¯´æ˜</a></h1>
<p>ç¤ºä¾‹ä»£ç æ˜¯ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/xds.go" title="xds.go">xds.go</a>ï¼Œè¿™æ˜¯ä¸€æ®µè¶…çº§ç®€å•ã€ç®€é™‹çš„ä»£ç ï¼Œåªç”¨æ¥æ¼”ç¤ºå¦‚ä½•ä¸‹å‘é…ç½®ï¼Œä¸‹é¢æ˜¯ xds.go ä»£ç çš„è¯´æ˜ï¼Œå®Œæ•´ä»£ç è§ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/xds.go" title="xds.go">xds.go</a>ã€‚</p>
<h2 id="nodeconfig"><a class="header" href="#nodeconfig">NodeConfig</a></h2>
<p>NodeConfig ä¸­å­˜æ”¾ä¸€ä¸ª envoy çš„æ‰€æœ‰é…ç½®ï¼š</p>
<pre><code class="language-go">+NodeConfig : struct
    [fields]
   -clusters : []cache.Resource
   -endpoints : []cache.Resource
   -listeners : []cache.Resource
   -node : *core.Node
   -routes : []cache.Resource
    [methods]
   +ID(node *core.Node) : string
</code></pre>
<p>ä»£ç ä¸­åˆ›å»ºäº†ä¸‹é¢çš„ node_configï¼Œå®ƒçš„ Id å’Œ Cluster ä¸ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-0-example.yaml" title="envoy-0-example.yaml">envoy-0-example.yaml</a> ä¸­çš„é…ç½®æ˜¯å¯¹åº”çš„ï¼š</p>
<pre><code class="language-go">
node := &amp;core.Node{
	Id:      &quot;envoy-64.58&quot;,
	Cluster: &quot;test&quot;,
}

node_config := &amp;NodeConfig{
	node:      node,
	endpoints: []cache.Resource{}, //[]*api_v2.ClusterLoadAssignment
	clusters:  []cache.Resource{}, //[]*api_v2.Cluster
	routes:    []cache.Resource{}, //[]*api_v2.RouteConfiguration
	listeners: []cache.Resource{}, //[]*api_v2.Listener
}
</code></pre>
<h2 id="ç”Ÿæˆé…ç½®"><a class="header" href="#ç”Ÿæˆé…ç½®">ç”Ÿæˆé…ç½®</a></h2>
<p>ä¸‹é¢è¿™äº›å‡½æ•°ç”¨æ¥ç”Ÿæˆè¦ä¸‹å‘çš„é…ç½®ï¼ŒCluster_ADS() ç”Ÿæˆä½¿ç”¨ ADS å‘ç° Endpoint çš„ Clusterï¼Œå¯¹åº”çš„ endpoint é…ç½®ç”¨ EDS() ç”Ÿæˆï¼ŒListener ä¸­åŠ¨æ€å‘ç°çš„ Routeï¼Œç”¨ Route() ç”Ÿæˆã€‚</p>
<pre><code class="language-go">+Cluster_ADS(name string) : *api_v2.Cluster
+Cluster_EDS(name string, edsCluster []string, edsName string) : *api_v2.Cluster
+Cluster_STATIC(name string, addrs []ADDR) : *api_v2.Cluster
+EDS(cluster string, addrs []ADDR) : *api_v2.ClusterLoadAssignment

+Listener_ADS(name string, port uint32, routeName string) : *api_v2.Listener
+Listener_RDS(name string, port uint32, routeName string, rdsCluster []string) : *api_v2.Listener
+Listener_STATIC(name string, port uint32, host, prefix, toCluster string) : *api_v2.Listener
+Route(name, host, prefix, toCluster string) : *api_v2.RouteConfiguration
</code></pre>
<h2 id="é…ç½®ä¸‹å‘"><a class="header" href="#é…ç½®ä¸‹å‘">é…ç½®ä¸‹å‘</a></h2>
<p>ç”¨ä¸‹é¢çš„æ–¹å¼å¯åŠ¨ grpc æœåŠ¡ï¼š</p>
<pre><code class="language-go">snapshotCache := cache.NewSnapshotCache(false, NodeConfig{}, nil)
server := xds.NewServer(snapshotCache, nil)
grpcServer := grpc.NewServer()
lis, _ := net.Listen(&quot;tcp&quot;, &quot;:5678&quot;)

discovery.RegisterAggregatedDiscoveryServiceServer(grpcServer, server)
api_v2.RegisterEndpointDiscoveryServiceServer(grpcServer, server)
api_v2.RegisterClusterDiscoveryServiceServer(grpcServer, server)
api_v2.RegisterRouteDiscoveryServiceServer(grpcServer, server)
api_v2.RegisterListenerDiscoveryServiceServer(grpcServer, server)

go func() {
	if err := grpcServer.Serve(lis); err != nil {
		// error handling
	}
}()
</code></pre>
<p>Update_SnapshotCache() å°† node_config å¡«å……åˆ°  snapshotCache ä¸­ï¼Œå¡«å……æ—¶æŒ‡å®šé…ç½®çš„ç‰ˆæœ¬å·ï¼Œåªè¦é…ç½®å·å‘ç”Ÿäº†å˜åŒ–å°±è¢«è®¤ä¸ºæ˜¯éœ€è¦æ›´æ–°çš„é…ç½®ï¼Œæ²¡æœ‰é€’å¢ã€å›é€€çš„æ¦‚å¿µã€‚</p>
<pre><code class="language-go">func Update_SnapshotCache(s cache.SnapshotCache, n *NodeConfig, version string) {
	err := s.SetSnapshot(n.ID(n.node), cache.NewSnapshot(version, n.endpoints, n.clusters, n.routes, n.listeners))
	if err != nil {
		glog.Error(err)
	}
}
</code></pre>
<h2 id="é…ç½®ä¸‹å‘ä¸¾ä¾‹"><a class="header" href="#é…ç½®ä¸‹å‘ä¸¾ä¾‹">é…ç½®ä¸‹å‘ä¸¾ä¾‹</a></h2>
<p>ä¸‹å‘ä¸€ä¸ªé€šè¿‡ xds_cluster å‘ç° endpoint çš„ clusterï¼Œcluster åä¸º Cluster_With_Dynamic_Endpointã€‚</p>
<pre><code class="language-go">{
	clusterName := &quot;Cluster_With_Dynamic_Endpoint&quot;

	fmt.Printf(&quot;\nEnter to update version 2: %s&quot;, clusterName)
	_, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

	var addrs []ADDR
	addrs = append(addrs, ADDR{
		Address: &quot;127.0.0.1&quot;,
		Port:    8082,
	})

	point := EDS(clusterName, addrs)
	node_config.endpoints = append(node_config.endpoints, point)

	var edsCluster []string
	edsCluster = append(edsCluster, &quot;xds_cluster&quot;) //é™æ€çš„é…ç½®çš„ cluster

	edsName := clusterName
	cluster := Cluster_EDS(clusterName, edsCluster, edsName)
	node_config.clusters = append(node_config.clusters, cluster)

	Update_SnapshotCache(snapshotCache, node_config, &quot;2&quot;)
	fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<h2 id="å‚è€ƒ-75"><a class="header" href="#å‚è€ƒ-75">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="go-control-plane-ä¸‹å‘é…ç½®ç¤ºä¾‹è¿è¡Œå’Œæ•ˆæœ"><a class="header" href="#go-control-plane-ä¸‹å‘é…ç½®ç¤ºä¾‹è¿è¡Œå’Œæ•ˆæœ">go-control-plane ä¸‹å‘é…ç½®ç¤ºä¾‹â€”è¿è¡Œå’Œæ•ˆæœ</a></h1>
<p>è¿™é‡Œè¯¦ç»†æ¼”ç¤ºåŠ¨æ€é…ç½®çš„å‡ ç§ç»„åˆï¼Œä½¿ç”¨çš„ envoy é…ç½®æ–‡ä»¶æ˜¯ envoy-1-ads-with-xds.yamlã€‚</p>
<p>å¯åŠ¨ envoyï¼š</p>
<pre><code class="language-sh">./run.sh envoy-1-ads-with-xds.yaml
</code></pre>
<h2 id="envoy-åˆå§‹çŠ¶æ€"><a class="header" href="#envoy-åˆå§‹çŠ¶æ€">envoy åˆå§‹çŠ¶æ€</a></h2>
<p>envoy å¯åŠ¨ä¹‹åï¼Œé€šè¿‡ admin åœ°å€ï¼ˆæµè§ˆå™¨æ‰“å¼€ IP:9901 ï¼‰ æŸ¥çœ‹ envoy çš„å½“å‰é…ç½®ä»¥åŠå†…éƒ¨æƒ…å†µï¼š</p>
<p><img src="envoy/../img/envoy/envoy-admin.png" alt="envoy çš„ admin ç•Œé¢" /></p>
<p>envoy çš„å½“å‰é…ç½®é€šè¿‡ IP:9901/config_dump æŸ¥çœ‹ï¼Œé€šè¿‡è¯¥åœ°å€æŸ¥è¯¢çš„é…ç½®æ–‡ä»¶æ˜¯åˆ†ä¸ºå‡ æ®µçš„ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ®µä¸º &quot;@type&quot;: &quot;type.googleapis.com/envoy.admin.v2alpha.BootstrapConfigDump&quot;ï¼Œæ˜¯ envoy å¯åŠ¨æ—¶çš„é…ç½®</li>
<li>ç¬¬äºŒæ®µä¸º &quot;@type&quot;: &quot;type.googleapis.com/envoy.admin.v2alpha.ClustersConfigDump&quot;ï¼Œæ˜¯ cluster é…ç½®ï¼Œè¿™é‡Œç°åœ¨åªæœ‰é™æ€é…ç½®çš„ ads_cluster</li>
<li>ç¬¬ä¸‰æ®µä¸º &quot;@type&quot;: &quot;type.googleapis.com/envoy.admin.v2alpha.ListenersConfigDump&quot;ï¼Œç¬¬ä¸‰æ®µç°åœ¨æ˜¯ç©ºçš„</li>
</ul>
<p><img src="envoy/../img/envoy/envoy-config-init.png" alt="envoy çš„åˆå§‹åŒ–é…ç½®ç•Œé¢" /></p>
<p>ä¸‹å‘ listener å’Œ route åä¼šå¤šå‡ºä¸¤æ®µé…ç½®ï¼Œé‡Œé¢æ˜¯åŠ¨æ€ä¸‹å‘çš„ routeï¼š</p>
<ul>
<li>&quot;@type&quot;: &quot;type.googleapis.com/envoy.admin.v2alpha.ScopedRoutesConfigDump&quot; </li>
<li>&quot;@type&quot;: &quot;type.googleapis.com/envoy.admin.v2alpha.RoutesConfigDump&quot; </li>
</ul>
<p><img src="envoy/../img/envoy/envoy-config-after.png" alt="envoy çš„é…ç½®å˜åŒ–" /></p>
<p>endpoint åœ¨é…ç½®é¡µé¢ä¸­çœ‹ä¸åˆ°ï¼Œè¦åˆ° IP:9901/clusters ä¸­æŸ¥çœ‹ï¼š</p>
<p><img src="envoy/../img/envoy/envoy-ed-init.png" alt="envoy çš„åˆå§‹åŒ–endpointç•Œé¢" /></p>
<h2 id="å¯åŠ¨æ§åˆ¶å¹³é¢"><a class="header" href="#å¯åŠ¨æ§åˆ¶å¹³é¢">å¯åŠ¨æ§åˆ¶å¹³é¢</a></h2>
<p>æ¼”ç¤ºå®ç°çš„æ§åˆ¶å¹³é¢çš„åŠŸèƒ½å¦‚ä¸‹ï¼Œæ¯æŒ‰ä¸€æ¬¡å›è½¦ï¼Œä¸‹å‘ä¸€ç»„é…ç½®ï¼š</p>
<pre><code class="language-sh">$ ./xds
Enter to update version 1: Cluster_With_Static_Endpoint
ok
Enter to update version 2: Cluster_With_Dynamic_Endpoint
ok
Enter to update version 3: Cluster_With_ADS_Endpoint
ok
Enter to update version 4: Listener_With_Static_Route
ok
Enter to update version 5: Listener_With_Dynamic_Route
ok
Enter to update version 6: Listener_With_ADS_Route
ok
Enter to exit: ^C
</code></pre>
<h2 id="ä½¿ç”¨é™æ€-endpoint-çš„-cluster"><a class="header" href="#ä½¿ç”¨é™æ€-endpoint-çš„-cluster">ä½¿ç”¨é™æ€ endpoint çš„ cluster</a></h2>
<pre><code class="language-go">{
    clusterName := &quot;Cluster_With_Static_Endpoint&quot;
    fmt.Printf(&quot;Enter to update version 1: %s&quot;, clusterName)
    _, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

    var addrs []ADDR
    addrs = append(addrs, ADDR{
        Address: &quot;127.0.0.1&quot;,
        Port:    8081,
    })
    cluster := Cluster_STATIC(clusterName, addrs)
    node_config.clusters = append(node_config.clusters, cluster)
    Update_SnapshotCache(snapshotCache, node_config, &quot;1&quot;)
    fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<p>ä¸‹å‘åå¤šå‡ºä¸€ä¸ªåä¸º  Cluster_With_Static_Endpoint çš„ clusterï¼Œåœ°å€ä¸º 127.0.0.1:8081ã€‚</p>
<p><img src="envoy/../img/envoy/envoy-static-cluster.png" alt="envoyä¸­ä¸‹å‘çš„é™æ€cluster" /></p>
<h2 id="ä½¿ç”¨-eds-å‘ç°-endpoint-çš„-cluster"><a class="header" href="#ä½¿ç”¨-eds-å‘ç°-endpoint-çš„-cluster">ä½¿ç”¨ eds å‘ç° endpoint çš„ cluster</a></h2>
<pre><code class="language-go">{
    clusterName := &quot;Cluster_With_Dynamic_Endpoint&quot;

    fmt.Printf(&quot;\nEnter to update version 2: %s&quot;, clusterName)
    _, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

    var addrs []ADDR
    addrs = append(addrs, ADDR{
        Address: &quot;127.0.0.1&quot;,
        Port:    8082,
    })

    point := EDS(clusterName, addrs)
    node_config.endpoints = append(node_config.endpoints, point)

    var edsCluster []string
    edsCluster = append(edsCluster, &quot;xds_cluster&quot;) //é™æ€çš„é…ç½®çš„ cluster

    edsName := clusterName
    cluster := Cluster_EDS(clusterName, edsCluster, edsName)
    node_config.clusters = append(node_config.clusters, cluster)

    Update_SnapshotCache(snapshotCache, node_config, &quot;2&quot;)
    fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<p>ä¸‹å‘åå¤šå‡ºä¸€ä¸ªåä¸º Cluster_With_Dynamic_Endpoint çš„ clusterï¼Œåœ°å€ä¸º 127.0.0.1:8082ã€‚</p>
<p><img src="envoy/../img/envoy/envoy-cluster-eds.png" alt="envoyä¸­ä¸‹å‘çš„é™æ€cluster" /></p>
<p>cluster ä¸­æ²¡æœ‰ç›´æ¥é…ç½® endpointï¼ŒæŒ‡å®šä» xds_cluster ä¸­è·å–ï¼Œåœ¨ IP:9901/clusters ä¸­å¯ä»¥çœ‹åˆ° endpointï¼š</p>
<p><img src="envoy/../img/envoy/envoy-dynamic-cls-ep.png" alt="envoyä¸­åŠ¨æ€è·å–çš„endpoints" /></p>
<h2 id="ä½¿ç”¨-ads-å‘ç°-endpoint-çš„-cluster"><a class="header" href="#ä½¿ç”¨-ads-å‘ç°-endpoint-çš„-cluster">ä½¿ç”¨ ads å‘ç° endpoint çš„ cluster</a></h2>
<pre><code class="language-go">{
    clusterName := &quot;Cluster_With_ADS_Endpoint&quot;
    fmt.Printf(&quot;\nEnter to update version 3: %s&quot;, clusterName)
    _, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

    var addrs []ADDR
    addrs = append(addrs, ADDR{
        Address: &quot;127.0.0.1&quot;,
        Port:    8083,
    })

    edsName := clusterName
    point := EDS(edsName, addrs)
    node_config.endpoints = append(node_config.endpoints, point)

    cluster := Cluster_ADS(&quot;Cluster_With_ADS_Endpoint&quot;)
    node_config.clusters = append(node_config.clusters, cluster)

    Update_SnapshotCache(snapshotCache, node_config, &quot;3&quot;)
    fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<p>ä¸‹å‘åå¤šå‡ºä¸€ä¸ªåä¸º Cluster_With_ADS_Endpoint çš„ clusterï¼Œåœ°å€ä¸º 127.0.0.1:8083ã€‚</p>
<p>ads çš„é…ç½®å’Œ xds ä¸åŒï¼Œä¸éœ€è¦æŒ‡å®š clusterï¼Œå£°æ˜ä½¿ç”¨ ADS å³å¯ï¼š</p>
<p><img src="envoy/../img/envoy/envoy-cls-ads.png" alt="ä½¿ç”¨ ads å‘ç° endpoint çš„ cluster" /></p>
<h2 id="ä½¿ç”¨é™æ€è·¯ç”±çš„-listener"><a class="header" href="#ä½¿ç”¨é™æ€è·¯ç”±çš„-listener">ä½¿ç”¨é™æ€è·¯ç”±çš„ listener</a></h2>
<p>å‰é¢çš„å‡ ä¸ªæ­¥éª¤ä¸‹å‘äº† clusterï¼Œæ²¡æœ‰ä¸‹å‘ listenerï¼Œæ— æ³•è®¿é—® clusterï¼Œè¦è®¿é—® cluster å¿…é¡»é…ç½®ä¸€ä¸ªæŒ‡å‘å®ƒçš„ listenerã€‚</p>
<pre><code class="language-go">{
    listenerName := &quot;Listener_With_Static_Route&quot;
    fmt.Printf(&quot;\nEnter to update version 4: %s&quot;, listenerName)
    _, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

    clusterName := &quot;Listener_With_Static_Route_Target_Cluster&quot;
    var addrs []ADDR
    addrs = append(addrs, ADDR{
        Address: &quot;127.0.0.1&quot;,
        Port:    8080,
    })
    cluster := Cluster_STATIC(clusterName, addrs)
    node_config.clusters = append(node_config.clusters, cluster)

    lis := Listener_STATIC(listenerName, 84, &quot;echo.example&quot;, &quot;/abc&quot;, clusterName)
    node_config.listeners = append(node_config.listeners, lis)

    Update_SnapshotCache(snapshotCache, node_config, &quot;4&quot;)
    fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä¸‹å‘äº†ä¸€ä¸ªç›‘å¬ 84 ç«¯å£ã€å°†è¯·æ±‚è½¬å‘åˆ° 172.17.0.2:8080 çš„ listenerï¼Œè½¬å‘è§„åˆ™ä¸º Host æ˜¯ echo.exampleï¼Œprefix æ˜¯ /abcï¼š
è¿™é‡Œçš„ 172.17.0.2:8080ï¼Œæ˜¯ <a href="envoy/./echoserver.html">åˆæ¬¡ä½“éªŒ</a> ä¸­å¯åŠ¨çš„ echoserver å®¹å™¨çš„åœ°å€ã€‚</p>
<p>ä¸‹å‘ä»¥åï¼Œåœ¨ç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„é…ç½®ï¼š</p>
<p><img src="envoy/../img/envoy/envoy-listener.png" alt="ä½¿ç”¨ ads å‘ç° endpoint çš„ cluster" /></p>
<p>è¿™æ—¶å€™å¯ä»¥é€šè¿‡ 84 ç«¯å£è®¿é—® clusterï¼š</p>
<pre><code class="language-sh">$ curl   -H &quot;Host: echo.example&quot; 127.0.0.1:84/abc

Hostname: 7759cabd7402

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008

Request Information:
	client_address=172.17.0.3
	method=GET
	real path=/abc
	query=
	request_version=1.1
	request_scheme=http
	request_uri=http://echo.example:8080/abc

Request Headers:
	accept=*/*
	content-length=0
	host=echo.example
	user-agent=curl/7.54.0
	x-envoy-expected-rq-timeout-ms=15000
	x-forwarded-proto=http
	x-request-id=8bda7006-87dd-4251-ad3a-431d610ef806

Request Body:
	-no body in request-
</code></pre>
<h2 id="ä½¿ç”¨-xds-å‘ç°è·¯ç”±çš„-listener"><a class="header" href="#ä½¿ç”¨-xds-å‘ç°è·¯ç”±çš„-listener">ä½¿ç”¨ xds å‘ç°è·¯ç”±çš„ listener</a></h2>
<pre><code class="language-go">{
	listenerName := &quot;Listener_With_Dynamic_Route&quot;
	fmt.Printf(&quot;\nEnter to update version 5: %s&quot;, listenerName)
	_, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

	clusterName := &quot;Listener_With_Dynamic_Route_Target_Cluster&quot;
	var addrs []ADDR
	addrs = append(addrs, ADDR{
		Address: &quot;172.17.0.2&quot;,
		Port:    8080,
	})
	cluster := Cluster_STATIC(clusterName, addrs)
	node_config.clusters = append(node_config.clusters, cluster)

	routeName := &quot;Listener_With_Dynamic_Route_Route&quot;
	r := Route(routeName, &quot;echo.example&quot;, &quot;/123&quot;, clusterName)
	node_config.routes = append(node_config.routes, r)

	var rdsCluster []string
	rdsCluster = append(rdsCluster, &quot;xds_cluster&quot;) //é™æ€çš„é…ç½®çš„ cluster
	lis := Listener_RDS(listenerName, 85, routeName, rdsCluster)
	node_config.listeners = append(node_config.listeners, lis)

	Update_SnapshotCache(snapshotCache, node_config, &quot;5&quot;)
	fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ rds é…ç½®çš„æ˜¯ xds_clusterï¼Œxds_cluster æ˜¯é…ç½®æ–‡ä»¶ä¸­äº‹å…ˆé…ç½®çš„é™æ€ clusterï¼š</p>
<p><img src="envoy/../img/envoy/envoy-rds.png" alt="ä» XDS ä¸­å‘ç°è·¯ç”±çš„ listener" /></p>
<h2 id="ä½¿ç”¨-ads-å‘ç°è·¯ç”±çš„-listener"><a class="header" href="#ä½¿ç”¨-ads-å‘ç°è·¯ç”±çš„-listener">ä½¿ç”¨ ads å‘ç°è·¯ç”±çš„ listener</a></h2>
<pre><code class="language-go">{
	listenerName := &quot;Listener_With_ADS_Route&quot;
	fmt.Printf(&quot;\nEnter to update version 6: %s&quot;, listenerName)
	_, _ = fmt.Scanf(&quot;\n&quot;, &amp;input)

	clusterName := &quot;Listener_With_ADS_Route_Target_Cluster&quot;
	var addrs []ADDR
	addrs = append(addrs, ADDR{
		Address: &quot;172.17.0.2&quot;,
		Port:    8080,
	})
	cluster := Cluster_STATIC(clusterName, addrs)
	node_config.clusters = append(node_config.clusters, cluster)

	routeName := &quot;Listener_With_ADS_Route_Route&quot;
	r := Route(routeName, &quot;echo.example&quot;, &quot;/a1b&quot;, clusterName)
	node_config.routes = append(node_config.routes, r)

	lis := Listener_ADS(listenerName, 86, routeName)
	node_config.listeners = append(node_config.listeners, lis)

	Update_SnapshotCache(snapshotCache, node_config, &quot;6&quot;)
	fmt.Printf(&quot;ok&quot;)
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ rds é…ç½®çš„æ˜¯ adsï¼Œads æŒ‡å‘é…ç½®æ–‡ä»¶ä¸­äº‹å…ˆé…ç½®çš„ ads_clusterï¼š</p>
<p><img src="envoy/../img/envoy/envoy-ads.png" alt="ä» ADS ä¸­å‘ç°è·¯ç”±çš„ listener" /></p>
<h2 id="å‚è€ƒ-76"><a class="header" href="#å‚è€ƒ-76">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„-cluster-é…ç½®è¯¦è§£"><a class="header" href="#envoy-çš„-cluster-é…ç½®è¯¦è§£">Envoy çš„ Cluster é…ç½®è¯¦è§£</a></h1>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/clusters/clusters" title="Envoy Clusters">Clusters</a> ç›¸å½“äº nginx çš„ upstreamï¼Œæ˜¯ä¸€ç»„ IP æˆ–è€…åŸŸåçš„é›†åˆï¼Œ æ˜¯ Envoy æ”¶åˆ°çš„è¯·æ±‚æœ€ç»ˆæµå‘çš„åœ°æ–¹ã€‚ Cluster çš„é…ç½®é¡¹æ¯”è¾ƒå¤šï¼Œè§ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cds.proto#cluster" title="Envoy Clusters Config">Clusters Config</a>ï¼š</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;alt_stat_name&quot;: &quot;...&quot;,
  &quot;type&quot;: &quot;...&quot;,
  &quot;cluster_type&quot;: &quot;{...}&quot;,
  &quot;eds_cluster_config&quot;: &quot;{...}&quot;,
  &quot;connect_timeout&quot;: &quot;{...}&quot;,
  &quot;per_connection_buffer_limit_bytes&quot;: &quot;{...}&quot;,
  &quot;lb_policy&quot;: &quot;...&quot;,
  &quot;hosts&quot;: [],
  &quot;load_assignment&quot;: &quot;{...}&quot;,
  &quot;health_checks&quot;: [],
  &quot;max_requests_per_connection&quot;: &quot;{...}&quot;,
  &quot;circuit_breakers&quot;: &quot;{...}&quot;,
  &quot;tls_context&quot;: &quot;{...}&quot;,
  &quot;common_http_protocol_options&quot;: &quot;{...}&quot;,
  &quot;http_protocol_options&quot;: &quot;{...}&quot;,
  &quot;http2_protocol_options&quot;: &quot;{...}&quot;,
  &quot;extension_protocol_options&quot;: &quot;{...}&quot;,
  &quot;typed_extension_protocol_options&quot;: &quot;{...}&quot;,
  &quot;dns_refresh_rate&quot;: &quot;{...}&quot;,
  &quot;respect_dns_ttl&quot;: &quot;...&quot;,
  &quot;dns_lookup_family&quot;: &quot;...&quot;,
  &quot;dns_resolvers&quot;: [],
  &quot;outlier_detection&quot;: &quot;{...}&quot;,
  &quot;cleanup_interval&quot;: &quot;{...}&quot;,
  &quot;upstream_bind_config&quot;: &quot;{...}&quot;,
  &quot;lb_subset_config&quot;: &quot;{...}&quot;,
  &quot;ring_hash_lb_config&quot;: &quot;{...}&quot;,
  &quot;original_dst_lb_config&quot;: &quot;{...}&quot;,
  &quot;least_request_lb_config&quot;: &quot;{...}&quot;,
  &quot;common_lb_config&quot;: &quot;{...}&quot;,
  &quot;transport_socket&quot;: &quot;{...}&quot;,
  &quot;metadata&quot;: &quot;{...}&quot;,
  &quot;protocol_selection&quot;: &quot;...&quot;,
  &quot;upstream_connection_options&quot;: &quot;{...}&quot;,
  &quot;close_connections_on_host_health_failure&quot;: &quot;...&quot;,
  &quot;drain_connections_on_host_removal&quot;: &quot;...&quot;,
  &quot;filters&quot;: []
}
</code></pre>
<h2 id="cluster-çš„ç±»å‹"><a class="header" href="#cluster-çš„ç±»å‹">Cluster çš„ç±»å‹</a></h2>
<p>type å’Œ cluster_type æ˜¯ cluster çš„ç±»å‹ï¼Œtype æ˜¯ envoy æ”¯æŒçš„æ ‡å‡†ç±»å‹ï¼Œcluster_type æ˜¯è‡ªå®šä¹‰ç±»å‹ã€‚</p>
<p>envoy æ”¯æŒçš„æ ‡å‡†ç±»å‹æŒ‰ç…§ <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/service_discovery" title="Supported service discovery types">service discovery types</a> åˆ†ç±»ï¼š</p>
<ul>
<li>Staticï¼Œç›´æ¥é…ç½® IP åœ°å€</li>
<li>Strict DNSï¼Œé€šè¿‡è§£æåŸŸåè·å–ç›®æ ‡ IPï¼Œä½¿ç”¨æŸ¥è¯¢å‡ºæ¥çš„æ‰€æœ‰ IP</li>
<li>Logical DNSï¼Œé€šè¿‡è§£æåŸŸåè·å–ç›®æ ‡ IPï¼Œåªä½¿ç”¨ç¬¬ä¸€ä¸ª IP </li>
<li>Endpoint discovery serviceï¼ˆEDSï¼‰</li>
<li>Original destinationï¼Œé€æ˜ä»£ç†æ–¹å¼</li>
</ul>
<p>åœ¨ go-controller-plane ä¸­çš„å®šä¹‰åˆ†åˆ«æ˜¯ï¼š</p>
<pre><code class="language-go">// envoy/api/v2/cds.pb.go: 43
const (
	Cluster_STATIC Cluster_DiscoveryType = 0
	Cluster_STRICT_DNS Cluster_DiscoveryType = 1
	Cluster_LOGICAL_DNS Cluster_DiscoveryType = 2
	Cluster_EDS Cluster_DiscoveryType = 3
	Cluster_ORIGINAL_DST Cluster_DiscoveryType = 4
)
</code></pre>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­çš„å†™æ³•åˆ†åˆ«æ˜¯ï¼š</p>
<pre><code class="language-go">// envoy/api/v2/cds.pb.go: 72
var Cluster_DiscoveryType_value = map[string]int32{
	&quot;STATIC&quot;:       0,
	&quot;STRICT_DNS&quot;:   1,
	&quot;LOGICAL_DNS&quot;:  2,
	&quot;EDS&quot;:          3,
	&quot;ORIGINAL_DST&quot;: 4,
}
</code></pre>
<h2 id="cluster-çš„-filter"><a class="header" href="#cluster-çš„-filter">Cluster çš„ filter</a></h2>
<p>Cluster çš„ filter å­—æ®µä¸­æ˜¯ <a href="envoy/./network-filter.html">network filter</a>ï¼Œå¤„ç†ä» cluster æµå‡ºï¼ˆoutgoingï¼‰çš„æ•°æ®ã€‚</p>
<h2 id="cluster-çš„è´Ÿè½½å‡è¡¡ç®—æ³•"><a class="header" href="#cluster-çš„è´Ÿè½½å‡è¡¡ç®—æ³•">Cluster çš„è´Ÿè½½å‡è¡¡ç®—æ³•</a></h2>
<p>Cluster æ”¯æŒä¸‹é¢çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#arch-overview-load-balancing-types" title="Supported load balancers">è´Ÿè½½å‡è¡¡ç®—æ³•</a>ï¼š</p>
<ul>
<li>ROUND_ROBIN</li>
<li>LEAST_REQUEST</li>
<li>RING_HASH</li>
<li>RANDOM</li>
<li>MAGLEV</li>
<li>CLUSTER_PROVIDED</li>
</ul>
<h2 id="å‚è€ƒ-77"><a class="header" href="#å‚è€ƒ-77">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„-listener-é…ç½®è¯¦è§£"><a class="header" href="#envoy-çš„-listener-é…ç½®è¯¦è§£">Envoy çš„ Listener é…ç½®è¯¦è§£</a></h1>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/listeners/listeners" title="Listeners">Listener</a> æ˜¯ envoy æœ€é‡è¦çš„é…ç½®ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„é…ç½®ï¼Œå®ƒæ˜¯ envoy çš„ç›‘å¬é…ç½®ï¼ŒæŒ‡å®šäº† envoy ç›‘å¬åœ°å€ï¼Œä»¥åŠè¯·æ±‚å¦‚ä½•å¤„ç†ã€è½¬å‘åˆ°å“ªé‡Œã€‚Listener ä¸­å¯ä»¥åŒ…å«å¤šä¸ªä¸åŒ filterï¼Œæœ‰ä¸€äº› filter æœ¬èº«åˆæ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¯ä»¥ç»§ç»­åŒ…å« filterï¼Œè­¬å¦‚ <a href="envoy/./network-filter.html#envoyhttpconnectionmanager">HTTP Connection Manager</a>ã€‚</p>
<h2 id="listener-é…ç½®æ ¼å¼"><a class="header" href="#listener-é…ç½®æ ¼å¼">Listener é…ç½®æ ¼å¼</a></h2>
<p>Listener çš„é…ç½®æ ¼å¼å¦‚ä¸‹ï¼Œå¯ä»¥åœ¨ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#envoy-api-msg-listener" title="Listener configuration overview">api æ–‡æ¡£</a> ä¸­æ‰¾åˆ°ï¼š</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;address&quot;: &quot;{...}&quot;,
  &quot;filter_chains&quot;: [],
  &quot;use_original_dst&quot;: &quot;{...}&quot;,
  &quot;per_connection_buffer_limit_bytes&quot;: &quot;{...}&quot;,
  &quot;metadata&quot;: &quot;{...}&quot;,
  &quot;drain_type&quot;: &quot;...&quot;,
  &quot;listener_filters&quot;: [],
  &quot;listener_filters_timeout&quot;: &quot;{...}&quot;,
  &quot;transparent&quot;: &quot;{...}&quot;,
  &quot;freebind&quot;: &quot;{...}&quot;,
  &quot;socket_options&quot;: [],
  &quot;tcp_fast_open_queue_length&quot;: &quot;{...}&quot;,
  &quot;traffic_direction&quot;: &quot;...&quot;
}
</code></pre>
<p>å…¶ä¸­ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/core/address.proto#envoy-api-msg-core-address" title="core.Address">address</a> æ˜¯ç›‘å¬åœ°å€ï¼Œ<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener.proto#envoy-api-msg-listener-filterchain" title="listener.FilterChain">filter_chains</a> å’Œ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener.proto#envoy-api-msg-listener-listenerfilter" title="listener.ListenerFilter">listener_filters</a> æ˜¯ listener ä¸­æœ€é‡è¦ä¹Ÿæœ€å¤æ‚çš„é…ç½®ï¼Œå‰©ä½™çš„éƒ½æ˜¯ä¸€äº›ç»†èŠ‚é…ç½®ï¼Œç›¸å¯¹ç®€å•ä¸€äº›ã€‚</p>
<p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ul>
<li>listener çš„ç›‘å¬åœ°å€æ˜¯äº’æ–¥çš„ï¼Œä¸¤ä¸ª listener ä¸èƒ½ç›‘å¬åŒä¸€ä¸ª socket åœ°å€</li>
<li>listener_filters æ˜¯ <a href="envoy/./listener-filter.html">listener filter</a></li>
<li>filter_chains æ˜¯ <a href="envoy/./network-filter.html">network filter</a>ï¼Œå¯ä»¥æœ‰å¤šç»„</li>
</ul>
<p>go-control-plane ä¸­çš„ listener åœ¨ <a href="https://github.com/envoyproxy/go-control-plane/blob/master/envoy/api/v2/lds.pb.go#L67" title="type Listener struct">envoy/api/ve/lds.pb.go</a> ä¸­å®šä¹‰ï¼Œæ¯ä¸ªå­—æ®µéƒ½æœ‰éå¸¸è¯¦ç»†çš„æ³¨é‡Šï¼Œ<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#envoy-api-msg-listener" title="Listener configuration overview">apiæ–‡æ¡£</a> å°±æ˜¯é€šè¿‡è¿™äº›æ³¨é‡Šç”Ÿæˆçš„ã€‚</p>
<h2 id="å‚è€ƒ-78"><a class="header" href="#å‚è€ƒ-78">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„-listener-ä¸­çš„-filter-è¯¦è§£"><a class="header" href="#envoy-çš„-listener-ä¸­çš„-filter-è¯¦è§£">Envoy çš„ Listener ä¸­çš„ Filter è¯¦è§£</a></h1>
<p>ä» socket ä¸­æ”¶å–çš„è¯·æ±‚å…ˆç»è¿‡ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener.proto#envoy-api-msg-listener-listenerfilter" title="listener.ListenerFilter">listener_filters</a> å¤„ç†ï¼Œç„¶åå†ç”± <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener.proto#envoy-api-msg-listener-filterchain" title="listener.FilterChain">filter_chains</a> å¤„ç†ï¼Œå‰è€…åŒ…å«çš„ filter ç§°ä¸º listener filterï¼Œåè€…åŒ…å«çš„ filter ç§°ä¸º network filterã€‚å› ä¸º listener_filters å…ˆèµ·ä½œç”¨ï¼Œå› æ­¤å®ƒå¯ä»¥ä¿®æ”¹è¯·æ±‚çš„ä¿¡æ¯ï¼Œä»è€Œå½±å“ filter_chains çš„åŒ¹é…ã€‚</p>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/filter" title="Filters">Filter</a> çš„æ–‡æ¡£åœ¨ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/config#" title="Extensions">Extensions</a> ä¸­ï¼Œå½“å‰ï¼ˆ2019-08-05 20:35:10ï¼‰æœ‰ä»¥ä¸‹å‡ ä¸ªå¤§ç±»ï¼š</p>
<pre><code class="language-sh">Listener filters
Network filters
HTTP filters
Thrift filters
Common access log types
Common fault injection types
Dubbo filters
</code></pre>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/configuration" title="Configuration reference">Configuration reference</a> ä¸­ä¸€åŠçš„ç¯‡å¹…åœ¨ä»‹ç» filterï¼Œå¯¹æ¯ä¸ª filter çš„ç”¨é€”å’Œç”¨æ³•ä½œäº†ç®€è¦ä»‹ç»ã€‚</p>
<h2 id="å‚è€ƒ-79"><a class="header" href="#å‚è€ƒ-79">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="go-control-plane-ä¸­çš„-filter-å®šä¹‰ä¸ä¸‹å‘"><a class="header" href="#go-control-plane-ä¸­çš„-filter-å®šä¹‰ä¸ä¸‹å‘">go-control-plane ä¸­çš„ filter å®šä¹‰ä¸ä¸‹å‘</a></h1>
<p>Filter æ˜¯å¡«å……åœ¨ listener ä¸­ä½œä¸º listener é…ç½®ä¸‹å‘çš„ï¼Œlistener åœ¨ <a href="https://github.com/envoyproxy/go-control-plane/blob/v0.8.4/envoy/api/v2/lds.pb.go" title="go-control-plane/envoy/api/v2/lds.pb.go">go-control-plane/envoy/api/v2/lds.pb.go</a> ä¸­å®šä¹‰ï¼Œfilter çš„æ¥å£åœ¨ <a href="https://github.com/envoyproxy/go-control-plane/blob/v0.8.4/envoy/api/v2/listener/listener.pb.go" title="envoy/api/v2/listener/listener.pb.go">envoy/api/v2/listener/listener.pb.go</a> ä¸­å®šä¹‰ï¼Œfilter çš„å®ç°åœ¨ <a href="https://github.com/envoyproxy/go-control-plane/tree/v0.8.4/envoy/config/filter" title="go-control-plane/envoy/config/filter/">go-control-plane/envoy/config/filter/</a> ä¸­ã€‚</p>
<h3 id="listener_filters-çš„å®šä¹‰"><a class="header" href="#listener_filters-çš„å®šä¹‰">listener_filters çš„å®šä¹‰</a></h3>
<p>Listener ä¸­çš„ listener_filters çš„åœ¨ go-control-plane ä¸­å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">// go-control-plane/envoy/api/v2/lds.pb.go
ListenerFilters []*listener.ListenerFilter 

// go-control-plane/envoy/api/v2/listener/listener.pb.go
type ListenerFilter struct {
    Name string 
    ConfigType           isListenerFilter_ConfigType 
    XXX_NoUnkeyedLiteral struct{}                    
    XXX_unrecognized     []byte                      
    XXX_sizecache        int32                       
}
</code></pre>
<h3 id="filter_chains-çš„å®šä¹‰"><a class="header" href="#filter_chains-çš„å®šä¹‰">filter_chains çš„å®šä¹‰</a></h3>
<p>Listener ä¸­çš„ filter_chains åœ¨ go-control-plane ä¸­å®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­FilterChain ç»§ç»­åŒ…å« Filter é“¾ï¼š</p>
<pre><code class="language-go">FilterChains []*listener.FilterChain 

type FilterChain struct {
    FilterChainMatch *FilterChainMatch 
    TlsContext *auth.DownstreamTlsContext 
    Filters []*Filter 
    UseProxyProto *types.BoolValue 
    Metadata *core.Metadata 
    TransportSocket      *core.TransportSocket 
    
    XXX_NoUnkeyedLiteral struct{}              
    XXX_unrecognized     []byte                
    XXX_sizecache        int32                 
}

type Filter struct {
    Name string `protobuf:&quot;bytes,1,opt,name=name,proto3&quot; json:&quot;name,omitempty&quot;`
    ConfigType           isFilter_ConfigType `protobuf_oneof:&quot;config_type&quot;`
    XXX_NoUnkeyedLiteral struct{}            `json:&quot;-&quot;`
    XXX_unrecognized     []byte              `json:&quot;-&quot;`
    XXX_sizecache        int32               `json:&quot;-&quot;`
}

</code></pre>
<h2 id="filter-çš„å®šä¹‰"><a class="header" href="#filter-çš„å®šä¹‰">filter çš„å®šä¹‰</a></h2>
<p>filter çš„å®šä¹‰åœ¨ <a href="https://github.com/envoyproxy/go-control-plane/tree/v0.8.4/envoy/config/filter" title="go-control-plane/envoy/config/filter/">go-control-plane/envoy/config/filter</a> ä¸­ï¼Œä¸åŒç±»å‹çš„ filter éƒ½æœ‰å„è‡ªçš„å®šä¹‰ã€‚ç”¨ go-control-plane ä¸‹å‘æ—¶ï¼Œéœ€è¦ç”¨ util.MessageToStruct() è½¬æ¢æˆ *types.Struct ç±»å‹ï¼Œæˆ–è€…ç”¨ ptypes.MarshalAny() è½¬æ¢æˆ * any.Any ç±»å‹åï¼Œå¡«å……åˆ° Listener ä¸­ã€‚</p>
<p>ä»¥ listener_filters çš„ä¸ºä¾‹ï¼ŒListenerFilter ä¸­çš„ ConfigType æ˜¯ä¸€ä¸ªæ¥å£å˜é‡ï¼š</p>
<pre><code class="language-go">// go-control-plane/envoy/api/v2/listener/listener.pb.go
type ListenerFilter struct {
    Name string 
    ConfigType           isListenerFilter_ConfigType 
    XXX_NoUnkeyedLiteral struct{}                    
    XXX_unrecognized     []byte                      
    XXX_sizecache        int32                       
}

// go-control-plane/envoy/api/v2/listener/listener.pb.go: 585
type isListenerFilter_ConfigType interface {
    isListenerFilter_ConfigType()
    Equal(interface{}) bool
    MarshalTo([]byte) (int, error)
    Size() int
}
</code></pre>
<p>isListenerFilter_ConfigType æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ¥å£ï¼Œå®ç°è¯¥æ¥å£çš„ struct æ˜¯ ListenerFilter_Config å’Œ ListenerFilter_TypedConfig ã€‚</p>
<pre><code class="language-go">// go-control-plane/envoy/api/v2/listener/listener.pb.go: 592
type ListenerFilter_Config struct {
    Config *types.Struct 
}
type ListenerFilter_TypedConfig struct {
    TypedConfig *types.Any
}

func (*ListenerFilter_Config) isListenerFilter_ConfigType()      {}
func (*ListenerFilter_TypedConfig) isListenerFilter_ConfigType() {}
</code></pre>
<p>ä¸Šé¢çš„ Config å’Œ TypedConfig å°±æ˜¯ filter è½¬åŒ–è€Œæˆçš„ã€‚</p>
<p>filter_chains çš„æƒ…å†µç±»ä¼¼ï¼Œå¯¹åº”çš„ struct æ˜¯ Filter_Config å’Œ Filter_TypedConfigã€‚</p>
<h2 id="xx_config-å’Œ-xx_typedconfig-çš„åŒºåˆ«"><a class="header" href="#xx_config-å’Œ-xx_typedconfig-çš„åŒºåˆ«">XX_Config å’Œ XX_TypedConfig çš„åŒºåˆ«</a></h2>
<p>å°† filter å¡«å……åˆ° listener æ—¶ï¼Œå¯ä»¥ç”¨  XX_Config ç±»å‹ï¼Œä¹Ÿå¯ä»¥ç”¨ XX_TypedConfig çš„ç±»å‹ï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š</p>
<p><strong>XX_Config</strong>ï¼š</p>
<pre><code class="language-yaml">- name: envoy.http_connection_manager
  config:
    stat_prefix: ingress_http
    generate_request_id: true
    route_config:
      name: local_route
      virtual_hosts:
      - name: local_service
        domains: [&quot;webshell.com&quot;]
        routes:
        - match:
            prefix: &quot;/&quot;
          route:
            host_rewrite: webshell.com
            cluster: service_webshell
    http_filters:
    - name: envoy.router
      config:
        dynamic_stats: false
</code></pre>
<p><strong>XX_TypedConfig</strong>ï¼š</p>
<pre><code class="language-yaml">- name: envoy.http_connection_manager
  typed_config:
    &quot;@type&quot;: type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
    stat_prefix: ingress_http
    route_config:
      name: local_route
      virtual_hosts:
      - name: local_service
        domains: [&quot;*&quot;]
        routes:
        - match:
            prefix: &quot;/&quot;
          route:
            host_rewrite: www.baidu.com
            cluster: service_baidu
    http_filters:
    - name: envoy.router
</code></pre>
<h2 id="http-connection-manager-çš„å¡«å……è¿‡ç¨‹"><a class="header" href="#http-connection-manager-çš„å¡«å……è¿‡ç¨‹">HTTP Connection Manager çš„å¡«å……è¿‡ç¨‹</a></h2>
<p>ä»¥ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#envoy-api-msg-config-filter-network-http-connection-manager-v2-httpconnectionmanager" title="HTTP Connection Manager">HTTP Connection Manager</a> ä¸ºä¾‹ï¼Œå¡«å……æ“ä½œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">// åˆ›å»ºä¸€ä¸ª HttpConnectionManager
listen_filter_http_conn_ := &amp;http_conn_manager.HttpConnectionManager{
    StatPrefix: &quot;ingress_http&quot;,
    RouteSpecifier: &amp;http_conn_manager.HttpConnectionManager_RouteConfig{
        RouteConfig: &amp;api_v2.RouteConfiguration{
            Name:         &quot;None&quot;,
            VirtualHosts: virtualHosts,
        },
    },
    HttpFilters: httpFilters,
}

// è½¬æ¢æˆ *types.Struct
listen_filter_http_conn, err := util.MessageToStruct(listen_filter_http_conn_)
if err != nil {
    glog.Error(err)
    return
}

// ç”¨è½¬æ¢å¾—åˆ° *types.Struct æ„é€  listener.Filter_Configï¼Œç»§è€Œæ„é€  Filter
filter := &amp;listener.Filter{
    Name: &quot;envoy.http_connection_manager&quot;,
    ConfigType: &amp;listener.Filter_Config{
        Config: listen_filter_http_conn,
    },
}

//ç„¶åæŠŠ filter æ”¾å…¥ filterChains çš„ä¸€ä¸ªæˆå‘˜çš„ filters é“¾ä¸­ã€‚
filters = append(filters, filter)
filterChain := &amp;listener.FilterChain{
    Filters: filters,
}

//æœ€åå°† filterChains è£…å…¥ listener
filterChains = append(filterChains, filterChain)
lis := &amp;api_v2.Listener{
    Name:         &quot;listener_with_static_route_port_9000&quot;,
    Address:      address,
    FilterChains: filterChains,
}
</code></pre>
<h2 id="å‚è€ƒ-80"><a class="header" href="#å‚è€ƒ-80">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-çš„-listener-filter-åˆ—è¡¨"><a class="header" href="#envoy-çš„-listener-filter-åˆ—è¡¨">Envoy çš„ listener filter åˆ—è¡¨</a></h1>
<p>ä¸‹é¢æ˜¯å¯ä»¥åœ¨åŠ å…¥ listener çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener.proto#listener-listenerfilter" title="listener.ListenerFilter">listener_filter</a> å­—æ®µä¸­çš„ <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/listener_filters#config-listener-filters" title="Listener filters">listener filter</a>ã€‚ è¿™äº› filter çš„ä¸»è¦ä½œç”¨æ˜¯æ£€æµ‹åè®®ã€è§£æåè®®ï¼Œé€šè¿‡å®ƒä»¬è§£æå‡ºçš„ä¿¡æ¯è¢«ç”¨äºåŒ¹é… filter_chains ä¸­çš„ filterã€‚</p>
<p>Envoy æ”¯æŒçš„ listener_filterï¼š <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/listener_filters#config-listener-filters" title="Listener filters">listener filter</a>ã€‚</p>
<h2 id="name-envoylistenerhttp_inspector"><a class="header" href="#name-envoylistenerhttp_inspector">name: envoy.listener.http_inspector</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listener_filters/http_inspector" title="HTTP Inspector">HTTP Inspector</a> åˆ¤æ–­åº”ç”¨å±‚çš„æ•°æ®æ˜¯å¦ä½¿ç”¨ HTTP åè®®ï¼Œå¦‚æœæ˜¯ï¼Œç»­ç»§åˆ¤æ–­ HTTP åè®®çš„ç‰ˆæœ¬å·ï¼ˆHTTP 1.0ã€HTTP 1.1ã€HTTP 2ï¼‰ï¼Œ: </p>
<pre><code class="language-yaml">listener_filters:
  - name: &quot;envoy.listener.http_inspector&quot;
    typed_config: {}
</code></pre>
<h2 id="name-envoylisteneroriginal_src"><a class="header" href="#name-envoylisteneroriginal_src">name: envoy.listener.original_src</a></h2>
<p><strong><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listener_filters/original_src_filter" title="Original Source">Original Source</a>  ç”¨äº<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#envoy-api-field-listener-transparent" title="transparent">é€æ˜ä»£ç†</a>ï¼Œè®© uptream çœ‹åˆ°çš„æ˜¯è¯·æ±‚ç«¯çš„ IPï¼ŒåŒæ–¹å‡æ„ŸçŸ¥ä¸åˆ° envoy çš„å­˜åœ¨ã€‚</strong></p>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listener_filters/original_src_filter" title="Original Source">Original Source</a> æœ‰ç‚¹ç±»ä¼¼äº lvs çš„ <a href="http://www.linuxvirtualserver.org/VS-DRouting.html" title="Virtual Server via Direct Routing">DR æ¨¡å¼</a> ï¼Œå‡è®¾ downstream çš„ IP æ˜¯ 10.1.2.3ï¼Œenvoy çš„ IP æ˜¯ 10.2.2.3ã€‚envoy å°†æŠ¥æ–‡è½¬å‘ç»™ upstream æ—¶å¤ç”¨ downstream çš„æº IPï¼Œupstream çœ‹åˆ°çš„æº IP æ˜¯ downstream çš„ IP  10.1.2.3ï¼Œä¸æ˜¯ envoy çš„ IP 10.2.2.3ã€‚</p>
<p>ä¸ lvs çš„ <a href="http://www.linuxvirtualserver.org/VS-DRouting.html" title="Virtual Server via Direct Routing">DR æ¨¡å¼</a> åŒºåˆ«æ˜¯ï¼Œåœ¨ lvs ä¸­ï¼Œupsteram æ˜¯ç›´æ¥å°†å›åº”åŒ…å‘é€ç»™ downstreamï¼Œè€Œ envoy çš„æ–‡æ¡£ä¸­å¼ºè°ƒï¼Œå¿…é¡»é€šè¿‡é…ç½®ç½‘ç»œç¯å¢ƒï¼Œè®© uptream çš„å›åº”åŒ…å‘é€åˆ° envoy ï¼Œå†ç”± envoy è½¬å‘ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼Œç”¨åˆ°äº†ä¸¤ä¸ª filterï¼šç¬¬ä¸€ä¸ª filter æ˜¯ envoy.listener.proxy_protocolï¼Œç”¨é€”æ˜¯ä»ä»£ç†åè®®ä¸­è§£æå‡ºçœŸå®çš„æº IPï¼Œè¯¦æƒ…è§ä¸‹ä¸€èŠ‚ï¼› ç¬¬äºŒä¸ª filter æ˜¯ envoy.listener.original_src ï¼Œä½œç”¨æ˜¯é€ä¼ æº IPã€‚</p>
<pre><code class="language-yaml">listeners:
- address:
    socket_address:
      address: 0.0.0.0
      port_value: 8888
  listener_filters:
    - name: envoy.listener.proxy_protocol
    - name: envoy.listener.original_src
      config:
        mark: 123
</code></pre>
<p><code>mark 123</code> è®¾ç½®äº†è¢«é€ä¼ çš„æŠ¥æ–‡éœ€è¦æ‰“ä¸Šçš„æ ‡è®°ï¼Œå½“ upstream å’Œ envoy ä½äºåŒä¸€å°æœºå™¨ä¸Šæ—¶ï¼Œå°†æ‰“äº†æ ‡è®°çš„æŠ¥æ–‡è½¬å‘åˆ°æœ¬åœ°: </p>
<pre><code class="language-sh">iptables  -t mangle -I PREROUTING -m mark     --mark 123 -j CONNMARK --save-mark
iptables  -t mangle -I OUTPUT     -m connmark --mark 123 -j CONNMARK --restore-mark
ip6tables -t mangle -I PREROUTING -m mark     --mark 123 -j CONNMARK --save-mark
ip6tables -t mangle -I OUTPUT     -m connmark --mark 123 -j CONNMARK --restore-mark
ip rule add fwmark 123 lookup 100
ip route add local 0.0.0.0/0 dev lo table 100
ip -6 rule add fwmark 123 lookup 100
ip -6 route add local ::/0 dev lo table 100
echo 1 &gt; /proc/sys/net/ipv4/conf/eth0/route_localnet
</code></pre>
<p>ä¸Šé¢çš„è®¾ç½®è§„åˆ™ç”¨åˆ°ä¸€ä¸ª linux çŸ¥è¯†: <a href="envoy/../linuxsys/localip.html">local åœ°å€çš„è®¤å®š</a>ã€‚</p>
<p>å¦‚æœ envoy å’Œ upstream ä¸åœ¨åŒä¸€ä¸ª hostï¼Œéœ€è¦é€šè¿‡è°ƒæ•´ç½‘ç»œç¯å¢ƒä½¿å›åº”åŒ…å›åˆ° envoyã€‚</p>
<h2 id="name-envoylisteneroriginal_dst"><a class="header" href="#name-envoylisteneroriginal_dst">name: envoy.listener.original_dst</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listener_filters/original_dst_filter" title="Original Destination">Original Destination</a> ç”¨æ¥è¯»å– socket çš„é…ç½®é¡¹ <code>SO_ORIGINAL_DST</code>ï¼Œåœ¨ä½¿ç”¨ <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#envoy-api-field-listener-transparent" title="transparent">é€æ˜ä»£ç†æ¨¡å¼</a> æ—¶ç”¨åˆ°ï¼Œåœ¨ envoy ä¸­ï¼Œç”¨è¯¥ filter è·å–æŠ¥æ–‡çš„åŸå§‹ç›®åœ°åœ°å€ï¼š</p>
<pre><code class="language-yaml">listener_filters:
  - name: &quot;envoy.listener.original_dst&quot;
</code></pre>
<h2 id="name-envoylistenerproxy_protocol"><a class="header" href="#name-envoylistenerproxy_protocol">name: envoy.listener.proxy_protocol</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listener_filters/proxy_protocol#config-listener-filters-proxy-protocol" title="Proxy Protocol">Proxy Protocol</a> è§£æä»£ç†åè®®ï¼Œç”¨è¯¥ filter å¯ä»¥è§£æå‡ºçœŸå®çš„æº IPï¼Œå·²çŸ¥æ”¯æŒ <a href="https://www.haproxy.org/download/1.9/doc/proxy-protocol.txt" title="The PROXY protocol">HAProxy Proxy Protocol</a>ï¼ˆ2019-08-09 18:08:01ï¼‰ï¼š</p>
<pre><code class="language-yaml">listener_filters:
  - name: envoy.listener.proxy_protocol
</code></pre>
<h2 id="name-envoylistenertls_inspector"><a class="header" href="#name-envoylistenertls_inspector">name: envoy.listener.tls_inspector</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listener_filters/tls_inspector" title="TLS Inspector">TLS Inspector</a> ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ TLS åè®®ï¼Œå¦‚æœæ˜¯ TLS åè®®ï¼Œè§£æå‡º Server Nameã€Negotiation ä¿¡æ¯ï¼Œè§£æå‡ºæ¥çš„ä¿¡æ¯ç”¨äº FilterChain çš„åŒ¹é…ã€‚</p>
<pre><code class="language-yaml">listener_filters:
  - name: &quot;envoy.listener.tls_inspector&quot;
    typed_config: {}
</code></pre>
<h2 id="å‚è€ƒ-81"><a class="header" href="#å‚è€ƒ-81">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<!-- toc -->
<h1 id="envoy-çš„-network-filter-åˆ—è¡¨"><a class="header" href="#envoy-çš„-network-filter-åˆ—è¡¨">Envoy çš„ network filter åˆ—è¡¨</a></h1>
<p>å¯ä»¥åŠ å…¥åˆ° filter_chains ä¸­çš„ network filter æ•°é‡ä¼—å¤šï¼Œ<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/network_filters" title="Network filters">Network filters</a> ä¸­åˆ—å‡ºäº†ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<pre><code>Dubbo proxy
Client TLS authentication
Echo
External Authorization
Mongo proxy
MySQL proxy
Rate limit
Role Based Access Control (RBAC) Network Filter
Redis proxy
TCP proxy
Thrift proxy
Upstream Cluster from SNI
ZooKeeper proxy
</code></pre>
<p>å¦è¿˜æœ‰ä¸€ä¸ªåä¸º HTTP connection manager çš„ network filterï¼Œè¿™ä¸ª filter ä¸»è¦å¤„ç† http åè®®ï¼Œè‡ªèº«å·²ç»è¶³å¤Ÿå¤æ‚ï¼Œè¢«å•ç‹¬åˆ—å‡º <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/http_conn_man/http_conn_man" title="HTTP connection manager">HTTP connection manager</a>ã€‚</p>
<p>HTTP connection managerã€Thrift proxy å’Œ Dubbo proxy è¿˜æœ‰åœ¨è‡ªå·±å†…éƒ¨ä½¿ç”¨çš„ filterï¼Œåˆ†åˆ«æ˜¯ï¼š <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/http_filters/http_filters" title="HTTP filters">HTTP filters</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/thrift_filters/thrift_filters" title="Thrift filters">Thrift filters</a>ã€<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/dubbo_filters/dubbo_filters" title="Dubbo filters">Dubbo filters</a>ã€‚</p>
<h2 id="envoytcp_proxy"><a class="header" href="#envoytcp_proxy">envoy.tcp_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/tcp_proxy_filter" title="TCP proxy">TCP proxy</a> æ˜¯å››å±‚ tcp ä»£ç†ï¼Œç®¡ç† downstream client ä¸ upstream cluster ä¹‹é—´çš„ tcp è¿æ¥ï¼Œä¿è¯è¿æ¥æ•°ä¸è¶…è¿‡ upstream cluster çš„ä¸Šé™ã€‚</p>
<h2 id="envoyratelimit"><a class="header" href="#envoyratelimit">envoy.ratelimit</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/rate_limit_filter" title="Rate limit">Rate limit</a> æä¾›å…¨å±€é™é€ŸåŠŸèƒ½ï¼ˆéœ€è¦è¿æ¥å¤–éƒ¨çš„é™é€ŸæœåŠ¡ï¼‰ï¼Œå¯ä»¥é™åˆ¶ tcp è¿æ¥é€Ÿç‡å’Œ http è¯·æ±‚é€Ÿç‡ã€‚ä¸ºäº†é¿å…æ¯ä¸ªè¿æ¥ã€æˆ–è€…æ¯ä¸ªè¯·æ±‚éƒ½æŸ¥è¯¢é™é€ŸæœåŠ¡ï¼Œå¯ä»¥è®¾ç½®é™é€ŸæœåŠ¡çš„æŸ¥è¯¢å æ¯”ï¼š</p>
<pre><code class="language-sh">ratelimit.tcp_filter_enabled     # å¯¹åº”æ¯”ä¾‹çš„è¿æ¥ä¼šæŸ¥è¯¢é™é€ŸæœåŠ¡ï¼Œä½†ä¸æ‰§è¡ŒæŸ¥è¯¢ç»“æœ
ratelimit.tcp_filter_enforcing   # å¯¹åº”æ¯”ä¾‹çš„è¿æ¥ä¼šæŸ¥è¯¢é™é€ŸæœåŠ¡ï¼Œå¹¶æŒ‰ç…§æŸ¥è¯¢ç»“æœæ‰§è¡Œ
</code></pre>
<h2 id="envoyfiltersnetworkrbac"><a class="header" href="#envoyfiltersnetworkrbac">envoy.filters.network.rbac</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/rbac_filter" title="Role Based Access Control (RBAC) Network Filter">Role Based Access Control (RBAC) Network Filter</a> æä¾›äº†è®¿é—®æ§åˆ¶çš„èƒ½åŠ›ã€‚</p>
<h2 id="envoyclient_ssl_auth"><a class="header" href="#envoyclient_ssl_auth">envoy.client_ssl_auth</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/client_ssl_auth_filter" title="Client TLS authentication">Client TLS authentication</a> éªŒè¯ client ç«¯çš„è¯ä¹¦ï¼Œå®ƒä¼šä»¥é…ç½®çš„é¢‘ç‡è°ƒç”¨ <code> GET /v1/certs/list/approved</code> è·å–æœ€æ–°çš„æœ‰æ•ˆè¯ä¹¦ã€‚</p>
<h2 id="envoyext_authz"><a class="header" href="#envoyext_authz">envoy.ext_authz</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/ext_authz_filter" title="External Authorization">External Authorization</a> é€šè¿‡å¤–éƒ¨çš„è®¤è¯æœåŠ¡åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦è·å¾—æˆæƒï¼Œå¦‚æœæ²¡æœ‰æˆæƒï¼Œå…³é—­è¿æ¥ã€‚</p>
<pre><code class="language-yaml">filters:
  - name: envoy.ext_authz
    config:
      stat_prefix: ext_authz
      grpc_service:
        envoy_grpc:
          cluster_name: ext-authz

clusters:
  - name: ext-authz
    type: static
    http2_protocol_options: {}
    load_assignment:
      cluster_name: ext-authz
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 10003
</code></pre>
<h2 id="envoyecho"><a class="header" href="#envoyecho">envoy.echo</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/echo_filter" title="Echo">Echo</a> å°†æ”¶åˆ°çš„æ•°æ®åŸæ ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<h2 id="envoyhttp_connection_manager"><a class="header" href="#envoyhttp_connection_manager">envoy.http_connection_manager</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/http_conn_man/http_conn_man" title="HTTP connection manager">HTTP connection manager</a> æ˜¯ä¸“é—¨å¤„ç† http åè®®çš„ network filterï¼Œå› ä¸º http æœ€ç»å¸¸ä½¿ç”¨çš„åè®®ï¼Œå¯¹ä»£ç†åŠŸèƒ½éœ€æ±‚ä¹Ÿéå¸¸å¤šæ ·ï¼Œ HTTP connection manager æœ¬èº«æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ network filterï¼Œåœ¨ envoy æ–‡æ¡£ä¸­è¢«å•ç‹¬åˆ—å‡ºï¼š<a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/http_conn_man/http_conn_man" title="HTTP connection manager">HTTP connection manager</a>ã€‚</p>
<p>HTTP connection manager æœ‰è‡ªå·±ä¸“ç”¨çš„ HTTP filtersï¼Œåœ¨ <a href="envoy/./http-filter.html">http filters</a>  ä¸­å•ç‹¬ä»‹ç»ã€‚</p>
<h2 id="envoyfiltersnetworkthrift_proxy"><a class="header" href="#envoyfiltersnetworkthrift_proxy">envoy.filters.network.thrift_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/thrift_proxy_filter" title="Thrift proxy">Thrift proxy</a> èƒ½å¤Ÿè§£æ thrift åè®®ã€‚</p>
<p>Thrift proxy æœ‰è‡ªå·±ä¸“ç”¨çš„ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/thrift_filters/thrift_filters" title="Thrift filters">Thrift filters</a>ã€‚</p>
<h2 id="envoyfiltersnetworkdubbo_proxy"><a class="header" href="#envoyfiltersnetworkdubbo_proxy">envoy.filters.network.dubbo_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/dubbo_proxy_filter" title="Dubbo proxy">Dubbo proxy</a> è§£æ dubbo client å’Œ service ä¹‹é—´çš„ grpc é€šä¿¡ã€‚</p>
<p>Dubbo proxy æœ‰è‡ªå·±ä¸“ç”¨çš„ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/dubbo_filters/dubbo_filters" title="Dubbo filters">Dubbo filters</a>ã€‚</p>
<pre><code class="language-yaml">filter_chains:
- filters:
  - name: envoy.filters.network.dubbo_proxy
    config:
      stat_prefix: dubbo_incomming_stats
      protocol_type: Dubbo
      serialization_type: Hessian2
      route_config:
        name: local_route
        interface: org.apache.dubbo.demo.DemoService
        routes:
        - match:
            method:
              name:
                exact: sayHello
          route:
            cluster: user_service_dubbo_server
      dubbo_filters:
      - name: envoy.filters.dubbo.testFilter
        config:
          &quot;@type&quot;: type.googleapis.com/google.protobuf.Struct
          value:
            name: test_service
      - name: envoy.filters.dubbo.router
</code></pre>
<h2 id="envoyfiltersnetworkzookeeper_proxy"><a class="header" href="#envoyfiltersnetworkzookeeper_proxy">envoy.filters.network.zookeeper_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/zookeeper_proxy_filter" title="ZooKeeper proxy">ZooKeeper proxy</a>  èƒ½å¤Ÿè§£æ zookeeper åè®®ã€‚</p>
<h2 id="envoymongo_proxy"><a class="header" href="#envoymongo_proxy">envoy.mongo_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/mongo_proxy_filter" title="Mongo proxy">Mongo proxy</a> èƒ½å¤Ÿè§£æ mongo é€šä¿¡ï¼Œè®°å½• mongo æ—¥å¿—ã€ç»Ÿè®¡ã€æ³¨å…¥é”™è¯¯ç­‰ã€‚</p>
<h2 id="envoyfiltersnetworkmysql_proxy"><a class="header" href="#envoyfiltersnetworkmysql_proxy">envoy.filters.network.mysql_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/mysql_proxy_filter" title="MySQL proxy">MySQL proxy</a> èƒ½å¤Ÿè§£æ mysql çš„é€šä¿¡åè®®ï¼Œéœ€è¦å’Œ [TCP proxy][] ä¸€èµ·ä½¿ç”¨ï¼š</p>
<pre><code class="language-yaml">filter_chains:
- filters:
  - name: envoy.filters.network.mysql_proxy
    typed_config:
      &quot;@type&quot;: type.googleapis.com/envoy.config.filter.network.mysql_proxy.v1alpha1.MySQLProxy
      stat_prefix: mysql
  - name: envoy.tcp_proxy
    typed_config:
      &quot;@type&quot;: type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy
      stat_prefix: tcp
      cluster: ...
</code></pre>
<h2 id="envoyredis_proxy"><a class="header" href="#envoyredis_proxy">envoy.redis_proxy</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/configuration/network_filters/redis_proxy_filter" title="Redis proxy">Redis proxy</a> èƒ½å¤Ÿè§£æ redis åè®®ï¼Œä½¿ envoy æˆä¸º redis ä»£ç†ï¼Œå¯ä»¥å°†ä¸åŒçš„ redis command ä»£ç†åˆ°ä¸åŒ redis clusterã€‚</p>
<h2 id="å‚è€ƒ-82"><a class="header" href="#å‚è€ƒ-82">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="http_connection_manager-ä¸­çš„-http-filter"><a class="header" href="#http_connection_manager-ä¸­çš„-http-filter">http_connection_manager ä¸­çš„ http filter</a></h1>
<p><a href="https://www.lijiaocn.com/soft/envoy/network-filter.html#name-envoyhttpconnectionmanager" title="http_connection_manager ">http_connection_manager</a> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ network filterï¼Œå®ƒå†…éƒ¨åˆå®ç°äº† http filterï¼Œæ”¯æŒçš„ filter æ•°é‡è¾ƒå¤šï¼Œè¿™é‡Œä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œå¯ä»¥åˆ° <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_filters/http_filters" title="HTTP filters">HTTP filters</a> æŸ¥çœ‹ï¼Œå®˜æ–¹æ–‡æ¡£æ¯”è¾ƒè¯¦ç»†ã€‚</p>
<h2 id="envoyrouter"><a class="header" href="#envoyrouter">envoy.router</a></h2>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_filters/router_filter" title="envoy.router">envoy.router</a> çš„æ’ä»¶åç§°å°±æ˜¯ envoy.routerï¼š</p>
<pre><code class="language-go">httpFilter := &amp;http_conn_manager.HttpFilter{
    Name: &quot;envoy.router&quot;,
    ConfigType: &amp;http_conn_manager.HttpFilter_Config{
        Config: http_filter_router,
    },
}
</code></pre>
<p>æˆ–è€…ï¼š</p>
<pre><code class="language-json">&quot;http_filters&quot;: [
   {
     &quot;name&quot;: &quot;envoy.router&quot;,
     &quot;config&quot;: {
       &quot;dynamic_stats&quot;: false
     }
   }
 ],
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ envoy.router åªæ˜¯è®¾ç½®é‡è¯•æ¬¡æ•°ä¹‹ç±»çš„é…ç½®é¡¹ï¼Œè½¬å‘è§„åˆ™é…ç½®ç›´æ¥éš¶å±äº http_connection_manager ï¼Œä¸æ˜¯ç‹¬ç«‹çš„ filterï¼š</p>
<p><img src="envoy/../img/envoy/envoy-http-conn-router.png" alt="envoy-http-conn-router" /></p>
<h2 id="å‚è€ƒ-83"><a class="header" href="#å‚è€ƒ-83">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<!-- toc -->
<h1 id="envoy-4-å±‚-tcpudp-åè®®è½¬å‘"><a class="header" href="#envoy-4-å±‚-tcpudp-åè®®è½¬å‘">Envoy 4 å±‚ TCP/UDP åè®®è½¬å‘</a></h1>
<p>4 å±‚åè®®ç°åœ¨åªæ”¯æŒ tcpï¼Œudp åè®®çš„æ”¯æŒè¿˜åœ¨è®¾è®¡å¼€å‘ä¸­ <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-to-tcp.yaml" title="envoy-to-tcp.yaml">UDP proxying support</a>ã€‚</p>
<p>Envoy çš„ 4 å±‚ä»£ç†è½¬å‘é€šè¿‡åä¸º <a href="envoy/./network-filter.html">envoy.tcp_proxy</a> çš„ network filter å®Œæˆï¼Œè¯¥ filter çš„å®šä¹‰è§ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/api-v2/config/filter/network/tcp_proxy/v2/tcp_proxy.proto#envoy-api-msg-config-filter-network-tcp-proxy-v2-tcpproxy" title="TCP Proxy configuration overview">TCP Proxy configuration overview</a>ã€‚</p>
<h2 id="envoy-tcp-è½¬å‘ç¤ºä¾‹"><a class="header" href="#envoy-tcp-è½¬å‘ç¤ºä¾‹">envoy tcp è½¬å‘ç¤ºä¾‹</a></h2>
<p>ç›‘å¬ 81  ç«¯å£ï¼Œå°†åˆ°è¾¾è¯¥ç«¯å£çš„ tcp æŠ¥æ–‡è½¬å‘ç»™ echo_clusterï¼Œç¤ºä¾‹é…ç½®æ–‡ä»¶ä¸º <a href="https://github.com/introclass/go-code-example/blob/master/envoydev/xds/envoy-docker-run/envoy-to-tcp.yaml" title="envoy-to-tcp.yaml">envoy-to-tcp.yaml</a>ï¼š</p>
<pre><code class="language-yaml">...çœç•¥...
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: 81
    filter_chains:
    - filters:
      - name: envoy.tcp_proxy
        config:
          stat_prefix: tcp_proxy_81
          cluster: echo_tcp_80
  clusters:
  - name: echo_tcp_80
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    #http2_protocol_options: {}  #echoserverä¸æ”¯æŒhttp 2.0
    load_assignment:
      cluster_name: service_echo
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address:  172.17.0.2
                port_value: 8080
</code></pre>
<p>æ³¨æ„ä½¿ç”¨çš„ filter åç§°ä¸º â€œenvoy.tcp_proxyâ€ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ ./run.sh  envoy-to-tcp.yaml
$ curl 127.0.0.1:81

Hostname: 7759cabd7402

Pod Information:
	-no pod information available-
... çœç•¥...
</code></pre>
<p><a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/api-v2/config/filter/network/tcp_proxy/v2/tcp_proxy.proto#envoy-api-msg-config-filter-network-tcp-proxy-v2-tcpproxy" title="TCP Proxy configuration overview">tcp_proxy</a> è¿˜æ”¯æŒ weighted_clustersï¼Œå¯ä»¥è®¾ç½® access_logï¼Œè¯¦æƒ…è§ <a href="https://www.envoyproxy.io/docs/envoy/v1.11.0/api-v2/config/filter/network/tcp_proxy/v2/tcp_proxy.proto#envoy-api-msg-config-filter-network-tcp-proxy-v2-tcpproxy" title="TCP Proxy configuration overview">TCP Proxy configuration overview</a>ã€‚</p>
<h2 id="å‚è€ƒ-84"><a class="header" href="#å‚è€ƒ-84">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<blockquote>
<p>è§†é¢‘è®²è§£ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1209487865&amp;_trace_c_p_k2_=18c88dad391f427b9e40e0795d8d939d">Envoyæ‰‹æŠŠæ‰‹å…¥é—¨è§†é¢‘è®²è§£</a></p>
</blockquote>
<h1 id="envoy-ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å¸¸è§é—®é¢˜"><a class="header" href="#envoy-ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å¸¸è§é—®é¢˜">Envoy ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å¸¸è§é—®é¢˜</a></h1>
<p>è¿™é‡Œæ˜¯ Envoy ä½¿ç”¨è¿‡ç¨‹ä¸­å¸¸é‡åˆ°çš„é—®é¢˜ã€‚</p>
<h2 id="listener-çš„ç«¯å£ä¸å¯ä»¥é‡å¤"><a class="header" href="#listener-çš„ç«¯å£ä¸å¯ä»¥é‡å¤">Listener çš„ç«¯å£ä¸å¯ä»¥é‡å¤</a></h2>
<p>å¦‚æœä¸ºä¸¤ä¸ª listener é…ç½®äº†ç›¸åŒçš„ç›‘å¬ç«¯å£ï¼Œåä¸€ä¸ª listener ä¼šå¤±è´¥ï¼š</p>
<pre><code class="language-sh">[2019-09-19 08:38:17.655][1][info][main] [source/server/server.cc:516] starting main dispatch loop
[2019-09-19 08:38:17.664][1][critical][config] [source/server/listener_manager_impl.cc:684] listener 'listener_1' failed to listen on address '0.0.0.0:81' on worker
</code></pre>
<p>listener çš„ç›‘å¬ç«¯å£ä¸èƒ½é‡å¤ã€‚</p>
<h2 id="route-çš„åŸŸåä¸èƒ½é‡å¤"><a class="header" href="#route-çš„åŸŸåä¸èƒ½é‡å¤">Route çš„åŸŸåä¸èƒ½é‡å¤</a></h2>
<p>Http è·¯ç”±ä¸­çš„åŸŸåä¸èƒ½é‡å¤ï¼Œå¦‚æœä¸¤ä¸ª Route ä¸­é…ç½®äº†ç›¸åŒçš„åŸŸåï¼Œæˆ–è€…ä¸€ä¸ª Route ä¸­é…ç½®äº†ä¸¤ä¸ªç›¸åŒçš„åŸŸåï¼Œé‚£ä¹ˆé…ç½®ä¼šä¸‹å‘å¤±è´¥ï¼Œenvoy æ‰“å°ä¸‹é¢çš„æ—¥å¿—ï¼š</p>
<pre><code class="language-sh">[2019-09-10 08:41:35.917][1][warning][config] [source/common/config/grpc_mux_subscription_impl.cc:72] gRPC config for type.googleapis.com/envoy.api.v2.Listener rejected: Error adding/updating listener(s) TCP-80: Only unique values for domains are permitted. Duplicate entry of domain echo.example
[2019-09-10 08:41:35.919][1][warning][config] [source/common/config/grpc_mux_subscription_impl.cc:72] gRPC config for type.googleapis.com/envoy.api.v2.Listener rejected: Error adding/updating listener(s) TCP-80: Only unique values for domains are permitted. Duplicate entry of domain echo.example
[2019-09-10 08:41:35.921][1][warning][config] [source/common/config/grpc_mux_subscription_impl.cc:72] gRPC config for type.googleapis.com/envoy.api.v2.Listener rejected: Error adding/updating listener(s) TCP-80: Only unique values for domains are permitted. Duplicate entry of domain echo.example
[2019-09-10 08:41:35.922][1][warning][config] [source/common/config/grpc_mux_subscription_impl.cc:72] gRPC config for type.googleapis.com/envoy.api.v2.Listener rejected: Error adding/updating listener(s) TCP-80: Only unique values for domains are permitted. Duplicate entry of domain echo.example
</code></pre>
<h2 id="route-çš„-prefix-å¯ä»¥é‡å¤"><a class="header" href="#route-çš„-prefix-å¯ä»¥é‡å¤">Route çš„ Prefix å¯ä»¥é‡å¤</a></h2>
<p>Route çš„ Prefix å¯ä»¥é‡å¤ï¼Œè¯•éªŒç»“æœè¡¨æ˜æ’åœ¨å‰é¢çš„ Prefix è¢«é‡‡ç”¨ï¼Œä¸‹é¢çš„ä¾‹å­å‰ç¼€ä¸º /abc çš„è¯·æ±‚è¢«è½¬å‘åˆ° STD@kube-cluster-1@demo-webshell@webshell@80 ï¼š</p>
<pre><code class="language-json">&quot;routes&quot;: [
  {
    &quot;route&quot;: {
      &quot;cluster&quot;: &quot;STD@kube-cluster-1@demo-webshell@webshell@80&quot;,
      &quot;host_rewrite&quot;: &quot;envoy.echo.example&quot;
    },
    &quot;match&quot;: {
      &quot;case_sensitive&quot;: false,
      &quot;prefix&quot;: &quot;/abc&quot;
    }
  },
  {
    &quot;route&quot;: {
      &quot;cluster&quot;: &quot;STD@kube-cluster-1@demo-echo@echo@8080&quot;,
      &quot;host_rewrite&quot;: &quot;envoy.echo.example&quot;
    },
    &quot;match&quot;: {
      &quot;prefix&quot;: &quot;/abc&quot;,
      &quot;case_sensitive&quot;: false
    }
  }
],
</code></pre>
<h2 id="å‚è€ƒ-85"><a class="header" href="#å‚è€ƒ-85">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-å­¦ä¹ èµ„æ–™"><a class="header" href="#nginx-å­¦ä¹ èµ„æ–™">Nginx å­¦ä¹ èµ„æ–™</a></h1>
<p>OpenResty ä½œè€…ç« å®œæ˜¥æœ‰ä¸€ä¸ª <a href="https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html">agentzh çš„ Nginx æ•™ç¨‹ï¼ˆç‰ˆæœ¬ 2016.07.21ï¼‰</a>ï¼Œä¸è¿‡è¿™ä¸ªæ•™ç¨‹æ²¡å†™å®Œï¼Œ
å¯ä»¥ç”¨æ¥åŸ¹å…»æ„Ÿæ€§è®¤è¯†ï¼Œä¸­æ–‡é˜…è¯»èµ·æ¥æ–¹ä¾¿ä¸€äº›ã€‚OpenResty æœ€ä½³å®è·µä¸­æœ‰ä¸€ç« æ˜¯å…³äº <a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx.html">nginx</a> çš„ï¼Œç›¸å¯¹æ¯”è¾ƒé€‚åˆç”¨æ¥å…¥é—¨ï¼Œå¹¶ä¸”æŒ‡å‡ºäº†ä¸€äº›å‘ã€‚</p>
<p>æœ€æƒå¨æœ€å®Œæ•´çš„æ˜¯ nginx å®˜æ–¹çš„æ–‡æ¡£ï¼Œå¯èƒ½ä¸å¤ªé€‚åˆå…¥é—¨ï¼Œé€‚åˆä½œä¸ºæŸ¥è¯¢æ‰‹å†Œï¼š</p>
<ul>
<li>æ–°æ‰‹æ‰‹å†Œï¼š  <a href="https://nginx.org/en/docs/beginners_guide.html">Nginx beginner's guide</a></li>
<li>æŒ‡ä»¤æ‰‹å†Œï¼š<a href="https://nginx.org/en/docs/dirindex.html">Alphabetical index of directives</a>ï¼Œåˆ—å‡ºäº†nginxçš„æ‰€æœ‰æŒ‡ä»¤ï¼ŒæŒ‰ç…§å­—æ¯é¡ºåºæ’åºã€‚</li>
<li>å˜é‡æ‰‹å†Œï¼š<a href="https://nginx.org/en/docs/varindex.html">Alphabetical index of variables</a>ï¼Œåˆ—å‡ºäº†nginxçš„æ‰€æœ‰å˜é‡ï¼ŒæŒ‰ç…§å­—æ¯é¡ºåºã€‚</li>
<li>å…¨å±€æ‰‹å†Œï¼š<a href="http://nginx.org/en/docs/">Nginx documentation</a>ï¼Œnginxå®˜æ–¹æ–‡æ¡£çš„é¦–é¡µï¼Œåˆ—å‡ºäº†nginxè‡ªå¸¦çš„æ‰€æœ‰moduleã€‚</li>
<li>æºä»£ç ï¼š  <a href="https://github.com/nginx/nginx">Nginx source code</a></li>
</ul>
<h2 id="å‚è€ƒ-86"><a class="header" href="#å‚è€ƒ-86">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-å­¦ä¹ ä½¿ç”¨çš„è¯•éªŒç¯å¢ƒ"><a class="header" href="#nginx-å­¦ä¹ ä½¿ç”¨çš„è¯•éªŒç¯å¢ƒ">Nginx å­¦ä¹ ä½¿ç”¨çš„è¯•éªŒç¯å¢ƒ</a></h1>
<p>åœ¨ mac ä¸Šå®‰è£… nginx :</p>
<pre><code class="language-sh">$ brew install nginx
Docroot is: /usr/local/var/www

The default port has been set in /usr/local/etc/nginx/nginx.conf to 8080 so that
nginx can run without sudo.

nginx will load all files in /usr/local/etc/nginx/servers/.

To have launchd start nginx now and restart at login:
  brew services start nginx
Or, if you do nott want/need a background service you can just run:
  nginx
==&gt; Summary
ğŸº  /usr/local/Cellar/nginx/1.17.3_1: 25 files, 2MB
</code></pre>
<p>mac ä¸Šçš„ nginx çš„é…ç½®æ–‡ä»¶ä¸ºï¼š/usr/local/etc/nginx/nginx.conf</p>
<p>server é…ç½®çš„æ”¾ç½®ç›®å½•ï¼š/usr/local/etc/nginx/servers/</p>
<h2 id="éªŒè¯-nginx"><a class="header" href="#éªŒè¯-nginx">éªŒè¯ nginx</a></h2>
<p>å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">$ brew services start nginx
</code></pre>
<p>æŸ¥çœ‹çŠ¶æ€ï¼š</p>
<pre><code class="language-sh">$ brew services list
Name       Status  User   Plist
nginx      started lijiao /Users/lijiao/Library/LaunchAgents/homebrew.mxcl.nginx.plist
</code></pre>
<p>è®¿é—®ï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:8080
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
...
</code></pre>
<p>åœæ­¢ï¼š</p>
<pre><code class="language-sh">$ brew services stop nginx
</code></pre>
<h2 id="éªŒè¯ä»£ç†åŠŸèƒ½"><a class="header" href="#éªŒè¯ä»£ç†åŠŸèƒ½">éªŒè¯ä»£ç†åŠŸèƒ½</a></h2>
<p>åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª <a href="nginx/../envoy/echoserver.html">echoserver</a> æœåŠ¡ï¼š</p>
<pre><code class="language-sh">docker run -idt --name echoserver -p 9090:8080 -p 9443:8443 googlecontainer/echoserver:1.10
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">./start_echoserver.sh
</code></pre>
<p>åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œecho.example.confï¼š</p>
<pre><code class="language-conf">upstream echo_upstream{
    server  127.0.0.1:9090;
    keepalive 1;
}

server {
    listen       9000;
    listen       [::]:9000;
    server_name  echo.example;
    keepalive_requests  2000;
    keepalive_timeout 60s;

    location / {
        proxy_pass  http://echo_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection &quot;&quot;;
    }
}
</code></pre>
<p>è¿æ¥åˆ° /usr/local/etc/nginx/servers/ ç›®å½•ä¸­ï¼š</p>
<pre><code class="language-sh">./link.sh echo.example.conf
</code></pre>
<p>éªŒè¯é…ç½®ï¼š</p>
<pre><code class="language-sh">/usr/local/bin/nginx -c /usr/local/etc/nginx/nginx.conf
</code></pre>
<p>é‡å¯ nginx åï¼Œè®¿é—®ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: echo.example&quot; 127.0.0.1:9000

Hostname: 12a852d64212

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008
</code></pre>
<h2 id="å‚è€ƒ-87"><a class="header" href="#å‚è€ƒ-87">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="nginx-é…ç½®æ–‡ä»¶æ ¼å¼"><a class="header" href="#nginx-é…ç½®æ–‡ä»¶æ ¼å¼">Nginx é…ç½®æ–‡ä»¶æ ¼å¼</a></h1>
<p>Nginx çš„æºä»£ç ä¸­æœ‰ä¸ªé…ç½®æ–‡ä»¶ <a href="https://github.com/nginx/nginx/blob/master/conf/nginx.conf">nginx.conf</a> æ ·ä¾‹ï¼ŒCentOS å®‰è£…çš„ nginx è‡ªå¸¦çš„é»˜è®¤é…ç½®æ–‡ä»¶ç»“æ„æ›´å¥½ã€‚</p>
<h2 id="centos-çš„-nginx-é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼"><a class="header" href="#centos-çš„-nginx-é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼">CentOS çš„ nginx é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼</a></h2>
<blockquote>
<p>mac ä¸Šçš„ nginx çš„é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼å’Œ CentOS ç±»ä¼¼ï¼Œé…ç½®æ–‡ä»¶ä½äº /usr/local/etc/nginx/nginx.conf</p>
</blockquote>
<p>ç”¨ yum å‘½ä»¤åœ¨ CentOS ä¸­å®‰è£… nginx çš„ï¼Œé»˜è®¤ä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ <code>/etc/nginx/nginx.conf</code>ï¼š</p>
<pre><code class="language-ini"># For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf; 

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    # é»˜è®¤çš„server
    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        root         /usr/share/nginx/html;

        # é»˜è®¤serverçš„é…ç½®ä¹Ÿå†™åˆ°å•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }

# TLS é…ç½®æ–¹æ³•
# Settings for a TLS enabled server.
    server {
        listen       443 ssl http2 default_server;
        listen       [::]:443 ssl http2 default_server;
        server_name  _;
        root         /usr/share/nginx/html;

        ssl_certificate &quot;/etc/pki/nginx/server.crt&quot;;
        ssl_certificate_key &quot;/etc/pki/nginx/private/server.key&quot;;
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout  10m;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
}
</code></pre>
<p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ª <code>include</code> æŒ‡ä»¤éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªæŒ‡ä»¤åˆå¼•å…¥äº†å…¶å®ƒçš„é…ç½®æ–‡ä»¶ï¼Œå®ƒä»¬åˆ†åˆ«åŠ è½½äº† Nginx æ¨¡å—å’Œ Server é…ç½®ã€‚</p>
<h3 id="ç¬¬ä¸€ä¸ª-includeåŠ è½½-nginx-æ¨¡å—"><a class="header" href="#ç¬¬ä¸€ä¸ª-includeåŠ è½½-nginx-æ¨¡å—">ç¬¬ä¸€ä¸ª includeï¼šåŠ è½½ nginx æ¨¡å—</a></h3>
<p>ç¬¬ä¸€ä¸ª include æŒ‡ä»¤æ˜¯å¯¼å…¥ nginx æ¨¡å—çš„åŠ è½½æŒ‡ä»¤ï¼š</p>
<pre><code class="language-conf"># Load dynamic modules. See /usr/share/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf; 
</code></pre>
<p>åœ¨ /usr/share/nginx/modules ç›®å½•ä¸­æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªé…ç½®æ–‡ä»¶ç”¨æ¥åŠ è½½ä¸€ä¸ª nginx æ¨¡å—ï¼š</p>
<pre><code class="language-bash">$ ls  /usr/share/nginx/modules/
mod-http-geoip.conf  mod-http-image-filter.conf  mod-http-perl.conf  
mod-http-xslt-filter.conf  mod-mail.conf  mod-stream.conf
</code></pre>
<p>ä»¥ <code>mod-http-geoip.conf</code> ä¸ºä¾‹ï¼Œæ¨¡å—çš„åŠ è½½å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-conf">load_module &quot;/usr/lib64/nginx/modules/ngx_http_geoip_module.so&quot;;
</code></pre>
<h3 id="ç¬¬ä¸€ä¸ª-includeåŠ è½½-server-é…ç½®"><a class="header" href="#ç¬¬ä¸€ä¸ª-includeåŠ è½½-server-é…ç½®">ç¬¬ä¸€ä¸ª includeï¼šåŠ è½½ server é…ç½®</a></h3>
<p>ç¬¬äºŒä¸ª include åŠ è½½ server é…ç½®ï¼š</p>
<pre><code class="language-conf">include /etc/nginx/conf.d/*.conf;
</code></pre>
<p>Nginx æ˜¯ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œå®ƒå¯ä»¥åŒæ—¶ä»£ç†å¤šä¸ªåç«¯æœåŠ¡ï¼Œå°†è¿™äº›åç«¯æœåŠ¡çš„é…ç½®å†™åˆ°å„è‡ªçš„å•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ç®€åŒ–é…ç½®æ–‡ä»¶å¹¶ä¸”æ–¹ä¾¿ç®¡ç†ã€‚</p>
<p>æ¯”å¦‚è¯´ /etc/nginx/conf.d/flarum.conf ä¸­å…¨éƒ½æ˜¯ flarum.local æœåŠ¡ç›¸å…³çš„é…ç½®ï¼š</p>
<pre><code class="language-conf">server {
    listen       80 ;
    listen       [::]:80 ;
    server_name  flarum.local;                         # åœ¨æœ¬åœ° host é…ç½®åŸŸå
    root         /vagrant/flarum/2_flarum/project;     # è¿™é‡Œæ˜¯ composer å®‰è£…çš„ flarum é¡¹ç›®ç›®å½•

    location / { try_files $uri $uri/ /index.php?$query_string; }
    location /api { try_files $uri $uri/ /api.php?$query_string; }
    location /admin { try_files $uri $uri/ /admin.php?$query_string; }

    location /flarum {
            deny all;
            return 404;
    }

    location ~* \.php$ {
            fastcgi_split_path_info ^(.+.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param HTTP_PROXY &quot;&quot;; # Fix for https://httpoxy.org/ vulnerability
            fastcgi_index index.php;
    }
    #...çœç•¥éƒ¨åˆ†å†…å®¹...
    gzip on;
    gzip_http_version 1.1;
    gzip_vary on;
}
</code></pre>
<h2 id="api-ç½‘å…³-kong-çš„é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼"><a class="header" href="#api-ç½‘å…³-kong-çš„é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼">API ç½‘å…³ kong çš„é…ç½®æ–‡ä»¶ç»„ç»‡æ–¹å¼</a></h2>
<p>Kong æ˜¯åŸºäº OpenResty å®ç°çš„ API ç½‘å…³ï¼ŒOpenResty åŸºäº nginxï¼Œkong ä½¿ç”¨çš„ nginx.conf å¦‚ä¸‹ï¼š</p>
<pre><code class="language-conf">worker_processes auto;
daemon off;

pid pids/nginx.pid;
error_log logs/error.log debug;

worker_rlimit_nofile 1024;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    # kongçš„é…ç½®å•ç‹¬å†™å…¥åˆ°å¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­
    include 'nginx-kong.conf';
}
</code></pre>
<h2 id="å‚è€ƒ-88"><a class="header" href="#å‚è€ƒ-88">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="nginx-çš„å¸¸ç”¨é…ç½®"><a class="header" href="#nginx-çš„å¸¸ç”¨é…ç½®">Nginx çš„å¸¸ç”¨é…ç½®</a></h1>
<p>ä¸€äº›å¸¸ç”¨çš„ nginx  é…ç½®ã€‚</p>
<h2 id="æ—¥å¿—"><a class="header" href="#æ—¥å¿—">æ—¥å¿—</a></h2>
<p>è®¾ç½®é”™è¯¯æ—¥å¿—æ–‡ä»¶å’Œæ—¥å¿—çº§åˆ«ï¼Œä¸€èˆ¬åœ¨é…ç½®æ–‡ä»¶æœ€å¼€å§‹å¤„é…ç½®ï¼š</p>
<pre><code class="language-conf">error_log  /tmp/logs/error.log  info;
</code></pre>
<p>æ—¥å¿—æ ¼å¼ log_format åˆ†ä¸º <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" title="http log_format">http log_format</a> å’Œ <a href="http://nginx.org/en/docs/stream/ngx_stream_log_module.html#log_format" title="stream log_format">stream log_format</a>ï¼Œä¸¤è€…çš„æ ¼å¼ä¸­å¯ä»¥ä½¿ç”¨çš„å˜é‡ä¸åŒã€‚</p>
<p>ç´§è·Ÿåœ¨ log_format åé¢çš„å­—ç¬¦ä¸²æ˜¯æ—¥å¿—æ ¼å¼çš„åç§°ï¼Œnginx æ”¯æŒå®šä¹‰å¤šä¸ªæ ¼å¼ï¼Œä»¥ http log_format ä¸ºä¾‹ï¼š</p>
<pre><code class="language-conf"># æ ¼å¼åç§°ä¸º main
log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                  '$status $body_bytes_sent &quot;$http_referer&quot; '
                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';
</code></pre>
<p>http çš„æ—¥å¿—æ ¼å¼ä¸­å¯ä»¥æ·»åŠ ä»»æ„çš„ http å¤´ï¼Œä¾‹å¦‚ä¸Šé¢çš„ <code>$http_user_agent</code>ã€‚</p>
<p>æ—¥å¿—æ ¼å¼åªç”¨äºè®¿é—®æ—¥å¿—ï¼Œç”¨ access_log å¼•ç”¨å¼•ç”¨ï¼Œaccess_log åŒæ ·åˆ†ä¸º <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" title="http access_log">http access_log</a> å’Œ <a href="http://nginx.org/en/docs/stream/ngx_stream_log_module.html#access_log" title="stream access_log">stream access_log</a>ã€‚http çš„ access_log å¯ä»¥åœ¨ location ä¸­å•ç‹¬è®¾ç½®ã€‚</p>
<p>ä½¿ç”¨æ•ˆæœï¼Œåœ¨ http ä¸­å®šä¹‰ tranproxyï¼š</p>
<pre><code class="language-conf">http{
    ...çœç•¥...
    log_format tranproxy '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
            '$status $body_bytes_sent &quot;$http_referer&quot; '
            '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    ...çœç•¥...
}
</code></pre>
<p>åœ¨ location ä¸­å¼•ç”¨ï¼š</p>
<pre><code class="language-conf">location / {
    access_log /var/log/nginx/access.80.log tranproxy;
    ... çœç•¥ ...
}
</code></pre>
<p>è®¿é—®æ—¥å¿—ï¼Œä¸å¸¦ <code>-H X-Forwarded-For</code> æ—¶ï¼š</p>
<pre><code class="language-sh">172.17.0.5 - - [14/Nov/2019:03:12:15 +0000] &quot;GET / HTTP/1.1&quot; 200 467 &quot;-&quot; &quot;curl/7.61.1&quot; &quot;-&quot;
</code></pre>
<p>è®¿é—®æ—¥å¿—ï¼Œå¸¦æœ‰ <code>-H X-Forwarded-For</code> æ—¶ï¼š</p>
<pre><code class="language-sh">172.17.0.5 - - [14/Nov/2019:03:12:15 +0000] &quot;GET / HTTP/1.1&quot; 200 467 &quot;-&quot; &quot;curl/7.61.1&quot; &quot;127.0.0.1&quot;
</code></pre>
<h2 id="location-çš„åŒ¹é…è§„åˆ™"><a class="header" href="#location-çš„åŒ¹é…è§„åˆ™">location çš„åŒ¹é…è§„åˆ™</a></h2>
<p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">location</a> æ˜¯æœ€å¸¸ç”¨çš„ï¼Œæ”¯æŒå››ä¸ªä¿®é¥°ç¬¦ï¼š <code>=</code>ã€<code>~</code>ã€<code> ~*</code>ã€<code>^~</code>ã€‚</p>
<ul>
<li><code>=</code>:  ä¸¥æ ¼ä¸€è‡´</li>
<li><code>~</code>:  åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</li>
<li><code>~*</code>: ä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</li>
<li><code>^~</code>: å‰ç¼€åŒ¹é…æˆåŠŸåï¼Œå¿½ç•¥æ­£åˆ™åŒ¹é…</li>
</ul>
<p>æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•å‚è€ƒ <code>man 7 regex</code>ï¼Œä¸‹é¢çš„è¡¨è¾¾å¼åŒ¹é…ä»¥ /detail å¼€å¤´ä¸”ä¸å«æœ‰ <code>.</code> è·¯å¾„ï¼š</p>
<pre><code class="language-conf">location ~ '^/detail/[^.]*$ {
    ...çœç•¥...
}
</code></pre>
<h2 id="å‚è€ƒ-89"><a class="header" href="#å‚è€ƒ-89">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="nginx-æ€§èƒ½ä¼˜åŒ–æ—¶éœ€è¦è€ƒè™‘çš„é…ç½®"><a class="header" href="#nginx-æ€§èƒ½ä¼˜åŒ–æ—¶éœ€è¦è€ƒè™‘çš„é…ç½®">Nginx æ€§èƒ½ä¼˜åŒ–æ—¶éœ€è¦è€ƒè™‘çš„é…ç½®</a></h1>
<p>åšå‹æµ‹æ—¶äº†è§£åˆ°ä¸€äº›é…ç½®ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚è°ƒæ•´çš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-conf"># è¿™ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„é…ç½®æ–‡ä»¶
worker_processes 2;
worker_cpu_affinity 0010 1000;
worker_rlimit_nofile  10340;
worker_priority -20;
events {
    worker_connections 10240;
    worker_aio_requests 32;
}
http{
...
    upstream webshell_upstream{
        keepalive 16;
        keepalive_timeout 60s;                # nginx 1.15.3
    }
    ...
    server {
        ...
        keepalive_requests  10000000;
        location / {
            ...
            proxy_socket_keepalive on;
            proxy_connect_timeout  60s;       # nginx 1.15.6
            proxy_send_timeout     60s;
            proxy_read_timeout     60s;
            proxy_http_version     1.1;
            proxy_set_header Connection &quot;&quot;;
        }
    }
}
</code></pre>
<h2 id="core-functionality"><a class="header" href="#core-functionality">Core functionality</a></h2>
<p><a href="https://nginx.org/en/docs/ngx_core_module.html">Core functionality</a> åŒ…å« nginx çš„æ ¸å¿ƒå‚æ•°ï¼Œä¸æ€§èƒ½ç›´æ¥ç›¸å…³çš„æœ‰ï¼š</p>
<ul>
<li><a href="https://nginx.org/en/docs/ngx_core_module.html#worker_processes">worker_processes</a>ï¼šnginx å·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼Œé»˜è®¤æ˜¯<code>auto</code></li>
<li><a href="https://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity">worker_cpu_affinity</a>ï¼šnginxå·¥ä½œè¿›ç¨‹ç»‘å®šåˆ°æŒ‡å®šçš„CPUæ ¸</li>
<li><a href="https://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile">worker_rlimit_nofile</a>ï¼šå•ä¸ªnginx workerå¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æ•°ï¼Œå½±å“ nginx worker å»ºç«‹çš„è¿æ¥æ•°é‡</li>
<li><a href="https://nginx.org/en/docs/ngx_core_module.html#worker_priority">worker_priority</a>ï¼šnginx worker è¿›ç¨‹åœ¨ç³»ç»Ÿä¸­çš„ä¼˜å…ˆçº§ï¼Œ<code>-20~+20</code>ï¼Œ<code>-20</code>æ˜¯æœ€é«˜ä¼˜å…ˆçº§</li>
<li><a href="https://nginx.org/en/docs/ngx_core_module.html#worker_connections">worker_connections</a>ï¼šå•ä¸ª nginx worker å¯ä»¥å»ºç«‹çš„è¿æ¥æ•°é‡ï¼Œ<code>ä¸èƒ½é«˜äº</code> worker_rlimit_nofileã€‚</li>
</ul>
<h2 id="module-ngx_http_proxy_module"><a class="header" href="#module-ngx_http_proxy_module">Module ngx_http_proxy_module</a></h2>
<p><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html">Module ngx_http_proxy_module</a> åŒ…å«ä»£ç†ç›¸å…³è®¾ç½®ï¼Œä¸æ€§èƒ½ç›´æ¥ç›¸å…³çš„æœ‰ï¼š</p>
<ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_http_version">proxy_http_version</a>ï¼šnginx åˆ° upstream ä¸­çš„ server æ—¶ä½¿ç”¨çš„åè®®ï¼Œé»˜è®¤æ˜¯ httpï¼Œä¸ä¼šå»ºç«‹é•¿è¿æ¥ã€‚è®¾ç½®æˆ http 1.1 ï¼Œç”¨ <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">proxy_set_header</a> å°† <code>Connection</code> å¤´å»æ‰åï¼Œä¼šå¯ç”¨é•¿è¿æ¥ï¼Œæ€§èƒ½æ˜¾è‘—æå‡ã€‚</li>
</ul>
<h2 id="module-ngx_http_upstream_module"><a class="header" href="#module-ngx_http_upstream_module">Module ngx_http_upstream_module</a></h2>
<p><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">Module ngx_http_upstream_module</a> åŒ…å« upstream ç›¸å…³çš„å‚æ•°ï¼Œå…¶ä¸­ä¸æ€§èƒ½ç›´æ¥ç›¸å…³çš„æœ‰ï¼š</p>
<ul>
<li>
<p><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">keepalive</a> ï¼šå•ä¸ª worker å¯ä»¥ä¸ backend server ä¿æŒçš„ç©ºé—²è¿æ¥æ•°ã€‚å¦‚æœè¿™ä¸ªæ•°å€¼è¿‡å°ï¼Œnginx worker ä¼šä¸åœåœ°ä¸ backend server æ–°å»ºè¿æ¥ã€å…³é—­è¿æ¥ã€‚</p>
</li>
<li>
<p><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive_timeout">keepalive_timeout</a>ï¼š<code>1.15.3</code>ä¸­å¼€å§‹æœ‰çš„å‚æ•°ï¼Œè®¾ç½® nginx worker ä¸ backend server çš„ç©ºé—²çš„è¿æ¥ä¿æŒæ—¶é—´ã€‚æ—©æœŸç‰ˆæœ¬ä¸­æ²¡æœ‰è¿™ä¸ªå‚æ•°ï¼Œé•¿è¿æ¥æ˜¯ä¸€ç›´ä¿æŒï¼ˆå¯ä»¥ç”¨ keepalive_requests çš„å‚æ•°é¿å…ï¼‰ã€‚</p>
</li>
<li>
<p><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive_requests">keepalive_requests</a>ï¼šè®¾ç½® nginx worker ä¸ backend server å»ºç«‹çš„é•¿è¿æ¥ä¸­å¯ä»¥ä¼ è¾“çš„è¯·æ±‚æ•°ï¼Œè¶…è¿‡åè¿æ¥è¢« nginx ä¸»åŠ¨å…³é—­ã€‚</p>
</li>
</ul>
<p>å…³äºé•¿è¿æ¥çš„è®¾ç½®å¯ä»¥å‚è€ƒï¼š<a href="https://ma.ttias.be/enable-keepalive-connections-in-nginx-upstream-proxy-configurations/">Enable Keepalive connections in Nginx Upstream proxy configurations</a>å’Œ<a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html">TCP keepalive overview</a>ã€‚</p>
<h2 id="å‚è€ƒ-90"><a class="header" href="#å‚è€ƒ-90">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="nginx-ä½¿ç”¨æ³¨æ„äº‹é¡¹"><a class="header" href="#nginx-ä½¿ç”¨æ³¨æ„äº‹é¡¹">Nginx ä½¿ç”¨æ³¨æ„äº‹é¡¹</a></h1>
<h2 id="ä¸€äº›é‡è¦æ‘˜è¦"><a class="header" href="#ä¸€äº›é‡è¦æ‘˜è¦">ä¸€äº›é‡è¦æ‘˜è¦</a></h2>
<p>æå‰äº†è§£è¿™äº›ï¼Œå¯ä»¥é¿å…è¸©å‘ï¼š</p>
<p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_brief.html" title="Nginx æ–°æ‰‹èµ·æ­¥">Nginx æ–°æ‰‹èµ·æ­¥</a>ä¸­ç»™å‡ºçš„ä¸€ä¸ªæ•°æ®æ¯”è¾ƒé‡è¦ï¼š </p>
<pre><code>ä¸€èˆ¬çš„æƒ…å†µä¸‹ï¼Œ10000 ä¸ªéæ´»è·ƒçš„ HTTP Keep-Alive è¿æ¥åœ¨ Nginx ä¸­ä»…æ¶ˆè€— 2.5MB çš„å†…å­˜
</code></pre>
<p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/if_is_evil.html" title="if æ˜¯é‚ªæ¶çš„">if æ˜¯é‚ªæ¶çš„</a>ï¼Œæ…ç”¨ifï¼Œå¦‚æœéè¦ç”¨ï¼Œæœ€å¥½åªåœ¨ifä¸­ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<pre><code>åœ¨ location åŒºå—é‡Œ if æŒ‡ä»¤ä¸‹å”¯ä¸€ 100% å®‰å…¨çš„æŒ‡ä»¤åº”è¯¥åªæœ‰:

return â€¦; rewrite â€¦ last;
</code></pre>
<h2 id="å‚è€ƒ-91"><a class="header" href="#å‚è€ƒ-91">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/09/29/nginx-openresty-kong.html" title="APIç½‘å…³Kongï¼ˆä¸€ï¼‰ï¼šNginxã€OpenRestyå’ŒKongçš„åŸºæœ¬æ¦‚å¿µä¸ä½¿ç”¨æ–¹æ³•">APIç½‘å…³Kongï¼ˆä¸€ï¼‰ï¼šNginxã€OpenRestyå’ŒKongçš„åŸºæœ¬æ¦‚å¿µä¸ä½¿ç”¨æ–¹æ³•</a></li>
<li><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_brief.html" title="Nginx æ–°æ‰‹èµ·æ­¥">Nginx æ–°æ‰‹èµ·æ­¥</a></li>
<li><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/if_is_evil.html" title="if æ˜¯é‚ªæ¶çš„">if æ˜¯é‚ªæ¶çš„</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="nginx-çš„çŠ¶æ€æ•°æ®"><a class="header" href="#nginx-çš„çŠ¶æ€æ•°æ®">Nginx çš„çŠ¶æ€æ•°æ®</a></h1>
<h2 id="stub_status"><a class="header" href="#stub_status">stub_status</a></h2>
<p>Nginx çš„ <a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html#stub_status" title="stub_status">stub_status</a> æŒ‡ä»¤ç”¨æ¥æ˜¾ç¤º nginx çš„å·¥ä½œçŠ¶æ€ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-conf">location = /nginx_status {
    allow       127.0.0.1;
    deny        all;

    stub_status  on;    # å¼€å¯çŠ¶æ€
    access_log  off;    # ä¸è®°å½•è¯¥ uri çš„è®¿é—®æ—¥å¿—
}
</code></pre>
<p>æ•ˆæœï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:9000/nginx_status
Active connections: 1
server accepts handled requests
 3 3 3
Reading: 0 Writing: 1 Waiting: 0
</code></pre>
<p><a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html#stub_status" title="stub_status">stub_status</a> ç»™å‡ºäº†å„ä¸ªå‚æ•°å«ä¹‰ï¼š</p>
<pre><code class="language-conf">Active connections  :æ´»è·ƒè¿æ¥æ•°
accepts             :æ¥æ”¶çš„è¿æ¥æ€»æ•° 
handled             :å·²ç»å¤„ç†çš„è¿æ¥æ•°  
requests            :å®¢æˆ·ç«¯è¯·æ±‚æ€»æ•°
Reading             :nginx æ­£åœ¨ä»å…¶ä¸­è¯»å– header çš„è¿æ¥æ•°
Writing             :nginx æ­£åœ¨å‘å®¢æˆ·ç«¯å‘é€å“åº”æ•°æ®çš„è¿æ¥æ•°
Waiting             :idle çŠ¶æ€çš„è¿æ¥
</code></pre>
<p>åŒæ—¶æä¾›äº†ä»¥ä¸‹å¯ç”¨å˜é‡ï¼š</p>
<pre><code class="language-conf">$connections_active
    same as the Active connections value;
$connections_reading
    same as the Reading value;
$connections_writing
    same as the Writing value;
$connections_waiting
    same as the Waiting value.
</code></pre>
<h2 id="å‚è€ƒ-92"><a class="header" href="#å‚è€ƒ-92">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-è¯·æ±‚å¤åˆ¶åŠŸèƒ½"><a class="header" href="#nginx-è¯·æ±‚å¤åˆ¶åŠŸèƒ½">Nginx è¯·æ±‚å¤åˆ¶åŠŸèƒ½</a></h1>
<p>Nginx 1.13.4 å¼•å…¥äº† <a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html%22" title="ngx_http_mirror_module">ngx_http_mirror_module</a>ï¼Œå®ç°äº† http è¯·æ±‚å¤åˆ¶çš„åŠŸèƒ½ã€‚</p>
<h2 id="å‡†å¤‡æ¥æ”¶å¤åˆ¶è¯·æ±‚çš„æœåŠ¡"><a class="header" href="#å‡†å¤‡æ¥æ”¶å¤åˆ¶è¯·æ±‚çš„æœåŠ¡">å‡†å¤‡æ¥æ”¶å¤åˆ¶è¯·æ±‚çš„æœåŠ¡</a></h2>
<p>å¯åŠ¨ä¸¤ä¸ªå®¹å™¨ä¸€ä¸ªæ­£å¸¸å¤„ç†è¯·æ±‚ï¼Œä¸€ä¸ªæ¥æ”¶å¤åˆ¶åˆ°è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">docker rm -f echoserver
docker run -idt --name echoserver -p 9090:8080 googlecontainer/echoserver:1.10

docker rm -f http-record
docker run -idt --name http-record -p 9091:8080 lijiaocn/http-record:0.0.1
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">./start_backends.sh
</code></pre>
<h2 id="é…ç½®è¯·æ±‚å¤åˆ¶"><a class="header" href="#é…ç½®è¯·æ±‚å¤åˆ¶">é…ç½®è¯·æ±‚å¤åˆ¶</a></h2>
<p>åœ¨ nginx çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œé…ç½®é•œåƒå¤åˆ¶ï¼Œå‚è€ƒ <a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html%22" title="ngx_http_mirror_module">ngx_http_mirror_module</a>ã€‚</p>
<pre><code class="language-conf">upstream echo_upstream{
    server  127.0.0.1:9090;
    keepalive 1;
}

upstream http-record_upstream{
    server  127.0.0.1:9091;
    keepalive 1;
}

server {
    listen       9000;
    listen       [::]:9000;
    server_name  echo.example;
    keepalive_requests  2000;
    keepalive_timeout 60s;

    location / {
        mirror /mirror;
        proxy_pass  http://echo_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection &quot;&quot;;
    }

    location = /mirror {
        internal;
        proxy_pass http://http-record_upstream$request_uri;
    }
}
</code></pre>
<p>æ‰€æœ‰å‘é€åˆ° echo.example çš„è¯·æ±‚å°†è¢«å¤åˆ¶ä¸€ä»½åˆ° http-recordï¼Œè¯·æ±‚ç«¯æ”¶åˆ°çš„æ˜¯ echo_upstream çš„å›åº”ï¼Œhttp-record_upstream çš„å›åº”å°†è¢«å¿½ç•¥ã€‚</p>
<h2 id="å¤åˆ¶æ•ˆæœ-1"><a class="header" href="#å¤åˆ¶æ•ˆæœ-1">å¤åˆ¶æ•ˆæœ</a></h2>
<p>å‘èµ·è¯·æ±‚ï¼Œæ”¶åˆ°çš„æ˜¯ echo çš„å›åº”ï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: echo.example&quot; 127.0.0.1:9000/abcd/eft

Hostname: 57e34b409aa1

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.3 - lua: 10008

Request Information:
	client_address=172.17.0.1
	method=GET
	real path=/abcd/eft
	query=
	request_version=1.1
	request_scheme=http
	request_uri=http://echo_upstream:8080/abcd/eft

Request Headers:
	accept=*/*
	host=echo_upstream
	user-agent=curl/7.54.0

Request Body:
	-no body in request-
</code></pre>
<p>æŸ¥çœ‹ http-record å®¹å™¨çš„æ—¥å¿—ï¼Œä¼šå‘ç°æ”¶åˆ°äº†å®Œå…¨ç›¸åŒçš„è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">/go/src/Server/echo.go:46: {
    &quot;RemoteAddr&quot;: &quot;172.17.0.1:46856&quot;,
    &quot;Method&quot;: &quot;GET&quot;,
    &quot;Host&quot;: &quot;http-record_upstream&quot;,
    &quot;RequestURI&quot;: &quot;/abcd/eft&quot;,
    &quot;Header&quot;: {
        &quot;Accept&quot;: [
            &quot;*/*&quot;
        ],
        &quot;Connection&quot;: [
            &quot;close&quot;
        ],
        &quot;User-Agent&quot;: [
            &quot;curl/7.54.0&quot;
        ]
    },
    &quot;Body&quot;: &quot;&quot;
}
</code></pre>
<h2 id="é…ç½®ä¿®æ­£"><a class="header" href="#é…ç½®ä¿®æ­£">é…ç½®ä¿®æ­£</a></h2>
<p>ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„é…ç½® Host æ˜¯ http-record_upstreamï¼Œä¸æ˜¯åŸå§‹çš„ hostã€‚å°†é…ç½®ä¿®æ­£ä¸ºï¼š</p>
<pre><code class="language-conf">    location / {
        access_log /tmp/logs/access.log mirror;
        mirror /mirror;

        # æ·»åŠ è¿™è¡Œé…ç½®
        set $proxy_host $host;    

        proxy_http_version 1.1;
        proxy_set_header Connection &quot;&quot;;

        proxy_pass  http://echo_upstream;
    }
</code></pre>
<h2 id="ç»“åˆ-split_clients-å®ç°è¯·æ±‚çš„éƒ¨åˆ†å¤åˆ¶"><a class="header" href="#ç»“åˆ-split_clients-å®ç°è¯·æ±‚çš„éƒ¨åˆ†å¤åˆ¶">ç»“åˆ split_clients å®ç°è¯·æ±‚çš„éƒ¨åˆ†å¤åˆ¶</a></h2>
<p>ç”¨äº A/B æµ‹è¯•çš„ <a href="nginx/./abtest.html">split_clients</a> æŒ‡ä»¤å’Œ mirror æŒ‡ä»¤é…åˆï¼Œå¯ä»¥å®ç°è¯·æ±‚çš„æŒ‰æ¯”ä¾‹å¤åˆ¶ï¼Œsplit_clients çš„ç”¨æ³•è§ <a href="nginx/./abtest.html">Nginxçš„A/Bæµ‹è¯•åŠŸèƒ½</a>ã€‚</p>
<p>å°† 50% çš„æµé‡å¤åˆ¶åˆ°å¤åˆ¶åˆ° record_upstreamï¼š </p>
<pre><code class="language-conf">split_clients &quot;$date_gmt&quot; $mirror_servers {
    50%        record_upstream;
    *          &quot;&quot;;
}

server {
    listen       9000;
    server_name  echo.example;
    keepalive_requests  1000;
    keepalive_timeout 60s;

    location / {
        access_log /tmp/nginx_access.log mirror;
        mirror /mirror;

        proxy_pass  http://echo_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection &quot;&quot;;
    }

    location = /mirror {
        internal;
        access_log /tmp/nginx_mirror_access.log mirror;
        if ($mirror_servers) {
            proxy_pass http://$mirror_servers$request_uri;
        }
    }
}
</code></pre>
<p>mirror_servers ä¹Ÿå¯ä»¥æ˜¯åŸŸåï¼ŒåŸŸåéœ€è¦æŒ‡å®š dns nameserverï¼š</p>
<pre><code class="language-sh">...çœç•¥...
split_clients &quot;$date_gmt&quot; $mirror_servers {
#   50%        record_upstream;
    100%       local.lijiaocn.com:9091;
    *          &quot;&quot;;
}
...çœç•¥...
    location = /mirror {
        internal;
        access_log off;
        #access_log /tmp/nginx_mirror_access.log mirror;
        resolver 114.114.114.114;

        if ($mirror_servers) {
            set $proxy_host $host;
            proxy_pass http://$mirror_servers$request_uri;
        }
    }
...çœç•¥...
</code></pre>
<h2 id="å‚è€ƒ-93"><a class="header" href="#å‚è€ƒ-93">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html%22" title="ngx_http_mirror_module">ngx_http_mirror_module</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="nginx-çš„-ab-æµ‹è¯•åŠŸèƒ½"><a class="header" href="#nginx-çš„-ab-æµ‹è¯•åŠŸèƒ½">Nginx çš„ A/B æµ‹è¯•åŠŸèƒ½</a></h1>
<p>Nginx çš„æœ‰ä¸€ä¸ª <a href="https://nginx.org/en/docs/http/ngx_http_split_clients_module.html" title="Module ngx_http_split_clients_module">ngx_http_split_clients_module</a> æ¨¡å—ï¼Œå¯ä»¥ç”¨æ¥å®ç° A/B æµ‹è¯•ã€‚</p>
<h2 id="split_clients-ä½¿ç”¨æ–¹æ³•"><a class="header" href="#split_clients-ä½¿ç”¨æ–¹æ³•">split_clients ä½¿ç”¨æ–¹æ³•</a></h2>
<p>split_clients æŒ‡ä»¤çš„ç”¨é€”æ˜¯æ ¹æ®è®¾å®šæ¡ä»¶è®¾ç½®å˜é‡çš„å€¼ï¼Œå¦‚ä¸‹ï¼Œå®šä¹‰äº†ä¸€ä¸ªåä¸º selected_upstream çš„å˜é‡ï¼š</p>
<pre><code class="language-conf">split_clients &quot;$date_gmt&quot; $selected_upstream {
               50%          echo_upstream;
               50%          record_upstream;
}
</code></pre>
<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ MurmurHash2 å“ˆå¸Œç®—æ³•çš„è¾“å…¥ï¼Œå¯ä»¥ä½¿ç”¨ ngxin å˜é‡ï¼Œ50% æ˜¯åŒºé—´åˆ’åˆ†ã€‚ä¸Šé¢çš„é…ç½®ä¸­ï¼Œå“ˆå¸Œè¾“å…¥æ˜¯ date_gmtï¼Œå˜é‡ selected_upstream çš„å€¼ 50% çš„å¯èƒ½æ˜¯ echo_upstreamï¼Œ50% çš„å¯èƒ½æ˜¯ record_upstreamã€‚</p>
<p>selected_upstream çš„å–å€¼æ˜¯æŒ‰ç…§æŒ‡å®šé…ç½®å˜æ¢çš„ï¼Œå¯ä»¥ç”¨æ¥å®ç°ä¸€äº›ç‰¹æ®Šæ•ˆæœï¼Œä¾‹å¦‚ä¸‹é¢çš„é…ç½®ï¼Œè¯·æ±‚ä¼šæŒ‰ç…§æ—¶é—´æƒ…å†µåœ¨ä¸¤ä¸ª upstreamï¼ˆecho_upstream å’Œ record_upstreamï¼‰ä¹‹é—´åˆ†é…ã€‚</p>
<pre><code class="language-conf">upstream echo_upstream {
    server  127.0.0.1:9090;
    keepalive 1;
}

upstream record_upstream {
    server  127.0.0.1:9091;
    keepalive 1;
}

split_clients &quot;$date_gmt&quot; $selected_upstream {
               50%          echo_upstream;
               50%          record_upstream;
}

server {
    listen       9000;
    server_name  echo.example;
    keepalive_requests  1000;
    keepalive_timeout 60s;

    location / {
        proxy_pass  http://$selected_upstream;
        proxy_http_version 1.1;
        proxy_set_header Connection &quot;&quot;;
    }
}
</code></pre>
<h2 id="å‚è€ƒ-94"><a class="header" href="#å‚è€ƒ-94">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_split_clients_module.html" title="Module ngx_http_split_clients_module">Module ngx_http_split_clients_module</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ä½¿ç”¨-nginx-å®ç°æœ¬åœ°é€æ˜ä»£ç†"><a class="header" href="#ä½¿ç”¨-nginx-å®ç°æœ¬åœ°é€æ˜ä»£ç†">ä½¿ç”¨ nginx å®ç°æœ¬åœ°é€æ˜ä»£ç†</a></h1>
<p>å°è¯•ç”¨ nginx ä½œä¸ºé€æ˜ä»£ç†ï¼Œä¿®æ”¹æŠ¥æ–‡å¤´ã€‚</p>
<h2 id="å‡†å¤‡ç›®æ ‡æœåŠ¡"><a class="header" href="#å‡†å¤‡ç›®æ ‡æœåŠ¡">å‡†å¤‡ç›®æ ‡æœåŠ¡</a></h2>
<p>ç›®æ ‡æœåŠ¡æ˜¯ <a href="nginx/./env.html">è¯•éªŒç¯å¢ƒ</a> ä¸­å¯åŠ¨çš„ echoserverï¼Œç›‘å¬åœ°å€ä¸º 127.0.0.1:9090ã€‚</p>
<p>ä¸ºç›®æ ‡æœåŠ¡å‡†å¤‡ä¸€ä¸ªåŸŸå echo.exampleï¼Œç”¨æœ¬åœ°çš„ dnsmasq è§£æï¼Œè®¾ç½®æ–¹æ³•è§ <a href="nginx/../tools/domainip.html#dnsmasq">dnsmasq</a>ã€‚</p>
<h2 id="é…ç½®-nginx"><a class="header" href="#é…ç½®-nginx">é…ç½® nginx</a></h2>
<p>é…ç½®nginxï¼š</p>
<pre><code class="language-conf">server {
    listen       9000;
    listen       [::]:9000;
    keepalive_requests  2000;
    keepalive_timeout 60s;

    location / {
        resolver 127.0.0.1:8053;  # å¿…é¡»é…ç½®åŸŸåæœåŠ¡å™¨
        # è¿™é‡Œå› ä¸º nginx å’Œ ç›®æ ‡æœåŠ¡åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œä½¿ç”¨äº†ä¸åŒç«¯å£ï¼Œæ‰€ä»¥å†™æˆ $host:9090
        # å¦‚æœä½äºä¸åŒæœºå™¨ä¸Šï¼Œå†™æˆï¼šproxy_pass  http://$host:9000$request_uri;
        proxy_pass  http://$host:9090$request_uri;
        proxy_set_header tranproxy &quot;true&quot;;
    }
}
</code></pre>
<p>é€šè¿‡ 127.0.0.1:9000 ç«¯å£è®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›çš„è¯·æ±‚å¤´ä¸­å¤šäº† tranproxy=trueï¼š</p>
<pre><code class="language-sh">$ curl -H &quot;Host: echo.example&quot; 127.0.0.1:9000

Hostname: 57e34b409aa1

Pod Information:
    -no pod information available-

Server values:
    server_version=nginx: 1.13.3 - lua: 10008

Request Information:
    client_address=172.17.0.1
    method=GET
    real path=/
    query=
    request_version=1
    request_scheme=http
    request_uri=http://echo.example:8080/

Request Headers:
    accept=*/*
    connection=close
    host=echo.example:9090
    tranproxy=true
    user-agent=curl/7.54.0

Request Body:
    -no body in request-
</code></pre>
<h2 id="å®ç°æ— æ„ŸçŸ¥çš„æœ¬åœ°é€æ˜ä»£ç†"><a class="header" href="#å®ç°æ— æ„ŸçŸ¥çš„æœ¬åœ°é€æ˜ä»£ç†">å®ç°æ— æ„ŸçŸ¥çš„æœ¬åœ°é€æ˜ä»£ç†</a></h2>
<p>ä¸Šé¢çš„æµ‹è¯•å› ä¸ºç¯å¢ƒé™åˆ¶ï¼Œåªæ˜¯éªŒè¯äº†é€ä¼ çš„åŠŸèƒ½ï¼Œè¿™é‡Œç ”ç©¶ä¸€ä¸‹æ€æ ·å®ç°å®Œå…¨æ— æ„ŸçŸ¥æœ¬åœ° http é€æ˜ä»£ç†ã€‚</p>
<p>ç›®æ ‡æœåŠ¡ç«¯å£ä¸º 8080ï¼Œåœ¨è¯·æ±‚ç«¯è®¾ç½® nginxï¼Œä½¿æœ¬åœ°å‘å‡ºçš„å¯¹ 8080 ç«¯å£çš„è®¿é—®éƒ½ç»è¿‡æœ¬åœ° nginx ä»£ç†ã€‚</p>
<p>æœ¬åœ° nginx çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">server {
    listen     8080;
    location / {
        resolver 114.114.114.114; 
        proxy_pass  http://$host:8080$request_uri;
        proxy_set_header tranproxy &quot;true&quot;;    # ä¸ºäº†éªŒè¯ä»£ç†æ•ˆæœï¼Œæ·»åŠ äº†ä¸€ä¸ªè¯·æ±‚å¤´
    }
}
</code></pre>
<p>æ¥ä¸‹æ¥çš„å…³é”®é—®é¢˜æ˜¯ï¼šæ€æ ·å°†æœ¬åœ°å‘å‡ºçš„åˆ° 8080 ç«¯å£çš„è¯·æ±‚ç»è¿‡ nginx é€å‡ºï¼Œå¹¶ä¸”æ˜¯åœ¨å®¢æˆ·ç«¯æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹ã€‚</p>
<p>å€Ÿé‰´ <a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/11/01/istio-packet-forward.html" title="æœåŠ¡ç½‘æ ¼/ServiceMesh é¡¹ç›® istio çš„æµé‡é‡å®šå‘ã€ä»£ç†è¯·æ±‚è¿‡ç¨‹åˆ†æ">istio çš„åšæ³•</a>ï¼Œç”¨ iptables å®ç°ï¼Œistio ä¸­çš„ envoy åŒæ—¶ä»£ç†æµå…¥çš„è¯·æ±‚å’Œæµå‡ºçš„è¯·æ±‚ï¼Œæˆ‘ä»¬è¿™é‡Œåªå®ç°æœ¬åœ°çš„ä»£ç†ï¼Œå› æ­¤åªéœ€è¦è®¾ç½® outbound è§„åˆ™ã€‚</p>
<p>åœ¨ nat è¡¨ä¸­æ·»åŠ ä¸€æ¡è§„åˆ™é“¾ï¼Œå­˜æ”¾æœ¬åœ°ä»£ç†çš„è§„åˆ™ï¼š</p>
<pre><code class="language-sh"># æ–°å»ºä¸€ä¸ªè§„åˆ™é“¾ 
iptables -t nat -N LOCAL_PROXY

# ä¸ä»£ç† nginx ç”Ÿæˆçš„æŠ¥æ–‡ï¼Œé˜²æ­¢å‡ºç° nginx ä»£ç† nginx çš„æ­»å¾ªç¯
iptables -t nat -A LOCAL_PROXY -m owner --uid-owner nginx -j RETURN

# å°†æœ¬åœ°ç”Ÿæˆçš„ç›®æ ‡ç«¯å£ä¸º 8080 çš„ tcp æŠ¥æ–‡ï¼Œé‡å®šå‘åˆ°æœ¬åœ°çš„ :8080 ç›‘å¬åœ°å€
iptables -t nat -A LOCAL_PROXY -p tcp -m tcp --dport 8080 -j REDIRECT --to-ports 8080
</code></pre>
<p>å¯ç”¨ LOCAL_PROXYï¼š</p>
<pre><code class="language-sh">iptables -t nat -A OUTPUT -p tcp -j LOCAL_PROXY
</code></pre>
<p>ç„¶ååœ¨æœ¬åœ°ç›´æ¥è®¿é—®ç›®æ ‡æœåŠ¡ï¼Œä¼šå‘ç°è¯·æ±‚å¤´ä¸­å¤šäº† tranproxy=trueï¼š</p>
<pre><code class="language-sh">$ curl 172.17.0.21:8080

Hostname: echo-597d89dcd9-m84tq

Pod Information:
    -no pod information available-

Server values:
    server_version=nginx: 1.13.3 - lua: 10008

Request Information:
    client_address=172.17.0.28
    method=GET
    real path=/
    query=
    request_version=1
    request_uri=http://172.17.0.21:8080/
Request Headers:
    accept=*/*
    connection=close
    host=172.17.0.21:8080
    tranproxy=true
    user-agent=curl/7.61.1
</code></pre>
<p>ä¸Šé¢çš„æ“ä½œè¿‡ç¨‹å·²ç»æ‰“åŒ…æˆäº†é•œåƒï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š</p>
<pre><code class="language-sh">docker run -itd --cap-add NET_ADMIN --name nginx-tranproxy lijiaocn/nginx-tranproxy:0.1 \
    -P 80 \
    -P 8080 \
    -H tranproxy:true \
    -H tranproxy2:true \
    -N 114.114.114.114 \
    -N 8.8.8.8 \
    --Set-Forwarded-For default \
    --Set-Client-Hostname default \
    -- tail -f /dev/null
</code></pre>
<p>åœ¨ kubernetes ä¸­ä½¿ç”¨ï¼š</p>
<pre><code class="language-sh">kubectl -n &quot;Your NameSpace&quot; create -f https://raw.githubusercontent.com/introclass/kubernetes-yamls/master/all-in-one/nginx-tranproxy.yaml
</code></pre>
<h2 id="å‚è€ƒ-95"><a class="header" href="#å‚è€ƒ-95">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://www.stevenrombauts.be/2019/06/restart-dnsmasq-without-sudo/" title="Restart dnsmasq without sudo">restart dnsmasq without sudo</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2019/11/01/istio-packet-forward.html" title="æœåŠ¡ç½‘æ ¼/ServiceMesh é¡¹ç›® istio çš„æµé‡é‡å®šå‘ã€ä»£ç†è¯·æ±‚è¿‡ç¨‹åˆ†æ">æœåŠ¡ç½‘æ ¼/ServiceMesh é¡¹ç›® istio çš„æµé‡é‡å®šå‘ã€ä»£ç†è¯·æ±‚è¿‡ç¨‹åˆ†æ</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="openresty-å­¦ä¹ ç¬”è®°"><a class="header" href="#openresty-å­¦ä¹ ç¬”è®°">OpenResty å­¦ä¹ ç¬”è®°</a></h1>
<p>è¿™é‡Œæ˜¯å¯¹ OpenResty ç›¸å…³ç¬”è®°çš„é‡æ–°æ•´ç†ï¼ŒåŸç¬”è®°ä¸å†ç»´æŠ¤ã€‚</p>
<p><a href="http://openresty.org/en/" title="OpenResty">OpenResty</a> æ˜¯ä»€ä¹ˆï¼Ÿè§ <a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/09/29/nginx-openresty-kong.html" title="Nginxã€OpenRestyå’ŒKongå…¥é—¨">Nginxã€OpenResty å’Œ Kongå…¥é—¨</a>ã€‚</p>
<h2 id="å­¦ä¹ èµ„æ–™"><a class="header" href="#å­¦ä¹ èµ„æ–™">å­¦ä¹ èµ„æ–™</a></h2>
<p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/">OpenResty æœ€ä½³å®è·µ</a> æ˜¯ä¸€ä»½å¾ˆå¥½çš„å­¦ä¹ èµ„æ–™ã€‚</p>
<p>OpenResty åœ¨ nginx çš„åŸºç¡€ä¸Šæ”¹é€ åŠ å¼ºï¼Œæä¾›çš„å¼€å‘è¯­è¨€æ˜¯ luaï¼Œç”¨ lua-nginx-module è§£é‡Š lua è„šæœ¬ï¼Œä»ä¸‹é¢çš„æ–‡æ¡£ä¸­å‡ ä¹å¯ä»¥æ‰¾åˆ°æ‰€æœ‰ç”¨æ³•ï¼š</p>
<ul>
<li>lua è¯­è¨€ç”¨æ³•ï¼š<a href="https://www.lijiaocn.com/prog/lua/" title="Luaç¼–ç¨‹é€ŸæŸ¥æ‰‹å†Œï¼ˆå¸¸ç”¨æ“ä½œ)">Luaç¼–ç¨‹é€ŸæŸ¥æ‰‹å†Œï¼ˆå¸¸ç”¨æ“ä½œ)</a></li>
<li>nginx æŒ‡ä»¤æ±‡æ€»ï¼š<a href="http://nginx.org/en/docs/dirindex.html" title="nginx directives">nginx directives</a></li>
<li>nginx å˜é‡æ±‡æ€»ï¼š<a href="http://nginx.org/en/docs/varindex.html" title="nginx variables">nginx variables</a></li>
<li>openresty æä¾›çš„ lua èƒ½åŠ›ï¼š<a href="https://github.com/openresty/lua-nginx-module" title="lua-nginx-module">openresty/lua-nginx-module</a></li>
<li>openresty é›†æˆçš„æ¨¡å—å’Œ lua åº“ï¼š<a href="http://openresty.org/en/components.html" title="OpenResty Components">openresty components</a></li>
</ul>
<p>ä»¥å‰çš„ç¬”è®°ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/10/25/openresty-study-01-intro.html">ã€ŠWebå¼€å‘å¹³å°OpenRestyï¼ˆä¸€ï¼‰ï¼šå­¦ä¹ èµ„æ–™ã€åŸºæœ¬ç»„æˆä¸ä½¿ç”¨æ–¹æ³•ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/10/25/openresty-study-02-process.html">ã€ŠWebå¼€å‘å¹³å°OpenRestyï¼ˆäºŒï¼‰ï¼šç»„æˆã€å·¥ä½œè¿‡ç¨‹ä¸åŸç†ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/11/02/openresty-study-03-frame-md.html">ã€ŠWebå¼€å‘å¹³å°OpenRestyï¼ˆä¸‰ï¼‰ï¼šç«ç„°å›¾æ€§èƒ½åˆ†æã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/11/09/openresty-study-04-development.html">ã€ŠWebå¼€å‘å¹³å°OpenRestyï¼ˆå››ï¼‰ï¼šé¡¹ç›®å¼€å‘ä¸­å¸¸ç”¨çš„æ“ä½œã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/12/17/openresty-study-05-compile.html">ã€ŠWebå¼€å‘å¹³å°OpenRestyï¼ˆäº”ï¼‰ï¼šOpenRestyé¡¹ç›®è‡ªèº«çš„ç¼–è¯‘ã€‹</a></li>
</ul>
<h2 id="å‚è€ƒ-96"><a class="header" href="#å‚è€ƒ-96">å‚è€ƒ</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="openresty-ç¯å¢ƒå‡†å¤‡"><a class="header" href="#openresty-ç¯å¢ƒå‡†å¤‡">OpenResty ç¯å¢ƒå‡†å¤‡</a></h1>
<h2 id="mac-ä¸Šçš„å®‰è£…æ–¹æ³•"><a class="header" href="#mac-ä¸Šçš„å®‰è£…æ–¹æ³•">mac ä¸Šçš„å®‰è£…æ–¹æ³•</a></h2>
<pre><code class="language-sh">brew untap homebrew/nginx
brew install openresty/brew/openresty
</code></pre>
<p>æ‰§è¡Œï¼š</p>
<pre><code class="language-sh">./install-on-mac.sh
</code></pre>
<h2 id="ç¯å¢ƒéªŒè¯"><a class="header" href="#ç¯å¢ƒéªŒè¯">ç¯å¢ƒéªŒè¯</a></h2>
<p>å‡†å¤‡ openresty çš„é…ç½®æ–‡ä»¶ï¼Œ01-hello-world/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;        #nginx worker æ•°é‡
error_log logs/error.log;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
    worker_connections 1024;
}

http {
    server {
        #ç›‘å¬ç«¯å£ï¼Œè‹¥ä½ çš„6699ç«¯å£å·²ç»è¢«å ç”¨ï¼Œåˆ™éœ€è¦ä¿®æ”¹
        listen 6699;
        location /a {
            default_type text/html;

            content_by_lua_block {
                ngx.say(&quot;HelloWorld&quot;)
            }
        }
    }
}
</code></pre>
<p>ç”¨è¯¥é…ç½®æ–‡ä»¶å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">openresty -p `pwd` -c nginx.conf
</code></pre>
<p>è®¿é—®ï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:6699/a
HelloWorld
</code></pre>
<h2 id="resty-éªŒè¯"><a class="header" href="#resty-éªŒè¯">resty éªŒè¯</a></h2>
<p>OpenResty æä¾›ä¸€ä¸ª resty å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥è§£é‡Šæ‰§è¡Œ lua è„šæœ¬ï¼Œå‡†å¤‡ä¸€ä¸ª lua è„šæœ¬ hello.luaï¼š</p>
<pre><code class="language-lua">#! /usr/bin/env lua
--
-- hello.lua
-- Copyright (C) 2018 lijiaocn &lt;lijiaocn@foxmail.com&gt;
--
-- Distributed under terms of the GPL license.
--
mysql=require &quot;resty.mysql&quot;
ngx.say(&quot;hello world&quot;)
</code></pre>
<p>ç”¨ resty æ‰§è¡Œ lua è„šæœ¬ï¼š</p>
<pre><code class="language-sh">$ resty hello.lua
hello world
</code></pre>
<h2 id="å‚è€ƒ-97"><a class="header" href="#å‚è€ƒ-97">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="openresty-ä¸­-lua-è„šæœ¬çš„ä½¿ç”¨"><a class="header" href="#openresty-ä¸­-lua-è„šæœ¬çš„ä½¿ç”¨">OpenResty ä¸­ lua è„šæœ¬çš„ä½¿ç”¨</a></h1>
<p>OpenResty ç”¨ lua-nginx-module è§£é‡Š lua è„šæœ¬ï¼Œlua è¯­è¨€è‡ªèº«çš„ç”¨æ³•è§ <a href="https://www.lijiaocn.com/prog/lua/" title="Luaç¼–ç¨‹é€ŸæŸ¥æ‰‹å†Œï¼ˆå¸¸ç”¨æ“ä½œ)">Luaç¼–ç¨‹é€ŸæŸ¥æ‰‹å†Œï¼ˆå¸¸ç”¨æ“ä½œ)</a>ï¼Œopenresty æä¾›çš„ lua èƒ½åŠ›ï¼ˆè­¬å¦‚å®šä¹‰çš„å˜é‡ã€æä¾›çš„å‡½æ•°ç­‰ï¼‰è§ <a href="https://github.com/openresty/lua-nginx-module" title="lua-nginx-module">openresty/lua-nginx-module</a> ã€‚</p>
<h2 id="openresty-æ‰§è¡Œ-lua-è„šæœ¬"><a class="header" href="#openresty-æ‰§è¡Œ-lua-è„šæœ¬">OpenResty æ‰§è¡Œ Lua è„šæœ¬</a></h2>
<p>OpenResty æ”¯æŒçš„å¼€å‘è¯­è¨€æ˜¯ luaï¼Œlua è„šæœ¬å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼è¿è¡Œï¼š</p>
<p>ç¬¬ä¸€ç§æ–¹å¼ï¼Œç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œopenresty åŠ è½½è¿è¡Œï¼š</p>
<pre><code class="language-sh">$ cd 01-hello-world
$ openresty -p `pwd` -c nginx.conf
</code></pre>
<p>è¿™ç§æ–¹å¼å¯åŠ¨äº† openresty æœåŠ¡ï¼Œè®¿é—® openresty æ—¶è§¦å‘é…ç½®ä¸­çš„ lua è„šæœ¬çš„è¿è¡Œï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:6699/
HelloWorld
</code></pre>
<p>ç¬¬äºŒç§æ–¹å¼ï¼Œç”¨ resty å‘½ä»¤ç›´æ¥æ‰§è¡Œ lua è„šæœ¬ï¼š</p>
<pre><code class="language-sh">$ cd 02-hello-world
$ resty hello.lua
hello world
</code></pre>
<h2 id="lua_module-çš„å‡ ä¸ªæ‰§è¡Œé˜¶æ®µ"><a class="header" href="#lua_module-çš„å‡ ä¸ªæ‰§è¡Œé˜¶æ®µ">lua_module çš„å‡ ä¸ªæ‰§è¡Œé˜¶æ®µ</a></h2>
<p>lua_module å®šä¹‰äº†å¾ˆå¤šçš„æŒ‡ä»¤ï¼Œ<a href="https://github.com/openresty/lua-nginx-module#directives" title="lua module directives">lua module directives</a>ï¼Œå…¶ä¸­æœ‰ä¸€äº›æŒ‡ä»¤æ˜¯ç±»ä¼¼äº serverã€location çš„å—æŒ‡ä»¤ï¼Œå®ƒä»¬çš„ä½œç”¨é¡ºåºå¦‚ä¸‹ï¼š</p>
<p><img src="https://cloud.githubusercontent.com/assets/2137369/15272097/77d1c09e-1a37-11e6-97ef-d9767035fc3e.png" alt="lua_module æŒ‡ä»¤çš„çš„ä½œç”¨é¡ºåº" /></p>
<p>ç”¨ä¸‹é¢çš„é…ç½®è§‚å¯Ÿè¿™äº›æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºï¼Œ03-nginx-lua-module/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;             #nginx worker æ•°é‡
error_log logs/error.log info;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
  worker_connections 256;
}

http {
  server {
    #ç›‘å¬ç«¯å£ï¼Œè‹¥ä½ çš„6699ç«¯å£å·²ç»è¢«å ç”¨ï¼Œåˆ™éœ€è¦ä¿®æ”¹
    listen 6699;
    location / {
        set_by_lua_block $a {
            ngx.log(ngx.INFO, &quot;set_by_lua*&quot;)
        }
        rewrite_by_lua_block {
            ngx.log(ngx.INFO, &quot;rewrite_by_lua*&quot;)
        }
        access_by_lua_block {
            ngx.log(ngx.INFO, &quot;access_by_lua*&quot;)
        }
        content_by_lua_block {
            ngx.log(ngx.INFO, &quot;content_by_lua*&quot;)
        }
        header_filter_by_lua_block {
            ngx.log(ngx.INFO, &quot;header_filter_by_lua*&quot;)
        }
        body_filter_by_lua_block {
            ngx.log(ngx.INFO, &quot;body_filter_by_lua*&quot;)
        }
        log_by_lua_block {
            ngx.log(ngx.INFO, &quot;log_by_lua*&quot;)
        }
    }
  }
}
</code></pre>
<p>æ‰§è¡Œæ—¶æ‰“å°çš„æ—¥å¿—ï¼š</p>
<pre><code class="language-sh">2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] set_by_lua:2: set_by_lua*, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] rewrite_by_lua(nginx.conf:17):2: rewrite_by_lua*, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] access_by_lua(nginx.conf:20):2: access_by_lua*, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] content_by_lua(nginx.conf:23):2: content_by_lua*, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] header_filter_by_lua:2: header_filter_by_lua*, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] body_filter_by_lua:2: body_filter_by_lua*, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 [lua] log_by_lua(nginx.conf:32):2: log_by_lua* while logging request, client: 127.0.0.1, server: , request: &quot;GET / HTTP/1.1&quot;, host: &quot;127.0.0.1:6699&quot;
2019/10/23 15:40:34 [info] 65194#3586531: *1 kevent() reported that client 127.0.0.1 closed keepalive connection
</code></pre>
<h2 id="ä¸-nginx-å†…ç½®å˜é‡çš„äº¤äº’"><a class="header" href="#ä¸-nginx-å†…ç½®å˜é‡çš„äº¤äº’">ä¸ nginx å†…ç½®å˜é‡çš„äº¤äº’</a></h2>
<p>nginx æœ‰å¾ˆå¤š <a href="http://nginx.org/en/docs/varindex.html" title="nginx variables">å†…ç½®å˜é‡</a>ï¼Œåœ¨ lua è„šæœ¬ä¸­é€šè¿‡ <a href="https://github.com/openresty/lua-nginx-module#ngxvarvariable" title="ngx.var.VARIABLE">ngx.var.VARIABLE</a> è·å–è¿™äº›å˜é‡ã€‚</p>
<p>æœ‰ä¸€äº› nginx çš„å˜é‡å€¼å¯ä»¥ç”¨ lua ä¿®æ”¹ï¼Œå¤§éƒ¨åˆ†æ˜¯ä¸å¯ä»¥ä¿®æ”¹çš„ã€‚</p>
<p>ä¿®æ”¹ä¸èƒ½ä¿®æ”¹çš„å˜é‡æ—¶ä¼šæŠ¥é”™ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">lua entry thread aborted: runtime error: ... variable &quot;request_uri&quot; not changeable
</code></pre>
<h2 id="ä¸-nginx-å…±äº«å†…å­˜çš„äº¤äº’"><a class="header" href="#ä¸-nginx-å…±äº«å†…å­˜çš„äº¤äº’">ä¸ nginx å…±äº«å†…å­˜çš„äº¤äº’</a></h2>
<p><a href="https://github.com/openresty/lua-nginx-module#ngxshareddict" title="ngx.shared.DICT">ngx.shared.DICT</a> è·å–ç”¨ <a href="https://github.com/openresty/lua-nginx-module#lua_shared_dict" title="lua_shared_dict">ua_shared_dict</a> åˆ›å»ºçš„å…±äº«å†…å­˜ã€‚</p>
<h2 id="å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡"><a class="header" href="#å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡">å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡</a></h2>
<p><a href="https://github.com/openresty/lua-nginx-module#ngxctx" title="ngx.ctx">ngx.ctx</a> ä¸­å­˜æ”¾å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼Œè´¯ç©¿æ‰€æœ‰å¤„ç†é˜¶æ®µï¼š</p>
<pre><code class="language-lua"> location /test {
     rewrite_by_lua_block {
         ngx.ctx.foo = 76
     }
     access_by_lua_block {
         ngx.ctx.foo = ngx.ctx.foo + 3
     }
     content_by_lua_block {
         ngx.say(ngx.ctx.foo)
     }
 }
</code></pre>
<h2 id="å¸¸ç”¨-lua-æ•°æ®ç»“æ„"><a class="header" href="#å¸¸ç”¨-lua-æ•°æ®ç»“æ„">å¸¸ç”¨ lua æ•°æ®ç»“æ„</a></h2>
<p><a href="https://www.lijiaocn.com/prog/lua/basic_type.html" title="Luaçš„åŸºæœ¬æ•°æ®ç±»å‹">Luaçš„åŸºæœ¬æ•°æ®ç±»å‹</a></p>
<h2 id="å‚è€ƒ-98"><a class="header" href="#å‚è€ƒ-98">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="openresty-çš„ä¸€äº›å¸¸è§„æ“ä½œ"><a class="header" href="#openresty-çš„ä¸€äº›å¸¸è§„æ“ä½œ">OpenResty çš„ä¸€äº›å¸¸è§„æ“ä½œ</a></h1>
<h2 id="å†…å­˜å­—å…¸"><a class="header" href="#å†…å­˜å­—å…¸">å†…å­˜å­—å…¸</a></h2>
<p>04-nginx-lua-module-shared-mem/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;        #nginx worker æ•°é‡
error_log logs/error.log;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
  worker_connections 1024;
}

 http {
     lua_shared_dict dogs 10m;
     server {
         listen 6699;
         location /set {
             content_by_lua_block {
                 local dogs = ngx.shared.dogs
                 dogs:set(&quot;Jim&quot;, 8)
                 ngx.say(&quot;STORED&quot;)
             }
         }
         location /get {
             content_by_lua_block {
                 local dogs = ngx.shared.dogs
                 ngx.say(dogs:get(&quot;Jim&quot;))
             }
         }
     }
 }
</code></pre>
<h2 id="å˜é‡è®¾ç½®ä¸è¯»å–"><a class="header" href="#å˜é‡è®¾ç½®ä¸è¯»å–">å˜é‡è®¾ç½®ä¸è¯»å–</a></h2>
<p>05-nginx-lua-module-readvar/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;        #nginx worker æ•°é‡
error_log logs/error.log;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
  worker_connections 1024;
}

http {
     server {
         listen 6699;
         location / {
             set $my_var 'my_var';
             content_by_lua_block {
                 local response = {}
                 response[1]= ngx.var.request_uri;
                 response[2]=&quot;;&quot;
                 response[3] = ngx.var.my_var;
                 ngx.say(response);
             }
         }
     }
 }
</code></pre>
<h2 id="æ—¥å¿—æ‰“å°"><a class="header" href="#æ—¥å¿—æ‰“å°">æ—¥å¿—æ‰“å°</a></h2>
<p>06-nginx-lua-module-log/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;              #nginx worker æ•°é‡
error_log logs/error.log debug;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
  worker_connections 1024;
}

http {
     server {
         listen 6699;
         location / {
             content_by_lua_block {
                ngx.log(ngx.DEBUG,&quot;this is a DEBUG log &quot;,ngx.var.request_uri, ngx.var.host);
                ngx.log(ngx.INFO,&quot;this is a INFO log&quot;);
                ngx.log(ngx.NOTICE,&quot;this is a NOTICE log&quot;);
                ngx.log(ngx.WARN,&quot;this is a WARN log&quot;);
                ngx.log(ngx.ERR,&quot;this is a ERR log&quot;);
                ngx.log(ngx.CRIT,&quot;this is a CRIT log&quot;);
                ngx.log(ngx.ALERT,&quot;this is a ALERT log&quot;);
                ngx.log(ngx.EMERG,&quot;this is a EMERG log&quot;);
                ngx.log(ngx.STDERR,&quot;this is a STDERR log&quot;);
             }
         }
     }
 }
</code></pre>
<h2 id="é‡å®šå‘"><a class="header" href="#é‡å®šå‘">é‡å®šå‘</a></h2>
<p>07-nginx-lua-module-redirect/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;              #nginx worker æ•°é‡
error_log logs/error.log debug;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
    worker_connections 1024;
}

http {
    server {
        listen 6699;
        location / {
            access_by_lua_block{
                local host = ngx.var.host
                -- ä¸åŒ¹é…
                local replace,n,err  = ngx.re.sub(ngx.var.request_uri, &quot;/abc&quot;, &quot;123&quot;)
                ngx.log(ngx.DEBUG, &quot;uri is: &quot;, ngx.var.request_uri, &quot; ,replace is: &quot;,replace, &quot; ,n is: &quot;,n , &quot; ,err is: &quot;,err)
                ngx.redirect(replace,301)
            }
        }
    }
}
</code></pre>
<h2 id="4-å±‚è´Ÿè½½å‡è¡¡"><a class="header" href="#4-å±‚è´Ÿè½½å‡è¡¡">4 å±‚è´Ÿè½½å‡è¡¡</a></h2>
<p>08-nginx-lua-module-balancer/nginx.confï¼š</p>
<pre><code class="language-conf">worker_processes  1;              #nginx worker æ•°é‡
error_log logs/error.log debug;   #æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
events {
    worker_connections 256;
}

stream{
        upstream upstream_balancer{
                server 0.0.0.1:6699; # placeholder
                balancer_by_lua_block {
                   local ngx_balancer = require(&quot;ngx.balancer&quot;)
                   ngx_balancer.set_more_tries(1)
                   local ok, err = ngx_balancer.set_current_peer(&quot;127.0.0.1&quot;,&quot;9090&quot;)
                   if not ok then
                      ngx.log(ngx.ERR, string.format(&quot;error while setting current upstream : %s&quot;, err))
                   end
                }
        }
        server {
                proxy_timeout           600s;
                listen                  6699;
                proxy_pass              upstream_balancer;
        }
}
</code></pre>
<h2 id="å‚è€ƒ-99"><a class="header" href="#å‚è€ƒ-99">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus-çš„ä½¿ç”¨æ–¹æ³•"><a class="header" href="#prometheus-çš„ä½¿ç”¨æ–¹æ³•">Prometheus çš„ä½¿ç”¨æ–¹æ³•</a></h1>
<p><a href="https://prometheus.io/" title="Prometheus">Prometheus</a> æ˜¯ä¸€ä¸ªæ¯”è¾ƒæµè¡Œçš„å‘Šè­¦ç›‘æ§ç³»ç»Ÿï¼Œä»¥å‰å†™è¿‡å‡ ç¯‡ç¬”è®°ï¼Œè¿™é‡Œæ›´ç³»ç»Ÿçš„æ•´ç†ä¸€ä¸‹ã€‚</p>
<p>è¿™æœ¬æ‰‹å†Œçš„å†…å®¹ä¼šæ ¹æ®å®é™…å·¥ä½œçš„éœ€è¦è¿›è¡Œæ‰©å±•ï¼Œæ¯”è¾ƒè´´è¿‘å®é™…ã€‚</p>
<p>æ‰‹å†Œç›®å½•åœ¨é¡µé¢å·¦ä¾§ï¼Œå¦‚æœæ˜¯åœ¨æ‰‹æœºç«¯æŸ¥çœ‹ï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ <i class="fa fa-align-justify"></i> ç¬¦å·ã€‚</p>
<p><strong>è§†é¢‘è®²è§£</strong>ï¼š<a href="https://study.163.com/course/courseMain.htm?share=2&amp;shareId=400000000376006&amp;courseId=1005950011&amp;_trace_c_p_k2_=66a5b0594a3349fa815b4b135d6b2de6">Prometheusæ™®ç½—ç±³ä¿®æ–¯ç›‘æ§å…¥é—¨</a> </p>
<h2 id="å‚è€ƒ-100"><a class="header" href="#å‚è€ƒ-100">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-å®‰è£…å¯åŠ¨"><a class="header" href="#prometheus-å®‰è£…å¯åŠ¨">Prometheus å®‰è£…å¯åŠ¨</a></h1>
<p>ä» <a href="https://prometheus.io/download/" title="prometheus download">prometheus download</a> ä¸‹è½½å·²ç»ç¼–è¯‘å¥½çš„ prometheus ç¨‹åºï¼Œè¯¥é¡µé¢ä¸Šè¿˜æœ‰ prometheus æä¾›çš„ exporterã€‚</p>
<h2 id="å‘½ä»¤è¡Œå‚æ•°"><a class="header" href="#å‘½ä»¤è¡Œå‚æ•°">å‘½ä»¤è¡Œå‚æ•°</a></h2>
<p>Prometheus çš„å‘½ä»¤è¡Œå‚æ•°ä¸æ˜¯ç‰¹åˆ«å¤šï¼Œæ¯”è¾ƒé‡è¦çš„æœ‰ï¼š</p>
<ul>
<li>--config.file              æŒ‡å®šé…ç½®æ–‡ä»¶</li>
<li>--log.level                æ—¥å¿—çº§åˆ«</li>
<li>--web.listen-address       ç›‘å¬åœ°å€</li>
<li>--web.read-timeout         è®¿é—®è¶…æ—¶æ—¶é—´</li>
<li>--web.enable-admin-api     å¯ç”¨ admin api</li>
<li>--web.external-url         è®¿é—®åœ°å€</li>
<li>--query.max-concurrency    è¿œç¨‹è°ƒç”¨å¹¶å‘ä¸Šé™</li>
<li>--storage.tsdb.path        æŒ‡å®šæ•°æ®æ–‡ä»¶å­˜æ”¾ç›®å½•</li>
<li>--storage.tsdb.retention.time            è®¾ç½®æ•°æ®ä¿ç•™æœŸé™ï¼Œä¾‹å¦‚ 15d</li>
<li>--storage.remote.read-concurrent-limit   è¯»å–å¹¶å‘è¿æ¥æ•°ä¸Šé™</li>
</ul>
<p>é…ç½®æ–‡ä»¶ prometheus.yml ä¸­ä¸»è¦åŒ…å«å‘Šè­¦è§„åˆ™æ–‡ä»¶ã€é™æ€é…ç½®çš„é‡‡é›†åœ°å€æˆ–è€…åŠ¨æ€å‘ç°é‡‡é›†åœ°å€çš„æ–¹æ³•ã€‚</p>
<h2 id="é…ç½®æ–‡ä»¶æ ¼å¼"><a class="header" href="#é…ç½®æ–‡ä»¶æ ¼å¼">é…ç½®æ–‡ä»¶æ ¼å¼</a></h2>
<p>é…ç½®æ–‡ä»¶æ˜¯ yaml æ ¼å¼çš„ï¼Œåˆ†ä¸º globalã€alertingã€rule_files å’Œ scrape_configs å››éƒ¨åˆ†ã€‚</p>
<p>global æ˜¯å…¨å±€å‚æ•°é…ç½®ï¼Œalerting æ˜¯å‘Šè­¦æœåŠ¡åœ°å€ï¼Œrule_files æ˜¯å‘Šè­¦å’Œè®°å½•è§„åˆ™ï¼Œscrape_configs æ˜¯æ•°æ®é‡‡é›†åœ°å€ã€‚å…¶ä¸­ rule_files å’Œ scrape_configs æ˜¯é‡ç‚¹ï¼Œåè€…æ”¯æŒå¤šç§åŠ¨æ€å‘ç°æ–¹å¼ï¼Œæ›´å¤æ‚ä¸€äº›ã€‚</p>
<pre><code class="language-yaml">global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - &quot;first_rules.yml&quot;
  # - &quot;second_rules.yml&quot;

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
    - targets: ['localhost:9090']
</code></pre>
<h2 id="é…ç½®æ–‡ä»¶æ£€æŸ¥"><a class="header" href="#é…ç½®æ–‡ä»¶æ£€æŸ¥">é…ç½®æ–‡ä»¶æ£€æŸ¥</a></h2>
<p>å¯ä»¥ç”¨ promtool æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼š</p>
<pre><code class="language-sh">$ ./promtool check config prometheus.yml 
Checking prometheus.yml
  SUCCESS: 0 rule files found
</code></pre>
<h2 id="å‚è€ƒ-101"><a class="header" href="#å‚è€ƒ-101">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-çš„æ•°æ®ç±»å‹"><a class="header" href="#prometheus-çš„æ•°æ®ç±»å‹">Prometheus çš„æ•°æ®ç±»å‹</a></h1>
<p>Prometheus å­˜æ”¾çš„æ˜¯æ¯ä¸ªæŒ‡æ ‡çš„æ—¶é—´åºåˆ—å€¼ï¼ŒæŒ‡æ ‡åç”± Metric name å’Œ labels ç»„æˆ :</p>
<pre><code class="language-sh">&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...}
</code></pre>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">api_http_requests_total{method=&quot;POST&quot;, handler=&quot;/messages&quot;}
</code></pre>
<h2 id="æŒ‡æ ‡ç±»å‹"><a class="header" href="#æŒ‡æ ‡ç±»å‹">æŒ‡æ ‡ç±»å‹</a></h2>
<p>æŒ‡æ ‡ç±»å‹ä¸€å…±æœ‰ <a href="https://prometheus.io/docs/concepts/metric_types/" title="METRIC TYPES">å››ç§</a>ï¼š</p>
<p><strong>Counter</strong>ï¼šè®¡æ•°å™¨ï¼Œè®°å½•çš„æ˜¯æ­£å‘å¢é•¿çš„ç´¯è®¡å€¼ï¼›</p>
<p><strong>Gauge</strong>ï¼š  æµ‹é‡å€¼ï¼Œè®°å½•çš„æ˜¯æŒ‡æ ‡å½“å‰çš„çŠ¶æ€æ•°å€¼ï¼›</p>
<p><strong>Histogram</strong>ï¼š ç›´æ–¹å›¾ï¼Œå°±æ˜¯ç»Ÿè®¡å­¦ä¸­çš„ç›´æ–¹å›¾ï¼Œè®°å½•è½åœ¨æ¯ä¸ªåŒºé—´å†…çš„æŒ‡æ ‡å€¼çš„ä¸ªæ•°ï¼›</p>
<p><strong>Summary</strong>ï¼š   åˆ†å¸ƒå›¾ï¼Œå°±æ˜¯ç»Ÿè®¡å­¦ä¸­çš„åˆ†å¸ƒå›¾ï¼Œè®°å½•æŒ‡æ ‡å€¼çš„åˆ†ä½æ•°ã€‚</p>
<h2 id="ç”Ÿæˆä»£ç "><a class="header" href="#ç”Ÿæˆä»£ç ">ç”Ÿæˆä»£ç </a></h2>
<p>å¦‚æœè¦ç”Ÿæˆ prometheus æ ·å¼çš„æŒ‡æ ‡æ•°æ®ï¼Œå¯ä»¥ç”¨ prometheus æä¾›çš„ client sdkã€‚go client ä¸­çš„æŒ‡æ ‡å®šä¹‰æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">scheduleAttempts = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Subsystem: SchedulerSubsystem,
        Name:      &quot;schedule_attempts_total&quot;,
        Help:      &quot;Number of attempts to schedule pods, by the result. 'unschedulable' means a pod could not be scheduled, while 'error' means an internal scheduler problem.&quot;,
    }, []string{&quot;result&quot;})
// PodScheduleSuccesses counts how many pods were scheduled.
PodScheduleSuccesses = scheduleAttempts.With(prometheus.Labels{&quot;result&quot;: &quot;scheduled&quot;})

PreemptionVictims = prometheus.NewGauge(
    prometheus.GaugeOpts{
        Subsystem: SchedulerSubsystem,
        Name:      &quot;pod_preemption_victims&quot;,
        Help:      &quot;Number of selected preemption victims&quot;,
    })

BindingLatency = prometheus.NewHistogram(
    prometheus.HistogramOpts{
        Subsystem: SchedulerSubsystem,
        Name:      &quot;binding_duration_seconds&quot;,
        Help:      &quot;Binding latency in seconds&quot;,
        Buckets:   prometheus.ExponentialBuckets(0.001, 2, 15),
    },
)

SchedulingLatency = prometheus.NewSummaryVec(
    prometheus.SummaryOpts{
        Subsystem: SchedulerSubsystem,
        Name:      SchedulingLatencyName,
        Help:      &quot;Scheduling latency in seconds split by sub-parts of the scheduling operation&quot;,
        // Make the sliding window of 5h.
        // TODO: The value for this should be based on some SLI definition (long term).
        MaxAge: 5 * time.Hour,
    },
    []string{OperationLabel},
)
</code></pre>
<h2 id="å‚è€ƒ-102"><a class="header" href="#å‚è€ƒ-102">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-çš„æŸ¥è¯¢è¯­æ³•"><a class="header" href="#prometheus-çš„æŸ¥è¯¢è¯­æ³•">Prometheus çš„æŸ¥è¯¢è¯­æ³•</a></h1>
<p>Prometheus çš„æ•°æ®æŸ¥è¯¢è¯­å¥å«åš Prometheus Query Languageï¼Œæä¾›äº†ä¸å°‘æŸ¥è¯¢å‡½æ•°ï¼Œè¡¨è¾¾èƒ½åŠ›æ¯”è¾ƒä¸°å¯Œã€‚
è¯­å¥çš„æ‰§è¡Œç»“æœæœ‰å››ç§ç±»å‹ï¼š</p>
<ul>
<li>Scalar: æµ®ç‚¹æ•°å€¼</li>
<li>String: å­—ç¬¦ä¸²ï¼ˆé¢„ç•™ç±»å‹ï¼Œå½“å‰æ²¡æœ‰å®ç° 2019-08-07 18:04:55ï¼‰</li>
<li>Instant vectorï¼šç¬æ—¶å€¼æ•°ç»„ï¼Œä»ä¸åŒé‡‡é›†åœ°å€é‡‡é›†åˆ°çš„åŒä¸€æŒ‡æ ‡çš„å½“å‰å€¼ç»„æˆçš„æ•°ç»„</li>
<li>Range vector: åŒºé—´æ•°ç»„ï¼Œä»ä¸åŒé‡‡é›†åœ°å€é‡‡é›†åˆ°çš„åŒä¸€æŒ‡æ ‡åœ¨ä¸€æ®µæ—¶é—´çš„å†…æ•°å€¼ç»„æˆçš„æ•°ç»„</li>
</ul>
<p>å‰ä¸¤ç§ç±»å‹å®¹æ˜“ç†è§£ï¼ŒInstant vector å’Œ Range vector çš„æœ‰åŒºåˆ«å‰è€…æ˜¯ä¸€ä¸ªä¸€ä¸ªå½“å‰å€¼ç»„æˆçš„æ•°ç»„ï¼Œåè€…æ˜¯ä¸€æ®µåŒºé—´é‡Œçš„æ•°å€¼ç»„æˆçš„æ•°ç»„ï¼Œç»§ç»­ç»„æˆçš„æ•°ç»„ï¼Œä¸€çœ‹ä¾¿çŸ¥ï¼š</p>
<p><strong>Instant vector</strong>ï¼š</p>
<p><img src="prometheus/../img/prom/instant.png" alt="PromethesæŸ¥è¯¢è¯­å¥æ‰§è¡Œç»“æœï¼šInstance vector" /></p>
<p><strong>Range vector</strong></p>
<p><img src="prometheus/../img/prom/range.png" alt="PromethesæŸ¥è¯¢è¯­å¥æ‰§è¡Œç»“æœï¼šRange vector" /></p>
<h2 id="æŒ‡æ ‡æŸ¥è¯¢"><a class="header" href="#æŒ‡æ ‡æŸ¥è¯¢">æŒ‡æ ‡æŸ¥è¯¢</a></h2>
<p>Prometheus çš„æŒ‡æ ‡æŸ¥è¯¢è¯­å¥åŸºæœ¬æ ¼å¼ä¸ºï¼š</p>
<pre><code>æŒ‡æ ‡åç§°{ æ ‡ç­¾å=&lt;æ•°å€¼&gt; }
</code></pre>
<p>ä»¥ http_server_requests_count ä¸ºä¾‹ï¼ŒæŒ‡æ ‡ä¸Šå¸¦æœ‰ labelï¼Œé€šè¿‡ label åŒºåˆ†ä¸åŒæ¥æºçš„æ•°æ®ã€‚</p>
<p>æŸ¥è¯¢ method ä¸º POSTï¼Œstatus ä¸º 200 çš„é‡‡é›†æ•°æ®ï¼š</p>
<pre><code class="language-sh">http_server_requests_count{method=&quot;POST&quot;,status=&quot;200&quot;}
</code></pre>
<p>æ ‡ç­¾æ¡ä»¶æ”¯æŒ <code>=</code>ã€<code>!=</code>ã€<code>=~</code>ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰ã€‚</p>
<p>é»˜è®¤æŸ¥è¯¢çš„æ˜¯å½“å‰æ—¶é—´çš„æ•°æ®ï¼Œå¦‚æœè¦æŸ¥è¯¢è¿‡å»çš„æ•°æ®ï¼Œä½¿ç”¨ offsetï¼Œä¾‹å¦‚æŸ¥è¯¢ 5 åˆ†é’Ÿå‰çš„æ•°æ®ï¼š</p>
<pre><code class="language-sh">http_server_requests_count{method=&quot;POST&quot;,status=&quot;200&quot;} offset 5m
</code></pre>
<p>è¦æŸ¥è¯¢æŒ‡æ ‡åœ¨æŸä¸€åŒºé—´çš„æ•°å€¼ï¼Œä½¿ç”¨ []ï¼Œ[] ä¸­æ˜¯ä»å½“å‰æ—¶é—´ç›¸å¯¹äºç›¸å¯¹äº offetå‘å‰æ¨çš„æ—¶é—´æ®µï¼Œä¾‹å¦‚æŸ¥è¯¢ 5 åˆ†é’Ÿå‰çš„ 1 åˆ†é’ŸåŒºé—´é‡Œçš„æ•°æ®ï¼š</p>
<pre><code class="language-sh">http_server_requests_count{method=&quot;POST&quot;,status=&quot;200&quot;}[1m] offset 5m
</code></pre>
<h2 id="å‚è€ƒ-103"><a class="header" href="#å‚è€ƒ-103">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-æŒ‡æ ‡æŸ¥è¯¢ç»“æœè¿ç®—"><a class="header" href="#prometheus-æŒ‡æ ‡æŸ¥è¯¢ç»“æœè¿ç®—">Prometheus æŒ‡æ ‡æŸ¥è¯¢ç»“æœè¿ç®—</a></h1>
<p>Prometheus çš„æŸ¥è¯¢è¯­å¥æ”¯æŒè¿ç®—ï¼Œå¯ä»¥ä½¿ç”¨äºŒå…ƒè¿ç®—ç¬¦ï¼ˆç®—æœ¯è¿ç®—ç¬¦ã€æ¯”è¾ƒè¿ç®—ç¬¦ã€é›†åˆè¿ç®—ç¬¦ï¼‰å’Œèšåˆè¿ç®—ç¬¦ç›´æ¥æ“ä½œæŸ¥è¯¢å‡ºæ¥çš„æ•°æ®é›†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Prometheus æä¾›çš„æŸ¥è¯¢å‡½æ•°è¿›è¡Œæ›´å¤æ‚çš„è¿ç®—ã€‚</p>
<p>è¿ç®—ç¬¦æ“ä½œçš„å¯¹è±¡ä¸»è¦æ˜¯ Instant vectorã€Scalar ç±»å‹ã€‚æ“ä½œå¯¹è±¡ä¸­å­˜åœ¨ Instant vector æ—¶ï¼Œéœ€è¦çŸ¥é“æ•°ç»„æˆå‘˜å¦‚ä½•é…å¯¹ã€‚</p>
<h2 id="vector-çš„é…å¯¹é—®é¢˜"><a class="header" href="#vector-çš„é…å¯¹é—®é¢˜">vector çš„é…å¯¹é—®é¢˜</a></h2>
<p>æ“ä½œæ•°æ˜¯ä¸¤ä¸ª vector æ—¶ï¼Œvector ä¹‹é—´çš„é…å¯¹å…³ç³»å¯ä»¥æ˜¯ 1:1ã€1:Nã€N:1ã€‚</p>
<p><strong>1:1</strong>ï¼Œå·¦è¾¹ vector ä¸­æ•°æ® ä¸ å³è¾¹ vector ä¸­æ‹¥æœ‰ç›¸åŒ label çš„æ•°æ®é…å¯¹ï¼Œå¯ä»¥ç”¨ ignoring å¿½ç•¥éƒ¨åˆ† labelï¼Œæˆ–è€…ç”¨ on æŒ‡å®šé…å¯¹ä½¿ç”¨çš„ labelï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;
</code></pre>
<p><strong>1:Nï¼ŒN:1</strong>ï¼Œgroup_left è¡¨ç¤ºå³è¾¹ vector ä¸­çš„ä¸€ä¸ªæˆå‘˜ä¼šåŒ¹é…å·¦è¾¹çš„ vector ä¸­çš„å¤šä¸ªæˆå‘˜ï¼Œgroup_right åè¿‡æ¥ï¼Œå·¦è¾¹ vector ä¸­çš„ä¸€ä¸ªæˆå‘˜ä¼šåŒ¹é…å³è¾¹çš„ vector ä¸­çš„å¤šä¸ªæˆå‘˜ï¼Œgroup æŒ‡å®šçš„æ˜¯ Nã€‚ignoring å’Œ on åˆ†åˆ«ç”¨äºåˆ å‡ç”¨äºåŒ¹é…çš„ label ã€æŒ‡å®šç”¨äºåŒ¹é…çš„ labelï¼š</p>
<pre><code class="language-sh">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;

&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;
</code></pre>
<h2 id="vector-é…å¯¹ç¤ºä¾‹"><a class="header" href="#vector-é…å¯¹ç¤ºä¾‹">vector é…å¯¹ç¤ºä¾‹</a></h2>
<p>å‡è®¾ Prometheus ä¸­å­˜æ”¾ä¸‹é¢ä¸¤ä¸ªæŒ‡æ ‡æ•°æ®ï¼š</p>
<pre><code class="language-sh">method_code:http_errors:rate5m{method=&quot;get&quot;, code=&quot;500&quot;}  24
method_code:http_errors:rate5m{method=&quot;get&quot;, code=&quot;404&quot;}  30
method_code:http_errors:rate5m{method=&quot;put&quot;, code=&quot;501&quot;}  3
method_code:http_errors:rate5m{method=&quot;post&quot;, code=&quot;500&quot;} 6
method_code:http_errors:rate5m{method=&quot;post&quot;, code=&quot;404&quot;} 21

method:http_requests:rate5m{method=&quot;get&quot;}  600
method:http_requests:rate5m{method=&quot;del&quot;}  34
method:http_requests:rate5m{method=&quot;post&quot;} 120
</code></pre>
<p>1:1 é…å¯¹ï¼Œè®¡ç®—æ¯ä¸ªæ–¹æ³•ä¸­ 500 é”™è¯¯çš„å æ¯”ï¼Œå› ä¸º method:http_requests:rate5m æ²¡æœ‰åä¸º code çš„ labelï¼Œæ‰€ä»¥ç”¨ ignoring å¿½ç•¥ codeï¼Œåªå‰©ä¸‹ method label ç”¨äºé…å¯¹ ï¼š</p>
<pre><code class="language-sh">method_code:http_errors:rate5m{code=&quot;500&quot;} / ignoring(code) method:http_requests:rate5m
</code></pre>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">{method=&quot;get&quot;}  0.04            //  24 / 600
{method=&quot;post&quot;} 0.05            //   6 / 120
</code></pre>
<p>N:1 é…å¯¹ï¼Œè®¡ç®—æ¯ä¸ªæ–¹æ³•ä¸­æ‰€æœ‰é”™è¯¯ç çš„å æ¯”ï¼Œå¤šä¸ªé”™è¯¯ä»£ç å¯¹åº”ä¸€ç±»è¯·æ±‚ï¼š</p>
<pre><code class="language-sh">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m
</code></pre>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">{method=&quot;get&quot;, code=&quot;500&quot;}  0.04            //  24 / 600
{method=&quot;get&quot;, code=&quot;404&quot;}  0.05            //  30 / 600
{method=&quot;post&quot;, code=&quot;500&quot;} 0.05            //   6 / 120
{method=&quot;post&quot;, code=&quot;404&quot;} 0.175           //  21 / 120
</code></pre>
<h2 id="äºŒå…ƒè¿ç®—"><a class="header" href="#äºŒå…ƒè¿ç®—">äºŒå…ƒè¿ç®—</a></h2>
<p>ä¸¤ç»„æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®é›†ä¹‹é—´çš„è¿ç®—ã€‚</p>
<h3 id="ç®—æœ¯è¿ç®—ç¬¦"><a class="header" href="#ç®—æœ¯è¿ç®—ç¬¦">ç®—æœ¯è¿ç®—ç¬¦</a></h3>
<p>ç®—æœ¯è¿ç®—ç¬¦æ”¯æŒï¼š</p>
<pre><code>+ã€-ã€*ã€/ï¼ˆé™¤æ³•ï¼‰ã€%ï¼ˆå–æ¨¡ï¼‰ã€^ï¼ˆæŒ‡æ•°ï¼‰ã€‚
</code></pre>
<h3 id="æ¯”è¾ƒè¿ç®—ç¬¦"><a class="header" href="#æ¯”è¾ƒè¿ç®—ç¬¦">æ¯”è¾ƒè¿ç®—ç¬¦</a></h3>
<p>æ¯”è¾ƒè¿ç®—ç¬¦æ”¯æŒï¼š</p>
<pre><code>==ã€!=ã€&gt;ã€&lt;ã€&gt;=ã€&lt;=
</code></pre>
<h3 id="é›†åˆè¿ç®—ç¬¦"><a class="header" href="#é›†åˆè¿ç®—ç¬¦">é›†åˆè¿ç®—ç¬¦</a></h3>
<p>é›†åˆè¿ç®—ç¬¦æ”¯æŒï¼š</p>
<pre><code>andï¼ˆäº¤é›†ï¼‰ã€orï¼ˆå¹¶é›†ï¼‰ã€unlessï¼ˆå·®é›†ï¼‰
</code></pre>
<p>é›†åˆè¿ç®—ç¬¦éœ€è¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼Œvector1 and  vector2 çš„æ„æ€ä» vector1 ä¸­å–å‡ºæ»¡è¶³ vetctor2 ç­›é€‰æ¡ä»¶çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¡¨è¾¾å¼ï¼š</p>
<pre><code class="language-sh">http_server_requests_count{status=&quot;200&quot;} and http_server_requests_count{method=&quot;POST&quot;,instance=&quot;10.12.3.5:8866&quot;}
</code></pre>
<p>ç­‰åŒäºï¼š</p>
<pre><code class="language-sh">http_server_requests_count{status=&quot;200&quot;,method=&quot;POST&quot;,instance=&quot;10.12.3.5:8866&quot;}
</code></pre>
<p>vector1 or vector2 æ˜¯å–å‡º vector1 çš„æ‰€æœ‰æˆå‘˜ å’Œ vector2 ä¸­ä¸æ»¡è¶³ vector1 çš„ç­›é€‰æ¡ä»¶çš„æˆå‘˜ã€‚</p>
<pre><code class="language-sh">## ç»“æœä¸­åŒ…å«æ‰€æœ‰æ»¡è¶³ method=&quot;POST&quot; çš„æ•°æ®ï¼Œå¦‚æœé‡å¤é€‰æ‹© or ä¹‹å‰çš„æ•°æ®ã€‚
http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;} or http_server_requests_count{method=&quot;POST&quot;}
</code></pre>
<p>vector1 unless vector2 å–å‡ºä¸æ»¡è¶³ vector2 ç­›é€‰æ¡ä»¶çš„æ‰€æœ‰ vector1 çš„æˆå‘˜ï¼š</p>
<pre><code class="language-sh">http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;} unless http_server_requests_count{method=&quot;POST&quot;}
</code></pre>
<p>ç­‰åŒäºï¼š</p>
<pre><code class="language-sh">http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;,method!=&quot;POST&quot;}
</code></pre>
<h2 id="èšåˆè¿ç®—"><a class="header" href="#èšåˆè¿ç®—">èšåˆè¿ç®—</a></h2>
<p>èšåˆè¿ç®—ç¬¦å½¢æ€ä¸Šä¸å‡½æ•°ç±»ä¼¼ï¼Œç”¨äºåˆ†ææŸ¥è¯¢å¾—åˆ°çš„æ•°æ®é›†ã€‚</p>
<pre><code class="language-sh">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]
</code></pre>
<p>éƒ¨åˆ†èšåˆè¿ç®—ç¬¦éœ€è¦è¾“å…¥å‚æ•°ï¼ˆparameterï¼‰ï¼Œä¾‹å¦‚ count_valuesã€bottomkã€topk ã€quantileã€‚æ”¯æŒåˆ†ç»„èšåˆï¼Œåˆ†ç»„èšåˆæ—¶ï¼Œå¯ä»¥ç”¨ without å¿½ç•¥æŒ‡å®šçš„ labelï¼Œæˆ–è€… by æŒ‡å®šåˆ†ç»„ä½¿ç”¨çš„ labelï¼š</p>
<pre><code class="language-sh">sum:    æ±‚å’Œ
min:    æœ€å°å€¼
max:    æœ€å¤§å€¼
avg:    å¹³å‡å€¼
stddev: å¹³æ–¹å·®ï¼ˆstdvarçš„å¹³æ–¹æ ¹ï¼‰
stdvar: æ–¹å·®
count:  è®¡æ•°
count_values: ç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°
bottomk: å–ç»“æœä¸­æœ€å°çš„ k ä½æ•°
topk:    å–ç»“æœä¸­æœ€å¤§çš„ k ä½æ•°
quantile: å–åˆ†ä½æ•° (0 â‰¤ Ï† â‰¤ 1ï¼‰
</code></pre>
<h3 id="ç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°"><a class="header" href="#ç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°">ç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°</a></h3>
<p>ç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°ï¼Œå‚æ•°ä¸ºç»“æœä¸­çš„å­—ç¬¦ä¸²åç§°ï¼š</p>
<pre><code class="language-sh">count_values(&quot;str&quot;,http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;})
</code></pre>
<p><img src="prometheus/../img/prom/count_value.png" alt="prometheusæ•°æ®èšåˆç»“æœï¼šç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°" /></p>
<h3 id="å–å‰-k-ä½å-k-ä½"><a class="header" href="#å–å‰-k-ä½å-k-ä½">å–å‰ k ä½/å k ä½</a></h3>
<p>å–ç»“æœä¸­æœ€å°ï¼ˆbottomkï¼‰å’Œæœ€å¤§ï¼ˆtopkï¼‰çš„ k ä½æ•°ï¼Œå‚æ•°ä¸º kï¼š</p>
<pre><code class="language-sh">bottomk(2,http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;})
topk(2,http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;})
</code></pre>
<p><img src="prometheus/../img/prom/bottomk.png" alt="prometheusæ•°æ®èšåˆç»“æœï¼šå–ç»“æœä¸­æœ€å°çš„Kä½æ•°" /></p>
<h3 id="å–åˆ†ä½æ•°"><a class="header" href="#å–åˆ†ä½æ•°">å–åˆ†ä½æ•°</a></h3>
<p>å–ç¬¬ 0.3 åˆ†ä½æ•°ï¼Œè¾“å…¥å‚æ•°ä¸ºåˆ†ä½ä½ç½®ï¼š</p>
<pre><code class="language-sh">quantile(0.3,http_server_requests_count{status=&quot;200&quot;,instance=&quot;10.12.3.5:8866&quot;})
</code></pre>
<p><img src="prometheus/../img/prom/quantile.png" alt="prometheusæ•°æ®èšåˆç»“æœï¼šå–0.3åˆ†ä½çš„æ•°å€¼" /></p>
<h2 id="å‚è€ƒ-104"><a class="header" href="#å‚è€ƒ-104">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-çš„æŸ¥è¯¢å‡½æ•°"><a class="header" href="#prometheus-çš„æŸ¥è¯¢å‡½æ•°">Prometheus çš„æŸ¥è¯¢å‡½æ•°</a></h1>
<p>Prometheus çš„æŸ¥è¯¢å‡½æ•°æ•°é‡æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸ç½—åˆ—äº†ï¼Œè§ <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/" title="Prometheus Functions">Prometheus Functions</a>ã€‚</p>
<p>ä»¥åé€æ¸æŠŠä¸æ˜¯ç‰¹åˆ«å¥½ç†è§£çš„å‡½æ•°çš„ç”¨æ³•æ•´ç†åˆ°è¿™é‡Œã€‚</p>
<h2 id="åŒºé—´æ•°ç»„"><a class="header" href="#åŒºé—´æ•°ç»„">åŒºé—´æ•°ç»„</a></h2>
<p>åŒºé—´æ•°ç»„ï¼ˆrange-vectorï¼‰æ˜¯è¿‡å»ä¸€æ®µæ—¶é—´å†…çš„å¤šä¸ªæ•°å€¼ï¼Œæ•°å€¼ï¼ˆscalarï¼‰ã€‚</p>
<h3 id="aggregation_over_time----åŒºé—´å†…èšåˆè¿ç®—"><a class="header" href="#aggregation_over_time----åŒºé—´å†…èšåˆè¿ç®—"><strong>aggregation</strong>_over_time() -- åŒºé—´å†…èšåˆè¿ç®—</a></h3>
<p>è¿™ä¸€ç»„å‡½æ•°æœ‰å¤šä¸ªï¼Œåˆ†åˆ«è®¡ç®—åŒºé—´æ•°ç»„ä¸­çš„æ•°æ®çš„å¹³å‡å€¼ã€æœ€å°å€¼ã€æœ€å¤§å€¼ç­‰ï¼š</p>
<p>å½¢æ€ï¼š</p>
<pre><code class="language-sh">avg_over_time(range-vector)
min_over_time(range-vector)
max_over_time(range-vector)
sum_over_time(range-vector)
count_over_time(range-vector)
quantile_over_time(scalar, range-vector)
stddev_over_time(range-vector)
stdvar_over_time(range-vector)
</code></pre>
<h3 id="holt_winters----å¹³æ»‘æ•°å€¼"><a class="header" href="#holt_winters----å¹³æ»‘æ•°å€¼">holt_winters() -- å¹³æ»‘æ•°å€¼</a></h3>
<p>å½¢æ€ï¼šholt_winters(v range-vector, sf scalar, tf scalar)</p>
<p>æ ¹æ®åŒºé—´æ•°ç»„ä¸­çš„æ•°æ®è®¡ç®—ä¸‹ä¸€ä¸ªå¹³æ»‘å€¼ï¼Œsf æ˜¯å†å²æ•°å€¼çš„æƒé‡ï¼Œtf æ˜¯æœ€æ–°æ•°å€¼çš„æƒé‡ï¼Œsf å’Œ tf çš„å–å€¼èŒƒå›´ä¸º [0,1]ã€‚</p>
<h3 id="increase"><a class="header" href="#increase">increase()</a></h3>
<p>å½¢æ€ï¼šincrease(v range-vector)</p>
<p>è®¡ç®—åŒºé—´æ•°ç»„ä¸­çš„å¢åŠ å€¼ã€‚</p>
<h3 id="idelta"><a class="header" href="#idelta">idelta()</a></h3>
<p>å½¢æ€ï¼šidelta(v range-vector)</p>
<p>è¿”å›åŒºé—´æ•°ç»„ä¸­æœ€æ–°çš„ä¸¤ä¸ªæ•°å€¼çš„å·®å€¼ã€‚</p>
<h3 id="iraterate"><a class="header" href="#iraterate">irate()ã€rate()</a></h3>
<p>å½¢æ€ï¼širate(v range-vector)</p>
<p>ç”¨åŒºé—´æ•°ç»„ä¸­æœ€æ–°çš„ä¸¤ä¸ªæ•°å€¼è®¡ç®—æ¯ç§’å˜åŒ–ã€‚</p>
<p>å½¢æ€ï¼šrate(v range-vector)</p>
<p>ç”¨åŒºé—´æ•°ç»„ä¸­çš„æ•°å€¼è®¡ç®—æ¯ç§’å˜åŒ–ã€‚</p>
<h3 id="resets"><a class="header" href="#resets">resets()</a></h3>
<p>å½¢æ€ï¼šresets(v range-vector)</p>
<p>è¿”å›æ•°ç»„ä¸­è¢«é‡ç½®çš„è®¡æ•°å™¨ï¼ˆcounterï¼‰çš„æ•°é‡ã€‚</p>
<h3 id="changes----æŒ‡å®šæ—¶é—´æ®µå†…å˜åŒ–æ¬¡æ•°"><a class="header" href="#changes----æŒ‡å®šæ—¶é—´æ®µå†…å˜åŒ–æ¬¡æ•°">changes() -- æŒ‡å®šæ—¶é—´æ®µå†…å˜åŒ–æ¬¡æ•°</a></h3>
<p>å½¢æ€ï¼šchanges(v range-vector)</p>
<p>è®¡ç®— range-vectorï¼ˆåŒºé—´æ•°ç»„ï¼‰ä¸­çš„æ•°å€¼å˜åŒ–çš„æ¬¡æ•°ã€‚</p>
<h3 id="delta"><a class="header" href="#delta">delta()</a></h3>
<p>å½¢æ€ï¼šdelta(v range-vector)</p>
<p>è®¡ç®—åŒºé—´æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªæ•°å€¼ä¸æœ€åä¸€ä¸ªæ•°å€¼çš„å·®å€¼ã€‚</p>
<h3 id="deriv----çº¿æ€§å›å½’"><a class="header" href="#deriv----çº¿æ€§å›å½’">deriv() -- çº¿æ€§å›å½’</a></h3>
<p>å½¢æ€ï¼šderiv(v range-vector)</p>
<h3 id="predict_linear"><a class="header" href="#predict_linear">predict_linear()</a></h3>
<p>å½¢æ€ï¼špredict_linear(v range-vector, t scalar)</p>
<p>çº¿æ€§é¢„æµ‹æ—¶é•¿ t ä¹‹åçš„æ•°å€¼ã€‚</p>
<h2 id="æ•°ç»„"><a class="header" href="#æ•°ç»„">æ•°ç»„</a></h2>
<p>æ•°ç»„ï¼ˆinstant-vectorï¼‰æ˜¯åŒä¸€æ—¶åˆ»çš„å¤šä¸ªæ•°å€¼ï¼Œ</p>
<h3 id="abs----ç®—ç»å¯¹å€¼"><a class="header" href="#abs----ç®—ç»å¯¹å€¼">abs() -- ç®—ç»å¯¹å€¼</a></h3>
<p>å½¢æ€ï¼šabs(v instant-vector)</p>
<p>å°†æ•°ç»„ä¸­çš„æ•°å€¼è½¬æ¢æˆå„è‡ªçš„ç»å¯¹å€¼ã€‚</p>
<h3 id="absent----ç¼ºå€¼åˆ¤æ–­"><a class="header" href="#absent----ç¼ºå€¼åˆ¤æ–­">absent() -- ç¼ºå€¼åˆ¤æ–­</a></h3>
<p>å½¢æ€ï¼šabsent(v instant-vector)</p>
<p>å¦‚æœæŒ‡æ ‡ä¸ºç©ºï¼Œç»“æœä¸º 1ï¼Œå¦åˆ™ç»“æœä¸ºç©ºã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­æŒ‡æ ‡æŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œabsent çš„ç»“æœæ˜¯ 1ï¼š</p>
<p><a href="prometheus/../img/prom/absent.png">prometheusçš„absentå‡½æ•°ç”¨æ³•</a></p>
<h3 id="ceil----å½’æ•´"><a class="header" href="#ceil----å½’æ•´">ceil() -- å½’æ•´</a></h3>
<p>å½¢æ€ï¼šceil(v instant-vector)</p>
<p>å°†æ•°ç»„ä¸­çš„æ•°å€¼è½¬æ¢æˆå„è‡ªæœ€æ¥è¿‘çš„æ•´æ•°ã€‚</p>
<h3 id="floor----å‘ä¸‹å½’æ•´"><a class="header" href="#floor----å‘ä¸‹å½’æ•´">floor() -- å‘ä¸‹å½’æ•´</a></h3>
<p>å½¢æ€ï¼šfloor(v instant-vector)</p>
<h3 id="clamp_max----ä¸Šé™è½¬æ¢"><a class="header" href="#clamp_max----ä¸Šé™è½¬æ¢">clamp_max() -- ä¸Šé™è½¬æ¢</a></h3>
<p>å½¢æ€ï¼šclamp_max(v instant-vector, max scalar)</p>
<p>å°†æ•°ç»„ä¸­è¶…è¿‡ä¸Šé™çš„æ•°å€¼è½¬æ¢æˆä¸Šé™å€¼ maxã€‚</p>
<h3 id="clamp_min----ä¸‹é™è½¬æ¢"><a class="header" href="#clamp_min----ä¸‹é™è½¬æ¢">clamp_min() -- ä¸‹é™è½¬æ¢</a></h3>
<p>å½¢æ€ï¼šclamp_min(v instant-vector, min scalar)</p>
<p>å°†æ•°ç»„ä¸­ä½äºä¸‹é™çš„æ•°å€¼è½¬æ¢æˆä¸‹é™å€¼ minã€‚</p>
<h3 id="exp"><a class="header" href="#exp">exp()</a></h3>
<p>å½¢æ€ï¼šexp(v instant-vector)</p>
<h3 id="histogram_quantile----åˆ†ä½æ•°"><a class="header" href="#histogram_quantile----åˆ†ä½æ•°">histogram_quantile() -- åˆ†ä½æ•°</a></h3>
<p>å½¢æ€ï¼šhistogram_quantile(Ï† float, b instant-vector)</p>
<p>è¿”å›æ•°ç»„ä¸­çš„ Ï† åˆ†ä½æ•° [0,1]ã€‚</p>
<h3 id="round"><a class="header" href="#round">round()</a></h3>
<p>å½¢æ€ï¼šround(v instant-vector, to_nearest=1 scalar)</p>
<p>å°†æ•°ç»„ä¸­çš„æ•°æ®å‘ä¸Šå½’æ•´ï¼Œto_nearest æ˜¯å½’æ•´æ­¥é•¿ã€‚</p>
<p>The optional to_nearest argument allows specifying the nearest multiple to which the sample values should be rounded. This multiple may also be a fraction.</p>
<h3 id="scalar"><a class="header" href="#scalar">scalar()</a></h3>
<p>å½¢æ€ï¼šscalar(v instant-vector)</p>
<p>å°†åªæœ‰ä¸€ä¸ªæˆå‘˜çš„æ•°ç»„è½¬æ¢æˆæ•°å€¼ã€‚</p>
<h3 id="sortsort_desc"><a class="header" href="#sortsort_desc">sort()ã€sort_desc()</a></h3>
<p>å½¢æ€ï¼šsort(v instant-vector)ã€sort_desc(v instant-vector)</p>
<p>åˆ†åˆ«ä¸ºå‡åºã€é™åºæ’åˆ—ã€‚</p>
<h3 id="sqrt"><a class="header" href="#sqrt">sqrt()</a></h3>
<p>å½¢æ€ï¼šsqrt(v instant-vector)</p>
<p>è®¡ç®—å¹³æ–¹æ ¹ã€‚</p>
<h3 id="label_join"><a class="header" href="#label_join">label_join()</a></h3>
<p>å½¢æ€ï¼šlabel_join(v instant-vector, dst_label string, separator string, src_label_1 string, src_label_2 string, ...)</p>
<p>å°†å¤šä¸ª src_label_XX æ‹¼æ¥æˆä¸€ä¸ªæ–°çš„ dst_labelï¼Œç”¨åˆ†éš”ç¬¦ separator è¿æ¥ã€‚</p>
<h3 id="label_replace"><a class="header" href="#label_replace">label_replace()</a></h3>
<p>å½¢æ€ï¼šlabel_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)</p>
<p>ç”¨æ­£åˆ™ regex æå– src_label ä¸­çš„å­—æ®µï¼ŒæŒ‰ç…§ replacement å½¢æ€æ‹¼æ¥æˆ dst_labelã€‚</p>
<pre><code class="language-sh">label_replace(up{job=&quot;api-server&quot;,service=&quot;a:c&quot;}, &quot;foo&quot;, &quot;$1&quot;, &quot;service&quot;, &quot;(.*):.*&quot;)
</code></pre>
<h3 id="ln"><a class="header" href="#ln">ln()</a></h3>
<p>å½¢æ€ï¼šln(v instant-vector)</p>
<p>è®¡ç®—æ•°ç»„ä¸­çš„æ•°å€¼çš„å¯¹æ•°ã€‚</p>
<h3 id="log2-log10"><a class="header" href="#log2-log10">log2() ã€log10()</a></h3>
<p>å½¢æ€ï¼šlog2(v instant-vector)ã€log10(v instant-vector)</p>
<h3 id="vector"><a class="header" href="#vector">vector()</a></h3>
<p>å½¢æ€ï¼švector(s scalar)</p>
<p>å°†æ•°å€¼è½¬æ¢æˆæ•°ç»„ã€‚</p>
<h2 id="æ—¶é—´æ¢ç®—"><a class="header" href="#æ—¶é—´æ¢ç®—">æ—¶é—´æ¢ç®—</a></h2>
<h3 id="day_of_month----æœˆä¸­ä½ç½®"><a class="header" href="#day_of_month----æœˆä¸­ä½ç½®">day_of_month() -- æœˆä¸­ä½ç½®</a></h3>
<p>å½¢æ€ï¼šday_of_month(v=vector(time()) instant-vector)</p>
<p>è¿”å›å®¿ä¸»ä¸­çš„æ—¶é—´ä½äºæœˆä¸­ç¬¬å‡ å¤©ã€‚</p>
<h3 id="day_of_week----å‘¨ä¸­ä½ç½®"><a class="header" href="#day_of_week----å‘¨ä¸­ä½ç½®">day_of_week() -- å‘¨ä¸­ä½ç½®</a></h3>
<p>å½¢æ€ï¼šday_of_week(v=vector(time()) instant-vector)</p>
<p>è¿”å›å®¿ä¸»ä¸­çš„æ—¶é—´ä½äºå‘¨ä¸­ç¬¬å‡ å¤©ã€‚</p>
<h3 id="days_in_month----æœˆä»½å¤©æ•°"><a class="header" href="#days_in_month----æœˆä»½å¤©æ•°">days_in_month() -- æœˆä»½å¤©æ•°</a></h3>
<p>å½¢æ€ï¼šdays_in_month(v=vector(time()) instant-vector)</p>
<p>è¿”å›å®¿ä¸»ä¸­æ—¶é—´æ‰€åœ¨æœˆä»½çš„å¤©æ•°ã€‚</p>
<h3 id="year"><a class="header" href="#year">year()</a></h3>
<p>å½¢æ€ï¼šyear(v=vector(time()) instant-vector)</p>
<h3 id="month"><a class="header" href="#month">month()</a></h3>
<p>å½¢æ€ï¼šmonth(v=vector(time()) instant-vector)</p>
<h3 id="hour"><a class="header" href="#hour">hour()</a></h3>
<p>å½¢æ€ï¼šhour(v=vector(time()) instant-vector)</p>
<p>è¿”å›æ•°ç»„ä¸­æ—¶é—´ä½äºå½“å¤©çš„ç¬¬å‡ ä¸ªå°æ—¶ã€‚</p>
<h3 id="minute"><a class="header" href="#minute">minute()</a></h3>
<p>å½¢æ€ï¼šminute(v=vector(time()) instant-vector)</p>
<h3 id="time"><a class="header" href="#time">time()</a></h3>
<p>å½¢æ€ï¼štime()</p>
<p>è¿”å›å½“å‰çš„ UTC æ—¶é—´ï¼ˆç§’ï¼‰</p>
<h3 id="timestamp"><a class="header" href="#timestamp">timestamp()</a></h3>
<p>å½¢æ€ï¼štimestamp(v instant-vector)</p>
<p>è¿”å›æ•°ç»„ä¸­æ•°å€¼å¯¹åº”çš„æ—¶é—´æˆ³ã€‚</p>
<h2 id="å‚è€ƒ-105"><a class="header" href="#å‚è€ƒ-105">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus-çš„-exporters"><a class="header" href="#prometheus-çš„-exporters">Prometheus çš„ exporters</a></h1>
<p>Prometheus çš„è´Ÿè´£æ”¶é›†æŒ‡æ ‡æ•°æ®ã€æ‰§è¡Œå‘Šè­¦è§„åˆ™ã€æä¾›æŒ‡æ ‡æ•°æ®æŸ¥è¯¢åŠŸèƒ½ï¼ŒæŒ‡æ ‡æ•°æ®è¦ä¹ˆæ˜¯ç›®æ ‡ç³»ç»Ÿå®ç°äº† Prometheus æ ·å¼çš„æŒ‡æ ‡æ•°æ®ï¼Œè¦ä¹ˆé€šè¿‡å„ç§ exporter è·å–ã€‚<a href="https://prometheus.io/docs/instrumenting/exporters/#third-party-exporters" title="Third-party exporters">Third-party exporters</a> ä¸­æ”¶å½•äº†å¾ˆå¤š exporterï¼Œæœ¬æ‰‹å†Œé€æ¸æ”¶å½•å·¥ä½œä¸­ç”¨åˆ°çš„ä¸€äº› exporterã€‚</p>
<ul>
<li><a href="prometheus/./blackbox.html">blackbox exporter</a>ï¼šæ¢æµ‹ç›®æ ‡æœåŠ¡ï¼Œæ”¯æŒ HTTP HTTPS DNS TCP ICMP</li>
</ul>
<h2 id="å‚è€ƒ-106"><a class="header" href="#å‚è€ƒ-106">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="blackbox-exporteræ¢æµ‹è¿œç¨‹åœ°å€http-https-dns-tcp-icmp"><a class="header" href="#blackbox-exporteræ¢æµ‹è¿œç¨‹åœ°å€http-https-dns-tcp-icmp">Blackbox exporterï¼šæ¢æµ‹è¿œç¨‹åœ°å€ï¼ˆHTTP HTTPS DNS TCP ICMPï¼‰</a></h1>
<p><a href="https://github.com/prometheus/blackbox_exporter" title="blackbox_exporter">blackbox_exporter</a> ç”¨æ¥æ¢æµ‹ç›®æ ‡åœ°å€ï¼Œæ”¯æŒçš„åè®®æœ‰ï¼šHTTPã€HTTPSã€DNSã€TCPã€ICMPã€‚</p>
<h2 id="é…ç½®æ–‡ä»¶"><a class="header" href="#é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</a></h2>
<p>blackbox çš„é…ç½®æ–‡ä»¶ç”±å¤šä¸ª modules ç»„æˆï¼Œæ¯ä¸ª module ä»£è¡¨ä¸€ä¸ªåŠŸèƒ½ã€‚</p>
<p>åœ¨å½“å‰ç›®å½•ä¸­å‡†å¤‡ä¸€ä¸ªé…ç½®æ–‡ä»¶ <a href="https://github.com/prometheus/blackbox_exporter/blob/master/blackbox.yml" title="blackbox.yml">blackbox.yml</a>ï¼Œé‡Œé¢æœ‰ http_2xxã€http_post_2xx ç­‰æ¨¡å—ï¼š</p>
<pre><code class="language-yaml">modules:
  http_2xx:
    prober: http
    http:
      headers:
        Accept: &quot;*/*&quot;
  http_post_2xx:
    prober: http
    http:
      method: POST
  tcp_connect:
    prober: tcp
  pop3s_banner:
    prober: tcp
    tcp:
      query_response:
      - expect: &quot;^+OK&quot;
      tls: true
      tls_config:
        insecure_skip_verify: false
  ssh_banner:
    prober: tcp
    tcp:
      query_response:
      - expect: &quot;^SSH-2.0-&quot;
  irc_banner:
    prober: tcp
    tcp:
      query_response:
      - send: &quot;NICK prober&quot;
      - send: &quot;USER prober prober prober :prober&quot;
      - expect: &quot;PING :([^ ]+)&quot;
        send: &quot;PONG ${1}&quot;
      - expect: &quot;^:[^ ]+ 001&quot;
  icmp:
    prober: icmp
</code></pre>
<p><a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml" title="example.yml">example.yml</a> ä¸­åˆ—å‡ºäº†æ”¯æŒçš„åŠŸèƒ½æ¨¡å—ã€‚</p>
<h2 id="å¯åŠ¨è¿è¡Œ"><a class="header" href="#å¯åŠ¨è¿è¡Œ">å¯åŠ¨è¿è¡Œ</a></h2>
<p>ä½¿ç”¨ docker è¿è¡Œï¼Œblackbox.yml ä½äºå½“å‰ç›®å½•ï¼Œdocker çš„å®‰è£…æ–¹æ³•è§ <a href="prometheus/../docker/index.html">docker ä½¿ç”¨æ‰‹å†Œ</a>ï¼š </p>
<pre><code class="language-sh">docker run --rm -d -p 9115:9115 --name blackbox_exporter -v `pwd`:/config prom/blackbox-exporter:v0.15.1 --config.file=/config/blackbox.yml
</code></pre>
<p>æŸ¥çœ‹æ›´å¤šé•œåƒ <a href="https://hub.docker.com/r/prom/blackbox-exporter/tags" title="prom/blackbox-exporter">prom/blackbox-exporter</a>ã€‚</p>
<h2 id="å‚è€ƒ-107"><a class="header" href="#å‚è€ƒ-107">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-çš„-pushgateway-ä½œç”¨å’Œç”¨æ³•"><a class="header" href="#prometheus-çš„-pushgateway-ä½œç”¨å’Œç”¨æ³•">Prometheus çš„ pushgateway ä½œç”¨å’Œç”¨æ³•</a></h1>
<p>Prometheus é‡‡é›†æ•°æ®çš„æ–¹å¼æ˜¯å®šæ—¶è½®è¯¢ï¼Œè½®è¯¢çš„é¢‘ç‡åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š</p>
<pre><code class="language-yaml">global:
  scrape_interval:     30s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 30s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).
</code></pre>
<p>å¯¹äºçŸ­æ—¶è¿è¡Œã€ä¸æ”¯æŒè½®è¯¢çš„ä»»åŠ¡ï¼Œå¯ä»¥å¼•å…¥ <a href="https://github.com/prometheus/pushgateway" title="prometheus/pushgateway">pushgateway</a>ï¼Œå°†æŒ‡æ ‡æ•°å€¼ä»¥ push çš„æ–¹å¼æ¨é€åˆ° pushgatewayæš‚å­˜ï¼Œç„¶å prometheus ä» pushgateway ä¸­è½®è¯¢ã€‚ </p>
<p><img src="https://prometheus.io/assets/architecture.png" alt="Prometheus æ¶æ„å›¾" /></p>
<h2 id="è¿è¡Œ-pushgateway"><a class="header" href="#è¿è¡Œ-pushgateway">è¿è¡Œ pushgateway</a></h2>
<p>Docker çš„å®‰è£…æ–¹å¼è§ <a href="prometheus/../docker/install.html">Docker å®‰è£…éƒ¨ç½²</a>ã€‚</p>
<p>ç”¨ docker å¯åŠ¨ pushgateway æ˜¯æœ€æ–¹é¢çš„æ–¹å¼ï¼š</p>
<pre><code class="language-sh">docker pull prom/pushgateway:v0.9.1
docker run -d -p 9091:9091 prom/pushgateway:v0.9.1
</code></pre>
<p>å¯ä»¥ä½¿ç”¨çš„é•œåƒ tag è§ <a href="https://hub.docker.com/r/prom/pushgateway/tags" title="prom/pushgateway/tags">prom/pushgateway/tags</a>ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ v0.9.1ã€‚</p>
<pre><code class="language-sh"># docker ps
CONTAINER ID    IMAGE                     COMMAND              CREATED        STATUS         PORTS                    NAMES
9fe07d8f549e    prom/pushgateway:v0.9.1   &quot;/bin/pushgateway&quot;   4 seconds ago  Up 2 seconds   0.0.0.0:9091-&gt;9091/tcp   sleepy_swanson
</code></pre>
<p>ç”¨æµè§ˆå™¨æ‰“å¼€ pushgateway çš„é¡µé¢ï¼Œç«¯å£ä¸º 9901ï¼š</p>
<p><img src="prometheus/../img/prom/pushgateway.png" alt="Pushgatewayé¡µé¢" /></p>
<h2 id="å‘-pushgateway-æ¨é€æ•°æ®"><a class="header" href="#å‘-pushgateway-æ¨é€æ•°æ®">å‘ pushgateway æ¨é€æ•°æ®</a></h2>
<p>æ¨é€æ•°æ®çš„æ¥å£ä½¿ç”¨çš„æ˜¯ http åè®®ï¼Œ<a href="https://github.com/prometheus/pushgateway/blob/master/README.md#api" title="pushgateway api">pushgateway api</a> ä¸­æœ‰è¯´æ˜ã€‚</p>
<p>ç”¨ curl  æ¨é€æŒ‡æ ‡æ•°å€¼ï¼š</p>
<pre><code class="language-sh">$ cat &lt;&lt;EOF | curl --data-binary @- http://127.0.0.1:9091/metrics/job/some_job/instance/some_instance
# TYPE some_metric counter
some_metric{label=&quot;val1&quot;} 42
# TYPE another_metric gauge
# HELP another_metric Just an example.
another_metric 2398.283
EOF
</code></pre>
<p>æ¨é€æ•°æ®åï¼Œåœ¨é¡µé¢ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ metricsï¼š</p>
<p><img src="prometheus/../img/prom/pushgateway2.png" alt="Pushgatewayé¡µé¢" /></p>
<p><a href="https://prometheus.io/docs/instrumenting/pushing/" title="pushing metrics">pushing metrics</a></p>
<h2 id="ç”¨-prometheus-é‡‡é›†-pushgateway-ä¸­æŒ‡æ ‡æ•°æ®"><a class="header" href="#ç”¨-prometheus-é‡‡é›†-pushgateway-ä¸­æŒ‡æ ‡æ•°æ®">ç”¨ Prometheus é‡‡é›† pushgateway ä¸­æŒ‡æ ‡æ•°æ®</a></h2>
<p>æ¨é€åˆ° pushgateway ä¸­çš„æŒ‡æ ‡æ•°æ®ï¼Œé€šè¿‡ pushgateway çš„ <code>/metrics</code> æ¥å£è·å–ï¼š</p>
<pre><code class="language-sh">$ curl http://127.0.0.1:9091/metrics |grep &quot;some_&quot;
push_time_seconds{instance=&quot;some_instance&quot;,job=&quot;some_job&quot;} 1.5692110390599859e+09
# TYPE some_metric counter
some_metric{instance=&quot;some_instance&quot;,job=&quot;some_job&quot;,label=&quot;val1&quot;} 42
</code></pre>
<p>å¯ä»¥çœ‹åˆ° /metrics æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼æ˜¯ prometheus æ”¯æŒçš„æ ¼å¼ï¼Œå› æ­¤ç”¨ prometheus ç›´æ¥é‡‡é›†è¯¥æ¥å£çš„æ•°æ®å³å¯ã€‚</p>
<p>åœ¨ prometheus ä¸­é…ç½®ä¸€ä¸ªé™æ€çš„ jobï¼Œè½®è¯¢ pushgateway ä¸­çš„ /metricsï¼š</p>
<pre><code class="language-yaml">scrape_configs:
  - job_name: &quot;pushgateway&quot;
    static_configs:
    - targets:
        - &quot;127.0.0.1:9091/metrics&quot;
      labels:
        pushgateway: &quot;true&quot;
</code></pre>
<h2 id="å‚è€ƒ-108"><a class="header" href="#å‚è€ƒ-108">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="prometheus-è¿›é˜¶æ‹“å±•"><a class="header" href="#prometheus-è¿›é˜¶æ‹“å±•">Prometheus è¿›é˜¶æ‹“å±•</a></h1>
<h2 id="è§„æ¨¡æ‰©å±•"><a class="header" href="#è§„æ¨¡æ‰©å±•">è§„æ¨¡æ‰©å±•</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2020/02/12/prometheus-scale-out-1.html">Prometheus æ°´å¹³æ‰©å±•æ–¹æ¡ˆï¼ˆä¸€ï¼‰ï¼šç›‘æ§æ•°æ®çš„è½¬å‚¨ã€èšåˆã€æŸ¥è¯¢</a></li>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2020/02/24/prometheus-scale-out-2.html">Prometheus æ°´å¹³æ‰©å±•æ–¹æ¡ˆï¼ˆäºŒï¼‰ï¼šVictoria Metrics å­¦ä¹ ã€è¯•ç”¨</a></li>
</ul>
<h2 id="api-å’Œ-sdk"><a class="header" href="#api-å’Œ-sdk">API å’Œ SDK</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2019/04/29/prometheus-go-client-usage.html">ã€ŠPrometheus HTTP API çš„ Go sdk client_golang çš„ä½¿ç”¨ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/09/25/prometheus-client-usage.html">ã€Šä½¿ç”¨ Prometheus SDK è¾“å‡º Prometheus æ ¼å¼çš„ Metricsã€‹</a></li>
</ul>
<h2 id="å¸¸ç”¨æŠ€å·§"><a class="header" href="#å¸¸ç”¨æŠ€å·§">å¸¸ç”¨æŠ€å·§</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2018/09/14/prometheus-compute-kubernetes-container-cpu-usage.html">ã€Šé€šè¿‡ Prometheus æŸ¥è¯¢è®¡ç®— Kubernetes é›†ç¾¤ä¸­çš„å®¹å™¨CPUã€å†…å­˜ä½¿ç”¨ç‡ç­‰æŒ‡æ ‡ã€‹</a></li>
</ul>
<h2 id="é—®é¢˜è®°å½•"><a class="header" href="#é—®é¢˜è®°å½•">é—®é¢˜è®°å½•</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/08/03/prometheus-problem.html">ã€ŠPrometheusï¼ˆæ™®ç½—ç±³ä¿®æ–¯ï¼‰ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ã€‹</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2018/12/03/prometheus-blackbox-exporter-return-404.html">ã€Šcurlèƒ½è®¿é—®çš„urlï¼Œé€šè¿‡blackbox-expoeterè¿›è¡Œæ¢æµ‹æ—¶ï¼Œè¿”å›404ã€‹</a></li>
</ul>
<h2 id="è§†é¢‘è®²ä¹‰"><a class="header" href="#è§†é¢‘è®²ä¹‰">è§†é¢‘è®²ä¹‰</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/08/03/prometheus-usage.html">ã€Šæ–°å‹ç›‘æ§å‘Šè­¦å·¥å…·prometheusï¼ˆæ™®ç½—ç±³ä¿®æ–¯ï¼‰å…¥é—¨ä½¿ç”¨ï¼ˆé™„è§†é¢‘è®²è§£ï¼‰ã€‹</a></li>
</ul>
<h2 id="å‚è€ƒ-109"><a class="header" href="#å‚è€ƒ-109">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ansible-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#ansible-ä½¿ç”¨æ‰‹å†Œ">Ansible ä½¿ç”¨æ‰‹å†Œ</a></h1>
<p>è¿™é‡Œæ˜¯ <a href="https://www.lijiaocn.com/tags/all.html#ansible" title="ansibleå­¦ä¹ ç¬”è®°">ansible å­¦ä¹ ç¬”è®°</a> çš„é‡æ–°ï¼Œå†…å®¹éšç€å·¥ä½œå­¦ä¹ çš„è¿›è¡Œä¸æ–­æ›´æ–°ã€‚</p>
<h2 id="å‚è€ƒ-110"><a class="header" href="#å‚è€ƒ-110">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ä½¿ç”¨-ansible-æ“ä½œæ—¶ç”¨æˆ·æƒé™ç›¸å…³çš„è®¾ç½®"><a class="header" href="#ä½¿ç”¨-ansible-æ“ä½œæ—¶ç”¨æˆ·æƒé™ç›¸å…³çš„è®¾ç½®">ä½¿ç”¨ ansible æ“ä½œæ—¶ï¼Œç”¨æˆ·æƒé™ç›¸å…³çš„è®¾ç½®</a></h1>
<p>ä½¿ç”¨ ansible æ“ä½œæ—¶ï¼Œæœ‰æ—¶å€™éœ€è¦åˆ‡æ¢åˆ°ç‰¹æƒè´¦å·ï¼Œæ¯”å¦‚ rootã€‚</p>
<h2 id="åˆ‡æ¢åˆ°ç‰¹æƒç”¨æˆ·root"><a class="header" href="#åˆ‡æ¢åˆ°ç‰¹æƒç”¨æˆ·root">åˆ‡æ¢åˆ°ç‰¹æƒç”¨æˆ·ï¼ˆrootï¼‰</a></h2>
<p>ä½¿ç”¨ç™»å½•ç”¨æˆ· <code>ops</code> æ“ä½œæ—¶ï¼Œå› ä¸ºç›®æ ‡æƒé™è®¾ç½®ï¼Œops ç”¨æˆ·æ²¡æœ‰ /etc ç›®å½•çš„å†™å…¥æƒé™ï¼š</p>
<pre><code class="language-sh">$ ansible -i inventories/production/hosts -u ops  all   -m command  -a &quot;touch /etc/a&quot;
10.19.11.7 | FAILED | rc=1 &gt;&gt;
touch: cannot touch â€˜/etc/aâ€™: Permission deniednon-zero return code

10.19.117.30 | FAILED | rc=1 &gt;&gt;
touch: cannot touch â€˜/etc/aâ€™: Permission deniednon-zero return code
</code></pre>
<p>ä¾ç„¶ä½¿ç”¨ ops ç”¨æˆ·ï¼ŒåŠ ä¸Šå‚æ•° <code>-b --become-user=root</code> æå‡åˆ° root ç”¨æˆ·ï¼Œæå‡æ–¹æ³•ç”¨ <code>--become-method</code> æŒ‡å®šï¼Œé»˜è®¤æ˜¯ sudoï¼š</p>
<pre><code class="language-sh">$ ansible -i inventories/production/hosts -u ops -b --become-user=root all   -m command  -a &quot;touch /etc/a&quot;
10.19.11.7 | CHANGED | rc=0 &gt;&gt;
10.19.117.30 | CHANGED | rc=0 &gt;&gt;
</code></pre>
<p>ä½¿ç”¨ playbook æ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨ playbook æ–‡ä»¶ä¸­è®¾ç½®ï¼š</p>
<pre><code class="language-yaml">- hosts: all
  gather_facts: no
  become: true
  become_user: root
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç”¨-ansible-æ“ä½œæ–‡ä»¶å’Œ-url"><a class="header" href="#ç”¨-ansible-æ“ä½œæ–‡ä»¶å’Œ-url">ç”¨ ansible æ“ä½œæ–‡ä»¶å’Œ url</a></h1>
<h2 id="å°†-url-æŒ‡å‘çš„æ–‡ä»¶ä¸‹è½½åˆ°æŒ‡å®šç›®å½•"><a class="header" href="#å°†-url-æŒ‡å‘çš„æ–‡ä»¶ä¸‹è½½åˆ°æŒ‡å®šç›®å½•">å°† url æŒ‡å‘çš„æ–‡ä»¶ä¸‹è½½åˆ°æŒ‡å®šç›®å½•</a></h2>
<p><a href="https://docs.ansible.com/ansible/latest/modules/get_url_module.html#examples" title="get_url_module">get_url_module</a> æ¨¡å—æä¾›äº†è¯¥åŠŸèƒ½ï¼š</p>
<pre><code class="language-yaml">- name: Download docker repo
  get_url:
    url: https://download.docker.com/linux/centos/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo
</code></pre>
<p>å¦‚æœ dest æŒ‡å‘ç‰¹å®šç”¨æˆ·æ‰å¯ä»¥å†™å…¥çš„ç›®å½•ï¼Œå¯èƒ½éœ€è¦ <a href="ansible/./privilege.html">æå‡ç”¨æˆ·æƒé™</a>ã€‚</p>
<h2 id="å‚è€ƒ-111"><a class="header" href="#å‚è€ƒ-111">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç”¨-ansible-å®‰è£…è½¯ä»¶"><a class="header" href="#ç”¨-ansible-å®‰è£…è½¯ä»¶">ç”¨ ansible å®‰è£…è½¯ä»¶</a></h1>
<p>ansible æä¾›äº† <a href="https://docs.ansible.com/ansible/latest/modules/yum_module.html#yum-module" title="yum-module">yum-module</a>ã€<a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module" title="apt-module">apt-module</a>ã€<a href="https://docs.ansible.com/ansible/latest/modules/apk_module.html#apk-module" title="apk-module">apk-module</a>ç­‰æ¨¡å—ï¼Œç”¨æ¥åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šå®‰è£…è½¯ä»¶ã€‚</p>
<p>å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹æ³•åˆ¤æ–­ç›®æ ‡ç³»ç»Ÿç±»å‹ï¼Œä»è€Œå¯¼å…¥ä¸åŒçš„æ–‡ä»¶ï¼š</p>
<pre><code class="language-yaml">- name: install dependent packages
  import_tasks: centos.yml
  when: ansible_distribution == &quot;CentOS&quot;
</code></pre>
<p>ç”¨ setup æ¨¡å—æŸ¥çœ‹ ansible æ”¯æŒçš„å†…ç½®å˜é‡ï¼š</p>
<pre><code class="language-sh">$ ansible -i inventories/production/hosts 10.19.11.7  -m setup
&quot;ansible_distribution&quot;: &quot;CentOS&quot;,
&quot;ansible_distribution_file_parsed&quot;: true,
&quot;ansible_distribution_file_path&quot;: &quot;/etc/redhat-release&quot;,
&quot;ansible_distribution_file_variety&quot;: &quot;RedHat&quot;,
&quot;ansible_distribution_major_version&quot;: &quot;7&quot;,
&quot;ansible_distribution_release&quot;: &quot;Core&quot;,
&quot;ansible_distribution_version&quot;: &quot;7&quot;,
</code></pre>
<h2 id="åœ¨-centos-ä¸Šç”¨-yum-å®‰è£…"><a class="header" href="#åœ¨-centos-ä¸Šç”¨-yum-å®‰è£…">åœ¨ CentOS ä¸Šç”¨ yum å®‰è£…</a></h2>
<pre><code class="language-yaml">- name: Install docker
  notify: Start docker
  yum:
    name: docker-ce
    state: installed
</code></pre>
<p>å…¶ä¸­ notify æŒ‡å®šçš„å®‰è£…å®Œæˆåæ‰§è¡Œçš„ handler/main.yml ä¸­çš„åŒåæ“ä½œï¼š</p>
<pre><code class="language-yaml">- name: Start docker
  systemd:
    name: docker
    state: started
    daemon_reload: yes
    enabled: yes
</code></pre>
<h2 id="ç”¨-pip-å®‰è£…-python-åŒ…"><a class="header" href="#ç”¨-pip-å®‰è£…-python-åŒ…">ç”¨ pip å®‰è£… python åŒ…</a></h2>
<p><a href="https://docs.ansible.com/ansible/latest/modules/pip_module.html#pip-module" title="pip-module">pip-module</a> è°ƒç”¨ pip å‘½ä»¤å®‰è£… python åŒ…ï¼š</p>
<pre><code class="language-yaml">- name: install docker python lib
  pip:
    name: docker
</code></pre>
<h2 id="å‚è€ƒ-112"><a class="header" href="#å‚è€ƒ-112">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ä½¿ç”¨-ansible-æ“ä½œç›®æ ‡æœºå™¨ä¸Šçš„å®¹å™¨"><a class="header" href="#ä½¿ç”¨-ansible-æ“ä½œç›®æ ‡æœºå™¨ä¸Šçš„å®¹å™¨">ä½¿ç”¨ ansible æ“ä½œç›®æ ‡æœºå™¨ä¸Šçš„å®¹å™¨</a></h1>
<p>docker çš„å®‰è£…æ–¹æ³•è§ <a href="ansible/../docker/install.html">docker çš„å®‰è£…</a>ã€‚</p>
<p><img src="ansible/../img/ansible/docker1.png" alt="docker æ¨¡å—" /></p>
<h2 id="ç”¨-ansible-å®‰è£…-dockercentos"><a class="header" href="#ç”¨-ansible-å®‰è£…-dockercentos">ç”¨ ansible å®‰è£… dockerï¼ˆCentOSï¼‰</a></h2>
<p>åœ¨ tasks/main.yml ä¸­å†™å…¥ï¼š</p>
<pre><code class="language-yaml">- name: Download docker repo
  get_url:
    url: https://download.docker.com/linux/centos/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo

- name: Install docker
  notify: Start docker
  yum:
    name: docker-ce
    state: installed
</code></pre>
<p>åœ¨ handlers/main.yml ä¸­å†™å…¥ï¼š</p>
<pre><code class="language-yaml">- name: Start docker
  systemd:
    name: docker
    state: started
    daemon_reload: yes
    enabled: yes
</code></pre>
<h2 id="ç”¨-ansible-å¯åŠ¨å®¹å™¨"><a class="header" href="#ç”¨-ansible-å¯åŠ¨å®¹å™¨">ç”¨ ansible å¯åŠ¨å®¹å™¨</a></h2>
<p><a href="https://docs.ansible.com/ansible/latest/modules/docker_container_module.html#examples" title="docker_container">docker_container</a> æ¨¡å—ç”¨æ¥å¯åœå®¹å™¨ï¼š</p>
<pre><code class="language-yaml">- name: Start pushgateway container
  docker_container:
    state: started
    name:  pushgateway-v0.9.1
    image: prom/pushgateway:v0.9.1
    ports:
     - &quot;9091:9091&quot;
</code></pre>
<p>å¯èƒ½ä¼šé‡åˆ°ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<pre><code class="language-sh">TASK [pushgateway : Start pushgateway container] ***********************************************************************************************************************************************************
fatal: [10.19.11.7]: FAILED! =&gt; {&quot;ansible_facts&quot;: {&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;}, &quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to import docker or docker-py (Docker SDK for Python) - No module named requests.exceptions. Try `pip install docker` or `pip install docker-py` (Python 2.6).&quot;}
fatal: [10.19.117.30]: FAILED! =&gt; {&quot;ansible_facts&quot;: {&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;}, &quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to import docker or docker-py (Docker SDK for Python) - No module named requests.exceptions. Try `pip install docker` or `pip install docker-py` (Python 2.6).&quot;}
</code></pre>
<p>é‡åˆ°è¿™ç§æƒ…å†µï¼Œéœ€è¦åœ¨ <code>ç›®æ ‡æœºå™¨</code> ä¸Šå®‰è£… docker çš„ python åŒ…ï¼š</p>
<pre><code class="language-yaml">- name: Install pip
  yum:
    name: python2-pip
    state: installed
- name: Install docker python lib
  pip:
    name: docker
- name: Start pushgateway container
  docker_container:
    state: started
    name:  pushgateway-v0.9.1
    image: prom/pushgateway:v0.9.1
    ports:
     - &quot;9091:9091&quot;
</code></pre>
<h2 id="å‚è€ƒ-113"><a class="header" href="#å‚è€ƒ-113">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="perf-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#perf-ä½¿ç”¨æ‰‹å†Œ">Perf ä½¿ç”¨æ‰‹å†Œ</a></h1>
<p><a href="https://perf.wiki.kernel.org/index.php/Main_Page" title="perf: Linux profiling with performance counters ">Perf</a>ï¼Œ<a href="https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html" title="Performance Counters for Linux">Performance Counters for Linux</a> æ˜¯ä¸€ä¸ª Linux æ¢æŸ¥å·¥å…·ï¼Œç”¨æ¥è§‚å¯Ÿè®°å½•ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹å‘ç”Ÿçš„äº‹æƒ…ã€‚</p>
<p>æ€§èƒ½è°ƒä¼˜å¤§ç¥ <a href="http://www.brendangregg.com" title="Brendan D. Gregg">Brendan D. Gregg</a> åœ¨ <a href="http://www.brendangregg.com/perf.html" title="perf Examples">perf example</a> ä¸­è¯¦ç»†ä»‹ç»äº† perf çš„ç”¨æ³•ï¼Œè¯¥æ‰‹å†Œçš„ä¸»è¦ç»“æ„åŸºäºè¿™ç¯‡æ–‡ç« ï¼Œä¹Ÿæ”¶å½•äº†ä»å…¶å®ƒå„å¤„æœé›†åˆ°çš„ç›¸å…³çŸ¥è¯†ã€‚</p>
<h2 id="å‚è€ƒ-114"><a class="header" href="#å‚è€ƒ-114">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="perf-æŠ€æœ¯åŸç†performance-counters-å­ç³»ç»Ÿçš„é…å¥—å·¥å…·"><a class="header" href="#perf-æŠ€æœ¯åŸç†performance-counters-å­ç³»ç»Ÿçš„é…å¥—å·¥å…·">Perf æŠ€æœ¯åŸç†ï¼šPerformance Counters å­ç³»ç»Ÿçš„é…å¥—å·¥å…·</a></h1>
<p>2009 å¹´çš„æ—¶å€™ï¼Œä¸€ä¸ªåä¸º Performance Counters çš„å­ç³»ç»Ÿè¢«æäº¤åˆ° kernelï¼Œè¯¥å­ç³»ç»Ÿæä¾›â€œè®¡æ•°â€äº‹ä»¶çš„åŠŸèƒ½ï¼Œé‚®ä»¶ <a href="https://lwn.net/Articles/337493/" title="Performance Counters for Linux">Performance Counters for Linux</a> ä¸­æœ‰é˜è¿°ã€‚Perf æ˜¯è¯¥ç³»ç»Ÿçš„é…å¥—å·¥å…·ã€‚</p>
<h2 id="ç³»ç»Ÿè°ƒç”¨æ¥å£"><a class="header" href="#ç³»ç»Ÿè°ƒç”¨æ¥å£">ç³»ç»Ÿè°ƒç”¨æ¥å£</a></h2>
<p>Performance Counters å­ç³»ç»Ÿä¸­çš„ç»Ÿè®¡æ•°æ®é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <a href="http://man7.org/linux/man-pages/man2/perf_event_open.2.html" title="perf_event_open - set up performance monitoring">perf_event_open</a> è¯»å–ã€‚</p>
<pre><code class="language-c">#include &lt;linux/perf_event.h&gt;
#include &lt;linux/hw_breakpoint.h&gt;

int perf_event_open(struct perf_event_attr *attr,
                    pid_t pid, int cpu, int group_fd,
                    unsigned long flags);
</code></pre>
<p>å‚æ•° pid æ˜¯ç›®æ ‡è¿›ç¨‹å·ï¼Œæ—¢å¯ä»¥è¯»å–æŒ‡å®šè¿›ç¨‹çš„äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥è¯»å–æ‰€æœ‰è¿›ç¨‹çš„äº‹ä»¶ï¼Œè¯¦æƒ…è§ linux æ‰‹å†Œé¡µï¼š<a href="http://man7.org/linux/man-pages/man2/perf_event_open.2.html" title="perf_event_open - set up performance monitoring">perf_event_open - set up performance monitoring</a>ã€‚</p>
<h2 id="æƒé™æ§åˆ¶"><a class="header" href="#æƒé™æ§åˆ¶">æƒé™æ§åˆ¶</a></h2>
<p><a href="https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html" title="Perf Events and tool security">Perf Events and tool security</a> ä¸­ä»‹ç»äº†è®¾ç½® perf å‘½ä»¤æƒé™çš„æ–¹æ³•ï¼Œè¯»å–å†…æ ¸ä¸­çš„ç»Ÿè®¡æ•°æ®ï¼Œéœ€è¦æœ‰å“åº”çš„æƒé™ã€‚å•çº¯ä½œä¸ºä½¿ç”¨è€…å¯ä»¥ä¸å…³å¿ƒè¿™ä¸ªè¿‡ç¨‹ï¼Œå‘è¡Œç‰ˆä»¥åŠç”¨ yum ç­‰å‘½ä»¤å®‰è£…æ—¶ï¼Œä¼šå®Œæˆç›¸å…³è®¾ç½®ã€‚</p>
<h2 id="å‚è€ƒ-115"><a class="header" href="#å‚è€ƒ-115">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="perf-åŸºæœ¬ç”¨æ³•"><a class="header" href="#perf-åŸºæœ¬ç”¨æ³•">Perf åŸºæœ¬ç”¨æ³•</a></h1>
<p>Perf æœ‰äº”ä¸ªå­å‘½ä»¤ï¼Œå¯ä»¥ç”¨ man æŸ¥çœ‹æ¯ä¸ªå­å‘½ä»¤çš„ç”¨æ³•ï¼Œä¾‹å¦‚ <code>man perf-stat</code>ï¼š</p>
<pre><code class="language-sh">perf-stat(1), perf-top(1), perf-record(1), perf-report(1), perf-list(1)
</code></pre>
<p>perf æ—¢å¯ä»¥è·å–æ–°èµ·çš„è¿›ç¨‹çš„äº‹ä»¶ç»Ÿè®¡ï¼Œä¹Ÿå¯ä»¥è·å–å·²ç»å­˜åœ¨çš„è¿›ç¨‹æˆ–çº¿ç¨‹çš„äº‹ä»¶ç»Ÿè®¡ï¼Œåè€…ç”¨ <code>-p</code>ã€<code>-t</code> æŒ‡å®šè¿›ç¨‹å·ã€çº¿ç¨‹å·ã€‚</p>
<h2 id="perf-stat-æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•å®ƒçš„äº‹ä»¶"><a class="header" href="#perf-stat-æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•å®ƒçš„äº‹ä»¶">perf stat æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•å®ƒçš„äº‹ä»¶</a></h2>
<p>è¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå¹¶è®°å½•è¯¥å‘½ä»¤çš„äº‹ä»¶ä¿¡æ¯ï¼š</p>
<pre><code class="language-sh">perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] &lt;command&gt;
perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] â€” &lt;command&gt; [&lt;options&gt;]
</code></pre>
<h2 id="perf-top-æŸ¥çœ‹ç‰¹å®šäº‹ä»¶çš„åˆ†å¸ƒæƒ…å†µ"><a class="header" href="#perf-top-æŸ¥çœ‹ç‰¹å®šäº‹ä»¶çš„åˆ†å¸ƒæƒ…å†µ">perf top æŸ¥çœ‹ç‰¹å®šäº‹ä»¶çš„åˆ†å¸ƒæƒ…å†µ</a></h2>
<p>perf top å®æ—¶æ˜¾ç¤ºäº‹ä»¶åœ¨æ¯ä¸ªè¿›ç¨‹ä¸Šçš„åˆ†å¸ƒæƒ…å†µï¼š</p>
<pre><code class="language-sh">perf top [-e &lt;EVENT&gt; | --event=EVENT] [&lt;options&gt;]
</code></pre>
<h2 id="perf-record-å°†äº‹ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶"><a class="header" href="#perf-record-å°†äº‹ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶">perf record å°†äº‹ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶</a></h2>
<p>æ–‡ä»¶åæ˜¯ perf.dataï¼š</p>
<pre><code class="language-sh">perf record [-e &lt;EVENT&gt; | --event=EVENT] [-l] [-a] &lt;command&gt;
perf record [-e &lt;EVENT&gt; | --event=EVENT] [-l] [-a] â€” &lt;command&gt; [&lt;options&gt;]
</code></pre>
<h2 id="perf-report-è¯»å–æ–‡ä»¶"><a class="header" href="#perf-report-è¯»å–æ–‡ä»¶">perf report è¯»å–æ–‡ä»¶</a></h2>
<p>è¯»å–ç”¨ perf record ç”Ÿæˆçš„æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">perf report [-i &lt;file&gt; | --input=file]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="perf-å¯ä»¥è·å–çš„-pmu-äº‹ä»¶"><a class="header" href="#perf-å¯ä»¥è·å–çš„-pmu-äº‹ä»¶">Perf å¯ä»¥è·å–çš„ PMU äº‹ä»¶</a></h1>
<p><code>perf list</code> æ‰“å°æ‰€æœ‰å¯ä»¥æŒ‡å®šçš„äº‹ä»¶ï¼Œäº‹ä»¶çš„æ•°é‡éå¸¸éå¸¸å¤šï¼Œæ¯ä¸ªå­ç³»ç»Ÿéƒ½æœ‰ä¸€ç»„äº‹ä»¶ï¼Œè¦ç†è§£è¿™äº›äº‹ä»¶ï¼Œéœ€è¦å¯¹å†…æ ¸éå¸¸ç†Ÿæ‚‰ã€‚</p>
<pre><code class="language-sh">$ perf list
List of pre-defined events (to be used in -e):

  alignment-faults                                   [Software event]
  context-switches OR cs                             [Software event]
  cpu-clock                                          [Software event]
  cpu-migrations OR migrations                       [Software event]
  dummy                                              [Software event]
  emulation-faults                                   [Software event]
  major-faults                                       [Software event]
  minor-faults                                       [Software event]
  page-faults OR faults                              [Software event]
  task-clock                                         [Software event]

  msr/tsc/                                           [Kernel PMU event]

  rNNN                                               [Raw hardware event descriptor]
  cpu/t1=v1[,t2=v2,t3 ...]/modifier                  [Raw hardware event descriptor]
   (see 'man perf-list' on how to encode it)

  mem:&lt;addr&gt;[/len][:access]                          [Hardware breakpoint]

  alarmtimer:alarmtimer_cancel                       [Tracepoint event]
  alarmtimer:alarmtimer_fired                        [Tracepoint event]
  alarmtimer:alarmtimer_start                        [Tracepoint event]
  alarmtimer:alarmtimer_suspend                      [Tracepoint event]
  ...
  block:block_bio_backmerge                          [Tracepoint event]
  block:block_bio_backmerge                          [Tracepoint event]
  block:block_bio_bounce                             [Tracepoint event]
  block:block_bio_complete                           [Tracepoint event]
  block:block_bio_frontmerge                         [Tracepoint event]
  block:block_bio_queue                              [Tracepoint event]
  ...
  bridge:br_fdb_add                                  [Tracepoint event]
  bridge:br_fdb_external_learn_add                   [Tracepoint event]
  bridge:br_fdb_update                               [Tracepoint event]
  bridge:fdb_delete                                  [Tracepoint event]
  ...
  cgroup:cgroup_remount                              [Tracepoint event]
  cgroup:cgroup_rename                               [Tracepoint event]
  cgroup:cgroup_rmdir                                [Tracepoint event]
  cgroup:cgroup_setup_root                           [Tracepoint event]
  cgroup:cgroup_transfer_tasks                       [Tracepoint event]
  ...
  clk:clk_disable                                    [Tracepoint event]
  clk:clk_disable_complete                           [Tracepoint event]
  clk:clk_enable                                     [Tracepoint event]
  clk:clk_enable_complete                            [Tracepoint event]
  clk:clk_prepare                                    [Tracepoint event]
  clk:clk_prepare_complete                           [Tracepoint event]
  ...
  compaction:mm_compaction_begin                     [Tracepoint event]
  compaction:mm_compaction_defer_compaction          [Tracepoint event]
  compaction:mm_compaction_defer_reset               [Tracepoint event]
  compaction:mm_compaction_deferred                  [Tracepoint event]
  compaction:mm_compaction_end                       [Tracepoint event]
  compaction:mm_compaction_finished                  [Tracepoint event]
  compaction:mm_compaction_isolate_freepages         [Tracepoint event]
  ...
  context_tracking:user_enter                        [Tracepoint event]
  context_tracking:user_exit                         [Tracepoint event]
  ...
  cpuhp:cpuhp_enter                                  [Tracepoint event]
  cpuhp:cpuhp_exit                                   [Tracepoint event]
  cpuhp:cpuhp_multi_enter                            [Tracepoint event]
  ...  
  dma_fence:dma_fence_destroy                        [Tracepoint event]
  dma_fence:dma_fence_emit                           [Tracepoint event]
  dma_fence:dma_fence_enable_signal                  [Tracepoint event]
  ...
  exceptions:page_fault_kernel                       [Tracepoint event]
  exceptions:page_fault_user                         [Tracepoint event]
  ...
  fib6:fib6_table_lookup                             [Tracepoint event]
  fib:fib_table_lookup                               [Tracepoint event]
  ...
  filelock:break_lease_block                         [Tracepoint event]
  filelock:break_lease_noblock                       [Tracepoint event]
  filelock:break_lease_unblock                       [Tracepoint event]
  filelock:fcntl_setlk                               [Tracepoint event]
  ...
  filemap:file_check_and_advance_wb_err              [Tracepoint event]
  filemap:filemap_set_wb_err                         [Tracepoint event]
  filemap:mm_filemap_add_to_page_cache               [Tracepoint event]
  filemap:mm_filemap_delete_from_page_cache          [Tracepoint event]
  ...
  fs_dax:dax_insert_mapping                          [Tracepoint event]
  fs_dax:dax_insert_pfn_mkwrite                      [Tracepoint event]
  fs_dax:dax_insert_pfn_mkwrite_no_entry             [Tracepoint event]
  fs_dax:dax_load_hole                               [Tracepoint event]
  ...
  ftrace:function                                    [Tracepoint event]
  ftrace:print                                       [Tracepoint event]
  huge_memory:mm_collapse_huge_page                  [Tracepoint event]
  huge_memory:mm_collapse_huge_page_isolate          [Tracepoint event]
  huge_memory:mm_collapse_huge_page_swapin           [Tracepoint event]
  huge_memory:mm_khugepaged_scan_pmd                 [Tracepoint event]
  hwmon:hwmon_attr_show                              [Tracepoint event]
  hwmon:hwmon_attr_show_string                       [Tracepoint event]
  hwmon:hwmon_attr_store                             [Tracepoint event]
  hyperv:hyperv_mmu_flush_tlb_others                 [Tracepoint event]
  hyperv:hyperv_nested_flush_guest_mapping           [Tracepoint event]
  hyperv:hyperv_send_ipi_mask                        [Tracepoint event]
  i2c:i2c_read                                       [Tracepoint event]
  i2c:i2c_reply                                      [Tracepoint event]
  i2c:i2c_result                                     [Tracepoint event]
  i2c:i2c_write                                      [Tracepoint event]
  initcall:initcall_finish                           [Tracepoint event]
  initcall:initcall_level                            [Tracepoint event]
  initcall:initcall_start                            [Tracepoint event]
  iommu:add_device_to_group                          [Tracepoint event]
  iommu:attach_device_to_domain                      [Tracepoint event]
  iommu:detach_device_from_domain                    [Tracepoint event]
  iommu:io_page_fault                                [Tracepoint event]
  iommu:map                                          [Tracepoint event]
  iommu:remove_device_from_group                     [Tracepoint event]
  iommu:unmap                                        [Tracepoint event]
  irq:irq_handler_entry                              [Tracepoint event]
  irq:irq_handler_exit                               [Tracepoint event]
  irq:softirq_entry                                  [Tracepoint event]
  irq:softirq_exit                                   [Tracepoint event]
  irq:softirq_raise                                  [Tracepoint event]
  irq_matrix:irq_matrix_alloc                        [Tracepoint event]
  irq_matrix:irq_matrix_alloc_managed                [Tracepoint event]
  kmem:kfree                                         [Tracepoint event]
  kmem:kmalloc                                       [Tracepoint event]
  kmem:kmalloc_node                                  [Tracepoint event]
  kmem:kmem_cache_alloc                              [Tracepoint event]
  kmem:kmem_cache_alloc_node                         [Tracepoint event]
  kmem:kmem_cache_free                               [Tracepoint event]
  libata:ata_eh_link_autopsy                         [Tracepoint event]
  libata:ata_eh_link_autopsy_qc                      [Tracepoint event]
  libata:ata_qc_complete_done                        [Tracepoint event]
  mce:mce_record                                     [Tracepoint event]
  mdio:mdio_access                                   [Tracepoint event]
  migrate:mm_migrate_pages                           [Tracepoint event]
  module:module_free                                 [Tracepoint event]
  module:module_get                                  [Tracepoint event]
  module:module_load                                 [Tracepoint event]
  module:module_put                                  [Tracepoint event]
  module:module_request                              [Tracepoint event]
  msr:rdpmc                                          [Tracepoint event]
  msr:read_msr                                       [Tracepoint event]
  msr:write_msr                                      [Tracepoint event]
  napi:napi_poll                                     [Tracepoint event]
  net:napi_gro_frags_entry                           [Tracepoint event]
  net:napi_gro_receive_entry                         [Tracepoint event]
  net:net_dev_queue                                  [Tracepoint event]
  net:net_dev_start_xmit                             [Tracepoint event]
  nvme:nvme_async_event                              [Tracepoint event]
  nvme:nvme_complete_rq                              [Tracepoint event]
  nvme:nvme_setup_cmd                                [Tracepoint event]
  oom:compact_retry                                  [Tracepoint event]
  oom:finish_task_reaping                            [Tracepoint event]
  oom:mark_victim                                    [Tracepoint event]
  oom:oom_score_adj_update                           [Tracepoint event]
  oom:reclaim_retry_zone                             [Tracepoint event]
  oom:skip_task_reaping                              [Tracepoint event]
  oom:start_task_reaping                             [Tracepoint event]
  oom:wake_reaper                                    [Tracepoint event]
  page_isolation:test_pages_isolated                 [Tracepoint event]
  pagemap:mm_lru_activate                            [Tracepoint event]
  pagemap:mm_lru_insertion                           [Tracepoint event]
  percpu:percpu_alloc_percpu                         [Tracepoint event]
  percpu:percpu_alloc_percpu_fail                    [Tracepoint event]
  percpu:percpu_create_chunk                         [Tracepoint event]
  percpu:percpu_destroy_chunk                        [Tracepoint event]
  percpu:percpu_free_percpu                          [Tracepoint event]
  power:clock_disable                                [Tracepoint event]
  power:clock_enable                                 [Tracepoint event]
  power:clock_set_rate                               [Tracepoint event]
  printk:console                                     [Tracepoint event]
  qdisc:qdisc_dequeue                                [Tracepoint event]
  random:add_device_randomness                       [Tracepoint event]
  random:add_disk_randomness                         [Tracepoint event]
  random:add_input_randomness                        [Tracepoint event]
  random:credit_entropy_bits                         [Tracepoint event]
  random:debit_entropy                               [Tracepoint event]
  random:extract_entropy                             [Tracepoint event]
  ras:aer_event                                      [Tracepoint event]
  ras:arm_event                                      [Tracepoint event]
  ras:mc_event                                       [Tracepoint event]
  ras:memory_failure_event                           [Tracepoint event]
  ras:non_standard_event                             [Tracepoint event]
  raw_syscalls:sys_enter                             [Tracepoint event]
  raw_syscalls:sys_exit                              [Tracepoint event]
  rcu:rcu_utilization                                [Tracepoint event]
  regmap:regcache_drop_region                        [Tracepoint event]
  regmap:regcache_sync                               [Tracepoint event]
  regmap:regmap_async_complete_done                  [Tracepoint event]
  regmap:regmap_async_complete_start                 [Tracepoint event]
  regmap:regmap_async_io_complete                    [Tracepoint event]
  regmap:regmap_async_write_start                    [Tracepoint event]
  rseq:rseq_ip_fixup                                 [Tracepoint event]
  rseq:rseq_update                                   [Tracepoint event]
  rtc:rtc_alarm_irq_enable                           [Tracepoint event]
  rtc:rtc_irq_set_freq                               [Tracepoint event]
  rtc:rtc_irq_set_state                              [Tracepoint event]
  rtc:rtc_read_alarm                                 [Tracepoint event]
  rtc:rtc_read_offset                                [Tracepoint event]
  rtc:rtc_read_time                                  [Tracepoint event]
  rtc:rtc_set_alarm                                  [Tracepoint event]
  rtc:rtc_set_offset                                 [Tracepoint event]
  rtc:rtc_set_time                                   [Tracepoint event]
  rtc:rtc_timer_dequeue                              [Tracepoint event]
  rtc:rtc_timer_enqueue                              [Tracepoint event]
  rtc:rtc_timer_fired                                [Tracepoint event]
  sched:sched_kthread_stop                           [Tracepoint event]
  sched:sched_kthread_stop_ret                       [Tracepoint event]
  sched:sched_migrate_task                           [Tracepoint event]
  sched:sched_move_numa                              [Tracepoint event]
  smbus:smbus_write                                  [Tracepoint event]
  sock:inet_sock_set_state                           [Tracepoint event]
  sock:sock_exceed_buf_limit                         [Tracepoint event]
  sock:sock_rcvqueue_full                            [Tracepoint event]
  spi:spi_controller_busy                            [Tracepoint event]
  spi:spi_controller_idle                            [Tracepoint event]
  spi:spi_message_done                               [Tracepoint event]
  spi:spi_message_start                              [Tracepoint event]
  spi:spi_message_submit                             [Tracepoint event]
  spi:spi_transfer_start                             [Tracepoint event]
  spi:spi_transfer_stop                              [Tracepoint event]
  swiotlb:swiotlb_bounced                            [Tracepoint event]
  syscalls:sys_enter_accept                          [Tracepoint event]
  syscalls:sys_enter_accept4                         [Tracepoint event]
  syscalls:sys_enter_access                          [Tracepoint event]
  syscalls:sys_enter_acct                            [Tracepoint event]
  task:task_newtask                                  [Tracepoint event]
  task:task_rename                                   [Tracepoint event]
  tcp:tcp_destroy_sock                               [Tracepoint event]
  tcp:tcp_probe                                      [Tracepoint event]
  tcp:tcp_rcv_space_adjust                           [Tracepoint event]
  tcp:tcp_receive_reset                              [Tracepoint event]
  tcp:tcp_retransmit_skb                             [Tracepoint event]
  tcp:tcp_retransmit_synack                          [Tracepoint event]
  tcp:tcp_send_reset                                 [Tracepoint event]
  thermal:cdev_update                                [Tracepoint event]
  thermal:thermal_temperature                        [Tracepoint event]
  thermal:thermal_zone_trip                          [Tracepoint event]
  thermal_power_allocator:thermal_power_allocator    [Tracepoint event]
  thermal_power_allocator:thermal_power_allocator_pid [Tracepoint event]
  timer:hrtimer_cancel                               [Tracepoint event]
  timer:hrtimer_expire_entry                         [Tracepoint event]
  timer:hrtimer_expire_exit                          [Tracepoint event]
  vmscan:mm_vmscan_memcg_softlimit_reclaim_begin     [Tracepoint event]
  vmscan:mm_vmscan_memcg_softlimit_reclaim_end       [Tracepoint event]
  vmscan:mm_vmscan_wakeup_kswapd                     [Tracepoint event]
  vmscan:mm_vmscan_writepage                         [Tracepoint event]
  vsyscall:emulate_vsyscall                          [Tracepoint event]
  workqueue:workqueue_activate_work                  [Tracepoint event]
  workqueue:workqueue_execute_end                    [Tracepoint event]
  workqueue:workqueue_execute_start                  [Tracepoint event]
  workqueue:workqueue_queue_work                     [Tracepoint event]
  writeback:balance_dirty_pages                      [Tracepoint event]
  writeback:bdi_dirty_ratelimit                      [Tracepoint event]
  writeback:global_dirty_state                       [Tracepoint event]
  writeback:sb_clear_inode_writeback                 [Tracepoint event]
  x86_fpu:x86_fpu_copy_src                           [Tracepoint event]
  x86_fpu:x86_fpu_dropped                            [Tracepoint event]
  x86_fpu:x86_fpu_init_state                         [Tracepoint event]
  x86_fpu:x86_fpu_regs_activated                     [Tracepoint event]
  x86_fpu:x86_fpu_regs_deactivated                   [Tracepoint event]
  x86_fpu:x86_fpu_xstate_check_failed                [Tracepoint event]
  xdp:xdp_cpumap_enqueue                             [Tracepoint event]
  xdp:xdp_cpumap_kthread                             [Tracepoint event]
  xdp:xdp_devmap_xmit                                [Tracepoint event]
  xdp:xdp_exception                                  [Tracepoint event]
  xdp:xdp_redirect                                   [Tracepoint event]
  xdp:xdp_redirect_err                               [Tracepoint event]
  xen:xen_mmu_set_pte                                [Tracepoint event]
  xen:xen_mmu_set_pte_at                             [Tracepoint event]
  xen:xen_mmu_set_pud                                [Tracepoint event]
  xen:xen_mmu_write_cr3                              [Tracepoint event]
  xfs:xfs_ag_resv_alloc_extent                       [Tracepoint event]
  xfs:xfs_ag_resv_critical                           [Tracepoint event]
  xfs:xfs_ag_resv_free                               [Tracepoint event]
  xfs:xfs_ag_resv_free_error                         [Tracepoint event]
  xfs:xfs_ag_resv_free_extent                        [Tracepoint event]
  xfs:xfs_ag_resv_init                               [Tracepoint event]
  xfs:xfs_ag_resv_init_error                         [Tracepoint event]
  xhci-hcd:xhci_address_ctx                          [Tracepoint event]
  xhci-hcd:xhci_alloc_dev                            [Tracepoint event]
  xhci-hcd:xhci_alloc_virt_device                    [Tracepoint event]
  xhci-hcd:xhci_configure_endpoint                   [Tracepoint event]
  xhci-hcd:xhci_dbc_alloc_request                    [Tracepoint event]
  xhci-hcd:xhci_dbc_free_request                     [Tracepoint event]
  xhci-hcd:xhci_dbc_gadget_ep_queue                  [Tracepoint event]
</code></pre>
<h2 id="å‚è€ƒ-116"><a class="header" href="#å‚è€ƒ-116">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#docker-ä½¿ç”¨æ‰‹å†Œ">Docker ä½¿ç”¨æ‰‹å†Œ</a></h1>
<p>è¿™ä¸ªç³»åˆ—çš„å†…å®¹æ¥è‡ªè¿‡å»å‡ å¹´å·¥ä½œä¸­ç§¯æ”’çš„ç¬”è®°ï¼š<a href="https://www.lijiaocn.com/tags/all.html#docker" title="Dockerç¬”è®°">Docker ç¬”è®°</a>ã€‚</p>
<p>æœ€å¥½çš„ Docker èµ„æ–™å½“ç„¶æ˜¯ï¼š<a href="https://docs.docker.com/" title="Docker å®˜æ–¹æ–‡æ¡£">Dockerå®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>ğŸ‘ˆ ä»å·¦ä¾§ç›®å½•å¼€å§‹é˜…è¯»ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="docker-å®‰è£…éƒ¨ç½²"><a class="header" href="#docker-å®‰è£…éƒ¨ç½²">Docker å®‰è£…éƒ¨ç½²</a></h1>
<p>dockerã€docker-ce å’Œ docker-ee çš„å…³ç³»è§ <a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/07/18/docker-commnuity.html" title="mobyã€docker-ceä¸docker-ee">mobyã€docker-ceä¸docker-ee</a>ã€‚</p>
<p>æ¨èä½¿ç”¨ docker-ceã€‚</p>
<h2 id="centos---å®‰è£…-docker-ce"><a class="header" href="#centos---å®‰è£…-docker-ce">CentOS - å®‰è£… docker-ce</a></h2>
<p>æ·»åŠ  docker-ce çš„æºï¼Œå®‰è£… docker-ceï¼š</p>
<pre><code class="language-sh">wget https://download.docker.com/linux/centos/docker-ce.repo
mv docker-ce.repo /etc/yum.repos.d
yum install -y docker-ce
</code></pre>
<p>å¯åŠ¨ï¼š</p>
<pre><code class="language-sh">systemctl start docker
</code></pre>
<h2 id="é…ç½®é˜¿é‡Œäº‘é•œåƒ"><a class="header" href="#é…ç½®é˜¿é‡Œäº‘é•œåƒ">é…ç½®é˜¿é‡Œäº‘é•œåƒ</a></h2>
<p>docker çš„é•œåƒæœåŠ¡å™¨åœ¨å¢ƒå¤–ï¼Œä»å›½å†…æ‹‰å–é•œåƒä¼šç‰¹åˆ«æ…¢ã€‚ç»™ docker é…ç½®ä¸€ä¸ªå›½å†…çš„é•œåƒæºå¯ä»¥å¤§å¤§ç¼©çŸ­é•œåƒçš„è·å–æ—¶é—´ã€‚</p>
<p>åœ¨ /etc/docker/daemon.json ä¸­æ·»åŠ ä¸‹é¢çš„é…ç½®ï¼Œå¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œ ç„¶åé‡å¯ dockerï¼š</p>
<pre><code class="language-json">{
  &quot;registry-mirrors&quot; : [
    &quot;https://pee6w651.mirror.aliyuncs.com&quot;
  ]
}
</code></pre>
<p>å¦‚æœæ˜¯æœ‰å›¾å½¢ç•Œé¢çš„ docker æ›´ç®€å•ï¼š</p>
<p><img src="docker/../img/docker/mirror.png" alt="docker daemon é…ç½®" /></p>
<h2 id="å‚è€ƒ-117"><a class="header" href="#å‚è€ƒ-117">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="docker-å®¹å™¨æ“ä½œ"><a class="header" href="#docker-å®¹å™¨æ“ä½œ">Docker å®¹å™¨æ“ä½œ</a></h1>
<p>Docker é•œåƒçš„ç®¡ç†æ–¹æ³•åœ¨åé¢ç« èŠ‚ï¼Œè¿™é‡Œå…ˆç›´æ¥ç”¨ä¸‹é¢çš„å‘½ä»¤è·å–åé¢çš„æ¼”ç¤ºä¸­ç”¨åˆ°çš„é•œåƒï¼š</p>
<pre><code class="language-sh">docker pull alpine:3.9.5
</code></pre>
<p><a href="https://docs.docker.com/engine/reference/run/" title="docker command">docker command</a> ä¸­åˆ—å‡ºäº†æ‰€æœ‰å‘½ä»¤çš„ç”¨æ³•ï¼Œä¸‹é¢åªåˆ—ä¸¾æœ€å¸¸ç”¨çš„ä¸€äº›ã€‚</p>
<h2 id="å‰å°è¿è¡Œ"><a class="header" href="#å‰å°è¿è¡Œ">å‰å°è¿è¡Œ</a></h2>
<pre><code class="language-sh">$ docker run --rm -it  alpine:3.9.5 /bin/sh
/ # ip addr |grep eth0
298: eth0@if299: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</code></pre>
<p>docker help run æŸ¥çœ‹é€‰é¡¹ï¼š</p>
<pre><code class="language-sh">--rm  :æ‰§è¡Œç»“æŸååˆ é™¤å®¹å™¨
-t    :åˆ›å»ºtty
-i    :äº¤äº’è¿è¡Œ
</code></pre>
<h2 id="åå°è¿è¡Œ"><a class="header" href="#åå°è¿è¡Œ">åå°è¿è¡Œ</a></h2>
<pre><code class="language-sh">$ docker run -d alpine:3.9.5 /bin/sh -c &quot;while true;do echo hello world; sleep 1;done&quot;
2eecc150eda7af8226b29856468a5428e59664977663779f591cae59c1a217b5
</code></pre>
<p>-d è¡¨ç¤ºæ”¾å…¥åå°è¿è¡Œ, ä¸‹é¢æ˜¾ç¤ºå­—ç¬¦ä¸²å®¹å™¨çš„ idã€‚</p>
<h2 id="æŸ¥çœ‹å®¹å™¨"><a class="header" href="#æŸ¥çœ‹å®¹å™¨">æŸ¥çœ‹å®¹å™¨</a></h2>
<pre><code class="language-sh">$ docker ps
CONTAINER ID    IMAGE          COMMAND                  CREATED             STATUS          PORTS    NAMES
d9c9aed4e644    alpine:3.9.5   &quot;/bin/sh -c 'while tâ€¦&quot;   57 seconds ago      Up 55 seconds            infallible_antonelli
</code></pre>
<p>ç¬¬ä¸€æ æ˜¯å®¹å™¨ ID çš„ç®€çŸ­å½¢å¼, æœ€åä¸€æ  docker è‡ªåŠ¨ä¸ºå®¹å™¨åˆ†é…çš„åå­—ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªåå­—å’Œå®¹å™¨è¿›è¡Œäº¤äº’ã€‚</p>
<p>è¿è¡Œæ—¶æŒ‡å®šå®¹å™¨åï¼š</p>
<pre><code class="language-sh">$ docker run -d --name=&quot;Hello&quot; alpine:3.9.5 /bin/sh -c &quot;while true;do echo hello world; sleep 1;done&quot;
</code></pre>
<h2 id="å®¹å™¨çš„è¾“å‡º"><a class="header" href="#å®¹å™¨çš„è¾“å‡º">å®¹å™¨çš„è¾“å‡º</a></h2>
<p>ç”¨ docker logs æŸ¥çœ‹åå°è¿è¡Œçš„å®¹å™¨çš„è¾“å‡º, ç›®æ ‡å®¹å™¨å¯ä»¥é€šè¿‡ id æŒ‡å®š, ä¹Ÿå¯ä»¥é€šè¿‡ name æŒ‡å®š:</p>
<pre><code class="language-sh">$ docker logs -f Hello
hello world
hello world
hello world
</code></pre>
<h2 id="å®¹å™¨ä¸­è¿›ç¨‹"><a class="header" href="#å®¹å™¨ä¸­è¿›ç¨‹">å®¹å™¨ä¸­è¿›ç¨‹</a></h2>
<p>å¯ä»¥é€šè¿‡ docker top æŸ¥çœ‹å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹ï¼š</p>
<pre><code class="language-sh">$ docker top Hello
PID      USER      TIME     COMMAND
51993    root      0:00     /bin/sh -c while true;do echo hello world; sleep 1;done
52096    root      0:00     sleep 1
</code></pre>
<h2 id="å®¹å™¨è¯¦æƒ…"><a class="header" href="#å®¹å™¨è¯¦æƒ…">å®¹å™¨è¯¦æƒ…</a></h2>
<p>å¯ä»¥é€šè¿‡ docker inspect æŸ¥çœ‹å®¹å™¨çš„è¯¦æƒ…ï¼š</p>
<pre><code class="language-sh">$ docker inspect Hello
[
    {
        &quot;Id&quot;: &quot;ef3983bcc0c13660d95d33dce1a4cd7626992a2f211022ac509bae891918918d&quot;,
        &quot;Created&quot;: &quot;2020-03-01T10:44:06.5211288Z&quot;,
        &quot;Path&quot;: &quot;/bin/sh&quot;,
        &quot;Args&quot;: [
            &quot;-c&quot;,
            &quot;while true;do echo hello world; sleep 1;done&quot;
         ...çœç•¥...
</code></pre>
<h2 id="è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨"><a class="header" href="#è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨">è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨</a></h2>
<p>docker exec åœ¨æŒ‡å®šå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡å®ƒè¿›å…¥å®¹å™¨å†…éƒ¨ï¼š</p>
<pre><code class="language-sh">$ docker exec -it Hello /bin/sh
/ # ip addr |grep eth0
328: eth0@if329: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP
    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0
</code></pre>
<h2 id="åœæ­¢å®¹å™¨"><a class="header" href="#åœæ­¢å®¹å™¨">åœæ­¢å®¹å™¨</a></h2>
<p>docker stopåœæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼š</p>
<pre><code class="language-sh">$ docker stop Hello 
Hello
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                        PORTS               NAMES
cf591db9d6e9        alpine:3.9.5        &quot;/bin/sh -c 'while tâ€¦&quot;   About a minute ago   Exited (137) 55 seconds ago                       Hello
</code></pre>
<p>å®¹å™¨è¢«åœæ­¢ä¹‹åï¼Œå®¹å™¨æ–‡ä»¶ä¾ç„¶æ˜¯å­˜åœ¨çš„ã€‚</p>
<h2 id="åˆ é™¤å®¹å™¨"><a class="header" href="#åˆ é™¤å®¹å™¨">åˆ é™¤å®¹å™¨</a></h2>
<p>åˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨ï¼š</p>
<pre><code class="language-sh">$ docker rm -f Hello
</code></pre>
<p>åˆ é™¤å·²ç»é€€å‡ºçš„å®¹å™¨ï¼š </p>
<pre><code class="language-sh">$ docker rm -Hello
</code></pre>
<h2 id="ç«¯å£æ˜ å°„"><a class="header" href="#ç«¯å£æ˜ å°„">ç«¯å£æ˜ å°„</a></h2>
<p>åœ¨runçš„-P/-pçš„é€‰é¡¹, è¿™ä¸ªé€‰é¡¹å°†é•œåƒçš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç«¯å£, è¿™æ ·å°±å¯ä»¥ä»å¤–éƒ¨ä½¿ç”¨é•œåƒå†…çš„æœåŠ¡ã€‚</p>
<pre><code class="language-sh">$ docker run -idt -p 8080:80 nginx:stable
Unable to find image 'nginx:stable' locally
...çœç•¥...
</code></pre>
<p>æŸ¥çœ‹ç«¯å£æ˜ å°„æƒ…å†µï¼š</p>
<pre><code class="language-sh">$ docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED             STATUS          PORTS                  NAMES
223c0e90f378   nginx:stable   &quot;nginx -g 'daemon ofâ€¦&quot;   10 seconds ago      Up 9 seconds    0.0.0.0:8080-&gt;80/tcp   friendly_leavitt
</code></pre>
<p>è®¿é—®ç«¯å£ï¼š</p>
<pre><code class="language-sh">$ curl 127.0.0.1:8080
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</code></pre>
<h2 id="æœ¬åœ°ç›®å½•æŒ‚è½½"><a class="header" href="#æœ¬åœ°ç›®å½•æŒ‚è½½">æœ¬åœ°ç›®å½•æŒ‚è½½</a></h2>
<p>æŠŠæœ¬åœ°çš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼š</p>
<pre><code class="language-sh">$ mkdir config
$ echo aaaa &gt;config/a.conf
$ docker run -it --rm -v `pwd`/config:/tmp/ alpine:3.9.5 /bin/sh
</code></pre>
<h2 id="å‚è€ƒ-118"><a class="header" href="#å‚è€ƒ-118">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/03/29/docker-usage.html" title="dockerçš„å¸¸ç”¨æ“ä½œ">dockerçš„å¸¸ç”¨æ“ä½œ</a></li>
<li><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2017/03/22/docker-search-registry.html" title="dockeræœç´¢å…¶å®ƒregistryä¸­çš„é•œåƒ">dockeræœç´¢å…¶å®ƒregistryä¸­çš„é•œåƒ</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/05/19/docker-enter-net-from-host.html" title="ä»å®¿ä¸»æœºç›´æ¥è¿›å…¥dockerå®¹å™¨çš„ç½‘ç»œç©ºé—´">ä»å®¿ä¸»æœºç›´æ¥è¿›å…¥dockerå®¹å™¨çš„ç½‘ç»œç©ºé—´</a></li>
<li><a href="https://docs.docker.com/engine/reference/run/" title="docker command">docker command</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="docker-é•œåƒçš„ç®¡ç†"><a class="header" href="#docker-é•œåƒçš„ç®¡ç†">Docker é•œåƒçš„ç®¡ç†</a></h1>
<h2 id="æœç´¢é•œåƒ"><a class="header" href="#æœç´¢é•œåƒ">æœç´¢é•œåƒ</a></h2>
<p>docker search é»˜è®¤æœç´¢ docker hub ä¸­çš„é•œåƒï¼š</p>
<pre><code class="language-sh">$ docker search nginx
</code></pre>
<p>å¦‚æœæœç´¢å…¶å®ƒ registry ä¸­çš„é•œåƒï¼Œå¯ç”¨ä¸‹é¢çš„ <a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2017/03/22/docker-search-registry.html" title="dockeræœç´¢å…¶å®ƒregistryä¸­çš„é•œåƒ]">æ–¹æ³•</a>:</p>
<pre><code class="language-sh">docker search 192.168.1.104:5000/redis
docker search 192.168.1.104:5000/*
</code></pre>
<p>åˆ° Docker Hub ä¸Šæ‰¾é•œåƒã€æŸ¥çœ‹é•œåƒè¯¦æƒ…ï¼š<a href="https://hub.docker.com/">https://hub.docker.com </a>ã€‚</p>
<h2 id="é•œåƒçš„-tag"><a class="header" href="#é•œåƒçš„-tag">é•œåƒçš„ tag</a></h2>
<p>æ¯ä¸ªé•œåƒéƒ½æœ‰ tagï¼Œtag æ˜¯é•œåƒçš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦ä¸ºé•œåƒé‡æ–°å‘½åï¼Œç”Ÿæˆæ–°çš„ tagï¼š</p>
<pre><code class="language-sh">docker tag alpine:3.9.5 myalpine:1.0
</code></pre>
<h2 id="ä¸‹è½½é•œåƒ"><a class="header" href="#ä¸‹è½½é•œåƒ">ä¸‹è½½é•œåƒ</a></h2>
<pre><code class="language-sh">$ docker pull alpine:3.9.5
</code></pre>
<h2 id="æŸ¥çœ‹é•œåƒ"><a class="header" href="#æŸ¥çœ‹é•œåƒ">æŸ¥çœ‹é•œåƒ</a></h2>
<pre><code class="language-sh">$ docker images
REPOSITORY      TAG     IMAGE ID        CREATED       VIRTUAL SIZE
alpine         3.9.5    82f67be598eb    5 weeks ago   5.53MB
myalpine       1.0      82f67be598eb    5 weeks ago   5.53MB
</code></pre>
<p>æŸ¥çœ‹é•œåƒè¯¦æƒ…ï¼š</p>
<pre><code class="language-sh">$ docker inspect  alpine:3.9.5
</code></pre>
<h2 id="é•œåƒçš„å¯¼å…¥å¯¼å‡º"><a class="header" href="#é•œåƒçš„å¯¼å…¥å¯¼å‡º">é•œåƒçš„å¯¼å…¥å¯¼å‡º</a></h2>
<p>ç”¨ save å‘½ä»¤æŠŠé•œåƒå¯¼å‡ºåˆ°æ–‡ä»¶ä¸­ï¼š</p>
<pre><code class="language-sh">$ docker save alpine:3.9.5 -o alpine.tar

</code></pre>
<p>ç”¨ load å‘½ä»¤åŠ è½½ï¼š </p>
<pre><code class="language-sh">$ docker load -i alpine.tar
</code></pre>
<h2 id="åˆ¶ä½œæ–°é•œåƒ"><a class="header" href="#åˆ¶ä½œæ–°é•œåƒ">åˆ¶ä½œæ–°é•œåƒ</a></h2>
<p>æ–¹æ³•ä¸€ï¼šç¼–å†™ Dockerfileï¼Œä½¿ç”¨ docker build ç›´æ¥å»ºç«‹ä¸€ä¸ªé•œåƒã€‚</p>
<ul>
<li><a href="https://docs.docker.com/reference/builder">Dockerfile è¯­æ³•</a></li>
</ul>
<p><a href="https://github.com/introclass/docker-containers.git">docker-containers</a> ä¸­æä¾›ä¸å°‘å®ç”¨é•œåƒ Dockerfileï¼Œå¯ä»¥å‚è€ƒï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/docker-containers.git
</code></pre>
<p>æ–¹æ³•äºŒï¼šæŠŠç°æœ‰çš„å®¹å™¨åšæˆé•œåƒã€‚</p>
<pre><code class="language-sh">$ docker commit
Usage: docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]
Create a new image from a containers changes
  -a, --author=&quot;&quot;     Author (e.g., &quot;John Hannibal Smith &lt;hannibal@a-team.com&gt;&quot;)
  -m, --message=&quot;&quot;    Commit message
  -p, --pause=true    Pause container during commit
</code></pre>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">$ docker commit Hello myhello:latest
sha256:72c60d1495909cada678ee468171828c8fccf4b41712a96bc43017139e35568e
</code></pre>
<p>æ–¹æ³•ä¸‰ï¼šåˆ¶ä½œ BASE é•œåƒã€‚</p>
<p>å‰é¢ä¸¤ç§åšæ³•éƒ½éœ€è¦å…ˆæœ‰ä¸€ä¸ªé•œåƒï¼Œåœ¨å·²æœ‰é•œåƒçš„åŸºç¡€ä¸Šåˆ¶ä½œæ–°é•œåƒï¼Œé‚£ä¹ˆæ€æ ·å‡­ç©ºåˆ›å»ºä¸€ä¸ªé•œåƒå‘¢ï¼Ÿ</p>
<p><a href="https://docs.docker.com/develop/develop-images/baseimages/">Create a base image</a> ä»‹ç»äº†ä¸¤ç§æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">#!/usr/bin/env bash
#
# Create a base CentOS Docker image.
#
# This script is useful on systems with yum installed (e.g., building
# a CentOS image on CentOS).  See contrib/mkimage-rinse.sh for a way
# to build CentOS images on other systems.

usage() {
    cat &lt;&lt;EOOPTS
$(basename $0) [OPTIONS] &lt;name&gt;
OPTIONS:
  -y &lt;yumconf&gt;  The path to the yum config to install packages from. The
                default is /etc/yum.conf.
EOOPTS
    exit 1
}

# option defaults
yum_config=/etc/yum.conf
while getopts &quot;:y:h&quot; opt; do
    case $opt in
        y)
            yum_config=$OPTARG
            ;;
        h)
            usage
            ;;
        \?)
            echo &quot;Invalid option: -$OPTARG&quot;
            usage
            ;;
    esac
done
shift $((OPTIND - 1))
name=$1

if [[ -z $name ]]; then
    usage
fi

#--------------------

target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)

set -x

# åˆ›å»ºç³»ç»Ÿçš„å¿…é¡»çš„è®¾å¤‡æ–‡ä»¶
mkdir -m 755 &quot;$target&quot;/dev 
mknod -m 600 &quot;$target&quot;/dev/console c 5 1
mknod -m 600 &quot;$target&quot;/dev/initctl p
mknod -m 666 &quot;$target&quot;/dev/full c 1 7
mknod -m 666 &quot;$target&quot;/dev/null c 1 3
mknod -m 666 &quot;$target&quot;/dev/ptmx c 5 2
mknod -m 666 &quot;$target&quot;/dev/random c 1 8
mknod -m 666 &quot;$target&quot;/dev/tty c 5 0
mknod -m 666 &quot;$target&quot;/dev/tty0 c 4 0
mknod -m 666 &quot;$target&quot;/dev/urandom c 1 9
mknod -m 666 &quot;$target&quot;/dev/zero c 1 5

# å®‰è£…rootæ–‡ä»¶ç³»ç»Ÿ
yum -c &quot;$yum_config&quot; --installroot=&quot;$target&quot; --releasever=/ --setopt=tsflags=nodocs \
    --setopt=group_package_types=mandatory -y groupinstall Core
yum -c &quot;$yum_config&quot; --installroot=&quot;$target&quot; -y clean all

# ç½‘ç»œé…ç½®
cat &gt; &quot;$target&quot;/etc/sysconfig/network &lt;&lt;EOF
NETWORKING=yes
HOSTNAME=localhost.localdomain
EOF

# åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶
# effectively: febootstrap-minimize --keep-zoneinfo --keep-rpmdb
# --keep-services &quot;$target&quot;.  Stolen from mkimage-rinse.sh
#  locales
rm -rf &quot;$target&quot;/usr/{lib,share}/locale,{lib,lib64}/gconv,bin/localedef,sbin/build-locale-archive}
#  docs
rm -rf &quot;$target&quot;/usr/share/{man,doc,info,gnome/help}
#  cracklib
rm -rf &quot;$target&quot;/usr/share/cracklib
#  i18n
rm -rf &quot;$target&quot;/usr/share/i18n
#  sln
rm -rf &quot;$target&quot;/sbin/sln
#  ldconfig
rm -rf &quot;$target&quot;/etc/ld.so.cache
rm -rf &quot;$target&quot;/var/cache/ldconfig/*

version=
if [ -r &quot;$target&quot;/etc/redhat-release ]; then
    version=&quot;$(sed 's/^[^0-9\]*\([0-9.]\+\).*$/\1/' &quot;$target&quot;/etc/redhat-release)&quot;
fi

if [ -z &quot;$version&quot; ]; then
    echo &gt;&amp;2 &quot;warning: cannot autodetect OS version, using '$name' as tag&quot;
    version=$name
fi

# æ‰“åŒ…æˆé•œåƒï¼Œ é•œåƒåæ˜¯$name, tagæ˜¯$version
tar --numeric-owner -c -C &quot;$target&quot; . | docker import - $name:$version

# è¿è¡Œæ–°å»ºç«‹çš„é•œåƒ
docker run -i -t $name:$version echo success

rm -rf &quot;$target&quot;
</code></pre>
<h2 id="å‘å¸ƒé•œåƒ"><a class="header" href="#å‘å¸ƒé•œåƒ">å‘å¸ƒé•œåƒ</a></h2>
<p>å°†é•œåƒæäº¤åˆ°é•œåƒä¸­å¿ƒ</p>
<pre><code class="language-sh">$ docker push æœ¬åœ°çš„é•œåƒå:é•œåƒæ ‡ç­¾
</code></pre>
<h2 id="é•œåƒçš„æœ¬åœ°å­˜æ”¾"><a class="header" href="#é•œåƒçš„æœ¬åœ°å­˜æ”¾">é•œåƒçš„æœ¬åœ°å­˜æ”¾</a></h2>
<p><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2020/02/08/docker-image-manager.html">Docker é•œåƒç®¡ç†ï¼ˆä¸€ï¼‰ï¼šæœ¬åœ°é•œåƒã€æœ¬åœ°å®¹å™¨çš„æ–‡ä»¶å­˜æ”¾ç›®å½•</a></p>
<h2 id="å‚è€ƒ-119"><a class="header" href="#å‚è€ƒ-119">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="docker-åŸç†ä¸å®¹å™¨æ–‡ä»¶è®²è§£"><a class="header" href="#docker-åŸç†ä¸å®¹å™¨æ–‡ä»¶è®²è§£">Docker åŸç†ä¸å®¹å™¨æ–‡ä»¶è®²è§£</a></h1>
<h2 id="docker-çš„åŸºæœ¬åŸç†"><a class="header" href="#docker-çš„åŸºæœ¬åŸç†">Docker çš„åŸºæœ¬åŸç†</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2015/02/25/%E4%B8%80%E4%B8%AA%E6%9C%80%E7%AE%80%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0.html">ä¸€ä¸ªæœ€ç®€å®¹å™¨çš„å®ç°</a></li>
</ul>
<h2 id="docker-é•œåƒæ–‡ä»¶çš„æœ¬åœ°ç®¡ç†"><a class="header" href="#docker-é•œåƒæ–‡ä»¶çš„æœ¬åœ°ç®¡ç†">Docker é•œåƒæ–‡ä»¶çš„æœ¬åœ°ç®¡ç†</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2020/02/08/docker-image-manager.html">æœ¬åœ°é•œåƒã€æœ¬åœ°å®¹å™¨çš„æ–‡ä»¶å­˜æ”¾ç›®å½•</a></li>
</ul>
<h2 id="æ›´å¤šç¬”è®°"><a class="header" href="#æ›´å¤šç¬”è®°">æ›´å¤šç¬”è®°</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/tags/all.html#docker">æ›´å¤š Doceker ç¬”è®°</a></li>
</ul>
<h2 id="å‚è€ƒ-120"><a class="header" href="#å‚è€ƒ-120">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç”¨-docker-compose-æé«˜-docker-ä½¿ç”¨æ•ˆç‡"><a class="header" href="#ç”¨-docker-compose-æé«˜-docker-ä½¿ç”¨æ•ˆç‡">ç”¨ docker-compose æé«˜ docker ä½¿ç”¨æ•ˆç‡</a></h1>
<ul>
<li><a href="https://docs.docker.com/compose/compose-file/" title="docker compose file">docker compose file</a></li>
<li><a href="https://docs.docker.com/compose/reference/overview/" title="docker-compose cli">docker-compose cli</a></li>
</ul>
<p><a href="https://github.com/introclass/docker-compose-files" title="doker-compose-files">doker-compose-files</a> ä¸­ä¼šæŒç»­æ”¶é›†ä¸€äº›å¸¸ç”¨çš„ compose æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">git clone https://github.com/introclass/docker-compose-files.git
</code></pre>
<h2 id="å‚è€ƒ-121"><a class="header" href="#å‚è€ƒ-121">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="mysql-çš„å¸¸è§„ä½¿ç”¨"><a class="header" href="#mysql-çš„å¸¸è§„ä½¿ç”¨">MySQL çš„å¸¸è§„ä½¿ç”¨</a></h1>
<p>MySQL è¢« Oracle æ”¶è´­åï¼Œåˆ†å‰æˆäº†éš¶å± Oracle çš„ MySQL åˆ†æ”¯ï¼Œå’Œç¤¾åŒºç»´æŠ¤çš„ MariaDB åˆ†æ”¯ã€‚åœ¨ CentOS ç­‰å¼€æºç³»ç»Ÿä¸Šï¼Œç°åœ¨é€šå¸¸é»˜è®¤æä¾›çš„æ˜¯ MariaDBã€‚</p>
<h2 id="mariadb-docker-é•œåƒçš„ä½¿ç”¨"><a class="header" href="#mariadb-docker-é•œåƒçš„ä½¿ç”¨">MariaDB Docker é•œåƒçš„ä½¿ç”¨</a></h2>
<p>Docker ç¤¾åŒºç»´æŠ¤äº†ä¸€ä¸ª mariadb é•œåƒï¼š</p>
<pre><code class="language-sh">$ docker search mariadb
NAME                                   DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
mariadb                                MariaDB is a community-developed fork of MySâ€¦   3263                [OK]
</code></pre>
<p>é•œåƒçš„ä½¿ç”¨æ–¹æ³•è§ <a href="https://hub.docker.com/_/mariadb/" title="MariaDB Image Usage">mariadb image usage</a>ï¼Œé•œåƒæ„å»ºæ–‡ä»¶è§ <a href="https://github.com/docker-library/mariadb" title="docker-library/mariadb">docker-library/mariadb</a>ã€‚ </p>
<p>ä¸‹é¢ä»¥ mariadb:10.4.1 ä¸ºä¾‹ï¼š</p>
<pre><code class="language-sh">$ docker push mariadb:10.4.1
</code></pre>
<h3 id="é•œåƒçš„ç¯å¢ƒå˜é‡"><a class="header" href="#é•œåƒçš„ç¯å¢ƒå˜é‡">é•œåƒçš„ç¯å¢ƒå˜é‡</a></h3>
<pre><code class="language-sh">MYSQL_ROOT_PASSWORD            # root å¯†ç 
MYSQL_DATABASE                 # å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ª database
MYSQL_USER, MYSQL_PASSWORD     # å¯åŠ¨æ—¶å¢åŠ ä¸€ä¸ªç‰¹æƒç”¨æˆ·
MYSQL_ALLOW_EMPTY_PASSWORD     # å…è®¸ç©ºå¯†ç  
MYSQL_RANDOM_ROOT_PASSWORD     # éšæœºç”Ÿæˆ root å¯†ç 
</code></pre>
<h3 id="é•œåƒçš„å…³é”®ç›®å½•"><a class="header" href="#é•œåƒçš„å…³é”®ç›®å½•">é•œåƒçš„å…³é”®ç›®å½•</a></h3>
<p><strong>/docker-entrypoint-initdb.d</strong> ï¼šé•œåƒå¯åŠ¨æ—¶ä¼šæ ¹æ®ä¸Šé¢çš„ç¯å¢ƒå˜é‡ï¼Œå®Œæˆæ•°æ®åº“ã€ç”¨æˆ·å’Œå¯†ç åï¼Œç„¶åæ‰§è¡Œè¯¥ç›®å½•ä¸­ <code>.sh</code>ã€<code>.sql</code>ã€<code>.sql.gz</code> æ–‡ä»¶ï¼Œå¯ä»¥æŠŠåˆå§‹åŒ–è„šæ­¥æŒ‚è½½åˆ°è¿™ä¸ªç›®å½•ä¸­ï¼ŒæŒ‰ç…§æ–‡ä»¶åç§°æ’åºæ‰§è¡Œã€‚</p>
<blockquote>
<p>ç‰¹åˆ«æ³¨æ„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œ/var/lib/mysql ç›®å½•ä¸ºç©ºçš„æ—¶å€™æ‰ä¼šåŠ è½½æ‰§è¡Œã€‚</p>
</blockquote>
<p><strong>/var/lib/mysql</strong>ï¼šæ•°æ®åº“æ–‡ä»¶çš„ç›®å½•ã€‚</p>
<p><strong>/etc/mysql/my.cnf</strong>ï¼šæ•°æ®åº“çš„é…ç½®æ–‡ä»¶ã€‚</p>
<p><strong>/etc/mysql/conf.d</strong>ï¼šé»˜è®¤çš„ my.cnf æ–‡ä»¶çš„é…ç½®åŠ è½½ç›®å½•ã€‚</p>
<h3 id="é•œåƒçš„å‘½ä»¤è¡Œå‚æ•°"><a class="header" href="#é•œåƒçš„å‘½ä»¤è¡Œå‚æ•°">é•œåƒçš„å‘½ä»¤è¡Œå‚æ•°</a></h3>
<pre><code class="language-sh">$ docker run -it --rm mariadb:10.4.1 --verbose --help
</code></pre>
<h3 id="é•œåƒçš„ä½¿ç”¨ç¤ºèŒƒ"><a class="header" href="#é•œåƒçš„ä½¿ç”¨ç¤ºèŒƒ">é•œåƒçš„ä½¿ç”¨ç¤ºèŒƒ</a></h3>
<p>Docker Compose å¯åŠ¨ï¼š</p>
<pre><code class="language-yaml">version: &quot;3&quot;
services:
  mysql:
    image: mariadb:10.4.1
    environment:
      - TZ=CST-8
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=testdb
      - MYSQL_USER=testdb
      - MYSQL_PASSWORD=testdb
    volumes:
      #æœ¬åœ°æ–‡ä»¶ç›®å½•
      - ./data/mysql:/var/lib/mysql
      - ./conf/sql:/docker-entrypoint-initdb.d
    ports:
      - &quot;13306:3306&quot;
</code></pre>
<p>æ‰§è¡Œ sql:</p>
<pre><code class="language-sh">$ mysql -u testdb -ptestdb -h 127.0.0.1 -P 3306 -D testdb&lt; ./sql/insert.sql
</code></pre>
<p>æˆ–è€…ï¼š</p>
<pre><code class="language-sh">$ docker exec -i mysql sh -c 'exec mysql -utestdb -ptestdb -D testdb' &lt; ./sql/insert.sql
</code></pre>
<p>å¯¼å‡ºæ•°æ®ï¼ˆåªå¯¼å‡ºè¡¨ç»“æ„ -dï¼Œåªå¯¼è¡¨æ•°æ® -tï¼‰ï¼š</p>
<pre><code class="language-sh">$ docker exec mysql sh -c 'exec mysqldump -utestdb -ptestdb testdb'  &gt;backup.sql
</code></pre>
<p>æ•°æ®é‡æ–°åŠ è½½æ–¹æ³•å’Œæ‰§è¡Œ sql ç›¸åŒã€‚</p>
<h2 id="å‚è€ƒ-122"><a class="header" href="#å‚è€ƒ-122">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://github.com/docker-library/mariadb" title="docker-library/mariadb">docker-library/mariadb</a></li>
<li><a href="https://hub.docker.com/_/mariadb/" title="MariaDB Image Usage">MariaDB Image Usage</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#git-ä½¿ç”¨æ‰‹å†Œ">Git ä½¿ç”¨æ‰‹å†Œ</a></h1>
<p>è¿™é‡Œæ˜¯å¯¹ <a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/04/01/git.html" title="Gitä½¿ç”¨æ‰‹å†Œ">Gitä½¿ç”¨æ‰‹å†Œ</a> çš„è¿›ä¸€æ­¥æ•´ç†ï¼Œå°†å†…å®¹åˆ†ç« èŠ‚å±•ç¤ºã€‚</p>
<p>æäº¤å‰çš„å‡†å¤‡ rebase æ“ä½œå’Œè·¨è¶Šå¤šä¸ª repo æäº¤çš„ä»£ç æ–¹æ³•å•ç‹¬åˆ—å‡ºï¼š</p>
<ul>
<li><a href="git/./rebase.html">æäº¤å‡†å¤‡ rebase</a></li>
<li><a href="git/./repo-cross.html">è·¨è¶Šå¤šä¸ª repo</a> </li>
</ul>
<h2 id="å¸¸ç”¨æ“ä½œ"><a class="header" href="#å¸¸ç”¨æ“ä½œ">å¸¸ç”¨æ“ä½œ</a></h2>
<ul>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/04/01/git.html" title="Gitä½¿ç”¨æ‰‹å†Œ">Gitä½¿ç”¨æ‰‹å†Œ</a></li>
</ul>
<h2 id="å‚è€ƒ-123"><a class="header" href="#å‚è€ƒ-123">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="git-çš„-rebase-æ“ä½œcommit-å›æ”¾"><a class="header" href="#git-çš„-rebase-æ“ä½œcommit-å›æ”¾">Git çš„ rebase æ“ä½œï¼ˆcommit å›æ”¾ï¼‰</a></h1>
<p>rebase å‘½ä»¤å°†å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šçš„ä¿®æ”¹åŒæ­¥åˆ°å½“å‰åˆ†æ”¯ï¼Œä½†æ˜¯å’Œ merge ä¸åŒï¼Œrebase ä¿®æ”¹çš„å½“å‰åˆ†æ”¯çš„ commit ä¹‹å‰çš„å†…å®¹ã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜ï¼š</p>
<ol>
<li>åŸå§‹åˆ†æ”¯ A</li>
<li>åŸºäº A åˆ›å»ºäº†åˆ†æ”¯ B</li>
<li>åˆ†æ”¯ A ä½œäº†ä¸€æ¬¡æäº¤ c1ï¼Œåˆ†æ”¯ B ä½œäº†ä¸€æ¬¡æäº¤ c2</li>
<li>åŸºäº A å¯¹äº B åˆ†æ”¯è¿›è¡Œ rebase åï¼Œåˆ†æ”¯ B ä¸­çš„æäº¤è®°å½•å˜æˆ  c1 c2</li>
</ol>
<p>æ‰§è¡Œ rebase åï¼ŒB åˆ†æ”¯çš„å†…å®¹ç­‰åŒäºå°† B åˆ†æ”¯ä¸Šçš„ä¿®æ”¹åœ¨ A åˆ†æ”¯ä¸Šé‡æ”¾ã€‚</p>
<p><strong>rebase ä¼šæ”¹å˜å½“å‰åˆ†æ”¯ä¸­çš„ commit idï¼Œé€šå¸¸åœ¨ push ä¹‹å‰æ‰§è¡Œ rebase æ“ä½œ</strong></p>
<h2 id="rebase-çš„å‘½ä»¤å‚æ•°"><a class="header" href="#rebase-çš„å‘½ä»¤å‚æ•°">rebase çš„å‘½ä»¤å‚æ•°</a></h2>
<p>rebase çš„å‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">NAME
       git-rebase - Reapply commits on top of another base tip

SYNOPSIS
       git rebase [-i | --interactive] [&lt;options&gt;] [--exec &lt;cmd&gt;] [--onto &lt;newbase&gt;]
               [&lt;upstream&gt; [&lt;branch&gt;]]
       git rebase [-i | --interactive] [&lt;options&gt;] [--exec &lt;cmd&gt;] [--onto &lt;newbase&gt;]
               --root [&lt;branch&gt;]
       git rebase --continue | --skip | --abort | --quit | --edit-todo | --show-current-patch
</code></pre>
<p>å¦‚æœä¸æŒ‡å®š branchï¼Œé»˜è®¤å¯¹å½“å‰åˆ†æ”¯è¿›è¡Œ rebaseï¼Œå¦‚æœæŒ‡å®šäº† branchï¼Œå…ˆåˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯ï¼Œå† rebaseã€‚</p>
<h2 id="åŸºäº-tag-è¿›è¡Œ-rebase"><a class="header" href="#åŸºäº-tag-è¿›è¡Œ-rebase">åŸºäº tag è¿›è¡Œ rebase</a></h2>
<p><code>--onto</code> æŒ‡å®š rebase å›æ”¾æ“ä½œçš„å¼€å§‹ä½ç½®ï¼Œè­¬å¦‚ A åˆ†æ”¯ä¸Šæœ‰ b1 b2 c1 ä¸‰ä¸ª commitï¼Œ<code>--onto b2</code> æŒ‡å®šåœ¨ A åˆ†æ”¯çš„ b2 ä½ç½®å›æ”¾å½“å‰åˆ†æ”¯çš„ commitã€‚æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªå‚æ•°è¿›è¡ŒåŸºäº tag è¿›è¡Œå›æ”¾ã€‚</p>
<p>å¦‚æœä¸ä½¿ç”¨ --ontoï¼Œé»˜è®¤åœ¨ A åˆ†æ”¯æœ€æ–°çš„ commit ä¸Šè¿›è¡Œå›æ”¾ï¼Œæœ€å¸¸é‡åˆ°çš„æƒ…å†µæ˜¯ A åˆ†æ”¯ä¸Šæ—¢æœ‰ release tag ä¹‹å‰çš„ commitï¼Œä¹Ÿæœ‰ä¹‹åçš„ commitï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦åœ¨ release tag çš„åŸºç¡€ä¸Šå›æ”¾ï¼Œæš‚æ—¶ä¸å¼•ç”¨æœª release çš„ commitã€‚</p>
<pre><code class="language-sh">git rebase upstream/master --onto nginx-0.25.1
</code></pre>
<p>upstream/master ä¸­çš„ upstream æ˜¯è¿œç¨‹ä»“åº“ï¼Œä¸Šé¢çš„å‘½ä»¤è¡¨ç¤ºåœ¨ upstream ä¸­çš„ master åˆ†æ”¯çš„  nginx-0.25.1  tag ä¸Šå›æ”¾å½“å‰åˆ†æ”¯ä¸­çš„ commitã€‚æŸ¥çœ‹è¿œç¨‹ä»“åº“çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">git remote -v
origin	http://gitlab.XXXXX.cn/infrastructure/ingress-nginx.git (fetch)
origin	http://gitlab.XXXXX.cn/infrastructure/ingress-nginx.git (push)
upstream	https://github.com/kubernetes/ingress-nginx.git (fetch)
upstream	https://github.com/kubernetes/ingress-nginx.git (push)
</code></pre>
<p><a href="https://stackoverflow.com/questions/39768124/git-rebase-onto-a-tag-when-master-and-a-branch-is-ahead-of-the-current-commits" title="Git rebase onto a tag when master and a branch is ahead of the current commits">Git rebase onto a tag when master and a branch is ahead of the current commits</a> ä¸­è®¨è®ºäº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="å¦‚æœ-rebase-è¿‡ç¨‹å‡ºç°å†²çª"><a class="header" href="#å¦‚æœ-rebase-è¿‡ç¨‹å‡ºç°å†²çª">å¦‚æœ rebase è¿‡ç¨‹å‡ºç°å†²çª</a></h2>
<p>ç”¨ git status æŸ¥çœ‹å†²çªæ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ git status
rebase in progress; onto 5179893a9
You are currently rebasing branch 'nginx-0.25.0-fp' on '5179893a9'.
  (fix conflicts and then run &quot;git rebase --continue&quot;)
  (use &quot;git rebase --skip&quot; to skip this patch)
  (use &quot;git rebase --abort&quot; to check out the original branch)

Unmerged paths:
  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)
  (use &quot;git add &lt;file&gt;...&quot; to mark resolution)

	both modified:   Makefile

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
</code></pre>
<p>ä¿®æ”¹å†²çªæ–‡ä»¶ï¼Œå¹¶æäº¤ï¼Œç„¶åç»§ç»­ rebase ï¼ˆgit rebase --continueï¼‰ï¼š</p>
<pre><code class="language-sh">Resolve all conflicts manually, mark them as resolved with
&quot;git add/rm &lt;conflicted_files&gt;&quot;, then run &quot;git rebase --continue&quot;.
You can instead skip this commit: run &quot;git rebase --skip&quot;.
To abort and get back to the state before &quot;git rebase&quot;, run &quot;git rebase --abort&quot;.
</code></pre>
<h2 id="å‚è€ƒ-124"><a class="header" href="#å‚è€ƒ-124">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="git-è·¨-repo-æ“ä½œ"><a class="header" href="#git-è·¨-repo-æ“ä½œ">git è·¨ repo æ“ä½œ</a></h1>
<p>å¦‚æœä½¿ç”¨äº†ä¸€ä¸ªå¼€æºçš„é¡¹ç›®ï¼Œå¹¶ä¸”åŸºäºè¿™ä¸ªé¡¹ç›®å¼€å‘äº†è‡ªå·±çš„åˆ†æ”¯ï¼ŒåŒæ—¶åˆå¸Œæœ›æŠŠæ”¹åŠ¨åé¦ˆåˆ°ç¤¾åŒºï¼Œå°±ä¼šé‡åˆ°åœ¨è·¨ repo æ“ä½œçš„é—®é¢˜ã€‚</p>
<h2 id="å°†-github-é¡¹ç›®å¯¼å…¥-gitlab"><a class="header" href="#å°†-github-é¡¹ç›®å¯¼å…¥-gitlab">å°† github é¡¹ç›®å¯¼å…¥ gitlab</a></h2>
<p>ä½¿ç”¨å¼€æºé¡¹ç›®ï¼Œé€šå¸¸éœ€è¦æŠŠå¼€æºé¡¹ç›®å¯¼å…¥åˆ°è‡ªå·±å…¬å¸çš„ git ï¼Œæ“ä½œæ–¹æ³•è§ <a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/04/01/git.html#%E8%B7%A8%E6%89%98%E7%AE%A1%E5%B9%B3%E5%8F%B0%E5%8D%8F%E4%BD%9C%E5%B0%86github%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5gitlab" title="å°†githubé¡¹ç›®å¯¼å…¥gitlab">å°†githubé¡¹ç›®å¯¼å…¥gitlab</a>ã€‚</p>
<p>è¿™é‡Œçš„ç¤ºä¾‹æƒ…å†µå¦‚ä¸‹ï¼Œorigin æ˜¯å…¬å¸ç§æœ‰çš„ repoï¼Œupstream æ˜¯å¼€æºç¤¾åŒºçš„ repoï¼š</p>
<pre><code class="language-sh">$ git remote -v
origin      http://gitlab.xxxx.cn/infrastructure/ingress-nginx.git (fetch)
origin      http://gitlab.xxxx.cn/infrastructure/ingress-nginx.git (push)
upstream    https://github.com/kubernetes/ingress-nginx.git (fetch)
upstream    https://github.com/kubernetes/ingress-nginx.git (push)
</code></pre>
<h2 id="æ·»åŠ å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“"><a class="header" href="#æ·»åŠ å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“">æ·»åŠ å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“</a></h2>
<p>å¦‚æœè¦æŠŠæ”¹åŠ¨è´¡çŒ®ç»™å¼€æºç¤¾åŒºï¼Œéœ€è¦åœ¨ github ä¸Š fork åŸå§‹é¡¹ç›®ï¼Œé€šè¿‡è¿™ä¸ª fork çš„ repo æäº¤ prã€‚</p>
<p>å°† fork çš„ repoï¼Œä½œä¸ºè¿œç¨‹ä»“åº“åŠ å…¥ï¼š</p>
<pre><code class="language-sh">git remote add lijiaocn https://github.com/lijiaocn/ingress-nginx.git 
</code></pre>
<p>åŠ å…¥åï¼Œä¸€å…±æœ‰ä¸‰ä¸ªè¿œç¨‹ä»“åº“ï¼Œåˆ†åˆ«æ˜¯ github ä¸Šçš„ fork åˆ†æ”¯ï¼ˆlijiaocnï¼‰ã€åŸå§‹çš„é¡¹ç›®ï¼ˆupstreamï¼‰ã€å…¬å¸ç§æœ‰åˆ†æ”¯ï¼ˆoriginï¼‰ï¼š</p>
<pre><code class="language-sh">$ git remote -v
lijiaocn    https://github.com/lijiaocn/ingress-nginx.git (fetch)
lijiaocn    https://github.com/lijiaocn/ingress-nginx.git (push)
upstream    https://github.com/kubernetes/ingress-nginx.git (fetch)
upstream    https://github.com/kubernetes/ingress-nginx.git (push)
origin      http://gitlab.xxxx.cn/infrastructure/ingress-nginx.git (fetch)
origin      http://gitlab.xxxx.cn/infrastructure/ingress-nginx.git (push)
</code></pre>
<p>æ·»åŠ ä¹‹åï¼Œè¿˜è¦æŠŠæ–°çš„è¿œç¨‹ä»“åº“çš„å†…å®¹æ‹‰å–åˆ°æœ¬åœ°ï¼š</p>
<pre><code class="language-sh">$ git fetch lijiaocn
</code></pre>
<p>ç„¶åæ‰èƒ½å¤Ÿçœ‹åˆ°æ–°è¿œç¨‹ä»“åº“ lijiaocn ä¸­çš„åˆ†æ”¯ï¼š</p>
<pre><code class="language-sh">$ git branch -r
  lijiaocn/gh-pages
  lijiaocn/master
  upstream/HEAD -&gt; upstream/master
  upstream/gh-pages
  upstream/master
</code></pre>
<h2 id="åˆ›å»ºè·Ÿè¸ªå¦ä¸€ä¸ªè¿œç¨‹ä»“åº“çš„åˆ†æ”¯"><a class="header" href="#åˆ›å»ºè·Ÿè¸ªå¦ä¸€ä¸ªè¿œç¨‹ä»“åº“çš„åˆ†æ”¯">åˆ›å»ºè·Ÿè¸ªå¦ä¸€ä¸ªè¿œç¨‹ä»“åº“çš„åˆ†æ”¯</a></h2>
<pre><code class="language-sh">$ git branch lijiaocn_master lijiaocn/master
$ git branch -u lijiaocn/master lijiaocn_master ï¼ˆä¸æ˜¯å¿…é¡»ï¼‰
$ git branch -vv
  lijiaocn_master 846ff0036 [lijiaocn/master: ahead 167] Merge pull request #4560 from Shopify/basic-auth-map
* master          846ff0036 [origin/master: ahead 165] Merge pull request #4560 from Shopify/basic-auth-map
</code></pre>
<h2 id="å°†è¿œç¨‹ä»“åº“-a-ä¸­çš„æ›´æ–°-rebase-åˆ°è¿œç¨‹ä»“åº“-b-ä¸­"><a class="header" href="#å°†è¿œç¨‹ä»“åº“-a-ä¸­çš„æ›´æ–°-rebase-åˆ°è¿œç¨‹ä»“åº“-b-ä¸­">å°†è¿œç¨‹ä»“åº“ A ä¸­çš„æ›´æ–° rebase åˆ°è¿œç¨‹ä»“åº“ B ä¸­</a></h2>
<p>è¿™é‡Œå°†è¿œç¨‹ä»“åº“ upstream ä¸­çš„æ›´æ–°åŒæ­¥åˆ° lijiaocn_master åˆ†æ”¯ä¸­ï¼š</p>
<pre><code class="language-sh">$ git remote -v
lijiaocn    https://github.com/lijiaocn/ingress-nginx.git (fetch)
lijiaocn    https://github.com/lijiaocn/ingress-nginx.git (push)
upstream    https://github.com/kubernetes/ingress-nginx.git (fetch)
upstream    https://github.com/kubernetes/ingress-nginx.git (push)
</code></pre>
<p>é‡‡ç”¨ rebase çš„æ–¹å¼ï¼Œåˆå¹¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ git fetch upstream    # å°† upstream çš„æ›´æ–°åŒæ­¥åˆ°æœ¬åœ°
$ git rebase upstream/master lijiaocn_master
</code></pre>
<h2 id="å°†å¦ä¸€ä¸ªåˆ†æ”¯ä¸­çš„ç‰¹å®š-commit-æäº¤åˆ°å½“å‰åˆ†æ”¯"><a class="header" href="#å°†å¦ä¸€ä¸ªåˆ†æ”¯ä¸­çš„ç‰¹å®š-commit-æäº¤åˆ°å½“å‰åˆ†æ”¯">å°†å¦ä¸€ä¸ªåˆ†æ”¯ä¸­çš„ç‰¹å®š commit æäº¤åˆ°å½“å‰åˆ†æ”¯</a></h2>
<pre><code class="language-sh">$ git checkout lijiaocn_master
$ git cherry-pick 800e5fe9dc852fb0 ï¼ˆ800..æ˜¯å¦ä¸€ä¸ªåˆ†æ”¯ä¸­çš„ commitï¼‰
</code></pre>
<h2 id="å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“çš„-master-ä¸­"><a class="header" href="#å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“çš„-master-ä¸­">å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“çš„ master ä¸­</a></h2>
<pre><code class="language-sh">$ git checkout lijiaocn_master
...è¿›è¡Œäº†ä¸€äº›æ”¹åŠ¨ ...
$ git commit -s -m &quot;æäº¤...&quot;
$ git push -u lijiaocn HEAD:master     # æ¨é€åˆ°è¿œç¨‹ä»“åº“ lijiaocn çš„ master åˆ†æ”¯ä¸­
</code></pre>
<h2 id="å‚è€ƒ-125"><a class="header" href="#å‚è€ƒ-125">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxé—®é¢˜åˆ†æä¸æ€§èƒ½ä¼˜åŒ–"><a class="header" href="#linuxé—®é¢˜åˆ†æä¸æ€§èƒ½ä¼˜åŒ–">Linuxé—®é¢˜åˆ†æä¸æ€§èƒ½ä¼˜åŒ–</a></h1>
<p>ä¸ªäººå­¦ä¹ ç¬”è®°ï¼Œè®°å½•Linuxç›¸å…³çš„çŸ¥è¯†ï¼Œæ€§èƒ½ä¼˜åŒ–éƒ¨åˆ†çš„å†…å®¹ä¸»è¦æ¥è‡ªæå®¢æ—¶é—´å‡ºå“çš„å€ªé¹é£ä¸“æ ã€ŠLinuxæ€§èƒ½ä¼˜åŒ–ã€‹ã€‚è¿™é‡Œä½¿ç”¨çš„æ“ä½œç³»ç»Ÿæ˜¯CentOSï¼Œç´¢å¼•äº†å¤§é‡å‚è€ƒèµ„æ–™ï¼Œä¸ºäº†èƒ½å¤ŸæŸ¥çœ‹å†…æ ¸æ–‡æ¡£ï¼Œéœ€è¦åœ¨ç³»ç»Ÿä¸Šå®‰è£…man-pagesï¼š</p>
<pre><code>yum install -y man-pages
</code></pre>
<p>å€ªæœ‹é£ä¸“æ ã€ŠLinuxæ€§èƒ½ä¼˜åŒ–ã€‹ï¼š</p>
<p><span style="display:block;text-align:center"><img src="linux//img/linux/01-geek-linux-ercode.jpeg" width="250px" alt="æå®¢æ—¶é—´å€ªé¹é£Linuxæ€§èƒ½ä¼˜åŒ–æµ·æŠ¥"/></span></p>
<h2 id="æ’æŸ¥é¡ºåº"><a class="header" href="#æ’æŸ¥é¡ºåº">æ’æŸ¥é¡ºåº</a></h2>
<p>æ•´ä½“æƒ…å†µï¼š</p>
<ol>
<li><code>top/htop/atop</code>å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹/çº¿ç¨‹ã€CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ<a href="linux/../chapter1/cpu-usage-analysis.html">CPUä½¿ç”¨æƒ…å†µ</a>ï¼›</li>
<li><code>dstat 2</code>æŸ¥çœ‹CPUã€ç£ç›˜IOã€ç½‘ç»œIOã€æ¢é¡µã€ä¸­æ–­ã€åˆ‡æ¢ï¼Œ<a href="linux/../chapter3/process_sys_io.html">ç³»ç»ŸI/OçŠ¶æ€</a>;</li>
<li><code>vmstat 2</code>æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ<a href="linux/../chapter1/memory-stat.html">å†…å­˜çŠ¶æ€</a>ï¼›</li>
<li><code>iostat -d -x 2</code>æŸ¥çœ‹æ‰€æœ‰ç£ç›˜çš„IOæƒ…å†µï¼Œ<a href="linux/../chapter3/process_sys_io.html">ç³»ç»ŸI/OçŠ¶æ€</a>ï¼›</li>
<li><code>iotop</code>æŸ¥çœ‹IOé å‰çš„è¿›ç¨‹ï¼Œ<a href="linux/../chapter3/process_sys_io.html">ç³»ç»Ÿçš„I/OçŠ¶æ€</a>ï¼›</li>
<li><code>perf top</code>æŸ¥çœ‹å ç”¨CPUæœ€å¤šçš„å‡½æ•°ï¼Œ<a href="linux/../chapter1/cpu-usage-analysis.html">CPUä½¿ç”¨æƒ…å†µ</a>ï¼›</li>
<li><code>perf record -ag -- sleep 15;perf report</code>æŸ¥çœ‹CPUäº‹ä»¶å æ¯”ï¼Œ<a href="linux/../chapter1/cpu-usage-analysis.html">CPUä½¿ç”¨æƒ…å†µ</a>ï¼›</li>
<li><code>sar -n DEV 2</code>æŸ¥çœ‹ç½‘å¡çš„ååï¼Œ<a href="linux/../chapter1/network-nic-stat.html">ç½‘å¡çŠ¶æ€</a>ï¼›</li>
<li><code>/usr/share/bcc/tools/filetop -C</code>æŸ¥çœ‹æ¯ä¸ªæ–‡ä»¶çš„è¯»å†™æƒ…å†µï¼Œ<a href="linux/../chapter3/process_sys_io.html">ç³»ç»Ÿçš„I/OçŠ¶æ€</a>ï¼›</li>
<li><code>/usr/share/bcc/tools/opensnoop</code>æ˜¾ç¤ºæ­£åœ¨è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œ<a href="linux/../chapter3/process_sys_io.html">ç³»ç»Ÿçš„I/OçŠ¶æ€</a>ï¼›</li>
</ol>
<p>è¿›ç¨‹åˆ†æï¼Œ<a href="linux/../chapter1/process-resouce.html">è¿›ç¨‹å ç”¨çš„èµ„æº</a>ï¼š</p>
<ol>
<li><code>pidstat 2 -p è¿›ç¨‹å·</code>æŸ¥çœ‹å¯ç–‘è¿›ç¨‹CPUä½¿ç”¨ç‡å˜åŒ–æƒ…å†µï¼›</li>
<li><code>pidstat -w -p è¿›ç¨‹å· 2</code>æŸ¥çœ‹å¯ç–‘è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µï¼›</li>
<li><code>pidstat -d -p è¿›ç¨‹å· 2</code>æŸ¥çœ‹å¯ç–‘è¿›ç¨‹çš„IOæƒ…å†µï¼›</li>
<li><code>lsof -p è¿›ç¨‹å·</code>æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼›</li>
<li><code>strace -f -T -tt -p è¿›ç¨‹å·</code>æ˜¾ç¤ºè¿›ç¨‹å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨ï¼› </li>
</ol>
<p>åè®®æ ˆåˆ†æï¼Œ<a href="linux/../chapter1/network-stat.html">è¿æ¥/åè®®æ ˆçŠ¶æ€</a>ï¼š</p>
<ol>
<li><code>netstat -nat|awk '{print awk $NF}'|sort|uniq -c|sort -n</code>æŸ¥çœ‹è¿æ¥çŠ¶æ€åˆ†å¸ƒï¼›</li>
<li><code>ss -ntp</code>æˆ–è€…<code>netstat -ntp</code>æŸ¥çœ‹è¿æ¥é˜Ÿåˆ—ï¼›</li>
</ol>
<h2 id="æ–¹æ³•è®º"><a class="header" href="#æ–¹æ³•è®º">æ–¹æ³•è®º</a></h2>
<p>REDæ–¹æ³•ï¼šç›‘æ§æœåŠ¡çš„è¯·æ±‚æ•°ï¼ˆRateï¼‰ã€é”™è¯¯æ•°ï¼ˆErrorsï¼‰ã€å“åº”æ—¶é—´ï¼ˆDurationï¼‰ã€‚Weave Cloudåœ¨ç›‘æ§å¾®æœåŠ¡æ€§èƒ½æ—¶æå‡ºçš„æ€è·¯ã€‚</p>
<p>USEæ–¹æ³•ï¼šç›‘æ§ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ç‡ï¼ˆUtilizationï¼‰ã€é¥±å’Œåº¦ï¼ˆSaturationï¼‰ã€é”™è¯¯æ•°ï¼ˆErrorsï¼‰ã€‚</p>
<p><img src="linux/../img/linux/use-metrics.png" alt="USEæ–¹æ³•å¸¸è§æŒ‡æ ‡åˆ†ç±»" /></p>
<h2 id="æ€§èƒ½åˆ†æå·¥å…·"><a class="header" href="#æ€§èƒ½åˆ†æå·¥å…·">æ€§èƒ½åˆ†æå·¥å…·</a></h2>
<p><img src="linux/../img/linux/analyst-tool.png" alt="æ€§èƒ½åˆ†æå·¥å…·" /></p>
<h2 id="cpuåˆ†ææ€è·¯"><a class="header" href="#cpuåˆ†ææ€è·¯">CPUåˆ†ææ€è·¯</a></h2>
<p><img src="linux/../img/linux/cpu-metrics.png" alt="CPUæŒ‡æ ‡" /></p>
<p><img src="linux/../img/linux/cpu-analyst.png" alt="CPUæ€§èƒ½åˆ†æ" /></p>
<p><img src="linux/../img/linux/cpu-tools.png" alt="CPUåˆ†æå·¥å…·" /></p>
<h2 id="å†…å­˜åˆ†ææ€è·¯"><a class="header" href="#å†…å­˜åˆ†ææ€è·¯">å†…å­˜åˆ†ææ€è·¯</a></h2>
<p><img src="linux/../img/linux/memory-metrics.png" alt="å†…å­˜æ€§èƒ½æŒ‡æ ‡" /></p>
<p><img src="linux/../img/linux/cpu-analyst.png" alt="å†…å­˜æ€§èƒ½åˆ†æ" /></p>
<p><img src="linux/../img/linux/memory-tools.png" alt="å†…å­˜åˆ†æå·¥å…·" /></p>
<h2 id="ioåˆ†ææ€è·¯"><a class="header" href="#ioåˆ†ææ€è·¯">IOåˆ†ææ€è·¯</a></h2>
<p><img src="linux/../img/linux/file-io-metrics.png" alt="æ–‡ä»¶ç³»ç»ŸIOæŒ‡æ ‡" /></p>
<p><img src="linux/../img/linux/io-analyst.png" alt="IOæ€§èƒ½åˆ†æ" /></p>
<p><img src="linux/../img/linux/file-io-tools.png" alt="IOåˆ†æå·¥å…·" /></p>
<h2 id="ç½‘ç»œåˆ†ææ€è·¯"><a class="header" href="#ç½‘ç»œåˆ†ææ€è·¯">ç½‘ç»œåˆ†ææ€è·¯</a></h2>
<p><img src="linux/../img/linux/net-metrics.png" alt="ç½‘ç»œæ€§èƒ½æŒ‡æ ‡" /></p>
<p><img src="linux/../img/linux/net-analyst.png" alt="ç½‘ç»œæ€§èƒ½åˆ†æ" /></p>
<p><img src="linux/../img/linux/net-tools.png" alt="ç½‘ç»œæ€§èƒ½å·¥å…·" /></p>
<h2 id="åŸºå‡†æµ‹è¯•å·¥å…·"><a class="header" href="#åŸºå‡†æµ‹è¯•å·¥å…·">åŸºå‡†æµ‹è¯•å·¥å…·</a></h2>
<p><img src="linux/../img/linux/benchmark-tool.png" alt="åŸºå‡†æµ‹è¯•å·¥å…·" /></p>
<h2 id="å‚è€ƒ-126"><a class="header" href="#å‚è€ƒ-126">å‚è€ƒ</a></h2>
<p>ç›¸å½“ä¸€éƒ¨åˆ†å†…å®¹æ¥è‡ªæå®¢æ—¶é—´å‡ºå“çš„å€ªé¹é£ä¸“æ ã€ŠLinuxæ€§èƒ½ä¼˜åŒ–ã€‹ï¼Œæ˜¯è¿™ä¸ª<a href="linux//">ä¸“æ </a>çš„å­¦ä¹ ç¬”è®°ã€‚</p>
<p>å¦ä¸€ä»½èµ„æ–™æ˜¯IBMçº¢å®ä¹¦<a href="https://lihz1990.gitbooks.io/transoflptg/content/">Linuxæ€§èƒ½è°ƒä¼˜æŒ‡å—</a>ã€‚</p>
<p>æ­¤å¤–ï¼Œ<a href="http://tldp.org/">The Linux Documentation Project</a>æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„èµ„æ–™åº“ã€‚</p>
<p>å°†ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†ä»»åŠ¡åˆ†é…ä¸ªå¤šä¸ªCPUï¼š<a href="http://www.alexonlinux.com/smp-affinity-and-proper-interrupt-handling-in-linux">SMP affinity and proper interrupt handling in Linux</a></p>
<p><a href="https://randomascii.wordpress.com/2014/12/10/hidden-costs-of-memory-allocation/">Hidden Costs of Memory Allocation</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å½¢æˆè®¤è¯†æ¡†æ¶"><a class="header" href="#å½¢æˆè®¤è¯†æ¡†æ¶">å½¢æˆè®¤è¯†æ¡†æ¶</a></h1>
<p>è®¤è¯†æ¡†æ¶ï¼ˆä¹Ÿå°±æ˜¯çŸ¥è¯†å¤§çº²ï¼‰éå¸¸é‡è¦ï¼Œå®è§‚ä¸Šæœ‰äº†ç†è§£ä¹‹åï¼š1ï¼‰æ‰èƒ½æœ‰çš„æ”¾çŸ¢çš„æ·±å…¥ç»†èŠ‚ï¼Œå¹¶èƒ½å°†ç¹æ‚å¤šæ ·çš„ç»†èŠ‚ä¸²è”èµ·æ¥ï¼›2ï¼‰åœ¨é‡åˆ°é—®é¢˜çš„æ—¶å€™ï¼Œæ‰æœ‰èƒ½å¤Ÿæ­£ç¡®çš„æ€è€ƒï¼Œæœ‰å¤´ç»ªã€æœ‰æ–¹æ³•ã€æœ‰æ­¥éª¤çš„è°ƒæŸ¥é—®é¢˜ã€è§£å†³é—®é¢˜ã€‚</p>
<p>ä¸‹é¢è¿™å¼ å›¾æ˜¯æœ€å®è§‚çš„å›¾ç‰‡ï¼Œä»ä¸Šå¾€ä¸‹æ˜¯â€œåº”ç”¨-&gt;åº“-&gt;ç³»ç»Ÿè°ƒç”¨-&gt;å†…æ ¸-&gt;è®¾å¤‡â€ï¼Œå¦‚æœå‘ç°ä¸€ä¸ªåº”ç”¨çš„æ€§èƒ½ç‰¹åˆ«ä¸ç†æƒ³ï¼Œå¯ä»¥æŒ‰ç…§è¿™ä¸ªé¡ºåºæŸ¥æ‰¾é—®é¢˜æ‰€åœ¨ï¼Œå³å…ˆæŸ¥åº”ç”¨ã€å†æŸ¥ä¾èµ–åº“ã€ç„¶åæŸ¥ç³»ç»Ÿã€æœ€åæŸ¥ç¡¬ä»¶ã€‚</p>
<p><img src="linux/../img/linux/02-framwork-1.png" alt="å€ªé¹é£ï¼Œæå®¢æ—¶é—´ï¼ŒLinuxæ€§èƒ½ä¼˜åŒ–" />
(å›¾ç‰‡æ¥æºï¼šå€ªé¹é£ï¼Œæå®¢æ—¶é—´ï¼Œ [ã€ŠLinuxæ€§èƒ½ä¼˜åŒ–]ã€‹]<a href="https://www.lijiaocn.com/img/01-geek-linux-ercode.jpeg" title="å€ªé¹é£ï¼Œæå®¢æ—¶é—´ï¼ŒLinuxæ€§èƒ½ä¼˜åŒ–">1</a> )</p>
<p>Brendan Greggåˆ¶ä½œäº†ä¸€ä»½Linuxæ€§èƒ½å·¥å…·å›¾è°±ï¼Œè¿™äº›å·¥å…·å¯ä»¥ç”¨æ¥å®šä½å„ä¸ªæ–¹é¢çš„é—®é¢˜ï¼š</p>
<p><img src="linux/../img/linux/03-linux-performance-tools.png" alt="Linuxæ€§èƒ½å·¥å…·å›¾è°±" /></p>
<p>è¿‘å‡ å¹´æ¯”è¾ƒæµè¡Œçš„eBPFä¹Ÿæä¾›äº†å¤§é‡å·¥å…·ï¼ŒeBPFçš„ä»‹ç»è§<a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2019/02/25/ebpf-introduction-1.html">ã€ŠLinuxå†…æ ¸åŠŸèƒ½eBPFå…¥é—¨å­¦ä¹ ã€‹</a>:</p>
<p><img src="linux/../img/linux/05-bcc_tracing_tools_2017.png" alt="05-bcc_tracing_tools_2017.png" /></p>
<p>æ³¨æ„ä¸Šé¢ä¸¤å¼ å·¥å…·å›¾ä½¿ç”¨çš„<code>åˆ†ç±»æ–¹æ³•</code>ï¼ˆå›¾ç‰‡ä¸­é—´éƒ¨åˆ†ï¼‰ï¼Œè¿™ä¸ªåˆ†ç±»å°±æ˜¯æˆ‘ä»¬è¦åœ¨å¤´è„‘ä¸­å½¢æˆè®°å¿†çš„è®¤çŸ¥æ¡†æ¶ï¼Œæœ‰äº†è¿™ä¸ªè®¤çŸ¥æ¡†æ¶ä¹‹åï¼Œåœ¨é‡åˆ°æ€§èƒ½é—®é¢˜çš„æ—¶å€™æ‰ä¼šæœ‰æ¸…æ™°ã€æ˜ç¡®çš„æ’æŸ¥æ€è·¯ï¼Œä¸å†æŠ“çã€‚</p>
<p>å€ªé¹é£çš„<a href="https://www.lijiaocn.com/img/01-geek-linux-ercode.jpeg" title="å€ªé¹é£ï¼Œæå®¢æ—¶é—´ï¼ŒLinuxæ€§èƒ½ä¼˜åŒ–">Linuxæ€§èƒ½ä¼˜åŒ–</a>ä¸“æ ä¸­ç»™å‡ºçš„è¿™å¼ æ€ç»´å¯¼å›¾ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„çŸ¥è¯†æ¡†æ¶ï¼Œæ€»å…±æœ‰10éƒ¨åˆ†ï¼š<code>æ€§èƒ½ç›‘æ§</code>ã€<code>æ€§èƒ½æµ‹è¯•</code>ã€<code>åº”ç”¨ç¨‹åº</code>ã€<code>æ¶æ„è®¾è®¡</code>ã€<code>Linuxå†…æ ¸</code>ã€<code>æ–‡ä»¶ç³»ç»Ÿ</code>ã€<code>CPU</code>ã€<code>å†…å­˜</code>ã€<code>ç½‘ç»œ</code>ã€<code>ç£ç›˜</code>ã€‚</p>
<p><img src="linux/../img/linux/04-linux-performance-knowledge.png" alt="Linuxæ€§èƒ½ä¼˜åŒ–çŸ¥è¯†æ¡†æ¶" /></p>
<h2 id="å‚è€ƒ-127"><a class="header" href="#å‚è€ƒ-127">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linux-kernelç›¸å…³çŸ¥è¯†"><a class="header" href="#linux-kernelç›¸å…³çŸ¥è¯†">Linux Kernelç›¸å…³çŸ¥è¯†</a></h1>
<p>å¯¹kerneläº†è§£çš„è¶Šå¤šï¼Œæ€§èƒ½åˆ†æã€ä¼˜åŒ–å°±è¶Šé¡ºç•…ã€‚</p>
<h2 id="å‚è€ƒ-128"><a class="header" href="#å‚è€ƒ-128">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="åŠ¨æ€è¿½è¸ªæŠ€æœ¯"><a class="header" href="#åŠ¨æ€è¿½è¸ªæŠ€æœ¯">åŠ¨æ€è¿½è¸ªæŠ€æœ¯</a></h1>
<p>ä¸»è¦çš„åŠ¨æ€è¿½è¸ªå·¥å…·æœ‰ï¼šftraceã€perfã€eBPF(bcc)ã€SystemTapã€sysdigã€‚</p>
<p>è¿™é‡Œåªç®€å•æ•´ç†ä¸€ä¸‹ï¼Œä»¥ååœ¨å®è·µä¸­åŠ æ·±äº†è§£ã€‚</p>
<p><img src="linux/../img/linux/dynamic-trace-tool.png" alt="å¸¸ç”¨åŠ¨æ€è¿½è¸ªåœºæ™¯å’Œå·¥å…·" /></p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯æ–°ç‰ˆæœ¬å†…æ ¸ï¼ŒeBPFå’ŒBCCæ˜¯æœ€çµæ´»çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•ï¼Œåœ¨æ—§ç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œå› ä¸ºeBPFå—é™ï¼ŒSystemTapå’Œftraceæ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚</p>
<h2 id="ftraceä¸trace-cmd"><a class="header" href="#ftraceä¸trace-cmd">ftraceä¸trace-cmd</a></h2>
<p>ftraceé€šè¿‡debugfsæä¾›ç”¨æˆ·æ€æ¥å£ï¼Œdebugfséœ€è¦äº‹å…ˆæŒ‚è½½ï¼š</p>
<pre><code class="language-sh">mount -t debugfs nodev /sys/kernel/debug
</code></pre>
<p>debugfsä¸­æä¾›å¤šä¸ªè™šæ‹Ÿæ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">$ ls /sys/kernel/debug/tracing
README                      instances            set_ftrace_notrace  trace_marker_raw
available_events            kprobe_events        set_ftrace_pid      trace_options
...
</code></pre>
<p>ftraceç”¨èµ·æ¥æ¯”è¾ƒç¹çï¼Œtrace-cmdç®€åŒ–äº†ftraceçš„ä½¿ç”¨ï¼š</p>
<pre><code class="language-sh">yum install trace-cmd
</code></pre>
<p>trace-cmdç”¨æ³•ï¼š</p>
<pre><code class="language-sh">$ trace-cmd record -p function_graph -g do_sys_open -O funcgraph-proc ls
$ trace-cmd report
...
ls-12418 [000] 85558.075341: funcgraph_entry:              |  do_sys_open() {
ls-12418 [000] 85558.075363: funcgraph_entry:              |    getname() {
ls-12418 [000] 85558.075364: funcgraph_entry:              |      getname_flags() {
ls-12418 [000] 85558.075364: funcgraph_entry:              |        kmem_cache_alloc() {
ls-12418 [000] 85558.075365: funcgraph_entry:              |          _cond_resched() {
ls-12418 [000] 85558.075365: funcgraph_entry:   0.074 us   |            rcu_all_qs();
ls-12418 [000] 85558.075366: funcgraph_exit:    1.143 us   |          }
ls-12418 [000] 85558.075366: funcgraph_entry:   0.064 us   |          should_failslab();
ls-12418 [000] 85558.075367: funcgraph_entry:   0.075 us   |          prefetch_freepointer();
ls-12418 [000] 85558.075368: funcgraph_entry:   0.085 us   |          memcg_kmem_put_cache();
ls-12418 [000] 85558.075369: funcgraph_exit:    4.447 us   |        }
ls-12418 [000] 85558.075369: funcgraph_entry:              |        __check_object_size() {
ls-12418 [000] 85558.075370: funcgraph_entry:   0.132 us   |          __virt_addr_valid();
ls-12418 [000] 85558.075370: funcgraph_entry:   0.093 us   |          __check_heap_object();
ls-12418 [000] 85558.075371: funcgraph_entry:   0.059 us   |          check_stack_object();
ls-12418 [000] 85558.075372: funcgraph_exit:    2.323 us   |        }
ls-12418 [000] 85558.075372: funcgraph_exit:    8.411 us   |      }
ls-12418 [000] 85558.075373: funcgraph_exit:    9.195 us   |    }
...
</code></pre>
<h2 id="perf-è·Ÿè¸ªå†…æ ¸å‡½æ•°"><a class="header" href="#perf-è·Ÿè¸ªå†…æ ¸å‡½æ•°">perf è·Ÿè¸ªå†…æ ¸å‡½æ•°</a></h2>
<p>æŸ¥çœ‹perfæ”¯æŒçš„äº‹ä»¶ï¼š</p>
<pre><code class="language-sh">$ perf list

List of pre-defined events (to be used in -e):

  alignment-faults                                   [Software event]
  context-switches OR cs                             [Software event]
  cpu-clock                                          [Software event]
  cpu-migrations OR migrations                       [Software event]
  dummy                                              [Software event]
  emulation-faults                                   [Software event]
  ...
</code></pre>
<p>æ·»åŠ æ¢é’ˆï¼š</p>
<pre><code class="language-sh">$ perf probe --add do_sys_open
Added new event:
  probe:do_sys_open    (on do_sys_open)
You can now use it in all perf tools, such as:
    perf record -e probe:do_sys_open -aR sleep 1
</code></pre>
<p>ä½¿ç”¨æ¢é’ˆé‡‡æ ·ï¼š</p>
<pre><code class="language-sh">$ perf record -e probe:do_sys_open -aR sleep 10
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.148 MB perf.data (19 samples) ]
</code></pre>
<p>æŸ¥çœ‹é‡‡æ ·ç»“æœï¼š</p>
<pre><code class="language-sh">$ perf script
            perf 12886 [000] 89565.879875: probe:do_sys_open: (ffffffffa807b290)
           sleep 12889 [000] 89565.880362: probe:do_sys_open: (ffffffffa807b290)
           sleep 12889 [000] 89565.880382: probe:do_sys_open: (ffffffffa807b290)
           sleep 12889 [000] 89565.880635: probe:do_sys_open: (ffffffffa807b290)
           sleep 12889 [000] 89565.880669: probe:do_sys_open: (ffffffffa807b290)
</code></pre>
<p>æŸ¥çœ‹å†…æ ¸å‡½æ•°çš„å‚æ•°ï¼Œéœ€è¦å®‰è£…debufinfoï¼š</p>
<pre><code class="language-sh">yum --enablerepo=base-debuginfo install -y kernel-debuginfo-$(uname -r)ï¼š
</code></pre>
<pre><code class="language-sh">$ perf probe -V do_sys_open
Available variables at do_sys_open
        @&lt;do_sys_open+0&gt;
                char*   filename
                int     dfd
                int     flags
                struct open_flags       op
                umode_t mode
</code></pre>
<p>åˆ é™¤æ¢é’ˆï¼š</p>
<pre><code class="language-sh">perf probe --del probe:do_sys_open
</code></pre>
<p>æ·»åŠ å¸¦å‚æ•°çš„æ¢é’ˆï¼š</p>
<pre><code class="language-sh">$ perf probe --add 'do_sys_open filename:string'
Added new event:
  probe:do_sys_open    (on do_sys_open with filename:string)
You can now use it in all perf tools, such as:
    perf record -e probe:do_sys_open -aR sleep 1
</code></pre>
<p>é‡‡æ ·ç»“æœå°†æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-sh">$ perf script
perf 13593 [000] 91846.053622: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/proc/13596/status&quot;
  ls 13596 [000] 91846.053995: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/etc/ld.so.cache&quot;
  ls 13596 [000] 91846.054011: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;
  ls 13596 [000] 91846.054066: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/lib/x86_64-linux-gnu/libc.so.6â€
  ...
</code></pre>
<h2 id="perf-è·Ÿè¸ªé“¾æ¥åº“å‡½æ•°"><a class="header" href="#perf-è·Ÿè¸ªé“¾æ¥åº“å‡½æ•°">perf è·Ÿè¸ªé“¾æ¥åº“å‡½æ•°</a></h2>
<p>æŸ¥çœ‹æŒ‡å®šäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ-x /bin/bashï¼‰å¯ä»¥è¿½è¸ªçš„æ‰€æœ‰çš„å‡½æ•°ï¼š</p>
<pre><code class="language-sh">$ perf probe -x /bin/bash â€”funcs
</code></pre>
<p>æŸ¥çœ‹å‡½æ•°çš„å‚æ•°ï¼Œéœ€è¦å®‰è£…æœ‰å¯¹åº”çš„debuginfoï¼š</p>
<pre><code class="language-sh">$ perf probe -x /bin/bash -V readline
Available variables at readline
        @&lt;readline+0&gt;
                char*   prompt
</code></pre>
<p>ä¸º /bin/bash æ·»åŠ  readline æ¢é’ˆï¼š</p>
<pre><code class="language-sh">$ perf probe -x /bin/bash 'readline%return +0($retval):stringâ€™
</code></pre>
<p>å¼€å§‹é‡‡æ ·ï¼š</p>
<pre><code class="language-sh">$ perf record -e probe_bash:readline__return -aR sleep 5
</code></pre>
<p>æŸ¥çœ‹ç»“æœï¼š</p>
<pre><code class="language-sh">$ perf script
    bash 13348 [000] 93939.142576: probe_bash:readline__return: (5626ffac1610 &lt;- 5626ffa46739) arg1=&quot;ls&quot;
</code></pre>
<p>åˆ é™¤æ¢é’ˆ</p>
<pre><code class="language-sh">$ perf probe --del probe_bash:readline__return
</code></pre>
<h2 id="perf-trace-ä¸-trace"><a class="header" href="#perf-trace-ä¸-trace">perf trace ä¸ trace</a></h2>
<p>traceå‘½ä»¤é€šè¿‡ç³»ç»Ÿè°ƒç”¨ptraceè·å–è¿›ç¨‹çš„è°ƒç”¨ç³»ç»Ÿæƒ…å†µï¼Œå®ƒä¼šé¢‘ç¹åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€åˆ‡æ¢ï¼Œå½±å“ç›®æ ‡è¿›ç¨‹çš„æ€§èƒ½ï¼Œptraceåˆä¼šç”¨SIGSTOPä¿¡å·æŒ‚èµ·ç›®æ ‡è¿›ç¨‹ï¼Œå½±å“ç›®æ ‡è¿›ç¨‹çš„è¡Œä¸ºã€‚</p>
<p>perf traceåŸºäºå†…æ ¸äº‹ä»¶ï¼Œæ€§èƒ½è¦å¥½å¾ˆå¤šï¼š</p>
<pre><code class="language-sh">$ perf trace ls
         ? (         ): ls/14234  ... [continued]: execve()) = 0
     0.177 ( 0.013 ms): ls/14234 brk(                                                                  ) = 0x555d96be7000
     0.224 ( 0.014 ms): ls/14234 access(filename: 0xad98082                                            ) = -1 ENOENT No such file or directory
     0.248 ( 0.009 ms): ls/14234 access(filename: 0xad9add0, mode: R                                   ) = -1 ENOENT No such file or directory
     0.267 ( 0.012 ms): ls/14234 openat(dfd: CWD, filename: 0xad98428, flags: CLOEXEC                  ) = 3
     0.288 ( 0.009 ms): ls/14234 fstat(fd: 3&lt;/usr/lib/locale/C.UTF-8/LC_NAME&gt;, statbuf: 0x7ffd2015f230 ) = 0
     0.305 ( 0.011 ms): ls/14234 mmap(len: 45560, prot: READ, flags: PRIVATE, fd: 3                    ) = 0x7efe0af92000
     0.324 Dockerfile  test.sh
( 0.008 ms): ls/14234 close(fd: 3&lt;/usr/lib/locale/C.UTF-8/LC_NAME&gt;                          ) = 0
     ...
</code></pre>
<h2 id="ebpfå’Œbcc"><a class="header" href="#ebpfå’Œbcc">eBPFå’ŒBCC</a></h2>
<p>eBPFä»¥åŠBCCçš„åŸç†å’Œç”¨é€”ï¼Œä»¥åŠBCCç³»åˆ—å·¥å…·çš„ç”¨æ³•ï¼š</p>
<ol>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2019/02/25/ebpf-introduction-1.html">Linuxå†…æ ¸åŠŸèƒ½eBPFå…¥é—¨å­¦ä¹ ï¼ˆä¸€ï¼‰ï¼šBPFã€eBPFã€BCCç­‰åŸºæœ¬æ¦‚å¿µ</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2019/02/26/ebpf-introduction-2-bcc-usage.html">Linuxå†…æ ¸åŠŸèƒ½eBPFå…¥é—¨å­¦ä¹ ï¼ˆäºŒï¼‰ï¼šBCCä¸­çš„eBPFåº”ç”¨ä¸bpftraceç­‰</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial.md">BCC Tutorial</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md">BCC Python Developer Tutorial</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">BPF Features by Linux Kernel Version</a></li>
</ol>
<p><img src="linux/../img/linux/bcc-tools.png" alt="bccå·¥å…·é›†" /></p>
<p>CentOSä¸­ç”¨yumç›´æ¥å®‰è£…ï¼Œæœ‰åè®®é¢</p>
<pre><code class="language-sh">yum install bcc-tools
</code></pre>
<p>å‘½ä»¤å®‰è£…åœ¨/usr/share/bcc/tools/ä¸­ï¼š</p>
<pre><code class="language-sh">$ ls /usr/share/bcc/tools/
argdist       dbstat               javacalls       offcputime   rubyobjnew   tcplife
bashreadline  dcsnoop              javaflow        offwaketime  rubystat     tcpretrans
biolatency    dcstat               javagc          oomkill      runqlat      tcpstates
</code></pre>
<p>å¦‚æœé‡åˆ°ä¸‹é¢çš„é”™è¯¯ï¼Œè¯´æ˜å†…æ ¸ç‰ˆæœ¬å¤ªä½ï¼Œä¸æ”¯æŒç›¸å…³ç‰¹æ€§ï¼š</p>
<pre><code class="language-sh">[root@prod-k8s-node-138-127 phops]# /usr/share/bcc/tools/execsnoop
In file included from &lt;built-in&gt;:2:
/virtual/include/bcc/bpf.h:13:10: fatal error: 'linux/bpf_common.h' file not found
#include &lt;linux/bpf_common.h&gt;
         ^~~~~~~~~~~~~~~~~~~~
1 error generated.
Traceback (most recent call last):
  File &quot;/usr/share/bcc/tools/execsnoop&quot;, line 166, in &lt;module&gt;
    b = BPF(text=bpf_text)
  File &quot;/usr/lib/python2.7/site-packages/bcc/__init__.py&quot;, line 318, in __init__
    raise Exception(&quot;Failed to compile BPF text&quot;)
Exception: Failed to compile BPF text
</code></pre>
<p><a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">BPF Features by Linux Kernel Version</a>æ±‡æ€»äº†æ¯ä¸ªç‰¹æ€§éœ€è¦çš„æœ€ä½å†…æ ¸ç‰ˆæœ¬ï¼Œä¸‹å›¾æä¾›äº†éƒ¨åˆ†ä¿¡æ¯ï¼š</p>
<p><img src="linux/../img/linux/bcc-tool-version.png" alt="Linuxäº‹ä»¶å’ŒBPFæ”¯æŒ" /></p>
<p><a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md">BCC Python Developer Tutorial</a>ä¸­ä»‹ç»äº†eBPFåº”ç”¨ç¨‹åºçš„å¼€å‘æ–¹æ³•ï¼ŒæŒæ¡ä»¥åå¯ä»¥è‡ªè¡Œå¼€å‘è¿½è¸ªå·¥å…·ã€‚</p>
<h2 id="æ”¯æŒæ—§å†…æ ¸çš„systemtap"><a class="header" href="#æ”¯æŒæ—§å†…æ ¸çš„systemtap">æ”¯æŒæ—§å†…æ ¸çš„SystemTap</a></h2>
<p>å’ŒeBPFæ ¹æ¤äºå†…æ ¸ä¸åŒï¼ŒSystemTapæ˜¯ç‹¬ç«‹äºå†…æ ¸çš„ï¼Œå¹¶ä¸”åœ¨RHELç³»ç»Ÿä¸­å¥½ç”¨ï¼Œåœ¨å…¶å®ƒå‘è¡Œç‰ˆä¸Šå®¹æ˜“å‡ºç°å„ç§å¼‚å¸¸é—®é¢˜ã€‚eBPFæ˜¯æ¯”è¾ƒæ–°çš„å†…æ ¸ç‰¹æ€§ï¼Œå¯¹å†…æ ¸ç‰ˆæœ¬è¦æ±‚é«˜ï¼ŒSystemTapçš„å…ˆäºeBPFè¯ç”Ÿï¼Œæ”¯æŒ3.xç­‰æ—§ç‰ˆæœ¬çš„å†…æ ¸ã€‚</p>
<h2 id="å®¹å™¨åŠ¨æ€è¿½è¸ªsysdig"><a class="header" href="#å®¹å™¨åŠ¨æ€è¿½è¸ªsysdig">å®¹å™¨åŠ¨æ€è¿½è¸ªsysdig</a></h2>
<p><a href="https://sysdig.com/blog/sysdig-vs-dtrace-vs-strace-a-technical-discussion/">Sysdig vs DTrace vs Strace: a Technical Discussion</a></p>
<h2 id="å‚è€ƒ-129"><a class="header" href="#å‚è€ƒ-129">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cpu-ç›¸å…³çŸ¥è¯†"><a class="header" href="#cpu-ç›¸å…³çŸ¥è¯†">CPU ç›¸å…³çŸ¥è¯†</a></h1>
<p>è¿™é‡Œè®°å½•CPUç›¸å…³çš„çŸ¥è¯†ã€‚</p>
<h2 id="å‚è€ƒ-130"><a class="header" href="#å‚è€ƒ-130">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="cpuçš„è¿è¡ŒçŠ¶æ€"><a class="header" href="#cpuçš„è¿è¡ŒçŠ¶æ€">CPUçš„è¿è¡ŒçŠ¶æ€</a></h1>
<p>CPUä¸€å…±æœ‰å¤šç§å·¥ä½œçŠ¶æ€ï¼Œå…¶ä¸­åªæœ‰<code>idle</code>çŠ¶æ€æ˜¯ç©ºé—²çŠ¶æ€ã€‚</p>
<p><code>top</code>å‘½ä»¤æ˜¾ç¤ºè¿‡å»2ç§’ï¼ˆ2sæ˜¯é»˜è®¤å€¼ï¼Œå¯ä»¥ç”¨-då‚æ•°ä¿®æ”¹ï¼‰ä¸­ï¼Œæ¯ä¸ªCPUåœ¨æ¯ä¸ªçŠ¶æ€ä¸­åœç•™çš„æ—¶é—´æ¯”ä¾‹ï¼š</p>
<pre><code>%Cpu(s): 14.5 us,  0.3 sy,  0.0 ni, 85.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</code></pre>
<p><code>us</code>æ˜¯CPUåœ¨ç”¨æˆ·æ€çš„æ—¶é—´æ¯”ä¾‹ï¼Œ<code>sy</code>æ˜¯CPUåœ¨å†…æ ¸æ€çš„æ—¶é—´æ¯”ä¾‹ï¼Œå…¶å®ƒæŒ‡æ ‡å«ä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code>us, user    : time running un-niced user processes
sy, system  : time running kernel processes
ni, nice    : time running niced user processes
id, idle    : time spent in the kernel idle handler
wa, IO-wait : time waiting for I/O completion
hi : time spent servicing hardware interrupts
si : time spent servicing software interrupts
st : time stolen from this vm by the hypervisor
</code></pre>
<p>åœ¨<code>man top</code>å’Œä¸­å¯ä»¥æ‰¾åˆ°è¿™äº›è¯´æ˜ã€‚å¦å¤–<code>man proc</code>ç»™å‡ºäº†æ›´å¤šçŠ¶æ€è¯´æ˜ï¼š</p>
<pre><code>user   (1) Time spent in user mode.

nice   (2) Time spent in user mode with low priority (nice).

system (3) Time spent in system mode.

idle   (4) Time spent in the idle task. 
           This value should be USER_HZ times the second entry in the /proc/uptime pseudo-file.

iowait (since Linux 2.5.41)
       (5) Time waiting for I/O to complete.

irq (since Linux 2.6.0-test4)
       (6) Time servicing interrupts.

softirq (since Linux 2.6.0-test4)
       (7) Time servicing softirqs.

steal (since Linux 2.6.11)
       (8) Stolen time, which is the time spent in other operating systems when running in a virtualized environment

guest (since Linux 2.6.24)
       (9) Time spent running a virtual CPU for guest operating systems under the control of the Linux kernel.

guest_nice (since Linux 2.6.33)
       (10) Time spent running a niced guest (virtual CPU for guest operating systems under the control of the Linux kernel).
</code></pre>
<p><a href="http://blog.scoutapp.com/articles/2013/07/25/understanding-cpu-steal-time-when-should-you-be-worried">Understanding CPU Steal Time - when should you be worried?</a>ä¸­è¯¦ç»†ä»‹ç»äº†<code>steal time</code>ï¼Œå¦‚æœsteal timeå æ¯”æŒç»­20åˆ†é’Ÿè¶…è¿‡10%ï¼Œvmæ€§èƒ½å¯èƒ½å—åˆ°äº†æ˜¾è‘—å½±å“ã€‚</p>
<h2 id="cpuä½¿ç”¨ç‡çš„è®¡ç®—"><a class="header" href="#cpuä½¿ç”¨ç‡çš„è®¡ç®—">CPUä½¿ç”¨ç‡çš„è®¡ç®—</a></h2>
<p>CPUä½¿ç”¨ç‡è®¡ç®—æ–¹æ³•æ˜¯ï¼š1-ç©ºé—²æ—¶é—´/CPUæ€»æ—¶é—´ã€‚</p>
<h2 id="cpuå¤„äºæ¯ç§çŠ¶æ€çš„æ—¶é—´"><a class="header" href="#cpuå¤„äºæ¯ç§çŠ¶æ€çš„æ—¶é—´">CPUå¤„äºæ¯ç§çŠ¶æ€çš„æ—¶é—´</a></h2>
<p>topä¸­ä¼šæ˜¾ç¤ºCPUåœ¨æ¯ä¸ªçŠ¶æ€çš„æ—¶é—´å æ¯”ï¼Œè¿™äº›æ•°æ®æ¥è‡ªäº<code>/proc/stat</code>ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­è®°å½•æ¯ä¸ªCPUåœ¨æ¯ç§æ¨¡å¼ä¸‹è€—è´¹çš„æ—¶é—´åˆ†ç‰‡æ•°é‡ï¼Œç¬¬ä¸€è¡Œæ˜¯æ‰€æœ‰CPUçš„æ•°å€¼çš„ç´¯åŠ ï¼š</p>
<pre><code class="language-bash">$ cat /proc/stat
cpu  2295737 1270 903726 238996130 61210 0 90996 27778 0 0
cpu0 435456 334 213700 59922519 15305 0 18523 6715 0 0
cpu1 626136 317 229817 59638019 15702 0 35754 7526 0 0
cpu2 635052 320 237094 59685588 15354 0 18630 6930 0 0
cpu3 599092 297 223113 59750002 14847 0 18087 6605 0 0
...
</code></pre>
<p>æ³¨æ„ï¼š<code>/proc/stat</code>ä¸­æ•°å€¼çš„å•ä½ä¸æ˜¯ç§’/æ¯«ç§’ï¼Œè€Œæ˜¯æ—¶é—´åˆ†ç‰‡çš„ä¸ªæ•°ï¼š</p>
<pre><code>The amount of time, measured in units of USER_HZ (1/100ths of a second on most architectures,
use sysconf(_SC_CLK_TCK) to obtain the right value), that the system spent in variâ€
</code></pre>
<p>æ¯ä¸ªæ—¶é—´åˆ†ç‰‡æ—¶é•¿æ˜¯1/100ç§’ã€‚</p>
<h2 id="ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„è¯¦ç»†è¯´æ˜"><a class="header" href="#ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„è¯¦ç»†è¯´æ˜">ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„è¯¦ç»†è¯´æ˜</a></h2>
<p>ç”¨æˆ·æ€å’Œå†…æ ¸æ€å…¶å®æ˜¯CPUçš„å·¥ä½œæ¨¡å¼ï¼Œä¸€äº›ç‰¹æ®Šçš„æŒ‡ä»¤å¯ä»¥è®©CPUåœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ã€‚
CPUåœ¨å†…æ ¸æ€æ—¶ï¼Œæ“ä½œçš„æ˜¯å†…æ ¸ä¸­çš„æ•°æ®ï¼Œç”¨æˆ·æ€æ—¶æ“ä½œçš„æ˜¯ç”¨æˆ·æ€æ•°æ®ã€‚</p>
<p>ç”¨æˆ·æ€è¿›ç¨‹æ˜¯é€šè¿‡å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥åˆ°å†…æ ¸æ€çš„ã€‚</p>
<p>ç³»ç»Ÿè°ƒç”¨å¯ä»¥ç†è§£ä¸ºå†…æ ¸æä¾›çš„åŠŸèƒ½æ¥å£ï¼Œç”¨æˆ·æ€ç¨‹åºå‘èµ·ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼ŒCPUè½¬ä¸ºå†…æ ¸æ€ï¼Œå®Œæˆäº†ç›¸å…³æ“ä½œåï¼Œå†åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚</p>
<h2 id="å‚è€ƒ-131"><a class="header" href="#å‚è€ƒ-131">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="cpuè¿è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢"><a class="header" href="#cpuè¿è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢">CPUè¿è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢</a></h1>
<p>CPUä¸Šä¸‹æ–‡å°±æ˜¯CPUä¸­æ‰€æœ‰å¯„å­˜å™¨ã€è®¡æ•°å™¨çš„å¿«ç…§ï¼Œæ˜¯CPUå·¥ä½œç¯å¢ƒã€‚å½“CPUè¦æ‰§è¡Œå¦ä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œéœ€è¦å°†ä¸€äº›å¯„å­˜å™¨çš„æ•°å€¼ä¿®æ”¹ä¸ºç›®æ ‡è¿›ç¨‹çš„ç›¸åº”å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšCPUä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>CPUä¸Šä¸‹æ–‡åˆ‡æ¢å‘ç”Ÿåœ¨è¿™å‡ ä¸ªåœºæ™¯ä¸­ï¼š</p>
<ol>
<li>ç‰¹æƒæ¨¡å¼åˆ‡æ¢ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</li>
<li>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ol>
<h2 id="ç‰¹æƒæ¨¡å¼åˆ‡æ¢ç³»ç»Ÿè°ƒç”¨"><a class="header" href="#ç‰¹æƒæ¨¡å¼åˆ‡æ¢ç³»ç»Ÿè°ƒç”¨">ç‰¹æƒæ¨¡å¼åˆ‡æ¢ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</a></h2>
<p>åœ¨Linuxä¸­ï¼ŒCPUç‰¹æƒæ¨¡å¼åˆ‡æ¢å°±æ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œç”¨æˆ·æ€è¿›ç¨‹é€šè¿‡è°ƒç”¨ç³»ç»Ÿè°ƒç”¨è¿›å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¸€äº›ç‰¹æ®Šçš„CPUæŒ‡ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå°†CPUåˆ‡æ¢ç‰¹æƒæ¨¡å¼ï¼ŒCPUçš„ä¸Šä¸‹æ–‡ä¹Ÿéšä¹‹åˆ‡æ¢ï¼Œåˆ‡å…¥åˆ‡å›ï¼Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ä¼´éšç€ä¸¤æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>ç¬¬ä¸€æ¬¡åˆ‡æ¢ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶å€™ï¼Œä¿å­˜ç”¨æˆ·æ€çš„çŠ¶æ€ï¼Œç„¶ååˆ‡æ¢åˆ°å†…æ ¸æ€ï¼ŒåŠ è½½å†…æ ¸æ€ä»£ç ã€‚</p>
<p>ç¬¬äºŒæ¬¡åˆ‡æ¢ï¼šå†…æ ¸æ€çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†ä»£ç æ‰§è¡Œç»“æŸåï¼Œé€€å‡ºç‰¹æƒæ¨¡å¼ï¼ŒåŠ è½½ä¹‹å‰ä¿ç•™çš„ç”¨æˆ·æ€çŠ¶æ€ã€‚</p>
<p>ç³»ç»Ÿè°ƒç”¨çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ä¸€ç›´éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå’Œè¿›ç¨‹ä¸è¿›ç¨‹çš„åˆ‡æ¢ä¸åŒï¼Œä¸æ¶‰åŠè™šæ‹Ÿå†…å­˜ç­‰ç”¨æˆ·æ€èµ„æºã€‚</p>
<h2 id="è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢"><a class="header" href="#è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢">è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</a></h2>
<p>è¿›ç¨‹æ˜¯å†…æ ¸ç®¡ç†è°ƒåº¦çš„ï¼Œåˆ‡æ¢è¿‡ç¨‹åœ¨å†…æ ¸æ€è¿›è¡Œã€‚ç›¸æ¯”ç³»ç»Ÿè°ƒç”¨ä¸­çš„åˆ‡æ¢ï¼Œè¿›ç¨‹åˆ‡æ¢æ—¶éœ€è¦ä¿ç•™æ›´å¤šçŠ¶æ€æ•°æ®ï¼Œä¾‹å¦‚è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ï¼Œå’Œå†…æ ¸å †æ ˆã€å¯„å­˜å™¨æ•°å€¼ã€‚</p>
<p>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œå…ˆä¿ç•™å½“å‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œç„¶ååŠ è½½ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„çŠ¶æ€ï¼Œæ¯æ¬¡åˆ‡æ¢éœ€è¦å‡ åçº³ç§’åˆ°å‡ å¾®å¦™çš„æ—¶é—´ï¼Œå¼€é”€æ¯”è¾ƒå¤§ã€‚ï¼ˆç¡¬ä»¶å¯„å­˜å™¨çš„ç¼“å­˜éœ€è¦è¢«é‡æ–°åˆ·æ–°ï¼Œä¹Ÿä½¿æ‰§è¡Œæ•ˆç‡å—åˆ°å½±å“ï¼Œåœ¨å¤šæ ¸çš„æœºå™¨ï¼Œè¿›ç¨‹è¿˜å¯èƒ½åœ¨ä¸åŒCPUæ ¸å¿ƒä¸Šç§»åŠ¨ï¼‰ </p>
<p>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ä¸å¯é¿å…çš„ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿›ç¨‹çš„æ•°é‡ä¸€å®šæ˜¯è¿œè¿œè¶…è¿‡CPUæ ¸å¿ƒæ•°çš„ï¼Œè¿›ç¨‹ä¸èƒ½ç‹¬å CPUï¼Œéœ€è¦æ¥å—å†…æ ¸çš„è°ƒåº¦ï¼Œæ¯æ¬¡è°ƒåº¦éƒ½ä¼šè§¦å‘è¿›ç¨‹åˆ‡æ¢ã€‚</p>
<p>å¼•å‘å†…æ ¸é‡æ–°è°ƒåº¦çš„å› ç´ æœ‰ï¼š</p>
<ol>
<li>æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å½“å‰æ—¶é—´ç‰‡è€—å°½</li>
<li>ç³»ç»Ÿèµ„æºä¸è¶³ï¼ˆè­¬å¦‚å†…å­˜ï¼‰ï¼Œè¿›ç¨‹éœ€è¦ç­‰å¾…</li>
<li>è¿›ç¨‹é€šè¿‡sleepç­‰å‡½æ•°ï¼Œå°†è‡ªå·±æŒ‚èµ·</li>
<li>å‡ºç°äº†ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹ï¼ˆå†…æ ¸éœ€è¦è®¾ç½®ä¸ºæ”¯æŒæŠ¢å ï¼‰</li>
<li>å‘ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œè¢«åˆ‡æ¢åˆ°ä¸­æ–­æœåŠ¡ç¨‹åºï¼ˆæ³¨æ„ï¼Œè½¯ä¸­æ–­ä¸ä¼šè§¦å‘åˆ‡æ¢ï¼‰</li>
</ol>
<p>å¦‚æœä¸€ä¸ªè¿›ç¨‹å› ä¸ºè¢«é¢‘ç¹åœ°åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œå¯¼è‡´æ•ˆç‡ä¸é«˜ï¼Œå¯ä»¥å°†è¿›ç¨‹ç»‘å®šæŒ‡å®šCPUæ ¸å¿ƒä¸Šã€‚</p>
<h2 id="çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢"><a class="header" href="#çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢">çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</a></h2>
<p>è¿›ç¨‹æ˜¯èµ„æºæ‹¥æœ‰çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹å¯¹åº”è‡³å°‘ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥å¯¹åº”å¤šä¸ªçº¿ç¨‹ã€‚</p>
<p>éš¶å±äºåŒä¸€ä¸ªç»§æ‰¿çš„çº¿ç¨‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ç›¸å¯¹è¾ƒå°ï¼Œå› ä¸ºå®ƒä»¬æœ‰ä¸€éƒ¨åˆ†å…±ç”¨çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥å…é™¤åˆ‡æ¢ã€‚</p>
<h2 id="ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢"><a class="header" href="#ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢</a></h2>
<p>ä¸­æ–­é€šå¸¸æ˜¯ç¡¬ä»¶å‘å‡ºçš„ï¼Œä¹Ÿå¯ä»¥ç”¨å®ç°â€œè½¯ä¸­æ–­â€ï¼Œä¸­æ–­å‘ç”Ÿåï¼ŒCPUé€šå¸¸éœ€è¦åœä¸‹å½“å‰çš„å·¥ä½œï¼Œä¼˜å…ˆå¤„ç†ä¸­æ–­å®ç°ï¼ŒæŒ‡å®šä¸­æ–­äº‹ä»¶å¯¹åº”çš„æŒ‡ä»¤ã€‚</p>
<p>ä¸­æ–­åªå‘ç”Ÿåœ¨å†…æ ¸æ€ã€‚</p>
<p>ä¸­æ–­ä¼šæ‰“æ–­å…¶å®ƒè¿›ç¨‹çš„è°ƒåº¦å’Œæ‰§è¡Œï¼Œå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œå¦‚æœä¸­æ–­æ¬¡æ•°è¿‡å¤šï¼Œä¼šæ˜¾è‘—é™ä½æ•´ä½“ç³»ç»Ÿã€‚</p>
<h2 id="å‚è€ƒ-132"><a class="header" href="#å‚è€ƒ-132">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxä¸­æŸ¥çœ‹cpuçš„ä½¿ç”¨æƒ…å†µ"><a class="header" href="#linuxä¸­æŸ¥çœ‹cpuçš„ä½¿ç”¨æƒ…å†µ">Linuxä¸­æŸ¥çœ‹CPUçš„ä½¿ç”¨æƒ…å†µ</a></h1>
<p>CPUä½¿ç”¨åˆ†æä¸»è¦å°±æ˜¯åˆ†æCPUçš„ä½¿ç”¨ç‡ï¼Œçœ‹çœ‹é‚£äº›è¿›ç¨‹å ç”¨çš„CPUèµ„æºæ¯”è¾ƒå¤šã€‚</p>
<h2 id="tophtopatopæŸ¥çœ‹cpuä½¿ç”¨æƒ…å†µ"><a class="header" href="#tophtopatopæŸ¥çœ‹cpuä½¿ç”¨æƒ…å†µ">top/htop/atopæŸ¥çœ‹CPUä½¿ç”¨æƒ…å†µ</a></h2>
<p>topå‘½ä»¤ä¸å¤šè¯´äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨topä¸­é”®å…¥<code>H</code>åï¼Œè¿›å…¥çº¿ç¨‹æ¨¡å¼ã€‚</p>
<p>htopå’Œatopæ˜¯ä¸¤ä¸ªåŠŸèƒ½æ›´ä¸°å¯Œçš„ç±»topå·¥å…·ï¼š</p>
<pre><code>yum install -y htop atop
</code></pre>
<h2 id="pidstatæŸ¥çœ‹è¿›ç¨‹çš„cpuä½¿ç”¨ç‡"><a class="header" href="#pidstatæŸ¥çœ‹è¿›ç¨‹çš„cpuä½¿ç”¨ç‡">pidstatæŸ¥çœ‹è¿›ç¨‹çš„CPUä½¿ç”¨ç‡</a></h2>
<p><code>pidstat</code>å‘½ä»¤å¯ä»¥æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„åœ¨ä¸åŒCPUçŠ¶æ€ä¸­è€—è´¹çš„æ—¶é—´çš„ç™¾åˆ†æ¯”(1ï¼Œæ¯ç§’æ˜¾ç¤ºä¸€æ¬¡ï¼›-pï¼ŒæŒ‡å®šè¿›ç¨‹ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹)ï¼š</p>
<pre><code class="language-bash">$ pidstat  1 -p  27936
Linux 3.10.0-693.11.6.el7.x86_64 (10.10.64.58) 	12/04/2018 	_x86_64_	(4 CPU)

05:00:59 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
05:01:00 PM    99     27936    0.00    0.00    0.00    0.00     0  openresty
05:01:01 PM    99     27936    0.00    0.00    0.00    0.00     0  openresty
05:01:02 PM    99     27936    0.00    0.00    0.00    0.00     0  openresty
</code></pre>
<h2 id="perf-topæŸ¥çœ‹cpuå ç”¨é«˜çš„å‡½æ•°"><a class="header" href="#perf-topæŸ¥çœ‹cpuå ç”¨é«˜çš„å‡½æ•°">perf topæŸ¥çœ‹CPUå ç”¨é«˜çš„å‡½æ•°</a></h2>
<p><code>perf top</code>æ˜¾ç¤ºå ç”¨CPUæ—¶é—´æœ€å¤šçš„å‡½æ•°æˆ–è€…æŒ‡ä»¤ï¼š</p>
<pre><code class="language-bash">$ perf top
Samples: 3K of event 'cpu-clock', Event count (approx.): 903937500
Overhead  Shared Object          Symbol
   8.69%  perf                   [.] symbols__insert
   5.33%  perf                   [.] rb_next
   3.41%  [kernel]               [k] _raw_spin_unlock_irqrestore
   3.12%  libc-2.17.so           [.] __memcpy_ssse3_back
   2.40%  [kernel]               [k] finish_task_switch
   2.40%  libc-2.17.so           [.] __strchr_sse42
   2.08%  libelf-0.168.so        [.] gelf_getsym
...çœç•¥åç»­å†…å®¹...
</code></pre>
<h2 id="perf-reportæŸ¥çœ‹cpuäº‹ä»¶å æ¯”"><a class="header" href="#perf-reportæŸ¥çœ‹cpuäº‹ä»¶å æ¯”">perf reportæŸ¥çœ‹cpuäº‹ä»¶å æ¯”</a></h2>
<p>ç”¨<code>perf record</code>å°†é‡‡æ ·æ•°æ®ä¿å­˜ï¼Œç„¶åç”¨<code>perf record</code>æŸ¥çœ‹ï¼Œæˆ–è€…ç›´æ¥ç”¨ä¸‹é¢çš„å‘½ä»¤ä¸€æ¬¡å®Œæˆï¼Œ<code>-a</code>æŸ¥çœ‹æ‰€æœ‰cpuï¼š </p>
<pre><code class="language-sh">perf record -ag  -- sleep 15;perf report
</code></pre>
<p>perf reportä¸­æ˜¾ç¤ºï¼Œstressè¿›ç¨‹çš„cpuäº‹ä»¶å æ¯”æ˜¯77%ï¼Œå®ƒå¤§é‡è°ƒç”¨äº†éšæœºæ•°ç”Ÿæˆå‡½æ•°random()ï¼š</p>
<p><img src="linux/../img/perf-report-1.png" alt="perf-report" /></p>
<h2 id="vmstatæŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢"><a class="header" href="#vmstatæŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢">vmstatæŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢</a></h2>
<p><code>vmstat</code>å‘½ä»¤æ˜¾ç¤ºç³»ç»Ÿæ•´ä½“çŠ¶æ€ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">$ vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0   5980 126076    648 6997448    0    0     6    27   13    1  1  1 97  0  0
</code></pre>
<p>å¯ä»¥åœ¨åé¢åŠ ä¸Šä¸€ä¸ªæ•°å­—ï¼Œæ¯éš”æŒ‡å®šæ—¶é—´è¾“å‡ºä¸€æ¬¡ï¼Œä¾‹å¦‚<code>vmstat 5</code>ï¼Œå¦‚æœæ„Ÿè§‰æ•°æ®æ’åˆ—å¤ªå¯†é›†ï¼Œå¯ä»¥åŠ ä¸Šå‚æ•°<code>-w</code>ï¼Œç”¨å®½æ ¼å¼æ˜¾ç¤ºã€‚</p>
<p>vmstatå‘½ä»¤çš„è¾“å‡ºåŒ…å«<code>procs</code>ã€<code>memory</code>ã€ <code>swap</code>ã€<code>io</code>ã€<code>system</code>å’Œ<code>cpu</code>å…­å—å†…å®¹ã€‚</p>
<p>æ¯åˆ—æ•°æ®çš„å«ä¹‰å¦‚ä¸‹ï¼Œå¯ä»¥åœ¨<code>man vmstat</code>ä¸­æ‰¾åˆ°ï¼š</p>
<pre><code>Procs
    r: The number of runnable processes (running or waiting for run time).
    b: The number of processes in uninterruptible sleep.

Memory
    swpd: the amount of virtual memory used.
    free: the amount of idle memory.
    buff: the amount of memory used as buffers.
    cache: the amount of memory used as cache.
    inact: the amount of inactive memory.  (-a option)
    active: the amount of active memory.  (-a option)

Swap
    si: Amount of memory swapped in from disk (/s).
    so: Amount of memory swapped to disk (/s).

IO
    bi: Blocks received from a block device (blocks/s).
    bo: Blocks sent to a block device (blocks/s).

System
    in: The number of interrupts per second, including the clock.
    cs: The number of context switches per second.

CPU
    These are percentages of total CPU time.
    us: Time spent running non-kernel code.  (user time, including nice time)
    sy: Time spent running kernel code.  (system time)
    id: Time spent idle.  Prior to Linux 2.5.41, this includes IO-wait time.
    wa: Time spent waiting for IO.  Prior to Linux 2.5.41, included in idle.
    st: Time stolen from a virtual machine.  Prior to Linux 2.6.11, unknown.
</code></pre>
<p>å…¶ä¸­<code>cs</code>æ˜¯ä¸€ç§’å†…å‘ç”Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ã€‚</p>
<h2 id="pidstatæŸ¥çœ‹ç‰¹å®šè¿›ç¨‹çš„åˆ‡æ¢æƒ…å†µ"><a class="header" href="#pidstatæŸ¥çœ‹ç‰¹å®šè¿›ç¨‹çš„åˆ‡æ¢æƒ…å†µ">pidstatæŸ¥çœ‹ç‰¹å®šè¿›ç¨‹çš„åˆ‡æ¢æƒ…å†µ</a></h2>
<p><code>pidstat -w</code>å¯ä»¥æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µï¼š</p>
<pre><code class="language-bash">$ pidstat -w
Linux 3.10.0-693.11.6.el7.x86_64 (10.10.64.58) 	12/04/2018 	_x86_64_	(4 CPU)

04:04:15 PM   UID       PID   cswch/s nvcswch/s  Command
04:04:15 PM     0         1      1.75      0.00  systemd
04:04:15 PM     0         2      0.01      0.00  kthreadd
04:04:15 PM     0         3      2.54      0.00  ksoftirqd/0
...çœç•¥åç»­å†…å®¹...
</code></pre>
<p>ï¼ˆå¯ä»¥åœ¨åé¢ä¸Šä¸€ä¸ªæ•°å­—ï¼Œæ¯éš”æŒ‡å®šæ—¶é—´è¾“å‡ºä¸€æ¬¡ï¼Œä¾‹å¦‚<code>pidstat -w 5</code>ï¼‰</p>
<p>ç‰¹åˆ«æ³¨æ„ï¼špidstats -wæ˜¾ç¤ºçš„æ˜¯è¿›ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœè¦å°†çº¿ç¨‹ä¸€å¹¶æ˜¾ç¤ºå‡ºæ¥ï¼Œéœ€è¦å†åŠ ä¸€ä¸ª-tå‚æ•°ï¼š</p>
<pre><code class="language-bash">$ pidstat -wt
Average:      UID      TGID       TID   cswch/s nvcswch/s  Command
Average:        0         3         -      3.92      0.00  ksoftirqd/0
Average:        0         -         3      3.92      0.00  |__ksoftirqd/0
Average:        0         9         -     45.59      0.00  rcu_sched
Average:        0         -         9     45.59      0.00  |__rcu_sched
Average:        0        13         -      1.96      0.00  ksoftirqd/1
Average:        0         -        13      1.96      0.00  |__ksoftirqd/1
Average:        0        17         -      0.49      0.00  migration/2
...çœç•¥åç»­å†…å®¹...
</code></pre>
<p><code>-w</code>å‚æ•°çš„ä½œç”¨æ˜¯æ˜¾ç¤ºè¿›ç¨‹åˆ‡æ¢çŠ¶æ€ï¼Œæ¯ä¸€åˆ—çš„å«ä¹‰å¦‚ä¸‹ï¼ˆå¯ä»¥åœ¨<code>man pidstat</code>ä¸­æ‰¾åˆ°ï¼‰ï¼š</p>
<pre><code> -w     Report task switching activity (kernels 2.6.23 and later only).  
        The following values may be displayed:
  UID
         The real user identification number of the task being monitored.

  USER
         The name of the real user owning the task being monitored.

  PID
         The identification number of the task being monitored.

  cswch/s
         Total number of voluntary context switches the task made per second.  
         A voluntary context switch occurs when a task blocks because it requires 
         a resource that is unavailable.

  nvcswch/s
         Total number of non voluntary context switches the task made per second.  
         A involuntary context switch takes place when a task executes for the duration 
         of its  time  slice  and then is forced to relinquish the processor.

  Command
         The command name of the task.
</code></pre>
<p>éœ€è¦æ³¨æ„è‡ªæ„¿åˆ‡æ¢ï¼ˆcswch/sï¼Œvoluntary context switchesï¼‰å’Œéè‡ªæ„¿åˆ‡æ¢ï¼ˆnvcswch/sï¼Œnon voluntary context switchesï¼‰çš„åŒºåˆ«ã€‚å‰è€…æ˜¯å› ä¸ºéœ€è¦çš„èµ„æºæ²¡æœ‰å‡†å¤‡å¥½ï¼Œä¸»åŠ¨è®©å‡ºCPUå‘ç”Ÿçš„åˆ‡æ¢ï¼Œåè€…æ˜¯è¿›ç¨‹åˆ†é…çš„æ—¶é—´ç‰‡å·²ç»ç”¨å®Œï¼Œè¢«è°ƒåº¦å™¨å¼ºåˆ¶åˆ‡æ¢ã€‚</p>
<p>å¦å¤–pidstatè¿˜æœ‰ä¸€ä¸ª<code>-u</code>å‚æ•°ï¼Œå¯ä»¥ä¸€å¹¶è¾“å‡ºè¿›ç¨‹å’Œçº¿ç¨‹ï¼ˆåŠ -tï¼‰çš„CPUä½¿ç”¨æƒ…å†µï¼š</p>
<pre><code class="language-bash">[root@10.10.64.58 ~]#  pidstat -wt -u
Linux 3.10.0-693.11.6.el7.x86_64 (10.10.64.58) 	12/04/2018 	_x86_64_	(4 CPU)

04:21:56 PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command
04:21:56 PM     0         1         -    0.02    0.01    0.00    0.03     0  systemd
04:21:56 PM     0         -         1    0.02    0.01    0.00    0.03     0  |__systemd
04:21:56 PM     0         2         -    0.00    0.00    0.00    0.00     0  kthreadd
04:21:56 PM     0         -         2    0.00    0.00    0.00    0.00     0  |__kthreadd
...çœç•¥åç»­å†…å®¹...

04:21:56 PM   UID      TGID       TID   cswch/s nvcswch/s  Command
04:21:56 PM     0         1         -      1.75      0.00  systemd
04:21:56 PM     0         -         1      1.75      0.00  |__systemd
04:21:56 PM     0         2         -      0.01      0.00  kthreadd
04:21:56 PM     0         -         2      0.01      0.00  |__kthreadd
04:21:56 PM     0         3         -      2.53      0.00  ksoftirqd/0
...çœç•¥åç»­å†…å®¹...
</code></pre>
<h2 id="procinterruptsè®°å½•çš„ä¸­æ–­çŠ¶æ€"><a class="header" href="#procinterruptsè®°å½•çš„ä¸­æ–­çŠ¶æ€">/proc/interruptsè®°å½•çš„ä¸­æ–­çŠ¶æ€</a></h2>
<p><code>watch -d cat /proc/interrupts</code>ç”¨å¯ä»¥æ˜¾ç¤ºä¸­æ–­çš„å˜åŒ–æƒ…å†µã€‚</p>
<pre><code class="language-bash">Every 2.0s: cat /proc/interrupts                                                                                                                                                    Tue Dec  4 16:29:25 2018

           CPU0       CPU1	 CPU2       CPU3
  0:        153          0          0          0   IO-APIC-edge      timer
  1:         10          0          0          0   IO-APIC-edge      i8042
  6:          3          0          0          0   IO-APIC-edge      floppy
  8:          0          0          0          0   IO-APIC-edge      rtc0
  9:          0          0          0          0   IO-APIC-fasteoi   acpi
 10:          0          0          0          0   IO-APIC-fasteoi   virtio0
 11:         31          0          3          0   IO-APIC-fasteoi   uhci_hcd:usb1
 12:         15          0          0          0   IO-APIC-edge      i8042
 14:          0          0          0          0   IO-APIC-edge      ata_piix
 15:          0          0          0          0   IO-APIC-edge      ata_piix
 24:          0          0          0          0   PCI-MSI-edge      virtio3-config
 25:	   6234          0     120283     272843   PCI-MSI-edge      virtio3-req.0
 26:          0          0          0          0   PCI-MSI-edge      virtio1-config
 27:         99  176029503  172147021          0   PCI-MSI-edge      virtio1-input.0
 28:         24       2721        497       4165   PCI-MSI-edge      virtio1-output.0
 29:          0          0          0          0   PCI-MSI-edge      virtio2-config
 30:         19          0          0          0   PCI-MSI-edge      virtio2-virtqueues
 31:          0          0          0          0   PCI-MSI-edge      virtio4-config
 32:     131111          0          0          0   PCI-MSI-edge      virtio4-req.0
NMI:          0          0          0          0   Non-maskable interrupts
LOC:   64284244   70653905   70450086   65741168   Local timer interrupts
SPU:          0          0          0          0   Spurious interrupts
PMI:          0          0          0          0   Performance monitoring interrupts
IWI:    1242971    1424513    1360783    1296367   IRQ work interrupts
RTR:          0          0          0          0   APIC ICR read retries
RES:   33708963   29562936   30300354   32946303   Rescheduling interrupts
CAL:  131150935   64213698   67023823  133615842   Function call interrupts
TLB:     519133     541110     531432     522850   TLB shootdowns
TRM:          0          0          0          0   Thermal event interrupts
THR:          0          0          0          0   Threshold APIC interrupts
DFR:          0          0          0          0   Deferred Error APIC interrupts
MCE:          0          0          0          0   Machine check exceptions
MCP:	   2001       2001	 2001       2001   Machine check polls
ERR:          0
MIS:          0
PIN:          0          0          0          0   Posted-interrupt notification event
PIW:          0          0          0          0   Posted-interrupt wakeup event
</code></pre>
<p><code>Rescheduling interrupts</code>æ˜¯é‡è°ƒåº¦ä¸­æ–­ï¼Œç”¨æ¥å”¤é†’ç©ºé—²çš„CPUæ‰§è¡Œæ–°çš„ä»»åŠ¡ã€‚</p>
<h2 id="å‚è€ƒ-133"><a class="header" href="#å‚è€ƒ-133">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å†…å­˜ç›¸å…³çš„çŸ¥è¯†"><a class="header" href="#å†…å­˜ç›¸å…³çš„çŸ¥è¯†">å†…å­˜ç›¸å…³çš„çŸ¥è¯†</a></h1>
<h2 id="å‚è€ƒ-134"><a class="header" href="#å‚è€ƒ-134">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxçš„å†…å­˜ç®¡ç†æ–¹æ³•"><a class="header" href="#linuxçš„å†…å­˜ç®¡ç†æ–¹æ³•">Linuxçš„å†…å­˜ç®¡ç†æ–¹æ³•</a></h1>
<h2 id="è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´åˆ’åˆ†"><a class="header" href="#è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´åˆ’åˆ†">è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´åˆ’åˆ†</a></h2>
<p><img src="linux/../img/linux/memory-space.png" alt="Linuxè™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†" /></p>
<p><img src="linux/../img/linux/memory-space-detail.png" alt="Linuxè™šæ‹Ÿåœ°å€ç©ºé—´çš„è¯¦ç»†åˆ’åˆ†" /></p>
<h2 id="è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„"><a class="header" href="#è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„">è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„</a></h2>
<p><img src="linux/../img/linux/memory-map.png" alt="Linuxè™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„è¡¨" /></p>
<p><img src="linux/../img/linux/memory-page-table.png" alt="Linuxç³»ç»Ÿå†…å­˜çš„å››çº§é¡µè¡¨" /></p>
<h2 id="numanodeç‹¬ç«‹å†…å­˜"><a class="header" href="#numanodeç‹¬ç«‹å†…å­˜">NUMAï¼šnodeç‹¬ç«‹å†…å­˜</a></h2>
<p>åœ¨NUMAæ¶æ„(å¤šCPU)ä¸‹ï¼Œæ¯ä¸ªnodeï¼ˆç‰©ç†CPUï¼‰éƒ½æœ‰è‡ªå·±çš„æœ¬åœ°å†…å­˜ï¼Œåœ¨åˆ†æå†…å­˜çš„æ—¶å€™éœ€è¦åˆ†ææ¯ä¸ªnodeçš„æƒ…å†µï¼š</p>
<p><img src="linux/../img/linux/numa-memory.png" alt="NUMAæ¶æ„ä¸­nodeçš„æœ¬åœ°å†…å­˜" /></p>
<pre><code class="language-sh">$ numactl --hardware
available: 1 nodes (0)
node 0 cpus: 0 1
node 0 size: 7977 MB
node 0 free: 4416 MB
...
</code></pre>
<p>/proc/sys/vm/zone_reclaim_modeè®¾ç½®NUMAæœ¬åœ°å†…å­˜çš„å›æ”¶ç­–ç•¥ï¼Œå½“nodeæœ¬åœ°å†…å­˜ä¸è¶³æ—¶ï¼Œé»˜è®¤å¯ä»¥ä»å…¶å®ƒnodeå¯»æ‰¾ç©ºé—²å†…å­˜ï¼Œä¹Ÿå¯ä»¥ä»æœ¬åœ°å›æ”¶ã€‚</p>
<h2 id="swap"><a class="header" href="#swap">Swap</a></h2>
<p>Swapçš„è®¾ç½®å¼€å¯ï¼š</p>
<pre><code class="language-sh"># åˆ›å»º Swap æ–‡ä»¶
$ fallocate -l 8G /mnt/swapfile
# ä¿®æ”¹æƒé™åªæœ‰æ ¹ç”¨æˆ·å¯ä»¥è®¿é—®
$ chmod 600 /mnt/swapfile
# é…ç½® Swap æ–‡ä»¶
$ mkswap /mnt/swapfile
# å¼€å¯ Swap
$ swapon /mnt/swapfile
</code></pre>
<p>saræ˜¾ç¤ºSwapçš„ä½¿ç”¨æƒ…çœ‹ï¼Œ-r è¡¨ç¤ºæ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ-S è¡¨ç¤ºæ˜¾ç¤º Swap ä½¿ç”¨æƒ…å†µï¼š</p>
<pre><code class="language-sh">$ sar -r -S 1
04:39:56    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
04:39:57      6249676   6839824   1919632     23.50    740512     67316   1691736     10.22    815156    841868         4

04:39:56    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad
04:39:57      8388604         0      0.00         0      0.00

04:39:57    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
04:39:58      6184472   6807064   1984836     24.30    772768     67380   1691736     10.22    847932    874224        20

04:39:57    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad
04:39:58      8388604         0      0.00         0      0.00
</code></pre>
<h2 id="å†…å­˜åˆ†é…brkä¸mmap"><a class="header" href="#å†…å­˜åˆ†é…brkä¸mmap">å†…å­˜åˆ†é…ï¼šbrk()ä¸mmap()</a></h2>
<p>brk()åˆ†é…çš„æ˜¯å †ä¸­çš„å†…å­˜ï¼Œè¿™äº›å†…å­˜é‡Šæ”¾ä»¥åä¸ä¼šè¢«ç«‹åˆ»å½’è¿˜ç³»ç»Ÿï¼Œè€Œæ˜¯è¢«ç¼“å­˜èµ·æ¥é‡å¤ä½¿ç”¨ã€‚brk()ä¼šç¼“å­˜è·å¾—çš„ç‰©ç†å†…å­˜é¡µï¼Œå‡å°‘ç¼ºé¡µå¼‚å¸¸ï¼Œä½†æ˜¯é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ä¼šé€ æˆå†…å­˜ç¢ç‰‡ã€‚</p>
<p>mmap()åˆ†é…çš„æ–‡ä»¶æ˜ å°„æ®µçš„å†…å­˜ï¼Œé‡Šæ”¾æ—¶ç›´æ¥å½’è¿˜ç³»ç»Ÿï¼Œä¸‹è½½å†ä½¿ç”¨è¦å†æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œè®©å†…æ ¸åˆ†é…å¯¹åº”çš„ç‰©ç†å†…å­˜ã€‚ mmap()ç›´æ¥å½’è¿˜è·å¾—çš„ç‰©ç†å†…å­˜é¡µï¼Œæ¯æ¬¡éƒ½ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œé¢‘ç¹å†…å­˜åˆ†é…ä¼šå¢åŠ å†…æ ¸å‹åŠ›ã€‚</p>
<p>åœ¨Cæ ‡å‡†åº“ä¸­ï¼Œå°äº128Kçš„å†…å­˜ç”¨brk()åˆ†é…ï¼Œå¤§äº128Kçš„å†…å­˜ç”¨mmap()åˆ†é…ã€‚ </p>
<h2 id="å†…æ ¸å†…å­˜ä¼™ä¼´ç³»ç»Ÿ"><a class="header" href="#å†…æ ¸å†…å­˜ä¼™ä¼´ç³»ç»Ÿ">å†…æ ¸å†…å­˜ï¼šä¼™ä¼´ç³»ç»Ÿ</a></h2>
<p>å†…æ ¸ç”¨ä¼™ä¼´ç³»ç»Ÿç®¡ç†å†…å­˜åˆ†é…ã€‚</p>
<h2 id="å†…å­˜æ³„éœ²"><a class="header" href="#å†…å­˜æ³„éœ²">å†…å­˜æ³„éœ²</a></h2>
<p>BCCä¸­çš„memleakç”¨æ¥æ£€æµ‹å†…å­˜æ³„éœ²ï¼š</p>
<pre><code class="language-sh">$ /usr/share/bcc/tools/memleak -p $(pidof app) -a
Attaching to pid 12512, Ctrl+C to quit.
[03:00:41] Top 10 stacks with outstanding allocations:
    addr = 7f8f70863220 size = 8192
    addr = 7f8f70861210 size = 8192
    addr = 7f8f7085b1e0 size = 8192
    addr = 7f8f7085f200 size = 8192
    addr = 7f8f7085d1f0 size = 8192
    40960 bytes in 5 allocations from stack
        fibonacci+0x1f [app]
        child+0x4f [app]
        start_thread+0xdb [libpthread-2.27.so] 
</code></pre>
<h2 id="å‚è€ƒ-135"><a class="header" href="#å‚è€ƒ-135">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="å†…å­˜ç¼“å­˜"><a class="header" href="#å†…å­˜ç¼“å­˜">å†…å­˜ç¼“å­˜</a></h1>
<h2 id="bufferä¸cache"><a class="header" href="#bufferä¸cache">bufferä¸cache</a></h2>
<p>freeçš„å‘½ä»¤ä¸­æœ‰ä¸€æ æ˜¯buff/cacheï¼Œbufferå’Œcacheéƒ½æ˜¯å†…å­˜ç¼“å­˜ï¼Œä½†æ˜¯åˆæœ‰åŒºåˆ«ã€‚</p>
<pre><code class="language-sh">$ free
              total        used        free      shared  buff/cache   available
Mem:       32731868     1170284    28024100      254420     3537484    30824636
Swap:      67108860     3376124    63732736
</code></pre>
<p>bufferä¸­ç¼“å­˜çš„æ˜¯å°†è¦å†™åˆ°ç£ç›˜çš„æ•°æ®ï¼Œé€šè¿‡åˆå¹¶å†™çš„æ–¹å¼æé«˜å†™å…¥æ•ˆç‡ã€‚</p>
<p>cacheä¸­ç¼“å­˜çš„æ˜¯ä»ç£ç›˜è¯»å–çš„æ•°æ®ã€‚</p>
<h2 id="ç¼“å­˜å‘½ä¸­ç‡"><a class="header" href="#ç¼“å­˜å‘½ä¸­ç‡">ç¼“å­˜å‘½ä¸­ç‡</a></h2>
<p>BCCä¸­çš„cachestatå’Œcachetopåˆ†åˆ«ç”¨æ¥æŸ¥çœ‹æ•´ä¸ªç³»ç»Ÿçš„ç¼“å­˜è¯»å†™å‘½ä¸­æƒ…å†µã€æ¯ä¸ªè¿›ç¨‹çš„ç¼“å­˜å‘½ä¸­æƒ…å†µã€‚</p>
<pre><code class="language-sh">$ cachestat 1 3
   TOTAL   MISSES     HITS  DIRTIES   BUFFERS_MB  CACHED_MB
       2        0        2        1           17        279
       2        0        2        1           17        279
       2        0        2        1           17        279 

</code></pre>
<p>TOTALæ˜¯æ€»çš„IOæ¬¡æ•°ï¼ŒDIRTIESæ˜¯æ–°å¢åˆ°ç¼“å­˜ä¸­çš„è„é¡µã€‚ </p>
<pre><code class="language-sh">$ cachetop
11:58:50 Buffers MB: 258 / Cached MB: 347 / Sort: HITS / Order: ascending
PID      UID      CMD              HITS     MISSES   DIRTIES  READ_HIT%  WRITE_HIT%
   13029 root     python                  1        0        0     100.0%       0.0%
</code></pre>
<h2 id="æ–‡ä»¶çš„ç¼“å­˜å¤§å°"><a class="header" href="#æ–‡ä»¶çš„ç¼“å­˜å¤§å°">æ–‡ä»¶çš„ç¼“å­˜å¤§å°</a></h2>
<p>pcstatç”¨æ¥æŸ¥çœ‹ä¸€ä¸ªæ–‡ä»¶çš„ç¼“å­˜å¤§å°ï¼š</p>
<pre><code class="language-sh">$ pcstat /bin/ls
+---------+----------------+------------+-----------+---------+
| Name    | Size (bytes)   | Pages      | Cached    | Percent |
|---------+----------------+------------+-----------+---------|
| /bin/ls | 133792         | 33         | 0         | 000.000 |
+---------+----------------+------------+-----------+---------+
</code></pre>
<p>pcstatçš„å®‰è£…æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">$ go get golang.org/x/sys/unix
$ go get github.com/tobert/pcstat/pcstat
</code></pre>
<p>åœ¨æµ‹è¯•æ–‡ä»¶è¯»å†™æ€§èƒ½çš„æ—¶å€™ï¼Œè¦æ¸…ç†ç¼“å­˜ï¼š</p>
<pre><code class="language-sh">$ echo 3 &gt; /proc/sys/vm/drop_caches
</code></pre>
<h2 id="å‚è€ƒ-136"><a class="header" href="#å‚è€ƒ-136">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="æŸ¥çœ‹å†…å­˜çŠ¶æ€"><a class="header" href="#æŸ¥çœ‹å†…å­˜çŠ¶æ€">æŸ¥çœ‹å†…å­˜çŠ¶æ€</a></h1>
<h2 id="vmstatæŸ¥çœ‹å†…å­˜çŠ¶æ€"><a class="header" href="#vmstatæŸ¥çœ‹å†…å­˜çŠ¶æ€">vmstatæŸ¥çœ‹å†…å­˜çŠ¶æ€</a></h2>
<pre><code class="language-sh">$ vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  1      0 6809304   1368 856744    0    0 32640     0   52  478  1  0 50 49  0
 0  1      0 6776620   1368 889456    0    0 32640     0   33  490  0  0 50 49  0
 0  0      0 6747540   1368 918576    0    0 29056     0   42  568  0  0 56 44  0
 0  0      0 6747540   1368 918576    0    0     0     0   40  141  1  0 100  0  0
 0  0      0 6747160   1368 918576    0    0     0     0   40  148  0  1 99  0  0
</code></pre>
<p>buff: å†™å…¥ç¼“å†²åŒºã€‚</p>
<p>cache: è¯»å–ç¼“å†²åŒºã€‚</p>
<p>bi: æ¯ç§’ä»å—è®¾å¤‡ä¸Šè¯»å–çš„å—æ•°ï¼ˆblock/sï¼‰ã€‚</p>
<p>bo: æ¯ç§’å‘å—è®¾å¤‡ä¸Šå†™å…¥çš„å—æ•°ï¼ˆblock/sï¼‰ã€‚</p>
<p>in: æ¯ç§’ä¸­æ–­æ¬¡æ•°ï¼ŒåŒ…å«æ—¶é’Ÿä¸­æ–­ã€‚</p>
<p>cs: æ¯ç§’çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ã€‚</p>
<h2 id="å‚è€ƒ-137"><a class="header" href="#å‚è€ƒ-137">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç³»ç»Ÿä¸­æ–­"><a class="header" href="#ç³»ç»Ÿä¸­æ–­">ç³»ç»Ÿä¸­æ–­</a></h1>
<p>ä¸­æ–­æ˜¯é‡è¦çš„å†…æ ¸æœºåˆ¶ï¼Œæ˜¯å†…æ ¸çš„äº‹ä»¶å¤„ç†æœºåˆ¶ã€‚</p>
<h2 id="å‚è€ƒ-138"><a class="header" href="#å‚è€ƒ-138">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linuxçš„ç³»ç»Ÿä¸­æ–­"><a class="header" href="#linuxçš„ç³»ç»Ÿä¸­æ–­">Linuxçš„ç³»ç»Ÿä¸­æ–­</a></h1>
<p>ä¸­æ–­åˆ†ä¸ºç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­ï¼Œå‘ç”Ÿä¸­æ–­ä»¥åï¼Œä¸­æ–­å¤„ç†ç¨‹åºä¼šè¢«è°ƒç”¨ã€‚</p>
<p>ä¸­æ–­å¤„ç†ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œä¸èƒ½å†æ¬¡ä¸­æ–­ï¼ˆè®¾ç½®äº†ä¸­æ–­ç¦æ­¢ï¼‰çš„ä¸­æ–­æ˜¯ç¡¬ä¸­æ–­ï¼Œç¡¬ä¸­æ–­å¤„ç†æœŸé—´å‘ç”Ÿçš„ä¸­æ–­ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥ç¡¬ä¸­æ–­çš„å¤„ç†æ—¶é—´ä¸èƒ½è¿‡ç¨‹ã€‚ä¸­æ–­å¤„ç†ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œå¯ä»¥å†æ¬¡ä¸­æ–­çš„ä¸­æ–­æ˜¯è½¯ä¸­æ–­ã€‚</p>
<p>Linuxå°†ä¸­æ–­å¤„ç†è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>
<p>ç¬¬ä¸€é˜¶æ®µæ˜¯ä¸ŠåŠéƒ¨ï¼Œåœ¨ä¸­æ–­ç¦æ­¢æ¨¡å¼ä¸‹è¿è¡Œï¼Œç”¨æ¥å¿«é€Ÿå¤„ç†ç¡¬ä»¶ç›¸å…³æˆ–è€…æ—¶é—´æ•æ„Ÿçš„ä»»åŠ¡ï¼Œè§¦å‘ä¸ŠåŠéƒ¨å¤„ç†çš„ä¸­æ–­æ˜¯ç¡¬ä¸­æ–­ï¼›</p>
</li>
<li>
<p>ç¬¬äºŒé˜¶æ®µæ˜¯ä¸‹åŠéƒ¨ï¼Œå…è®¸ç»§ç»­ä¸­æ–­ï¼Œç”¨äºå¤„ç†ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œï¼Œé€šå¸¸ä»¥å†…æ ¸çº¿ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œè§¦å‘ä¸‹åŠéƒ¨æ“ä½œçš„ä¸­æ–­æ˜¯è½¯ä¸­æ–­ã€‚</p>
</li>
</ol>
<p>ä¸ŠåŠéƒ¨å¤„ç†ç»“æŸæ—¶ï¼Œé€šå¸¸ä¼šå‘é€ä¸€ä¸ªè½¯ä¸­æ–­ï¼Œç”±ä¸‹åŠéƒ¨å¤„ç†æ—¶æ•ˆæ€§ä¸é‚£ä¹ˆç´§è¿«çš„ä»»åŠ¡ã€‚ä¸ŠåŠéƒ¨é€šå¸¸æ˜¯ç¡¬ä»¶è§¦å‘ï¼Œå¤„ç†ç¡¬ä»¶è¯·æ±‚ï¼Œä¸‹åŠéƒ¨æ˜¯å†…æ ¸è§¦å‘ã€‚</p>
<p>ä¸‹åŠéƒ¨æ˜¯è½¯ä¸­æ–­ï¼Œè½¯ä¸­æ–­ä¸å…¨æ˜¯ä¸‹åŠéƒ¨ï¼Œä¸€äº›å†…æ ¸è‡ªå®šä¹‰äº‹ä»¶ä¹Ÿæ˜¯è½¯ä¸­æ–­ï¼Œä¾‹å¦‚å†…æ ¸è°ƒåº¦ã€RCUé”ç­‰ã€‚</p>
<p>æ¯ä¸ªCPUéƒ½æœ‰ä¸€ä¸ªè½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹ï¼Œksoftirqd/cpuç¼–å·ï¼š</p>
<pre><code class="language-sh">$ps aux|grep ksoft
root         3  0.0  0.0      0     0 ?        S    Apr05   1:19 [ksoftirqd/0]
root        13  0.0  0.0      0     0 ?        S    Apr05   1:24 [ksoftirqd/1]
root        18  0.0  0.0      0     0 ?        S    Apr05   1:25 [ksoftirqd/2]
root        23  0.0  0.0      0     0 ?        S    Apr05   1:14 [ksoftirqd/3]
root        28  0.0  0.0      0     0 ?        S    Apr05   1:26 [ksoftirqd/4]
root        33  0.0  0.0      0     0 ?        S    Apr05   1:09 [ksoftirqd/5]
root        38  0.0  0.0      0     0 ?        S    Apr05   1:09 [ksoftirqd/6]
</code></pre>
<h2 id="ç³»ç»Ÿä¸­æ–­çŠ¶æ€"><a class="header" href="#ç³»ç»Ÿä¸­æ–­çŠ¶æ€">ç³»ç»Ÿä¸­æ–­çŠ¶æ€</a></h2>
<p><code>/proc/softirqs</code>ä¸­æ˜¯è½¯ä¸­æ–­çš„è¿è¡Œæƒ…å†µï¼ŒåŒä¸€ä¸­æ–­åœ¨ä¸åŒCPUä¸Šçš„è¿è¡Œæ¬¡æ•°åº”å½“æ˜¯æ¥è¿‘çš„ï¼Œå¦‚æœæ˜æ˜¾ä¸å‡è¡¡ï¼Œè¡¨æ˜å¤šæ ¸CPUæ²¡æœ‰è¢«å……åˆ†åˆ©ç”¨ï¼š</p>
<pre><code class="language-sh">$ cat /proc/softirqs
                    CPU0       CPU1       CPU2       CPU3
          HI:          1          1          0          0
       TIMER:  607522918  541095809  566655073  545147469
      NET_TX:    1188125     727904    1105106    1090468
      NET_RX:  227103214 1942391353  244785330  214470397
       BLOCK:    9212292    9070209    6004124    9196281
    IRQ_POLL:          0          0          0          0
     TASKLET:        461        703        559        512
       SCHED:  262424378  225458960  231808842  212340029
     HRTIMER:       1598       1163       1373       1445
         RCU:  348165561  309546532  322077899  312389145
</code></pre>
<p><code>/proc/interrupts</code>ä¸­æ˜¯ç¡¬ä¸­æ–­çš„è¿è¡Œæƒ…å†µï¼š</p>
<pre><code class="language-sh">$ cat /proc/interrupts
           CPU0       CPU1       CPU2       CPU3
  0:        114          0          0          0   IO-APIC   2-edge      timer
  1:          9          0          0          0   IO-APIC   1-edge      i8042
  6:          0          0          3          0   IO-APIC   6-edge      floppy
  8:          0          0          0          0   IO-APIC   8-edge      rtc0
  9:          0          0          0          0   IO-APIC   9-fasteoi   acpi
 10:          0          0          0          0   IO-APIC  10-fasteoi   virtio0
 11:          0          0         35          0   IO-APIC  11-fasteoi   uhci_hcd:usb1
 12:          0          0          0         15   IO-APIC  12-edge      i8042
 14:          0          0          0          0   IO-APIC  14-edge      ata_piix
 15:          0          0          0          0   IO-APIC  15-edge      ata_piix
 24:          0          0          0          0   PCI-MSI 81920-edge      virtio2-config
 25:          0          0          3          0   PCI-MSI 81921-edge      virtio2-virtqueues
 26:          0          0          0          0   PCI-MSI 65536-edge      virtio1-config
 27:         62 1012111617          0          0   PCI-MSI 65537-edge      virtio1-input.0
 28:         54          2          0      22109   PCI-MSI 65538-edge      virtio1-output.0
 29:          0          0          0          0   PCI-MSI 98304-edge      virtio3-config
 30:          0          0    9853249          0   PCI-MSI 98305-edge      virtio3-req.0
 31:          0          0          0          0   PCI-MSI 114688-edge      virtio4-config
 32:          0          0   12293598          0   PCI-MSI 114689-edge      virtio4-req.0
NMI:          0          0          0          0   Non-maskable interrupts
LOC: 1217427530 1144644230 1177257177 1149689000   Local timer interrupts
SPU:          0          0          0          0   Spurious interrupts
PMI:          0          0          0          0   Performance monitoring interrupts
IWI:        153        120        264        318   IRQ work interrupts
RTR:          0          0          0          0   APIC ICR read retries
RES: 1027217904  904556924  981991984  977800420   Rescheduling interrupts
CAL:  233863698   11399907  241091628  220970613   Function call interrupts
TLB:    1487790    1520042    1474210    1505102   TLB shootdowns
TRM:          0          0          0          0   Thermal event interrupts
THR:          0          0          0          0   Threshold APIC interrupts
DFR:          0          0          0          0   Deferred Error APIC interrupts
MCE:          0          0          0          0   Machine check exceptions
MCP:      14170      14170      14170      14170   Machine check polls
HYP:          0          0          0          0   Hypervisor callback interrupts
HRE:          0          0          0          0   Hyper-V reenlightenment interrupts
HVS:          0          0          0          0   Hyper-V stimer0 interrupts
ERR:          0
MIS:          0
PIN:          0          0          0          0   Posted-interrupt notification event
NPI:          0          0          0          0   Nested posted-interrupt event
PIW:          0          0          0          0   Posted-interrupt wakeup event
</code></pre>
<h2 id="å‚è€ƒ-139"><a class="header" href="#å‚è€ƒ-139">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç†è§£è¿›ç¨‹"><a class="header" href="#ç†è§£è¿›ç¨‹">ç†è§£è¿›ç¨‹</a></h1>
<p>å‡ ä¸ªæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€çš„å·¥å…·ï¼š</p>
<pre><code class="language-sh">top command : Display and update sorted information about Linux processes.
atop command : Advanced System &amp; Process Monitor for Linux.
htop command : Interactive process viewer in Linux.
pgrep command : Look up or signal processes based on name and other attributes.
pstree command : Display a tree of processes.
</code></pre>
<p><a href="https://www.cyberciti.biz/faq/show-all-running-processes-in-linux/">Show All Running Processes in Linux using ps/htop commands</a></p>
<h2 id="å‚è€ƒ-140"><a class="header" href="#å‚è€ƒ-140">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¿›ç¨‹çš„åˆ†ç±»"><a class="header" href="#è¿›ç¨‹çš„åˆ†ç±»">è¿›ç¨‹çš„åˆ†ç±»</a></h1>
<p><a href="https://access.redhat.com/sites/default/files/attachments/processstates_20120831.pdf">Understanding Linux Process States</a>å¯¹Linuxçš„è¿›ç¨‹ï¼ˆProcessï¼‰åšäº†å¾ˆè¯¦ç»†çš„ä»‹ç»ã€‚</p>
<p>åœ¨Linuxä¸­ï¼Œè¿›ç¨‹æ˜¯ç”³è¯·èµ„æºçš„æœ€å°å•ä½ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰<code>ownership</code>ã€<code>nice value</code>ã€<code>SELinux context</code>ç­‰è¯¸å¤šå±æ€§ã€‚Linuxä¸­ï¼Œè¿›ç¨‹åˆ†ä¸ºä¸‰ç±»ï¼šç”¨æˆ·è¿›ç¨‹ï¼ˆUser Processï¼‰ã€å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemon Processï¼‰ã€å†…æ ¸è¿›ç¨‹ï¼ˆKernel Processï¼‰ã€‚</p>
<p><code>ç”¨æˆ·è¿›ç¨‹ï¼ˆUser Processï¼‰</code>æ˜¯æ™®é€šç”¨æˆ·åˆ›å»ºçš„ã€è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼ˆUser Spaceï¼‰çš„è¿›ç¨‹ã€‚é™¤éè¿›è¡Œäº†ç‰¹æ®Šçš„æƒé™è®¾ç½®ï¼Œå¦åˆ™ç”¨æˆ·è¿›ç¨‹æ²¡æœ‰å…¶å®ƒç”¨æˆ·æ–‡ä»¶çš„æƒé™ã€‚</p>
<p><code>å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemon Processï¼‰</code>æ˜¯åœ¨åå°ä¸€ç›´è¿è¡Œçš„è¿›ç¨‹ï¼Œåº”å½“ç®—æ˜¯ç”¨æˆ·è¿›ç¨‹ä¸­çš„ä¸€ç§ï¼Œä½†å®ƒä¸éšç€ç”¨æˆ·çš„é€€å‡ºè€Œç»ˆæ­¢ï¼Œè€Œæ˜¯ä¸€ç›´åœ¨ç³»ç»Ÿä¸­è¿è¡Œï¼Œç›´åˆ°è¢«äººä¸ºå…³é—­ã€‚</p>
<p><code>å†…æ ¸è¿›ç¨‹ï¼ˆKernel Processï¼‰</code>åªåœ¨å†…æ ¸æ€è¿è¡Œï¼Œå®ƒä¹Ÿæ˜¯å¸¸é©»çš„è¿›ç¨‹ï¼Œä½†å†…æ ¸è¿›ç¨‹æ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰çš„å†…æ ¸æ•°æ®ã€‚</p>
<p>è¿™æ˜¯é€šå¸¸æåˆ°çš„ä¸‰ç§åˆ’åˆ†æ–¹æ³•ï¼Œä¸ªäººæ„Ÿè§‰è¿™ç§åˆ’åˆ†æ–¹æ³•åœ¨æ ‡å‡†ä¸Šä¸ç»Ÿä¸€ï¼Œä¸¥æ ¼è¯´ï¼ŒæŒ‰ç…§è¿›ç¨‹çš„æ‰€å±å’Œæƒé™ï¼Œè¿›ç¨‹å¯ä»¥åˆ†ä¸ºç”¨æˆ·è¿›ç¨‹å’Œå†…æ ¸è¿›ç¨‹ï¼ŒæŒ‰ç…§è¿›ç¨‹çš„å½¢æ€ï¼Œå¯ä»¥åˆ†ä¸ºå®ˆæŠ¤è¿›ç¨‹å’Œéå®ˆæŠ¤è¿›ç¨‹ã€‚ç”¨æˆ·è¿›ç¨‹æ—¢å¯ä»¥æ˜¯å®ˆæŠ¤è¿›ç¨‹ä¹Ÿå¯ä»¥æ˜¯éå®ˆæŠ¤è¿›ç¨‹ï¼Œå†…æ ¸è¿›ç¨‹éƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹ã€‚</p>
<h2 id="å‚è€ƒ-141"><a class="header" href="#å‚è€ƒ-141">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="è¿›ç¨‹çš„çŠ¶æ€"><a class="header" href="#è¿›ç¨‹çš„çŠ¶æ€">è¿›ç¨‹çš„çŠ¶æ€</a></h1>
<p><code>ps -l</code>å‘½ä»¤è¾“å‡ºç»“æœçš„ç¬¬äºŒåˆ—æ˜¯è¿›ç¨‹æ‰€å¤„çš„çŠ¶æ€ï¼Œpsä¸€å…±å±•ç¤ºä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p>
<pre><code>D    uninterruptible sleep (usually IO)
R    running or runnable (on run queue)
S    interruptible sleep (waiting for an event to complete)
T    stopped by job control signal
t    stopped by debugger during the tracing
W    paging (not valid since the 2.6.xx kernel)
X    dead (should never be seen)
Z    defunct (&quot;zombie&quot;) process, terminated but not reaped by its parent
</code></pre>
<p>åœ¨<code>man ps</code>ä¸­å¯ä»¥æ‰¾åˆ°æ›´è¯¦ç»†è¯´æ˜ã€‚</p>
<h2 id="è¿›ç¨‹çŠ¶æ€ä»‹ç»"><a class="header" href="#è¿›ç¨‹çŠ¶æ€ä»‹ç»">è¿›ç¨‹çŠ¶æ€ä»‹ç»</a></h2>
<p>è¿›ç¨‹æ˜¯åŠ¨æ€çš„ï¼Œæ˜¯æœ‰çŠ¶æ€çš„ï¼Œæ­£åœ¨è¢«CPUæ‰§è¡Œçš„è¿›ç¨‹çš„çŠ¶æ€æ˜¯<code>Running</code>ï¼Œæ²¡æœ‰è¢«CPUæ‰§è¡Œçš„è¿›ç¨‹çš„çŠ¶æ€æ˜¯<code>Not Running</code>ã€‚åœ¨åé¢çš„ç«ç„°å›¾ç« èŠ‚ä¸­ï¼Œæ­£åœ¨è¿è¡Œçš„çŠ¶æ€è¢«ç§°ä¸º<code>On-CPU</code>ï¼Œæ²¡æœ‰åœ¨è¿è¡Œçš„çŠ¶æ€è¢«ç§°ä¸º<code>Off-CPU</code>ï¼Œä¸€ä¸ªè¿›ç¨‹è¦ä¹ˆåœ¨ä½¿ç”¨CPUï¼Œè¦ä¹ˆæ²¡æœ‰åœ¨ä½¿ç”¨CPUï¼Œåœ¨åšæ€§èƒ½åˆ†æçš„æ—¶å€™ï¼Œè¿™ä¸¤æ®µæ—¶é—´é‡Œå‘ç”Ÿçš„äº‹æƒ…éƒ½éœ€è¦å…³æ³¨ã€‚</p>
<p><img src="http://www.brendangregg.com/FlameGraphs/hotcoldfigure.png" alt="Thread state transition diagram" /></p>
<p>æ¯ä¸ªCPUæ ¸å¿ƒåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œå¯¹ä¸€ä¸ªCPUæ ¸å¿ƒæ¥è¯´è¿›ç¨‹å°±æ˜¯ä¸€ç»„æŒ‡ä»¤ï¼ŒCPUä¸åœåœ°åƒè¿›æŒ‡ä»¤ã€æ‰§è¡Œæ‰§è¡Œï¼Œä¸èƒ½åŒæ—¶åƒè¿›ä¸¤ä¸ªæŒ‡ä»¤ï¼ˆåœ¨CPUä¸­ä½¿ç”¨æµæ°´çº¿ï¼Œå¯ä»¥ä¸€æ¬¡ç»™CPUå¡è¿›å¤šä¸ªæŒ‡ä»¤ï¼Œä½†è¿™äº›æŒ‡ä»¤è¿˜æ˜¯è¢«ä¸€æ¡ä¸€æ¡æ‰§è¡Œçš„ï¼Œä¸è¿‡CPUå¼‚å¸¸å¤æ‚ï¼Œä¸èƒ½ä¸€è¨€æ¦‚ä¹‹ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è¿™æ ·ç†è§£ï¼‰ã€‚</p>
<p>å°†è¿›ç¨‹çŠ¶æ€åˆ†ä¸º<code>Running</code>å’Œ<code>Not Running</code>æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œè¿›ç¨‹çš„çŠ¶æ€å–å†³äºè°ƒåº¦ç®—æ³•ï¼Œè°ƒåº¦ç®—æ³•çš„ç›®çš„æ˜¯åœ¨å…¼é¡¾æ•ˆç‡å’Œå…¬å¹³çš„æƒ…å†µä¸‹ï¼Œè®©æœ‰é™çš„CPUå¤„ç†è¿œè¶…è¿‡CPUæ•°é‡ã€å„ç§å„æ ·çš„è¿›ç¨‹ã€‚è°ƒåº¦ç®—æ³•è¶Šå¤æ‚ï¼Œè¿›ç¨‹çš„çŠ¶æ€å°±è¶Šå¤šã€‚</p>
<p>ç°åœ¨ï¼Œè¿›ç¨‹çš„çŠ¶æ€ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<pre><code>0. åˆšåˆ›å»ºï¼ŒBorn or forked
1. å¯è¿è¡ŒçŠ¶æ€ï¼ŒReady or Runnable
2. è¿è¡ŒçŠ¶æ€ï¼ŒRunning in User Or Running in Kernel
3. é˜»å¡çŠ¶æ€ï¼ŒBlocked
4. ç­‰å¾…çŠ¶æ€ï¼ŒWaiting
5. ç¡çœ çŠ¶æ€ï¼ŒSleeping
6. ç¡çœ çŠ¶æ€åˆå¯ä»¥åˆ†ä¸ºå¯ä¸­æ–­ï¼ˆ Interruptableï¼‰å’Œä¸å¯ä¸­æ–­ï¼ˆ Uninterruptable ï¼‰ä¸¤ç§çŠ¶æ€
7. ç¡è§‰çŠ¶æ€åˆ†ä¸ºé©»ç•™åœ¨å†…å­˜ä¸­å’Œè¢«äº¤æ¢åˆ°äº¤æ¢åˆ†åŒºä¸­ä¸¤ç§çŠ¶æ€
8. åƒµå°¸çŠ¶æ€ã€ç»ˆæ­¢çŠ¶æ€ï¼ŒTerminated or stopped
</code></pre>
<p>è¿›ç¨‹çŠ¶æ€æ˜¯<code>Runnable</code>ï¼Œè¡¨ç¤ºè¯¥è¿›ç¨‹ä¸‡äº‹å…·å¤‡ï¼Œåªç¼ºCPUï¼Œå¯ä»¥éšæ—¶è¢«CPUæ‰§è¡Œã€‚</p>
<p>è¿›ç¨‹çŠ¶æ€æ˜¯<code>Sleeping</code>ï¼Œè¡¨ç¤ºæ”¹è¿›ç¨‹éœ€è¦çš„ä¸€äº›èµ„æºéœ€è¦æ—¶é—´å‡†å¤‡ï¼Œè°ƒåº¦å™¨å°†åŸæœ¬è¢«å®ƒå ç”¨çš„CPUè°ƒåº¦ç»™<code>Runable</code>çŠ¶æ€çš„è¿›ç¨‹ï¼Œç›´åˆ°è¿›ç¨‹éœ€è¦çš„èµ„æºå‡†å¤‡å®Œæˆï¼Œé‡æ–°è¿›å…¥RunnableçŠ¶æ€ã€‚</p>
<p>ç”¨<code>ps -l</code>å¯ä»¥çœ‹åˆ°ç¡çœ çš„è¿›ç¨‹åœç•™åœ¨å“ªä¸ªå†…æ ¸å‡½æ•°ä¸Šï¼ˆ<code>WCHAN</code>å­—æ®µï¼‰ï¼ˆåœ¨åŠ ä¸Šå‚æ•°<code>-e</code>å¯ä»¥æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹ï¼‰ï¼š</p>
<pre><code class="language-bash">$ ps -l
F S   UID   PID  PPID  C PRI  NI ADDR SZ WCHAN  TTY          TIME CMD
4 S     0  7042  7040  0  80   0 - 28894 wait   pts/0    00:00:00 bash
0 R     0  7950  7042  0  80   0 - 34361 -      pts/0    00:00:00 ps
</code></pre>
<blockquote>
<p>WCHANï¼š name of the kernel function in which the process is sleeping, a &quot;-&quot; if the process is running, or a &quot;*&quot; if the process is multi-threaded and ps is not displaying threads.</p>
</blockquote>
<p>ç¡çœ çŠ¶æ€çš„è¿›ç¨‹åˆ†ä¸º<code>å¯ä¸­æ–­çš„</code>å’Œ<code>ä¸å¯ä¸­æ–­</code>çš„ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºå¯¹ä¿¡å·æˆ–è€…äº‹ä»¶çš„æ€åº¦ï¼Œå‰è€…åœ¨æ”¶åˆ°ä¿¡å·æˆ–è€…äº‹ä»¶åï¼Œè¿›ç¨‹ä¼šè·³å‡ºç¡çœ çŠ¶æ€ï¼Œåè€…ä¸ä¼šï¼Œåè€…è¦ç­‰åˆ°ç³»ç»Ÿè°ƒç”¨å®Œæˆåï¼Œæ‰ä¼šæ„ŸçŸ¥åˆ°ç¡çœ æœŸé—´çš„å‘ç”Ÿäº‹ä»¶ã€‚ <code>ä¸å¯ä¸­æ–­</code>çš„è¿›ç¨‹é€šå¸¸æ˜¯åœ¨è¿›è¡Œç£ç›˜ã€ç½‘ç»œI/Oæ“ä½œçš„è¿›ç¨‹ï¼Œå®ƒä»¬éœ€è¦ç­‰åˆ°è®¾å¤‡æ“ä½œå®Œæˆã€‚</p>
<p>è¿›ç¨‹è¿è¡Œç»“æŸé€€å‡ºåï¼Œåœ¨è¿›ç¨‹è¡¨ä¸­å ç”¨çš„ä½ç½®ç”±å®ƒçš„çˆ¶è¿›ç¨‹è´Ÿè´£é‡Šæ”¾ï¼Œåœ¨çˆ¶è¿›ç¨‹è¿˜æ²¡æœ‰é‡Šæ”¾å®ƒå ç”¨çš„ä½ç½®çš„æ—¶å€™ï¼Œè¿›ç¨‹å¤„äºåƒµå°¸çŠ¶æ€ã€‚</p>
<h2 id="æŸ¥æ‰¾çˆ¶è¿›ç¨‹"><a class="header" href="#æŸ¥æ‰¾çˆ¶è¿›ç¨‹">æŸ¥æ‰¾çˆ¶è¿›ç¨‹</a></h2>
<p>ç”¨pstreeå¯ä»¥ç›´æ¥å±•ç¤ºå‡ºä¸€ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œä»¥åŠçˆ¶è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œç›´åˆ°1å·ç»§æ‰¿ï¼Œ-a è¡¨ç¤ºè¾“å‡ºå‘½ä»¤è¡Œé€‰é¡¹ã€ p è¡¨ PIDã€s è¡¨ç¤ºæŒ‡å®šè¿›ç¨‹çš„çˆ¶è¿›ç¨‹</p>
<pre><code class="language-sh">$ pstree -aps 3084
systemd,1
  â””â”€dockerd,15006 -H fd://
      â””â”€docker-containe,15024 --config /var/run/docker/containerd/containerd.toml
          â””â”€docker-containe,3991 -namespace moby -workdir...
              â””â”€app,4009
                  â””â”€(app,3084)
</code></pre>
<p>pstreeå‘½ä»¤ä½äºrpmåŒ…psmiscä¸­ï¼š</p>
<pre><code class="language-sh">yum install -y psmisc
</code></pre>
<h2 id="å‚è€ƒ-142"><a class="header" href="#å‚è€ƒ-142">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxæŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å ç”¨çš„èµ„æº"><a class="header" href="#linuxæŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å ç”¨çš„èµ„æº">LinuxæŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å ç”¨çš„èµ„æº</a></h1>
<p>æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å ç”¨çš„èµ„æºã€‚</p>
<h2 id="pidstatæŸ¥çœ‹è¿›ç¨‹çš„cpuä½¿ç”¨ç‡-1"><a class="header" href="#pidstatæŸ¥çœ‹è¿›ç¨‹çš„cpuä½¿ç”¨ç‡-1">pidstatæŸ¥çœ‹è¿›ç¨‹çš„CPUä½¿ç”¨ç‡</a></h2>
<p><code>pidstat</code>å‘½ä»¤å¯ä»¥æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„åœ¨ä¸åŒCPUçŠ¶æ€ä¸­è€—è´¹çš„æ—¶é—´çš„ç™¾åˆ†æ¯”(1ï¼Œæ¯ç§’æ˜¾ç¤ºä¸€æ¬¡ï¼›-pï¼ŒæŒ‡å®šè¿›ç¨‹ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹)ï¼š</p>
<pre><code class="language-bash">$ pidstat  1 -p  27936
Linux 3.10.0-693.11.6.el7.x86_64 (10.10.64.58) 	12/04/2018 	_x86_64_	(4 CPU)

05:00:59 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
05:01:00 PM    99     27936    0.00    0.00    0.00    0.00     0  openresty
05:01:01 PM    99     27936    0.00    0.00    0.00    0.00     0  openresty
05:01:02 PM    99     27936    0.00    0.00    0.00    0.00     0  openresty
</code></pre>
<h2 id="pidstatæŸ¥çœ‹è¿›ç¨‹çš„ioæƒ…å†µ"><a class="header" href="#pidstatæŸ¥çœ‹è¿›ç¨‹çš„ioæƒ…å†µ">pidstatæŸ¥çœ‹è¿›ç¨‹çš„IOæƒ…å†µ</a></h2>
<p>pidstatï¼Œ<code>-d</code>è¡¨ç¤ºå±•ç¤ºIOä¿¡æ¯ï¼Œ1è¡¨ç¤ºæ¯ç§’è¾“å‡ºä¸€æ¬¡ï¼Œä½¿ç”¨-pæŒ‡å®šè¿›ç¨‹å·ï¼Œä¸‹é¢é—´éš” 1 ç§’è¾“å‡º 3 ç»„æ•°æ®ï¼š</p>
<pre><code class="language-sh">$ pidstat -d -p 4344 1 3
06:38:50      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
06:38:51        0      4344      0.00      0.00      0.00       0  app
06:38:52        0      4344      0.00      0.00      0.00       0  app
06:38:53        0      4344      0.00      0.00      0.00       0  app
</code></pre>
<h2 id="pidstatæŸ¥çœ‹è¿›ç¨‹çš„åˆ‡æ¢æƒ…å†µ"><a class="header" href="#pidstatæŸ¥çœ‹è¿›ç¨‹çš„åˆ‡æ¢æƒ…å†µ">pidstatæŸ¥çœ‹è¿›ç¨‹çš„åˆ‡æ¢æƒ…å†µ</a></h2>
<p><code>pidstat -w -p è¿›ç¨‹å·</code>å¯ä»¥æ˜¾ç¤ºæŒ‡å®šè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µï¼š</p>
<pre><code class="language-bash">$ pidstat -w 2 -p 426
Linux 4.20.12-1.el7.elrepo.x86_64 (10.10.64.58) 	04/29/2019 	_x86_64_	(4 CPU)

03:01:12 PM   UID       PID   cswch/s nvcswch/s  Command
03:01:14 PM    99       426      2.99      0.00  openresty
03:01:16 PM    99       426      2.50      0.00  openresty
03:01:18 PM    99       426      3.00      0.00  openresty
03:01:20 PM    99       426      2.00      0.00  openresty
</code></pre>
<p><code>-w</code>å‚æ•°çš„ä½œç”¨æ˜¯æ˜¾ç¤ºè¿›ç¨‹åˆ‡æ¢çŠ¶æ€ï¼Œæ¯ä¸€åˆ—çš„å«ä¹‰å¦‚ä¸‹ï¼ˆå¯ä»¥åœ¨<code>man pidstat</code>ä¸­æ‰¾åˆ°ï¼‰ï¼š</p>
<pre><code> -w     Report task switching activity (kernels 2.6.23 and later only).  
        The following values may be displayed:
  UID
         The real user identification number of the task being monitored.

  USER
         The name of the real user owning the task being monitored.

  PID
         The identification number of the task being monitored.

  cswch/s
         Total number of voluntary context switches the task made per second.  
         A voluntary context switch occurs when a task blocks because it requires 
         a resource that is unavailable.

  nvcswch/s
         Total number of non voluntary context switches the task made per second.  
         A involuntary context switch takes place when a task executes for the duration 
         of its  time  slice  and then is forced to relinquish the processor.

  Command
         The command name of the task.
</code></pre>
<p>éœ€è¦æ³¨æ„è‡ªæ„¿åˆ‡æ¢ï¼ˆcswch/sï¼Œvoluntary context switchesï¼‰å’Œéè‡ªæ„¿åˆ‡æ¢ï¼ˆnvcswch/sï¼Œnon voluntary context switchesï¼‰çš„åŒºåˆ«ã€‚å‰è€…æ˜¯å› ä¸ºéœ€è¦çš„èµ„æºæ²¡æœ‰å‡†å¤‡å¥½ï¼Œä¸»åŠ¨è®©å‡ºCPUå‘ç”Ÿçš„åˆ‡æ¢ï¼Œåè€…æ˜¯è¿›ç¨‹åˆ†é…çš„æ—¶é—´ç‰‡å·²ç»ç”¨å®Œï¼Œè¢«è°ƒåº¦å™¨å¼ºåˆ¶åˆ‡æ¢ã€‚</p>
<p>pidstats -wæ˜¾ç¤ºçš„æ˜¯è¿›ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœè¦å°†çº¿ç¨‹ä¸€å¹¶æ˜¾ç¤ºå‡ºæ¥ï¼Œéœ€è¦å†åŠ ä¸€ä¸ª-tå‚æ•°ï¼š</p>
<pre><code class="language-bash">$ pidstat -wt
Average:      UID      TGID       TID   cswch/s nvcswch/s  Command
Average:        0         3         -      3.92      0.00  ksoftirqd/0
Average:        0         -         3      3.92      0.00  |__ksoftirqd/0
Average:        0         9         -     45.59      0.00  rcu_sched
Average:        0         -         9     45.59      0.00  |__rcu_sched
Average:        0        13         -      1.96      0.00  ksoftirqd/1
Average:        0         -        13      1.96      0.00  |__ksoftirqd/1
Average:        0        17         -      0.49      0.00  migration/2
</code></pre>
<p>å¦å¤–pidstatè¿˜æœ‰ä¸€ä¸ª<code>-u</code>å‚æ•°ï¼Œå¯ä»¥ä¸€å¹¶è¾“å‡ºè¿›ç¨‹å’Œçº¿ç¨‹ï¼ˆåŠ -tï¼‰çš„CPUä½¿ç”¨æƒ…å†µï¼š</p>
<pre><code class="language-bash">[root@10.10.64.58 ~]#  pidstat -wt -u
Linux 3.10.0-693.11.6.el7.x86_64 (10.10.64.58) 	12/04/2018 	_x86_64_	(4 CPU)

04:21:56 PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command
04:21:56 PM     0         1         -    0.02    0.01    0.00    0.03     0  systemd
04:21:56 PM     0         -         1    0.02    0.01    0.00    0.03     0  |__systemd
04:21:56 PM     0         2         -    0.00    0.00    0.00    0.00     0  kthreadd
04:21:56 PM     0         -         2    0.00    0.00    0.00    0.00     0  |__kthreadd

04:21:56 PM   UID      TGID       TID   cswch/s nvcswch/s  Command
04:21:56 PM     0         1         -      1.75      0.00  systemd
04:21:56 PM     0         -         1      1.75      0.00  |__systemd
04:21:56 PM     0         2         -      0.01      0.00  kthreadd
04:21:56 PM     0         -         2      0.01      0.00  |__kthreadd
04:21:56 PM     0         3         -      2.53      0.00  ksoftirqd/0
</code></pre>
<h2 id="lsofæŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶"><a class="header" href="#lsofæŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶">lsofæŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶</a></h2>
<p>lsofæŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œ-pæŒ‡å®šè¿›ç¨‹å·ï¼Œæ³¨æ„å¿…é¡»æ˜¯è¿›ç¨‹å·ï¼Œä¸èƒ½æ˜¯çº¿ç¨‹å·ï¼š</p>
<pre><code class="language-sh">$ lsof -p 18940 
COMMAND   PID USER   FD   TYPE DEVICE  SIZE/OFF    NODE NAME 
python  18940 root  cwd    DIR   0,50      4096 1549389 / 
python  18940 root  rtd    DIR   0,50      4096 1549389 / 
â€¦ 
python  18940 root    2u   CHR  136,0       0t0       3 /dev/pts/0 
python  18940 root    3w   REG    8,1 117944320     303 /tmp/logtest.txt 
</code></pre>
<h2 id="straceæŸ¥çœ‹è¿›ç¨‹å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨"><a class="header" href="#straceæŸ¥çœ‹è¿›ç¨‹å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨">straceæŸ¥çœ‹è¿›ç¨‹å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨</a></h2>
<p>straceè·Ÿè¸ªè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ-f è¡¨ç¤ºè·Ÿè¸ªå­è¿›ç¨‹å’Œå­çº¿ç¨‹ï¼Œ-T è¡¨ç¤ºæ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿ï¼Œ-tt è¡¨ç¤ºæ˜¾ç¤ºè·Ÿè¸ªæ—¶é—´ï¼š</p>
<pre><code class="language-sh">$ strace -f -T -tt -p 9085
[pid  9085] 14:20:16.826131 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 65, NULL, 8) = 1 &lt;0.000055&gt;
[pid  9085] 14:20:16.826301 read(8, &quot;*2\r\n$3\r\nGET\r\n$41\r\nuuid:5b2e76cc-&quot;..., 16384) = 61 &lt;0.000071&gt;
[pid  9085] 14:20:16.826477 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000063&gt;
[pid  9085] 14:20:16.826645 write(8, &quot;$3\r\nbad\r\n&quot;, 9) = 9 &lt;0.000173&gt;
[pid  9085] 14:20:16.826907 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 65, NULL, 8) = 1 &lt;0.000032&gt;
[pid  9085] 14:20:16.827030 read(8, &quot;*2\r\n$3\r\nGET\r\n$41\r\nuuid:55862ada-&quot;..., 16384) = 61 &lt;0.000044&gt;
[pid  9085] 14:20:16.827149 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000043&gt;
[pid  9085] 14:20:16.827285 write(8, &quot;$3\r\nbad\r\n&quot;, 9) = 9 &lt;0.000141&gt;
[pid  9085] 14:20:16.827514 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 64, NULL, 8) = 1 &lt;0.000049&gt;
[pid  9085] 14:20:16.827641 read(8, &quot;*2\r\n$3\r\nGET\r\n$41\r\nuuid:53522908-&quot;..., 16384) = 61 &lt;0.000043&gt;
[pid  9085] 14:20:16.827784 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000034&gt;
[pid  9085] 14:20:16.827945 write(8, &quot;$4\r\ngood\r\n&quot;, 10) = 10 &lt;0.000288&gt;
[pid  9085] 14:20:16.828339 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 63, NULL, 8) = 1 &lt;0.000057&gt;
[pid  9085] 14:20:16.828486 read(8, &quot;*3\r\n$4\r\nSADD\r\n$4\r\ngood\r\n$36\r\n535&quot;..., 16384) = 67 &lt;0.000040&gt;
[pid  9085] 14:20:16.828623 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000052&gt;
[pid  9085] 14:20:16.828760 write(7, &quot;*3\r\n$4\r\nSADD\r\n$4\r\ngood\r\n$36\r\n535&quot;..., 67) = 67 &lt;0.000060&gt;
[pid  9085] 14:20:16.828970 fdatasync(7) = 0 &lt;0.005415&gt;
[pid  9085] 14:20:16.834493 write(8, &quot;:1\r\n&quot;, 4) = 4 &lt;0.000250&gt;
</code></pre>
<h2 id="å‚è€ƒ-143"><a class="header" href="#å‚è€ƒ-143">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linuxçš„æ–‡ä»¶ç³»ç»Ÿ"><a class="header" href="#linuxçš„æ–‡ä»¶ç³»ç»Ÿ">Linuxçš„æ–‡ä»¶ç³»ç»Ÿ</a></h1>
<p>IOé—®é¢˜æ’æŸ¥è¿‡ç¨‹ï¼š</p>
<p><img src="linux/../img/linux/io-trace.png" alt="IOé—®é¢˜æ’æŸ¥è¿‡ç¨‹" /></p>
<p>IOæŒ‡æ ‡ä¸å·¥å…·æ˜ å°„è¡¨ï¼š</p>
<p><img src="linux/../img/linux/io-metric-tool.png" alt="æŒ‡æ ‡å·¥å…·æ˜ å°„è¡¨" /></p>
<p><img src="linux/../img/linux/io-tool-metrics.png" alt="å·¥å…·æŒ‡æ ‡æ˜ å°„è¡¨" /></p>
<h2 id="å‚è€ƒ-144"><a class="header" href="#å‚è€ƒ-144">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linuxè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿvfs"><a class="header" href="#linuxè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿvfs">Linuxè™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS</a></h1>
<p>VFSæ˜¯linuxå®ç°çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œè§„å®šäº†æ•°æ®ç»“æ„å’Œæ¥å£è§„èŒƒã€‚</p>
<p><img src="linux/../img/linux/Linux-storage-stack-diagram_v4.10.png" alt="Linuxçš„å­˜å‚¨æ ˆ" /></p>
<p><a href="https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram">å›¾ç‰‡æ¥æº</a></p>
<h2 id="æ–‡ä»¶ç³»ç»Ÿå±‚"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿå±‚">æ–‡ä»¶ç³»ç»Ÿå±‚</a></h2>
<p>VFSå†…éƒ¨é€šè¿‡è¶…çº§å—ã€ç´¢å¼•èŠ‚ç‚¹ã€é€»è¾‘å—å’Œè¶…çº§å—ç­‰ç®¡ç†æ–‡ä»¶ã€‚</p>
<p><strong>è¶…çº§å—</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿæ•´ä½“æƒ…å†µï¼Œç´¢å¼•èŠ‚ç‚¹å’Œé€»è¾‘å—çš„ä½¿ç”¨æƒ…å†µã€‚</p>
<p><strong>é€»è¾‘å—</strong>ï¼šç£ç›˜æ‰‡åŒºæ„æˆçš„æœ€å°å­˜å‚¨å•å…ƒã€‚</p>
<p><strong>ç´¢å¼•èŠ‚ç‚¹</strong>ï¼šæ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œç´¢å¼•åˆ°å…·ä½“çš„æ–‡ä»¶æ•°æ®ã€‚</p>
<p><strong>ç›®å½•é¡¹</strong>ï¼šè®°å½•æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å’Œç›®å½•ã€ç›®å½•å’Œç›®å½•ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ç›®å½•é¡¹åªå­˜åœ¨äºå†…å­˜ä¸­ï¼Œè¶…çº§å—ã€é€»è¾‘å—å’Œç´¢å¼•èŠ‚ç‚¹æ˜¯ç£ç›˜ä¸­çš„æŒä¹…åŒ–æ•°æ®ï¼Œç›®å½•é¡¹çš„å†…å®¹æ˜¯ä»ç£ç›˜ä¸­è¯»å–åŠ è½½çš„ã€‚</p>
<h2 id="é€šç”¨å—å±‚"><a class="header" href="#é€šç”¨å—å±‚">é€šç”¨å—å±‚</a></h2>
<p>åœ¨æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜é©±åŠ¨ä¹‹é—´è¿˜æœ‰ä¸€ä¸ªå—è®¾å¤‡æŠ½è±¡å±‚ï¼Œè¯¥å±‚å‘ä¸Šæä¾›äº†ç»Ÿä¸€çš„å—è®¾å¤‡æ ‡å‡†æ¥å£ï¼Œå‘ä¸‹å…¼å®¹å„ç§ç±»å‹çš„ç£ç›˜ï¼ŒåŒæ—¶è´Ÿè´£å¯¹æ–‡ä»¶ç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºå‘é€è¿‡æ¥çš„I/Oè¯·æ±‚æ’é˜Ÿï¼Œç”¨é‡æ’ã€åˆå¹¶ç­‰æ–¹å¼ï¼Œæé«˜ç£ç›˜è¯»å†™æ•ˆç‡ï¼Œä¹Ÿå°±æ˜¯I/Oè°ƒåº¦ã€‚</p>
<p>Linuxæ”¯æŒå››ç§I/Oè°ƒåº¦ç­–ç•¥ï¼š</p>
<p><strong>NONE</strong>ï¼šä¸è°ƒåº¦ã€‚</p>
<p><strong>NOOP</strong>ï¼šå…ˆå…¥å…ˆå‡ºï¼ŒåªåšåŸºæœ¬çš„è¯·æ±‚åˆå¹¶ï¼Œå¸¸ç”¨äºSSDã€‚</p>
<p><strong>CFQ</strong>ï¼šé»˜è®¤ç­–ç•¥ï¼Œå…¬å¹³è°ƒåº¦ï¼Œæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªI/Oè°ƒåº¦é˜Ÿåˆ—ï¼ŒæŒ‰ç…§æ—¶é—´ç‰‡å‡åŒ€åˆ†å¸ƒæ¯ä¸ªè¿›ç¨‹çš„I/Oè¯·æ±‚ã€‚</p>
<p><strong>DealLine</strong>ï¼šè¯»ã€å†™ä¸¤ä¸ªI/Oé˜Ÿåˆ—ï¼Œè·ç¦»æˆªæ­¢æ—¶é—´æœ€è¿‘çš„è¯·æ±‚è¢«ä¼˜å…ˆå¤„ç†ï¼Œå¯ä»¥æé«˜æœºæ¢°ç£ç›˜çš„ååé‡ï¼Œé€šå¸¸ç”¨åœ¨å‹åŠ›è¾ƒé‡çš„åœºæ™¯ï¼Œä¾‹å¦‚æ•°æ®åº“ã€‚</p>
<h2 id="è®¾å¤‡å±‚"><a class="header" href="#è®¾å¤‡å±‚">è®¾å¤‡å±‚</a></h2>
<p>é©±åŠ¨ç¨‹åºå’Œç‰©ç†è®¾å¤‡ï¼Œè´Ÿè´£ç‰©ç†è®¾å¤‡ä¸Šæœ€ç»ˆçš„I/Oæ“ä½œã€‚</p>
<h2 id="å‚è€ƒ-145"><a class="header" href="#å‚è€ƒ-145">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç£ç›˜ç›¸å…³çŸ¥è¯†"><a class="header" href="#ç£ç›˜ç›¸å…³çŸ¥è¯†">ç£ç›˜ç›¸å…³çŸ¥è¯†</a></h1>
<p>æœºæ¢°ç£ç›˜ï¼Œé€šå¸¸ç¼©å†™ä¸ºHDDï¼Œæœºæ¢°ç£ç›˜æœ‰ç£é“å¯»å€çš„æ—¶é—´ï¼Œéšæœºè¯»å†™æ˜¯æ€§èƒ½ä¼šå˜å·®ã€‚</p>
<p>å›ºæ€ç£ç›˜ï¼Œé€šå¸¸ç¼©å†™ä¸ºSSDï¼Œä¸éœ€è¦å¯»é“ï¼Œéšæœºè¯»å†™å’Œè¿ç»­è¯»å†™æ•ˆç‡å‡è¾ƒé«˜ã€‚</p>
<p>ç£ç›˜æ¥å£ä¸»è¦æœ‰ï¼šIDEã€SCSIã€SASã€SATAã€FCç­‰ã€‚</p>
<p>åœ¨å…·ä½“ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥å°†ç£ç›˜ä½œä¸ºç‹¬ç«‹ç£ç›˜ç”¨ï¼Œåœ¨æ¯ä¸ªç£ç›˜ä¸Šåˆ’åˆ†é€»è¾‘åˆ†åŒºï¼Œæˆ–è€…å°†å¤šä¸ªç‹¬ç«‹ç£ç›˜ç»„åˆæˆä¸€ä¸ªé€»è¾‘ç£ç›˜ï¼Œè­¬å¦‚RAIDï¼ŒRAIDåˆ†ä¸ºRAID0ã€RAID1ã€RAID5ã€RAID10ï¼Œæˆ–è€…å°†ç£ç›˜ç»„åˆæˆä¸€ä¸ªå­˜å‚¨é›†ç¾¤ï¼Œé€šè¿‡NFSã€SMBã€iSCSIç­‰ç½‘ç»œå­˜å‚¨åè®®æ¥å…¥æœåŠ¡å™¨ã€‚</p>
<p>ç£ç›˜è¢«Linuxè®¤ä½œæ˜¯å—è®¾å¤‡ï¼Œæ‹¥æœ‰ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼Œä¸»è®¾å¤‡å·ç”¨äºåŒºåˆ†è®¾å¤‡ç±»å‹ï¼Œé¢å‘é©±åŠ¨ç¨‹åºï¼Œæ¬¡è®¾å¤‡å·æ˜¯åŒç±»è®¾å¤‡çš„å”¯ä¸€ç¼–å·ã€‚</p>
<h2 id="ç£ç›˜æ•°æ®æœ€å°è¯»å–å•ä½"><a class="header" href="#ç£ç›˜æ•°æ®æœ€å°è¯»å–å•ä½">ç£ç›˜æ•°æ®æœ€å°è¯»å–å•ä½</a></h2>
<p>æœºæ¢°ç£ç›˜çš„æœ€å°è¯»å–å•ä½æ˜¯æ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒºä¸€èˆ¬ä¸º512å­—èŠ‚ã€‚</p>
<p>å›ºæ€ç£ç›˜çš„æœ€å°è¯»å–å•ä½æ˜¯é¡µï¼Œé€šå¸¸æ˜¯4KBã€8KBã€‚</p>
<h2 id="ç£ç›˜æ•°æ®æœ€å°ç®¡ç†å•ä½"><a class="header" href="#ç£ç›˜æ•°æ®æœ€å°ç®¡ç†å•ä½">ç£ç›˜æ•°æ®æœ€å°ç®¡ç†å•ä½</a></h2>
<p>é€»è¾‘å—æ˜¯ç£ç›˜ä¸Šè¿ç»­çš„æ‰‡åŒºæˆ–è€…é¡µï¼Œé€»è¾‘å—æ˜¯ç£ç›˜æ•°æ®çš„æœ€å°ç®¡ç†å•ä½ã€‚</p>
<h2 id="ç£ç›˜æ€§èƒ½æŒ‡æ ‡"><a class="header" href="#ç£ç›˜æ€§èƒ½æŒ‡æ ‡">ç£ç›˜æ€§èƒ½æŒ‡æ ‡</a></h2>
<p><strong>ä½¿ç”¨ç‡</strong>ï¼šç£ç›˜å¤„ç†I/Oçš„æ—¶é—´å æ¯”ï¼Œä½¿ç”¨ç‡è¿‡é«˜è¶…è¿‡80%ï¼Œè¯´æ˜ç£ç›˜I/Oå­˜åœ¨æ€§èƒ½ç“¶é¢ˆã€‚</p>
<p><strong>é¥±å’Œåº¦</strong>ï¼šç£ç›˜å¤„ç†I/Oçš„ç¹å¿™ç¨‹åº¦ï¼Œé¥±å’Œåº¦ä¸º100%æ—¶ï¼Œç£ç›˜å·²ç»æ— æ³•æ¥æ”¶æ–°çš„I/Oè¯·æ±‚ã€‚</p>
<p><strong>IOPS</strong>ï¼šæ¯ç§’é’Ÿçš„I/Oæ“ä½œæ¬¡æ•°ã€‚</p>
<p><strong>ååé‡</strong>ï¼šæ¯ç§’çš„æ•°æ®ååé‡ã€‚</p>
<p><strong>å“åº”æ—¶é—´</strong>ï¼šI/Oè¯·æ±‚å‘å‡ºä¸æ”¶åˆ°å“åº”çš„é—´éš”æ—¶é—´ã€‚</p>
<p>ç£ç›˜ä½¿ç”¨ç‡é«˜ä¸ç­‰äºç£ç›˜é¥±å’Œï¼Œå¦‚æœæ¯æ¬¡I/Oæ“ä½œçš„æ•°æ®é‡å¾ˆå°‘ï¼Œç£ç›˜çš„ä½¿ç”¨ç‡é«˜ï¼Œä½†æ˜¯é¥±å’Œåº¦ä¸é«˜ï¼Œå¯ä»¥ç»§ç»­æ¥æ”¶æ–°çš„I/Oè¯·æ±‚ã€‚(æ„Ÿè§‰é¥±å’Œåº¦æœ‰ç‚¹ç±»ä¼¼äºå¸¦å®½å æ¯”ï¼Œæ˜¯å’Œååé‡ç›¸å…³çš„)</p>
<h2 id="ç£ç›˜æ€§èƒ½æµ‹è¯•å·¥å…·"><a class="header" href="#ç£ç›˜æ€§èƒ½æµ‹è¯•å·¥å…·">ç£ç›˜æ€§èƒ½æµ‹è¯•å·¥å…·</a></h2>
<p>fioï¼Œæµ‹è¯•æ—¶éœ€è¦è€ƒè™‘ä¸åŒI/Oå¤§å°ã€éšæœºè¯»ã€é¡ºåºè¯»ã€éšæœºå†™ã€é¡ºåºå†™ç­‰ã€‚</p>
<h2 id="å‚è€ƒ-146"><a class="header" href="#å‚è€ƒ-146">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="æŸ¥çœ‹linuxæ–‡ä»¶ç³»ç»ŸçŠ¶æ€"><a class="header" href="#æŸ¥çœ‹linuxæ–‡ä»¶ç³»ç»ŸçŠ¶æ€">æŸ¥çœ‹Linuxæ–‡ä»¶ç³»ç»ŸçŠ¶æ€</a></h1>
<h2 id="å¯ç”¨ç©ºé—´"><a class="header" href="#å¯ç”¨ç©ºé—´">å¯ç”¨ç©ºé—´</a></h2>
<p>å¯ç”¨ç©ºé—´ï¼Œç”¨<code>df</code>æŸ¥çœ‹ï¼Œå¯ç”¨inodeï¼Œç”¨<code>df -i</code>æŸ¥çœ‹ã€‚</p>
<pre><code class="language-sh"># df -h
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        3.9G     0  3.9G   0% /dev
tmpfs           3.9G  4.0K  3.9G   1% /dev/shm
tmpfs           3.9G  452K  3.9G   1% /run
tmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup
/dev/vda1        20G   14G  6.8G  67% /
/dev/vdb        100G   64G   37G  64% /data
tmpfs           798M     0  798M   0% /run/user/0
</code></pre>
<pre><code class="language-sh"># df -ih
Filesystem     Inodes IUsed IFree IUse% Mounted on
devtmpfs         995K   360  994K    1% /dev
tmpfs            998K     2  998K    1% /dev/shm
tmpfs            998K   447  997K    1% /run
tmpfs            998K    17  998K    1% /sys/fs/cgroup
/dev/vda1         20M  231K   20M    2% /
/dev/vdb          50M  1.8M   49M    4% /data
tmpfs            998K     1  998K    1% /run/user/0
</code></pre>
<h2 id="é¡µé¢ç¼“å­˜å’Œslabç¼“å­˜"><a class="header" href="#é¡µé¢ç¼“å­˜å’Œslabç¼“å­˜">é¡µé¢ç¼“å­˜å’Œslabç¼“å­˜</a></h2>
<p>é¡µç¼“å­˜å’Œå¯å›æ”¶çš„slabç¼“å­˜ï¼š</p>
<pre><code class="language-sh">$ cat /proc/meminfo | grep -E &quot;SReclaimable|Cached&quot; 
Cached:           748316 kB     #é¡µç¼“å­˜ï¼Œç¼“å­˜ç£ç›˜çš„ä¸Šçš„æ–‡ä»¶ï¼Œä¸åŒ…æ‹¬swap
SwapCached:            0 kB     #å·²ç»è¢«ä»swapå¬å›ï¼Œä½†æ˜¯è¿˜åœ¨swapæ–‡ä»¶ä¸­çš„å†…å­˜é¡µ
SReclaimable:     179508 kB     #å¯å›æ”¶çš„slab
</code></pre>
<h2 id="inodeå’Œæ–‡ä»¶ç›®å½•é¡¹çš„ç¼“å­˜æƒ…å†µ"><a class="header" href="#inodeå’Œæ–‡ä»¶ç›®å½•é¡¹çš„ç¼“å­˜æƒ…å†µ">inodeå’Œæ–‡ä»¶ç›®å½•é¡¹çš„ç¼“å­˜æƒ…å†µ</a></h2>
<p>inodeå’Œæ–‡ä»¶ç›®å½•é¡¹çš„ç¼“å­˜æƒ…å†µï¼š</p>
<pre><code class="language-sh">$ cat /proc/slabinfo | grep -E '^#|dentry|inode' 
# name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt; 
xfs_inode              0      0    960   17    4 : tunables    0    0    0 : slabdata      0      0      0 
... 
ext4_inode_cache   32104  34590   1088   15    4 : tunables    0    0    0 : slabdata   2306   2306      0hugetlbfs_inode_cache     13     13    624   13    2 : tunables    0    0    0 : slabdata      1      1      0 
sock_inode_cache    1190   1242    704   23    4 : tunables    0    0    0 : slabdata     54     54      0 
shmem_inode_cache   1622   2139    712   23    4 : tunables    0    0    0 : slabdata     93     93      0 
proc_inode_cache    3560   4080    680   12    2 : tunables    0    0    0 : slabdata    340    340      0 
# vfsç´¢å¼•èŠ‚ç‚¹ç¼“å­˜
inode_cache        25172  25818    608   13    2 : tunables    0    0    0 : slabdata   1986   1986      0 
# dentryæ˜¯ç›®å½•é¡¹
dentry             76050 121296    192   21    1 : tunables    0    0    0 : slabdata   5776   5776      0 
</code></pre>
<p>å…·ä½“å«ä¹‰è§<code>man slabinfo</code>ï¼Œslabtopå¯ä»¥æ›´å¥½çš„å±•ç°slabçŠ¶æ€ï¼š</p>
<pre><code class="language-sh">Active / Total Objects (% used)    : 743718 / 794177 (93.6%)
Active / Total Slabs (% used)      : 26434 / 26434 (100.0%)
Active / Total Caches (% used)     : 103 / 138 (74.6%)
Active / Total Size (% used)       : 179223.89K / 191460.80K (93.6%)
Minimum / Average / Maximum Object : 0.01K / 0.24K / 8.00K

OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME
211260 205043  97%    0.19K  10060	 21     40240K dentry
 49344  48896  99%    0.06K    771	 64	 3084K anon_vma_chain
 42752  42752 100%    0.02K    167	256	  668K kmalloc-16
 38656  30327  78%    0.03K    302	128	 1208K kmalloc-32
 36352  29070  79%    0.01K     71	512	  284K kmalloc-8
...
</code></pre>
<h2 id="ç£ç›˜åˆ†åŒº"><a class="header" href="#ç£ç›˜åˆ†åŒº">ç£ç›˜åˆ†åŒº</a></h2>
<p>ç”¨<code>parted</code>æŸ¥çœ‹ç£ç›˜åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿï¼š</p>
<pre><code class="language-bash">$ parted /dev/vdb
GNU Parted 3.1
Using /dev/vdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) print
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 107GB
Sector size (logical/physical): 512B/512B
Partition Table: loop
Disk Flags:

Number  Start  End    Size   File system  Flags
 1      0.00B  107GB  107GB  xfs

(parted)
</code></pre>
<h2 id="å‚è€ƒ-147"><a class="header" href="#å‚è€ƒ-147">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxç³»ç»Ÿä¸­çš„io"><a class="header" href="#linuxç³»ç»Ÿä¸­çš„io">Linuxç³»ç»Ÿä¸­çš„I/O</a></h1>
<p>I/Oæ“ä½œåˆ†ä¸ºï¼šç¼“å†²ä¸éç¼“å†²I/Oã€ç›´æ¥ä¸éç›´æ¥I/Oã€é˜»å¡ä¸éé˜»å¡I/Oã€åŒæ­¥ä¸å¼‚æ­¥I/Oã€‚</p>
<h2 id="å¦ä½¿ç”¨æ ‡å‡†åº“ç¼“å­˜ç¼“å†²ä¸éç¼“å†²io"><a class="header" href="#å¦ä½¿ç”¨æ ‡å‡†åº“ç¼“å­˜ç¼“å†²ä¸éç¼“å†²io">å¦ä½¿ç”¨æ ‡å‡†åº“ç¼“å­˜ï¼šç¼“å†²ä¸éç¼“å†²I/O</a></h2>
<p>æ ‡å‡†åº“å¯¹å¤–æä¾›I/Oæ“ä½œæ¥å£ï¼Œè‡ªèº«åˆ™æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶ã€‚æ ‡å‡†åº“çš„å®ç°ä¸­ä¼šä½¿ç”¨ä¸€äº›ç¼“å­˜æœºåˆ¶ï¼Œä½¿ç”¨äº†æ ‡å‡†åº“ç¼“å­˜çš„I/Oæ“ä½œæ˜¯ <strong>ç¼“å†²I/O</strong>ï¼Œç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›è¡Œçš„I/Oæ“ä½œæ˜¯ <strong>éç¼“å†²I/O</strong>ã€‚</p>
<h2 id="æ˜¯å¦ä½¿ç”¨ç³»ç»Ÿçš„é¡µç¼“å­˜ç›´æ¥ä¸éç›´æ¥io"><a class="header" href="#æ˜¯å¦ä½¿ç”¨ç³»ç»Ÿçš„é¡µç¼“å­˜ç›´æ¥ä¸éç›´æ¥io">æ˜¯å¦ä½¿ç”¨ç³»ç»Ÿçš„é¡µç¼“å­˜ï¼šç›´æ¥ä¸éç›´æ¥I/O</a></h2>
<p>æ“ä½œç³»ç»Ÿä¹Ÿä¼šæœ‰ç¼“å­˜ï¼Œè·³è¿‡æ“ä½œç³»ç»Ÿé¡µç¼“å­˜çš„I/Oæ“ä½œæ˜¯ <strong>ç›´æ¥I/O</strong>ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨æ—¶è¦æŒ‡å®š<code>O_DIRECT</code>æ ‡å¿—ã€‚</p>
<p>æ–‡ä»¶è¯»å†™æ—¶ï¼Œå…ˆç»è¿‡ç³»ç»Ÿé¡µç¼“å­˜ã€ç„¶ååœ¨é€šè¿‡ç³»ç»Ÿè°ƒç”¨è½å®åˆ°ç£ç›˜ï¼Œè¿™æ ·çš„I/Oæ“ä½œæ˜¯ <strong>éç›´æ¥I/O</strong>ã€‚</p>
<p>åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸­ï¼Œè­¬å¦‚æ•°æ®åº“ï¼Œä¼šè¿æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸€èµ·è·³è¿‡ï¼Œç›´æ¥è¯»å†™ç£ç›˜ï¼Œ è¿™ç§æ“ä½œé€šå¸¸ç§°ä¸º <strong>è£¸I/O</strong>ã€‚</p>
<h2 id="ç¨‹åºæ˜¯å¦é˜»å¡è‡ªèº«è¿è¡Œé˜»å¡å’Œéé˜»å¡io"><a class="header" href="#ç¨‹åºæ˜¯å¦é˜»å¡è‡ªèº«è¿è¡Œé˜»å¡å’Œéé˜»å¡io">ç¨‹åºæ˜¯å¦é˜»å¡è‡ªèº«è¿è¡Œï¼šé˜»å¡å’Œéé˜»å¡I/O</a></h2>
<p>å¦‚æœç¨‹åºè¦ç­‰æ”¶åˆ°I/Oæ“ä½œç»“æœåï¼Œæ‰ç»§ç»­æ‰§è¡Œï¼Œè¿™æ˜¯ <strong>é˜»å¡I/O</strong>ã€‚</p>
<p>å¦‚æœç¨‹åºå‘èµ·I/Oæ“ä½œåï¼Œä¸ç­‰ç»“æœè¿”å›ç»§ç»­æ‰§è¡Œå…¶å®ƒæ“ä½œï¼Œä»¥è½®è¯¢æˆ–è€…äº‹ä»¶çš„æ–¹å¼è·å¾—I/Oæ“ä½œç»“æœï¼Œ
è¿™æ˜¯ <strong>éé˜»å¡I/O</strong>ã€‚</p>
<h2 id="ç¨‹åºæ˜¯å¦ç­‰å¾…å“åº”ç»“æœåŒæ­¥å’Œå¼‚æ­¥io"><a class="header" href="#ç¨‹åºæ˜¯å¦ç­‰å¾…å“åº”ç»“æœåŒæ­¥å’Œå¼‚æ­¥io">ç¨‹åºæ˜¯å¦ç­‰å¾…å“åº”ç»“æœï¼šåŒæ­¥å’Œå¼‚æ­¥I/O</a></h2>
<p>å‘èµ·I/Oæ“ä½œï¼Œéœ€è¦ç­‰æ•´ä¸ªI/Oå®Œæˆåæ‰è¿”å›å“åº”ï¼Œè¿™æ˜¯ <strong>åŒæ­¥I/O</strong>ã€‚</p>
<p>å‘èµ·I/Oæ“ä½œï¼Œä¸éœ€è¦ç­‰æ•´ä¸ªI/Oå®Œæˆï¼ŒI/Oæ“ä½œç»“æŸåï¼Œå“åº”ä»¥äº‹ä»¶çš„å½¢å¼é€šçŸ¥è°ƒç”¨è€…ï¼Œè¿™æ˜¯ <strong>å¼‚æ­¥I/O</strong>ã€‚</p>
<p>æ“ä½œæ–‡ä»¶æ—¶ï¼Œå¦‚æœè®¾ç½®äº†<code>O_DSYNC</code>æˆ–è€…<code>O_SYNC</code>æ ‡å¿—ï¼Œè¡¨ç¤ºåŒæ­¥I/Oï¼Œå‰è€…è¦ç­‰æ–‡ä»¶å†™å…¥ç£ç›˜ä»¥åæ‰è¿”å›ï¼Œåè€…è¦åœ¨å‰è€…çš„åŸºç¡€ï¼Œç»§ç»­ç­‰å¾…æ–‡ä»¶çš„å…ƒæ•°æ®å†™å…¥ç£ç›˜åå†è¿”å›ã€‚</p>
<p>æ“ä½œç®¡é“æˆ–è€…Socketæ—¶ï¼Œå¦‚æœè®¾ç½®äº†<code>O_ASYNC</code>ï¼Œè¡¨ç¤ºå¼‚æ­¥I/Oï¼Œå½“æ–‡ä»¶å¯è¯»å†™æ—¶ï¼Œå†…æ ¸å‘é€<code>SIGIO</code>æˆ–è€…<code>SIGPOLL</code>ã€‚</p>
<h2 id="å‚è€ƒ-148"><a class="header" href="#å‚è€ƒ-148">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxç³»ç»Ÿçš„ioçŠ¶æ€"><a class="header" href="#linuxç³»ç»Ÿçš„ioçŠ¶æ€">Linuxç³»ç»Ÿçš„IOçŠ¶æ€</a></h1>
<h2 id="dstatæŸ¥çœ‹ç³»ç»Ÿæ•´ä½“ioçŠ¶æ€"><a class="header" href="#dstatæŸ¥çœ‹ç³»ç»Ÿæ•´ä½“ioçŠ¶æ€">dstatæŸ¥çœ‹ç³»ç»Ÿæ•´ä½“IOçŠ¶æ€</a></h2>
<p>dstatåŒæ—¶å±•ç¤ºCPUã€ç£ç›˜IOå’Œç½‘ç»œIOçš„çŠ¶æ€ï¼Œä»¥åŠç³»ç»Ÿä¸­æ–­ã€å†…å­˜æ¢é¡µå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ•°é‡ï¼Œç”¨yumç›´æ¥å®‰è£…å³å¯ï¼š</p>
<pre><code class="language-sh">yum install -y dstat
</code></pre>
<p>dstatçš„è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼Œ1è¡¨ç¤ºæ¯1ç§’è¾“å‡ºä¸€æ¬¡ï¼Œ10è¡¨ç¤ºä¸€å…±è¾“å‡º10ç»„æ•°æ®ï¼š</p>
<p><img src="linux/../img/linux/dstat.png" alt="dstatè¾“å‡º" /></p>
<h2 id="iostatæŸ¥çœ‹ç£ç›˜è®¾å¤‡ioçŠ¶æ€"><a class="header" href="#iostatæŸ¥çœ‹ç£ç›˜è®¾å¤‡ioçŠ¶æ€">iostatæŸ¥çœ‹ç£ç›˜è®¾å¤‡IOçŠ¶æ€</a></h2>
<p>iostatå‘ˆç°çš„æ•°æ®æ¥è‡ª<code>/proc/diskstats</code>ï¼Œ<code>-d -x</code> æ˜¾ç¤ºæ‰€æœ‰ç£ç›˜çš„I/Oæƒ…å†µã€‚</p>
<pre><code class="language-sh">$ iostat -d -x 1
Device:    rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda          0.00     0.01    0.43    0.19    74.76     1.59   243.28     0.06    4.63    1.67   11.27  97.45   6.12
vdb          0.00     0.00    0.72    0.01   146.07     0.19   402.12     0.00    1.43    1.26   11.25   0.15   0.01

Device:    rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda          0.00     0.00    1.00    0.00     8.00     0.00    16.00     0.00    4.00    4.00    0.00   4.00   0.40
vdb          0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

Device:    rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda          0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdb          0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
</code></pre>
<p>rrqm/sï¼šæ¯ç§’åˆå¹¶è¯»è¯·æ±‚æ•°</p>
<p>r/sï¼šæ¯ç§’å‘é€ç»™ç£ç›˜çš„è¯»è¯·æ±‚æ•°ï¼ˆåˆå¹¶åï¼‰ </p>
<p>rkB/sï¼šæ¯ç§’ä»ç£ç›˜è¯»å–çš„æ•°æ®é‡ï¼Œå•ä½KB</p>
<p>r_awaitï¼šè¯»å“åº”æ—¶é—´ï¼Œå•ä½æ¯«ç§’</p>
<p>wrqm/sï¼š åˆå¹¶å†™è¯·æ±‚é€Ÿç‡</p>
<p>w/sï¼šæ¯ç§’å‘é€ç»™ç£ç›˜çš„å†™è¯·æ±‚æ•°ï¼ˆåˆå¹¶åï¼‰</p>
<p>wkB/sï¼šæ¯ç§’å‘ç£ç›˜å†™å…¥çš„æ•°æ®é‡ï¼Œå•ä½KB</p>
<p>w_awaitï¼šå†™å“åº”æ—¶é—´ï¼Œå•ä½æ¯«ç§’</p>
<p>avgqu-sz/aqu-szï¼šå¹³å‡è¯·æ±‚é˜Ÿåˆ—é•¿åº¦</p>
<p>svctmï¼š æ¨æ–­çš„å¤„ç†I/Oè¯·æ±‚éœ€è¦çš„å¹³å‡æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</p>
<p>%utilï¼šç£ç›˜å¤„ç†I/Oçš„æ—¶é—´å æ¯”ï¼Œå³ä½¿ç”¨ç‡ï¼Œä½¿ç”¨ç‡100%ï¼Œè¯´æ˜I/Oæ“ä½œå¤šï¼ˆä¸ç­‰äºç£ç›˜é¥±å’Œï¼Œé¥±å’Œæ˜¯ä¸èƒ½å†æ¥æ”¶æ–°çš„è¯»å†™)</p>
<h2 id="filetopæŸ¥çœ‹è¯»å†™é¢‘ç¹çš„æ–‡ä»¶"><a class="header" href="#filetopæŸ¥çœ‹è¯»å†™é¢‘ç¹çš„æ–‡ä»¶">filetopæŸ¥çœ‹è¯»å†™é¢‘ç¹çš„æ–‡ä»¶</a></h2>
<p>filetopæ˜¯ä¸€ä¸ªbccå·¥å…·ç®±ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼ˆbccç³»åˆ—å·¥å…·è§<a href="linux/chapter1/04-bcc-tools.html">BCCç³»åˆ—å·¥å…·</a>ï¼‰ï¼Œå®ƒèƒ½å¤ŸåŠ¨æ€å±•ç¤ºæ–‡ä»¶çš„è¯»å†™æƒ…å†µï¼Œç”±é«˜åˆ°ä½æ’åºã€‚</p>
<p>åœ¨CentOSä¸Šç”¨yumå®‰è£…bcc-toolsï¼š</p>
<pre><code class="language-sh">yum install -y bcc-toolsã€‚
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯bccå‘½ä»¤è¢«å®‰è£…åœ¨/usr/share/bcc/tools/ç›®å½•ä¸­ï¼Œè¯¥ç›®å½•é»˜è®¤ä¸åœ¨$PATHä¸­ã€‚å¦å¤–ï¼Œå¦‚æœå†…æ ¸ç‰ˆæœ¬ä¸æ”¯æŒebpfï¼Œbcc-toolsä¸­çš„æœ‰äº›å‘½ä»¤ä½¿ç”¨çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚filetopåœ¨ä¸æ”¯æŒebpfçš„å†…æ ¸ä¸Šå¯ä»¥å·¥ä½œã€‚</p>
<pre><code>$ /usr/share/bcc/tools/filetop    
$ /usr/share/bcc/tools/filetop -C   # åˆ·æ–°æ•°æ®å‰ä¸æ¸…é™¤å±å¹•ï¼Œè¿™æ ·å¯ä»¥çœ‹åˆ°å˜åŒ–æƒ…å†µ
</code></pre>
<p><img src="linux/../img/linux/filetop.png" alt="filetopè¾“å‡º" /></p>
<h2 id="opensnoopè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨open"><a class="header" href="#opensnoopè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨open">opensnoopè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨open</a></h2>
<p>opensnoopä¹Ÿæ˜¯bccå·¥å…·ç®±ä¸­çš„ä¸€ä¸ªï¼Œç”¨æ¥è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨openï¼Œæ˜¾ç¤ºè¢«æ‰“å¼€çš„æ–‡ä»¶ï¼š</p>
<p><img src="linux/../img/linux/opensnoop.png" alt="opensnoop" /></p>
<h2 id="iotopæŸ¥çœ‹è¿›ç¨‹ioæ’è¡Œ"><a class="header" href="#iotopæŸ¥çœ‹è¿›ç¨‹ioæ’è¡Œ">iotopæŸ¥çœ‹è¿›ç¨‹I/Oæ’è¡Œ</a></h2>
<p>iotopåŠ¨æ€æ˜¾ç¤ºæ¯ä¸ªçº¿ç¨‹çš„IOæ“ä½œæƒ…å†µï¼Œç”±é«˜åˆ°åº•æ’åºï¼š</p>
<pre><code class="language-bash">Total DISK READ :	0.00 B/s | Total DISK WRITE :      11.28 K/s
Actual DISK READ:	0.00 B/s | Actual DISK WRITE:       0.00 B/s
  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND
  329 be/4 nobody      0.00 B/s    3.76 K/s  0.00 %  0.00 % nginx: worker process
  446 be/4 root        0.00 B/s    7.52 K/s  0.00 %  0.00 % systemd-journald
12800 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % dockerd
    1 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % systemd --switched-root --system --deserialize 21
    2 be/4 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [kthreadd]
    3 be/0 root        0.00 B/s    0.00 B/s  0.00 %  0.00 % [rcu_gp]
</code></pre>
<h2 id="pidstatæŸ¥çœ‹è¿›ç¨‹çš„ioçŠ¶æ€"><a class="header" href="#pidstatæŸ¥çœ‹è¿›ç¨‹çš„ioçŠ¶æ€">pidstatæŸ¥çœ‹è¿›ç¨‹çš„I/OçŠ¶æ€</a></h2>
<p>pidstatï¼Œ<code>-d</code>è¡¨ç¤ºå±•ç¤ºIOä¿¡æ¯ï¼Œ1è¡¨ç¤ºæ¯ç§’è¾“å‡ºä¸€æ¬¡ï¼š</p>
<pre><code class="language-bash">$ pidstat -d 1 
13:39:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s     iodelay  Command 
13:39:52      102       916      0.00      4.00      0.00           0  rsyslogd
                               æ¯ç§’è¯»    æ¯ç§’å†™  æ¯ç§’å–æ¶ˆçš„å†™ I/Oå»¶è¿Ÿ
                               å•ä½KB    å•ä½KB  å•ä½KB       å•ä½æ—¶é’Ÿå‘¨æœŸ
</code></pre>
<p>å¦‚æœè¦æŸ¥çœ‹å…·ä½“æŸä¸ªè¿›ç¨‹ï¼Œä½¿ç”¨-pæŒ‡å®šè¿›ç¨‹å·ï¼Œä¸‹é¢é—´éš” 1 ç§’è¾“å‡º 3 ç»„æ•°æ®ï¼š</p>
<pre><code class="language-sh">$ pidstat -d -p 4344 1 3
06:38:50      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
06:38:51        0      4344      0.00      0.00      0.00       0  app
06:38:52        0      4344      0.00      0.00      0.00       0  app
06:38:53        0      4344      0.00      0.00      0.00       0  app
</code></pre>
<h2 id="å‚è€ƒ-149"><a class="header" href="#å‚è€ƒ-149">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç†è§£linuxçš„ç½‘ç»œ"><a class="header" href="#ç†è§£linuxçš„ç½‘ç»œ">ç†è§£Linuxçš„ç½‘ç»œ</a></h1>
<p>Linuxç½‘ç»œç›¸å…³çŸ¥è¯†ã€‚</p>
<h2 id="æŒ‡æ ‡å’Œå·¥å…·æ˜ å°„è¡¨"><a class="header" href="#æŒ‡æ ‡å’Œå·¥å…·æ˜ å°„è¡¨">æŒ‡æ ‡å’Œå·¥å…·æ˜ å°„è¡¨</a></h2>
<p><img src="linux/../img/linux/net-metric-tool.png" alt="ç½‘ç»œæŒ‡æ ‡å·¥å…·æ˜ å°„è¡¨" /></p>
<p><img src="linux/../img/linux/net-tool-metric.png" alt="ç½‘ç»œæŒ‡æ ‡å·¥å…·æ˜ å°„è¡¨" /></p>
<h2 id="æŠ¥æ–‡å¤„ç†æµç¨‹"><a class="header" href="#æŠ¥æ–‡å¤„ç†æµç¨‹">æŠ¥æ–‡å¤„ç†æµç¨‹</a></h2>
<p><img src="linux/../img/linux/pkt-process.png" alt="æŠ¥æ–‡å¤„ç†æµç¨‹" /></p>
<h2 id="tcpè¿æ¥çŠ¶æ€"><a class="header" href="#tcpè¿æ¥çŠ¶æ€">TCPè¿æ¥çŠ¶æ€</a></h2>
<p><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/09/04/linux-net-tcp.html">TCPè¿æ¥ç›¸å…³çŸ¥è¯†</a></p>
<p><img src="linux/../img/linux/tcp-stat.png" alt="TCPè¿æ¥çŠ¶æ€" /></p>
<h2 id="tcpå‚æ•°è°ƒä¼˜"><a class="header" href="#tcpå‚æ•°è°ƒä¼˜">TCPå‚æ•°è°ƒä¼˜</a></h2>
<p><img src="linux/../img/linux/tcp-parameters.png" alt="TCPå‚æ•°è°ƒä¼˜" /></p>
<h2 id="å…¶å®ƒæ–‡ç« "><a class="header" href="#å…¶å®ƒæ–‡ç« ">å…¶å®ƒæ–‡ç« </a></h2>
<p><a href="https://jvns.ca/blog/2017/09/05/finding-out-where-packets-are-being-dropped/">Finding out if/why a server is dropping packets</a></p>
<p><a href="https://mp.weixin.qq.com/s/VYBs8iqf0HsNg9WAxktzYQ">SNATç«¯å£å†²çªï¼Œå¯¼è‡´å®¹å™¨è®¿é—®å¤–éƒ¨æœåŠ¡å¶å°”è¶…æ—¶</a>ï¼š</p>
<blockquote>
<p>éœ€è¦åœ¨masqueradeè§„åˆ™ä¸­è®¾ç½®flag NF_NAT_RANGE_PROTO_RANDOM_FULLYã€‚iptableså·¥å…·ä¸æ”¯æŒè®¾å®šè¿™ä¸ªflagï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»æäº¤äº†ä¸€ä¸ªå°è¡¥ä¸å¢åŠ è¿™ä¸ªç‰¹æ€§ï¼Œè¡¥ä¸å·²ç»åˆå…¥ï¼ˆè¯‘è€…æ³¨ï¼šåœ¨iptables 1.6.2ç‰ˆæœ¬å‘å¸ƒï¼‰ã€‚</p>
</blockquote>
<blockquote>
<p>æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ä¸€ä¸ªä¿®æ”¹åçš„æ‰“äº†è¿™ä¸ªè¡¥ä¸çš„flannelç‰ˆæœ¬ï¼Œåœ¨masqueradeè§„åˆ™ä¸­å¢åŠ äº†flag --ramdom-fullyã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„Daemonsetä»æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè·å–conntrackçš„ç»Ÿè®¡ç»“å¹¶å‘é€åˆ°InfluxDBæ¥ç›‘æ§conntrackè¡¨çš„æ’å…¥é”™è¯¯ã€‚æˆ‘ä»¬å·²ç»ä½¿ç”¨è¿™è¡¥ä¸å°†è¿‘ä¸€ä¸ªæœˆäº†ï¼Œæ•´ä¸ªé›†ç¾¤ä¸­çš„é”™è¯¯çš„æ•°ç›®ä»æ¯å‡ ç§’ä¸€æ¬¡ä¸‹é™åˆ°æ¯å‡ ä¸ªå°æ—¶ä¸€æ¬¡ã€‚</p>
</blockquote>
<h2 id="å‚è€ƒ-150"><a class="header" href="#å‚è€ƒ-150">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç½‘ç»œæ€§èƒ½æŒ‡æ ‡"><a class="header" href="#ç½‘ç»œæ€§èƒ½æŒ‡æ ‡">ç½‘ç»œæ€§èƒ½æŒ‡æ ‡</a></h1>
<p><strong>å¸¦å®½</strong>: æœ€å¤§ä¼ è¾“é€Ÿç‡ï¼Œå•ä½b/sï¼ˆæ¯”ç‰¹/ç§’ï¼‰ã€‚</p>
<p><strong>ååé‡</strong>: å•ä½æ—¶é—´å†…ä¼ è¾“çš„æ•°æ®é‡ï¼Œb/sæˆ–è€…B/sã€‚</p>
<p><strong>å»¶æ—¶</strong>ï¼šè¯·æ±‚å‘å‡ºæ—¶ä¸å¯¹æ–¹æ”¶åˆ°æ—¶çš„é—´éš”æ—¶é—´ï¼Œä¸åŒåœºæ™¯ä¸‹å«ä¹‰ä¸åŒï¼Œä¾‹å¦‚TCPæ¡æ‰‹å»¶è¿Ÿï¼Œæ•°æ®åŒ…å¾€è¿”å»¶è¿Ÿï¼ˆRTTï¼‰ã€‚</p>
<p><strong>PPS</strong>: æ¯ç§’ä¼ è¾“çš„æŠ¥æ–‡æ•°ï¼ˆä¸è®ºæŠ¥æ–‡å¤§å°ï¼‰ï¼Œç¡¬ä»¶äº¤æ¢æœºé€šå¸¸å¯ä»¥è¾¾åˆ°çº¿é€Ÿï¼ŒLinuxæœåŠ¡å™¨ä¸€èˆ¬è¾¾ä¸åˆ°ã€‚</p>
<p><strong>å¹¶å‘è¿æ¥æ•°</strong>: tcpè¿æ¥æ•°é‡ã€‚</p>
<p><strong>ä¸¢åŒ…ç‡</strong>: ä¸¢å¤±æŠ¥æ–‡å æ¯”ã€‚</p>
<p><strong>é‡ä¼ ç‡</strong>: é‡ä¼ æŠ¥æ–‡å æ¯”ã€‚ </p>
<h2 id="hping3æ£€æµ‹å»¶è¿Ÿ"><a class="header" href="#hping3æ£€æµ‹å»¶è¿Ÿ">hping3æ£€æµ‹å»¶è¿Ÿ</a></h2>
<p>hping3çš„ç”¨æ³•ï¼š-c è¡¨ç¤ºå‘é€3æ¬¡è¯·æ±‚ï¼Œ-S è¡¨ç¤ºè®¾ç½®TCP SYNï¼Œ-p è¡¨ç¤ºç«¯å£å·ä¸º80ï¼ˆyumå®‰è£…ï¼šyum install -y hping3ï¼‰ã€‚</p>
<pre><code class="language-sh">$ hping3 -c 3 -S -p 80 baidu.com
HPING baidu.com (eth0 123.125.115.110): S set, 40 headers + 0 data bytes
len=46 ip=123.125.115.110 ttl=51 id=47908 sport=80 flags=SA seq=0 win=8192 rtt=20.9 ms
len=46 ip=123.125.115.110 ttl=51 id=6788  sport=80 flags=SA seq=1 win=8192 rtt=20.9 ms
len=46 ip=123.125.115.110 ttl=51 id=37699 sport=80 flags=SA seq=2 win=8192 rtt=20.9 ms

--- baidu.com hping statistic ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 20.9/20.9/20.9 ms
</code></pre>
<h2 id="tracerouteæ£€æµ‹å»¶è¿Ÿ"><a class="header" href="#tracerouteæ£€æµ‹å»¶è¿Ÿ">tracerouteæ£€æµ‹å»¶è¿Ÿ</a></h2>
<p>tracerouteçš„ç”¨æ³•ï¼š--tcp è¡¨ç¤ºä½¿ç”¨ TCP åè®®ï¼Œ-p è¡¨ç¤ºç«¯å£å·ï¼Œ-n è¡¨ç¤ºä¸å¯¹ç»“æœä¸­çš„ IP åœ°å€æ‰§è¡Œåå‘åŸŸåè§£æï¼ˆyumå®‰è£…ï¼šyum install -y tracerouteï¼‰ã€‚</p>
<pre><code class="language-sh">$ traceroute --tcp -p 80 -n baidu.com
traceroute to baidu.com (123.125.115.110), 30 hops max, 60 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  * * *
13  * * *
14  123.125.115.110  20.684 ms *  20.798 ms
</code></pre>
<h2 id="pktgenå‘åŒ…"><a class="header" href="#pktgenå‘åŒ…">pktgenå‘åŒ…</a></h2>
<p>pktgenæ˜¯å†…æ ¸è‡ªå¸¦çš„å‘åŒ…å·¥å…·ï¼Œ<a href="https://www.kernel.org/doc/Documentation/networking/pktgen.txt">networking/pktgen.txt</a>ï¼ŒIntelæä¾›äº†ä¸€ä¸ªåŸºäºDPDKçš„åŒåå·¥å…·<a href="https://pktgen-dpdk.readthedocs.io/en/latest/">The Pktgen Application</a>ã€‚</p>
<h2 id="å‚è€ƒ-151"><a class="header" href="#å‚è€ƒ-151">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="ç½‘å¡çŠ¶æ€"><a class="header" href="#ç½‘å¡çŠ¶æ€">ç½‘å¡çŠ¶æ€</a></h1>
<h2 id="å¤šç§æ–¹å¼æŸ¥çœ‹ç½‘å¡ä¿¡æ¯"><a class="header" href="#å¤šç§æ–¹å¼æŸ¥çœ‹ç½‘å¡ä¿¡æ¯">å¤šç§æ–¹å¼æŸ¥çœ‹ç½‘å¡ä¿¡æ¯</a></h2>
<p><code>ifconfig</code>ã€<code>netstat</code>ï¼ˆyum install -y net-toolï¼‰æˆ–è€…<code>ip</code>ï¼ˆyum install -y iproute2ï¼‰æŸ¥çœ‹ç½‘å¡è¯¦æƒ…ã€‚</p>
<pre><code class="language-sh">$ ifconfig eth0
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1454
        inet 192.168.7.222  netmask 255.255.0.0  broadcast 10.19.255.255
        ether 52:54:00:33:70:30  txqueuelen 1000  (Ethernet)
        RX packets 2973979082  bytes 1977239275436 (1.7 TiB)
        RX errors 0  dropped 53  overruns 0  frame 0
        TX packets 2157378511  bytes 3340384739019 (3.0 TiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre>
<pre><code class="language-sh">$ netstat -i
Kernel Interface table
Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
docker0   1426 290827246      0      0 0      309655306      0      0      0 BMRU
eth0      1454 214759910523      0   1296 0      193020803000      0      0      0 BMRU
flannel0  1426 118667062225      0      0 0      110488702382      0   6361      0 MOPRU
lo       65536 184456359      0      0 0      184456359      0      0      0 LRU
lo:1     65536      - no statistics available -                        LRU
vethba02  1426 74175712      0      0 0      80134415      0      0      0 BMRU
</code></pre>
<pre><code class="language-sh">$ ip -s -d addr
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1454 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:33:70:30 brd ff:ff:ff:ff:ff:ff promiscuity 0
    inet 192.168.7.222/16 brd 10.19.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    RX: bytes  packets  errors  dropped overrun mcast
    1977612295437 2974994116 0       53      0       0
    TX: bytes  packets  errors  dropped carrier collsns
    3341796453985 2158430374 0       0       0       0
</code></pre>
<p>è¿è¡ŒçŠ¶æ€ï¼š RUNNINGï¼ŒLOWER_UPã€‚</p>
<p>MTUï¼š1454ã€‚</p>
<p>åœ°å€ï¼šIPã€MACã€‚</p>
<p>æŠ¥æ–‡æ”¶å‘æƒ…å†µï¼š RXæ˜¯æ¥æ”¶çš„æŠ¥æ–‡ï¼ŒTXæ˜¯å‘é€çš„æŠ¥æ–‡ã€‚</p>
<pre><code>errorsï¼š    é”™è¯¯æŠ¥æ–‡æ•°ï¼Œæ ¡éªŒé”™è¯¯ã€å¸§é”™è¯¯ç­‰ã€‚
droppedï¼š   ä¸¢å¼ƒçš„æŠ¥æ–‡æ•°ï¼ŒæŠ¥æ–‡å·²ç»è¿›å…¥ring bufferï¼Œä½†æ˜¯å› ä¸ºå†…å­˜ä¸è¶³ä¸¢å¼ƒã€‚
overrunsï¼š  è¶…é™åˆ¶æŠ¥æ–‡æ•°ï¼Œå› ring bufferå·²æ»¡è€Œä¸¢å¼ƒçš„æŠ¥æ–‡ã€‚
carrierï¼š   åŒå·¥æ¨¡å¼ä¸åŒ¹é…ã€ç”µç¼†æ•…éšœç­‰å¯¼è‡´çš„é”™è¯¯ã€‚
collisionsï¼šå†²çªæŠ¥æ–‡æ•°ã€‚
</code></pre>
<h2 id="ç”¨saræŸ¥çœ‹ç½‘å¡åå"><a class="header" href="#ç”¨saræŸ¥çœ‹ç½‘å¡åå">ç”¨saræŸ¥çœ‹ç½‘å¡åå</a></h2>
<p>ç”¨saræŸ¥çœ‹ç½‘å¡çš„ååæƒ…å†µï¼Œ<code>-n</code>æŸ¥çœ‹ç½‘ç»œçŠ¶æ€ï¼Œ<code>DEV</code>æŸ¥çœ‹è®¾å¤‡çŠ¶æ€ï¼ˆé™¤äº†DEVï¼Œè¿˜æ”¯æŒï¼šEDEVã€ NFSã€ NFSDã€ SOCKã€ IPã€ EIPã€ ICMPã€ EICMPã€ TCPã€ ETCPã€ UDPã€ SOCK6ã€ IP6ã€ EIP6ã€ ICMP6ã€ EICMP6ã€ UDP6ï¼‰ï¼Œ<code>1</code>æ¯ç§’åˆ·æ–°ä¸€æ¬¡ï¼š</p>
<pre><code class="language-sh">$sar -n DEV 1
Linux 3.10.0-693.11.6.el7.x86_64 (prod-k8s-node-180-92) 	04/22/2019 	_x86_64_	(32 CPU)

02:04:47 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s
02:04:48 PM      eth0   1395.00   1186.00    545.40   1902.75      0.00      0.00      0.00
02:04:48 PM  flannel0    381.00    299.00    154.24     83.22      0.00      0.00      0.00
02:04:48 PM   docker0   1177.00   1336.00   1895.27    530.71      0.00      0.00      0.00

</code></pre>
<p>æ¥æ”¶å’Œå‘é€çš„ppsï¼š rxpck/sã€txpck/sã€‚</p>
<p>æ¥æ”¶å’Œå‘é€çš„å­—èŠ‚æ•°ï¼šrxkB/sã€txkB/sã€‚</p>
<p>æ¥æ”¶å’Œå‘é€çš„å‹ç¼©æ•°æ®åŒ…æ•°ï¼šrxcmp/sã€txcmp/sã€‚</p>
<h2 id="å‚è€ƒ-152"><a class="header" href="#å‚è€ƒ-152">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxçš„è¿æ¥ä¸åè®®æ ˆçŠ¶æ€çš„æŸ¥çœ‹æ–¹æ³•"><a class="header" href="#linuxçš„è¿æ¥ä¸åè®®æ ˆçŠ¶æ€çš„æŸ¥çœ‹æ–¹æ³•">Linuxçš„è¿æ¥ä¸åè®®æ ˆçŠ¶æ€çš„æŸ¥çœ‹æ–¹æ³•</a></h1>
<h2 id="netstatæŸ¥çœ‹è¿æ¥çŠ¶æ€åˆ†å¸ƒ"><a class="header" href="#netstatæŸ¥çœ‹è¿æ¥çŠ¶æ€åˆ†å¸ƒ">netstatæŸ¥çœ‹è¿æ¥çŠ¶æ€åˆ†å¸ƒ</a></h2>
<p>ç”¨netstatæŸ¥çœ‹è¿æ¥çŠ¶æ€çš„åˆ†å¸ƒï¼ˆç”¨yumå®‰è£…ï¼šyum install -y net-toolsï¼‰ï¼š</p>
<pre><code class="language-sh">$ netstat -nat|awk '{print awk $NF}'|sort|uniq -c|sort -n
      1 CLOSE_WAIT
      1 FIN_WAIT2
      1 State
      1 established)
      3 LAST_ACK
     30 FIN_WAIT1
    151 LISTEN
    280 TIME_WAIT
   1548 ESTABLISHED
</code></pre>
<h2 id="æŸ¥çœ‹æœ¬åœ°ä¸´æ—¶ç«¯å£å ç”¨æƒ…å†µ"><a class="header" href="#æŸ¥çœ‹æœ¬åœ°ä¸´æ—¶ç«¯å£å ç”¨æƒ…å†µ">æŸ¥çœ‹æœ¬åœ°ä¸´æ—¶ç«¯å£å ç”¨æƒ…å†µ</a></h2>
<pre><code class="language-sh">$ netstat -ntp |grep &quot;11.0.110.0&quot;  |awk '{print $4}' |sort |uniq |wc
  18171   18171  308907
</code></pre>
<p>æŸ¥çœ‹æœ¬åœ°æºç«¯å£èŒƒå›´ï¼š</p>
<pre><code class="language-sh">$ sysctl  net.ipv4.ip_local_port_range  
$ cat /proc/sys/net/ipv4/ip_local_port_range
</code></pre>
<p>è®¾ç½®æœ¬åœ°æºç«¯å£èŒƒå›´ï¼š</p>
<pre><code class="language-sh">sysctl -w net.ipv4.ip_local_port_range=&quot;1024 64000&quot;
</code></pre>
<p>ä¸´æ—¶ç«¯å£ä¸è¶³æ—¶ï¼ŒNginxä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<pre><code> (99: Cannot assign requested address) while connecting to upstream, client: 192.168.0.2, server: localhost, request: &quot;GET / HTTP/1.1&quot;, upstream: &quot;fastcgi://127.0.0.1:9000&quot;, host: &quot;192.168.0.30&quot;
</code></pre>
<h2 id="netstatssæŸ¥çœ‹å•ä¸ªè¿æ¥çŠ¶æ€"><a class="header" href="#netstatssæŸ¥çœ‹å•ä¸ªè¿æ¥çŠ¶æ€">netstat/ssæŸ¥çœ‹å•ä¸ªè¿æ¥çŠ¶æ€</a></h2>
<p>ç”¨netstatæŸ¥çœ‹è¯¦ç»†è¿æ¥ï¼Œ-tæŸ¥çœ‹tcpè¿æ¥ï¼Œ-uæŸ¥çœ‹udpè¿æ¥ï¼Œ-pæ˜¾ç¤ºå¯¹åº”è¿›ç¨‹ï¼š</p>
<pre><code class="language-sh">$ netstat -ntp
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 11.0.157.1:32888        11.0.157.6:8080         TIME_WAIT   -
tcp        0      0 11.0.157.1:45894        11.0.157.4:8080         TIME_WAIT   -
tcp        0      0 11.0.157.1:35826        11.0.157.9:8080         TIME_WAIT   -
tcp        0      0 11.0.157.1:57348        11.0.157.3:8080         TIME_WAIT   -
tcp        0      0 127.0.0.1:54728         127.0.0.1:10248         TIME_WAIT   -
</code></pre>
<p>sså‘½ä»¤æ˜¯netstatçš„æ›¿ä»£å‘½ä»¤ï¼š</p>
<pre><code class="language-sh">$ ss -ntp
State      Recv-Q Send-Q     Local Address:Port         Peer Address:Port
ESTAB      0      0           10.19.180.92:10250        10.19.14.106:38292     users:((&quot;kubelet&quot;,pid=15242,fd=41))
ESTAB      0      0           10.19.180.92:35154        10.19.61.146:2379      users:((&quot;flanneld&quot;,pid=1042,fd=10))
ESTAB      0      0           10.19.180.92:45380        10.19.162.39:6443      users:((&quot;kube-proxy&quot;,pid=14013,fd=8))
</code></pre>
<p>å½“å¥—æ¥å­—æ˜¯è¿æ¥çŠ¶æ€æ—¶ï¼ŒEstablishedï¼š</p>
<p><strong>Recv-Q</strong>ï¼šå¥—æ¥å­—æ¥æ”¶é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰è¢«åº”ç”¨ç¨‹åºè¯»å–çš„å­—èŠ‚æ•°ã€‚</p>
<p><strong>Send-Q</strong>ï¼šå¥—æ¥å­—å‘é€é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰è¢«è¿œç«¯ä¸»æœºç¡®è®¤çš„å­—èŠ‚æ•°ã€‚</p>
<p>å½“å¥—æ¥å­—æ˜¯ç›‘å¬çŠ¶æ€æ—¶ï¼ŒListeningï¼Œæ˜¾ç¤ºçš„åŠè¿æ¥çŠ¶æ€ï¼Œå³æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯SYNï¼Œè¿˜æ²¡æœ‰å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„TCPè¿æ¥ï¼š</p>
<p><strong>Recv-Q</strong>ï¼šTCPåè®®æ ˆä¸­çš„åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦çš„å½“å‰å€¼ï¼Œsyn backlogå½“å‰å€¼ã€‚</p>
<p><strong>Send-Q</strong>ï¼šTCPåè®®æ ˆä¸­çš„åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦çš„æœ€å¤§å€¼ï¼Œsyn backlogæœ€å¤§å€¼ã€‚</p>
<p>å¥—æ¥å­—æ˜¯EstablishedçŠ¶æ€æ—¶ï¼Œå¦‚æœRecv-Qå’ŒSend-Qä¸ä¸ºé›¶ï¼Œè¯´æ˜æ¥æ”¶çš„æ•°æ®æ— æ³•è¢«åº”ç”¨ç¨‹åºåŠæ—¶è¯»å–ï¼Œä»¥åŠåº”ç”¨çš„æ•°æ®æ— æ³•åŠæ—¶å‘é€ï¼Œæ˜¯å¼‚å¸¸æƒ…å†µã€‚</p>
<blockquote>
<p>é—®é¢˜ï¼šå¦‚æœæ˜¯UDPåè®®å‘¢ï¼ŸRece-Qå’ŒSend-Qçš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼ŸåŒEstablishedã€‚</p>
</blockquote>
<h2 id="netstatæŸ¥çœ‹åè®®æ ˆçŠ¶æ€"><a class="header" href="#netstatæŸ¥çœ‹åè®®æ ˆçŠ¶æ€">netstatæŸ¥çœ‹åè®®æ ˆçŠ¶æ€</a></h2>
<p><code>netstat -s</code>æ‰“å°å‡ºæ•´ä¸ªåè®®æ ˆçš„çŠ¶æ€ï¼ŒæŒ‰ç…§åè®®ç±»å‹åˆ†å¼€å±•ç¤ºï¼š</p>
<pre><code class="language-sh">$ netstat -s
Ip:
    3635473208 total packets received
    2855004908 forwarded
    0 incoming packets discarded
    769088666 incoming packets delivered
    3701098707 requests sent out
    44 dropped because of missing route
Icmp:
    100236 ICMP messages received
    0 input ICMP message failed.
    ICMP input histogram:
        destination unreachable: 995
        redirects: 4
        echo requests: 99229
        echo replies: 8
    114887 ICMP messages sent
    0 ICMP messages failed
    ICMP output histogram:
        destination unreachable: 15658
        echo replies: 99229
IcmpMsg:
        InType0: 8
        InType3: 995
        InType5: 4
        InType8: 99229
        OutType0: 99229
        OutType3: 15658
Tcp:
    3716853 active connections openings
    1228040 passive connection openings
    570 failed connection attempts
    610 connection resets received
    17 connections established
    33850465 segments received
    43122661 segments send out
    15575 segments retransmited
    4 bad segments received.
    1018 resets sent
Udp:
    735086502 packets received
    6 packets to unknown port received.
    33475 packet receive errors
    797838180 packets sent
    33475 receive buffer errors
    0 send buffer errors
UdpLite:
TcpExt:
    28250 invalid SYN cookies received
    3961 resets received for embryonic SYN_RECV sockets
    21371 packets pruned from receive queue because of socket buffer overrun
    72874448 TCP sockets finished time wait in fast timer
    1396 packets rejects in established connections because of timestamp
    6946924 delayed acks sent
    128318 delayed acks further delayed because of locked socket
    Quick ack mode was activated 49028 times
    1292037 packets directly queued to recvmsg prequeue.
    33405 bytes directly in process context from backlog
    566548477 bytes directly received in process context from prequeue
    420652665 packet headers predicted
    1255272 packets header predicted and directly queued to user
    285092354 acknowledgments not containing data payload received
...
</code></pre>
<h2 id="é™åˆ¶åŠå¼€è¿æ¥"><a class="header" href="#é™åˆ¶åŠå¼€è¿æ¥">é™åˆ¶åŠå¼€è¿æ¥</a></h2>
<p>åŠå¼€è¿æ¥æœ€å¤§æ•°é‡ï¼š</p>
<pre><code class="language-sh">sysctl net.ipv4.tcp_max_syn_backlog
net.ipv4.tcp_max_syn_backlog = 256
</code></pre>
<p>é™åˆ¶åŠå¼€è¿æ¥å»ºç«‹é€Ÿåº¦ï¼š</p>
<pre><code class="language-sh"># é™åˆ¶ syn å¹¶å‘æ•°ä¸ºæ¯ç§’ 1 æ¬¡
$ iptables -A INPUT -p tcp --syn -m limit --limit 1/s -j ACCEPT

# é™åˆ¶å•ä¸ª IP åœ¨ 60 ç§’æ–°å»ºç«‹çš„è¿æ¥æ•°ä¸º 10
$ iptables -I INPUT -p tcp --dport 80 --syn -m recent --name SYN_FLOOD --update --seconds 60 --hitcount 10 -j REJECT
</code></pre>
<p>å¯åŠ¨synccookieï¼š</p>
<pre><code class="language-sh">sysctl -w net.ipv4.tcp_syncookies=1
net.ipv4.tcp_syncookies = 1
</code></pre>
<h2 id="å‚è€ƒ-153"><a class="header" href="#å‚è€ƒ-153">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxçš„netfilter"><a class="header" href="#linuxçš„netfilter">Linuxçš„netfilter</a></h1>
<p><img src="linux/../img/linux/net-filter.png" alt="net filter" /></p>
<h2 id="è¿æ¥è·Ÿè¸ªè¡¨å‚æ•°"><a class="header" href="#è¿æ¥è·Ÿè¸ªè¡¨å‚æ•°">è¿æ¥è·Ÿè¸ªè¡¨å‚æ•°</a></h2>
<p>è¿æ¥è·Ÿè¸ªè¡¨tcpè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤120ç§’ï¼š</p>
<pre><code class="language-sh">sysctl net.netfilter.nf_conntrack_tcp_timeout_time_wait
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
</code></pre>
<p>è¿æ¥è·Ÿè¸ªè¡¨å¤§å°è®¾ç½®ï¼š</p>
<pre><code class="language-sh">$ sysctl net.netfilter.nf_conntrack_max=131072       //è·Ÿè¸ªè¡¨çš„æ€»å®¹é‡
$ sysctl net.netfilter.nf_conntrack_buckets=65536    //è·Ÿè¸ªè¡¨çš„æ¡¶æ•°é‡
</code></pre>
<p>è¿æ¥è·Ÿè¸ªè¡¨å†…å­˜å¼€é”€è®¡ç®—ï¼Œè¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å°ä¸º376ï¼Œé“¾è¡¨é¡¹å¤§å°ä¸º16ï¼š</p>
<pre><code class="language-sh">nf_conntrack_max* è¿æ¥è·Ÿè¸ªå¯¹è±¡å¤§å° +nf_conntrack_buckets* é“¾è¡¨é¡¹å¤§å°
= 1000*376+65536*16 B
= 1.4 MB
</code></pre>
<h2 id="conntrackæŸ¥çœ‹è¿æ¥è·Ÿè¸ªè¡¨çš„å†…å®¹"><a class="header" href="#conntrackæŸ¥çœ‹è¿æ¥è·Ÿè¸ªè¡¨çš„å†…å®¹">conntrackæŸ¥çœ‹è¿æ¥è·Ÿè¸ªè¡¨çš„å†…å®¹</a></h2>
<p>conntrackæŸ¥çœ‹è¿æ¥è·Ÿè¸ªè¡¨çš„å†…å®¹ï¼Œ -L è¡¨ç¤ºåˆ—è¡¨ï¼Œ-o è¡¨ç¤ºä»¥æ‰©å±•æ ¼å¼æ˜¾ç¤ºï¼š</p>
<pre><code class="language-sh">$ conntrack -L -o extended
ipv4     2 tcp      6 7 TIME_WAIT src=192.168.0.2 dst=192.168.0.96 sport=51744 dport=8080 src=172.17.0.2 dst=192.168.0.2 sport=8080 dport=51744 [ASSURED] mark=0 use=1
ipv4     2 tcp      6 6 TIME_WAIT src=192.168.0.2 dst=192.168.0.96 sport=51524 dport=8080 src=172.17.0.2 dst=192.168.0.2 sport=8080 dport=51524 [ASSURED] mark=0 use=1
</code></pre>
<h2 id="ç»Ÿè®¡æ€»çš„è¿æ¥è·Ÿè¸ªæ•°"><a class="header" href="#ç»Ÿè®¡æ€»çš„è¿æ¥è·Ÿè¸ªæ•°">ç»Ÿè®¡æ€»çš„è¿æ¥è·Ÿè¸ªæ•°</a></h2>
<pre><code class="language-sh">$ conntrack -L -o extended | wc -l
14289
</code></pre>
<h2 id="ç»Ÿè®¡tcpåè®®å„ä¸ªçŠ¶æ€çš„è¿æ¥è·Ÿè¸ªæ•°"><a class="header" href="#ç»Ÿè®¡tcpåè®®å„ä¸ªçŠ¶æ€çš„è¿æ¥è·Ÿè¸ªæ•°">ç»Ÿè®¡TCPåè®®å„ä¸ªçŠ¶æ€çš„è¿æ¥è·Ÿè¸ªæ•°</a></h2>
<pre><code class="language-sh">$ conntrack -L -o extended | awk '/^.*tcp.*$/ {sum[$6]++} END {for(i in sum) print i, sum[i]}'
SYN_RECV 4
CLOSE_WAIT 9
ESTABLISHED 2877
FIN_WAIT 3
SYN_SENT 2113
TIME_WAIT 9283
</code></pre>
<h2 id="ç»Ÿè®¡å„ä¸ªæºipçš„è¿æ¥è·Ÿè¸ªæ•°"><a class="header" href="#ç»Ÿè®¡å„ä¸ªæºipçš„è¿æ¥è·Ÿè¸ªæ•°">ç»Ÿè®¡å„ä¸ªæºIPçš„è¿æ¥è·Ÿè¸ªæ•°</a></h2>
<pre><code class="language-sh">$ conntrack -L -o extended | awk '{print $7}' | cut -d &quot;=&quot; -f 2 | sort | uniq -c | sort -nr | head -n 10
  14116 192.168.0.2
    172 192.168.0.96
</code></pre>
<h2 id="å‚è€ƒ-154"><a class="header" href="#å‚è€ƒ-154">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="æŠ¥æ–‡è¿½è¸ª"><a class="header" href="#æŠ¥æ–‡è¿½è¸ª">æŠ¥æ–‡è¿½è¸ª</a></h1>
<h2 id="ç”¨stapå’Œperfå®šä½ä¸¢å¤±çš„æŠ¥æ–‡"><a class="header" href="#ç”¨stapå’Œperfå®šä½ä¸¢å¤±çš„æŠ¥æ–‡">ç”¨stapå’Œperfå®šä½ä¸¢å¤±çš„æŠ¥æ–‡</a></h2>
<p>stapçš„å®‰è£…æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">yum install systemtap kernel-devel yum-utils kernel
stab-prep
</code></pre>
<p>ç”¨ä¸‹é¢çš„è„šæœ¬è·Ÿè¸ªå†…æ ¸å‡½æ•°kfree_skbçš„è°ƒç”¨ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä¸¢å¼ƒæŠ¥æ–‡çš„ä½ç½®ï¼š</p>
<pre><code class="language-bash">#! /usr/bin/env stap

############################################################
# Dropwatch.stp
# Author: Neil Horman &lt;nhorman@redhat.com&gt;
# An example script to mimic the behavior of the dropwatch utility
# http://fedorahosted.org/dropwatch
############################################################
# Array to hold the list of drop points we find
global locations
# Note when we turn the monitor on and off
probe begin { printf(&quot;Monitoring for dropped packets\n&quot;) }
probe end { printf(&quot;Stopping dropped packet monitor\n&quot;) }
# increment a drop counter for every location we drop at
probe kernel.trace(&quot;kfree_skb&quot;) { locations[$location] &lt;&lt;&lt; 1 }
# Every 5 seconds report our drop locations
probe timer.sec(5)
{
  printf(&quot;\n&quot;)
  foreach (l in locations-) {
    printf(&quot;%d packets dropped at %s\n&quot;,
           @count(locations[l]), symname(l))
  }
  delete locations
}
</code></pre>
<p>è¾“å‡ºç»“æœæ ·å¼å¦‚ä¸‹ï¼Œä¸‹é¢çš„è¾“å‡ºè¡¨æ˜æŠ¥æ–‡åœ¨nf_hook_slowä¸­è¢«ä¸¢å¼ƒï¼š</p>
<pre><code>10031 packets dropped at nf_hook_slow
676 packets dropped at tcp_v4_rcv

7284 packets dropped at nf_hook_slow
268 packets dropped at tcp_v4_rcv
</code></pre>
<p>ç”¨perfè¿›ä¸€æ­¥å®šä½ï¼Œåœ¨perf reportä¸­å±•å¼€å†…æ ¸å‡½æ•°nf_hook_slowï¼š</p>
<pre><code class="language-sh">$ perf record -a -g -- sleep 30
$ perf report -g graph,0
</code></pre>
<p><img src="linux/../img/nf_slow.png" alt="perf report" /></p>
<h2 id="tcpdumpæ•è·æŠ¥æ–‡"><a class="header" href="#tcpdumpæ•è·æŠ¥æ–‡">tcpdumpæ•è·æŠ¥æ–‡</a></h2>
<p>tcpdumpè¿‡æ»¤è¡¨è¾¾å¼ï¼š</p>
<p><img src="linux/../img/linux/tcpdump-flag.png" alt="tcpdumpè¿‡æ»¤è¡¨è¾¾å¼" /></p>
<h2 id="å‚è€ƒ-155"><a class="header" href="#å‚è€ƒ-155">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dnsè§£æè¿½è¸ª"><a class="header" href="#dnsè§£æè¿½è¸ª">DNSè§£æè¿½è¸ª</a></h1>
<h2 id="digè·Ÿè¸ªdnsè§£æè¿‡ç¨‹"><a class="header" href="#digè·Ÿè¸ªdnsè§£æè¿‡ç¨‹">digè·Ÿè¸ªdnsè§£æè¿‡ç¨‹</a></h2>
<p>digå¯ä»¥è·Ÿè¸ªdnsçš„è§£æè¿‡ç¨‹ï¼Œ+trace è¡¨ç¤ºå¼€å¯è·Ÿè¸ªæŸ¥è¯¢ï¼Œ+nodnssec è¡¨ç¤ºç¦æ­¢ DNS å®‰å…¨æ‰©å±•ï¼š</p>
<pre><code class="language-sh">$ dig +trace +nodnssec time.geekbang.org

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.3-Ubuntu &lt;&lt;&gt;&gt; +trace +nodnssec time.geekbang.org
;; global options: +cmd
.			322086	IN	NS	m.root-servers.net.
.			322086	IN	NS	a.root-servers.net.
.			322086	IN	NS	i.root-servers.net.
.			322086	IN	NS	d.root-servers.net.
.			322086	IN	NS	g.root-servers.net.
.			322086	IN	NS	l.root-servers.net.
.			322086	IN	NS	c.root-servers.net.
.			322086	IN	NS	b.root-servers.net.
.			322086	IN	NS	h.root-servers.net.
.			322086	IN	NS	e.root-servers.net.
.			322086	IN	NS	k.root-servers.net.
.			322086	IN	NS	j.root-servers.net.
.			322086	IN	NS	f.root-servers.net.
;; Received 239 bytes from 114.114.114.114#53(114.114.114.114) in 1340 ms

org.			172800	IN	NS	a0.org.afilias-nst.info.
org.			172800	IN	NS	a2.org.afilias-nst.info.
org.			172800	IN	NS	b0.org.afilias-nst.org.
org.			172800	IN	NS	b2.org.afilias-nst.org.
org.			172800	IN	NS	c0.org.afilias-nst.info.
org.			172800	IN	NS	d0.org.afilias-nst.org.
;; Received 448 bytes from 198.97.190.53#53(h.root-servers.net) in 708 ms

geekbang.org.		86400	IN	NS	dns9.hichina.com.
geekbang.org.		86400	IN	NS	dns10.hichina.com.
;; Received 96 bytes from 199.19.54.1#53(b0.org.afilias-nst.org) in 1833 ms

time.geekbang.org.	600	IN	A	39.106.233.176
;; Received 62 bytes from 140.205.41.16#53(dns10.hichina.com) in 4 ms
</code></pre>
<p><img src="linux/../img/linux/dig-dns-trace.png" alt="digçš„dnsè·Ÿè¸ªè¿‡ç¨‹" /></p>
<h2 id="å‚è€ƒ-156"><a class="header" href="#å‚è€ƒ-156">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="linuxé«˜æ€§èƒ½ç½‘ç»œioå¤„ç†"><a class="header" href="#linuxé«˜æ€§èƒ½ç½‘ç»œioå¤„ç†">Linuxé«˜æ€§èƒ½ç½‘ç»œIOå¤„ç†</a></h1>
<h2 id="å•è¿›ç¨‹æ¨¡å¼selectpollä¸epoll"><a class="header" href="#å•è¿›ç¨‹æ¨¡å¼selectpollä¸epoll">å•è¿›ç¨‹æ¨¡å¼ï¼šselectã€pollä¸epoll</a></h2>
<p>selectå’Œpolléƒ½æ˜¯éé˜»å¡çš„ï¼Œç›‘è§†ä¸€ç»„æ–‡ä»¶æè¿°çš„è¯»å†™çŠ¶æ€ï¼Œå¯¹æ»¡è¶³æ¡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ“ä½œï¼Œå®ç°å•çº¿ç¨‹å¤„ç†å¤šè¯·æ±‚ã€‚selectç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡æœ‰é™åˆ¶ï¼Œ32ä½ç³»ç»Ÿé»˜è®¤1024ä¸ªï¼Œpollå¯¹selectè¿›è¡Œäº†æ”¹è¿›ï¼Œåªå—ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ã€‚</p>
<p>selectå’Œpollé‡‡ç”¨çš„éƒ½æ˜¯è½®è¯¢æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨çš„æ–¹å¼ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå¹¶ä¸”æ–‡ä»¶æè¿°ç¬¦è¦åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ¥å›ä¼ é€ï¼Œå¢åŠ äº†å¤„ç†æˆæœ¬ã€‚</p>
<p>epollåœ¨å†…æ ¸ä¸­ç”¨çº¢é»‘æ ‘ç®¡ç†æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œé¿å…äº†æ–‡ä»¶æè¿°ç¬¦çš„ä¼ é€’ï¼ŒåŒæ—¶ä½¿ç”¨äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œä¸éœ€è¦è½®è¯¢æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚</p>
<h2 id="å¤šè¿›ç¨‹æ¨¡å¼1ä¸»è¿›ç¨‹å¤šå­è¿›ç¨‹"><a class="header" href="#å¤šè¿›ç¨‹æ¨¡å¼1ä¸»è¿›ç¨‹å¤šå­è¿›ç¨‹">å¤šè¿›ç¨‹æ¨¡å¼1ï¼šä¸»è¿›ç¨‹+å¤šå­è¿›ç¨‹</a></h2>
<p>ä¸»è¿›ç¨‹åˆå§‹åŒ–å¥—æ¥å­—bind()+listen()ã€ç®¡ç†å­è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œå­è¿›ç¨‹é€šè¿‡accpet()ã€epoll_wait()å¤„ç†ç›¸åŒçš„å¥—æ¥å­—ã€‚acceptå’Œepollå­˜åœ¨â€œæƒŠç¾¤â€é—®é¢˜ï¼Œacceptåœ¨Linux2.6ä¸­è§£å†³äº†ï¼Œepollåœ¨Linux4.5ä¸­ï¼Œé€šè¿‡EPOLLEXCLUSIVEè§£å†³ã€‚</p>
<p><strong>æƒŠç¾¤</strong>ï¼š ç½‘ç»œI/Oäº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒåŒæ—¶æœ‰å¤šä¸ªè¿›ç¨‹è¢«å”¤é†’ï¼Œä½†æœ€ç»ˆåªæœ‰ä¸€ä¸ªè¿›ç¨‹å“åº”äº‹ä»¶ï¼Œå…¶å®ƒè¿›ç¨‹è¢«ä¸å¿…è¦çš„å”¤é†’ã€‚</p>
<h2 id="å¤šè¿›ç¨‹æ¨¡å¼2ç«¯å£å¤ç”¨"><a class="header" href="#å¤šè¿›ç¨‹æ¨¡å¼2ç«¯å£å¤ç”¨">å¤šè¿›ç¨‹æ¨¡å¼2ï¼šç«¯å£å¤ç”¨</a></h2>
<p>Linux3.9æä¾›äº†<code>SO_REUSEPORT</code>ï¼Œæ”¯æŒå¤šè¿›ç¨‹å¤ç”¨åŒä¸€ä¸ªç«¯å£ï¼Œå†…æ ¸ä¿è¯å°†åˆ°è¾¾è¯¥ç«¯å£çš„è¯·æ±‚å‡è¡¡åˆ†å‘ç»™ç›‘å¬çš„è¿›ç¨‹ã€‚åŒæ—¶å†…æ ¸ç¡®ä¿åªæœ‰è¿›ç¨‹è¢«å”¤é†’ï¼Œä¸å­˜åœ¨æƒŠç¾¤çš„é—®é¢˜ã€‚</p>
<p><img src="linux/../img/linux/port-reuse.png" alt="nginx1.9.1ç«¯å£å¤ç”¨" /></p>
<h2 id="ç»•è¿‡å†…æ ¸åè®®æ ˆ1dpdk"><a class="header" href="#ç»•è¿‡å†…æ ¸åè®®æ ˆ1dpdk">ç»•è¿‡å†…æ ¸åè®®æ ˆ1ï¼šDPDK</a></h2>
<p>DPDKç›´æ¥åœ¨ç”¨æˆ·æ€è½®è¯¢ç¡¬ä»¶ç½‘å¡ï¼Œç»•è¿‡äº†å†…æ ¸åè®®æ ˆï¼Œè¿˜é€šè¿‡huagepageã€cpuç»‘å®šã€å†…å­˜å¯¹é½ã€æµæ°´çº¿å¹¶å‘ç­‰å¤šç§æœºåˆ¶ï¼Œæé«˜æŠ¥æ–‡çš„å¤„ç†æ•ˆç‡ï¼š</p>
<p><img src="linux/../img/linux/dpdk.png" alt="dpdkå·¥ä½œåŸç†" /></p>
<h2 id="ç»•è¿‡å†…æ ¸åè®®æ ˆ2xdp"><a class="header" href="#ç»•è¿‡å†…æ ¸åè®®æ ˆ2xdp">ç»•è¿‡å†…æ ¸åè®®æ ˆ2ï¼šXDP</a></h2>
<p>XDPï¼ˆeXpress Data Pathï¼‰æ˜¯Linuxå†…æ ¸ï¼ˆ4.8ä»¥ä¸Šï¼‰æä¾›çš„é«˜æ€§èƒ½ç½‘ç»œæ•°æ®è·¯å¾„ï¼Œåœ¨ç½‘ç»œåŒ…è¿›å…¥å†…æ ¸åè®®æ ˆä¹‹å‰è¿›è¡Œå¤„ç†ã€‚XDPæ˜¯åŸºäºLinuxå†…æ ¸çš„eBPFæœºåˆ¶å®ç°çš„ï¼š</p>
<p><img src="linux/../img/linux/xdp.png" alt="XDPå·¥ä½œåŸç†" /></p>
<h2 id="å‚è€ƒ-157"><a class="header" href="#å‚è€ƒ-157">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h2 id="linuxæ€§èƒ½åˆ†æå¸¸ç”¨å·¥å…·"><a class="header" href="#linuxæ€§èƒ½åˆ†æå¸¸ç”¨å·¥å…·">Linuxæ€§èƒ½åˆ†æå¸¸ç”¨å·¥å…·</a></h2>
<p>è¿™é‡Œæ±‡æ€»Linuxæ€§èƒ½åˆ†ææ—¶å¸¸ç”¨çš„å·¥å…·ï¼Œå†…å®¹åŠ›æ±‚ç®€æ´æ˜äº†ï¼Œé€‚åˆä½œä¸ºé€ŸæŸ¥æ‰‹å†Œä½¿ç”¨ã€‚</p>
<h2 id="å‚è€ƒ-158"><a class="header" href="#å‚è€ƒ-158">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç«ç„°å›¾ä»‹ç»"><a class="header" href="#ç«ç„°å›¾ä»‹ç»">ç«ç„°å›¾ä»‹ç»</a></h1>
<p>ç«ç„°å›¾æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„åˆ†æå·¥å…·ï¼Œå¯ä»¥ç›´è§‚åœ°æ˜¾ç¤ºæ¯ä¸ªå‡½æ•°è€—è´¹çš„æ—¶é—´å æ¯”ã€‚</p>
<p>ç«ç„°å›¾æ˜¯æ€§èƒ½ä¼˜åŒ–é¢†åŸŸå¤§ç¥<a href="http://www.brendangregg.com/">Brendan D. Gregg</a>çš„æ°ä½œï¼Œä»–åœ¨<a href="http://www.brendangregg.com/flamegraphs.html">Flame Graphs</a>ä¸€æ–‡é‡Œè¯¦ç»†ä»‹ç»äº†ç«ç„°å›¾çš„ç”¨æ³•ã€‚
å¹¶ä¸”è´¡çŒ®äº†ä¸€ä¸ªç«ç„°ç”Ÿæˆå·¥å…·<a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a>ï¼Œè¿™ä¸ªå·¥å…·å¯ä»¥å°†è°ƒç”¨æ ˆé‡‡æ ·æ•°æ®è½¬æ¢æˆç«ç„°å›¾ï¼Œ<a href="http://www.brendangregg.com/perf.html#FlameGraphs">Perf Examples</a>ä¸­æåˆ°äº†å®ƒçš„ç”¨æ³•ã€‚é‡‡æ ·æ•°æ®ä¹Ÿå¯ä»¥ç”¨å…¶å®ƒå·¥å…·é‡‡é›†ï¼Œæ¯”å¦‚OpenRestyçš„ä½œè€…ç« å®œæ˜¥è´¡çŒ®çš„<a href="https://github.com/openresty/stapxx">stapxx</a>ã€‚</p>
<p>Brendan D. Greggçš„è‹±æ–‡æ–‡ç« çœ‹èµ·æ¥åƒåŠ›ï¼Œå¯ä»¥å‚è€ƒé˜®ä¸€å³°å†™çš„<a href="http://www.ruanyifeng.com/blog/2017/09/flame-graph.html">å¦‚ä½•è¯»æ‡‚ç«ç„°å›¾ï¼Ÿ</a>ã€‚</p>
<p>ç«ç„°å›¾æ˜¯è¿™ä¸ªæ ·å­çš„ï¼ˆå®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€å›¾ï¼Œå³é”®æŸ¥çœ‹å›¾åƒï¼‰ï¼š</p>
<p><img src="linux/../img/linux/cpu-mysql-updated.svg" alt="ç«ç„°å›¾" /></p>
<p>æ¨ªå‘æ˜¯æŒ‰ç…§å­—æ¯é¡ºåºæ’åºçš„å‡½æ•°åï¼Œæ¯ä¸ªå‡½æ•°çš„å®½åº¦å æ¯”ç­‰äºè¿™ä¸ªå‡½æ•°åœ¨é‡‡æ ·ä¸­å‡ºç°æ¬¡æ•°å æ¯”ï¼Œä¹Ÿå°±ç­‰åŒäºå®ƒè€—è´¹çš„æ—¶é—´æ¯”ä¾‹ã€‚è¶Šå®½çš„å‡½æ•°ï¼Œè€—è´¹çš„çš„æ—¶é—´å æ¯”è¶Šå¤§ã€‚</p>
<p>çºµå‘æ˜¯è°ƒç”¨å…³ç³»ï¼Œä¸Šå±‚çš„å‡½æ•°è¢«ä¸‹å±‚çš„å‡½æ•°è°ƒç”¨ï¼Œæœ€ä¸Šå±‚çš„å‡½æ•°æ˜¯é‡‡æ ·æ—¶æ­£åœ¨å ç”¨CPUçš„å‡½æ•°ã€‚</p>
<p>å¦‚æœåœ¨æœ€ä¸Šå±‚å­˜åœ¨å¾ˆå®½çš„å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±æ˜¯å¯¼è‡´æ€§èƒ½æ— æ³•æå‡çš„ç½ªé­ç¥¸é¦–ï¼Œéœ€è¦é‡ç‚¹åˆ†æä¼˜åŒ–ã€‚</p>
<p>ç«ç„°å›¾çš„é¢œè‰²æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œæ¯ä¸ªå‡½æ•°çš„é¢œè‰²éƒ½æ˜¯éšæœºç”Ÿæˆçš„ï¼Œåƒä¸‡ä¸è¦è¯¯ä»¥ä¸ºå’Œé¢œè‰²æœ‰å…³ï¼Œä½ åº”å½“å…³æ³¨çš„æ˜¯å‡½æ•°çš„å®½åº¦ã€‚</p>
<p>ä»»ä½•æ€§èƒ½å·¥å…·ç”Ÿæˆçš„é‡‡ç”¨æ•°æ®éƒ½å¯ä»¥ç”¨æ¥ç”Ÿæˆç«ç„°å›¾ï¼š</p>
<pre><code>Linux: perf, eBPF, SystemTap, and ktap
Solaris, illumos, FreeBSD: DTrace
Mac OS X: DTrace and Instruments
Windows: Xperf.exe
</code></pre>
<p>å…«å¦ä¸€ä¸‹ï¼š</p>
<p>Brendan D. Greggåœ¨<a href="linux/www.brendangregg.com/flamegraphs.html">æ–‡ç« </a>ä¸­å†™é“ï¼Œä»–æ˜¯åœ¨è§£å†³MySQLçš„æ€§èƒ½é—®é¢˜æ—¶ï¼Œäº§ç”Ÿäº†ç«ç„°å›¾çš„åˆ›æ„ã€‚ä½†æ˜¯ä»–é‡‡é›†äº†å¾ˆå¤šçš„æ–‡æœ¬æ•°æ®ï¼Œä¸æ–¹ä¾¿æŸ¥çœ‹ï¼Œäºæ˜¯ç ”ç©¶äº†ä¸€ä¸‹æ€æ ·å°†é‡‡æ ·æ•°æ®å¯è§†åŒ–ã€‚ä»–å€Ÿé‰´äº†Neelakanth and Rochçš„ç›¸å…³ç ”ç©¶ï¼Œç”¨é‡‡æ ·å æ¯”å–ä»£äº†æ—¶é—´å æ¯”ï¼Œåªé€‰å–äº†æš–è‰²è°ƒçš„é¢œè‰²ï¼Œç”Ÿæˆäº†ç«ç„°ä¸€èˆ¬çš„å›¾å½¢ã€‚è¿™é¡¹å·¥ä½œæ˜¯åœ¨2011å¹´å®Œæˆã€‚</p>
<p>åæ¥ç«ç„°å›¾çš„åˆ›æ„è¢«Googleå€Ÿé‰´ï¼Œæ¤å…¥äº†Chromeæµè§ˆå™¨ï¼Œç”¨æ¥åˆ†æç½‘é¡µæ€§èƒ½ï¼Œåœ¨å¼€å‘è€…å·¥å…·çš„æ€§èƒ½é€‰é¡¹å¡ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸è¿‡chromeä¸­çš„ç«ç„°å›¾å’Œè¿™é‡Œçš„ç«ç„°å›¾ä¸ä¸€æ ·ï¼Œå®ƒçš„xè½´æ˜¯æ—¶é—´è½´ï¼Œå¹¶ä¸”æ˜¯å€’ç«ç„°å½¢çŠ¶ï¼Œä¸Šå±‚å‡½æ•°è°ƒç”¨ä¸‹å±‚å‡½æ•°ã€‚</p>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2017/bg2017092505.jpg" alt="Chromeä¸­çš„ç«ç„°å›¾" /></p>
<p>åœ¨å…·ä½“ä½¿ç”¨ä¸Šï¼Œç«ç„°å›¾å¯ä»¥ç”¨æ¥åˆ†æCPUå ç”¨æƒ…å†µã€å†…å­˜ç”³è¯·æƒ…å†µã€æœªå ç”¨CPUæ—¶çš„æƒ…å†µï¼Œå¹¶ä¸”æ¼”åŒ–å‡ºâ€œå†·çƒ­ï¼ˆaHHot/Codeï¼‰å’Œâ€œå·®å¼‚ç«ç„°å›¾ï¼ˆDifferentialï¼‰â€ã€‚</p>
<h2 id="å‚è€ƒ-159"><a class="header" href="#å‚è€ƒ-159">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç”¨ç«ç„°å›¾åˆ†æcpuå ç”¨æƒ…å†µ"><a class="header" href="#ç”¨ç«ç„°å›¾åˆ†æcpuå ç”¨æƒ…å†µ">ç”¨ç«ç„°å›¾åˆ†æCPUå ç”¨æƒ…å†µ</a></h1>
<p>CPUç«ç„°å›¾æ˜¯æœ€å¸¸ç”¨ã€æœ€å¥½ç†è§£çš„ç«ç„°å›¾ï¼Œå®ƒå±•ç°çš„æ˜¯å‡½æ•°å¯¹CPUçš„å ç”¨æƒ…å†µï¼Œç«ç„°å›¾æœ€ä¸Šå±‚æ˜¯é‡‡æ ·æ—¶æ­£åœ¨ä½¿ç”¨CPUçš„å‡½æ•°ï¼š</p>
<p><img src="linux/../img/linux/cpu-bash-flamegraph.svg" alt="CPUç«ç„°å›¾" /></p>
<p>CPUç«ç„°å›¾å±•ç°çš„æ˜¯åœ¨CPUä¸Šå‘ç”Ÿçš„äº‹æƒ…ï¼Œä¸‹å›¾ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼ˆè“è‰²éƒ¨åˆ†æ˜¯CPUä¹‹å¤–çš„äº‹æƒ…ï¼Œç”¨åæ–‡ä¸­çš„Off-CPUç«ç„°å›¾å±•ç°ï¼‰ï¼š</p>
<p><img src="linux/../img/linux/hotcoldfigure.png" alt="Thread state transition diagram" /></p>
<p>CPUç«ç„°å›¾æœ€å¸¸ç”¨ä¹Ÿæœ€ç®€å•ï¼Œ<a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html">CPU Flame Graphs</a>ä»‹ç»äº†å‡ ç§åˆ¶ä½œæ–¹æ³•ï¼Œç»™å‡ºäº†C/C++/Jave/Node.jsï¼Œä»¥åŠå…¶å®ƒè¯­è¨€ç¼–å†™çš„åº”ç”¨çš„CPUç«ç„°å›¾ç”Ÿæˆæ–¹æ³•ã€‚</p>
<h2 id="å‡ ç§å¸¸ç”¨çš„é‡‡æ ·å·¥å…·"><a class="header" href="#å‡ ç§å¸¸ç”¨çš„é‡‡æ ·å·¥å…·">å‡ ç§å¸¸ç”¨çš„é‡‡æ ·å·¥å…·</a></h2>
<h3 id="perf"><a class="header" href="#perf">perf</a></h3>
<p>ç”¨perfé‡‡é›†æŒ‡å®šCPUä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼š</p>
<pre><code>perf record -F 99 -C 1,3 -g 
</code></pre>
<h3 id="dtrace"><a class="header" href="#dtrace">DTrace</a></h3>
<h3 id="systemtap"><a class="header" href="#systemtap">SystemTap</a></h3>
<h3 id="ktap"><a class="header" href="#ktap">ktap</a></h3>
<h2 id="å‚è€ƒ-160"><a class="header" href="#å‚è€ƒ-160">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç”¨å†…å­˜ç«ç„°å›¾åˆ†æå†…å­˜æ³„éœ²"><a class="header" href="#ç”¨å†…å­˜ç«ç„°å›¾åˆ†æå†…å­˜æ³„éœ²">ç”¨å†…å­˜ç«ç„°å›¾åˆ†æå†…å­˜æ³„éœ²</a></h1>
<p>å†…å­˜æ³„éœ²å·²ç»æœ‰å‡ ç§åˆ†æå·¥å…·ï¼Œä¾‹å¦‚é€šè¿‡æ¨¡æ‹Ÿè¿è¡Œè¿›è¡Œåˆ†æçš„<a href="http://valgrind.org/docs/manual/mc-manual.html">Valgrind</a>ï¼Œå¯ä»¥ç»Ÿè®¡å†…å­˜å †ï¼ˆheapï¼‰ä½¿ç”¨æƒ…å†µçš„<a href="http://goog-perftools.sourceforge.net/doc/heap_profiler.html">libtcmalloc</a>é“¾æ¥åº“ã€‚</p>
<p>ç›¸æ¯”å·²æœ‰çš„å·¥å…·ï¼Œå†…å­˜ç«ç„°å›¾æ˜¯éä¾µå…¥å¼çš„æ—è·¯åˆ†ææ–¹æ³•ï¼Œä¸å¹²æ‰°ç›®æ ‡åº”ç”¨çš„è¿è¡Œã€‚åˆ¶ä½œCPUç«ç„°å›¾æ—¶ï¼Œé‡‡æ ·æ—¶æ•æ‰çš„æ˜¯æ­£åœ¨å ç”¨CPUçš„å‡½æ•°çš„è°ƒç”¨æ ˆï¼Œåˆ¶ä½œå†…å­˜ç«ç„°å›¾æ—¶ï¼Œé‡‡æ ·æ—¶æ•æ‰çš„æ˜¯æ­£åœ¨è¿›è¡Œå†…å­˜ç”³è¯·/é‡Šæ”¾çš„å‡½æ•°çš„è°ƒç”¨æ ˆã€‚</p>
<p>è¿›ç¨‹çš„å†…å­˜ç©ºé—´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œéƒ½æ˜¯é€šè¿‡malloc()ã€free()ç­‰å‡ ä¸ªå‡½æ•°ç”³è¯·æˆ–é‡Šæ”¾å†…å­˜ï¼š</p>
<p><img src="http://www.brendangregg.com/FlameGraphs/memorytracing_1000.png" alt="è¿›ç¨‹å†…å­˜ç©ºé—´å›¾" /></p>
<p>ä»¥è¿™äº›å†…å­˜ç®¡ç†å‡½æ•°ä¸ºç›®æ ‡è¿›è¡Œé‡‡æ ·ï¼Œå°±å¯ä»¥çŸ¥é“å“ªäº›å‡½æ•°æ­£åœ¨é¢‘ç¹çš„ä½¿ç”¨è¿™äº›å†…å­˜ç®¡ç†å‡½æ•°ï¼Œä¾‹å¦‚ä¸‹å›¾æ˜¯ä»¥<code>malloc</code>å‡½æ•°ä¸ºç›®æ ‡è¿›ç¨‹é‡‡æ ·çš„ç»“æœï¼š</p>
<p><img src="http://www.brendangregg.com/FlameGraphs/malloc_perl1.svg" alt="å†…å­˜ç«ç„°å›¾" /></p>
<p>ç«ç„°å›¾çš„æ¨ªè½´ä¾æ—§æ˜¯æŒ‰å­—æ¯é¡ºåºæ’åˆ—çš„å‡½æ•°ï¼Œå®½åº¦ä»£è¡¨å‡½æ•°åœ¨é‡‡æ ·ç»“æœä¸­å‡ºç°çš„æ¯”ä¾‹ï¼Œçºµè½´ä¾ç„¶æ˜¯è°ƒç”¨æ ˆï¼Œä¸Šå±‚å‡½æ•°è¢«ä¸‹å±‚å‡½æ•°è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œæœ€é¡¶å±‚çš„å‡½æ•°çš„å«ä¹‰å‘ç”Ÿäº†å˜åŒ–ï¼Œåœ¨CPUç«ç„°å›¾ä¸­ï¼Œæœ€é¡¶å±‚çš„å‡½æ•°æ˜¯æ­£åœ¨ä½¿ç”¨CPUçš„å‡½æ•°ï¼Œåœ¨å†…å­˜ç«ç„°å›¾ä¸­ï¼Œæœ€é¡¶å±‚çš„å‡½æ•°æ˜¯æ­£åœ¨ä½¿ç”¨æŒ‡å®šçš„å†…å­˜ç®¡ç†å‡½æ•°çš„å‡½æ•°ã€‚</p>
<h2 id="mallocç­‰å‡½æ•°çš„é‡‡é›†"><a class="header" href="#mallocç­‰å‡½æ•°çš„é‡‡é›†">malloc()ç­‰å‡½æ•°çš„é‡‡é›†</a></h2>
<h2 id="brkå‡½æ•°çš„é‡‡é›†"><a class="header" href="#brkå‡½æ•°çš„é‡‡é›†">brk()å‡½æ•°çš„é‡‡é›†</a></h2>
<h2 id="mmapå‡½æ•°çš„é‡‡é›†"><a class="header" href="#mmapå‡½æ•°çš„é‡‡é›†">mmap()å‡½æ•°çš„é‡‡é›†</a></h2>
<h2 id="ç¼ºé¡µpage-faultsé‡‡é›†"><a class="header" href="#ç¼ºé¡µpage-faultsé‡‡é›†">ç¼ºé¡µï¼ˆPage Faultsï¼‰é‡‡é›†</a></h2>
<h2 id="å‚è€ƒ-161"><a class="header" href="#å‚è€ƒ-161">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç”¨ç«ç„°å›¾åˆ†ææœªå ç”¨cpuæœŸé—´çš„æƒ…å†µ"><a class="header" href="#ç”¨ç«ç„°å›¾åˆ†ææœªå ç”¨cpuæœŸé—´çš„æƒ…å†µ">ç”¨ç«ç„°å›¾åˆ†ææœªå ç”¨CPUæœŸé—´çš„æƒ…å†µ</a></h1>
<p>åº”ç”¨ç¨‹åºçš„æ•ˆç‡ä¸é«˜ï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«CPUä¹‹å¤–çš„èµ„æºé™åˆ¶å¡ä½äº†ã€‚</p>
<p>Brendan D. Greggåœ¨<a href="http://www.brendangregg.com/offcpuanalysis.html">Off-CPU Analysis</a>ä¸€æ–‡ä¸­é˜è¿°äº†è¿™ä¸ªæƒ³æ³•ï¼š</p>
<pre><code>Performance issues can be categorized into one of two types:
    On-CPU: where threads are spending time running on-CPU.
    Off-CPU: where time is spent waiting while blocked on I/O, locks, timers, paging/swapping, etc.
</code></pre>
<p>é€šå¸¸æˆ‘ä»¬æ›´å®¹æ˜“å…³æ³¨On-CPUä¸Šå‘ç”Ÿçš„äº‹æƒ…ï¼Œå®¹æ˜“å¿½ç•¥Off-CPUæœŸé—´å‘ç”Ÿçš„äº‹æƒ…ï¼ŒOff-CPUä»¿ä½›æ°´é¢ä¸‹çš„å†°å±±ï¼ˆä¸‹å›¾ä¸­çš„è“è‰²éƒ¨åˆ†ï¼‰ ï¼š</p>
<p><img src="http://www.brendangregg.com/Perf/thread_states.png" alt="è¿›ç¨‹çš„çŠ¶æ€" /></p>
<p>ç« å®œæ˜¥æœ€æ—©è·µè¡Œäº†Off-CPUçš„æƒ³æ³•ï¼Œåœ¨<a href="http://agentzh.org/misc/slides/off-cpu-flame-graphs.pdf">Introduction to offÂ­CPU Time Flame Graphs</a>ä¸­ç”ŸåŠ¨ç®€æ´åœ°ä»‹ç»äº†è‡ªå·±çš„å®è·µè¿‡ç¨‹ã€‚</p>
<p>ä¸å†…å­˜ç®¡ç†å‡½æ•°æœ‰å¤šä¸ªä¸€æ ·ï¼ŒOff-CPUæœŸé—´æ˜¯æœ‰å¤šä»¶äº‹æƒ…çš„ï¼š</p>
<p><img src="linux/../img/linux/offcputracing-1000.png" alt="Example off-CPU event, with enumerated approaches for analysis" /></p>
<p>I/OæœŸé—´æœ‰File I/Oã€Block Device I/Oï¼Œé€šè¿‡é‡‡é›†è¿›ç¨‹è®©å‡ºCPUæ—¶è°ƒç”¨æ ˆï¼Œå¯ä»¥çŸ¥é“å“ªäº›å‡½æ•°æ­£åœ¨é¢‘ç¹åœ°ç­‰å¾…å…¶å®ƒäº‹ä»¶ï¼Œä»¥è‡³äºéœ€è¦è®©å‡ºCPUï¼Œé€šè¿‡é‡‡é›†è¿›ç¨‹è¢«å”¤é†’æ—¶çš„è°ƒç”¨æ ˆï¼Œå¯ä»¥çŸ¥é“å“ªäº›å‡½æ•°è®©è¿›ç¨‹ç­‰å¾…çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚</p>
<h2 id="file-io-ç«ç„°å›¾"><a class="header" href="#file-io-ç«ç„°å›¾">File I/O ç«ç„°å›¾</a></h2>
<p><img src="linux/../img/linux/fileio-mysqld1.svg" alt="File I/O ç«ç„°å›¾" /></p>
<h2 id="block-io-ç«ç„°å›¾"><a class="header" href="#block-io-ç«ç„°å›¾">Block I/O ç«ç„°å›¾</a></h2>
<p><img src="linux/../img/linux/blockio-mysqld0.svg" alt="Block I/O ç«ç„°å›¾" /></p>
<h2 id="off-cpu-ç«ç„°å›¾"><a class="header" href="#off-cpu-ç«ç„°å›¾">Off-CPU ç«ç„°å›¾</a></h2>
<p><img src="linux/../img/linux/off-mysqld3.svg" alt="Off-CPU ç«ç„°å›¾" /></p>
<h2 id="wakeup-ç«ç„°å›¾"><a class="header" href="#wakeup-ç«ç„°å›¾">Wakeup ç«ç„°å›¾</a></h2>
<p><img src="linux/../img/linux/wakeup-mysqld1.svg" alt="è¿›ç¨‹å”¤é†’ç«ç„°å›¾" /></p>
<h2 id="å‚è€ƒ-162"><a class="header" href="#å‚è€ƒ-162">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å†·çƒ­ç«ç„°å›¾å°†on-cpuç«ç„°å›¾ä¸off-cpuç«ç„°å›¾åˆå¹¶"><a class="header" href="#å†·çƒ­ç«ç„°å›¾å°†on-cpuç«ç„°å›¾ä¸off-cpuç«ç„°å›¾åˆå¹¶">å†·çƒ­ç«ç„°å›¾ï¼šå°†On-CPUç«ç„°å›¾ä¸Off-CPUç«ç„°å›¾åˆå¹¶</a></h1>
<p>æŠŠOn-CPUç«ç„°å›¾å’ŒOff-CPUç«ç„°å›¾åˆå¹¶åœ¨ä¸€èµ·æˆ–è®¸æ›´ä¾¿äºåˆ†æã€‚</p>
<h2 id="ç‹¬ç«‹æ’åˆ—"><a class="header" href="#ç‹¬ç«‹æ’åˆ—">ç‹¬ç«‹æ’åˆ—</a></h2>
<p>è¿™ç§æ–¹å¼å…¶å®å°±æ˜¯æ”¾åœ¨ä¸€èµ·è€Œå·²ï¼Œå‹‰å¼ºç®—æ˜¯ä¸€ç§èåˆæ–¹æ³•å§ã€‚</p>
<p><img src="linux/../img/linux/cpu-mysql-filt-500.png" alt="å†·çƒ­ç«ç„°å›¾ç»„åˆ-ç‹¬ç«‹æ’åˆ—" /></p>
<h2 id="å…±äº«æ¨ªè½´"><a class="header" href="#å…±äº«æ¨ªè½´">å…±äº«æ¨ªè½´</a></h2>
<p>è¿™ç§æ–¹å¼æ˜¯å°†ç«ç„°å›¾çš„æ¨ªè½´è½´å¯¹æ¥èµ·æ¥å…±ç”¨ï¼Œçºµè½´ä¸Šä¾ç„¶æ˜¯æ³¾æ¸­åˆ†æ˜ï¼Œæœ‰æ˜ç¡®çš„è¾¹ç•Œï¼š</p>
<p><img src="linux/../img/linux/hotcoldthread-kernel.svg" alt="å†·çƒ­ç«ç„°å›¾ç»„åˆ-å…±äº«æ¨ªè½´" /></p>
<h2 id="èåˆæ˜¾ç¤º"><a class="header" href="#èåˆæ˜¾ç¤º">èåˆæ˜¾ç¤º</a></h2>
<p>è¿™ç§æ–¹å¼æ˜¯å°½å¯èƒ½çš„On-CPUå’ŒOff-CPUç³…åˆåœ¨ä¸€èµ·ï¼š</p>
<p><img src="linux/../img/linux/eflame-blocking.png" alt="å†·çƒ­ç«ç„°å›¾ç»„åˆ-èåˆæ˜¾ç¤º" /></p>
<h2 id="å‚è€ƒ-163"><a class="header" href="#å‚è€ƒ-163">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å·®å¼‚ç«ç„°å›¾å±•ç¤ºä¸¤ä¸ªç«ç„°å›¾ä¹‹é—´çš„å·®å¼‚"><a class="header" href="#å·®å¼‚ç«ç„°å›¾å±•ç¤ºä¸¤ä¸ªç«ç„°å›¾ä¹‹é—´çš„å·®å¼‚">å·®å¼‚ç«ç„°å›¾ï¼šå±•ç¤ºä¸¤ä¸ªç«ç„°å›¾ä¹‹é—´çš„å·®å¼‚</a></h1>
<p>ç«ç„°å›¾æ˜¯ç”¨æ¥åšæ€§èƒ½åˆ†æçš„ï¼Œé€šè¿‡ç«ç„°åº¦äº†è§£äº†ç¨‹åºè¿è¡ŒæœŸé—´çš„æƒ…å†µä»¥åï¼Œæ¥ä¸‹æ¥æ˜¯æœ‰é’ˆå¯¹æ€§åœ°ä¿®æ”¹è°ƒä¼˜ã€‚
è°ƒæ•´ä¹‹åï¼Œè¿˜éœ€è¦åœ¨åˆ¶ä½œä¸€ä¸ªæ–°çš„ç«ç„°å›¾ï¼Œé€šè¿‡å¯¹æ¯”è°ƒä¼˜å‰å’Œè°ƒä¼˜åçš„ç«ç„°å›¾ï¼Œè¯„ä¼°è°ƒæ•´æ˜¯å¦æœ‰æ•ˆã€‚</p>
<p>æœ‰æ—¶å€™å¯èƒ½å‘ç°ç³»ç»Ÿå‡çº§ä¹‹åï¼ŒæŸäº›æŒ‡æ ‡çªç„¶å‡é«˜ï¼Œè¿™æ—¶å€™ä¹Ÿå¯ä»¥å¯¹æ¯”å‡çº§å‰å’Œå‡çº§åçš„ç«ç„°å›¾ï¼Œæ‰¾åˆ°é‚£äº›è€—æ—¶å¢åŠ çš„å‡½æ•°ã€‚</p>
<p>æœ€ç®€å•çš„å¯¹æ¯”æ–¹å¼å°±æ˜¯å°†ä¿®æ”¹å‰åä¸¤ä¸ªç«ç„°å›¾å¹¶è¡Œæ’åˆ—ï¼Œè‚‰çœ¼æ‰¾ä¸åŒï¼Œè¿™æ ·æ˜¾ç„¶å¾ˆä¸æ–¹ä¾¿ã€‚Brendan Greggæƒ³å‡ºäº†ä¸€æ‹›ï¼šå·®å¼‚ç«ç„°å›¾ï¼ˆDifferential Flame Graphsï¼‰ã€‚</p>
<p>åœ¨æœ€è¿‘ä¸€æ¬¡åˆ¶ä½œçš„ç«ç„°å›¾ä¸Šï¼Œè€—æ—¶ç›¸æ¯”å‰ä¸€æ¬¡å¢åŠ çš„å‡½æ•°ç”¨çº¢è‰²ï¼Œè€—æ—¶å‡å°‘çš„å‡½æ•°ç”¨è“è‰²ï¼š</p>
<p><img src="linux/../img/linux/zfs-flamegraph-diff.svg" alt="å·®å¼‚ç«ç„°å›¾" /></p>
<h2 id="å‚è€ƒ-164"><a class="header" href="#å‚è€ƒ-164">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç«ç„°å›¾ç”Ÿæˆå‘½ä»¤"><a class="header" href="#ç«ç„°å›¾ç”Ÿæˆå‘½ä»¤">ç«ç„°å›¾ç”Ÿæˆå‘½ä»¤</a></h1>
<p>ç«ç„°å›¾çš„ç”Ÿæˆåˆ†ä¸ºé‡‡é›†æ•°æ®å’Œç”Ÿæˆå›¾ç‰‡ä¸¤ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸¤ä¸ªè¿‡ç¨‹ä¸­æœ‰å¤šç§å·¥å…·å¯é€‰ã€‚</p>
<p>é‡‡é›†æ•°æ®çš„å·¥å…·å¯ä»¥æ ¹æ®è‡ªå·±å®é™…æƒ…å†µã€å–œå¥½ä»¥åŠç†Ÿæ‚‰ç¨‹åº¦é€‰å–ã€‚</p>
<p>ç”Ÿæˆå›¾ç‰‡æ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨<a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a>å°±è¶³å¤Ÿäº†ã€‚</p>
<h2 id="ç”¨perfé‡‡é›†è°ƒç”¨æ ˆon-cpu"><a class="header" href="#ç”¨perfé‡‡é›†è°ƒç”¨æ ˆon-cpu">ç”¨perfé‡‡é›†è°ƒç”¨æ ˆï¼ˆOn CPUï¼‰</a></h2>
<p>CPU Flame Graphsçš„<a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html#Instructions">Instructions</a>ç« èŠ‚ä¸­ç»™å‡ºäº†ç”¨perfé‡‡é›†çš„æ–¹æ³•ã€‚</p>
<pre><code class="language-bash">pid=ç›®æ ‡è¿›ç¨‹
perf record -p $pid -F 99 -a -g 
</code></pre>
<p>é‡‡é›†çš„æ•°æ®ä½äºå½“å‰ç›®å½•ä¸­çš„perf.dataæ–‡ä»¶ä¸­ï¼Œç”¨<code>perf script</code>è½¬æ¢æˆå¯è¯»æ ¼å¼ï¼š</p>
<pre><code class="language-bash">perf script &gt; perf.bt
</code></pre>
<p>ç”¨<a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a>ä¸­çš„<code>stackcollapse-perf.pl</code>å’Œ<code>flamegraph.pl</code>ç”Ÿæˆç«ç„°å›¾ï¼š</p>
<pre><code class="language-bash">./FlameGraph/stackcollapse-perf.pl  perf.bt  &gt;perf.cbt
./FlameGraph/flamegraph.pl perf.cbt &gt; perf.svg
</code></pre>
<h2 id="ç”¨stapxxé‡‡é›†è°ƒç”¨æ ˆon-cpu"><a class="header" href="#ç”¨stapxxé‡‡é›†è°ƒç”¨æ ˆon-cpu">ç”¨stapxxé‡‡é›†è°ƒç”¨æ ˆï¼ˆOn CPU)</a></h2>
<blockquote>
<p>æ³¨æ„ï¼šåœ¨é‡‡é›†envoyçš„è°ƒç”¨æ ˆï¼ˆOn CPUï¼‰æ—¶ï¼Œå‘ç°perfæ•ˆæœæ›´å¥½ï¼Œé‡‡é›†å¾—æ›´ç²¾ç»†å’Œå‡†ç¡®ã€‚</p>
</blockquote>
<p><a href="https://github.com/openresty/stapxx">stapxx</a>æ˜¯OpenRestyä½œè€…ç« å®œæ˜¥å¼€å‘çš„ä¸€å¥—è„šæœ¬ï¼Œç®€åŒ–äº†ç”¨SystemTAPé‡‡é›†æ•°æ®çš„æ“ä½œã€‚</p>
<p>éœ€è¦äº‹å…ˆå®‰è£…SystemTAPä»¥åŠkernelçš„debuginfoåŒ…ï¼Œå…·ä½“å®‰è£…å®‰è£…è¿‡ç¨‹å‚è€ƒ<a href="https://www.lijiaocn.com/%E7%BC%96%E7%A8%8B/2018/11/02/openresty-study-03-frame-md.html">Webå¼€å‘å¹³å°OpenRestyï¼ˆä¸‰ï¼‰ï¼šç«ç„°å›¾æ€§èƒ½åˆ†æ</a>ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</p>
<p>å®‰è£…äº†SystemTAPç­‰ä¾èµ–åŒ…ä¹‹åï¼Œä¸‹è½½stapxxè„šæœ¬ï¼š</p>
<pre><code>git clone https://github.com/openresty/stapxx
export PATH=$PATH:`pwd`/stapxx
</code></pre>
<p><code>stapxx/samples</code>ç›®å½•ä¸­æä¾›äº†å¾ˆå¤šè„šæœ¬ï¼Œå¤§éƒ¨åˆ†æ˜¯ç”¨äºopenrestyçš„ï¼Œä½†ä¹Ÿæœ‰å¾ˆå¤šé€šç”¨çš„è„šæœ¬ï¼Œè­¬å¦‚<code>sample-bt.sxx</code>ã€<code>cpu-hogs.sxx</code>ç­‰ã€‚</p>
<pre><code>$ ls stapxx/samples/
cpu-hogs.sxx                   ngx-lj-gc-speed.sxx              ngx-rps.sxx
cpu-robbers.sxx                ngx-lj-trace-exits.sxx           ngx-single-req-latency.sxx
ctx-switches.sxx               ngx-lua-count-timers.sxx         ngx-slow-purge-reqs.sxx
epoll-et-lt.sxx                ngx-lua-exec-time.sxx            ngx-sr-trunc.sxx
epoll-loop-blocking-distr.sxx  ngx-lua-shdict-info.sxx          ngx-timeout-settings.sxx
epoll-loop-blocking.sxx        ngx-lua-shdict-writes.sxx        ngx-upstream-err-log.sxx
epoll-loop-blocking-vfs.sxx    ngx-lua-slow-udp-query.sxx       ngx-upstream-latency.sxx
func-latency-distr.sxx         ngx-lua-tcp-recv-time.sxx        ngx-upstream-next.sxx
lj-bucket-depth-accessed.sxx   ngx-lua-tcp-total-recv-time.sxx  ngx-upstream-post-conn.sxx
lj-find-str.sxx                ngx-lua-udp-recv-time.sxx        ngx-zlib-deflate-time.sxx
lj-gc-objs.sxx                 ngx-lua-udp-total-recv-time.sxx  ngx-zlib-total-deflate-time.sxx
lj-gc.sxx                      ngx-lua-useless-cosockets.sxx    openssl-handshake-diagnosis.sxx
lj-lua-bt.sxx                  ngx-open-file-cache-misses.sxx   probe-rate.sxx
lj-lua-stacks.sxx              ngx-orig-resp-body-len.sxx       sample-bt-leaks.sxx
lj-str-tab.sxx                 ngx-pcre-dist.sxx                sample-bt-leaks-wrapalloc.sxx
lj-trace-exit-rate.sxx         ngx-pcre-top.sxx                 sample-bt.sxx
lj-vm-states.sxx               ngx-req-latency-distr.sxx        slow-vfs-reads.sxx
luajit21-gc64                  ngx-req-pool-allocs.sxx          unix-stream-socks.sxx
ngx-conn-timers.sxx            ngx-req-pool-size.sxx            vfs-page-cache-misses.sxx
ngx-count-conns.sxx            ngx-rewrite-latency-distr.sxx    zlib-deflate-chunk-size.sxx
</code></pre>
<p>è¿™äº›è„šæœ¬çš„ç”¨æ³•åœ¨<a href="https://github.com/openresty/stapxx#table-of-contents">README</a>ä¸­æœ‰è¯´æ˜ï¼Œè¿™é‡Œåªæ¼”ç¤ºéƒ¨åˆ†è„šæœ¬çš„ç”¨æ³•ã€‚</p>
<p>é‡‡é›†æŒ‡å®šè¿›ç¨‹çš„è°ƒç”¨æ ˆï¼š</p>
<pre><code class="language-bash">pid=ç›®æ ‡è¿›ç¨‹
./stapxx/samples/sample-bt.sxx --arg time=20 --skip-badvars -D  MAXSKIPPED=100000 -D MAXMAPENTRIES=100000 -x $pid &gt;resty.bt
</code></pre>
<p>ç”¨<a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a>ä¸­çš„<code>stackcollapse-stap.pl</code>å’Œ<code>flamegraph.pl</code>ç”Ÿæˆç«ç„°å›¾ï¼š</p>
<pre><code class="language-bash">git clone https://github.com/brendangregg/FlameGraph.git
./FlameGraph/stackcollapse-stap.pl resty.bt  &gt;resty.cbt
./FlameGraph/flamegraph.pl resty.cbt &gt; resty.svg
</code></pre>
<h2 id="å‚è€ƒ-165"><a class="header" href="#å‚è€ƒ-165">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bccç³»åˆ—å·¥å…·"><a class="header" href="#bccç³»åˆ—å·¥å…·">BCCç³»åˆ—å·¥å…·</a></h1>
<p>ä½¿ç”¨æ–¹æ³•è§<a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial.md">bcc Tutorial</a></p>
<h2 id="å‚è€ƒ-166"><a class="header" href="#å‚è€ƒ-166">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="cpuä½¿ç”¨ç‡å¾ˆé«˜çš„æ’æŸ¥æ–¹æ³•"><a class="header" href="#cpuä½¿ç”¨ç‡å¾ˆé«˜çš„æ’æŸ¥æ–¹æ³•">CPUä½¿ç”¨ç‡å¾ˆé«˜çš„æ’æŸ¥æ–¹æ³•</a></h1>
<p>è¿™æ˜¯å€ªé¹é£çš„<a href="https://www.lijiaocn.com/linux/img/linux/01-geek-linux-ercode.jpeg">ã€ŠLinuxæ€§èƒ½ä¼˜åŒ–å®æˆ˜ã€‹</a>ä¸­çš„æ¡ˆä¾‹ï¼Œè¿™é‡Œåšäº†äºŒæ¬¡åŠ å·¥ï¼ŒæŠ½å–äº†ä¸»è¦è¿‡ç¨‹ï¼Œæ¡ˆä¾‹æ˜¯å€ªé¹é£åŸæ–‡ä¸­çš„ã€‚</p>
<h2 id="ç”¨topæŸ¥çœ‹cpuä½¿ç”¨æƒ…å†µ"><a class="header" href="#ç”¨topæŸ¥çœ‹cpuä½¿ç”¨æƒ…å†µ">ç”¨topæŸ¥çœ‹CPUä½¿ç”¨æƒ…å†µ</a></h2>
<p>åœ¨topä¸­çœ‹CPUçš„ä½¿ç”¨ç‡å¾ˆé«˜ï¼Œè¾¾åˆ°äº†80%ä»¥ä¸Šï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹çš„CPUä½¿ç”¨ç‡éƒ½å¾ˆä½ï¼š</p>
<pre><code class="language-sh">$ top
...
%Cpu(s): 80.8 us, 15.1 sy,  0.0 ni,  2.8 id,  0.0 wa,  0.0 hi,  1.3 si,  0.0 st
...

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 6882 root      20   0    8456   5052   3884 S   2.7  0.1   0:04.78 docker-containe
 6947 systemd+  20   0   33104   3716   2340 S   2.7  0.0   0:04.92 nginx
 7494 daemon    20   0  336696  15012   7332 S   2.0  0.2   0:03.55 php-fpm
 7495 daemon    20   0  336696  15160   7480 S   2.0  0.2   0:03.55 php-fpm
10547 daemon    20   0  336696  16200   8520 S   2.0  0.2   0:03.13 php-fpm
10155 daemon    20   0  336696  16200   8520 S   1.7  0.2   0:03.12 php-fpm
10552 daemon    20   0  336696  16200   8520 S   1.7  0.2   0:03.12 php-fpm
15006 root      20   0 1168608  66264  37536 S   1.0  0.8   9:39.51 dockerd
 4323 root      20   0       0      0      0 I   0.3  0.0   0:00.87 kworker/u4:1
...
</code></pre>
<h2 id="ç”¨pidstatæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€"><a class="header" href="#ç”¨pidstatæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€">ç”¨pidstatæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€</a></h2>
<p>æ¯é—´éš”1ç§’è¾“å‡ºä¸€ç»„è¿›ç¨‹çš„çŠ¶æ€ï¼Œæ¯ä¸ªè¿›ç¨‹çš„CPUä½¿ç”¨ç‡éƒ½ä¸é«˜ï¼š</p>
<pre><code class="language-sh">$ pidstat 1
...
04:36:24      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
04:36:25        0      6882    1.00    3.00    0.00    0.00    4.00     0  docker-containe
04:36:25      101      6947    1.00    2.00    0.00    1.00    3.00     1  nginx
04:36:25        1     14834    1.00    1.00    0.00    1.00    2.00     0  php-fpm
04:36:25        1     14835    1.00    1.00    0.00    1.00    2.00     0  php-fpm
04:36:25        1     14845    0.00    2.00    0.00    2.00    2.00     1  php-fpm
04:36:25        1     14855    0.00    1.00    0.00    1.00    1.00     1  php-fpm
04:36:25        1     14857    1.00    2.00    0.00    1.00    3.00     0  php-fpm
04:36:25        0     15006    0.00    1.00    0.00    0.00    1.00     0  dockerd
04:36:25        0     15801    0.00    1.00    0.00    0.00    1.00     1  pidstat
04:36:25        1     17084    1.00    0.00    0.00    2.00    1.00     0  stress
04:36:25        0     31116    0.00    1.00    0.00    0.00    1.00     0  atopacctd
...
</code></pre>
<h2 id="è§‚å¯Ÿtopä¸­çš„tasks"><a class="header" href="#è§‚å¯Ÿtopä¸­çš„tasks">è§‚å¯Ÿtopä¸­çš„tasks</a></h2>
<p>topä¸­æ˜¾ç¤º149ä¸ªtaskï¼Œæœ‰6ä¸ªåœ¨runningçŠ¶æ€ï¼Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ•°åé«˜ï¼ˆæ¡ˆä¾‹ä¸­çš„æœºå™¨ä¸Šï¼Œåªè¿è¡Œäº†ä¸€ä¸ªphpå¼€å‘çš„webåº”ç”¨ï¼Œç”¨abå¯¹å…¶å‘èµ·äº†5ä¸ªå¹¶å‘çš„å‹æµ‹ï¼‰ã€‚</p>
<pre><code class="language-sh">$ top
top - 04:58:24 up 14 days, 15:47,  1 user,  load average: 3.39, 3.82, 2.74
Tasks: 149 total,   6 running,  93 sleeping,   0 stopped,   0 zombie
%Cpu(s): 77.7 us, 19.3 sy,  0.0 ni,  2.0 id,  0.0 wa,  0.0 hi,  1.0 si,  0.0 st
KiB Mem :  8169348 total,  2543916 free,   457976 used,  5167456 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  7363908 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 6947 systemd+  20   0   33104   3764   2340 S   4.0  0.0   0:32.69 nginx
 6882 root      20   0   12108   8360   3884 S   2.0  0.1   0:31.40 docker-containe
15465 daemon    20   0  336696  15256   7576 S   2.0  0.2   0:00.62 php-fpm
15466 daemon    20   0  336696  15196   7516 S   2.0  0.2   0:00.62 php-fpm
15489 daemon    20   0  336696  16200   8520 S   2.0  0.2   0:00.62 php-fpm
 6948 systemd+  20   0   33104   3764   2340 S   1.0  0.0   0:00.95 nginx
15006 root      20   0 1168608  65632  37536 S   1.0  0.8   9:51.09 dockerd
15476 daemon    20   0  336696  16200   8520 S   1.0  0.2   0:00.61 php-fpm
15477 daemon    20   0  336696  16200   8520 S   1.0  0.2   0:00.61 php-fpm
24340 daemon    20   0    8184   1616    536 R   1.0  0.0   0:00.01 stress
24342 daemon    20   0    8196   1580    492 R   1.0  0.0   0:00.01 stress
24344 daemon    20   0    8188   1056    492 R   1.0  0.0   0:00.01 stress
24347 daemon    20   0    8184   1356    540 R   1.0  0.0   0:00.01 stress
...
</code></pre>
<p>åŒæ—¶ï¼Œtopä¸­æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ˜¯stressã€‚</p>
<h2 id="ç”¨pidstatpsæŸ¥çœ‹runningçŠ¶æ€çš„è¿›ç¨‹"><a class="header" href="#ç”¨pidstatpsæŸ¥çœ‹runningçŠ¶æ€çš„è¿›ç¨‹">ç”¨pidstat/psæŸ¥çœ‹runningçŠ¶æ€çš„è¿›ç¨‹</a></h2>
<p>ç”¨pidstatæŸ¥çœ‹runningçŠ¶æ€çš„stressè¿›ç¨‹ï¼Œç»“æœæ²¡æœ‰è¯¥è¿›ç¨‹çš„æ•°æ®ï¼š</p>
<pre><code class="language-sh">$ pidstat -p 24344

16:14:55      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
</code></pre>
<p>ç”¨psæŸ¥çœ‹ï¼Œå‘ç°è¿™ä¸ªè¿›ç¨‹ä¸å­˜åœ¨ï¼š</p>
<pre><code class="language-sh">$ ps aux | grep 24344
root      9628  0.0  0.0  14856  1096 pts/0    S+   16:15   0:00 grep --color=auto 24344
</code></pre>
<p>åˆ°äº†å…³é”®æ—¶åˆ»ï¼Œä¸ºä»€ä¹ˆæ­£åœ¨runningçš„è¿›ç¨‹ä¸å­˜åœ¨ï¼Œè¿™äº›æ¶ˆå¤±çš„è¿›ç¨‹å’Œcpuçš„ä½¿ç”¨ç‡é«˜æœ‰æ²¡æœ‰å…³ç³»ï¼Ÿ</p>
<p>å†æ¬¡ç”¨topè§‚å¯ŸrunningçŠ¶æ€çš„è¿›ç¨‹ï¼Œå‘ç°stressè¿›ç¨‹çš„è¿›ç¨‹å·ä¸€ç›´å˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œstressè¿›ç¨‹ä¸åœçš„é€€å‡ºï¼Œ
åŒæ—¶åˆä¸æ–­çš„æ–°å»ºã€‚</p>
<h2 id="ç”¨pstreeæŸ¥çœ‹è¿›ç¨‹çš„çˆ¶å­å…³ç³»"><a class="header" href="#ç”¨pstreeæŸ¥çœ‹è¿›ç¨‹çš„çˆ¶å­å…³ç³»">ç”¨pstreeæŸ¥çœ‹è¿›ç¨‹çš„çˆ¶å­å…³ç³»</a></h2>
<p>ç”¨pstreeæ‰¾åˆ°åˆ›å»ºstressè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œstressè¿›ç¨‹æ˜¯php-fpmé€šè¿‡shåˆ›å»ºçš„ï¼š</p>
<pre><code class="language-sh">$ pstree | grep stress
        |-docker-containe-+-php-fpm-+-php-fpm---sh---stress
        |         |-3*[php-fpm---sh---stress---stress]
</code></pre>
<p>pstreeå®‰è£…æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">yum install -y psmisc
</code></pre>
<h2 id="æ£€æŸ¥phpåº”ç”¨ä»£ç "><a class="header" href="#æ£€æŸ¥phpåº”ç”¨ä»£ç ">æ£€æŸ¥phpåº”ç”¨ä»£ç </a></h2>
<p>æ£€æŸ¥phpåº”ç”¨ä»£ç å‘ç°ï¼Œä»£ç ä¸­è°ƒç”¨äº†stresså‘½ä»¤ï¼Œæ¨¡æ‹ŸI/Oå‹åŠ›ï¼Œä½†æ˜¯ç”¨topçœ‹åˆ°çš„ç°è±¡æ˜¯cpuä½¿ç”¨ç‡é«˜ï¼Œè¿™æ˜¯æ¯”è¾ƒå¥‡æ€ªçš„åœ°æ–¹ï¼šã€‚</p>
<pre><code class="language-php">$ cat app/index.php
&lt;?php
// fake I/O with stress (via write()/unlink()).
$result = exec(&quot;/usr/local/bin/stress -t 1 -d 1 2&gt;&amp;1&quot;, $output, $status);
if (isset($_GET[&quot;verbose&quot;]) &amp;&amp; $_GET[&quot;verbose&quot;]==1 &amp;&amp; $status != 0) {
  echo &quot;Server internal error: &quot;;
  print_r($output);
} else {
  echo &quot;It works!&quot;;
}
?&gt;
</code></pre>
<p>æ£€æŸ¥è¿™éƒ¨åˆ†ä»£ç çš„è¿è¡Œæ—¥å¿—ï¼Œå‘ç°stresså‘½ä»¤æ²¡æœ‰æˆåŠŸï¼Œå› ä¸ºæƒé™é—®é¢˜ç›´æ¥é€€å‡ºäº†ï¼š</p>
<pre><code>$ curl http://192.168.0.10:10000?verbose=1
Server internal error: Array
(
    [0] =&gt; stress: info: [19607] dispatching hogs: 0 cpu, 0 io, 0 vm, 1 hdd
    [1] =&gt; stress: FAIL: [19608] (563) mkstemp failed: Permission denied
    [2] =&gt; stress: FAIL: [19607] (394) &lt;-- worker 19608 returned error 1
    [3] =&gt; stress: WARN: [19607] (396) now reaping child worker processes
    [4] =&gt; stress: FAIL: [19607] (400) kill error: No such process
    [5] =&gt; stress: FAIL: [19607] (451) failed run completed in 0s
)
</code></pre>
<p>åˆæ­¥æ€€ç–‘ï¼Œç”¨phpè°ƒç”¨çš„stressæ²¡æœ‰æƒé™åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œå¯¼è‡´å¤§é‡çš„stressè¿›ç¨‹ä¸åœåœ°åˆ›å»ºé€€å‡ºï¼Œä»è€Œæ˜¯CPUä½¿ç”¨ç‡å¢é«˜ï¼Œå› ä¸ºè¿™äº›è¿›ç¨‹å¾ˆå¿«é€€å‡ºï¼Œåœ¨topä¸­èƒ½çœ‹åˆ°çš„stressè¿›ç¨‹çš„CPUä½¿ç”¨ç‡éƒ½å¾ˆä½ã€‚</p>
<h2 id="ç”¨perfæŸ¥çœ‹15ç§’å†…çš„cpuæ€§èƒ½æŠ¥å‘Š"><a class="header" href="#ç”¨perfæŸ¥çœ‹15ç§’å†…çš„cpuæ€§èƒ½æŠ¥å‘Š">ç”¨perfæŸ¥çœ‹15ç§’å†…çš„CPUæ€§èƒ½æŠ¥å‘Š</a></h2>
<p><code>-a</code>æŸ¥çœ‹æ‰€æœ‰cpuï¼š</p>
<pre><code class="language-sh">perf record -ag  -- sleep 15;perf report
</code></pre>
<p>perf reportä¸­æ˜¾ç¤ºï¼Œstressè¿›ç¨‹çš„cpuäº‹ä»¶å æ¯”æ˜¯77%ï¼Œå®ƒå¤§é‡è°ƒç”¨äº†éšæœºæ•°ç”Ÿæˆå‡½æ•°random()ï¼Œç¡®å®šæ˜¯å®ƒå¯¼è‡´CPUä½¿ç”¨ç‡é«˜ï¼š</p>
<p><img src="linux/../img/perf-report-1.png" alt="perf-report" /></p>
<h2 id="å°ç»“ä¸execsnoop"><a class="header" href="#å°ç»“ä¸execsnoop">å°ç»“ä¸execsnoop</a></h2>
<p>å€ªé¹é£è®¾è®¡çš„è¿™ä¸ªæ¡ˆä¾‹ç‰¹åˆ«å…¸å‹ï¼Œé—®é¢˜æ ¹æºç‰¹åˆ«éšè”½ï¼Œå¯¼è‡´CPUä½¿ç”¨ç‡é«˜çš„stressè¿›ç¨‹å¾ˆå¿«é€€å‡ºï¼Œå¦‚æœåªè§‚å¯Ÿè¿›ç¨‹çš„cpuä½¿ç”¨ç‡ï¼Œæ˜¯æ‰¾ä¸åˆ°é—®é¢˜æ ¹æºçš„ï¼Œéœ€è¦ä»taskä¸­å‘ç°å¼‚å¸¸ï¼Œ åœ¨ç”¨pstreeå˜æ¸…è¿›ç¨‹å…³ç³»ï¼Œä»stressçš„çˆ¶è¿›ç¨‹å…¥æ‰‹ï¼Œæœ€åç”¨perf reportåå®ã€‚</p>
<p>æ’æŸ¥è¿‡ç¨‹å’Œæ’æŸ¥æ€è·¯æ‰æ˜¯é‡ç‚¹ã€‚</p>
<p>å¦å¤–ï¼Œæœ‰ä¸€ä¸ªåä¸º<code>execsnoop</code>çš„å·¥å…·ï¼Œä¸“é—¨ç”¨æ¥ç›‘æ§çŸ­æ—¶è¿›ç¨‹ï¼Œç”¨execsnoopç›‘æ§çš„æ—¶å€™ï¼Œä¼šå‘ç°å¤§é‡çš„stressè¿›ç¨‹ä¸åœçš„å¯åŠ¨ï¼š</p>
<pre><code class="language-sh"># æŒ‰ Ctrl+C ç»“æŸ
$ execsnoop
PCOMM            PID    PPID   RET ARGS
sh               30394  30393    0
stress           30396  30394    0 /usr/local/bin/stress -t 1 -d 1
sh               30398  30393    0
stress           30399  30398    0 /usr/local/bin/stress -t 1 -d 1
sh               30402  30400    0
stress           30403  30402    0 /usr/local/bin/stress -t 1 -d 1
sh               30405  30393    0
stress           30407  30405    0 /usr/local/bin/stress -t 1 -d 1
...
</code></pre>
<h2 id="execsnoopå®‰è£…æ–¹æ³•"><a class="header" href="#execsnoopå®‰è£…æ–¹æ³•">execsnoopå®‰è£…æ–¹æ³•</a></h2>
<p>å®‰è£…bccï¼Œexecsnoopæ˜¯bccä¸­çš„ä¸€ä¸ªå·¥å…·ï¼š</p>
<pre><code class="language-sh">yum install -y bcc
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œexecsnoopä¸åœ¨<code>*/bin</code>ç›®å½•ä¸­ï¼ˆå–å†³äºCentOSç‰ˆæœ¬ï¼‰ï¼š</p>
<pre><code class="language-sh">$ ls /usr/share/bcc/tools/execsnoop
/usr/share/bcc/tools/execsnoop
</code></pre>
<p>å¦‚æœé‡åˆ°ä¸‹é¢çš„é”™è¯¯ï¼Œè¯´æ˜å†…æ ¸ç‰ˆæœ¬å¤ªä½ï¼Œä¸æ”¯æŒebpfï¼Œéœ€è¦å‡çº§åˆ°4.1ä»¥ä¸Šï¼Œå¹¶å®‰è£…kernel-develï¼š</p>
<pre><code class="language-sh">[root@prod-k8s-node-138-127 phops]# /usr/share/bcc/tools/execsnoop
In file included from &lt;built-in&gt;:2:
/virtual/include/bcc/bpf.h:13:10: fatal error: 'linux/bpf_common.h' file not found
#include &lt;linux/bpf_common.h&gt;
         ^~~~~~~~~~~~~~~~~~~~
1 error generated.
Traceback (most recent call last):
  File &quot;/usr/share/bcc/tools/execsnoop&quot;, line 166, in &lt;module&gt;
    b = BPF(text=bpf_text)
  File &quot;/usr/lib/python2.7/site-packages/bcc/__init__.py&quot;, line 318, in __init__
    raise Exception(&quot;Failed to compile BPF text&quot;)
Exception: Failed to compile BPF text
</code></pre>
<h2 id="å‚è€ƒ-167"><a class="header" href="#å‚è€ƒ-167">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å­¦æ ¡é‡Œå­¦ä¸åˆ°çš„linuxç³»ç»ŸçŸ¥è¯†"><a class="header" href="#å­¦æ ¡é‡Œå­¦ä¸åˆ°çš„linuxç³»ç»ŸçŸ¥è¯†">å­¦æ ¡é‡Œå­¦ä¸åˆ°çš„Linuxç³»ç»ŸçŸ¥è¯†</a></h1>
<p>æœ‰éå¸¸ã€éå¸¸å¤šçš„ç»†èŠ‚æ˜¯ä»ä¹¦æœ¬ä¸Šå­¦ä¸åˆ°ï¼Œè¿™äº›ç»†èŠ‚é€šå¸¸åˆ†æ•£åœ¨å„ç§å¤æœ´ã€éš¾åº¦çš„æ–‡æ¡£å’Œæ‰‹å†Œä¸­ã€‚</p>
<p>è¿™äº›çŸ¥è¯†åœ¨ä¸çŸ¥é“çš„æ—¶å€™ï¼Œæ„Ÿè§‰å¾ˆç®€å•ï¼ŒçŸ¥é“ä»¥åæ‰å‘ç°ï¼ŒåŸæ¥æœ‰è¿™ä¹ˆå¤šçš„ç»†èŠ‚ã€‚</p>
<p><a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/index.html">TCP Keepalive HOWTO</a></p>
<p>è®¾ç½®æœ¬åœ°å¯ç”¨çš„tcpç«¯å£ï¼š<a href="https://ma.ttias.be/linux-increase-ip_local_port_range-tcp-port-range/">Linux increase ip_local_port_range TCP port range</a></p>
<p><a href="https://www.thegeekdiary.com/how-to-enable-disk-quotas-on-an-xfs-file-system/">How to Enable Disk Quotas on an XFS File System</a></p>
<p><a href="https://www.cnblogs.com/sammyliu/p/4543110.html">KVMä»‹ç»ç³»åˆ—æ–‡ç« </a></p>
<p><a href="https://www.linux.com/learn/intro-to-linux/2017/7/introduction-sS-command">An Introduction to the ss Command</a></p>
<p><a href="http://linux.51yip.com/search/perf">perfçš„ä½¿ç”¨</a></p>
<p><a href="https://www.debian.org/doc/manuals/debian-reference/index.en.html">Debian Reference</a></p>
<h2 id="å‚è€ƒ-168"><a class="header" href="#å‚è€ƒ-168">å‚è€ƒ</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macmacos-ä½¿ç”¨æ‰‹å†Œå¼€å‘äººå‘˜å¸¸ç”¨å‘½ä»¤"><a class="header" href="#macmacos-ä½¿ç”¨æ‰‹å†Œå¼€å‘äººå‘˜å¸¸ç”¨å‘½ä»¤">Mac/macOS ä½¿ç”¨æ‰‹å†Œï¼Œå¼€å‘äººå‘˜å¸¸ç”¨å‘½ä»¤</a></h1>
<p>Mac å‡ ä¹æˆä¸ºç¨‹åºå‘˜çš„æ ‡å‡†å¼€å‘ç¯å¢ƒäº†ï¼Œä½†æ˜¯ <a href="https://en.wikipedia.org/wiki/MacOS" title="MacOS">MacOS</a> ç³»ç»Ÿçš„å‘½ä»¤è¡ŒæŒ‡ä»¤å¯¹å¤§å¤šæ•°äººæ¥è¯´ï¼Œè¿˜æ˜¯å¾ˆé™Œç”Ÿçš„ï¼Œéƒ¨åˆ†æŒ‡ä»¤æ˜¯ BSD é£æ ¼çš„ï¼Œä¸ linux çš„æ“ä½œå‘½ä»¤çš„å½¢ä¼¼è€Œä¸åŒï¼Œä¹Ÿå¸¸å¸¸å¸¦æ¥å›°æ‰°ã€‚è¿™é‡Œæ”¶é›†åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¼šç»å¸¸ç”¨åˆ°çš„ MacOS å‘½ä»¤è¡ŒæŒ‡ä»¤ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="å¸¸ç”¨è½¯ä»¶åœ¨-mac-ä¸Šçš„å®‰è£…å’Œä½¿ç”¨"><a class="header" href="#å¸¸ç”¨è½¯ä»¶åœ¨-mac-ä¸Šçš„å®‰è£…å’Œä½¿ç”¨">å¸¸ç”¨è½¯ä»¶åœ¨ Mac ä¸Šçš„å®‰è£…å’Œä½¿ç”¨</a></h1>
<h2 id="å¿…å¤‡è½¯ä»¶"><a class="header" href="#å¿…å¤‡è½¯ä»¶">å¿…å¤‡è½¯ä»¶</a></h2>
<p>å®‰è£… <a href="https://brew.sh/">brew</a>:
ã€€</p>
<pre><code class="language-sh">/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)&quot;
</code></pre>
<p>å®‰è£… <a href="https://www.iterm2.com/">iterm2</a>:</p>
<pre><code class="language-sh">ä¸‹è½½è§£å‹ï¼Œæ‹–åŠ¨åˆ°åº”ç”¨ç¨‹åº
</code></pre>
<p>å®‰è£…<a href="https://ohmyz.sh/">oh-my-zsh</a>:</p>
<pre><code class="language-sh">sh -c &quot;$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;
</code></pre>
<p>å…¶å®ƒè½¯ä»¶ï¼š</p>
<pre><code class="language-sh">brew cask install gitbook
sudo gem install bundler jekyll
brew install npm
npm install -g gitbook-cli
</code></pre>
<h2 id="æ•°æ®åº“å›¾å½¢å·¥å…·"><a class="header" href="#æ•°æ®åº“å›¾å½¢å·¥å…·">æ•°æ®åº“å›¾å½¢å·¥å…·</a></h2>
<p>mysql å›¾å½¢ç•Œé¢ç®¡ç†å·¥å…·ï¼šsequel-proã€mysqlworkbenchï¼š</p>
<pre><code class="language-sh">brew cask install sequel-pro mysqlworkbench
</code></pre>
<p>é€šç”¨çš„æ•°æ®åº“å›¾å½¢ç•Œé¢å·¥å…·ï¼šnavicat-premium</p>
<pre><code class="language-sh">brew cask install navicat-premium
</code></pre>
<p><a href="https://www.codementor.io/@engineerapart/getting-started-with-postgresql-on-mac-osx-are8jcopb" title="Getting Started with PostgreSQL on Mac OSX">Getting Started with PostgreSQL on Mac OSX</a> åˆ—å‡ºäº†å‡ ä¸ª postgres çš„å›¾å½¢ç•Œé¢ç®¡ç†å·¥å…·:</p>
<ul>
<li>Postico</li>
<li>pgAdmin</li>
</ul>
<h2 id="postgres"><a class="header" href="#postgres">postgres</a></h2>
<p><a href="https://www.postgresql.org/" title="PostgreSQL">PostgreSQL</a> å¥½åƒè¶Šæ¥è¶Šæµè¡Œäº†ã€‚</p>
<p>æ¨èï¼š</p>
<ul>
<li><a href="https://www.codementor.io/@engineerapart/getting-started-with-postgresql-on-mac-osx-are8jcopb" title="Getting Started with PostgreSQL on Mac OSX">Getting Started with PostgreSQL on Mac OSX</a></li>
</ul>
<p>ä»¥å‰çš„ç¬”è®°ï¼š</p>
<ul>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2017/08/31/postgre-usage.html">PostgresSQLæ•°æ®åº“æ–°æ‰‹å…¥é—¨</a></li>
<li><a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2018/09/28/postgres-user-manage.html">æ–°å»ºç”¨æˆ·æ€æ ·æ‰èƒ½ç”¨å¯†ç ç™»é™†ï¼Ÿ</a></li>
</ul>
<h3 id="å®‰è£…-postgres"><a class="header" href="#å®‰è£…-postgres">å®‰è£… postgres</a></h3>
<p>åœ¨ Mac ä¸Šç”¨ brew å®‰è£…ï¼š</p>
<pre><code class="language-sh">$ brew search postgres
postgresql@11   postgresql@10   postgresql@9.4    postgresql@9.5   postgresql@9.6

$ brew install postgresql@11
</code></pre>
<p>å®‰è£…å®Œæˆåæ˜¾ç¤ºæ“ä½œæç¤ºï¼š</p>
<pre><code class="language-sh">To migrate existing data from a previous major version of PostgreSQL run:
  brew postgresql-upgrade-database

postgresql@11 is keg-only, which means it was not symlinked into /usr/local,
because this is an alternate version of another formula.

If you need to have postgresql@11 first in your PATH run:
  echo 'export PATH=&quot;/usr/local/opt/postgresql@11/bin:$PATH&quot;' &gt;&gt; ~/.zshrc

For compilers to find postgresql@11 you may need to set:
  export LDFLAGS=&quot;-L/usr/local/opt/postgresql@11/lib&quot;
  export CPPFLAGS=&quot;-I/usr/local/opt/postgresql@11/include&quot;

For pkg-config to find postgresql@11 you may need to set:
  export PKG_CONFIG_PATH=&quot;/usr/local/opt/postgresql@11/lib/pkgconfig&quot;


To have launchd start postgresql@11 now and restart at login:
  brew services start postgresql@11
Or, if you don't want/need a background service you can just run:
  pg_ctl -D /usr/local/var/postgresql@11 start
</code></pre>
<p>è®¾ç½®ç¯å¢ƒå˜é‡ï¼š</p>
<pre><code class="language-sh">echo 'export PATH=&quot;/usr/local/opt/postgresql@11/bin:$PATH&quot;' &gt;&gt; ~/.zshrc
</code></pre>
<p>éªŒè¯ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sh">$ postgres -V
postgres (PostgreSQL) 11.6
</code></pre>
<h3 id="å‘½ä»¤è¡Œå·¥å…·çš„å•ç‹¬å®‰è£…"><a class="header" href="#å‘½ä»¤è¡Œå·¥å…·çš„å•ç‹¬å®‰è£…">å‘½ä»¤è¡Œå·¥å…·çš„å•ç‹¬å®‰è£…</a></h3>
<p>å¦‚æœåªæ˜¯è¦ä»æœ¬åœ°è®¿é—® postgresï¼Œå¯ä»¥åªå®‰è£…å‘½ä»¤è¡Œå·¥å…·ï¼š</p>
<pre><code class="language-sh">$ brew install pgcli
...
If you need to have libpq first in your PATH run:
  echo 'export PATH=&quot;/usr/local/opt/libpq/bin:$PATH&quot;' &gt;&gt; ~/.zshrc

For compilers to find libpq you may need to set:
  export LDFLAGS=&quot;-L/usr/local/opt/libpq/lib&quot;
  export CPPFLAGS=&quot;-I/usr/local/opt/libpq/include&quot;

For pkg-config to find libpq you may need to set:
  export PKG_CONFIG_PATH=&quot;/usr/local/opt/libpq/lib/pkgconfig&quot;
</code></pre>
<h3 id="å¯åŠ¨-postgres"><a class="header" href="#å¯åŠ¨-postgres">å¯åŠ¨ postgres</a></h3>
<p>å¯åŠ¨ postgresï¼š</p>
<pre><code class="language-sh">$ brew services start postgresql@11
==&gt; Successfully started `postgresql@11` (label: homebrew.mxcl.postgresql@11)
</code></pre>
<p>æŸ¥çœ‹çŠ¶æ€ï¼š</p>
<pre><code class="language-sh">$ brew services list |grep postgres
postgresql@11 started lijiao /Users/lijiao/Library/LaunchAgents/homebrew.mxcl.postgresql@11.plist
</code></pre>
<p>é»˜è®¤æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼š</p>
<pre><code class="language-sh">$ ls /usr/local/var/postgresql@11
PG_VERSION           pg_ident.conf        pg_snapshots         pg_wal
base                 pg_logical           pg_stat              pg_xact
global               pg_multixact         pg_stat_tmp          postgresql.auto.conf
pg_commit_ts         pg_notify            pg_subtrans          postgresql.conf
pg_dynshmem          pg_replslot          pg_tblspc            postmaster.opts
pg_hba.conf          pg_serial            pg_twophase          postmaster.pid
</code></pre>
<h3 id="ç¬¬ä¸€æ¬¡ç™»é™†"><a class="header" href="#ç¬¬ä¸€æ¬¡ç™»é™†">ç¬¬ä¸€æ¬¡ç™»é™†</a></h3>
<p>æœ¬åœ°ç™»é™† postgresï¼š</p>
<pre><code class="language-sh">$ psql postgres
psql (11.6)
Type &quot;help&quot; for help.

postgres=#
</code></pre>
<p>é»˜è®¤åˆ›å»ºçš„ roleï¼ˆç”¨æˆ·ï¼‰ï¼š</p>
<pre><code class="language-sh">postgres=# \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 lijiao    | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
</code></pre>
<p>æ‰€åœ¨çš„ç³»ç»Ÿçš„å½“å‰ç”¨æˆ·ä¼šè¢«è‡ªåŠ¨åˆ›å»ºä¸º postgres çš„è¶…çº§ç”¨æˆ·ï¼Œæ‰€ä»¥åœ¨æœ¬åœ°å¯ä»¥ç›´æ¥ç”¨ <code>psql postgres</code> ç™»é™†ã€‚</p>
<h3 id="åˆ›å»ºå…¶å®ƒç”¨æˆ·"><a class="header" href="#åˆ›å»ºå…¶å®ƒç”¨æˆ·">åˆ›å»ºå…¶å®ƒç”¨æˆ·</a></h3>
<p>åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ï¼š</p>
<pre><code class="language-sql">create user postgresdemo with password 'password123';
</code></pre>
<p>åœ¨æœ¬åœ°ç”¨æ–°ç”¨æˆ·ç™»é™†ï¼ˆæ³¨æ„æŒ‡å®š -h 127.0.0.1 -p 5432ï¼‰ï¼š</p>
<pre><code class="language-sh">$ psql -h 127.0.0.1 -p 5432 -U postgresdemo
Password:
psql (11.6)
Type &quot;help&quot; for help.

postgres=&gt;
</code></pre>
<p>æœ¬åœ°ç™»é™†æ—¶ï¼Œå¯èƒ½æ— éœ€å¯†ç å°±æˆåŠŸäº†ï¼Œè¿œç¨‹ç™»é™†æ—¶å¯èƒ½å¯†ç æ­£ç¡®ä¹Ÿæ— æ³•ç™»é™†ï¼Œè¿™æ˜¯ postgres çš„è®¤è¯é…ç½®å¯¼è‡´çš„ï¼š</p>
<pre><code class="language-sh">$ cat /usr/local/var/postgresql@11/pg_hba.conf |grep all
local   all             all                                     trust
host    all             all             127.0.0.1/32            trust
host    all             all             ::1/128                 trust
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            trust
host    replication     all             ::1/128                 trust
</code></pre>
<p>é»˜è®¤å¯¹æœ¬åœ°å…¨éƒ¨ä¿¡ä»»ï¼ˆ<code>trust</code>ï¼‰ï¼Œæ²¡æœ‰é…ç½®å…¶å®ƒæ¥æºè®¿é—®ã€‚</p>
<p>ç”¨ä¸‹é¢çš„é…ç½®å…è®¸ postgresdemo ç”¨æˆ·ä»ä»»ä½•åœ°å€è®¿é—®æ‰€æœ‰æ•°æ®åº“ï¼Œé€šè¿‡å¯†ç è®¤è¯ï¼š</p>
<pre><code class="language-sh"># TYPE  DATABASE   USER          ADDRESS      METHOD
  host  all        postgresdemo  0.0.0.0/0    password
</code></pre>
<p>æ·»åŠ é…ç½®åéœ€è¦é‡å¯ postgresqlï¼Œè¯¦ç»†è¯´æ˜è§ï¼š<a href="https://www.lijiaocn.com/%E6%8A%80%E5%B7%A7/2018/09/28/postgres-user-manage.html"> Postgres æ–°å»ºç”¨æˆ·æ€æ ·æ‰èƒ½ç”¨å¯†ç ç™»é™†ï¼Ÿ</a></p>
<h3 id="åˆ›å»ºæ•°æ®åº“"><a class="header" href="#åˆ›å»ºæ•°æ®åº“">åˆ›å»ºæ•°æ®åº“</a></h3>
<p>åˆ›å»ºæ•°æ®åº“å¹¶æˆæƒç»™ postgresdemoï¼š</p>
<pre><code class="language-mysql">create database postgresdemo;
grant all on database  postgresdemo to postgresdemo;
</code></pre>
<p>å¦‚æœè¦é™åˆ¶è¯¥æ•°æ®åº“çš„è®¿é—®æ–¹å¼ï¼Œå¯ä»¥åœ¨ pg_hba.conf æ·»åŠ ç±»ä¼¼é…ç½®ï¼š</p>
<pre><code class="language-sh"># TYPE  DATABASE        USER            ADDRESS      METHOD
  host  postgresdemo    postgresdemo    0.0.0.0/0    password
</code></pre>
<p>æ•°æ®åº“æ“ä½œ:</p>
<pre><code class="language-sh">\list: lists all the databases in Postgres
\connect: connect to a specific database
\dt: list the tables in the currently connected database
</code></pre>
<h2 id="å‚è€ƒ-169"><a class="header" href="#å‚è€ƒ-169">å‚è€ƒ</a></h2>
<ol>
<li><a href="https://www.lijiaocn.com" title="æä½¶æ¾³çš„åšå®¢">æä½¶æ¾³çš„åšå®¢</a></li>
<li><a href="https://www.postgresql.org/" title="PostgreSQL">PostgreSQL</a></li>
<li><a href="https://www.lijiaocn.com/tags/all.html#postgres" title="postgres usage">PostgreSQL ä½¿ç”¨æ–¹æ³•</a></li>
<li><a href="https://www.codementor.io/@engineerapart/getting-started-with-postgresql-on-mac-osx-are8jcopb" title="Getting Started with PostgreSQL on Mac OSX">Getting Started with PostgreSQL on Mac OSX</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><!-- toc -->
<h1 id="macmacos-ä½¿ç”¨æ‰‹å†Œ"><a class="header" href="#macmacos-ä½¿ç”¨æ‰‹å†Œ">Mac/macOS ä½¿ç”¨æ‰‹å†Œ</a></h1>
<h2 id="netstat"><a class="header" href="#netstat">netstat</a></h2>
<p>macOS ä¸Šçš„ <strong>netstat</strong> å‘½ä»¤ç”¨æ¥æŸ¥çœ‹æœ¬æœºçš„ç½‘ç»œè¿æ¥æƒ…å†µï¼Œä½†æ˜¯è¦æ³¨æ„ï¼ŒmacOS çš„ netstat å‘½ä»¤ç”¨æ³•ä¸ linux ä¸Šçš„ netstat ä¸åŒã€‚è­¬å¦‚åœ¨ linux ä¸­ <code>-p</code> å‚æ•°çš„æ„æ€æ˜¯æ˜¾ç¤ºå…³è”çš„è¿›ç¨‹çš„ç¨‹åºåï¼Œåœ¨ macOS ä¸­æ˜¯æŒ‡å®šåè®®ï¼š</p>
<pre><code class="language-sh">-p protocol
           Show statistics about protocol, which is either a well-known name for a protocol or an alias for it.
</code></pre>
<h3 id="æŸ¥çœ‹è·¯ç”±è¡¨"><a class="header" href="#æŸ¥çœ‹è·¯ç”±è¡¨">æŸ¥çœ‹è·¯ç”±è¡¨</a></h3>
<p><a href="https://my.oschina.net/fxtxz2/blog/3060015">macä¸Šé¢æŸ¥çœ‹è·¯ç”±è¡¨</a>ï¼š</p>
<pre><code class="language-sh">netstat -nr
</code></pre>
<h3 id="æŸ¥çœ‹ç›‘å¬çš„ç«¯å£å’Œè¿æ¥"><a class="header" href="#æŸ¥çœ‹ç›‘å¬çš„ç«¯å£å’Œè¿æ¥">æŸ¥çœ‹ç›‘å¬çš„ç«¯å£å’Œè¿æ¥</a></h3>
<p>æŸ¥çœ‹ tcp ç›‘å¬ç«¯å£ï¼Œåœ¨ linux ä¸Šæ˜¯ netstat -lntï¼Œåœ¨ macOS ä¸­æ˜¯ï¼š</p>
<pre><code class="language-sh">$ netstat -n -a -p tcp |grep &quot;LISTEN&quot;

# -n:     å«ä¹‰ä¸ linux ç›¸åŒï¼Œæ˜¾ç¤ºæ•°å­—
# -a:     æ˜¾ç¤ºæ‰€æœ‰ socketï¼Œå¸¦æœ‰è¿™ä¸ªå‚æ•°ï¼Œæ‰èƒ½æ˜¾ç¤ºç›‘å¬ç«¯å£
# -p tcp: æŒ‡å®š tcp åè®®
#
# æœ€åç”¨ grep å°†ç›‘å¬çŠ¶æ€çš„ socket è¿‡æ»¤å‡ºæ¥
</code></pre>
<p>å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ netstat -n -a -p tcp  |grep &quot;LISTEN&quot;
tcp46      0      0  *.5002                 *.*                    LISTEN
tcp4       0      0  127.0.0.1.51526        *.*                    LISTEN
tcp4       0      0  127.0.0.1.63886        *.*                    LISTEN
tcp46      0      0  *.80                   *.*                    LISTEN
...
</code></pre>
<h2 id="æŸ¥æ‰¾ç›‘å¬ç«¯å£çš„è¿›ç¨‹"><a class="header" href="#æŸ¥æ‰¾ç›‘å¬ç«¯å£çš„è¿›ç¨‹">æŸ¥æ‰¾ç›‘å¬ç«¯å£çš„è¿›ç¨‹</a></h2>
<p>åœ¨ linux ä¸Š netstat çš„ -p å‚æ•°ä¼šæ˜¾ç¤ºè¿æ¥æˆ–è€… socket æ‰€å±çš„è¿›ç¨‹å·å’Œç¨‹åºåç§°ï¼ŒmacOS çš„ netstat æ²¡æœ‰ç±»ä¼¼çš„é€‰é¡¹ï¼Œéœ€è¦ç”¨å…¶å®ƒæ–¹æ³•æ‰¾åˆ°ç›‘å¬ç«¯å£çš„è¿›ç¨‹ã€‚ <strong>lsof</strong> æ˜¯æœ€å¥½çš„é€‰æ‹©ä¹‹ä¸€ï¼Œåœ¨ macOS ä¸Šçš„ç”¨æ³•å’Œåœ¨ linux ä¸­çš„ç”¨æ³•ç›¸åŒï¼š</p>
<pre><code class="language-sh"># æŸ¥æ‰¾ç›‘å¬ 80 ç«¯å£çš„è¿›ç¨‹
$ lsof -n -i :80 |grep LISTEN
com.docke  6777 lijiao   35u  IPv6 0x65955d0d6aba74bb      0t0  TCP *:http (LISTEN)

# -iï¼ŒæŒ‡å®šç½‘ç»œåœ°å€
</code></pre>
<p><a href="https://tonydeng.github.io/2016/07/07/use-lsof-to-replace-netstat/">ä½¿ç”¨ lsof ä»£æ›¿ Mac OS X ä¸­çš„ netstat æŸ¥çœ‹å ç”¨ç«¯å£çš„ç¨‹åº</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
                <div style="text-align:center;width:100%">
                    <!--h1>åº•éƒ¨ç›¸å…³å¹¿å‘Š</h1-->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8176866190626448"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-format="autorelaxed"
                         data-ad-client="ca-pub-8176866190626448"
                         data-ad-slot="6443696990"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
